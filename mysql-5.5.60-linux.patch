diff -uNr mysql-5.5.60.orig/client/mysql.cc mysql-5.5.60/client/mysql.cc
--- mysql-5.5.60.orig/client/mysql.cc	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/client/mysql.cc	2018-12-02 00:10:59.892448967 +0800
@@ -2671,7 +2671,7 @@
         mysql_free_result(fields);
         break;
       }
-      field_names[i][num_fields*2]= '\0';
+      field_names[i][num_fields*2]= NULL;
       j=0;
       while ((sql_field=mysql_fetch_field(fields)))
       {
diff -uNr mysql-5.5.60.orig/cmake/os/GNU.cmake mysql-5.5.60/cmake/os/GNU.cmake
--- mysql-5.5.60.orig/cmake/os/GNU.cmake	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/cmake/os/GNU.cmake	2018-12-02 00:06:23.357891685 +0800
@@ -0,0 +1,20 @@
+# This file includes GNU/Hurd specific options and quirks, related to system checks
+
+INCLUDE(CheckSymbolExists)
+
+SET(_GNU_SOURCE 1)
+
+# Fix CMake (< 2.8) flags. -rdynamic exports too many symbols.
+FOREACH(LANG C CXX)
+  STRING(REPLACE "-rdynamic" ""
+  CMAKE_SHARED_LIBRARY_LINK_${LANG}_FLAGS
+  "${CMAKE_SHARED_LIBRARY_LINK_${LANG}_FLAGS}"
+  )
+ENDFOREACH()
+
+# Ensure we have clean build for shared libraries
+# without unresolved symbols
+SET(LINK_FLAG_NO_UNDEFINED "-Wl,--no-undefined")
+
+# 64 bit file offset support flag
+SET(_FILE_OFFSET_BITS 64)
diff -uNr mysql-5.5.60.orig/debian/NEWS mysql-5.5.60/debian/NEWS
--- mysql-5.5.60.orig/debian/NEWS	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/NEWS	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,22 @@
+mysql-5.5 (5.5.35+dfsg-1) unstable; urgency=low
+
+  mysql-server-5.5 ships with the upstream mysql_install_db script which
+  creates a database "test" and sets up permissions that allow anonymous
+  access, without a password, from localhost to the "test" database and
+  any databases starting with "test_" that users might have created
+  after installing mysql-server.
+
+  During the migration of mysql-5.1 to mysql-5.5 in Debian the patches
+  to drop these permissions and the creation of the test databases were
+  not applied. This update resolves this issue for new installations of
+  mysql-server-5.5.
+
+  If you are updating from a previous version of mysql-5.5 it is
+  recommended to check your installation and to drop these privileges
+  and databases manually.
+
+  Further information can be found at the MySQL 5.5 Reference Manual[1].
+
+   [1] http://dev.mysql.com/doc/refman/5.5/en/default-privileges.html
+
+ -- James Page <jamespage@debian.org>  Fri, 17 Jan 2014 17:15:31 +0000
diff -uNr mysql-5.5.60.orig/debian/README.Maintainer mysql-5.5.60/debian/README.Maintainer
--- mysql-5.5.60.orig/debian/README.Maintainer	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/README.Maintainer	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,114 @@
+
+###########################
+##	FIXME for 5.1    ##
+###########################
+
+* put this trigger-recreation thing into the init scripts -- what?!
+
+###########################################################################
+# Here are some information that are only of interest for the current and #
+# following Debian maintainers of MySQL.                                  #
+###########################################################################
+
+The debian/ directory is under SVN control, see debian/control for URL.
+
+#
+# Preparing a new version
+#
+The new orig.tar.gz (without non-free documentation) is created in /tmp/ when
+running this command:
+ 
+debian/rules get-orig-source
+
+#
+# mysqlreport
+#
+The authors e-mail address is <public@codenode.com>.
+
+#
+# Remarks to dependencies
+#
+libwrap0-dev (>= 7.6-8.3)
+	According to bug report 114582 where where build problems on
+	IA-64/sid with at least two prior versions.
+psmisc
+	/usr/bin/killall in the initscript
+
+zlib1g in libmysqlclient-dev:	
+	"mysql_config --libs" ads "-lz"
+
+Build-Dep:
+
+debhelper (>=4.1.16):
+	See po-debconf(7).
+
+autoconf (>= 2.13-20), automake1.7
+	Try to get rid of them.
+
+doxygen, tetex-bin, tetex-extra, gs
+	for ndb/docs/*tex
+
+#
+# Remarks to the start scripts
+#
+
+## initscripts rely on mysqladmin from a different package
+We have the problem that "/etc/init.d/mysql stop" relies on mysqladmin which
+is in another package (mysql-client) and a passwordless access that's maybe
+only available if the user configured his /root/.my.cnf. Can this be a problem?
+* normal mode: not because the user is required to have it. Else:
+* purge/remove: not, same as normal mode
+* upgrade: not, same as normal mode
+* first install: not, it depends on mysql-client which at least is unpacked
+                 so mysqladmin is there (to ping). It is not yet configured
+		passwordles but if there's a server running then there's a
+                /root/.my.cnf. Anyways, we simply kill anything that's mysqld.
+
+## Passwordless access for the maintainer scripts
+Another issue is that the scripts needs passwordless access. To ensure this
+a debian-sys-maint user is configured which has process and shutdown privs.
+The file with the randomly (that's important!) generated password must be
+present as long as the databases remain installed because else a new install
+would have no access. This file should be used like:
+	mysqladmin --defaults-file=/etc/mysql/debian.cnf restart
+to avoid providing the password in plaintext on a commandline where it would 
+be visible to any user via the "ps" command.
+
+## When to start the daemon?
+We aim to give the admin full control on when MySQL is running.
+Issues to be faced here:
+OLD:
+        1. Debconf asks whether MySQL should be started on boot so update-rc.d is
+           only run if the answer has been yes. The admin is likely to forget
+           this decision but update-rc.d checks for an existing line in
+           /etc/runlevel.conf and leaves it intact.
+        2. On initial install, if the answer is yes, the daemon has to be started.
+        3. On upgrades it should only be started if it was already running, everything
+           else is confusing. Especiall relying on an debconf decision made month ago
+           is considered suboptimal. See bug #274264
+        Implementation so far:
+        prerm (called on upgrade before stopping the server): 
+          check for a running server and set flag if necessary
+        preinst (called on initial install and before unpacking when upgrading):
+          check for the debconf variable and set flag if necessary
+        postinst (called on initial install and after each upgrade after unpacking):
+          call update-rc.d if debconf says yes
+          call invoce-rc.d if the flag has been set
+        Problems remaining:
+          dpkg-reconfigure and setting mysql start on boot to yes did not start mysql
+          (ok "start on boot" literally does not mean "start now" so that might have been ok)
+NEW:
+        1. --- no debconf anymore for the sake of simplicity. We have runlevel.conf,
+           the admin should use it
+        2. On initial install the server is started.
+        3. On upgrades the server is started exactly if it was running before so the
+           runlevel configuration is irrelevant. It will be preserved by the mean of
+           update-rc.d's builtin check.
+        Implementation:
+        prerm (called on upgrade before stopping the server):
+          check for a running server and set flag if necessary
+        preinst (called on initial install and before unpacking when upgrading):
+          check for $1 beeing (initial) "install" and set flag
+        postinst (called on initial install and after each upgrade after unpacking):
+          call update-rc.d
+          call invoce-rc.d if the flag has been set
diff -uNr mysql-5.5.60.orig/debian/README.source mysql-5.5.60/debian/README.source
--- mysql-5.5.60.orig/debian/README.source	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/README.source	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,40 @@
+DFSG and repacking
+==================
+The upstream source tarball from dev.mysql.com contains one file,
+Docs/mysq.info, that is not DFSG-compliant. We are currently using
+the mechanism that appears to be the closest thing to a Debian-wide
+DFSG-repacking mechanism - i.e. the scripts used by the Debian Perl
+Group. See #677270 for a request to make this (or something based
+upon it) a standard within Debian.
+
+To use this to download the current tarball (as indicated by debian/changelog)
+run 'fakeroot debian/rules get-orig-source' from within the top-level
+directory. If you are trying to build directly from the repository you
+will also need to unpack the tarball into the same top-level directory.
+
+Bugs: Beware of having upstream tarballs (with or without the
+non-DFSG material) in .. befrore running get-orig-source. It first downloads
+the unaltered file and then repacks to the new one. The process
+will stop if either file is present.
+
+MySQL source package
+====================
+The question arises why we have the mysql-source-* packages and why
+they are arch:any wasting so much space. This conversation covered the
+issue although it should probably be looked at again.
+
+(26/05/12 16:24:18) SpamapS: periapt: hey, are you 100% sure that mysql-source-5.5 is arch: all ?
+(16:24:37) SpamapS: periapt: It includes generated files.. some of which might be arch specific. I've never taken the time to make sure.
+(16:35:56) periapt: SpamapS: Actually that's a fair point - cmake output. But then I think we ought to drop it. I view it as duplication which I think is against Debian policy.
+(16:44:04) periapt: It seems to be some sort of hangover from when the licensing issues were much worse. It's popcorn rating is almost lower than the arches we support.
+(16:49:27) SpamapS: Nope, its needed for plugins
+(16:49:39) SpamapS: It is only useful as a build-dep
+(16:49:57) SpamapS: Now, I have been made aware of the fact that source format 3.0 allows multiple upstreams..
+(16:50:24) SpamapS: periapt: I created the package, and I use it as a build-dep for handlersocket.
+(16:50:54) SpamapS: periapt: perhaps we should add handlersocket as a second upstream source. That would eliminate the need for it.
+(16:55:21) periapt: SpamapS: I would advise against multiple upstream sources. I actually tried to write some debhelper stuff to maange it. I never got the uscan wrapper working and it's horrible: pkg-components.
+(16:56:23) SpamapS: periapt: then we cannot remove the mysql-source-* packages
+(16:56:57) periapt: I'll put it back to arch:any for now and update the long description. I notice there are already bugs that cover the issue of how to manage plugins. I think it should be revisited. 
+(16:57:30) SpamapS: periapt: perhaps the clarity from this discussion belongs in README.source too :)
+(16:57:40) periapt: okay
+(16:58:15) periapt: Actually I would prefer the FAQ: http://wiki.debian.org/Teams/MySQL/FAQ
diff -uNr mysql-5.5.60.orig/debian/additions/Docs__Images__Makefile.in mysql-5.5.60/debian/additions/Docs__Images__Makefile.in
--- mysql-5.5.60.orig/debian/additions/Docs__Images__Makefile.in	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/Docs__Images__Makefile.in	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,6 @@
+all:
+
+distclean:
+	-rm -f Makefile
+
+.PHONY: all distclean clean install check
diff -uNr mysql-5.5.60.orig/debian/additions/Docs__Makefile.in mysql-5.5.60/debian/additions/Docs__Makefile.in
--- mysql-5.5.60.orig/debian/additions/Docs__Makefile.in	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/Docs__Makefile.in	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,6 @@
+all:
+
+distclean:
+	-rm -f Makefile
+
+.PHONY: all distclean clean install check
diff -uNr mysql-5.5.60.orig/debian/additions/debian-start mysql-5.5.60/debian/additions/debian-start
--- mysql-5.5.60.orig/debian/additions/debian-start	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/debian-start	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,32 @@
+#!/bin/bash
+#
+# This script is executed by "/etc/init.d/mysql" on every (re)start.
+# 
+# Changes to this file will be preserved when updating the Debian package.
+#
+
+source /usr/share/mysql/debian-start.inc.sh
+
+MYSQL="/usr/bin/mysql --defaults-file=/etc/mysql/debian.cnf"
+MYADMIN="/usr/bin/mysqladmin --defaults-file=/etc/mysql/debian.cnf"
+MYUPGRADE="/usr/bin/mysql_upgrade --defaults-extra-file=/etc/mysql/debian.cnf"
+MYCHECK="/usr/bin/mysqlcheck --defaults-file=/etc/mysql/debian.cnf"
+MYCHECK_SUBJECT="WARNING: mysqlcheck has found corrupt tables"
+MYCHECK_PARAMS="--all-databases --fast --silent"
+MYCHECK_RCPT="root"
+
+# The following commands should be run when the server is up but in background
+# where they do not block the server start and in one shell instance so that
+# they run sequentially. They are supposed not to echo anything to stdout.
+# If you want to disable the check for crashed tables comment
+# "check_for_crashed_tables" out.  
+# (There may be no output to stdout inside the background process!)
+echo "Checking for tables which need an upgrade, are corrupt or were "
+echo "not closed cleanly."
+(
+  upgrade_system_tables_if_necessary;
+  check_root_accounts;
+  check_for_crashed_tables;
+) >&2 &
+
+exit 0
diff -uNr mysql-5.5.60.orig/debian/additions/debian-start.inc.sh mysql-5.5.60/debian/additions/debian-start.inc.sh
--- mysql-5.5.60.orig/debian/additions/debian-start.inc.sh	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/debian-start.inc.sh	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,72 @@
+#!/bin/bash
+#
+# This file is included by /etc/mysql/debian-start
+#
+
+## Check all unclosed tables.
+# - Requires the server to be up.
+# - Is supposed to run silently in background. 
+function check_for_crashed_tables() {
+  set -e
+  set -u
+
+  # But do it in the background to not stall the boot process.
+  logger -p daemon.info -i -t$0 "Triggering myisam-recover for all MyISAM tables"
+
+  # Checking for $? is unreliable so the size of the output is checked.
+  # Some table handlers like HEAP do not support CHECK TABLE.
+  tempfile=`tempfile`
+  # We have to use xargs in this case, because a for loop barfs on the 
+  # spaces in the thing to be looped over. 
+  LC_ALL=C $MYSQL --skip-column-names --batch -e  '
+      select concat('\''select count(*) into @discard from `'\'',
+                    TABLE_SCHEMA, '\''`.`'\'', TABLE_NAME, '\''`'\'') 
+      from information_schema.TABLES where ENGINE='\''MyISAM'\' | \
+    xargs -i $MYSQL --skip-column-names --silent --batch \
+                    --force -e "{}" >$tempfile 
+  if [ -s $tempfile ]; then
+    (
+      /bin/echo -e "\n" \
+        "Improperly closed tables are also reported if clients are accessing\n" \
+ 	"the tables *now*. A list of current connections is below.\n";
+       $MYADMIN processlist status
+    ) >> $tempfile
+    # Check for presence as a dependency on mailx would require an MTA.
+    if [ -x /usr/bin/mailx ]; then 
+      mailx -e -s"$MYCHECK_SUBJECT" $MYCHECK_RCPT < $tempfile 
+    fi
+    (echo "$MYCHECK_SUBJECT"; cat $tempfile) | logger -p daemon.warn -i -t$0
+  fi
+  rm $tempfile
+}
+
+## Check for tables needing an upgrade.
+# - Requires the server to be up.
+# - Is supposed to run silently in background. 
+function upgrade_system_tables_if_necessary() {
+  set -e
+  set -u
+
+  logger -p daemon.info -i -t$0 "Upgrading MySQL tables if necessary."
+
+  # Filter all "duplicate column", "duplicate key" and "unknown column"
+  # errors as the script is designed to be idempotent.
+  LC_ALL=C $MYUPGRADE \
+    2>&1 \
+    | egrep -v '^(1|@had|ERROR (1054|1060|1061))' \
+    | logger -p daemon.warn -i -t$0
+}
+
+## Check for the presence of both, root accounts with and without password.
+# This might have been caused by a bug related to mysql_install_db (#418672).
+function check_root_accounts() {
+  set -e
+  set -u
+  
+  logger -p daemon.info -i -t$0 "Checking for insecure root accounts."
+
+  ret=$( echo "SELECT count(*) FROM mysql.user WHERE user='root' and password='';" | $MYSQL --skip-column-names )
+  if [ "$ret" -ne "0" ]; then
+    logger -p daemon.warn -i -t$0 "WARNING: mysql.user contains $ret root accounts without password!"
+  fi
+}
diff -uNr mysql-5.5.60.orig/debian/additions/echo_stderr mysql-5.5.60/debian/additions/echo_stderr
--- mysql-5.5.60.orig/debian/additions/echo_stderr	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/echo_stderr	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,2 @@
+#!/bin/bash
+echo "$*" 1>&2
diff -uNr mysql-5.5.60.orig/debian/additions/innotop/changelog.innotop mysql-5.5.60/debian/additions/innotop/changelog.innotop
--- mysql-5.5.60.orig/debian/additions/innotop/changelog.innotop	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/innotop/changelog.innotop	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,357 @@
+Changelog for innotop:
+
+2009-03-09: version 1.7.1
+
+   Changes:
+   * Don't display the CXN column if only one connection is active in 
+     the current view
+
+   Bugs fixed:
+   * fixed bug where trying to aggregate the time column would result 
+     in a crash if the time column had an undef value in it, which is 
+     the case when a thread is in the 'Connect' state
+   * updated innotop.spec file to reflect current version
+
+2009-02-23: version 1.7.0
+
+   Changes:
+   * supports a central config (/etc/innotop/innotop.conf)
+   * changed the default home directory config to ~/.innotop/innotop.conf
+     (away from .ini)
+   * embedded InnoDBParser.pm into innotop so it can be run with no 
+     installation
+   * no longer writes a new config file by default
+   * added --skipcentral (skip reading central config) and --write (write
+     a config if none were loaded at start-up)
+   * if no config file is loaded, connect to a MySQL database on
+     localhost using mysql_read_default_group=client
+   * embedded maatkit's DSNParser.pm and added support for --user,
+     --password, --host, --port
+   * changed default mode from T (InnoDB Transactions) to Q (Query List)
+   * in addition to connected threads, now displays running and cached
+     threads in statusbar
+   * don't load connections from a config file if any DSN information or
+     a username or password is specified on the command-line
+   
+   Bugs fixed:
+   * fixed bug preventing utilization of command-line options that
+     override default config settings if no config file was loaded
+   * fixed a bug where migrating from an old version of the config will
+     delete ~/innotop.ini, if it exists.  Now uses File::Temp::tempfile().
+
+2007-11-09: version 1.6.0
+
+   * S mode crashed on non-numeric values.
+   * New user-defined columns crashed upon restart.
+   * Added --color option to control terminal coloring.
+
+2007-09-18: version 1.5.2
+
+   * Added the ability to monitor InnoDB status from a file.
+   * Changed W mode to L mode; it monitors all locks, not just lock waits.
+
+2007-09-16: version 1.5.1
+
+   * Added C (Command Summary) mode.
+   * Fixed a bug in the 'avg' aggregate function.
+
+2007-09-10: version 1.5.0
+
+   Changes:
+   * Added plugin functionality.
+   * Added group-by functionality.
+   * Moved the configuration file to a directory.
+   * Enhanced filtering and sorting on pivoted tables.
+   * Many small bug fixes.
+
+2007-07-16: version 1.4.3
+
+   Changes:
+   * Added standard --version command-line option
+   * Changed colors to cyan instead of blue; more visible on dark terminals.
+   * Added information to the filter-choosing dialog.
+   * Added column auto-completion when entering a filter expression.
+   * Changed Term::ReadKey from optional to mandatory.
+   * Clarified username in password prompting.
+   * Ten thousand words of documentation!
+
+   Bugs fixed:
+   * innotop crashed in W mode when InnoDB status data was truncated.
+   * innotop didn't display errors in tables if debug was enabled.
+   * The colored() subroutine wasn't being created in non-interactive mode.
+   * Don't prompt to save password except the first time.
+
+2007-05-03: version 1.4.2
+
+   This version contains all changes to the trunk until revision 239; some
+   changes in revisions 240:250 are included.
+
+   MAJOR CHANGES:
+
+   * Quick-filters to easily filter any column in any display
+   * Compatibility with MySQL 3.23 through 6.0
+   * Improved error handling when a server is down, permissions denied, etc
+   * Use additional SHOW INNODB STATUS information in 5.1.x
+   * Make all modes use tables consistently, so they can all be edited,
+     filtered, colored and sorted consistently
+   * Combine V, G and S modes into S mode, with v, g, and s hot-keys
+   * Let DBD driver read MySQL option files; permit connections without
+     user/pass/etc
+   * Compile SQL-like expressions into Perl subroutines; eliminate need to
+     know Perl
+   * Do not save all config data to config file, only save user's customizations
+   * Rewritten and improved command-line option handling
+   * Added --count, --delay, and other command-line options to support
+     run-and-exit operation
+   * Improve built-in variable sets
+   * Improve help screen with three-part balanced-column layout
+   * Simplify table-editor and improve hotkey support
+   * Require Perl to have high-resolution time support (Time::HiRes)
+   * Help the user choose a query to analyze or kill
+   * Enable EXPLAIN, show-full-query in T mode just like Q mode
+   * Let data-extraction access current, previous and incremental data sets
+     all at once
+
+   MINOR CHANGES:
+
+   * Column stabilizing for Q mode
+   * New color rules for T, Q, W modes
+   * Apply slave I/O filter to Q mode
+   * Improve detection of server version and other meta-data
+   * Make connection timeout a config variable
+   * Improve cross-version-compatible SQL syntax
+   * Get some information from the DBD driver instead of asking MySQL for it
+   * Improved error messages
+   * Improve server group creation/editing
+   * Improve connection/thread killing
+   * Fix broken key bindings and restore previously mapped hot-keys for
+     choosing columns
+   * Some documentation updates (but not nearly enough)
+   * Allow the user to specify graphing char in S mode (formerly G mode)
+   * Allow easy switching between variable sets in S mode
+   * Bind 'n' key globally to choose the 'next' server connection
+   * Bind '%' key globally to filter displayed tables
+   * Allow aligning columns on the decimal place for easy readability
+   * Add hide_hdr config variable to hide column headers in tables
+   * Add a feature to smartly run PURGE MASTER LOGS in Replication mode
+   * Enable debug mode as a globally configurable variable
+   * Improve error messages when an expression or filter doesn't compile or has
+     a run-time error; die on error when debug is enabled
+   * Allow user-configurable delays after executing SQL (to let the server
+     settle down before taking another measurement)
+   * Add an expression to show how long until a transaction is finished
+   * Add skip_innodb as a global config variable
+   * Add '%' after percentages to help disambiguate (user-configurable)
+   * Add column to M mode to help see how fast slave is catching up to master
+
+   BUG FIXES:
+
+   * T and W modes had wrong value for wait_status column
+   * Error tracking on connections didn't reset when the connection recovered
+   * wait_timeout on connections couldn't be set before MySQL 4.0.3
+   * There was a crash on 3.23 when wiping deadlocks
+   * Lettercase changes in some result sets (SHOW MASTER/SLAVE STATUS) between
+     MySQL versions crashed innotop
+   * Inactive connections crashed innotop upon access to DBD driver
+   * set_precision did not respect user defaults for number of digits
+   * --inc command-line option could not be negated
+   * InnoDB status parsing was not always parsing all needed information
+   * S mode (formerly G mode) could crash trying to divide non-numeric data
+   * M table didn't show Slave_open_temp_tables variable; incorrect lettercase
+   * DBD drivers with broken AutoCommit would crash innotop
+   * Some key bindings had incorrect labels
+   * Some config-file loading routines could load data for things that didn't
+     exist
+   * Headers printed too often in S mode
+   * High-resolution time was not used even when the user had it
+   * Non-interactive mode printed blank lines sometimes
+   * Q-mode header and statusbar showed different QPS numbers
+   * Formulas for key-cache and query-cache hit ratios were wrong
+   * Mac OS "Darwin" machines were mis-identified as Microsoft Windows
+   * Some multiplications crashed when given undefined input
+   * The commify transformation did not check its input and could crash
+   * Specifying an invalid mode on the command line or config file could crash
+     innotop
+
+2007-03-29: version 1.4.1
+
+   * More tweaks to display of connection errors.
+   * Fixed a problem with skip-innodb in MySQL 5.1.
+   * Fix a bug with dead connections in single-connection mode.
+   * Fix a regex to allow parsing more data from truncated deadlocks.
+   * Don't load active cxns from the config file if the cxn isn't defined.
+
+2007-03-03: version 1.4.0
+
+   * Further tweak error handling and display of connection errors
+   * More centralization of querying
+   * Fix forking so it doesn't kill all database connections
+   * Allow user to run innotop without permissions for GLOBAL variables and status
+
+2007-02-11: version 1.3.6
+
+   * Handle some connection failures so innotop doesn't crash because of one server.
+   * Enable incremental display in more modes.
+   * Tweaks to colorizing, color editor, and default color rules.
+   * Tweaks to default sorting rules.
+   * Use prepared statements for efficiency.
+   * Bug fixes and code cleanups.
+   * Data storage is keyed on clock ticks now.
+
+2007-02-03: version 1.3.5
+
+   * Bug fixes.
+   * More tools for editing configuration from within innotop.
+   * Filters and transformations are constrained to valid values.
+   * Support for colorizing rows.
+   * Sorting by multiple columns.
+   * Compress headers when display is very wide.
+   * Stabilize and limit column widths.
+   * Check config file formats when upgrading so upgrades go smoothly.
+   * Make D mode handle many connections at once.
+   * Extract simple expressions from data sets in column src property.
+     This makes innotop more awk-ish.
+
+2007-01-16: version 1.3
+
+   * Readline support.
+   * Can be used unattended, or in a pipe-and-filter mode
+     where it outputs tab-separated data to standard output.
+   * You can specify a config file on the command line.
+     Config files can be marked read-only.
+   * Monitor multiple servers simultaneously.
+   * Server groups to help manage many servers conveniently.
+   * Monitor master/slave status, and control slaves.
+   * Columns can have user-defined expressions as their data sources.
+   * Better configuration tools.
+   * InnoDB status information is merged into SHOW VARIABLES and
+     SHOW STATUS information, so you can access it all together.
+   * High-precision time support in more places.
+   * Lots of tweaks to make things display more readably and compactly.
+   * Column transformations and filters.
+
+2007-01-16: version 1.0.1
+   * NOTE: innotop is now hosted at Sourceforge, in Subversion not CVS.
+     The new project homepage is http://sourceforge.net/projects/innotop/
+   * Tweak default T/Q mode sort columns to match what people expect.
+   * Fix broken InnoDBParser.pm documentation (and hence man page).
+
+2007-01-06: version 1.0
+   * NOTE: innotop is now hosted at Sourceforge, in Subversion not CVS.
+     The new project homepage is http://sourceforge.net/projects/innotop/
+   * Prevent control characters from freaking terminal out.
+   * Set timeout to keep busy servers from closing connection.
+   * There is only one InnoDB insert buffer.
+   * Make licenses clear and consistent.
+
+2006-11-14: innotop 0.1.160, InnoDBParser version 1.69
+   * Support for ANSI color on Microsoft Windows (more readable, compact
+     display; thanks Gisbert W. Selke).
+   * Better handling of $ENV{HOME} on Windows.
+   * Added a LICENSE file to the package as per Gentoo bug:
+     http://bugs.gentoo.org/show_bug.cgi?id=147600
+
+2006-11-11: innotop 0.1.157, InnoDBParser version 1.69
+   * Add Microsoft Windows support.
+
+2006-10-19: innotop 0.1.154, InnoDBParser version 1.69
+   * Add O (Open Tables) mode
+   * Add some more checks to handle incomplete InnoDB status information
+
+2006-09-30: innotop 0.1.152, InnoDBParser version 1.69
+   * Figured out what was wrong with package $VERSION variable: it wasn't
+     after the package declaration!
+
+2006-09-28: innotop 0.1.152, InnoDBParser version 1.67
+   * Make more efforts towards crash-resistance and tolerance of completely
+     messed-up inputs.  If innotop itself is broken, it is now much harder to
+     tell, because it just keeps on running without complaining.
+   * Fix a small bug parsing out some information and displaying it.
+
+2006-09-05: innotop 0.1.149, InnoDBParser version 1.64
+   * Try to find and eliminate any parsing code that assumes pattern matches
+     will succeed.
+
+2006-09-05: innotop 0.1.149, InnoDBParser version 1.62
+   * Make innotop crash-resistant, so I can declare it STABLE finally.
+   * Instead of using SQL conditional comments, detect MySQL version.
+
+2006-08-22: innotop 0.1.147, InnoDBParser version 1.60
+   * Fix some innotop bugs with undefined values, bad formatting etc.
+
+2006-08-19: innotop 0.1.146, InnoDBParser version 1.60
+   * Make innotop handle some unexpected NULL values in Q mode.
+   * Add OS wait information to W mode, so it is now "everything that waits."
+   * Center section captions better.
+   * Make R mode more readable and compact.
+   * Make InnoDBParser parse lock waits even when they've been waiting 0 secs.
+
+2006-08-12: innotop 0.1.139, InnoDBParser version 1.59
+   * Add more documentation
+   * Tweak V mode to show more info in less space.
+   * Fix a bug in G mode.
+
+2006-08-10: innotop 0.1.132, InnoDBParser version 1.58
+   * Handle yet more types of FK error... it will never end!
+   * Handle some special cases when DEADLOCK info truncated
+   * Add a bit more FK info to F mode in innotop
+   * More tests added to the test suite
+
+2006-08-07: innotop 0.1.131, InnoDBParser version 1.55
+   * Fix another issue with configuration
+   * Handle another type of FK error
+
+2006-08-03: innotop 0.1.130, InnoDBParser version 1.54
+   * Fix an issue loading config file
+   * Add heap_no to 'D' (InnoDB Deadlock) mode to ease deadlock debugging.
+
+2006-08-02: innotop 0.1.128, InnoDBParser version 1.54
+   * Parse lock wait information from the TRANSACTION section.
+   * Even more OS-specific parsing... pain in the butt...
+   * Add 'W' (InnoDB Lock Wait) mode.
+   * Fix some minor display issues with statusbar.
+
+2006-08-02: innotop 0.1.125, InnoDBParser version 1.50
+   * Don't try to get references to Perl built-in functions like time()
+   * Handle more OS-specific variations of InnoDB status text
+   * Add some more information to various places in innotop
+
+2006-08-01: innotop 0.1.123, InnoDBParser version 1.47
+
+   * Enhance S and G modes: clear screen and re-print headers
+   * Don't crash when deadlock data is truncated
+   * Make Analyze mode say how to get back to whatever you came from
+   * Display 'nothing to display' when there is nothing
+   * Add ability to read InnoDB status text from a file (mostly helps test)
+   * Add table of Wait Array Information in Row Op/Semaphore mode
+   * Add table of lock information in InnoDB deadlock mode
+   * Ensure new features in upgrades don't get masked by existing config files
+   * Tweak default column choices for T mode
+   * Enhance foreign key parsing
+   * Enhance physical record and data tuple parsing
+   * Enhance lock parsing (handle old-style and new-style formats)
+
+2006-07-24: innotop 0.1.112, InnoDBParser version 1.36
+
+   * InnoDBParser enhancements for FK error messages.
+   * A fix to innotop to prevent it from crashing while trying to display a FK
+     error message.
+   * Some minor cosmetic changes to number formatting in innotop.
+
+2006-07-22: innotop 0.1.106, InnoDBParser version 1.35
+
+   * InnoDBParser is much more complete and accurate.
+   * Tons of bug fixes.
+   * Add partitions to EXPLAIN mode.
+   * Enhance Q mode header, add T mode header.
+   * Share some configuration variables across modes.
+   * Add formatted time columns to Q, T modes.
+   * Add command-line argument parsing.
+   * Turn off echo when asking for password.
+   * Add option to specify port when connecting.
+   * Let display-optimized-query display multiple notes.
+   * Lots of small improvements, such as showing more info in statusbar.
+
+2006-07-02: innotop 0.1.74, InnoDBParser version 1.24
+
+   * Initial release for public consumption.
diff -uNr mysql-5.5.60.orig/debian/additions/innotop/innotop mysql-5.5.60/debian/additions/innotop/innotop
--- mysql-5.5.60.orig/debian/additions/innotop/innotop	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/innotop/innotop	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,10946 @@
+#!/usr/bin/perl
+
+# vim: tw=160:nowrap:expandtab:tabstop=3:shiftwidth=3:softtabstop=3
+
+# This program is copyright (c) 2006 Baron Schwartz, baron at xaprb dot com.
+# Feedback and improvements are gratefully received.
+#
+# THIS PROGRAM IS PROVIDED "AS IS" AND WITHOUT ANY EXPRESS OR IMPLIED
+# WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF
+# MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.
+#
+# This program is free software; you can redistribute it and/or modify it under
+# the terms of the GNU General Public License as published by the Free Software
+# Foundation, version 2; OR the Perl Artistic License.  On UNIX and similar
+# systems, you can issue `man perlgpl' or `man perlartistic' to read these
+
+# You should have received a copy of the GNU General Public License along with
+# this program; if not, write to the Free Software Foundation, Inc., 59 Temple
+# Place, Suite 330, Boston, MA  02111-1307  USA
+
+use strict;
+use warnings FATAL => 'all';
+
+our $VERSION = '1.7.1';
+
+# Find the home directory; it's different on different OSes.
+our $homepath = $ENV{HOME} || $ENV{HOMEPATH} || $ENV{USERPROFILE} || '.';
+
+# Configuration files
+our $default_home_conf = "$homepath/.innotop/innotop.conf";
+our $default_central_conf = "/etc/innotop/innotop.conf";
+our $conf_file = "";
+
+## Begin packages ##
+
+package DSNParser;
+
+use DBI;
+use Data::Dumper;
+$Data::Dumper::Indent    = 0;
+$Data::Dumper::Quotekeys = 0;
+use English qw(-no_match_vars);
+
+use constant MKDEBUG => $ENV{MKDEBUG};
+
+# Defaults are built-in, but you can add/replace items by passing them as
+# hashrefs of {key, desc, copy, dsn}.  The desc and dsn items are optional.
+# You can set properties with the prop() sub.  Don't set the 'opts' property.
+sub new {
+   my ( $class, @opts ) = @_;
+   my $self = {
+      opts => {
+         A => {
+            desc => 'Default character set',
+            dsn  => 'charset',
+            copy => 1,
+         },
+         D => {
+            desc => 'Database to use',
+            dsn  => 'database',
+            copy => 1,
+         },
+         F => {
+            desc => 'Only read default options from the given file',
+            dsn  => 'mysql_read_default_file',
+            copy => 1,
+         },
+         h => {
+            desc => 'Connect to host',
+            dsn  => 'host',
+            copy => 1,
+         },
+         p => {
+            desc => 'Password to use when connecting',
+            dsn  => 'password',
+            copy => 1,
+         },
+         P => {
+            desc => 'Port number to use for connection',
+            dsn  => 'port',
+            copy => 1,
+         },
+         S => {
+            desc => 'Socket file to use for connection',
+            dsn  => 'mysql_socket',
+            copy => 1,
+         },
+         u => {
+            desc => 'User for login if not current user',
+            dsn  => 'user',
+            copy => 1,
+         },
+      },
+   };
+   foreach my $opt ( @opts ) {
+      MKDEBUG && _d('Adding extra property ' . $opt->{key});
+      $self->{opts}->{$opt->{key}} = { desc => $opt->{desc}, copy => $opt->{copy} };
+   }
+   return bless $self, $class;
+}
+
+# Recognized properties:
+# * autokey:   which key to treat a bareword as (typically h=host).
+# * dbidriver: which DBI driver to use; assumes mysql, supports Pg.
+# * required:  which parts are required (hashref).
+# * setvars:   a list of variables to set after connecting
+sub prop {
+   my ( $self, $prop, $value ) = @_;
+   if ( @_ > 2 ) {
+      MKDEBUG && _d("Setting $prop property");
+      $self->{$prop} = $value;
+   }
+   return $self->{$prop};
+}
+
+sub parse {
+   my ( $self, $dsn, $prev, $defaults ) = @_;
+   if ( !$dsn ) {
+      MKDEBUG && _d('No DSN to parse');
+      return;
+   }
+   MKDEBUG && _d("Parsing $dsn");
+   $prev     ||= {};
+   $defaults ||= {};
+   my %given_props;
+   my %final_props;
+   my %opts = %{$self->{opts}};
+   my $prop_autokey = $self->prop('autokey');
+
+   # Parse given props
+   foreach my $dsn_part ( split(/,/, $dsn) ) {
+      if ( my ($prop_key, $prop_val) = $dsn_part =~  m/^(.)=(.*)$/ ) {
+         # Handle the typical DSN parts like h=host, P=3306, etc.
+         $given_props{$prop_key} = $prop_val;
+      }
+      elsif ( $prop_autokey ) {
+         # Handle barewords
+         MKDEBUG && _d("Interpreting $dsn_part as $prop_autokey=$dsn_part");
+         $given_props{$prop_autokey} = $dsn_part;
+      }
+      else {
+         MKDEBUG && _d("Bad DSN part: $dsn_part");
+      }
+   }
+
+   # Fill in final props from given, previous, and/or default props
+   foreach my $key ( keys %opts ) {
+      MKDEBUG && _d("Finding value for $key");
+      $final_props{$key} = $given_props{$key};
+      if (   !defined $final_props{$key}
+           && defined $prev->{$key} && $opts{$key}->{copy} )
+      {
+         $final_props{$key} = $prev->{$key};
+         MKDEBUG && _d("Copying value for $key from previous DSN");
+      }
+      if ( !defined $final_props{$key} ) {
+         $final_props{$key} = $defaults->{$key};
+         MKDEBUG && _d("Copying value for $key from defaults");
+      }
+   }
+
+   # Sanity check props
+   foreach my $key ( keys %given_props ) {
+      die "Unrecognized DSN part '$key' in '$dsn'\n"
+         unless exists $opts{$key};
+   }
+   if ( (my $required = $self->prop('required')) ) {
+      foreach my $key ( keys %$required ) {
+         die "Missing DSN part '$key' in '$dsn'\n" unless $final_props{$key};
+      }
+   }
+
+   return \%final_props;
+}
+
+sub as_string {
+   my ( $self, $dsn ) = @_;
+   return $dsn unless ref $dsn;
+   return join(',',
+      map  { "$_=" . ($_ eq 'p' ? '...' : $dsn->{$_}) }
+      grep { defined $dsn->{$_} && $self->{opts}->{$_} }
+      sort keys %$dsn );
+}
+
+sub usage {
+   my ( $self ) = @_;
+   my $usage
+      = "DSN syntax is key=value[,key=value...]  Allowable DSN keys:\n"
+      . "  KEY  COPY  MEANING\n"
+      . "  ===  ====  =============================================\n";
+   my %opts = %{$self->{opts}};
+   foreach my $key ( sort keys %opts ) {
+      $usage .= "  $key    "
+             .  ($opts{$key}->{copy} ? 'yes   ' : 'no    ')
+             .  ($opts{$key}->{desc} || '[No description]')
+             . "\n";
+   }
+   if ( (my $key = $self->prop('autokey')) ) {
+      $usage .= "  If the DSN is a bareword, the word is treated as the '$key' key.\n";
+   }
+   return $usage;
+}
+
+# Supports PostgreSQL via the dbidriver element of $info, but assumes MySQL by
+# default.
+sub get_cxn_params {
+   my ( $self, $info ) = @_;
+   my $dsn;
+   my %opts = %{$self->{opts}};
+   my $driver = $self->prop('dbidriver') || '';
+   if ( $driver eq 'Pg' ) {
+      $dsn = 'DBI:Pg:dbname=' . ( $info->{D} || '' ) . ';'
+         . join(';', map  { "$opts{$_}->{dsn}=$info->{$_}" }
+                     grep { defined $info->{$_} }
+                     qw(h P));
+   }
+   else {
+      $dsn = 'DBI:mysql:' . ( $info->{D} || '' ) . ';'
+         . join(';', map  { "$opts{$_}->{dsn}=$info->{$_}" }
+                     grep { defined $info->{$_} }
+                     qw(F h P S A))
+         . ';mysql_read_default_group=client';
+   }
+   MKDEBUG && _d($dsn);
+   return ($dsn, $info->{u}, $info->{p});
+}
+
+
+# Fills in missing info from a DSN after successfully connecting to the server.
+sub fill_in_dsn {
+   my ( $self, $dbh, $dsn ) = @_;
+   my $vars = $dbh->selectall_hashref('SHOW VARIABLES', 'Variable_name');
+   my ($user, $db) = $dbh->selectrow_array('SELECT USER(), DATABASE()');
+   $user =~ s/@.*//;
+   $dsn->{h} ||= $vars->{hostname}->{Value};
+   $dsn->{S} ||= $vars->{'socket'}->{Value};
+   $dsn->{P} ||= $vars->{port}->{Value};
+   $dsn->{u} ||= $user;
+   $dsn->{D} ||= $db;
+}
+
+sub get_dbh {
+   my ( $self, $cxn_string, $user, $pass, $opts ) = @_;
+   $opts ||= {};
+   my $defaults = {
+      AutoCommit        => 0,
+      RaiseError        => 1,
+      PrintError        => 0,
+      mysql_enable_utf8 => ($cxn_string =~ m/charset=utf8/ ? 1 : 0),
+   };
+   @{$defaults}{ keys %$opts } = values %$opts;
+   my $dbh;
+   my $tries = 2;
+   while ( !$dbh && $tries-- ) {
+      eval {
+         MKDEBUG && _d($cxn_string, ' ', $user, ' ', $pass, ' {',
+            join(', ', map { "$_=>$defaults->{$_}" } keys %$defaults ), '}');
+         $dbh = DBI->connect($cxn_string, $user, $pass, $defaults);
+         # Immediately set character set and binmode on STDOUT.
+         if ( my ($charset) = $cxn_string =~ m/charset=(\w+)/ ) {
+            my $sql = "/*!40101 SET NAMES $charset*/";
+            MKDEBUG && _d("$dbh: $sql");
+            $dbh->do($sql);
+            MKDEBUG && _d('Enabling charset for STDOUT');
+            if ( $charset eq 'utf8' ) {
+               binmode(STDOUT, ':utf8')
+                  or die "Can't binmode(STDOUT, ':utf8'): $OS_ERROR";
+            }
+            else {
+               binmode(STDOUT) or die "Can't binmode(STDOUT): $OS_ERROR";
+            }
+         }
+      };
+      if ( !$dbh && $EVAL_ERROR ) {
+         MKDEBUG && _d($EVAL_ERROR);
+         if ( $EVAL_ERROR =~ m/not a compiled character set|character set utf8/ ) {
+            MKDEBUG && _d("Going to try again without utf8 support");
+            delete $defaults->{mysql_enable_utf8};
+         }
+         if ( !$tries ) {
+            die $EVAL_ERROR;
+         }
+      }
+   }
+   # If setvars exists and it's MySQL connection, set them
+   my $setvars = $self->prop('setvars');
+   if ( $cxn_string =~ m/mysql/i && $setvars ) {
+      my $sql = "SET $setvars";
+      MKDEBUG && _d("$dbh: $sql");
+      eval {
+         $dbh->do($sql);
+      };
+      if ( $EVAL_ERROR ) {
+         MKDEBUG && _d($EVAL_ERROR);
+      }
+   }
+   MKDEBUG && _d('DBH info: ',
+      $dbh,
+      Dumper($dbh->selectrow_hashref(
+         'SELECT DATABASE(), CONNECTION_ID(), VERSION()/*!50038 , @@hostname*/')),
+      ' Connection info: ', ($dbh->{mysql_hostinfo} || 'undef'),
+      ' Character set info: ',
+      Dumper($dbh->selectall_arrayref(
+         'SHOW VARIABLES LIKE "character_set%"', { Slice => {}})),
+      ' $DBD::mysql::VERSION: ', $DBD::mysql::VERSION,
+      ' $DBI::VERSION: ', $DBI::VERSION,
+   );
+   return $dbh;
+}
+
+# Tries to figure out a hostname for the connection.
+sub get_hostname {
+   my ( $self, $dbh ) = @_;
+   if ( my ($host) = ($dbh->{mysql_hostinfo} || '') =~ m/^(\w+) via/ ) {
+      return $host;
+   }
+   my ( $hostname, $one ) = $dbh->selectrow_array(
+      'SELECT /*!50038 @@hostname, */ 1');
+   return $hostname;
+}
+
+# Disconnects a database handle, but complains verbosely if there are any active
+# children.  These are usually $sth handles that haven't been finish()ed.
+sub disconnect {
+   my ( $self, $dbh ) = @_;
+   MKDEBUG && $self->print_active_handles($dbh);
+   $dbh->disconnect;
+}
+
+sub print_active_handles {
+   my ( $self, $thing, $level ) = @_;
+   $level ||= 0;
+   printf("# Active %sh: %s %s %s\n", ($thing->{Type} || 'undef'), "\t" x $level,
+      $thing, (($thing->{Type} || '') eq 'st' ? $thing->{Statement} || '' : ''))
+      or die "Cannot print: $OS_ERROR";
+   foreach my $handle ( grep {defined} @{ $thing->{ChildHandles} } ) {
+      $self->print_active_handles( $handle, $level + 1 );
+   }
+}
+
+sub _d {
+   my ($package, undef, $line) = caller 0;
+   @_ = map { (my $temp = $_) =~ s/\n/\n# /g; $temp; }
+        map { defined $_ ? $_ : 'undef' }
+        @_;
+   # Use $$ instead of $PID in case the package
+   # does not use English.
+   print "# $package:$line $$ ", @_, "\n";
+}
+
+1;
+
+package InnoDBParser;
+
+use Data::Dumper;
+$Data::Dumper::Sortkeys = 1;
+use English qw(-no_match_vars);
+use List::Util qw(max);
+
+# Some common patterns
+my $d  = qr/(\d+)/;                    # Digit
+my $f  = qr/(\d+\.\d+)/;               # Float
+my $t  = qr/(\d+ \d+)/;                # Transaction ID
+my $i  = qr/((?:\d{1,3}\.){3}\d+)/;    # IP address
+my $n  = qr/([^`\s]+)/;                # MySQL object name
+my $w  = qr/(\w+)/;                    # Words
+my $fl = qr/([\w\.\/]+) line $d/;      # Filename and line number
+my $h  = qr/((?:0x)?[0-9a-f]*)/;       # Hex
+my $s  = qr/(\d{6} .\d:\d\d:\d\d)/;    # InnoDB timestamp
+
+# If you update this variable, also update the SYNOPSIS in the pod.
+my %innodb_section_headers = (
+   "TRANSACTIONS"                          => "tx",
+   "BUFFER POOL AND MEMORY"                => "bp",
+   "SEMAPHORES"                            => "sm",
+   "LOG"                                   => "lg",
+   "ROW OPERATIONS"                        => "ro",
+   "INSERT BUFFER AND ADAPTIVE HASH INDEX" => "ib",
+   "FILE I/O"                              => "io",
+   "LATEST DETECTED DEADLOCK"              => "dl",
+   "LATEST FOREIGN KEY ERROR"              => "fk",
+);
+
+my %parser_for = (
+   tx => \&parse_tx_section,
+   bp => \&parse_bp_section,
+   sm => \&parse_sm_section,
+   lg => \&parse_lg_section,
+   ro => \&parse_ro_section,
+   ib => \&parse_ib_section,
+   io => \&parse_io_section,
+   dl => \&parse_dl_section,
+   fk => \&parse_fk_section,
+);
+
+my %fk_parser_for = (
+   Transaction => \&parse_fk_transaction_error,
+   Error       => \&parse_fk_bad_constraint_error,
+   Cannot      => \&parse_fk_cant_drop_parent_error,
+);
+
+# A thread's proc_info can be at least 98 different things I've found in the
+# source.  Fortunately, most of them begin with a gerunded verb.  These are
+# the ones that don't.
+my %is_proc_info = (
+   'After create'                 => 1,
+   'Execution of init_command'    => 1,
+   'FULLTEXT initialization'      => 1,
+   'Reopen tables'                => 1,
+   'Repair done'                  => 1,
+   'Repair with keycache'         => 1,
+   'System lock'                  => 1,
+   'Table lock'                   => 1,
+   'Thread initialized'           => 1,
+   'User lock'                    => 1,
+   'copy to tmp table'            => 1,
+   'discard_or_import_tablespace' => 1,
+   'end'                          => 1,
+   'got handler lock'             => 1,
+   'got old table'                => 1,
+   'init'                         => 1,
+   'key cache'                    => 1,
+   'locks'                        => 1,
+   'malloc'                       => 1,
+   'query end'                    => 1,
+   'rename result table'          => 1,
+   'rename'                       => 1,
+   'setup'                        => 1,
+   'statistics'                   => 1,
+   'status'                       => 1,
+   'table cache'                  => 1,
+   'update'                       => 1,
+);
+
+sub new {
+   bless {}, shift;
+}
+
+# Parse the status and return it.
+# See srv_printf_innodb_monitor in innobase/srv/srv0srv.c
+# Pass in the text to parse, whether to be in debugging mode, which sections
+# to parse (hashref; if empty, parse all), and whether to parse full info from
+# locks and such (probably shouldn't unless you need to).
+sub parse_status_text {
+   my ( $self, $fulltext, $debug, $sections, $full ) = @_;
+
+   die "I can't parse undef" unless defined $fulltext;
+   $fulltext =~ s/[\r\n]+/\n/g;
+
+   $sections ||= {};
+   die '$sections must be a hashref' unless ref($sections) eq 'HASH';
+
+   my %innodb_data = (
+      got_all   => 0,         # Whether I was able to get the whole thing
+      ts        => '',        # Timestamp the server put on it
+      last_secs => 0,         # Num seconds the averages are over
+      sections  => {},        # Parsed values from each section
+   );
+
+   if ( $debug ) {
+      $innodb_data{'fulltext'} = $fulltext;
+   }
+
+   # Get the most basic info about the status: beginning and end, and whether
+   # I got the whole thing (if there has been a big deadlock and there are
+   # too many locks to print, the output might be truncated)
+   my ( $time_text ) = $fulltext =~ m/^$s INNODB MONITOR OUTPUT$/m;
+   $innodb_data{'ts'} = [ parse_innodb_timestamp( $time_text ) ];
+   $innodb_data{'timestring'} = ts_to_string($innodb_data{'ts'});
+   ( $innodb_data{'last_secs'} ) = $fulltext
+      =~ m/Per second averages calculated from the last $d seconds/;
+
+   ( my $got_all ) = $fulltext =~ m/END OF INNODB MONITOR OUTPUT/;
+   $innodb_data{'got_all'} = $got_all || 0;
+
+   # Split it into sections.  Each section begins with
+   # -----
+   # LABEL
+   # -----
+   my %innodb_sections;
+   my @matches = $fulltext
+      =~ m#\n(---+)\n([A-Z /]+)\n\1\n(.*?)(?=\n(---+)\n[A-Z /]+\n\4\n|$)#gs;
+   while ( my ( $start, $name, $text, $end ) = splice(@matches, 0, 4) ) {
+      $innodb_sections{$name} = [ $text, $end ? 1 : 0 ];
+   }
+   # The Row Operations section is a special case, because instead of ending
+   # with the beginning of another section, it ends with the end of the file.
+   # So this section is complete if the entire file is complete.
+   $innodb_sections{'ROW OPERATIONS'}->[1] ||= $innodb_data{'got_all'};
+
+   # Just for sanity's sake, make sure I understand what to do with each
+   # section
+   eval {
+      foreach my $section ( keys %innodb_sections ) {
+         my $header = $innodb_section_headers{$section};
+         die "Unknown section $section in $fulltext\n"
+            unless $header;
+         $innodb_data{'sections'}->{ $header }
+            ->{'fulltext'} = $innodb_sections{$section}->[0];
+         $innodb_data{'sections'}->{ $header }
+            ->{'complete'} = $innodb_sections{$section}->[1];
+      }
+   };
+   if ( $EVAL_ERROR ) {
+      _debug( $debug, $EVAL_ERROR);
+   }
+
+   # ################################################################
+   # Parse the detailed data out of the sections.
+   # ################################################################
+   eval {
+      foreach my $section ( keys %parser_for ) {
+         if ( defined $innodb_data{'sections'}->{$section}
+               && (!%$sections || (defined($sections->{$section} && $sections->{$section})) )) {
+            $parser_for{$section}->(
+                  $innodb_data{'sections'}->{$section},
+                  $innodb_data{'sections'}->{$section}->{'complete'},
+                  $debug,
+                  $full )
+               or delete $innodb_data{'sections'}->{$section};
+         }
+         else {
+            delete $innodb_data{'sections'}->{$section};
+         }
+      }
+   };
+   if ( $EVAL_ERROR ) {
+      _debug( $debug, $EVAL_ERROR);
+   }
+
+   return \%innodb_data;
+}
+
+# Parses the status text and returns it flattened out as a single hash.
+sub get_status_hash {
+   my ( $self, $fulltext, $debug, $sections, $full ) = @_;
+
+   # Parse the status text...
+   my $innodb_status
+      = $self->parse_status_text($fulltext, $debug, $sections, $full );
+
+   # Flatten the hierarchical structure into a single list by grabbing desired
+   # sections from it.
+   return
+      (map { 'IB_' . $_ => $innodb_status->{$_} } qw(timestring last_secs got_all)),
+      (map { 'IB_bp_' . $_ => $innodb_status->{'sections'}->{'bp'}->{$_} }
+         qw( writes_pending buf_pool_hit_rate total_mem_alloc buf_pool_reads
+            awe_mem_alloc pages_modified writes_pending_lru page_creates_sec
+            reads_pending pages_total buf_pool_hits writes_pending_single_page
+            page_writes_sec pages_read pages_written page_reads_sec
+            writes_pending_flush_list buf_pool_size add_pool_alloc
+            dict_mem_alloc pages_created buf_free complete )),
+      (map { 'IB_tx_' . $_ => $innodb_status->{'sections'}->{'tx'}->{$_} }
+         qw( num_lock_structs history_list_len purge_done_for transactions
+            purge_undo_for is_truncated trx_id_counter complete )),
+      (map { 'IB_ib_' . $_ => $innodb_status->{'sections'}->{'ib'}->{$_} }
+         qw( hash_table_size hash_searches_s non_hash_searches_s
+            bufs_in_node_heap used_cells size free_list_len seg_size inserts
+            merged_recs merges complete )),
+      (map { 'IB_lg_' . $_ => $innodb_status->{'sections'}->{'lg'}->{$_} }
+         qw( log_ios_done pending_chkp_writes last_chkp log_ios_s
+            log_flushed_to log_seq_no pending_log_writes complete )),
+      (map { 'IB_sm_' . $_ => $innodb_status->{'sections'}->{'sm'}->{$_} }
+         qw( wait_array_size rw_shared_spins rw_excl_os_waits mutex_os_waits
+            mutex_spin_rounds mutex_spin_waits rw_excl_spins rw_shared_os_waits
+            waits signal_count reservation_count complete )),
+      (map { 'IB_ro_' . $_ => $innodb_status->{'sections'}->{'ro'}->{$_} }
+         qw( queries_in_queue n_reserved_extents main_thread_state
+         main_thread_proc_no main_thread_id read_sec del_sec upd_sec ins_sec
+         read_views_open num_rows_upd num_rows_ins num_rows_read
+         queries_inside num_rows_del complete )),
+      (map { 'IB_fk_' . $_ => $innodb_status->{'sections'}->{'fk'}->{$_} }
+         qw( trigger parent_table child_index parent_index attempted_op
+         child_db timestring fk_name records col_name reason txn parent_db
+         type child_table parent_col complete )),
+      (map { 'IB_io_' . $_ => $innodb_status->{'sections'}->{'io'}->{$_} }
+         qw( pending_buffer_pool_flushes pending_pwrites pending_preads
+         pending_normal_aio_reads fsyncs_s os_file_writes pending_sync_ios
+         reads_s flush_type avg_bytes_s pending_ibuf_aio_reads writes_s
+         threads os_file_reads pending_aio_writes pending_log_ios os_fsyncs
+         pending_log_flushes complete )),
+      (map { 'IB_dl_' . $_ => $innodb_status->{'sections'}->{'dl'}->{$_} }
+         qw( timestring rolled_back txns complete ));
+
+}
+
+sub ts_to_string {
+   my $parts = shift;
+   return sprintf('%02d-%02d-%02d %02d:%02d:%02d', @$parts);
+}
+
+sub parse_innodb_timestamp {
+   my $text = shift;
+   my ( $y, $m, $d, $h, $i, $s )
+      = $text =~ m/^(\d\d)(\d\d)(\d\d) +(\d+):(\d+):(\d+)$/;
+   die("Can't get timestamp from $text\n") unless $y;
+   $y += 2000;
+   return ( $y, $m, $d, $h, $i, $s );
+}
+
+sub parse_fk_section {
+   my ( $section, $complete, $debug, $full ) = @_;
+   my $fulltext = $section->{'fulltext'};
+
+   return 0 unless $fulltext;
+
+   my ( $ts, $type ) = $fulltext =~ m/^$s\s+(\w+)/m;
+   $section->{'ts'} = [ parse_innodb_timestamp( $ts ) ];
+   $section->{'timestring'} = ts_to_string($section->{'ts'});
+   $section->{'type'} = $type;
+
+   # Decide which type of FK error happened, and dispatch to the right parser.
+   if ( $type && $fk_parser_for{$type} ) {
+      $fk_parser_for{$type}->( $section, $complete, $debug, $fulltext, $full );
+   }
+
+   delete $section->{'fulltext'} unless $debug;
+
+   return 1;
+}
+
+sub parse_fk_cant_drop_parent_error {
+   my ( $section, $complete, $debug, $fulltext, $full ) = @_;
+
+   # Parse the parent/child table info out
+   @{$section}{ qw(attempted_op parent_db parent_table) } = $fulltext
+      =~ m{Cannot $w table `(.*)/(.*)`}m;
+   @{$section}{ qw(child_db child_table) } = $fulltext
+      =~ m{because it is referenced by `(.*)/(.*)`}m;
+
+   ( $section->{'reason'} ) = $fulltext =~ m/(Cannot .*)/s;
+   $section->{'reason'} =~ s/\n(?:InnoDB: )?/ /gm
+      if $section->{'reason'};
+
+   # Certain data may not be present.  Make them '' if not present.
+   map { $section->{$_} ||= "" }
+      qw(child_index fk_name col_name parent_col);
+}
+
+# See dict/dict0dict.c, function dict_foreign_error_report
+# I don't care much about these.  There are lots of different messages, and
+# they come from someone trying to create a foreign key, or similar
+# statements.  They aren't indicative of some transaction trying to insert,
+# delete or update data.  Sometimes it is possible to parse out a lot of
+# information about the tables and indexes involved, but often the message
+# contains the DDL string the user entered, which is way too much for this
+# module to try to handle.
+sub parse_fk_bad_constraint_error {
+   my ( $section, $complete, $debug, $fulltext, $full ) = @_;
+
+   # Parse the parent/child table and index info out
+   @{$section}{ qw(child_db child_table) } = $fulltext
+      =~ m{Error in foreign key constraint of table (.*)/(.*):$}m;
+   $section->{'attempted_op'} = 'DDL';
+
+   # FK name, parent info... if possible.
+   @{$section}{ qw(fk_name col_name parent_db parent_table parent_col) }
+      = $fulltext
+      =~ m/CONSTRAINT `?$n`? FOREIGN KEY \(`?$n`?\) REFERENCES (?:`?$n`?\.)?`?$n`? \(`?$n`?\)/;
+
+   if ( !defined($section->{'fk_name'}) ) {
+      # Try to parse SQL a user might have typed in a CREATE statement or such
+      @{$section}{ qw(col_name parent_db parent_table parent_col) }
+         = $fulltext
+         =~ m/FOREIGN\s+KEY\s*\(`?$n`?\)\s+REFERENCES\s+(?:`?$n`?\.)?`?$n`?\s*\(`?$n`?\)/i;
+   }
+   $section->{'parent_db'} ||= $section->{'child_db'};
+
+   # Name of the child index (index in the same table where the FK is, see
+   # definition of dict_foreign_struct in include/dict0mem.h, where it is
+   # called foreign_index, as opposed to referenced_index which is in the
+   # parent table.  This may not be possible to find.
+   @{$section}{ qw(child_index) } = $fulltext
+      =~ m/^The index in the foreign key in table is $n$/m;
+
+   @{$section}{ qw(reason) } = $fulltext =~ m/:\s*([^:]+)(?= Constraint:|$)/ms;
+   $section->{'reason'} =~ s/\s+/ /g
+      if $section->{'reason'};
+   
+   # Certain data may not be present.  Make them '' if not present.
+   map { $section->{$_} ||= "" }
+      qw(child_index fk_name col_name parent_table parent_col);
+}
+
+# see source file row/row0ins.c
+sub parse_fk_transaction_error {
+   my ( $section, $complete, $debug, $fulltext, $full ) = @_;
+
+   # Parse the txn info out
+   my ( $txn ) = $fulltext
+      =~ m/Transaction:\n(TRANSACTION.*)\nForeign key constraint fails/s;
+   if ( $txn ) {
+      $section->{'txn'} = parse_tx_text( $txn, $complete, $debug, $full );
+   }
+
+   # Parse the parent/child table and index info out.  There are two types: an
+   # update or a delete of a parent record leaves a child orphaned
+   # (row_ins_foreign_report_err), and an insert or update of a child record has
+   # no matching parent record (row_ins_foreign_report_add_err).
+
+   @{$section}{ qw(reason child_db child_table) }
+      = $fulltext =~ m{^(Foreign key constraint fails for table `(.*)/(.*)`:)$}m;
+
+   @{$section}{ qw(fk_name col_name parent_db parent_table parent_col) }
+      = $fulltext
+      =~ m/CONSTRAINT `$n` FOREIGN KEY \(`$n`\) REFERENCES (?:`$n`\.)?`$n` \(`$n`\)/;
+   $section->{'parent_db'} ||= $section->{'child_db'};
+
+   # Special case, which I don't know how to trigger, but see
+   # innobase/row/row0ins.c row_ins_check_foreign_constraint
+   if ( $fulltext =~ m/ibd file does not currently exist!/ ) {
+      my ( $attempted_op, $index, $records )
+         = $fulltext =~ m/^Trying to (add to index) `$n` tuple:\n(.*))?/sm;
+      $section->{'child_index'} = $index;
+      $section->{'attempted_op'} = $attempted_op || '';
+      if ( $records && $full ) {
+         ( $section->{'records'} )
+            = parse_innodb_record_dump( $records, $complete, $debug );
+      }
+      @{$section}{qw(parent_db parent_table)}
+         =~ m/^But the parent table `$n`\.`$n`$/m;
+   }
+   else {
+      my ( $attempted_op, $which, $index )
+         = $fulltext =~ m/^Trying to ([\w ]*) in (child|parent) table, in index `$n` tuple:$/m;
+      if ( $which ) {
+         $section->{$which . '_index'} = $index;
+         $section->{'attempted_op'} = $attempted_op || '';
+
+         # Parse out the related records in the other table.
+         my ( $search_index, $records );
+         if ( $which eq 'child' ) {
+            ( $search_index, $records ) = $fulltext
+               =~ m/^But in parent table [^,]*, in index `$n`,\nthe closest match we can find is record:\n(.*)/ms;
+            $section->{'parent_index'} = $search_index;
+         }
+         else {
+            ( $search_index, $records ) = $fulltext
+               =~ m/^But in child table [^,]*, in index `$n`, (?:the record is not available|there is a record:\n(.*))?/ms;
+            $section->{'child_index'} = $search_index;
+         }
+         if ( $records && $full ) {
+            $section->{'records'}
+               = parse_innodb_record_dump( $records, $complete, $debug );
+         }
+         else {
+            $section->{'records'} = '';
+         }
+      }
+   }
+
+   # Parse out the tuple trying to be updated, deleted or inserted.
+   my ( $trigger ) = $fulltext =~ m/^(DATA TUPLE: \d+ fields;\n.*)$/m;
+   if ( $trigger ) {
+      $section->{'trigger'} = parse_innodb_record_dump( $trigger, $complete, $debug );
+   }
+
+   # Certain data may not be present.  Make them '' if not present.
+   map { $section->{$_} ||= "" }
+      qw(child_index fk_name col_name parent_table parent_col);
+}
+
+# There are new-style and old-style record formats.  See rem/rem0rec.c
+# TODO: write some tests for this
+sub parse_innodb_record_dump {
+   my ( $dump, $complete, $debug ) = @_;
+   return undef unless $dump;
+
+   my $result = {};
+
+   if ( $dump =~ m/PHYSICAL RECORD/ ) {
+      my $style = $dump =~ m/compact format/ ? 'new' : 'old';
+      $result->{'style'} = $style;
+
+      # This is a new-style record.
+      if ( $style eq 'new' ) {
+         @{$result}{qw( heap_no type num_fields info_bits )}
+            = $dump
+            =~ m/^(?:Record lock, heap no $d )?([A-Z ]+): n_fields $d; compact format; info bits $d$/m;
+      }
+
+      # OK, it's old-style.  Unfortunately there are variations here too.
+      elsif ( $dump =~ m/-byte offs / ) {
+         # Older-old style.
+         @{$result}{qw( heap_no type num_fields byte_offset info_bits )}
+            = $dump
+            =~ m/^(?:Record lock, heap no $d )?([A-Z ]+): n_fields $d; $d-byte offs [A-Z]+; info bits $d$/m;
+            if ( $dump !~ m/-byte offs TRUE/ ) {
+               $result->{'byte_offset'} = 0;
+            }
+      }
+      else {
+         # Newer-old style.
+         @{$result}{qw( heap_no type num_fields byte_offset info_bits )}
+            = $dump
+            =~ m/^(?:Record lock, heap no $d )?([A-Z ]+): n_fields $d; $d-byte offsets; info bits $d$/m;
+      }
+
+   }
+   else {
+      $result->{'style'} = 'tuple';
+      @{$result}{qw( type num_fields )}
+         = $dump =~ m/^(DATA TUPLE): $d fields;$/m;
+   }
+
+   # Fill in default values for things that couldn't be parsed.
+   map { $result->{$_} ||= 0 }
+      qw(heap_no num_fields byte_offset info_bits);
+   map { $result->{$_} ||= '' }
+      qw(style type );
+
+   my @fields = $dump =~ m/ (\d+:.*?;?);(?=$| \d+:)/gm;
+   $result->{'fields'} = [ map { parse_field($_, $complete, $debug ) } @fields ];
+
+   return $result;
+}
+
+# New/old-style applies here.  See rem/rem0rec.c
+# $text should not include the leading space or the second trailing semicolon.
+sub parse_field {
+   my ( $text, $complete, $debug ) = @_;
+
+   # Sample fields:
+   # '4: SQL NULL, size 4 '
+   # '1: len 6; hex 000000005601; asc     V ;'
+   # '6: SQL NULL'
+   # '5: len 30; hex 687474703a2f2f7777772e737765657477617465722e636f6d2f73746f72; asc http://www.sweetwater.com/stor;...(truncated)'
+   my ( $id, $nullsize, $len, $hex, $asc, $truncated );
+   ( $id, $nullsize ) = $text =~ m/^$d: SQL NULL, size $d $/;
+   if ( !defined($id) ) {
+      ( $id ) = $text =~ m/^$d: SQL NULL$/;
+   }
+   if ( !defined($id) ) {
+      ( $id, $len, $hex, $asc, $truncated )
+         = $text =~ m/^$d: len $d; hex $h; asc (.*);(\.\.\.\(truncated\))?$/;
+   }
+
+   die "Could not parse this field: '$text'" unless defined $id;
+   return {
+      id    => $id,
+      len   => defined($len) ? $len : defined($nullsize) ? $nullsize : 0,
+      'hex' => defined($hex) ? $hex : '',
+      asc   => defined($asc) ? $asc : '',
+      trunc => $truncated ? 1 : 0,
+   };
+
+}
+
+sub parse_dl_section {
+   my ( $dl, $complete, $debug, $full ) = @_;
+   return unless $dl;
+   my $fulltext = $dl->{'fulltext'};
+   return 0 unless $fulltext;
+
+   my ( $ts ) = $fulltext =~ m/^$s$/m;
+   return 0 unless $ts;
+
+   $dl->{'ts'} = [ parse_innodb_timestamp( $ts ) ];
+   $dl->{'timestring'} = ts_to_string($dl->{'ts'});
+   $dl->{'txns'} = {};
+
+   my @sections
+      = $fulltext
+      =~ m{
+         ^\*{3}\s([^\n]*)  # *** (1) WAITING FOR THIS...
+         (.*?)             # Followed by anything, non-greedy
+         (?=(?:^\*{3})|\z) # Followed by another three stars or EOF
+      }gmsx;
+
+
+   # Loop through each section.  There are no assumptions about how many
+   # there are, who holds and wants what locks, and who gets rolled back.
+   while ( my ($header, $body) = splice(@sections, 0, 2) ) {
+      my ( $txn_id, $what ) = $header =~ m/^\($d\) (.*):$/;
+      next unless $txn_id;
+      $dl->{'txns'}->{$txn_id} ||= {};
+      my $txn = $dl->{'txns'}->{$txn_id};
+
+      if ( $what eq 'TRANSACTION' ) {
+         $txn->{'tx'} = parse_tx_text( $body, $complete, $debug, $full );
+      }
+      else {
+         push @{$txn->{'locks'}}, parse_innodb_record_locks( $body, $complete, $debug, $full );
+      }
+   }
+
+   @{ $dl }{ qw(rolled_back) }
+      = $fulltext =~ m/^\*\*\* WE ROLL BACK TRANSACTION \($d\)$/m;
+
+   # Make sure certain values aren't undef
+   map { $dl->{$_} ||= '' } qw(rolled_back);
+
+   delete $dl->{'fulltext'} unless $debug;
+   return 1;
+}
+
+sub parse_innodb_record_locks {
+   my ( $text, $complete, $debug, $full ) = @_;
+   my @result;
+
+   foreach my $lock ( $text =~ m/(^(?:RECORD|TABLE) LOCKS?.*$)/gm ) {
+      my $hash = {};
+      @{$hash}{ qw(lock_type space_id page_no n_bits index db table txn_id lock_mode) }
+         = $lock
+         =~ m{^(RECORD|TABLE) LOCKS? (?:space id $d page no $d n bits $d index `?$n`? of )?table `$n(?:/|`\.`)$n` trx id $t lock.mode (\S+)}m;
+      ( $hash->{'special'} )
+         = $lock =~ m/^(?:RECORD|TABLE) .*? locks (rec but not gap|gap before rec)/m;
+      $hash->{'insert_intention'}
+         = $lock =~ m/^(?:RECORD|TABLE) .*? insert intention/m ? 1 : 0;
+      $hash->{'waiting'}
+         = $lock =~ m/^(?:RECORD|TABLE) .*? waiting/m ? 1 : 0;
+
+      # Some things may not be in the text, so make sure they are not
+      # undef.
+      map { $hash->{$_} ||= 0 } qw(n_bits page_no space_id);
+      map { $hash->{$_} ||= "" } qw(index special);
+      push @result, $hash;
+   }
+
+   return @result;
+}
+
+sub parse_tx_text {
+   my ( $txn, $complete, $debug, $full ) = @_;
+
+   my ( $txn_id, $txn_status, $active_secs, $proc_no, $os_thread_id )
+      = $txn
+      =~ m/^(?:---)?TRANSACTION $t, (\D*?)(?: $d sec)?, (?:process no $d, )?OS thread id $d/m;
+   my ( $thread_status, $thread_decl_inside )
+      = $txn
+      =~ m/OS thread id \d+(?: ([^,]+?))?(?:, thread declared inside InnoDB $d)?$/m;
+
+   # Parsing the line that begins 'MySQL thread id' is complicated.  The only
+   # thing always in the line is the thread and query id.  See function
+   # innobase_mysql_print_thd in InnoDB source file sql/ha_innodb.cc.
+   my ( $thread_line ) = $txn =~ m/^(MySQL thread id .*)$/m;
+   my ( $mysql_thread_id, $query_id, $hostname, $ip, $user, $query_status );
+
+   if ( $thread_line ) {
+      # These parts can always be gotten.
+      ( $mysql_thread_id, $query_id ) = $thread_line =~ m/^MySQL thread id $d, query id $d/m;
+
+      # If it's a master/slave thread, "Has (read|sent) all" may be the thread's
+      # proc_info.  In these cases, there won't be any host/ip/user info
+      ( $query_status ) = $thread_line =~ m/(Has (?:read|sent) all .*$)/m;
+      if ( defined($query_status) ) {
+         $user = 'system user';
+      }
+
+      # It may be the case that the query id is the last thing in the line.
+      elsif ( $thread_line =~ m/query id \d+ / ) {
+         # The IP address is the only non-word thing left, so it's the most
+         # useful marker for where I have to start guessing.
+         ( $hostname, $ip ) = $thread_line =~ m/query id \d+(?: ([A-Za-z]\S+))? $i/m;
+         if ( defined $ip ) {
+            ( $user, $query_status ) = $thread_line =~ m/$ip $w(?: (.*))?$/;
+         }
+         else { # OK, there wasn't an IP address.
+            # There might not be ANYTHING except the query status.
+            ( $query_status ) = $thread_line =~ m/query id \d+ (.*)$/;
+            if ( $query_status !~ m/^\w+ing/ && !exists($is_proc_info{$query_status}) ) {
+               # The remaining tokens are, in order: hostname, user, query_status.
+               # It's basically impossible to know which is which.
+               ( $hostname, $user, $query_status ) = $thread_line
+                  =~ m/query id \d+(?: ([A-Za-z]\S+))?(?: $w(?: (.*))?)?$/m;
+            }
+            else {
+               $user = 'system user';
+            }
+         }
+      }
+   }
+
+   my ( $lock_wait_status, $lock_structs, $heap_size, $row_locks, $undo_log_entries )
+      = $txn
+      =~ m/^(?:(\D*) )?$d lock struct\(s\), heap size $d(?:, $d row lock\(s\))?(?:, undo log entries $d)?$/m;
+   my ( $lock_wait_time )
+      = $txn
+      =~ m/^------- TRX HAS BEEN WAITING $d SEC/m;
+
+   my $locks;
+   # If the transaction has locks, grab the locks.
+   if ( $txn =~ m/^TABLE LOCK|RECORD LOCKS/ ) {
+      $locks = [parse_innodb_record_locks($txn, $complete, $debug, $full)];
+   }
+   
+   my ( $tables_in_use, $tables_locked )
+      = $txn
+      =~ m/^mysql tables in use $d, locked $d$/m;
+   my ( $txn_doesnt_see_ge, $txn_sees_lt )
+      = $txn
+      =~ m/^Trx read view will not see trx with id >= $t, sees < $t$/m;
+   my $has_read_view = defined($txn_doesnt_see_ge);
+   # Only a certain number of bytes of the query text are included here, at least
+   # under some circumstances.  Some versions include 300, some 600.
+   my ( $query_text )
+      = $txn
+      =~ m{
+         ^MySQL\sthread\sid\s[^\n]+\n           # This comes before the query text
+         (.*?)                                  # The query text
+         (?=                                    # Followed by any of...
+            ^Trx\sread\sview
+            |^-------\sTRX\sHAS\sBEEN\sWAITING
+            |^TABLE\sLOCK
+            |^RECORD\sLOCKS\sspace\sid
+            |^(?:---)?TRANSACTION
+            |^\*\*\*\s\(\d\)
+            |\Z
+         )
+      }xms;
+   if ( $query_text ) {
+      $query_text =~ s/\s+$//;
+   }
+   else {
+      $query_text = '';
+   }
+
+   my %stuff = (
+      active_secs        => $active_secs,
+      has_read_view      => $has_read_view,
+      heap_size          => $heap_size,
+      hostname           => $hostname,
+      ip                 => $ip,
+      lock_structs       => $lock_structs,
+      lock_wait_status   => $lock_wait_status,
+      lock_wait_time     => $lock_wait_time,
+      mysql_thread_id    => $mysql_thread_id,
+      os_thread_id       => $os_thread_id,
+      proc_no            => $proc_no,
+      query_id           => $query_id,
+      query_status       => $query_status,
+      query_text         => $query_text,
+      row_locks          => $row_locks,
+      tables_in_use      => $tables_in_use,
+      tables_locked      => $tables_locked,
+      thread_decl_inside => $thread_decl_inside,
+      thread_status      => $thread_status,
+      txn_doesnt_see_ge  => $txn_doesnt_see_ge,
+      txn_id             => $txn_id,
+      txn_sees_lt        => $txn_sees_lt,
+      txn_status         => $txn_status,
+      undo_log_entries   => $undo_log_entries,
+      user               => $user,
+   );
+   $stuff{'fulltext'} = $txn if $debug;
+   $stuff{'locks'} = $locks if $locks;
+
+   # Some things may not be in the txn text, so make sure they are not
+   # undef.
+   map { $stuff{$_} ||= 0 } qw(active_secs heap_size lock_structs
+         tables_in_use undo_log_entries tables_locked has_read_view
+         thread_decl_inside lock_wait_time proc_no row_locks);
+   map { $stuff{$_} ||= "" } qw(thread_status txn_doesnt_see_ge
+         txn_sees_lt query_status ip query_text lock_wait_status user);
+   $stuff{'hostname'} ||= $stuff{'ip'};
+
+   return \%stuff;
+}
+
+sub parse_tx_section {
+   my ( $section, $complete, $debug, $full ) = @_;
+   return unless $section && $section->{'fulltext'};
+   my $fulltext = $section->{'fulltext'};
+   $section->{'transactions'} = [];
+
+   # Handle the individual transactions
+   my @transactions = $fulltext =~ m/(---TRANSACTION \d.*?)(?=\n---TRANSACTION|$)/gs;
+   foreach my $txn ( @transactions ) {
+      my $stuff = parse_tx_text( $txn, $complete, $debug, $full );
+      delete $stuff->{'fulltext'} unless $debug;
+      push @{$section->{'transactions'}}, $stuff;
+   }
+
+   # Handle the general info
+   @{$section}{ 'trx_id_counter' }
+      = $fulltext =~ m/^Trx id counter $t$/m;
+   @{$section}{ 'purge_done_for', 'purge_undo_for' }
+      = $fulltext =~ m/^Purge done for trx's n:o < $t undo n:o < $t$/m;
+   @{$section}{ 'history_list_len' } # This isn't present in some 4.x versions
+      = $fulltext =~ m/^History list length $d$/m;
+   @{$section}{ 'num_lock_structs' }
+      = $fulltext =~ m/^Total number of lock structs in row lock hash table $d$/m;
+   @{$section}{ 'is_truncated' }
+      = $fulltext =~ m/^\.\.\. truncated\.\.\.$/m ? 1 : 0;
+
+   # Fill in things that might not be present
+   foreach ( qw(history_list_len) ) {
+      $section->{$_} ||= 0;
+   }
+
+   delete $section->{'fulltext'} unless $debug;
+   return 1;
+}
+
+# I've read the source for this section.
+sub parse_ro_section {
+   my ( $section, $complete, $debug, $full ) = @_;
+   return unless $section && $section->{'fulltext'};
+   my $fulltext = $section->{'fulltext'};
+
+   # Grab the info
+   @{$section}{ 'queries_inside', 'queries_in_queue' }
+      = $fulltext =~ m/^$d queries inside InnoDB, $d queries in queue$/m;
+   ( $section->{ 'read_views_open' } )
+      = $fulltext =~ m/^$d read views open inside InnoDB$/m;
+   ( $section->{ 'n_reserved_extents' } )
+      = $fulltext =~ m/^$d tablespace extents now reserved for B-tree/m;
+   @{$section}{ 'main_thread_proc_no', 'main_thread_id', 'main_thread_state' }
+      = $fulltext =~ m/^Main thread (?:process no. $d, )?id $d, state: (.*)$/m;
+   @{$section}{ 'num_rows_ins', 'num_rows_upd', 'num_rows_del', 'num_rows_read' }
+      = $fulltext =~ m/^Number of rows inserted $d, updated $d, deleted $d, read $d$/m;
+   @{$section}{ 'ins_sec', 'upd_sec', 'del_sec', 'read_sec' }
+      = $fulltext =~ m#^$f inserts/s, $f updates/s, $f deletes/s, $f reads/s$#m;
+   $section->{'main_thread_proc_no'} ||= 0;
+
+   map { $section->{$_} ||= 0 } qw(read_views_open n_reserved_extents);
+   delete $section->{'fulltext'} unless $debug;
+   return 1;
+}
+
+sub parse_lg_section {
+   my ( $section, $complete, $debug, $full ) = @_;
+   return unless $section;
+   my $fulltext = $section->{'fulltext'};
+
+   # Grab the info
+   ( $section->{ 'log_seq_no' } )
+      = $fulltext =~ m/Log sequence number \s*(\d.*)$/m;
+   ( $section->{ 'log_flushed_to' } )
+      = $fulltext =~ m/Log flushed up to \s*(\d.*)$/m;
+   ( $section->{ 'last_chkp' } )
+      = $fulltext =~ m/Last checkpoint at \s*(\d.*)$/m;
+   @{$section}{ 'pending_log_writes', 'pending_chkp_writes' }
+      = $fulltext =~ m/$d pending log writes, $d pending chkp writes/;
+   @{$section}{ 'log_ios_done', 'log_ios_s' }
+      = $fulltext =~ m#$d log i/o's done, $f log i/o's/second#;
+
+   delete $section->{'fulltext'} unless $debug;
+   return 1;
+}
+
+sub parse_ib_section {
+   my ( $section, $complete, $debug, $full ) = @_;
+   return unless $section && $section->{'fulltext'};
+   my $fulltext = $section->{'fulltext'};
+
+   # Some servers will output ibuf information for tablespace 0, as though there
+   # might be many tablespaces with insert buffers.  (In practice I believe
+   # the source code shows there will only ever be one).  I have to parse both
+   # cases here, but I assume there will only be one.
+   @{$section}{ 'size', 'free_list_len', 'seg_size' }
+      = $fulltext =~ m/^Ibuf(?: for space 0)?: size $d, free list len $d, seg size $d,$/m;
+   @{$section}{ 'inserts', 'merged_recs', 'merges' }
+      = $fulltext =~ m/^$d inserts, $d merged recs, $d merges$/m;
+
+   @{$section}{ 'hash_table_size', 'used_cells', 'bufs_in_node_heap' }
+      = $fulltext =~ m/^Hash table size $d, used cells $d, node heap has $d buffer\(s\)$/m;
+   @{$section}{ 'hash_searches_s', 'non_hash_searches_s' }
+      = $fulltext =~ m{^$f hash searches/s, $f non-hash searches/s$}m;
+
+   delete $section->{'fulltext'} unless $debug;
+   return 1;
+}
+
+sub parse_wait_array {
+   my ( $text, $complete, $debug, $full ) = @_;
+   my %result;
+
+   @result{ qw(thread waited_at_filename waited_at_line waited_secs) }
+      = $text =~ m/^--Thread $d has waited at $fl for $f seconds/m;
+
+   # Depending on whether it's a SYNC_MUTEX,RW_LOCK_EX,RW_LOCK_SHARED,
+   # there will be different text output
+   if ( $text =~ m/^Mutex at/m ) {
+      $result{'request_type'} = 'M';
+      @result{ qw( lock_mem_addr lock_cfile_name lock_cline lock_var) }
+         = $text =~ m/^Mutex at $h created file $fl, lock var $d$/m;
+      @result{ qw( waiters_flag )}
+         = $text =~ m/^waiters flag $d$/m;
+   }
+   else {
+      @result{ qw( request_type lock_mem_addr lock_cfile_name lock_cline) }
+         = $text =~ m/^(.)-lock on RW-latch at $h created in file $fl$/m;
+      @result{ qw( writer_thread writer_lock_mode ) }
+         = $text =~ m/^a writer \(thread id $d\) has reserved it in mode  (.*)$/m;
+      @result{ qw( num_readers waiters_flag )}
+         = $text =~ m/^number of readers $d, waiters flag $d$/m;
+      @result{ qw(last_s_file_name last_s_line ) }
+         = $text =~ m/Last time read locked in file $fl$/m;
+      @result{ qw(last_x_file_name last_x_line ) }
+         = $text =~ m/Last time write locked in file $fl$/m;
+   }
+
+   $result{'cell_waiting'} = $text =~ m/^wait has ended$/m ? 0 : 1;
+   $result{'cell_event_set'} = $text =~ m/^wait is ending$/m ? 1 : 0;
+
+   # Because there are two code paths, some things won't get set.
+   map { $result{$_} ||= '' }
+      qw(last_s_file_name last_x_file_name writer_lock_mode);
+   map { $result{$_} ||= 0 }
+      qw(num_readers lock_var last_s_line last_x_line writer_thread);
+
+   return \%result;
+}
+
+sub parse_sm_section {
+   my ( $section, $complete, $debug, $full ) = @_;
+   return 0 unless $section && $section->{'fulltext'};
+   my $fulltext = $section->{'fulltext'};
+
+   # Grab the info
+   @{$section}{ 'reservation_count', 'signal_count' }
+      = $fulltext =~ m/^OS WAIT ARRAY INFO: reservation count $d, signal count $d$/m;
+   @{$section}{ 'mutex_spin_waits', 'mutex_spin_rounds', 'mutex_os_waits' }
+      = $fulltext =~ m/^Mutex spin waits $d, rounds $d, OS waits $d$/m;
+   @{$section}{ 'rw_shared_spins', 'rw_shared_os_waits', 'rw_excl_spins', 'rw_excl_os_waits' }
+      = $fulltext =~ m/^RW-shared spins $d, OS waits $d; RW-excl spins $d, OS waits $d$/m;
+
+   # Look for info on waits.
+   my @waits = $fulltext =~ m/^(--Thread.*?)^(?=Mutex spin|--Thread)/gms;
+   $section->{'waits'} = [ map { parse_wait_array($_, $complete, $debug) } @waits ];
+   $section->{'wait_array_size'} = scalar(@waits);
+
+   delete $section->{'fulltext'} unless $debug;
+   return 1;
+}
+
+# I've read the source for this section.
+sub parse_bp_section {
+   my ( $section, $complete, $debug, $full ) = @_;
+   return unless $section && $section->{'fulltext'};
+   my $fulltext = $section->{'fulltext'};
+
+   # Grab the info
+   @{$section}{ 'total_mem_alloc', 'add_pool_alloc' }
+      = $fulltext =~ m/^Total memory allocated $d; in additional pool allocated $d$/m;
+   @{$section}{'dict_mem_alloc'}     = $fulltext =~ m/Dictionary memory allocated $d/;
+   @{$section}{'awe_mem_alloc'}      = $fulltext =~ m/$d MB of AWE memory/;
+   @{$section}{'buf_pool_size'}      = $fulltext =~ m/^Buffer pool size\s*$d$/m;
+   @{$section}{'buf_free'}           = $fulltext =~ m/^Free buffers\s*$d$/m;
+   @{$section}{'pages_total'}        = $fulltext =~ m/^Database pages\s*$d$/m;
+   @{$section}{'pages_modified'}     = $fulltext =~ m/^Modified db pages\s*$d$/m;
+   @{$section}{'pages_read', 'pages_created', 'pages_written'}
+      = $fulltext =~ m/^Pages read $d, created $d, written $d$/m;
+   @{$section}{'page_reads_sec', 'page_creates_sec', 'page_writes_sec'}
+      = $fulltext =~ m{^$f reads/s, $f creates/s, $f writes/s$}m;
+   @{$section}{'buf_pool_hits', 'buf_pool_reads'}
+      = $fulltext =~ m{Buffer pool hit rate $d / $d$}m;
+   if ($fulltext =~ m/^No buffer pool page gets since the last printout$/m) {
+      @{$section}{'buf_pool_hits', 'buf_pool_reads'} = (0, 0);
+      @{$section}{'buf_pool_hit_rate'} = '--';
+   }
+   else {
+      @{$section}{'buf_pool_hit_rate'}
+         = $fulltext =~ m{Buffer pool hit rate (\d+ / \d+)$}m;
+   }
+   @{$section}{'reads_pending'} = $fulltext =~ m/^Pending reads $d/m;
+   @{$section}{'writes_pending_lru', 'writes_pending_flush_list', 'writes_pending_single_page' }
+      = $fulltext =~ m/^Pending writes: LRU $d, flush list $d, single page $d$/m;
+
+   map { $section->{$_} ||= 0 }
+      qw(writes_pending_lru writes_pending_flush_list writes_pending_single_page
+      awe_mem_alloc dict_mem_alloc);
+   @{$section}{'writes_pending'} = List::Util::sum(
+      @{$section}{ qw(writes_pending_lru writes_pending_flush_list writes_pending_single_page) });
+
+   delete $section->{'fulltext'} unless $debug;
+   return 1;
+}
+
+# I've read the source for this.
+sub parse_io_section {
+   my ( $section, $complete, $debug, $full ) = @_;
+   return unless $section && $section->{'fulltext'};
+   my $fulltext = $section->{'fulltext'};
+   $section->{'threads'} = {};
+
+   # Grab the I/O thread info
+   my @threads = $fulltext =~ m<^(I/O thread \d+ .*)$>gm;
+   foreach my $thread (@threads) {
+      my ( $tid, $state, $purpose, $event_set )
+         = $thread =~ m{I/O thread $d state: (.+?) \((.*)\)(?: ev set)?$}m;
+      if ( defined $tid ) {
+         $section->{'threads'}->{$tid} = {
+            thread    => $tid,
+            state     => $state,
+            purpose   => $purpose,
+            event_set => $event_set ? 1 : 0,
+         };
+      }
+   }
+
+   # Grab the reads/writes/flushes info
+   @{$section}{ 'pending_normal_aio_reads', 'pending_aio_writes' }
+      = $fulltext =~ m/^Pending normal aio reads: $d, aio writes: $d,$/m;
+   @{$section}{ 'pending_ibuf_aio_reads', 'pending_log_ios', 'pending_sync_ios' }
+      = $fulltext =~ m{^ ibuf aio reads: $d, log i/o's: $d, sync i/o's: $d$}m;
+   @{$section}{ 'flush_type', 'pending_log_flushes', 'pending_buffer_pool_flushes' }
+      = $fulltext =~ m/^Pending flushes \($w\) log: $d; buffer pool: $d$/m;
+   @{$section}{ 'os_file_reads', 'os_file_writes', 'os_fsyncs' }
+      = $fulltext =~ m/^$d OS file reads, $d OS file writes, $d OS fsyncs$/m;
+   @{$section}{ 'reads_s', 'avg_bytes_s', 'writes_s', 'fsyncs_s' }
+      = $fulltext =~ m{^$f reads/s, $d avg bytes/read, $f writes/s, $f fsyncs/s$}m;
+   @{$section}{ 'pending_preads', 'pending_pwrites' }
+      = $fulltext =~ m/$d pending preads, $d pending pwrites$/m;
+   @{$section}{ 'pending_preads', 'pending_pwrites' } = (0, 0)
+      unless defined($section->{'pending_preads'});
+
+   delete $section->{'fulltext'} unless $debug;
+   return 1;
+}
+
+sub _debug {
+   my ( $debug, $msg ) = @_;
+   if ( $debug ) {
+      die $msg;
+   }
+   else {
+      warn $msg;
+   }
+   return 1;
+}
+
+1;
+
+# end_of_package InnoDBParser
+
+package main;
+
+use sigtrap qw(handler finish untrapped normal-signals);
+
+use Data::Dumper;
+use DBI;
+use English qw(-no_match_vars);
+use File::Basename qw(dirname);
+use File::Temp;
+use Getopt::Long;
+use List::Util qw(max min maxstr sum);
+use POSIX qw(ceil);
+use Time::HiRes qw(time sleep);
+use Term::ReadKey qw(ReadMode ReadKey);
+
+# License and warranty information. {{{1
+# ###########################################################################
+
+my $innotop_license = <<"LICENSE";
+
+This is innotop version $VERSION, a MySQL and InnoDB monitor.
+
+This program is copyright (c) 2006 Baron Schwartz.
+Feedback and improvements are welcome.
+
+THIS PROGRAM IS PROVIDED "AS IS" AND WITHOUT ANY EXPRESS OR IMPLIED
+WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF
+MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.
+
+This program is free software; you can redistribute it and/or modify it under
+the terms of the GNU General Public License as published by the Free Software
+Foundation, version 2; OR the Perl Artistic License.  On UNIX and similar
+systems, you can issue `man perlgpl' or `man perlartistic' to read these
+licenses.
+
+You should have received a copy of the GNU General Public License along with
+this program; if not, write to the Free Software Foundation, Inc., 59 Temple
+Place, Suite 330, Boston, MA  02111-1307  USA.
+LICENSE
+
+# Configuration information and global setup {{{1
+# ###########################################################################
+
+# Really, really, super-global variables.
+my @config_versions = (
+   "000-000-000", "001-003-000", # config file was one big name-value hash.
+   "001-003-000", "001-004-002", # config file contained non-user-defined stuff.
+);
+
+my $clear_screen_sub;
+my $dsn_parser = new DSNParser();
+
+# This defines expected properties and defaults for the column definitions that
+# eventually end up in tbl_meta.
+my %col_props = (
+   hdr     => '',
+   just    => '-',
+   dec     => 0,     # Whether to align the column on the decimal point
+   num     => 0,
+   label   => '',
+   user    => 0,
+   src     => '',
+   tbl     => '',    # Helps when writing/reading custom columns in config files
+   minw    => 0,
+   maxw    => 0,
+   trans   => [],
+   agg     => 'first',  # Aggregate function
+   aggonly => 0,        # Whether to show only when tbl_meta->{aggregate} is true
+);
+
+# Actual DBI connections to MySQL servers.
+my %dbhs;
+
+# Command-line parameters {{{2
+# ###########################################################################
+
+my @opt_spec = (
+   { s => 'help',       d => 'Show this help message' },
+   { s => 'color|C!',   d => 'Use terminal coloring (default)',   c => 'color' },
+   { s => 'config|c=s', d => 'Config file to read' },
+   { s => 'nonint|n',   d => 'Non-interactive, output tab-separated fields' },
+   { s => 'count=i',    d => 'Number of updates before exiting' },
+   { s => 'delay|d=f',  d => 'Delay between updates in seconds',  c => 'interval' },
+   { s => 'mode|m=s',   d => 'Operating mode to start in',        c => 'mode' },
+   { s => 'inc|i!',     d => 'Measure incremental differences',   c => 'status_inc' },
+   { s => 'write|w',    d => 'Write running configuration into home directory if no config files were loaded' },
+   { s => 'skipcentral|s',     d => 'Skip reading the central configuration file' },
+   { s => 'version',    d => 'Output version information and exit' },
+   { s => 'user|u=s',   d => 'User for login if not current user' },
+   { s => 'password|p=s',   d => 'Password to use for connection' },
+   { s => 'host|h=s',   d => 'Connect to host' },
+   { s => 'port|P=i',   d => 'Port number to use for connection' },
+);
+
+# This is the container for the command-line options' values to be stored in
+# after processing.  Initial values are defaults.
+my %opts = (
+   n => !( -t STDIN && -t STDOUT ), # If in/out aren't to terminals, we're interactive
+);
+# Post-process...
+my %opt_seen;
+foreach my $spec ( @opt_spec ) {
+   my ( $long, $short ) = $spec->{s} =~ m/^(\w+)(?:\|([^!+=]*))?/;
+   $spec->{k} = $short || $long;
+   $spec->{l} = $long;
+   $spec->{t} = $short;
+   $spec->{n} = $spec->{s} =~ m/!/;
+   $opts{$spec->{k}} = undef unless defined $opts{$spec->{k}};
+   die "Duplicate option $spec->{k}" if $opt_seen{$spec->{k}}++;
+}
+
+Getopt::Long::Configure('no_ignore_case', 'bundling');
+GetOptions( map { $_->{s} => \$opts{$_->{k}} } @opt_spec) or $opts{help} = 1;
+
+if ( $opts{version} ) {
+   print "innotop  Ver $VERSION\n";
+   exit(0);
+}
+
+if ( $opts{c} and ! -f $opts{c} ) {
+   print $opts{c} . " doesn't exist.  Exiting.\n";
+   exit(1);
+}
+if ( $opts{'help'} ) {
+   print "Usage: innotop <options> <innodb-status-file>\n\n";
+   my $maxw = max(map { length($_->{l}) + ($_->{n} ? 4 : 0)} @opt_spec);
+   foreach my $spec ( sort { $a->{l} cmp $b->{l} } @opt_spec ) {
+      my $long  = $spec->{n} ? "[no]$spec->{l}" : $spec->{l};
+      my $short = $spec->{t} ? "-$spec->{t}" : '';
+      printf("  --%-${maxw}s %-4s %s\n", $long, $short, $spec->{d});
+   }
+   print <<USAGE;
+
+innotop is a MySQL and InnoDB transaction/status monitor, like 'top' for
+MySQL.  It displays queries, InnoDB transactions, lock waits, deadlocks,
+foreign key errors, open tables, replication status, buffer information,
+row operations, logs, I/O operations, load graph, and more.  You can
+monitor many servers at once with innotop. 
+
+USAGE
+   exit(1);
+}
+
+# Meta-data (table definitions etc) {{{2
+# ###########################################################################
+
+# Expressions {{{3
+# Convenience so I can copy/paste these in several places...
+# ###########################################################################
+my %exprs = (
+   Host              => q{my $host = host || hostname || ''; ($host) = $host =~ m/^((?:[\d.]+(?=:))|(?:[a-zA-Z]\w+))/; return $host || ''},
+   Port              => q{my ($p) = host =~ m/:(.*)$/; return $p || 0},
+   OldVersions       => q{dulint_to_int(IB_tx_trx_id_counter) - dulint_to_int(IB_tx_purge_done_for)},
+   MaxTxnTime        => q/max(map{ $_->{active_secs} } @{ IB_tx_transactions }) || 0/,
+   NumTxns           => q{scalar @{ IB_tx_transactions } },
+   DirtyBufs         => q{ $cur->{IB_bp_pages_modified} / ($cur->{IB_bp_buf_pool_size} || 1) },
+   BufPoolFill       => q{ $cur->{IB_bp_pages_total} / ($cur->{IB_bp_buf_pool_size} || 1) },
+   ServerLoad        => q{ $cur->{Threads_connected}/(Questions||1)/Uptime_hires },
+   TxnTimeRemain     => q{ defined undo_log_entries && defined $pre->{undo_log_entries} && undo_log_entries < $pre->{undo_log_entries} ? undo_log_entries / (($pre->{undo_log_entries} - undo_log_entries)/((active_secs-$pre->{active_secs})||1))||1 : 0},
+   SlaveCatchupRate  => ' defined $cur->{seconds_behind_master} && defined $pre->{seconds_behind_master} && $cur->{seconds_behind_master} < $pre->{seconds_behind_master} ? ($pre->{seconds_behind_master}-$cur->{seconds_behind_master})/($cur->{Uptime_hires}-$pre->{Uptime_hires}) : 0',
+   QcacheHitRatio    => q{(Qcache_hits||0)/(((Com_select||0)+(Qcache_hits||0))||1)},
+);
+
+# ###########################################################################
+# Column definitions {{{3
+# Defines every column in every table. A named column has the following
+# properties:
+#    * hdr    Column header/title
+#    * label  Documentation for humans.
+#    * num    Whether it's numeric (for sorting).
+#    * just   Alignment; generated from num, user-overridable in tbl_meta
+#    * minw, maxw Auto-generated, user-overridable.
+# Values from this hash are just copied to tbl_meta, which is where everything
+# else in the program should read from.
+# ###########################################################################
+
+my %columns = (
+   active_secs                 => { hdr => 'SecsActive',          num => 1, label => 'Seconds transaction has been active', },
+   add_pool_alloc              => { hdr => 'Add\'l Pool',         num => 1, label => 'Additonal pool allocated' },
+   attempted_op                => { hdr => 'Action',              num => 0, label => 'The action that caused the error' },
+   awe_mem_alloc               => { hdr => 'AWE Memory',          num => 1, label => '[Windows] AWE memory allocated' },
+   binlog_cache_overflow       => { hdr => 'Binlog Cache',        num => 1, label => 'Transactions too big for binlog cache that went to disk' },
+   binlog_do_db                => { hdr => 'Binlog Do DB',        num => 0, label => 'binlog-do-db setting' },
+   binlog_ignore_db            => { hdr => 'Binlog Ignore DB',    num => 0, label => 'binlog-ignore-db setting' },
+   bps_in                      => { hdr => 'BpsIn',               num => 1, label => 'Bytes per second received by the server', },
+   bps_out                     => { hdr => 'BpsOut',              num => 1, label => 'Bytes per second sent by the server', },
+   buf_free                    => { hdr => 'Free Bufs',           num => 1, label => 'Buffers free in the buffer pool' },
+   buf_pool_hit_rate           => { hdr => 'Hit Rate',            num => 0, label => 'Buffer pool hit rate' },
+   buf_pool_hits               => { hdr => 'Hits',                num => 1, label => 'Buffer pool hits' },
+   buf_pool_reads              => { hdr => 'Reads',               num => 1, label => 'Buffer pool reads' },
+   buf_pool_size               => { hdr => 'Size',                num => 1, label => 'Buffer pool size' },
+   bufs_in_node_heap           => { hdr => 'Node Heap Bufs',      num => 1, label => 'Buffers in buffer pool node heap' },
+   bytes_behind_master         => { hdr => 'ByteLag',             num => 1, label => 'Bytes the slave lags the master in binlog' },
+   cell_event_set              => { hdr => 'Ending?',             num => 1, label => 'Whether the cell event is set' },
+   cell_waiting                => { hdr => 'Waiting?',            num => 1, label => 'Whether the cell is waiting' },
+   child_db                    => { hdr => 'Child DB',            num => 0, label => 'The database of the child table' },
+   child_index                 => { hdr => 'Child Index',         num => 0, label => 'The index in the child table' },
+   child_table                 => { hdr => 'Child Table',         num => 0, label => 'The child table' },
+   cmd                         => { hdr => 'Cmd',                 num => 0, label => 'Type of command being executed', },
+   cnt                         => { hdr => 'Cnt',                 num => 0, label => 'Count', agg => 'count', aggonly => 1 },
+   connect_retry               => { hdr => 'Connect Retry',       num => 1, label => 'Slave connect-retry timeout' },
+   cxn                         => { hdr => 'CXN',                 num => 0, label => 'Connection from which the data came', },
+   db                          => { hdr => 'DB',                  num => 0, label => 'Current database', },
+   dict_mem_alloc              => { hdr => 'Dict Mem',            num => 1, label => 'Dictionary memory allocated' },
+   dirty_bufs                  => { hdr => 'Dirty Buf',           num => 1, label => 'Dirty buffer pool pages' },
+   dl_txn_num                  => { hdr => 'Num',                 num => 0, label => 'Deadlocked transaction number', },
+   event_set                   => { hdr => 'Evt Set?',            num => 1, label => '[Win32] if a wait event is set', },
+   exec_master_log_pos         => { hdr => 'Exec Master Log Pos', num => 1, label => 'Exec Master Log Position' },
+   fk_name                     => { hdr => 'Constraint',          num => 0, label => 'The name of the FK constraint' },
+   free_list_len               => { hdr => 'Free List Len',       num => 1, label => 'Length of the free list' },
+   has_read_view               => { hdr => 'Rd View',             num => 1, label => 'Whether the transaction has a read view' },
+   hash_searches_s             => { hdr => 'Hash/Sec',            num => 1, label => 'Number of hash searches/sec' },
+   hash_table_size             => { hdr => 'Size',                num => 1, label => 'Number of non-hash searches/sec' },
+   heap_no                     => { hdr => 'Heap',                num => 1, label => 'Heap number' },
+   heap_size                   => { hdr => 'Heap',                num => 1, label => 'Heap size' },
+   history_list_len            => { hdr => 'History',             num => 1, label => 'History list length' },
+   host_and_domain             => { hdr => 'Host',                num => 0, label => 'Hostname/IP and domain' },
+   host_and_port               => { hdr => 'Host/IP',             num => 0, label => 'Hostname or IP address, and port number', },
+   hostname                    => { hdr => 'Host',                num => 0, label => 'Hostname' },
+   index                       => { hdr => 'Index',               num => 0, label => 'The index involved' },
+   index_ref                   => { hdr => 'Index Ref',           num => 0, label => 'Index referenced' },
+   info                        => { hdr => 'Query',               num => 0, label => 'Info or the current query', },
+   insert_intention            => { hdr => 'Ins Intent',          num => 1, label => 'Whether the thread was trying to insert' },
+   inserts                     => { hdr => 'Inserts',             num => 1, label => 'Inserts' },
+   io_bytes_s                  => { hdr => 'Bytes/Sec',           num => 1, label => 'Average I/O bytes/sec' },
+   io_flush_type               => { hdr => 'Flush Type',          num => 0, label => 'I/O Flush Type' },
+   io_fsyncs_s                 => { hdr => 'fsyncs/sec',          num => 1, label => 'I/O fsyncs/sec' },
+   io_reads_s                  => { hdr => 'Reads/Sec',           num => 1, label => 'Average I/O reads/sec' },
+   io_writes_s                 => { hdr => 'Writes/Sec',          num => 1, label => 'Average I/O writes/sec' },
+   ip                          => { hdr => 'IP',                  num => 0, label => 'IP address' },
+   is_name_locked              => { hdr => 'Locked',              num => 1, label => 'Whether table is name locked', },
+   key_buffer_hit              => { hdr => 'KCacheHit',           num => 1, label => 'Key cache hit ratio', },
+   key_len                     => { hdr => 'Key Length',          num => 1, label => 'Number of bytes used in the key' },
+   last_chkp                   => { hdr => 'Last Checkpoint',     num => 0, label => 'Last log checkpoint' },
+   last_errno                  => { hdr => 'Last Errno',          num => 1, label => 'Last error number' },
+   last_error                  => { hdr => 'Last Error',          num => 0, label => 'Last error' },
+   last_s_file_name            => { hdr => 'S-File',              num => 0, label => 'Filename where last read locked' },
+   last_s_line                 => { hdr => 'S-Line',              num => 1, label => 'Line where last read locked' },
+   last_x_file_name            => { hdr => 'X-File',              num => 0, label => 'Filename where last write locked' },
+   last_x_line                 => { hdr => 'X-Line',              num => 1, label => 'Line where last write locked' },
+   last_pct                    => { hdr => 'Pct',                 num => 1, label => 'Last Percentage' },
+   last_total                  => { hdr => 'Last Total',          num => 1, label => 'Last Total' },
+   last_value                  => { hdr => 'Last Incr',           num => 1, label => 'Last Value' },
+   load                        => { hdr => 'Load',                num => 1, label => 'Server load' },
+   lock_cfile_name             => { hdr => 'Crtd File',           num => 0, label => 'Filename where lock created' },
+   lock_cline                  => { hdr => 'Crtd Line',           num => 1, label => 'Line where lock created' },
+   lock_mem_addr               => { hdr => 'Addr',                num => 0, label => 'The lock memory address' },
+   lock_mode                   => { hdr => 'Mode',                num => 0, label => 'The lock mode' },
+   lock_structs                => { hdr => 'LStrcts',             num => 1, label => 'Number of lock structs' },
+   lock_type                   => { hdr => 'Type',                num => 0, label => 'The lock type' },
+   lock_var                    => { hdr => 'Lck Var',             num => 1, label => 'The lock variable' },
+   lock_wait_time              => { hdr => 'Wait',                num => 1, label => 'How long txn has waited for a lock' },
+   log_flushed_to              => { hdr => 'Flushed To',          num => 0, label => 'Log position flushed to' },
+   log_ios_done                => { hdr => 'IO Done',             num => 1, label => 'Log I/Os done' },
+   log_ios_s                   => { hdr => 'IO/Sec',              num => 1, label => 'Average log I/Os per sec' },
+   log_seq_no                  => { hdr => 'Sequence No.',        num => 0, label => 'Log sequence number' },
+   main_thread_id              => { hdr => 'Main Thread ID',      num => 1, label => 'Main thread ID' },
+   main_thread_proc_no         => { hdr => 'Main Thread Proc',    num => 1, label => 'Main thread process number' },
+   main_thread_state           => { hdr => 'Main Thread State',   num => 0, label => 'Main thread state' },
+   master_file                 => { hdr => 'File',                num => 0, label => 'Master file' },
+   master_host                 => { hdr => 'Master',              num => 0, label => 'Master server hostname' },
+   master_log_file             => { hdr => 'Master Log File',     num => 0, label => 'Master log file' },
+   master_port                 => { hdr => 'Master Port',         num => 1, label => 'Master port' },
+   master_pos                  => { hdr => 'Position',            num => 1, label => 'Master position' },
+   master_ssl_allowed          => { hdr => 'Master SSL Allowed',  num => 0, label => 'Master SSL Allowed' },
+   master_ssl_ca_file          => { hdr => 'Master SSL CA File',  num => 0, label => 'Master SSL Cert Auth File' },
+   master_ssl_ca_path          => { hdr => 'Master SSL CA Path',  num => 0, label => 'Master SSL Cert Auth Path' },
+   master_ssl_cert             => { hdr => 'Master SSL Cert',     num => 0, label => 'Master SSL Cert' },
+   master_ssl_cipher           => { hdr => 'Master SSL Cipher',   num => 0, label => 'Master SSL Cipher' },
+   master_ssl_key              => { hdr => 'Master SSL Key',      num => 0, label => 'Master SSL Key' },
+   master_user                 => { hdr => 'Master User',         num => 0, label => 'Master username' },
+   max_txn                     => { hdr => 'MaxTxnTime',          num => 1, label => 'MaxTxn' },
+   merged_recs                 => { hdr => 'Merged Recs',         num => 1, label => 'Merged records' },
+   merges                      => { hdr => 'Merges',              num => 1, label => 'Merges' },
+   mutex_os_waits              => { hdr => 'Waits',               num => 1, label => 'Mutex OS Waits' },
+   mutex_spin_rounds           => { hdr => 'Rounds',              num => 1, label => 'Mutex Spin Rounds' },
+   mutex_spin_waits            => { hdr => 'Spins',               num => 1, label => 'Mutex Spin Waits' },
+   mysql_thread_id             => { hdr => 'ID',                  num => 1, label => 'MySQL connection (thread) ID', },
+   name                        => { hdr => 'Name',                num => 0, label => 'Variable Name' },
+   n_bits                      => { hdr => '# Bits',              num => 1, label => 'Number of bits' },
+   non_hash_searches_s         => { hdr => 'Non-Hash/Sec',        num => 1, label => 'Non-hash searches/sec' },
+   num_deletes                 => { hdr => 'Del',                 num => 1, label => 'Number of deletes' },
+   num_deletes_sec             => { hdr => 'Del/Sec',             num => 1, label => 'Number of deletes' },
+   num_inserts                 => { hdr => 'Ins',                 num => 1, label => 'Number of inserts' },
+   num_inserts_sec             => { hdr => 'Ins/Sec',             num => 1, label => 'Number of inserts' },
+   num_readers                 => { hdr => 'Readers',             num => 1, label => 'Number of readers' },
+   num_reads                   => { hdr => 'Read',                num => 1, label => 'Number of reads' },
+   num_reads_sec               => { hdr => 'Read/Sec',            num => 1, label => 'Number of reads' },
+   num_res_ext                 => { hdr => 'BTree Extents',       num => 1, label => 'Number of extents reserved for B-Tree' },
+   num_rows                    => { hdr => 'Row Count',           num => 1, label => 'Number of rows estimated to examine' },
+   num_times_open              => { hdr => 'In Use',              num => 1, label => '# times table is opened', },
+   num_txns                    => { hdr => 'Txns',                num => 1, label => 'Number of transactions' },
+   num_updates                 => { hdr => 'Upd',                 num => 1, label => 'Number of updates' },
+   num_updates_sec             => { hdr => 'Upd/Sec',             num => 1, label => 'Number of updates' },
+   os_file_reads               => { hdr => 'OS Reads',            num => 1, label => 'OS file reads' },
+   os_file_writes              => { hdr => 'OS Writes',           num => 1, label => 'OS file writes' },
+   os_fsyncs                   => { hdr => 'OS fsyncs',           num => 1, label => 'OS fsyncs' },
+   os_thread_id                => { hdr => 'OS Thread',           num => 1, label => 'The operating system thread ID' },
+   p_aio_writes                => { hdr => 'Async Wrt',           num => 1, label => 'Pending asynchronous I/O writes' },
+   p_buf_pool_flushes          => { hdr => 'Buffer Pool Flushes', num => 1, label => 'Pending buffer pool flushes' },
+   p_ibuf_aio_reads            => { hdr => 'IBuf Async Rds',      num => 1, label => 'Pending insert buffer asynch I/O reads' },
+   p_log_flushes               => { hdr => 'Log Flushes',         num => 1, label => 'Pending log flushes' },
+   p_log_ios                   => { hdr => 'Log I/Os',            num => 1, label => 'Pending log I/O operations' },
+   p_normal_aio_reads          => { hdr => 'Async Rds',           num => 1, label => 'Pending asynchronous I/O reads' },
+   p_preads                    => { hdr => 'preads',              num => 1, label => 'Pending p-reads' },
+   p_pwrites                   => { hdr => 'pwrites',             num => 1, label => 'Pending p-writes' },
+   p_sync_ios                  => { hdr => 'Sync I/Os',           num => 1, label => 'Pending synchronous I/O operations' },
+   page_creates_sec            => { hdr => 'Creates/Sec',         num => 1, label => 'Page creates/sec' },
+   page_no                     => { hdr => 'Page',                num => 1, label => 'Page number' },
+   page_reads_sec              => { hdr => 'Reads/Sec',           num => 1, label => 'Page reads per second' },
+   page_writes_sec             => { hdr => 'Writes/Sec',          num => 1, label => 'Page writes per second' },
+   pages_created               => { hdr => 'Created',             num => 1, label => 'Pages created' },
+   pages_modified              => { hdr => 'Dirty Pages',         num => 1, label => 'Pages modified (dirty)' },
+   pages_read                  => { hdr => 'Reads',               num => 1, label => 'Pages read' },
+   pages_total                 => { hdr => 'Pages',               num => 1, label => 'Pages total' },
+   pages_written               => { hdr => 'Writes',              num => 1, label => 'Pages written' },
+   parent_col                  => { hdr => 'Parent Column',       num => 0, label => 'The referred column in the parent table', },
+   parent_db                   => { hdr => 'Parent DB',           num => 0, label => 'The database of the parent table' },
+   parent_index                => { hdr => 'Parent Index',        num => 0, label => 'The referred index in the parent table' },
+   parent_table                => { hdr => 'Parent Table',        num => 0, label => 'The parent table' },
+   part_id                     => { hdr => 'Part ID',             num => 1, label => 'Sub-part ID of the query' },
+   partitions                  => { hdr => 'Partitions',          num => 0, label => 'Query partitions used' },
+   pct                         => { hdr => 'Pct',                 num => 1, label => 'Percentage' },
+   pending_chkp_writes         => { hdr => 'Chkpt Writes',        num => 1, label => 'Pending log checkpoint writes' },
+   pending_log_writes          => { hdr => 'Log Writes',          num => 1, label => 'Pending log writes' },
+   port                        => { hdr => 'Port',                num => 1, label => 'Client port number', },
+   possible_keys               => { hdr => 'Poss. Keys',          num => 0, label => 'Possible keys' },
+   proc_no                     => { hdr => 'Proc',                num => 1, label => 'Process number' },
+   q_cache_hit                 => { hdr => 'QCacheHit',           num => 1, label => 'Query cache hit ratio', },
+   qps                         => { hdr => 'QPS',                 num => 1, label => 'How many queries/sec', },
+   queries_in_queue            => { hdr => 'Queries Queued',      num => 1, label => 'Queries in queue' },
+   queries_inside              => { hdr => 'Queries Inside',      num => 1, label => 'Queries inside InnoDB' },
+   query_id                    => { hdr => 'Query ID',            num => 1, label => 'Query ID' },
+   query_status                => { hdr => 'Query Status',        num => 0, label => 'The query status' },
+   query_text                  => { hdr => 'Query Text',          num => 0, label => 'The query text' },
+   questions                   => { hdr => 'Questions',           num => 1, label => 'How many queries the server has gotten', },
+   read_master_log_pos         => { hdr => 'Read Master Pos',     num => 1, label => 'Read master log position' },
+   read_views_open             => { hdr => 'Rd Views',            num => 1, label => 'Number of read views open' },
+   reads_pending               => { hdr => 'Pending Reads',       num => 1, label => 'Reads pending' },
+   relay_log_file              => { hdr => 'Relay File',          num => 0, label => 'Relay log file' },
+   relay_log_pos               => { hdr => 'Relay Pos',           num => 1, label => 'Relay log position' },
+   relay_log_size              => { hdr => 'Relay Size',          num => 1, label => 'Relay log size' },
+   relay_master_log_file       => { hdr => 'Relay Master File',   num => 0, label => 'Relay master log file' },
+   replicate_do_db             => { hdr => 'Do DB',               num => 0, label => 'Replicate-do-db setting' },
+   replicate_do_table          => { hdr => 'Do Table',            num => 0, label => 'Replicate-do-table setting' },
+   replicate_ignore_db         => { hdr => 'Ignore DB',           num => 0, label => 'Replicate-ignore-db setting' },
+   replicate_ignore_table      => { hdr => 'Ignore Table',        num => 0, label => 'Replicate-do-table setting' },
+   replicate_wild_do_table     => { hdr => 'Wild Do Table',       num => 0, label => 'Replicate-wild-do-table setting' },
+   replicate_wild_ignore_table => { hdr => 'Wild Ignore Table',   num => 0, label => 'Replicate-wild-ignore-table setting' },
+   request_type                => { hdr => 'Type',                num => 0, label => 'Type of lock the thread waits for' },
+   reservation_count           => { hdr => 'ResCnt',              num => 1, label => 'Reservation Count' },
+   row_locks                   => { hdr => 'RLocks',              num => 1, label => 'Number of row locks' },
+   rw_excl_os_waits            => { hdr => 'RW Waits',            num => 1, label => 'R/W Excl. OS Waits' },
+   rw_excl_spins               => { hdr => 'RW Spins',            num => 1, label => 'R/W Excl. Spins' },
+   rw_shared_os_waits          => { hdr => 'Sh Waits',            num => 1, label => 'R/W Shared OS Waits' },
+   rw_shared_spins             => { hdr => 'Sh Spins',            num => 1, label => 'R/W Shared Spins' },
+   scan_type                   => { hdr => 'Type',                num => 0, label => 'Scan type in chosen' },
+   seg_size                    => { hdr => 'Seg. Size',           num => 1, label => 'Segment size' },
+   select_type                 => { hdr => 'Select Type',         num => 0, label => 'Type of select used' },
+   signal_count                => { hdr => 'Signals',             num => 1, label => 'Signal Count' },
+   size                        => { hdr => 'Size',                num => 1, label => 'Size of the tablespace' },
+   skip_counter                => { hdr => 'Skip Counter',        num => 1, label => 'Skip counter' },
+   slave_catchup_rate          => { hdr => 'Catchup',             num => 1, label => 'How fast the slave is catching up in the binlog' },
+   slave_io_running            => { hdr => 'Slave-IO',            num => 0, label => 'Whether the slave I/O thread is running' },
+   slave_io_state              => { hdr => 'Slave IO State',      num => 0, label => 'Slave I/O thread state' },
+   slave_open_temp_tables      => { hdr => 'Temp',                num => 1, label => 'Slave open temp tables' },
+   slave_sql_running           => { hdr => 'Slave-SQL',           num => 0, label => 'Whether the slave SQL thread is running' },
+   slow                        => { hdr => 'Slow',                num => 1, label => 'How many slow queries', },
+   space_id                    => { hdr => 'Space',               num => 1, label => 'Tablespace ID' },
+   special                     => { hdr => 'Special',             num => 0, label => 'Special/Other info' },
+   state                       => { hdr => 'State',               num => 0, label => 'Connection state', maxw => 18, },
+   tables_in_use               => { hdr => 'Tbl Used',            num => 1, label => 'Number of tables in use' },
+   tables_locked               => { hdr => 'Tbl Lck',             num => 1, label => 'Number of tables locked' },
+   tbl                         => { hdr => 'Table',               num => 0, label => 'Table', },
+   thread                      => { hdr => 'Thread',              num => 1, label => 'Thread number' },
+   thread_decl_inside          => { hdr => 'Thread Inside',       num => 0, label => 'What the thread is declared inside' },
+   thread_purpose              => { hdr => 'Purpose',             num => 0, label => "The thread's purpose" },
+   thread_status               => { hdr => 'Thread Status',       num => 0, label => 'The thread status' },
+   time                        => { hdr => 'Time',                num => 1, label => 'Time since the last event', },
+   time_behind_master          => { hdr => 'TimeLag',             num => 1, label => 'Time slave lags master' },
+   timestring                  => { hdr => 'Timestring',          num => 0, label => 'Time the event occurred' },
+   total                       => { hdr => 'Total',               num => 1, label => 'Total' },
+   total_mem_alloc             => { hdr => 'Memory',              num => 1, label => 'Total memory allocated' },
+   truncates                   => { hdr => 'Trunc',               num => 0, label => 'Whether the deadlock is truncating InnoDB status' },
+   txn_doesnt_see_ge           => { hdr => "Txn Won't See",       num => 0, label => 'Where txn read view is limited' },
+   txn_id                      => { hdr => 'ID',                  num => 0, label => 'Transaction ID' },
+   txn_sees_lt                 => { hdr => 'Txn Sees',            num => 1, label => 'Where txn read view is limited' },
+   txn_status                  => { hdr => 'Txn Status',          num => 0, label => 'Transaction status' },
+   txn_time_remain             => { hdr => 'Remaining',           num => 1, label => 'Time until txn rollback/commit completes' },
+   undo_log_entries            => { hdr => 'Undo',                num => 1, label => 'Number of undo log entries' },
+   undo_for                    => { hdr => 'Undo',                num => 0, label => 'Undo for' },
+   until_condition             => { hdr => 'Until Condition',     num => 0, label => 'Slave until condition' },
+   until_log_file              => { hdr => 'Until Log File',      num => 0, label => 'Slave until log file' },
+   until_log_pos               => { hdr => 'Until Log Pos',       num => 1, label => 'Slave until log position' },
+   used_cells                  => { hdr => 'Cells Used',          num => 1, label => 'Number of cells used' },
+   used_bufs                   => { hdr => 'Used Bufs',           num => 1, label => 'Number of buffer pool pages used' },
+   user                        => { hdr => 'User',                num => 0, label => 'Database username', },
+   value                       => { hdr => 'Value',               num => 1, label => 'Value' },
+   versions                    => { hdr => 'Versions',            num => 1, label => 'Number of InnoDB MVCC versions unpurged' },
+   victim                      => { hdr => 'Victim',              num => 0, label => 'Whether this txn was the deadlock victim' },
+   wait_array_size             => { hdr => 'Wait Array Size',     num => 1, label => 'Wait Array Size' },
+   wait_status                 => { hdr => 'Lock Status',         num => 0, label => 'Status of txn locks' },
+   waited_at_filename          => { hdr => 'File',                num => 0, label => 'Filename at which thread waits' },
+   waited_at_line              => { hdr => 'Line',                num => 1, label => 'Line at which thread waits' },
+   waiters_flag                => { hdr => 'Waiters',             num => 1, label => 'Waiters Flag' },
+   waiting                     => { hdr => 'Waiting',             num => 1, label => 'Whether lock is being waited for' },
+   when                        => { hdr => 'When',                num => 0, label => 'Time scale' },
+   writer_lock_mode            => { hdr => 'Wrtr Lck Mode',       num => 0, label => 'Writer lock mode' },
+   writer_thread               => { hdr => 'Wrtr Thread',         num => 1, label => 'Writer thread ID' },
+   writes_pending              => { hdr => 'Writes',              num => 1, label => 'Number of writes pending' },
+   writes_pending_flush_list   => { hdr => 'Flush List Writes',   num => 1, label => 'Number of flush list writes pending' },
+   writes_pending_lru          => { hdr => 'LRU Writes',          num => 1, label => 'Number of LRU writes pending' },
+   writes_pending_single_page  => { hdr => '1-Page Writes',       num => 1, label => 'Number of 1-page writes pending' },
+);
+
+# Apply a default property or three.  By default, columns are not width-constrained,
+# aligned left, and sorted alphabetically, not numerically.
+foreach my $col ( values %columns ) {
+   map { $col->{$_} ||= 0 } qw(num minw maxw);
+   $col->{just} = $col->{num} ? '' : '-';
+}
+
+# Filters {{{3
+# This hash defines every filter that can be applied to a table.  These
+# become part of tbl_meta as well.  Each filter is just an expression that
+# returns true or false.
+# Properties of each entry:
+#  * func:   the subroutine
+#  * name:   the name, repeated
+#  * user:   whether it's a user-defined filter (saved in config)
+#  * text:   text of the subroutine
+#  * note:   explanation
+my %filters = ();
+
+# These are pre-processed to live in %filters above, by compiling them.
+my %builtin_filters = (
+   hide_self => {
+      text => <<'      END',
+         return ( !$set->{info} || $set->{info} ne 'SHOW FULL PROCESSLIST' )
+             && ( !$set->{query_text}    || $set->{query_text} !~ m/INNODB STATUS$/ );
+      END
+      note => 'Removes the innotop processes from the list',
+      tbls => [qw(innodb_transactions processlist)],
+   },
+   hide_inactive => {
+      text => <<'      END',
+         return ( !defined($set->{txn_status}) || $set->{txn_status} ne 'not started' )
+             && ( !defined($set->{cmd})        || $set->{cmd} !~ m/Sleep|Binlog Dump/ )
+             && ( !defined($set->{info})       || $set->{info} =~ m/\S/               );
+      END
+      note => 'Removes processes which are not doing anything',
+      tbls => [qw(innodb_transactions processlist)],
+   },
+   hide_slave_io => {
+      text => <<'      END',
+         return !$set->{state} || $set->{state} !~ m/^(?:Waiting for master|Has read all relay)/;
+      END
+      note => 'Removes slave I/O threads from the list',
+      tbls => [qw(processlist slave_io_status)],
+   },
+   table_is_open => {
+      text => <<'      END',
+         return $set->{num_times_open} + $set->{is_name_locked};
+      END
+      note => 'Removes tables that are not in use or locked',
+      tbls => [qw(open_tables)],
+   },
+   cxn_is_master => {
+      text => <<'      END',
+         return $set->{master_file} ? 1 : 0;
+      END
+      note => 'Removes servers that are not masters',
+      tbls => [qw(master_status)],
+   },
+   cxn_is_slave => {
+      text => <<'      END',
+         return $set->{master_host} ? 1 : 0;
+      END
+      note => 'Removes servers that are not slaves',
+      tbls => [qw(slave_io_status slave_sql_status)],
+   },
+   thd_is_not_waiting => {
+      text => <<'      END',
+         return $set->{thread_status} !~ m#waiting for i/o request#;
+      END
+      note => 'Removes idle I/O threads',
+      tbls => [qw(io_threads)],
+   },
+);
+foreach my $key ( keys %builtin_filters ) {
+   my ( $sub, $err ) = compile_filter($builtin_filters{$key}->{text});
+   $filters{$key} = {
+      func => $sub,
+      text => $builtin_filters{$key}->{text},
+      user => 0,
+      name => $key, # useful for later
+      note => $builtin_filters{$key}->{note},
+      tbls => $builtin_filters{$key}->{tbls},
+   }
+}
+
+# Variable sets {{{3
+# Sets (arrayrefs) of variables that are used in S mode.  They are read/written to
+# the config file.
+my %var_sets = (
+   general => {
+      text => join(
+         ', ',
+         'set_precision(Questions/Uptime_hires) as QPS',
+         'set_precision(Com_commit/Uptime_hires) as Commit_PS',
+         'set_precision((Com_rollback||0)/(Com_commit||1)) as Rollback_Commit',
+         'set_precision(('
+            . join('+', map { "($_||0)" }
+               qw(Com_delete Com_delete_multi Com_insert Com_insert_select Com_replace
+                  Com_replace_select Com_select Com_update Com_update_multi))
+            . ')/(Com_commit||1)) as Write_Commit',
+         'set_precision((Com_select+(Qcache_hits||0))/(('
+            . join('+', map { "($_||0)" }
+               qw(Com_delete Com_delete_multi Com_insert Com_insert_select Com_replace
+                  Com_replace_select Com_select Com_update Com_update_multi))
+            . ')||1)) as R_W_Ratio',
+         'set_precision(Opened_tables/Uptime_hires) as Opens_PS',
+         'percent($cur->{Open_tables}/($cur->{table_cache})) as Table_Cache_Used',
+         'set_precision(Threads_created/Uptime_hires) as Threads_PS',
+         'percent($cur->{Threads_cached}/($cur->{thread_cache_size}||1)) as Thread_Cache_Used',
+         'percent($cur->{Max_used_connections}/($cur->{max_connections}||1)) as CXN_Used_Ever',
+         'percent($cur->{Threads_connected}/($cur->{max_connections}||1)) as CXN_Used_Now',
+      ),
+   },
+   commands => {
+      text => join(
+         ', ',
+         qw(Uptime Questions Com_delete Com_delete_multi Com_insert
+         Com_insert_select Com_replace Com_replace_select Com_select Com_update
+         Com_update_multi)
+      ),
+   },
+   query_status => {
+      text => join(
+         ',',
+         qw( Uptime Select_full_join Select_full_range_join Select_range
+         Select_range_check Select_scan Slow_queries Sort_merge_passes
+         Sort_range Sort_rows Sort_scan)
+      ),
+   },
+   innodb => {
+      text => join(
+         ',',
+         qw( Uptime Innodb_row_lock_current_waits Innodb_row_lock_time
+         Innodb_row_lock_time_avg Innodb_row_lock_time_max Innodb_row_lock_waits
+         Innodb_rows_deleted Innodb_rows_inserted Innodb_rows_read
+         Innodb_rows_updated)
+      ),
+   },
+   txn => {
+      text => join(
+         ',',
+         qw( Uptime Com_begin Com_commit Com_rollback Com_savepoint
+         Com_xa_commit Com_xa_end Com_xa_prepare Com_xa_recover Com_xa_rollback
+         Com_xa_start)
+      ),
+   },
+   key_cache => {
+      text => join(
+         ',',
+         qw( Uptime Key_blocks_not_flushed Key_blocks_unused Key_blocks_used
+         Key_read_requests Key_reads Key_write_requests Key_writes )
+      ),
+   },
+   query_cache => {
+      text => join(
+         ',',
+         "percent($exprs{QcacheHitRatio}) as Hit_Pct",
+         'set_precision((Qcache_hits||0)/(Qcache_inserts||1)) as Hit_Ins',
+         'set_precision((Qcache_lowmem_prunes||0)/Uptime_hires) as Lowmem_Prunes_sec',
+         'percent(1-((Qcache_free_blocks||0)/(Qcache_total_blocks||1))) as Blocks_used',
+         qw( Qcache_free_blocks Qcache_free_memory Qcache_not_cached Qcache_queries_in_cache)
+      ),
+   },
+   handler => {
+      text => join(
+         ',',
+         qw( Uptime Handler_read_key Handler_read_first Handler_read_next
+         Handler_read_prev Handler_read_rnd Handler_read_rnd_next Handler_delete
+         Handler_update Handler_write)
+      ),
+   },
+   cxns_files_threads => {
+      text => join(
+         ',',
+         qw( Uptime Aborted_clients Aborted_connects Bytes_received Bytes_sent
+         Compression Connections Created_tmp_disk_tables Created_tmp_files
+         Created_tmp_tables Max_used_connections Open_files Open_streams
+         Open_tables Opened_tables Table_locks_immediate Table_locks_waited
+         Threads_cached Threads_connected Threads_created Threads_running)
+      ),
+   },
+   prep_stmt => {
+      text => join(
+         ',',
+         qw( Uptime Com_dealloc_sql Com_execute_sql Com_prepare_sql Com_reset
+         Com_stmt_close Com_stmt_execute Com_stmt_fetch Com_stmt_prepare
+         Com_stmt_reset Com_stmt_send_long_data )
+      ),
+   },
+   innodb_health => {
+      text => join(
+         ',',
+         "$exprs{OldVersions} as OldVersions",
+         qw(IB_sm_mutex_spin_waits IB_sm_mutex_spin_rounds IB_sm_mutex_os_waits),
+         "$exprs{NumTxns} as NumTxns",
+         "$exprs{MaxTxnTime} as MaxTxnTime",
+         qw(IB_ro_queries_inside IB_ro_queries_in_queue),
+         "set_precision($exprs{DirtyBufs} * 100) as dirty_bufs",
+         "set_precision($exprs{BufPoolFill} * 100) as buf_fill",
+         qw(IB_bp_pages_total IB_bp_pages_read IB_bp_pages_written IB_bp_pages_created)
+      ),
+   },
+   innodb_health2 => {
+      text => join(
+         ', ',
+         'percent(1-((Innodb_buffer_pool_pages_free||0)/($cur->{Innodb_buffer_pool_pages_total}||1))) as BP_page_cache_usage',
+         'percent(1-((Innodb_buffer_pool_reads||0)/(Innodb_buffer_pool_read_requests||1))) as BP_cache_hit_ratio',
+         'Innodb_buffer_pool_wait_free',
+         'Innodb_log_waits',
+      ),
+   },
+   slow_queries => {
+      text => join(
+         ', ',
+         'set_precision(Slow_queries/Uptime_hires) as Slow_PS',
+         'set_precision(Select_full_join/Uptime_hires) as Full_Join_PS',
+         'percent(Select_full_join/(Com_select||1)) as Full_Join_Ratio',
+      ),
+   },
+);
+
+# Server sets {{{3
+# Defines sets of servers between which the user can quickly switch.
+my %server_groups;
+
+# Connections {{{3
+# This hash defines server connections.  Each connection is a string that can be passed to
+# the DBI connection.  These are saved in the connections section in the config file.
+my %connections;
+# Defines the parts of connections.
+my @conn_parts = qw(user have_user pass have_pass dsn savepass dl_table);
+
+# Graph widths {{{3
+# This hash defines the max values seen for various status/variable values, for graphing.
+# These are stored in their own section in the config file.  These are just initial values:
+my %mvs = (
+   Com_select   => 50,
+   Com_insert   => 50,
+   Com_update   => 50,
+   Com_delete   => 50,
+   Questions    => 100,
+);
+
+# ###########################################################################
+# Valid Term::ANSIColor color strings.
+# ###########################################################################
+my %ansicolors = map { $_ => 1 }
+   qw( black blink blue bold clear concealed cyan dark green magenta on_black
+       on_blue on_cyan on_green on_magenta on_red on_white on_yellow red reset
+       reverse underline underscore white yellow);
+
+# ###########################################################################
+# Valid comparison operators for color rules
+# ###########################################################################
+my %comp_ops = (
+   '==' => 'Numeric equality',
+   '>'  => 'Numeric greater-than',
+   '<'  => 'Numeric less-than',
+   '>=' => 'Numeric greater-than/equal',
+   '<=' => 'Numeric less-than/equal',
+   '!=' => 'Numeric not-equal',
+   'eq' => 'String equality',
+   'gt' => 'String greater-than',
+   'lt' => 'String less-than',
+   'ge' => 'String greater-than/equal',
+   'le' => 'String less-than/equal',
+   'ne' => 'String not-equal',
+   '=~' => 'Pattern match',
+   '!~' => 'Negated pattern match',
+);
+
+# ###########################################################################
+# Valid aggregate functions.
+# ###########################################################################
+my %agg_funcs = (
+   first => sub {
+      return $_[0]
+   },
+   count => sub {
+      return 0 + @_;
+   },
+   avg   => sub {
+      my @args = grep { defined $_ } @_;
+      return (sum(map { m/([\d\.-]+)/g } @args) || 0) / (scalar(@args) || 1);
+   },
+   sum   => sub {
+      my @args = grep { defined $_ } @_;
+      return sum(@args);
+   }
+);
+
+# ###########################################################################
+# Valid functions for transformations.
+# ###########################################################################
+my %trans_funcs = (
+   shorten      => \&shorten,
+   secs_to_time => \&secs_to_time,
+   no_ctrl_char => \&no_ctrl_char,
+   percent      => \&percent,
+   commify      => \&commify,
+   dulint_to_int => \&dulint_to_int,
+   set_precision => \&set_precision,
+);
+
+# Table definitions {{{3
+# This hash defines every table that can get displayed in every mode.  Each
+# table specifies columns and column data sources.  The column is
+# defined by the %columns hash.
+#
+# Example: foo => { src => 'bar' } means the foo column (look at
+# $columns{foo} for its definition) gets its data from the 'bar' element of
+# the current data set, whatever that is.
+#
+# These columns are post-processed after being defined, because they get stuff
+# from %columns.  After all the config is loaded for columns, there's more
+# post-processing too; the subroutines compiled from src get added to
+# the hash elements for extract_values to use.
+# ###########################################################################
+
+my %tbl_meta = (
+   adaptive_hash_index => {
+      capt => 'Adaptive Hash Index',
+      cust => {},
+      cols => {
+         cxn                 => { src => 'cxn' },
+         hash_table_size     => { src => 'IB_ib_hash_table_size', trans => [qw(shorten)], },
+         used_cells          => { src => 'IB_ib_used_cells' },
+         bufs_in_node_heap   => { src => 'IB_ib_bufs_in_node_heap' },
+         hash_searches_s     => { src => 'IB_ib_hash_searches_s' },
+         non_hash_searches_s => { src => 'IB_ib_non_hash_searches_s' },
+      },
+      visible => [ qw(cxn hash_table_size used_cells bufs_in_node_heap hash_searches_s non_hash_searches_s) ],
+      filters => [],
+      sort_cols => 'cxn',
+      sort_dir => '1',
+      innodb   => 'ib',
+      group_by => [],
+      aggregate => 0,
+   },
+   buffer_pool => {
+      capt => 'Buffer Pool',
+      cust => {},
+      cols => {
+         cxn                        => { src => 'cxn' },
+         total_mem_alloc            => { src => 'IB_bp_total_mem_alloc', trans => [qw(shorten)], },
+         awe_mem_alloc              => { src => 'IB_bp_awe_mem_alloc', trans => [qw(shorten)], },
+         add_pool_alloc             => { src => 'IB_bp_add_pool_alloc', trans => [qw(shorten)], },
+         buf_pool_size              => { src => 'IB_bp_buf_pool_size', trans => [qw(shorten)], },
+         buf_free                   => { src => 'IB_bp_buf_free' },
+         buf_pool_hit_rate          => { src => 'IB_bp_buf_pool_hit_rate' },
+         buf_pool_reads             => { src => 'IB_bp_buf_pool_reads' },
+         buf_pool_hits              => { src => 'IB_bp_buf_pool_hits' },
+         dict_mem_alloc             => { src => 'IB_bp_dict_mem_alloc' },
+         pages_total                => { src => 'IB_bp_pages_total' },
+         pages_modified             => { src => 'IB_bp_pages_modified' },
+         reads_pending              => { src => 'IB_bp_reads_pending' },
+         writes_pending             => { src => 'IB_bp_writes_pending' },
+         writes_pending_lru         => { src => 'IB_bp_writes_pending_lru' },
+         writes_pending_flush_list  => { src => 'IB_bp_writes_pending_flush_list' },
+         writes_pending_single_page => { src => 'IB_bp_writes_pending_single_page' },
+         page_creates_sec           => { src => 'IB_bp_page_creates_sec' },
+         page_reads_sec             => { src => 'IB_bp_page_reads_sec' },
+         page_writes_sec            => { src => 'IB_bp_page_writes_sec' },
+         pages_created              => { src => 'IB_bp_pages_created' },
+         pages_read                 => { src => 'IB_bp_pages_read' },
+         pages_written              => { src => 'IB_bp_pages_written' },
+      },
+      visible => [ qw(cxn buf_pool_size buf_free pages_total pages_modified buf_pool_hit_rate total_mem_alloc add_pool_alloc)],
+      filters => [],
+      sort_cols => 'cxn',
+      sort_dir => '1',
+      innodb   => 'bp',
+      group_by => [],
+      aggregate => 0,
+   },
+   # TODO: a new step in set_to_tbl: join result to itself, grouped?
+   # TODO: this would also enable pulling Q and T data together.
+   # TODO: using a SQL-ish language would also allow pivots to be easier -- treat the pivoted data as a view and SELECT from it.
+   cmd_summary => {
+      capt => 'Command Summary',
+      cust => {},
+      cols => {
+         name       => { src => 'name' },
+         total      => { src => 'total' },
+         value      => { src => 'value',                     agg   => 'sum'},
+         pct        => { src => 'value/total',               trans => [qw(percent)] },
+         last_total => { src => 'last_total' },
+         last_value => { src => 'last_value',                agg   => 'sum'},
+         last_pct   => { src => 'last_value/last_total',     trans => [qw(percent)] },
+      },
+      visible   => [qw(name value pct last_value last_pct)],
+      filters   => [qw()],
+      sort_cols => '-value',
+      sort_dir  => '1',
+      innodb    => '',
+      group_by  => [qw(name)],
+      aggregate => 1,
+   },
+   deadlock_locks => {
+      capt => 'Deadlock Locks',
+      cust => {},
+      cols => {
+         cxn              => { src => 'cxn' },
+         mysql_thread_id  => { src => 'mysql_thread_id' },
+         dl_txn_num       => { src => 'dl_txn_num' },
+         lock_type        => { src => 'lock_type' },
+         space_id         => { src => 'space_id' },
+         page_no          => { src => 'page_no' },
+         heap_no          => { src => 'heap_no' },
+         n_bits           => { src => 'n_bits' },
+         index            => { src => 'index' },
+         db               => { src => 'db' },
+         tbl              => { src => 'table' },
+         lock_mode        => { src => 'lock_mode' },
+         special          => { src => 'special' },
+         insert_intention => { src => 'insert_intention' },
+         waiting          => { src => 'waiting' },
+      },
+      visible => [ qw(cxn mysql_thread_id waiting lock_mode db tbl index special insert_intention)],
+      filters => [],
+      sort_cols => 'cxn mysql_thread_id',
+      sort_dir => '1',
+      innodb   => 'dl',
+      group_by => [],
+      aggregate => 0,
+   },
+   deadlock_transactions => {
+      capt => 'Deadlock Transactions',
+      cust => {},
+      cols => {
+         cxn                => { src => 'cxn' },
+         active_secs        => { src => 'active_secs' },
+         dl_txn_num         => { src => 'dl_txn_num' },
+         has_read_view      => { src => 'has_read_view' },
+         heap_size          => { src => 'heap_size' },
+         host_and_domain    => { src => 'hostname' },
+         hostname           => { src => $exprs{Host} },
+         ip                 => { src => 'ip' },
+         lock_structs       => { src => 'lock_structs' },
+         lock_wait_time     => { src => 'lock_wait_time', trans => [ qw(secs_to_time) ] },
+         mysql_thread_id    => { src => 'mysql_thread_id' },
+         os_thread_id       => { src => 'os_thread_id' },
+         proc_no            => { src => 'proc_no' },
+         query_id           => { src => 'query_id' },
+         query_status       => { src => 'query_status' },
+         query_text         => { src => 'query_text', trans => [ qw(no_ctrl_char) ] },
+         row_locks          => { src => 'row_locks' },
+         tables_in_use      => { src => 'tables_in_use' },
+         tables_locked      => { src => 'tables_locked' },
+         thread_decl_inside => { src => 'thread_decl_inside' },
+         thread_status      => { src => 'thread_status' },
+         'time'             => { src => 'active_secs', trans => [ qw(secs_to_time) ] },
+         timestring         => { src => 'timestring' },
+         txn_doesnt_see_ge  => { src => 'txn_doesnt_see_ge' },
+         txn_id             => { src => 'txn_id' },
+         txn_sees_lt        => { src => 'txn_sees_lt' },
+         txn_status         => { src => 'txn_status' },
+         truncates          => { src => 'truncates' },
+         undo_log_entries   => { src => 'undo_log_entries' },
+         user               => { src => 'user' },
+         victim             => { src => 'victim' },
+         wait_status        => { src => 'lock_wait_status' },
+      },
+      visible => [ qw(cxn mysql_thread_id timestring user hostname victim time undo_log_entries lock_structs query_text)],
+      filters => [],
+      sort_cols => 'cxn mysql_thread_id',
+      sort_dir => '1',
+      innodb   => 'dl',
+      group_by => [],
+      aggregate => 0,
+   },
+   explain => {
+      capt => 'EXPLAIN Results',
+      cust => {},
+      cols => {
+         part_id       => { src => 'id' },
+         select_type   => { src => 'select_type' },
+         tbl           => { src => 'table' },
+         partitions    => { src => 'partitions' },
+         scan_type     => { src => 'type' },
+         possible_keys => { src => 'possible_keys' },
+         index         => { src => 'key' },
+         key_len       => { src => 'key_len' },
+         index_ref     => { src => 'ref' },
+         num_rows      => { src => 'rows' },
+         special       => { src => 'extra' },
+      },
+      visible => [ qw(select_type tbl partitions scan_type possible_keys index key_len index_ref num_rows special)],
+      filters => [],
+      sort_cols => '',
+      sort_dir => '1',
+      innodb   => '',
+      group_by => [],
+      aggregate => 0,
+   },
+   file_io_misc => {
+      capt => 'File I/O Misc',
+      cust => {},
+      cols => {
+         cxn            => { src => 'cxn' },
+         io_bytes_s     => { src => 'IB_io_avg_bytes_s' },
+         io_flush_type  => { src => 'IB_io_flush_type' },
+         io_fsyncs_s    => { src => 'IB_io_fsyncs_s' },
+         io_reads_s     => { src => 'IB_io_reads_s' },
+         io_writes_s    => { src => 'IB_io_writes_s' },
+         os_file_reads  => { src => 'IB_io_os_file_reads' },
+         os_file_writes => { src => 'IB_io_os_file_writes' },
+         os_fsyncs      => { src => 'IB_io_os_fsyncs' },
+      },
+      visible => [ qw(cxn os_file_reads os_file_writes os_fsyncs io_reads_s io_writes_s io_bytes_s)],
+      filters => [],
+      sort_cols => 'cxn',
+      sort_dir => '1',
+      innodb   => 'io',
+      group_by => [],
+      aggregate => 0,
+   },
+   fk_error => {
+      capt => 'Foreign Key Error Info',
+      cust => {},
+      cols => {
+         timestring   => { src => 'IB_fk_timestring' },
+         child_db     => { src => 'IB_fk_child_db' },
+         child_table  => { src => 'IB_fk_child_table' },
+         child_index  => { src => 'IB_fk_child_index' },
+         fk_name      => { src => 'IB_fk_fk_name' },
+         parent_db    => { src => 'IB_fk_parent_db' },
+         parent_table => { src => 'IB_fk_parent_table' },
+         parent_col   => { src => 'IB_fk_parent_col' },
+         parent_index => { src => 'IB_fk_parent_index' },
+         attempted_op => { src => 'IB_fk_attempted_op' },
+      },
+      visible => [ qw(timestring child_db child_table child_index parent_db parent_table parent_col parent_index fk_name attempted_op)],
+      filters => [],
+      sort_cols => '',
+      sort_dir => '1',
+      innodb   => 'fk',
+      group_by => [],
+      aggregate => 0,
+   },
+   insert_buffers => {
+      capt => 'Insert Buffers',
+      cust => {},
+      cols => {
+         cxn           => { src => 'cxn' },
+         inserts       => { src => 'IB_ib_inserts' },
+         merged_recs   => { src => 'IB_ib_merged_recs' },
+         merges        => { src => 'IB_ib_merges' },
+         size          => { src => 'IB_ib_size' },
+         free_list_len => { src => 'IB_ib_free_list_len' },
+         seg_size      => { src => 'IB_ib_seg_size' },
+      },
+      visible => [ qw(cxn inserts merged_recs merges size free_list_len seg_size)],
+      filters => [],
+      sort_cols => 'cxn',
+      sort_dir => '1',
+      innodb   => 'ib',
+      group_by => [],
+      aggregate => 0,
+   },
+   innodb_locks  => {
+      capt => 'InnoDB Locks',
+      cust => {},
+      cols => {
+         cxn              => { src => 'cxn' },
+         db               => { src => 'db' },
+         index            => { src => 'index' },
+         insert_intention => { src => 'insert_intention' },
+         lock_mode        => { src => 'lock_mode' },
+         lock_type        => { src => 'lock_type' },
+         lock_wait_time   => { src => 'lock_wait_time', trans => [ qw(secs_to_time) ] },
+         mysql_thread_id  => { src => 'mysql_thread_id' },
+         n_bits           => { src => 'n_bits' },
+         page_no          => { src => 'page_no' },
+         space_id         => { src => 'space_id' },
+         special          => { src => 'special' },
+         tbl              => { src => 'table' },
+         'time'           => { src => 'active_secs', hdr => 'Active', trans => [ qw(secs_to_time) ] },
+         txn_id           => { src => 'txn_id' },
+         waiting          => { src => 'waiting' },
+      },
+      visible => [ qw(cxn mysql_thread_id lock_type waiting lock_wait_time time lock_mode db tbl index insert_intention special)],
+      filters => [],
+      sort_cols => 'cxn -lock_wait_time',
+      sort_dir => '1',
+      innodb   => 'tx',
+      colors   => [
+         { col => 'lock_wait_time', op => '>',  arg => 60, color => 'red' },
+         { col => 'lock_wait_time', op => '>',  arg => 30, color => 'yellow' },
+         { col => 'lock_wait_time', op => '>',  arg => 10, color => 'green' },
+      ],
+      group_by => [],
+      aggregate => 0,
+   },
+   innodb_transactions => {
+      capt => 'InnoDB Transactions',
+      cust => {},
+      cols => {
+         cxn                => { src => 'cxn' },
+         active_secs        => { src => 'active_secs' },
+         has_read_view      => { src => 'has_read_view' },
+         heap_size          => { src => 'heap_size' },
+         hostname           => { src => $exprs{Host} },
+         ip                 => { src => 'ip' },
+         wait_status        => { src => 'lock_wait_status' },
+         lock_wait_time     => { src => 'lock_wait_time',      trans => [ qw(secs_to_time) ] },
+         lock_structs       => { src => 'lock_structs' },
+         mysql_thread_id    => { src => 'mysql_thread_id' },
+         os_thread_id       => { src => 'os_thread_id' },
+         proc_no            => { src => 'proc_no' },
+         query_id           => { src => 'query_id' },
+         query_status       => { src => 'query_status' },
+         query_text         => { src => 'query_text',          trans => [ qw(no_ctrl_char) ] },
+         txn_time_remain    => { src => $exprs{TxnTimeRemain}, trans => [ qw(secs_to_time) ] },
+         row_locks          => { src => 'row_locks' },
+         tables_in_use      => { src => 'tables_in_use' },
+         tables_locked      => { src => 'tables_locked' },
+         thread_decl_inside => { src => 'thread_decl_inside' },
+         thread_status      => { src => 'thread_status' },
+         'time'             => { src => 'active_secs',         trans => [ qw(secs_to_time) ], agg => 'sum' },
+         txn_doesnt_see_ge  => { src => 'txn_doesnt_see_ge' },
+         txn_id             => { src => 'txn_id' },
+         txn_sees_lt        => { src => 'txn_sees_lt' },
+         txn_status         => { src => 'txn_status',          minw => 10, maxw => 10 },
+         undo_log_entries   => { src => 'undo_log_entries' },
+         user               => { src => 'user',                maxw => 10 },
+         cnt                => { src => 'mysql_thread_id',     minw => 0 },
+      },
+      visible => [ qw(cxn cnt mysql_thread_id user hostname txn_status time undo_log_entries query_text)],
+      filters => [ qw( hide_self hide_inactive ) ],
+      sort_cols => '-active_secs txn_status cxn mysql_thread_id',
+      sort_dir => '1',
+      innodb   => 'tx',
+      hide_caption => 1,
+      colors   => [
+         { col => 'wait_status', op => 'eq', arg => 'LOCK WAIT',   color => 'black on_red' },
+         { col => 'time',        op => '>',  arg => 600,           color => 'red' },
+         { col => 'time',        op => '>',  arg => 300,           color => 'yellow' },
+         { col => 'time',        op => '>',  arg => 60,            color => 'green' },
+         { col => 'time',        op => '>',  arg => 30,            color => 'cyan' },
+         { col => 'txn_status',  op => 'eq', arg => 'not started', color => 'white' },
+      ],
+      group_by => [ qw(cxn txn_status) ],
+      aggregate => 0,
+   },
+   io_threads => {
+      capt => 'I/O Threads',
+      cust => {},
+      cols => {
+         cxn            => { src => 'cxn' },
+         thread         => { src => 'thread' },
+         thread_purpose => { src => 'purpose' },
+         event_set      => { src => 'event_set' },
+         thread_status  => { src => 'state' },
+      },
+      visible => [ qw(cxn thread thread_purpose thread_status)],
+      filters => [ qw() ],
+      sort_cols => 'cxn thread',
+      sort_dir => '1',
+      innodb   => 'io',
+      group_by => [],
+      aggregate => 0,
+   },
+   log_statistics => {
+      capt => 'Log Statistics',
+      cust => {},
+      cols => {
+         cxn                 => { src => 'cxn' },
+         last_chkp           => { src => 'IB_lg_last_chkp' },
+         log_flushed_to      => { src => 'IB_lg_log_flushed_to' },
+         log_ios_done        => { src => 'IB_lg_log_ios_done' },
+         log_ios_s           => { src => 'IB_lg_log_ios_s' },
+         log_seq_no          => { src => 'IB_lg_log_seq_no' },
+         pending_chkp_writes => { src => 'IB_lg_pending_chkp_writes' },
+         pending_log_writes  => { src => 'IB_lg_pending_log_writes' },
+      },
+      visible => [ qw(cxn log_seq_no log_flushed_to last_chkp log_ios_done log_ios_s)],
+      filters => [],
+      sort_cols => 'cxn',
+      sort_dir => '1',
+      innodb   => 'lg',
+      group_by => [],
+      aggregate => 0,
+   },
+   master_status => {
+      capt => 'Master Status',
+      cust => {},
+      cols => {
+         cxn                         => { src => 'cxn' },
+         binlog_do_db                => { src => 'binlog_do_db' },
+         binlog_ignore_db            => { src => 'binlog_ignore_db' },
+         master_file                 => { src => 'file' },
+         master_pos                  => { src => 'position' },
+         binlog_cache_overflow       => { src => '(Binlog_cache_disk_use||0)/(Binlog_cache_use||1)', trans => [ qw(percent) ] },
+      },
+      visible => [ qw(cxn master_file master_pos binlog_cache_overflow)],
+      filters => [ qw(cxn_is_master) ],
+      sort_cols => 'cxn',
+      sort_dir => '1',
+      innodb   => '',
+      group_by => [],
+      aggregate => 0,
+   },
+   pending_io => {
+      capt => 'Pending I/O',
+      cust => {},
+      cols => {
+         cxn                => { src => 'cxn' },
+         p_normal_aio_reads => { src => 'IB_io_pending_normal_aio_reads' },
+         p_aio_writes       => { src => 'IB_io_pending_aio_writes' },
+         p_ibuf_aio_reads   => { src => 'IB_io_pending_ibuf_aio_reads' },
+         p_sync_ios         => { src => 'IB_io_pending_sync_ios' },
+         p_buf_pool_flushes => { src => 'IB_io_pending_buffer_pool_flushes' },
+         p_log_flushes      => { src => 'IB_io_pending_log_flushes' },
+         p_log_ios          => { src => 'IB_io_pending_log_ios' },
+         p_preads           => { src => 'IB_io_pending_preads' },
+         p_pwrites          => { src => 'IB_io_pending_pwrites' },
+      },
+      visible => [ qw(cxn p_normal_aio_reads p_aio_writes p_ibuf_aio_reads p_sync_ios p_log_flushes p_log_ios)],
+      filters => [],
+      sort_cols => 'cxn',
+      sort_dir => '1',
+      innodb   => 'io',
+      group_by => [],
+      aggregate => 0,
+   },
+   open_tables => {
+      capt => 'Open Tables',
+      cust => {},
+      cols => {
+         cxn            => { src => 'cxn' },
+         db             => { src => 'database' },
+         tbl            => { src => 'table' },
+         num_times_open => { src => 'in_use' },
+         is_name_locked => { src => 'name_locked' },
+      },
+      visible => [ qw(cxn db tbl num_times_open is_name_locked)],
+      filters => [ qw(table_is_open) ],
+      sort_cols => '-num_times_open cxn db tbl',
+      sort_dir => '1',
+      innodb   => '',
+      group_by => [],
+      aggregate => 0,
+   },
+   page_statistics => {
+      capt => 'Page Statistics',
+      cust => {},
+      cols => {
+         cxn              => { src => 'cxn' },
+         pages_read       => { src => 'IB_bp_pages_read' },
+         pages_written    => { src => 'IB_bp_pages_written' },
+         pages_created    => { src => 'IB_bp_pages_created' },
+         page_reads_sec   => { src => 'IB_bp_page_reads_sec' },
+         page_writes_sec  => { src => 'IB_bp_page_writes_sec' },
+         page_creates_sec => { src => 'IB_bp_page_creates_sec' },
+      },
+      visible => [ qw(cxn pages_read pages_written pages_created page_reads_sec page_writes_sec page_creates_sec)],
+      filters => [],
+      sort_cols => 'cxn',
+      sort_dir => '1',
+      innodb   => 'bp',
+      group_by => [],
+      aggregate => 0,
+   },
+   processlist => {
+      capt => 'MySQL Process List',
+      cust => {},
+      cols => {
+         cxn             => { src => 'cxn',        minw => 6,  maxw => 10 },
+         mysql_thread_id => { src => 'id',         minw => 6,  maxw => 0 },
+         user            => { src => 'user',       minw => 5,  maxw => 8 },
+         hostname        => { src => $exprs{Host}, minw => 13, maxw => 8, },
+         port            => { src => $exprs{Port}, minw => 0,  maxw => 0, },
+         host_and_port   => { src => 'host',       minw => 0,  maxw => 0 },
+         db              => { src => 'db',         minw => 6,  maxw => 12 },
+         cmd             => { src => 'command',    minw => 5,  maxw => 0 },
+         time            => { src => 'time',       minw => 5,  maxw => 0, trans => [ qw(secs_to_time) ], agg => 'sum' },
+         state           => { src => 'state',      minw => 0,  maxw => 0 },
+         info            => { src => 'info',       minw => 0,  maxw => 0, trans => [ qw(no_ctrl_char) ] },
+         cnt             => { src => 'id',         minw => 0,  maxw => 0 },
+      },
+      visible => [ qw(cxn cmd cnt mysql_thread_id state user hostname db time info)],
+      filters => [ qw(hide_self hide_inactive hide_slave_io) ],
+      sort_cols => '-time cxn hostname mysql_thread_id',
+      sort_dir => '1',
+      innodb   => '',
+      hide_caption => 1,
+      colors   => [
+         { col => 'state',       op => 'eq', arg => 'Locked',      color => 'black on_red' },
+         { col => 'cmd',         op => 'eq', arg => 'Sleep',       color => 'white' },
+         { col => 'user',        op => 'eq', arg => 'system user', color => 'white' },
+         { col => 'cmd',         op => 'eq', arg => 'Connect',     color => 'white' },
+         { col => 'cmd',         op => 'eq', arg => 'Binlog Dump', color => 'white' },
+         { col => 'time',        op => '>',  arg => 600,           color => 'red' },
+         { col => 'time',        op => '>',  arg => 120,           color => 'yellow' },
+         { col => 'time',        op => '>',  arg => 60,            color => 'green' },
+         { col => 'time',        op => '>',  arg => 30,            color => 'cyan' },
+      ],
+      group_by => [qw(cxn cmd)],
+      aggregate => 0,
+   },
+
+   # TODO: some more columns:
+   # kb_used=hdr='BufUsed' minw='0' num='0' src='percent(1 - ((Key_blocks_unused * key_cache_block_size) / (key_buffer_size||1)))' dec='0' trans='' tbl='q_header' just='-' user='1' maxw='0' label='User-defined'
+   # retries=hdr='Retries' minw='0' num='0' src='Slave_retried_transactions' dec='0' trans='' tbl='slave_sql_status' just='-' user='1' maxw='0' label='User-defined'
+   # thd=hdr='Thd' minw='0' num='0' src='Threads_connected' dec='0' trans='' tbl='slave_sql_status' just='-' user='1' maxw='0' label='User-defined'
+
+   q_header => {
+      capt => 'Q-mode Header',
+      cust => {},
+      cols => {
+         cxn            => { src => 'cxn' },
+         questions      => { src => 'Questions' },
+         qps            => { src => 'Questions/Uptime_hires',               dec => 1, trans => [qw(shorten)] },
+         load           => { src => $exprs{ServerLoad},                     dec => 1, trans => [qw(shorten)] },
+         slow           => { src => 'Slow_queries',                         dec => 1, trans => [qw(shorten)] },
+         q_cache_hit    => { src => $exprs{QcacheHitRatio},                 dec => 1, trans => [qw(percent)] },
+         key_buffer_hit => { src => '1-(Key_reads/(Key_read_requests||1))', dec => 1, trans => [qw(percent)] },
+         bps_in         => { src => 'Bytes_received/Uptime_hires',          dec => 1, trans => [qw(shorten)] },
+         bps_out        => { src => 'Bytes_sent/Uptime_hires',              dec => 1, trans => [qw(shorten)] },
+         when           => { src => 'when' },
+      },
+      visible => [ qw(cxn when load qps slow q_cache_hit key_buffer_hit bps_in bps_out)],
+      filters => [],
+      sort_cols => 'when cxn',
+      sort_dir => '1',
+      innodb   => '',
+      hide_caption => 1,
+      group_by => [],
+      aggregate => 0,
+   },
+   row_operations => {
+      capt => 'InnoDB Row Operations',
+      cust => {},
+      cols => {
+         cxn         => { src => 'cxn' },
+         num_inserts => { src => 'IB_ro_num_rows_ins' },
+         num_updates => { src => 'IB_ro_num_rows_upd' },
+         num_reads   => { src => 'IB_ro_num_rows_read' },
+         num_deletes => { src => 'IB_ro_num_rows_del' },
+         num_inserts_sec => { src => 'IB_ro_ins_sec' },
+         num_updates_sec => { src => 'IB_ro_upd_sec' },
+         num_reads_sec   => { src => 'IB_ro_read_sec' },
+         num_deletes_sec => { src => 'IB_ro_del_sec' },
+      },
+      visible => [ qw(cxn num_inserts num_updates num_reads num_deletes num_inserts_sec
+                       num_updates_sec num_reads_sec num_deletes_sec)],
+      filters => [],
+      sort_cols => 'cxn',
+      sort_dir => '1',
+      innodb   => 'ro',
+      group_by => [],
+      aggregate => 0,
+   },
+   row_operation_misc => {
+      capt => 'Row Operation Misc',
+      cust => {},
+      cols => {
+         cxn                 => { src => 'cxn' },
+         queries_in_queue    => { src => 'IB_ro_queries_in_queue' },
+         queries_inside      => { src => 'IB_ro_queries_inside' },
+         read_views_open     => { src => 'IB_ro_read_views_open' },
+         main_thread_id      => { src => 'IB_ro_main_thread_id' },
+         main_thread_proc_no => { src => 'IB_ro_main_thread_proc_no' },
+         main_thread_state   => { src => 'IB_ro_main_thread_state' },
+         num_res_ext         => { src => 'IB_ro_n_reserved_extents' },
+      },
+      visible => [ qw(cxn queries_in_queue queries_inside read_views_open main_thread_state)],
+      filters => [],
+      sort_cols => 'cxn',
+      sort_dir => '1',
+      innodb   => 'ro',
+      group_by => [],
+      aggregate => 0,
+   },
+   semaphores => {
+      capt => 'InnoDB Semaphores',
+      cust => {},
+      cols => {
+         cxn                => { src => 'cxn' },
+         mutex_os_waits     => { src => 'IB_sm_mutex_os_waits' },
+         mutex_spin_rounds  => { src => 'IB_sm_mutex_spin_rounds' },
+         mutex_spin_waits   => { src => 'IB_sm_mutex_spin_waits' },
+         reservation_count  => { src => 'IB_sm_reservation_count' },
+         rw_excl_os_waits   => { src => 'IB_sm_rw_excl_os_waits' },
+         rw_excl_spins      => { src => 'IB_sm_rw_excl_spins' },
+         rw_shared_os_waits => { src => 'IB_sm_rw_shared_os_waits' },
+         rw_shared_spins    => { src => 'IB_sm_rw_shared_spins' },
+         signal_count       => { src => 'IB_sm_signal_count' },
+         wait_array_size    => { src => 'IB_sm_wait_array_size' },
+      },
+      visible => [ qw(cxn mutex_os_waits mutex_spin_waits mutex_spin_rounds
+         rw_excl_os_waits rw_excl_spins rw_shared_os_waits rw_shared_spins
+         signal_count reservation_count )],
+      filters => [],
+      sort_cols => 'cxn',
+      sort_dir => '1',
+      innodb   => 'sm',
+      group_by => [],
+      aggregate => 0,
+   },
+   slave_io_status => {
+      capt => 'Slave I/O Status',
+      cust => {},
+      cols => {
+         cxn                         => { src => 'cxn' },
+         connect_retry               => { src => 'connect_retry' },
+         master_host                 => { src => 'master_host', hdr => 'Master'},
+         master_log_file             => { src => 'master_log_file', hdr => 'File' },
+         master_port                 => { src => 'master_port' },
+         master_ssl_allowed          => { src => 'master_ssl_allowed' },
+         master_ssl_ca_file          => { src => 'master_ssl_ca_file' },
+         master_ssl_ca_path          => { src => 'master_ssl_ca_path' },
+         master_ssl_cert             => { src => 'master_ssl_cert' },
+         master_ssl_cipher           => { src => 'master_ssl_cipher' },
+         master_ssl_key              => { src => 'master_ssl_key' },
+         master_user                 => { src => 'master_user' },
+         read_master_log_pos         => { src => 'read_master_log_pos', hdr => 'Pos' },
+         relay_log_size              => { src => 'relay_log_space', trans => [qw(shorten)] },
+         slave_io_running            => { src => 'slave_io_running', hdr => 'On?' },
+         slave_io_state              => { src => 'slave_io_state', hdr => 'State' },
+      },
+      visible => [ qw(cxn master_host slave_io_running master_log_file relay_log_size read_master_log_pos slave_io_state)],
+      filters => [ qw( cxn_is_slave ) ],
+      sort_cols => 'slave_io_running cxn',
+      colors   => [
+         { col => 'slave_io_running',  op => 'ne', arg => 'Yes', color => 'black on_red' },
+      ],
+      sort_dir => '1',
+      innodb   => '',
+      group_by => [],
+      aggregate => 0,
+   },
+   slave_sql_status => {
+      capt => 'Slave SQL Status',
+      cust => {},
+      cols => {
+         cxn                         => { src => 'cxn' },
+         exec_master_log_pos         => { src => 'exec_master_log_pos', hdr => 'Master Pos' },
+         last_errno                  => { src => 'last_errno' },
+         last_error                  => { src => 'last_error' },
+         master_host                 => { src => 'master_host', hdr => 'Master' },
+         relay_log_file              => { src => 'relay_log_file' },
+         relay_log_pos               => { src => 'relay_log_pos' },
+         relay_log_size              => { src => 'relay_log_space', trans => [qw(shorten)] },
+         relay_master_log_file       => { src => 'relay_master_log_file', hdr => 'Master File' },
+         replicate_do_db             => { src => 'replicate_do_db' },
+         replicate_do_table          => { src => 'replicate_do_table' },
+         replicate_ignore_db         => { src => 'replicate_ignore_db' },
+         replicate_ignore_table      => { src => 'replicate_ignore_table' },
+         replicate_wild_do_table     => { src => 'replicate_wild_do_table' },
+         replicate_wild_ignore_table => { src => 'replicate_wild_ignore_table' },
+         skip_counter                => { src => 'skip_counter' },
+         slave_sql_running           => { src => 'slave_sql_running', hdr => 'On?' },
+         until_condition             => { src => 'until_condition' },
+         until_log_file              => { src => 'until_log_file' },
+         until_log_pos               => { src => 'until_log_pos' },
+         time_behind_master          => { src => 'seconds_behind_master', trans => [ qw(secs_to_time) ] },
+         bytes_behind_master         => { src => 'master_log_file && master_log_file eq relay_master_log_file ? read_master_log_pos - exec_master_log_pos : 0', trans => [qw(shorten)] },
+         slave_catchup_rate          => { src => $exprs{SlaveCatchupRate}, trans => [ qw(set_precision) ] },
+         slave_open_temp_tables      => { src => 'Slave_open_temp_tables' },
+      },
+      visible => [ qw(cxn master_host slave_sql_running time_behind_master slave_catchup_rate slave_open_temp_tables relay_log_pos last_error)],
+      filters => [ qw( cxn_is_slave ) ],
+      sort_cols => 'slave_sql_running cxn',
+      sort_dir => '1',
+      innodb   => '',
+      colors   => [
+         { col => 'slave_sql_running',  op => 'ne', arg => 'Yes', color => 'black on_red' },
+         { col => 'time_behind_master', op => '>',  arg => 600,   color => 'red' },
+         { col => 'time_behind_master', op => '>',  arg => 60,    color => 'yellow' },
+         { col => 'time_behind_master', op => '==', arg => 0,     color => 'white' },
+      ],
+      group_by => [],
+      aggregate => 0,
+   },
+   t_header => {
+      capt => 'T-Mode Header',
+      cust => {},
+      cols => {
+         cxn                         => { src => 'cxn' },
+         dirty_bufs                  => { src => $exprs{DirtyBufs},           trans => [qw(percent)] },
+         history_list_len            => { src => 'IB_tx_history_list_len' },
+         lock_structs                => { src => 'IB_tx_num_lock_structs' },
+         num_txns                    => { src => $exprs{NumTxns} },
+         max_txn                     => { src => $exprs{MaxTxnTime},          trans => [qw(secs_to_time)] },
+         undo_for                    => { src => 'IB_tx_purge_undo_for' },
+         used_bufs                   => { src => $exprs{BufPoolFill},         trans => [qw(percent)]},
+         versions                    => { src => $exprs{OldVersions} },
+      },
+      visible => [ qw(cxn history_list_len versions undo_for dirty_bufs used_bufs num_txns max_txn lock_structs)],
+      filters => [ ],
+      sort_cols => 'cxn',
+      sort_dir => '1',
+      innodb   => '',
+      colors   => [],
+      hide_caption => 1,
+      group_by => [],
+      aggregate => 0,
+   },
+   var_status => {
+      capt      => 'Variables & Status',
+      cust      => {},
+      cols      => {}, # Generated from current varset
+      visible   => [], # Generated from current varset
+      filters   => [],
+      sort_cols => '',
+      sort_dir  => 1,
+      innodb    => '',
+      temp      => 1, # Do not persist to config file.
+      hide_caption  => 1,
+      pivot     => 0,
+      group_by => [],
+      aggregate => 0,
+   },
+   wait_array => {
+      capt => 'InnoDB Wait Array',
+      cust => {},
+      cols => {
+         cxn                => { src => 'cxn' },
+         thread             => { src => 'thread' },
+         waited_at_filename => { src => 'waited_at_filename' },
+         waited_at_line     => { src => 'waited_at_line' },
+         'time'             => { src => 'waited_secs', trans => [ qw(secs_to_time) ] },
+         request_type       => { src => 'request_type' },
+         lock_mem_addr      => { src => 'lock_mem_addr' },
+         lock_cfile_name    => { src => 'lock_cfile_name' },
+         lock_cline         => { src => 'lock_cline' },
+         writer_thread      => { src => 'writer_thread' },
+         writer_lock_mode   => { src => 'writer_lock_mode' },
+         num_readers        => { src => 'num_readers' },
+         lock_var           => { src => 'lock_var' },
+         waiters_flag       => { src => 'waiters_flag' },
+         last_s_file_name   => { src => 'last_s_file_name' },
+         last_s_line        => { src => 'last_s_line' },
+         last_x_file_name   => { src => 'last_x_file_name' },
+         last_x_line        => { src => 'last_x_line' },
+         cell_waiting       => { src => 'cell_waiting' },
+         cell_event_set     => { src => 'cell_event_set' },
+      },
+      visible => [ qw(cxn thread time waited_at_filename waited_at_line request_type num_readers lock_var waiters_flag cell_waiting cell_event_set)],
+      filters => [],
+      sort_cols => 'cxn -time',
+      sort_dir => '1',
+      innodb   => 'sm',
+      group_by => [],
+      aggregate => 0,
+   },
+);
+
+# Initialize %tbl_meta from %columns and do some checks.
+foreach my $table_name ( keys %tbl_meta ) {
+   my $table = $tbl_meta{$table_name};
+   my $cols  = $table->{cols};
+
+   foreach my $col_name ( keys %$cols ) {
+      my $col_def = $table->{cols}->{$col_name};
+      die "I can't find a column named '$col_name' for '$table_name'" unless $columns{$col_name};
+      $columns{$col_name}->{referenced} = 1;
+
+      foreach my $prop ( keys %col_props ) {
+         # Each column gets non-existing values set from %columns or defaults from %col_props.
+         if ( !$col_def->{$prop} ) {
+            $col_def->{$prop}
+               = defined($columns{$col_name}->{$prop})
+               ? $columns{$col_name}->{$prop}
+               : $col_props{$prop};
+         }
+      }
+
+      # Ensure transformations and aggregate functions are valid
+      die "Unknown aggregate function '$col_def->{agg}' "
+         . "for column '$col_name' in table '$table_name'"
+         unless exists $agg_funcs{$col_def->{agg}};
+      foreach my $trans ( @{$col_def->{trans}} ) {
+         die "Unknown transformation '$trans' "
+            . "for column '$col_name' in table '$table_name'"
+            unless exists $trans_funcs{$trans};
+      }
+   }
+
+   # Ensure each column in visible and group_by exists in cols
+   foreach my $place ( qw(visible group_by) ) {
+      foreach my $col_name ( @{$table->{$place}} ) {
+         if ( !exists $cols->{$col_name} ) {
+            die "Column '$col_name' is listed in '$place' for '$table_name', but doesn't exist";
+         }
+      }
+   }
+
+   # Compile sort and color subroutines
+   $table->{sort_func}  = make_sort_func($table);
+   $table->{color_func} = make_color_func($table);
+}
+
+# This is for code cleanup:
+{
+   my @unused_cols = grep { !$columns{$_}->{referenced} } sort keys %columns;
+   if ( @unused_cols ) {
+      die "The following columns are not used: "
+         . join(' ', @unused_cols);
+   }
+}
+
+# ###########################################################################
+# Operating modes {{{3
+# ###########################################################################
+my %modes = (
+   B => {
+      hdr               => 'InnoDB Buffers',
+      cust              => {},
+      note              => 'Shows buffer info from InnoDB',
+      action_for        => {
+         i => {
+            action => sub { toggle_config('status_inc') },
+            label  => 'Toggle incremental status display',
+         },
+      },
+      display_sub       => \&display_B,
+      connections       => [],
+      server_group      => '',
+      one_connection    => 0,
+      tables            => [qw(buffer_pool page_statistics insert_buffers adaptive_hash_index)],
+      visible_tables    => [qw(buffer_pool page_statistics insert_buffers adaptive_hash_index)],
+   },
+   C => {
+      hdr               => 'Command Summary',
+      cust              => {},
+      note              => 'Shows relative magnitude of variables',
+      action_for        => {
+         s => {
+            action => sub { get_config_interactive('cmd_filter') },
+            label  => 'Choose variable prefix',
+         },
+      },
+      display_sub       => \&display_C,
+      connections       => [],
+      server_group      => '',
+      one_connection    => 0,
+      tables            => [qw(cmd_summary)],
+      visible_tables    => [qw(cmd_summary)],
+   },
+   D => {
+      hdr               => 'InnoDB Deadlocks',
+      cust              => {},
+      note              => 'View InnoDB deadlock information',
+      action_for        => {
+         c => {
+            action => sub { edit_table('deadlock_transactions') },
+            label  => 'Choose visible columns',
+         },
+         w => {
+            action => \&create_deadlock,
+            label  => 'Wipe deadlock status info by creating a deadlock',
+         },
+      },
+      display_sub       => \&display_D,
+      connections       => [],
+      server_group      => '',
+      one_connection    => 0,
+      tables            => [qw(deadlock_transactions deadlock_locks)],
+      visible_tables    => [qw(deadlock_transactions deadlock_locks)],
+   },
+   F => {
+      hdr               => 'InnoDB FK Err',
+      cust              => {},
+      note              => 'View the latest InnoDB foreign key error',
+      action_for        => {},
+      display_sub       => \&display_F,
+      connections       => [],
+      server_group      => '',
+      one_connection    => 1,
+      tables            => [qw(fk_error)],
+      visible_tables    => [qw(fk_error)],
+   },
+   I => {
+      hdr               => 'InnoDB I/O Info',
+      cust              => {},
+      note              => 'Shows I/O info (i/o, log...) from InnoDB',
+      action_for        => {
+         i => {
+            action => sub { toggle_config('status_inc') },
+            label  => 'Toggle incremental status display',
+         },
+      },
+      display_sub       => \&display_I,
+      connections       => [],
+      server_group      => '',
+      one_connection    => 0,
+      tables            => [qw(io_threads pending_io file_io_misc log_statistics)],
+      visible_tables    => [qw(io_threads pending_io file_io_misc log_statistics)],
+   },
+   L => {
+      hdr             => 'Locks',
+      cust            => {},
+      note            => 'Shows transaction locks',
+      action_for      => {
+         a => {
+            action => sub { send_cmd_to_servers('CREATE TABLE IF NOT EXISTS test.innodb_lock_monitor(a int) ENGINE=InnoDB', 0, '', []); },
+            label  => 'Start the InnoDB Lock Monitor',
+         },
+         o => {
+            action => sub { send_cmd_to_servers('DROP TABLE IF EXISTS test.innodb_lock_monitor', 0, '', []); },
+            label  => 'Stop the InnoDB Lock Monitor',
+         },
+      },
+      display_sub     => \&display_L,
+      connections     => [],
+      server_group    => '',
+      one_connection  => 0,
+      tables            => [qw(innodb_locks)],
+      visible_tables    => [qw(innodb_locks)],
+   },
+   M => {
+      hdr               => 'Replication Status',
+      cust              => {},
+      note              => 'Shows replication (master and slave) status',
+      action_for        => {
+         a => {
+            action => sub { send_cmd_to_servers('START SLAVE', 0, 'START SLAVE SQL_THREAD UNTIL MASTER_LOG_FILE = ?, MASTER_LOG_POS = ?', []); },
+            label  => 'Start slave(s)',
+         },
+         i => {
+            action => sub { toggle_config('status_inc') },
+            label  => 'Toggle incremental status display',
+         },
+         o => {
+            action => sub { send_cmd_to_servers('STOP SLAVE', 0, '', []); },
+            label  => 'Stop slave(s)',
+         },
+         b => {
+            action => sub { purge_master_logs() },
+            label  => 'Purge unused master logs',
+         },
+      },
+      display_sub       => \&display_M,
+      connections       => [],
+      server_group      => '',
+      one_connection    => 0,
+      tables            => [qw(slave_sql_status slave_io_status master_status)],
+      visible_tables    => [qw(slave_sql_status slave_io_status master_status)],
+   },
+   O => {
+      hdr               => 'Open Tables',
+      cust              => {},
+      note              => 'Shows open tables in MySQL',
+      action_for        => {
+         r => {
+            action => sub { reverse_sort('open_tables'); },
+            label  => 'Reverse sort order',
+         },
+         s => {
+            action => sub { choose_sort_cols('open_tables'); },
+            label => "Choose sort column",
+         },
+      },
+      display_sub       => \&display_O,
+      connections       => [],
+      server_group      => '',
+      one_connection    => 0,
+      tables            => [qw(open_tables)],
+      visible_tables    => [qw(open_tables)],
+   },
+   Q => {
+      hdr        => 'Query List',
+      cust       => {},
+      note       => 'Shows queries from SHOW FULL PROCESSLIST',
+      action_for => {
+         a => {
+            action => sub { toggle_filter('processlist', 'hide_self') },
+            label  => 'Toggle the innotop process',
+         },
+         c => {
+            action => sub { edit_table('processlist') },
+            label  => 'Choose visible columns',
+         },
+         e => {
+            action => sub { analyze_query('e'); },
+            label  => "Explain a thread's query",
+         },
+         f => {
+            action => sub { analyze_query('f'); },
+            label  => "Show a thread's full query",
+         },
+         h => {
+            action => sub { toggle_visible_table('Q', 'q_header') },
+            label  => 'Toggle the header on and off',
+         },
+         i => {
+            action => sub { toggle_filter('processlist', 'hide_inactive') },
+            label  => 'Toggle idle processes',
+         },
+         k => {
+            action => sub { kill_query('CONNECTION') },
+            label => "Kill a query's connection",
+         },
+         r => {
+            action => sub { reverse_sort('processlist'); },
+            label  => 'Reverse sort order',
+         },
+         s => {
+            action => sub { choose_sort_cols('processlist'); },
+            label => "Change the display's sort column",
+         },
+         x => {
+            action => sub { kill_query('QUERY') },
+            label => "Kill a query",
+         },
+      },
+      display_sub       => \&display_Q,
+      connections       => [],
+      server_group      => '',
+      one_connection    => 0,
+      tables            => [qw(q_header processlist)],
+      visible_tables    => [qw(q_header processlist)],
+   },
+   R => {
+      hdr               => 'InnoDB Row Ops',
+      cust              => {},
+      note              => 'Shows InnoDB row operation and semaphore info',
+      action_for        => {
+         i => {
+            action => sub { toggle_config('status_inc') },
+            label  => 'Toggle incremental status display',
+         },
+      },
+      display_sub       => \&display_R,
+      connections       => [],
+      server_group      => '',
+      one_connection    => 0,
+      tables            => [qw(row_operations row_operation_misc semaphores wait_array)],
+      visible_tables    => [qw(row_operations row_operation_misc semaphores wait_array)],
+   },
+   S => {
+      hdr               => 'Variables & Status',
+      cust              => {},
+      note              => 'Shows query load statistics a la vmstat',
+      action_for        => {
+         '>' => {
+            action => sub { switch_var_set('S_set', 1) },
+            label  => 'Switch to next variable set',
+         },
+         '<' => {
+            action => sub { switch_var_set('S_set', -1) },
+            label  => 'Switch to prev variable set',
+         },
+         c => {
+            action => sub {
+               choose_var_set('S_set');
+               start_S_mode();
+            },
+            label => "Choose which set to display",
+         },
+         e => {
+            action => \&edit_current_var_set,
+            label  => 'Edit the current set of variables',
+         },
+         i => {
+            action => sub { $clear_screen_sub->(); toggle_config('status_inc') },
+            label  => 'Toggle incremental status display',
+         },
+         '-' => {
+            action => sub { set_display_precision(-1) },
+            label  => 'Decrease fractional display precision',
+         },
+         '+' => {
+            action => sub { set_display_precision(1) },
+            label  => 'Increase fractional display precision',
+         },
+         g => {
+            action => sub { set_s_mode('g') },
+            label  => 'Switch to graph (tload) view',
+         },
+         s => {
+            action => sub { set_s_mode('s') },
+            label  => 'Switch to standard (vmstat) view',
+         },
+         v => {
+            action => sub { set_s_mode('v') },
+            label  => 'Switch to pivoted view',
+         },
+      },
+      display_sub       => \&display_S,
+      no_clear_screen   => 1,
+      connections       => [],
+      server_group      => '',
+      one_connection    => 0,
+      tables            => [qw(var_status)],
+      visible_tables    => [qw(var_status)],
+   },
+   T => {
+      hdr        => 'InnoDB Txns',
+      cust       => {},
+      note       => 'Shows InnoDB transactions in top-like format',
+      action_for => {
+         a => {
+            action => sub { toggle_filter('innodb_transactions', 'hide_self') },
+            label  => 'Toggle the innotop process',
+         },
+         c => {
+            action => sub { edit_table('innodb_transactions') },
+            label  => 'Choose visible columns',
+         },
+         e => {
+            action => sub { analyze_query('e'); },
+            label  => "Explain a thread's query",
+         },
+         f => {
+            action => sub { analyze_query('f'); },
+            label  => "Show a thread's full query",
+         },
+         h => {
+            action => sub { toggle_visible_table('T', 't_header') },
+            label  => 'Toggle the header on and off',
+         },
+         i => {
+            action => sub { toggle_filter('innodb_transactions', 'hide_inactive') },
+            label  => 'Toggle inactive transactions',
+         },
+         k => {
+            action => sub { kill_query('CONNECTION') },
+            label  => "Kill a transaction's connection",
+         },
+         r => {
+            action => sub { reverse_sort('innodb_transactions'); },
+            label  => 'Reverse sort order',
+         },
+         s => {
+            action => sub { choose_sort_cols('innodb_transactions'); },
+            label  => "Change the display's sort column",
+         },
+         x => {
+            action => sub { kill_query('QUERY') },
+            label  => "Kill a query",
+         },
+      },
+      display_sub       => \&display_T,
+      connections       => [],
+      server_group      => '',
+      one_connection    => 0,
+      tables            => [qw(t_header innodb_transactions)],
+      visible_tables    => [qw(t_header innodb_transactions)],
+   },
+);
+
+# ###########################################################################
+# Global key mappings {{{3
+# Keyed on a single character, which is read from the keyboard.  Uppercase
+# letters switch modes.  Lowercase letters access commands when in a mode.
+# These can be overridden by action_for in %modes.
+# ###########################################################################
+my %action_for = (
+   '$' => {
+      action => \&edit_configuration,
+      label  => 'Edit configuration settings',
+   },
+   '?' => {
+      action => \&display_help,
+      label  => 'Show help',
+   },
+   '!' => {
+      action => \&display_license,
+      label  => 'Show license and warranty',
+   },
+   '^' => {
+      action => \&edit_table,
+      label  => "Edit the displayed table(s)",
+   },
+   '#' => {
+      action => \&choose_server_groups,
+      label  => 'Select/create server groups',
+   },
+   '@' => {
+      action => \&choose_servers,
+      label  => 'Select/create server connections',
+   },
+   '/' => {
+      action => \&add_quick_filter,
+      label  => 'Quickly filter what you see',
+   },
+   '\\' => {
+      action => \&clear_quick_filters,
+      label  => 'Clear quick-filters',
+   },
+   '%' => {
+      action => \&choose_filters,
+      label  => 'Choose and edit table filters',
+   },
+   "\t" => {
+      action => \&next_server_group,
+      label  => 'Switch to the next server group',
+      key    => 'TAB',
+   },
+   '=' => {
+      action => \&toggle_aggregate,
+      label  => 'Toggle aggregation',
+   },
+   # TODO: can these be auto-generated from %modes?
+   B => {
+      action => sub { switch_mode('B') },
+      label  => '',
+   },
+   C => {
+      action => sub { switch_mode('C') },
+      label  => '',
+   },
+   D => {
+      action => sub { switch_mode('D') },
+      label  => '',
+   },
+   F => {
+      action => sub { switch_mode('F') },
+      label  => '',
+   },
+   I => {
+      action => sub { switch_mode('I') },
+      label  => '',
+   },
+   L => {
+      action => sub { switch_mode('L') },
+      label  => '',
+   },
+   M => {
+      action => sub { switch_mode('M') },
+      label  => '',
+   },
+   O => {
+      action => sub { switch_mode('O') },
+      label  => '',
+   },
+   Q => {
+      action => sub { switch_mode('Q') },
+      label  => '',
+   },
+   R => {
+      action => sub { switch_mode('R') },
+      label  => '',
+   },
+   S => {
+      action => \&start_S_mode,
+      label  => '',
+   },
+   T => {
+      action => sub { switch_mode('T') },
+      label  => '',
+   },
+   d => {
+      action => sub { get_config_interactive('interval') },
+      label  => 'Change refresh interval',
+   },
+   n => { action => \&next_server,       label => 'Switch to the next connection' },
+   p => { action => \&pause,             label => 'Pause innotop', },
+   q => { action => \&finish,            label => 'Quit innotop', },
+);
+
+# ###########################################################################
+# Sleep times after certain statements {{{3
+# ###########################################################################
+my %stmt_sleep_time_for = ();
+
+# ###########################################################################
+# Config editor key mappings {{{3
+# ###########################################################################
+my %cfg_editor_action = (
+   c => {
+      note => 'Edit columns, etc in the displayed table(s)',
+      func => \&edit_table,
+   },
+   g => {
+      note => 'Edit general configuration',
+      func => \&edit_configuration_variables,
+   },
+   k => {
+      note => 'Edit row-coloring rules',
+      func => \&edit_color_rules,
+   },
+   p => {
+      note => 'Manage plugins',
+      func => \&edit_plugins,
+   },
+   s => {
+      note => 'Edit server groups',
+      func => \&edit_server_groups,
+   },
+   S => {
+      note => 'Edit SQL statement sleep delays',
+      func => \&edit_stmt_sleep_times,
+   },
+   t => {
+      note => 'Choose which table(s) to display in this mode',
+      func => \&choose_mode_tables,
+   },
+);
+
+# ###########################################################################
+# Color editor key mappings {{{3
+# ###########################################################################
+my %color_editor_action = (
+   n => {
+      note => 'Create a new color rule',
+      func => sub {
+         my ( $tbl, $idx ) = @_;
+         my $meta = $tbl_meta{$tbl};
+
+         $clear_screen_sub->();
+         my $col;
+         do {
+            $col = prompt_list(
+               'Choose the target column for the rule',
+               '',
+               sub { return keys %{$meta->{cols}} },
+               { map { $_ => $meta->{cols}->{$_}->{label} } keys %{$meta->{cols}} });
+         } while ( !$col );
+         ( $col ) = grep { $_ } split(/\W+/, $col);
+         return $idx unless $col && exists $meta->{cols}->{$col};
+
+         $clear_screen_sub->();
+         my $op;
+         do {
+            $op = prompt_list(
+               'Choose the comparison operator for the rule',
+               '',
+               sub { return keys %comp_ops },
+               { map { $_ => $comp_ops{$_} } keys %comp_ops } );
+         } until ( $op );
+         $op =~ s/\s+//g;
+         return $idx unless $op && exists $comp_ops{$op};
+
+         my $arg;
+         do {
+            $arg = prompt('Specify an argument for the comparison');
+         } until defined $arg;
+
+         my $color;
+         do {
+            $color = prompt_list(
+               'Choose the color(s) the row should be when the rule matches',
+               '',
+               sub { return keys %ansicolors },
+               { map { $_ => $_ } keys %ansicolors } );
+         } until defined $color;
+         $color = join(' ', unique(grep { exists $ansicolors{$_} } split(/\W+/, $color)));
+         return $idx unless $color;
+
+         push @{$tbl_meta{$tbl}->{colors}}, {
+            col   => $col,
+            op    => $op,
+            arg   => $arg,
+            color => $color
+         };
+         $tbl_meta{$tbl}->{cust}->{colors} = 1;
+
+         return $idx;
+      },
+   },
+   d => {
+      note => 'Remove the selected rule',
+      func => sub {
+         my ( $tbl, $idx ) = @_;
+         my @rules = @{ $tbl_meta{$tbl}->{colors} };
+         return 0 unless @rules > 0 && $idx < @rules && $idx >= 0;
+         splice(@{$tbl_meta{$tbl}->{colors}}, $idx, 1);
+         $tbl_meta{$tbl}->{cust}->{colors} = 1;
+         return $idx == @rules ? $#rules : $idx;
+      },
+   },
+   j => {
+      note => 'Move highlight down one',
+      func => sub {
+         my ( $tbl, $idx ) = @_;
+         my $num_rules = scalar @{$tbl_meta{$tbl}->{colors}};
+         return ($idx + 1) % $num_rules;
+      },
+   },
+   k => {
+      note => 'Move highlight up one',
+      func => sub {
+         my ( $tbl, $idx ) = @_;
+         my $num_rules = scalar @{$tbl_meta{$tbl}->{colors}};
+         return ($idx - 1) % $num_rules;
+      },
+   },
+   '+' => {
+      note => 'Move selected rule up one',
+      func => sub {
+         my ( $tbl, $idx ) = @_;
+         my $meta = $tbl_meta{$tbl};
+         my $dest = $idx == 0 ? scalar(@{$meta->{colors}} - 1) : $idx - 1;
+         my $temp = $meta->{colors}->[$idx];
+         $meta->{colors}->[$idx]  = $meta->{colors}->[$dest];
+         $meta->{colors}->[$dest] = $temp;
+         $meta->{cust}->{colors} = 1;
+         return $dest;
+      },
+   },
+   '-' => {
+      note => 'Move selected rule down one',
+      func => sub {
+         my ( $tbl, $idx ) = @_;
+         my $meta = $tbl_meta{$tbl};
+         my $dest = $idx == scalar(@{$meta->{colors}} - 1) ? 0 : $idx + 1;
+         my $temp = $meta->{colors}->[$idx];
+         $meta->{colors}->[$idx]  = $meta->{colors}->[$dest];
+         $meta->{colors}->[$dest] = $temp;
+         $meta->{cust}->{colors} = 1;
+         return $dest;
+      },
+   },
+);
+
+# ###########################################################################
+# Plugin editor key mappings {{{3
+# ###########################################################################
+my %plugin_editor_action = (
+   '*' => {
+      note => 'Toggle selected plugin active/inactive',
+      func => sub {
+         my ( $plugins, $idx ) = @_;
+         my $plugin = $plugins->[$idx];
+         $plugin->{active} = $plugin->{active} ? 0 : 1;
+         return $idx;
+      },
+   },
+   j => {
+      note => 'Move highlight down one',
+      func => sub {
+         my ( $plugins, $idx ) = @_;
+         return ($idx + 1) % scalar(@$plugins);
+      },
+   },
+   k => {
+      note => 'Move highlight up one',
+      func => sub {
+         my ( $plugins, $idx ) = @_;
+         return $idx == 0 ? @$plugins - 1 : $idx - 1;
+      },
+   },
+);
+
+# ###########################################################################
+# Table editor key mappings {{{3
+# ###########################################################################
+my %tbl_editor_action = (
+   a => {
+      note => 'Add a column to the table',
+      func => sub {
+         my ( $tbl, $col ) = @_;
+         my @visible_cols = @{ $tbl_meta{$tbl}->{visible} };
+         my %all_cols     = %{ $tbl_meta{$tbl}->{cols} };
+         delete @all_cols{@visible_cols};
+         my $choice = prompt_list(
+            'Choose a column',
+            '',
+            sub { return keys %all_cols; },
+            { map { $_ => $all_cols{$_}->{label} || $all_cols{$_}->{hdr} } keys %all_cols });
+         if ( $all_cols{$choice} ) {
+            push @{$tbl_meta{$tbl}->{visible}}, $choice;
+            $tbl_meta{$tbl}->{cust}->{visible} = 1;
+            return $choice;
+         }
+         return $col;
+      },
+   },
+   n => {
+      note => 'Create a new column and add it to the table',
+      func => sub {
+         my ( $tbl, $col ) = @_;
+
+         $clear_screen_sub->();
+         print word_wrap("Choose a name for the column.  This name is not displayed, and is used only "
+               . "for internal reference.  It can contain only lowercase letters, numbers, "
+               . "and underscores.");
+         print "\n\n";
+         do {
+            $col = prompt("Enter column name");
+            $col = '' if $col =~ m/[^a-z0-9_]/;
+         } while ( !$col );
+
+         $clear_screen_sub->();
+         my $hdr;
+         do {
+            $hdr = prompt("Enter column header");
+         } while ( !$hdr );
+
+         $clear_screen_sub->();
+         print "Choose a source for the column's data\n\n";
+         my ( $src, $sub, $err );
+         do {
+            if ( $err ) {
+               print "Error: $err\n\n";
+            }
+            $src = prompt("Enter column source");
+            if ( $src ) {
+               ( $sub, $err ) = compile_expr($src);
+            }
+         } until ( !$err);
+
+         # TODO: this duplicates %col_props.
+         $tbl_meta{$tbl}->{cols}->{$col} = {
+            hdr   => $hdr,
+            src   => $src,
+            just  => '-',
+            num   => 0,
+            label => 'User-defined',
+            user  => 1,
+            tbl   => $tbl,
+            minw  => 0,
+            maxw  => 0,
+            trans => [],
+            func  => $sub,
+            dec   => 0,
+            agg   => 0,
+            aggonly => 0,
+         };
+
+         $tbl_meta{$tbl}->{visible} = [ unique(@{$tbl_meta{$tbl}->{visible}}, $col) ];
+         $tbl_meta{$tbl}->{cust}->{visible} = 1;
+         return $col;
+      },
+   },
+   d => {
+      note => 'Remove selected column',
+      func => sub {
+         my ( $tbl, $col ) = @_;
+         my @visible_cols = @{ $tbl_meta{$tbl}->{visible} };
+         my $idx          = 0;
+         return $col unless @visible_cols > 1;
+         while ( $visible_cols[$idx] ne $col ) {
+            $idx++;
+         }
+         $tbl_meta{$tbl}->{visible} = [ grep { $_ ne $col } @visible_cols ];
+         $tbl_meta{$tbl}->{cust}->{visible} = 1;
+         return $idx == $#visible_cols ? $visible_cols[$idx - 1] : $visible_cols[$idx + 1];
+      },
+   },
+   e => {
+      note => 'Edit selected column',
+      func => sub {
+         # TODO: make this editor hotkey-driven and give readline support.
+         my ( $tbl, $col ) = @_;
+         $clear_screen_sub->();
+         my $meta = $tbl_meta{$tbl}->{cols}->{$col};
+         my @prop = qw(hdr label src just num minw maxw trans agg); # TODO redundant
+
+         my $answer;
+         do {
+            # Do what the user asked...
+            if ( $answer && grep { $_ eq $answer } @prop ) {
+               # Some properties are arrays, others scalars.
+               my $ini = ref $col_props{$answer} ? join(' ', @{$meta->{$answer}}) : $meta->{$answer};
+               my $val = prompt("New value for $answer", undef, $ini);
+               $val = [ split(' ', $val) ] if ref($col_props{$answer});
+               if ( $answer eq 'trans' ) {
+                  $val = [ unique(grep{ exists $trans_funcs{$_} } @$val) ];
+               }
+               @{$meta}{$answer, 'user', 'tbl' } = ( $val, 1, $tbl );
+            }
+
+            my @display_lines = (
+               '',
+               "You are editing column $tbl.$col.\n",
+            );
+
+            push @display_lines, create_table2(
+               \@prop,
+               { map { $_ => $_ } @prop },
+               { map { $_ => ref $meta->{$_} eq 'ARRAY' ? join(' ', @{$meta->{$_}})
+                           : ref $meta->{$_}            ? '[expression code]'
+                           :                              $meta->{$_}
+                     } @prop
+               },
+               { sep => '  ' });
+            draw_screen(\@display_lines, { raw => 1 });
+            print "\n\n"; # One to add space, one to clear readline artifacts
+            $answer = prompt('Edit what? (q to quit)');
+         } while ( $answer ne 'q' );
+
+         return $col;
+      },
+   },
+   j => {
+      note => 'Move highlight down one',
+      func => sub {
+         my ( $tbl, $col ) = @_;
+         my @visible_cols = @{ $tbl_meta{$tbl}->{visible} };
+         my $idx          = 0;
+         while ( $visible_cols[$idx] ne $col ) {
+            $idx++;
+         }
+         return $visible_cols[ ($idx + 1) % @visible_cols ];
+      },
+   },
+   k => {
+      note => 'Move highlight up one',
+      func => sub {
+         my ( $tbl, $col ) = @_;
+         my @visible_cols = @{ $tbl_meta{$tbl}->{visible} };
+         my $idx          = 0;
+         while ( $visible_cols[$idx] ne $col ) {
+            $idx++;
+         }
+         return $visible_cols[ $idx - 1 ];
+      },
+   },
+   '+' => {
+      note => 'Move selected column up one',
+      func => sub {
+         my ( $tbl, $col ) = @_;
+         my $meta         = $tbl_meta{$tbl};
+         my @visible_cols = @{$meta->{visible}};
+         my $idx          = 0;
+         while ( $visible_cols[$idx] ne $col ) {
+            $idx++;
+         }
+         if ( $idx ) {
+            $visible_cols[$idx]     = $visible_cols[$idx - 1];
+            $visible_cols[$idx - 1] = $col;
+            $meta->{visible}        = \@visible_cols;
+         }
+         else {
+            shift @{$meta->{visible}};
+            push @{$meta->{visible}}, $col;
+         }
+         $meta->{cust}->{visible} = 1;
+         return $col;
+      },
+   },
+   '-' => {
+      note => 'Move selected column down one',
+      func => sub {
+         my ( $tbl, $col ) = @_;
+         my $meta         = $tbl_meta{$tbl};
+         my @visible_cols = @{$meta->{visible}};
+         my $idx          = 0;
+         while ( $visible_cols[$idx] ne $col ) {
+            $idx++;
+         }
+         if ( $idx == $#visible_cols ) {
+            unshift @{$meta->{visible}}, $col;
+            pop @{$meta->{visible}};
+         }
+         else {
+            $visible_cols[$idx]     = $visible_cols[$idx + 1];
+            $visible_cols[$idx + 1] = $col;
+            $meta->{visible}        = \@visible_cols;
+         }
+         $meta->{cust}->{visible} = 1;
+         return $col;
+      },
+   },
+   f => {
+      note => 'Choose filters',
+      func => sub {
+         my ( $tbl, $col ) = @_;
+         choose_filters($tbl);
+         return $col;
+      },
+   },
+   o => {
+      note => 'Edit color rules',
+      func => sub {
+         my ( $tbl, $col ) = @_;
+         edit_color_rules($tbl);
+         return $col;
+      },
+   },
+   s => {
+      note => 'Choose sort columns',
+      func => sub {
+         my ( $tbl, $col ) = @_;
+         choose_sort_cols($tbl);
+         return $col;
+      },
+   },
+   g => {
+      note => 'Choose group-by (aggregate) columns',
+      func => sub {
+         my ( $tbl, $col ) = @_;
+         choose_group_cols($tbl);
+         return $col;
+      },
+   },
+);
+
+# ###########################################################################
+# Global variables and environment {{{2
+# ###########################################################################
+
+my @this_term_size; # w_chars, h_chars, w_pix, h_pix
+my @last_term_size; # w_chars, h_chars, w_pix, h_pix
+my $char;
+my $windows       = $OSNAME =~ m/MSWin/;
+my $have_color    = 0;
+my $MAX_ULONG     = 4294967295; # 2^32-1
+my $num_regex     = qr/^[+-]?(?=\d|\.)\d*(?:\.\d+)?(?:E[+-]?\d+|)$/i;
+my $int_regex     = qr/^\d+$/;
+my $bool_regex    = qr/^[01]$/;
+my $term          = undef;
+my $file          = undef; # File to watch for InnoDB monitor output
+my $file_mtime    = undef; # Status of watched file
+my $file_data     = undef; # Last chunk of text read from file
+my $innodb_parser = InnoDBParser->new;
+
+my $nonfatal_errs = join('|',
+   'Access denied for user',
+   'Unknown MySQL server host',
+   'Unknown database',
+   'Can\'t connect to local MySQL server through socket',
+   'Can\'t connect to MySQL server on',
+   'MySQL server has gone away',
+   'Cannot call SHOW INNODB STATUS',
+   'Access denied',
+   'AutoCommit',
+);
+
+if ( !$opts{n} ) {
+   require Term::ReadLine;
+   $term = Term::ReadLine->new('innotop');
+}
+
+# Stores status, variables, innodb status, master/slave status etc.
+# Keyed on connection name.  Each entry is a hashref of current and past data sets,
+# keyed on clock tick.
+my %vars;
+my %info_gotten = (); # Which things have been retrieved for the current clock tick.
+
+# Stores info on currently displayed queries: cxn, connection ID, query text.
+my @current_queries;
+
+my $lines_printed       = 0;
+my $clock               = 0;   # Incremented with every wake-sleep cycle
+my $clearing_deadlocks  = 0;
+
+# If terminal coloring is available, use it.  The only function I want from
+# the module is the colored() function.
+eval {
+   if ( !$opts{n} ) {
+      if ( $windows ) {
+         require Win32::Console::ANSI;
+      }
+      require Term::ANSIColor;
+      import Term::ANSIColor qw(colored);
+      $have_color = 1;
+   }
+};
+if ( $EVAL_ERROR || $opts{n} ) {
+   # If there was an error, manufacture my own colored() function that does no
+   # coloring.
+   *colored = sub { pop @_; @_; };
+}
+
+if ( $opts{n} ) {
+   $clear_screen_sub = sub {};
+}
+elsif ( $windows ) {
+   $clear_screen_sub = sub { $lines_printed = 0; system("cls") };
+}
+else {
+   my $clear = `clear`;
+   $clear_screen_sub = sub { $lines_printed = 0; print $clear };
+}
+
+# ###########################################################################
+# Config storage. {{{2
+# ###########################################################################
+my %config = (
+   color => {
+      val  => $have_color,
+      note => 'Whether to use terminal coloring',
+      conf => 'ALL',
+      pat  => $bool_regex,
+   },
+   cmd_filter => {
+      val  => 'Com_',
+      note => 'Prefix for values in C mode',
+      conf => [qw(C)],
+   },
+   plugin_dir => {
+      val  => "$homepath/.innotop/plugins",
+      note => 'Directory where plugins can be found',
+      conf => 'ALL',
+   },
+   show_percent => {
+      val  => 1,
+      note => 'Show the % symbol after percentages',
+      conf => 'ALL',
+      pat  => $bool_regex,
+   },
+   skip_innodb => {
+      val  => 0,
+      note => 'Disable SHOW INNODB STATUS',
+      conf => 'ALL',
+      pat  => $bool_regex,
+   },
+   S_func => {
+      val  => 's',
+      note => 'What to display in S mode: graph, status, pivoted status',
+      conf => [qw(S)],
+      pat  => qr/^[gsv]$/,
+   },
+   cxn_timeout => {
+      val  => 28800,
+      note => 'Connection timeout for keeping unused connections alive',
+      conf => 'ALL',
+      pat  => $int_regex,
+   },
+   graph_char => {
+      val  => '*',
+      note => 'Character for drawing graphs',
+      conf => [ qw(S) ],
+      pat  => qr/^.$/,
+   },
+   show_cxn_errors_in_tbl => {
+      val  => 1,
+      note => 'Whether to display connection errors as rows in the table',
+      conf => 'ALL',
+      pat  => $bool_regex,
+   },
+   hide_hdr => {
+      val  => 0,
+      note => 'Whether to show column headers',
+      conf => 'ALL',
+      pat  => $bool_regex,
+   },
+   show_cxn_errors => {
+      val  => 1,
+      note => 'Whether to print connection errors to STDOUT',
+      conf => 'ALL',
+      pat  => $bool_regex,
+   },
+   readonly => {
+      val  => 1,
+      note => 'Whether the config file is read-only',
+      conf => [ qw() ],
+      pat  => $bool_regex,
+   },
+   global => {
+      val  => 1,
+      note => 'Whether to show GLOBAL variables and status',
+      conf => 'ALL',
+      pat  => $bool_regex,
+   },
+   header_highlight => {
+      val  => 'bold',
+      note => 'How to highlight table column headers',
+      conf => 'ALL',
+      pat  => qr/^(?:bold|underline)$/,
+   },
+   display_table_captions => {
+      val  => 1,
+      note => 'Whether to put captions on tables',
+      conf => 'ALL',
+      pat  => $bool_regex,
+   },
+   charset => {
+      val  => 'ascii',
+      note => 'What type of characters should be displayed in queries (ascii, unicode, none)',
+      conf => 'ALL',
+      pat  => qr/^(?:ascii|unicode|none)$/,
+   },
+   auto_wipe_dl => {
+      val  => 0,
+      note => 'Whether to auto-wipe InnoDB deadlocks',
+      conf => 'ALL',
+      pat  => $bool_regex,
+   },
+   max_height => {
+      val  => 30,
+      note => '[Win32] Max window height',
+      conf => 'ALL',
+   },
+   debug => {
+      val  => 0,
+      pat  => $bool_regex,
+      note => 'Debug mode (more verbose errors, uses more memory)',
+      conf => 'ALL',
+   },
+   num_digits => {
+      val  => 2,
+      pat  => $int_regex,
+      note => 'How many digits to show in fractional numbers and percents',
+      conf => 'ALL',
+   },
+   debugfile => {
+      val  => "$homepath/.innotop/core_dump",
+      note => 'A debug file in case you are interested in error output',
+   },
+   show_statusbar => {
+      val  => 1,
+      pat  => $bool_regex,
+      note => 'Whether to show the status bar in the display',
+      conf => 'ALL',
+   },
+   mode => {
+      val  => "Q",
+      note => "Which mode to start in",
+      cmdline => 1,
+   },
+   status_inc => {
+      val  => 0,
+      note => 'Whether to show raw or incremental values for status variables',
+      pat  => $bool_regex,
+   },
+   interval => {
+      val  => 10,
+      pat  => qr/^(?:(?:\d*?[1-9]\d*(?:\.\d*)?)|(?:\d*\.\d*?[1-9]\d*))$/,
+      note => "The interval at which the display will be refreshed.  Fractional values allowed.",
+   },
+   num_status_sets => {
+      val  => 9,
+      pat  => $int_regex,
+      note => 'How many sets of STATUS and VARIABLES values to show',
+      conf => [ qw(S) ],
+   },
+   S_set => {
+      val  => 'general',
+      pat  => qr/^\w+$/,
+      note => 'Which set of variables to display in S (Variables & Status) mode',
+      conf => [ qw(S) ],
+   },
+);
+
+# ###########################################################################
+# Config file sections {{{2
+# The configuration file is broken up into sections like a .ini file.  This
+# variable defines those sections and the subroutines responsible for reading
+# and writing them.
+# ###########################################################################
+my %config_file_sections = (
+   plugins => {
+      reader => \&load_config_plugins,
+      writer => \&save_config_plugins,
+   },
+   group_by => {
+      reader => \&load_config_group_by,
+      writer => \&save_config_group_by,
+   },
+   filters => {
+      reader => \&load_config_filters,
+      writer => \&save_config_filters,
+   },
+   active_filters => {
+      reader => \&load_config_active_filters,
+      writer => \&save_config_active_filters,
+   },
+   visible_tables => {
+      reader => \&load_config_visible_tables,
+      writer => \&save_config_visible_tables,
+   },
+   sort_cols => {
+      reader => \&load_config_sort_cols,
+      writer => \&save_config_sort_cols,
+   },
+   active_columns => {
+      reader => \&load_config_active_columns,
+      writer => \&save_config_active_columns,
+   },
+   tbl_meta => {
+      reader => \&load_config_tbl_meta,
+      writer => \&save_config_tbl_meta,
+   },
+   general => {
+      reader => \&load_config_config,
+      writer => \&save_config_config,
+   },
+   connections => {
+      reader => \&load_config_connections,
+      writer => \&save_config_connections,
+   },
+   active_connections => {
+      reader => \&load_config_active_connections,
+      writer => \&save_config_active_connections,
+   },
+   server_groups => {
+      reader => \&load_config_server_groups,
+      writer => \&save_config_server_groups,
+   },
+   active_server_groups => {
+      reader => \&load_config_active_server_groups,
+      writer => \&save_config_active_server_groups,
+   },
+   max_values_seen => {
+      reader => \&load_config_mvs,
+      writer => \&save_config_mvs,
+   },
+   varsets => {
+      reader => \&load_config_varsets,
+      writer => \&save_config_varsets,
+   },
+   colors => {
+      reader => \&load_config_colors,
+      writer => \&save_config_colors,
+   },
+   stmt_sleep_times => {
+      reader => \&load_config_stmt_sleep_times,
+      writer => \&save_config_stmt_sleep_times,
+   },
+);
+
+# Config file sections have some dependencies, so they have to be read/written in order.
+my @ordered_config_file_sections = qw(general plugins filters active_filters tbl_meta
+   connections active_connections server_groups active_server_groups max_values_seen
+   active_columns sort_cols visible_tables varsets colors stmt_sleep_times
+   group_by);
+
+# All events for which plugins may register themselves.  Entries are arrayrefs.
+my %event_listener_for = map { $_ => [] }
+   qw(
+      extract_values
+      set_to_tbl_pre_filter set_to_tbl_pre_sort set_to_tbl_pre_group
+      set_to_tbl_pre_colorize set_to_tbl_pre_transform set_to_tbl_pre_pivot
+      set_to_tbl_pre_create set_to_tbl_post_create
+      draw_screen
+   );
+
+# All variables to which plugins have access.
+my %pluggable_vars = (
+   action_for    => \%action_for,
+   agg_funcs     => \%agg_funcs,
+   config        => \%config,
+   connections   => \%connections,
+   dbhs          => \%dbhs,
+   filters       => \%filters,
+   modes         => \%modes,
+   server_groups => \%server_groups,
+   tbl_meta      => \%tbl_meta,
+   trans_funcs   => \%trans_funcs,
+   var_sets      => \%var_sets,
+);
+
+# ###########################################################################
+# Contains logic to generate prepared statements for a given function for a
+# given DB connection.  Returns a $sth.
+# ###########################################################################
+my %stmt_maker_for = (
+   INNODB_STATUS => sub {
+      my ( $dbh ) = @_;
+      return $dbh->prepare(version_ge( $dbh, '5.0.0' )
+             ? 'SHOW ENGINE INNODB STATUS'
+             : 'SHOW INNODB STATUS');
+   },
+   SHOW_VARIABLES => sub {
+      my ( $dbh ) = @_;
+      return $dbh->prepare($config{global}->{val} && version_ge( $dbh, '4.0.3' )
+             ? 'SHOW GLOBAL VARIABLES'
+             : 'SHOW VARIABLES');
+   },
+   SHOW_STATUS => sub {
+      my ( $dbh ) = @_;
+      return $dbh->prepare($config{global}->{val} && version_ge( $dbh, '5.0.2' )
+             ? 'SHOW GLOBAL STATUS'
+             : 'SHOW STATUS');
+   },
+   KILL_QUERY => sub {
+      my ( $dbh ) = @_;
+      return $dbh->prepare(version_ge( $dbh, '5.0.0' )
+             ? 'KILL QUERY ?'
+             : 'KILL ?');
+   },
+   SHOW_MASTER_LOGS => sub {
+      my ( $dbh ) = @_;
+      return $dbh->prepare('SHOW MASTER LOGS');
+   },
+   SHOW_MASTER_STATUS => sub {
+      my ( $dbh ) = @_;
+      return $dbh->prepare('SHOW MASTER STATUS');
+   },
+   SHOW_SLAVE_STATUS => sub {
+      my ( $dbh ) = @_;
+      return $dbh->prepare('SHOW SLAVE STATUS');
+   },
+   KILL_CONNECTION => sub {
+      my ( $dbh ) = @_;
+      return $dbh->prepare(version_ge( $dbh, '5.0.0' )
+             ? 'KILL CONNECTION ?'
+             : 'KILL ?');
+   },
+   OPEN_TABLES => sub {
+      my ( $dbh ) = @_;
+      return version_ge($dbh, '4.0.0')
+         ? $dbh->prepare('SHOW OPEN TABLES')
+         : undef;
+   },
+   PROCESSLIST => sub {
+      my ( $dbh ) = @_;
+      return $dbh->prepare('SHOW FULL PROCESSLIST');
+   },
+);
+
+# Plugins!
+my %plugins = (
+);
+
+# ###########################################################################
+# Run the program {{{1
+# ###########################################################################
+
+# This config variable is only useful for MS Windows because its terminal
+# can't tell how tall it is.
+if ( !$windows ) {
+   delete $config{max_height};
+}
+
+# Try to lower my priority.
+eval { setpriority(0, 0, getpriority(0, 0) + 10); };
+
+# Print stuff to the screen immediately, don't wait for a newline.
+$OUTPUT_AUTOFLUSH = 1;
+
+# Clear the screen and load the configuration.
+$clear_screen_sub->();
+load_config();
+
+# Override config variables with command-line options
+my %cmdline =
+   map  { $_->{c} => $opts{$_->{k}} }
+   grep { exists $_->{c} && exists $opts{$_->{k}} }
+   @opt_spec;
+
+foreach my $name (keys %cmdline) {
+   next if not defined $cmdline{$name};
+   my $val = $cmdline{$name};
+   if ( exists($config{$name}) and (!$config{$name}->{pat} or $val =~ m/$config{$name}->{pat}/ )) {
+      $config{$name}->{val} = $val;
+   }
+}
+
+post_process_tbl_meta();
+
+# Make sure no changes are written to config file in non-interactive mode.
+if ( $opts{n} ) {
+   $config{readonly}->{val} = 1;
+}
+
+eval {
+
+   # Open the file for InnoDB status
+   if ( @ARGV ) {
+      my $filename = shift @ARGV;
+      open $file, "<", $filename
+         or die "Cannot open '$filename': $OS_ERROR";
+   }
+
+   # In certain modes we might have to collect data for two cycles
+   # before printing anything out, so we need to bump up the count one.
+   if ( $opts{n} && $opts{count} && $config{status_inc}->{val}
+      && $config{mode}->{val} =~ m/[S]/ )
+   {
+      $opts{count}++;
+   }
+
+   while (++$clock) {
+
+      my $mode = $config{mode}->{val} || 'Q';
+      if ( !$modes{$mode} ) {
+         die "Mode '$mode' doesn't exist; try one of these:\n"
+            . join("\n", map { "  $_ $modes{$_}->{hdr}" }  sort keys %modes)
+            . "\n";
+      }
+
+      if ( !$opts{n} ) {
+         @last_term_size = @this_term_size;
+         @this_term_size = Term::ReadKey::GetTerminalSize(\*STDOUT);
+         if ( $windows ) {
+            $this_term_size[0]--;
+            $this_term_size[1]
+               = min($this_term_size[1], $config{max_height}->{val});
+         }
+         die("Can't read terminal size") unless @this_term_size;
+      }
+
+      # If there's no connection to a database server, we need to fix that...
+      if ( !%connections ) {
+         print "You have not defined any database connections.\n\n";
+         add_new_dsn();
+      }
+
+      # See whether there are any connections defined for this mode.  If there's only one
+      # connection total, assume the user wants to just use innotop for a single server
+      # and don't ask which server to connect to.  Also, if we're monitoring from a file,
+      # we just use the first connection.
+      if ( !get_connections() ) {
+         if ( $file || 1 == scalar keys %connections ) {
+            $modes{$config{mode}->{val}}->{connections} = [ keys %connections ];
+         }
+         else {
+            choose_connections();
+         }
+      }
+
+      # Term::ReadLine might have re-set $OUTPUT_AUTOFLUSH.
+      $OUTPUT_AUTOFLUSH = 1;
+
+      # Prune old data
+      my $sets = $config{num_status_sets}->{val};
+      foreach my $store ( values %vars ) {
+         delete @{$store}{ grep { $_ < $clock - $sets } keys %$store };
+      }
+      %info_gotten = ();
+
+      # Call the subroutine to display this mode.
+      $modes{$mode}->{display_sub}->();
+
+      # It may be time to quit now.
+      if ( $opts{count} && $clock >= $opts{count} ) {
+         finish();
+      }
+
+      # Wait for a bit.
+      if ( $opts{n} ) {
+         sleep($config{interval}->{val});
+      }
+      else {
+         ReadMode('cbreak');
+         $char = ReadKey($config{interval}->{val});
+         ReadMode('normal');
+      }
+
+      # Handle whatever action the key indicates.
+      do_key_action();
+
+   }
+};
+if ( $EVAL_ERROR ) {
+   core_dump( $EVAL_ERROR );
+}
+finish();
+
+# Subroutines {{{1
+# Mode functions{{{2
+# switch_mode {{{3
+sub switch_mode {
+   my $mode = shift;
+   $config{mode}->{val} = $mode;
+}
+
+# Prompting functions {{{2
+# prompt_list {{{3
+# Prompts the user for a value, given a question, initial value,
+# a completion function and a hashref of hints.
+sub prompt_list {
+   die "Can't call in non-interactive mode" if $opts{n};
+   my ( $question, $init, $completion, $hints ) = @_;
+   if ( $hints ) {
+      # Figure out how wide the table will be
+      my $max_name = max(map { length($_) } keys %$hints );
+      $max_name ||= 0;
+      $max_name +=  3;
+      my @meta_rows = create_table2(
+               [ sort keys %$hints ],
+               { map { $_ => $_ } keys %$hints },
+               { map { $_ => trunc($hints->{$_}, $this_term_size[0] - $max_name) } keys %$hints },
+               { sep => '  ' });
+      if (@meta_rows > 10) {
+         # Try to split and stack the meta rows next to each other
+         my $split = int(@meta_rows / 2);
+         @meta_rows = stack_next(
+            [@meta_rows[0..$split - 1]],
+            [@meta_rows[$split..$#meta_rows]],
+            { pad => ' | '},
+         );
+      }
+      print join( "\n",
+         '',
+         map { ref $_ ? colored(@$_) : $_ } create_caption('Choose from', @meta_rows), ''),
+         "\n";
+   }
+   $term->Attribs->{completion_function} = $completion;
+   my $answer = $term->readline("$question: ", $init);
+   $OUTPUT_AUTOFLUSH = 1;
+   $answer = '' if !defined($answer);
+   $answer =~ s/\s+$//;
+   return $answer;
+}
+
+# prompt {{{3
+# Prints out a prompt and reads from the keyboard, then validates with the
+# validation regex until the input is correct.
+sub prompt {
+   die "Can't call in non-interactive mode" if $opts{n};
+   my ( $prompt, $regex, $init, $completion ) = @_;
+   my $response;
+   my $success = 0;
+   do {
+      if ( $completion ) {
+         $term->Attribs->{completion_function} = $completion;
+      }
+      $response = $term->readline("$prompt: ", $init);
+      if ( $regex && $response !~ m/$regex/ ) {
+         print "Invalid response.\n\n";
+      }
+      else {
+         $success = 1;
+      }
+   } while ( !$success );
+   $OUTPUT_AUTOFLUSH = 1;
+   $response =~ s/\s+$//;
+   return $response;
+}
+
+# prompt_noecho {{{3
+# Unfortunately, suppressing echo with Term::ReadLine isn't reliable; the user might not
+# have that library, or it might not support that feature.
+sub prompt_noecho {
+   my ( $prompt ) = @_;
+   print colored("$prompt: ", 'underline');
+   my $response;
+   ReadMode('noecho');
+   $response = <STDIN>;
+   chomp($response);
+   ReadMode('normal');
+   return $response;
+}
+
+# do_key_action {{{3
+# Depending on whether a key was read, do something.  Keys have certain
+# actions defined in lookup tables.  Each mode may have its own lookup table,
+# which trumps the global table -- so keys can be context-sensitive.  The key
+# may be read and written in a subroutine, so it's a global.
+sub do_key_action {
+   if ( defined $char ) {
+      my $mode = $config{mode}->{val};
+      my $action
+         = defined($modes{$mode}->{action_for}->{$char})
+         ? $modes{$mode}->{action_for}->{$char}->{action}
+         : defined($action_for{$char})
+         ? $action_for{$char}->{action}
+         : sub{};
+      $action->();
+   }
+}
+
+# pause {{{3
+sub pause {
+   die "Can't call in non-interactive mode" if $opts{n};
+   my $msg = shift;
+   print defined($msg) ? "\n$msg" : "\nPress any key to continue";
+   ReadMode('cbreak');
+   my $char = ReadKey(0);
+   ReadMode('normal');
+   return $char;
+}
+
+# reverse_sort {{{3
+sub reverse_sort {
+   my $tbl = shift;
+   $tbl_meta{$tbl}->{sort_dir} *= -1;
+}
+
+# select_cxn {{{3
+# Selects connection(s).  If the mode (or argument list) has only one, returns
+# it without prompt.
+sub select_cxn {
+   my ( $prompt, @cxns ) = @_;
+   if ( !@cxns ) {
+      @cxns = get_connections();
+   }
+   if ( @cxns == 1 ) {
+      return $cxns[0];
+   }
+   my $choices = prompt_list(
+         $prompt,
+         $cxns[0],
+         sub{ return @cxns },
+         { map { $_ => $connections{$_}->{dsn} } @cxns });
+   my @result = unique(grep { my $a = $_; grep { $_ eq $a } @cxns } split(/\s+/, $choices));
+   return @result;
+}
+
+# kill_query {{{3
+# Kills a connection, or on new versions, optionally a query but not connection.
+sub kill_query {
+   my ( $q_or_c ) = @_;
+
+   my $info = choose_thread(
+      sub { 1 },
+      'Select a thread to kill the ' . $q_or_c,
+   );
+   return unless $info;
+   return unless pause("Kill $info->{id}?") =~ m/y/i;
+
+   eval {
+      do_stmt($info->{cxn}, $q_or_c eq 'QUERY' ? 'KILL_QUERY' : 'KILL_CONNECTION', $info->{id} );
+   };
+
+   if ( $EVAL_ERROR ) {
+      print "\nError: $EVAL_ERROR";
+      pause();
+   }
+}
+
+# set_display_precision {{{3
+sub set_display_precision {
+   my $dir = shift;
+   $config{num_digits}->{val} = min(9, max(0, $config{num_digits}->{val} + $dir));
+}
+
+sub toggle_visible_table {
+   my ( $mode, $table ) = @_;
+   my $visible = $modes{$mode}->{visible_tables};
+   if ( grep { $_ eq $table } @$visible ) {
+      $modes{$mode}->{visible_tables} = [ grep { $_ ne $table } @$visible ];
+   }
+   else {
+      unshift @$visible, $table;
+   }
+   $modes{$mode}->{cust}->{visible_tables} = 1;
+}
+
+# toggle_filter{{{3
+sub toggle_filter {
+   my ( $tbl, $filter ) = @_;
+   my $filters = $tbl_meta{$tbl}->{filters};
+   if ( grep { $_ eq $filter } @$filters ) {
+      $tbl_meta{$tbl}->{filters} = [ grep { $_ ne $filter } @$filters ];
+   }
+   else {
+      push @$filters, $filter;
+   }
+   $tbl_meta{$tbl}->{cust}->{filters} = 1;
+}
+
+# toggle_config {{{3
+sub toggle_config {
+   my ( $key ) = @_;
+   $config{$key}->{val} ^= 1;
+}
+
+# create_deadlock {{{3
+sub create_deadlock {
+   $clear_screen_sub->();
+
+   print "This function will deliberately cause a small deadlock, "
+      . "clearing deadlock information from the InnoDB monitor.\n\n";
+
+   my $answer = prompt("Are you sure you want to proceed?  Say 'y' if you do");
+   return 0 unless $answer eq 'y';
+
+   my ( $cxn ) = select_cxn('Clear on which server? ');
+   return unless $cxn && exists($connections{$cxn});
+
+   clear_deadlock($cxn);
+}
+
+# deadlock_thread {{{3
+sub deadlock_thread {
+   my ( $id, $tbl, $cxn ) = @_;
+
+   eval {
+      my $dbh = get_new_db_connection($cxn, 1);
+      my @stmts = (
+         "set transaction isolation level serializable",
+         (version_ge($dbh, '4.0.11') ? "start transaction" : 'begin'),
+         "select * from $tbl where a = $id",
+         "update $tbl set a = $id where a <> $id",
+      );
+
+      foreach my $stmt (@stmts[0..2]) {
+         $dbh->do($stmt);
+      }
+      sleep(1 + $id);
+      $dbh->do($stmts[-1]);
+   };
+   if ( $EVAL_ERROR ) {
+      if ( $EVAL_ERROR !~ m/Deadlock found/ ) {
+         die $EVAL_ERROR;
+      }
+   }
+   exit(0);
+}
+
+# Purges unused binlogs on the master, up to but not including the latest log.
+# TODO: guess which connections are slaves of a given master.
+sub purge_master_logs {
+   my @cxns = get_connections();
+
+   get_master_slave_status(@cxns);
+
+   # Toss out the rows that don't have master/slave status...
+   my @vars =
+      grep { $_ && ($_->{file} || $_->{master_host}) }
+      map  { $vars{$_}->{$clock} } @cxns;
+   @cxns = map { $_->{cxn} } @vars;
+
+   # Figure out which master to purge ons.
+   my @masters = map { $_->{cxn} } grep { $_->{file} } @vars;
+   my ( $master ) = select_cxn('Which master?', @masters );
+   return unless $master;
+   my ($master_status) = grep { $_->{cxn} eq $master } @vars;
+
+   # Figure out the result order (not lexical order) of master logs.
+   my @master_logs = get_master_logs($master);
+   my $i = 0;
+   my %master_logs = map { $_->{log_name} => $i++ } @master_logs;
+
+   # Ask which slave(s) are reading from this master.
+   my @slave_status = grep { $_->{master_host} } @vars;
+   my @slaves = map { $_->{cxn} } @slave_status;
+   @slaves = select_cxn("Which slaves are reading from $master?", @slaves);
+   @slave_status = grep { my $item = $_; grep { $item->{cxn} eq $_ } @slaves } @slave_status;
+   return unless @slave_status;
+
+   # Find the minimum binary log in use.
+   my $min_log = min(map { $master_logs{$_->{master_log_file}} } @slave_status);
+   my $log_name = $master_logs[$min_log]->{log_name};
+
+   my $stmt = "PURGE MASTER LOGS TO '$log_name'";
+   send_cmd_to_servers($stmt, 0, 'PURGE {MASTER | BINARY} LOGS {TO "log_name" | BEFORE "date"}', [$master]);
+}
+
+sub send_cmd_to_servers {
+   my ( $cmd, $all, $hint, $cxns ) = @_;
+   if ( $all ) {
+      @$cxns = get_connections();
+   }
+   elsif ( !@$cxns ) {
+      @$cxns = select_cxn('Which servers?', @$cxns);
+   }
+   if ( $hint ) {
+      print "\nHint: $hint\n";
+   }
+   $cmd = prompt('Command to send', undef, $cmd);
+   foreach my $cxn ( @$cxns ) {
+      eval {
+         my $sth = do_query($cxn, $cmd);
+      };
+      if ( $EVAL_ERROR ) {
+         print "Error from $cxn: $EVAL_ERROR\n";
+      }
+      else {
+         print "Success on $cxn\n";
+      }
+   }
+   pause();
+}
+
+# Display functions {{{2
+
+sub set_s_mode {
+   my ( $func ) = @_;
+   $clear_screen_sub->();
+   $config{S_func}->{val} = $func;
+}
+
+# start_S_mode {{{3
+sub start_S_mode {
+   $clear_screen_sub->();
+   switch_mode('S');
+}
+
+# display_B {{{3
+sub display_B {
+   my @display_lines;
+   my @cxns = get_connections();
+   get_innodb_status(\@cxns);
+
+   my @buffer_pool;
+   my @page_statistics;
+   my @insert_buffers;
+   my @adaptive_hash_index;
+   my %rows_for = (
+      buffer_pool         => \@buffer_pool,
+      page_statistics     => \@page_statistics,
+      insert_buffers      => \@insert_buffers,
+      adaptive_hash_index => \@adaptive_hash_index,
+   );
+
+   my @visible = get_visible_tables();
+   my %wanted  = map { $_ => 1 } @visible;
+
+   foreach my $cxn ( @cxns ) {
+      my $set = $vars{$cxn}->{$clock};
+      my $pre = $vars{$cxn}->{$clock-1} || $set;
+
+      if ( $set->{IB_bp_complete} ) {
+         if ( $wanted{buffer_pool} ) {
+            push @buffer_pool, extract_values($set, $set, $pre, 'buffer_pool');
+         }
+         if ( $wanted{page_statistics} ) {
+            push @page_statistics, extract_values($set, $set, $pre, 'page_statistics');
+         }
+      }
+      if ( $set->{IB_ib_complete} ) {
+         if ( $wanted{insert_buffers} ) {
+            push @insert_buffers, extract_values(
+               $config{status_inc}->{val} ? inc(0, $cxn) : $set, $set, $pre,
+               'insert_buffers');
+         }
+         if ( $wanted{adaptive_hash_index} ) {
+            push @adaptive_hash_index, extract_values($set, $set, $pre, 'adaptive_hash_index');
+         }
+      }
+   }
+
+   my $first_table = 0;
+   foreach my $tbl ( @visible ) {
+      push @display_lines, '', set_to_tbl($rows_for{$tbl}, $tbl);
+      push @display_lines, get_cxn_errors(@cxns)
+         if ( $config{debug}->{val} || !$first_table++ );
+   }
+
+   draw_screen(\@display_lines);
+}
+
+# display_C {{{3
+sub display_C {
+   my @display_lines;
+   my @cxns = get_connections();
+   get_status_info(@cxns);
+
+   my @cmd_summary;
+   my %rows_for = (
+      cmd_summary => \@cmd_summary,
+   );
+
+   my @visible = get_visible_tables();
+   my %wanted  = map { $_ => 1 } @visible;
+
+   # For now, I'm manually pulling these variables out and pivoting.  Eventually a SQL-ish
+   # dialect should let me join a table to a grouped and pivoted table and do this more easily.
+   # TODO: make it so.
+   my $prefix = qr/^$config{cmd_filter}->{val}/; # TODO: this is a total hack
+   my @values;
+   my ($total, $last_total) = (0, 0);
+   foreach my $cxn ( @cxns ) {
+      my $set = $vars{$cxn}->{$clock};
+      my $pre = $vars{$cxn}->{$clock-1} || $set;
+      foreach my $key ( keys %$set ) {
+         next unless $key =~ m/$prefix/i;
+         my $val = $set->{$key};
+         next unless defined $val && $val =~ m/^\d+$/;
+         my $last_val = $val - ($pre->{$key} || 0);
+         $total      += $val;
+         $last_total += $last_val;
+         push @values, {
+            name       => $key,
+            value      => $val,
+            last_value => $last_val,
+         };
+      }
+   }
+
+   # Add aggregation and turn into a real set TODO: total hack
+   if ( $wanted{cmd_summary} ) {
+      foreach my $value ( @values ) {
+         @{$value}{qw(total last_total)} = ($total, $last_total);
+         push @cmd_summary, extract_values($value, $value, $value, 'cmd_summary');
+      }
+   }
+
+   my $first_table = 0;
+   foreach my $tbl ( @visible ) {
+      push @display_lines, '', set_to_tbl($rows_for{$tbl}, $tbl);
+      push @display_lines, get_cxn_errors(@cxns)
+         if ( $config{debug}->{val} || !$first_table++ );
+   }
+
+   draw_screen(\@display_lines);
+}
+
+# display_D {{{3
+sub display_D {
+   my @display_lines;
+   my @cxns = get_connections();
+   get_innodb_status(\@cxns);
+
+   my @deadlock_transactions;
+   my @deadlock_locks;
+   my %rows_for = (
+      deadlock_transactions => \@deadlock_transactions,
+      deadlock_locks        => \@deadlock_locks,
+   );
+
+   my @visible = get_visible_tables();
+   my %wanted  = map { $_ => 1 } @visible;
+
+   foreach my $cxn ( @cxns ) {
+      my $innodb_status = $vars{$cxn}->{$clock};
+      my $prev_status   = $vars{$cxn}->{$clock-1} || $innodb_status;
+
+      if ( $innodb_status->{IB_dl_timestring} ) {
+
+         my $victim = $innodb_status->{IB_dl_rolled_back} || 0;
+
+         if ( %wanted ) {
+            foreach my $txn_id ( keys %{$innodb_status->{IB_dl_txns}} ) {
+               my $txn = $innodb_status->{IB_dl_txns}->{$txn_id};
+               my $pre = $prev_status->{IB_dl_txns}->{$txn_id} || $txn;
+
+               if ( $wanted{deadlock_transactions} ) {
+                  my $hash = extract_values($txn->{tx}, $txn->{tx}, $pre->{tx}, 'deadlock_transactions');
+                  $hash->{cxn}        = $cxn;
+                  $hash->{dl_txn_num} = $txn_id;
+                  $hash->{victim}     = $txn_id == $victim ? 'Yes' : 'No';
+                  $hash->{timestring} = $innodb_status->{IB_dl_timestring};
+                  $hash->{truncates}  = $innodb_status->{IB_dl_complete} ? 'No' : 'Yes';
+                  push @deadlock_transactions, $hash;
+               }
+
+               if ( $wanted{deadlock_locks} ) {
+                  foreach my $lock ( @{$txn->{locks}} ) {
+                     my $hash = extract_values($lock, $lock, $lock, 'deadlock_locks');
+                     $hash->{dl_txn_num}      = $txn_id;
+                     $hash->{cxn}             = $cxn;
+                     $hash->{mysql_thread_id} = $txn->{tx}->{mysql_thread_id};
+                     push @deadlock_locks, $hash;
+                  }
+               }
+
+            }
+         }
+      }
+   }
+
+   my $first_table = 0;
+   foreach my $tbl ( @visible ) {
+      push @display_lines, '', set_to_tbl($rows_for{$tbl}, $tbl);
+      push @display_lines, get_cxn_errors(@cxns)
+         if ( $config{debug}->{val} || !$first_table++ );
+   }
+
+   draw_screen(\@display_lines);
+}
+
+# display_F {{{3
+sub display_F {
+   my @display_lines;
+   my ( $cxn ) = get_connections();
+   get_innodb_status([$cxn]);
+   my $innodb_status = $vars{$cxn}->{$clock};
+
+   if ( $innodb_status->{IB_fk_timestring} ) {
+
+      push @display_lines, 'Reason: ' . $innodb_status->{IB_fk_reason};
+
+      # Display FK errors caused by invalid DML.
+      if ( $innodb_status->{IB_fk_txn} ) {
+         my $txn = $innodb_status->{IB_fk_txn};
+         push @display_lines,
+            '',
+            "User $txn->{user} from $txn->{hostname}, thread $txn->{mysql_thread_id} was executing:",
+            '', no_ctrl_char($txn->{query_text});
+      }
+
+      my @fk_table = create_table2(
+         $tbl_meta{fk_error}->{visible},
+         meta_to_hdr('fk_error'),
+         extract_values($innodb_status, $innodb_status, $innodb_status, 'fk_error'),
+         { just => '-', sep => '  '});
+      push @display_lines, '', @fk_table;
+
+   }
+   else {
+      push @display_lines, '', 'No foreign key error data.';
+   }
+   draw_screen(\@display_lines, { raw => 1 } );
+}
+
+# display_I {{{3
+sub display_I {
+   my @display_lines;
+   my @cxns = get_connections();
+   get_innodb_status(\@cxns);
+
+   my @io_threads;
+   my @pending_io;
+   my @file_io_misc;
+   my @log_statistics;
+   my %rows_for = (
+      io_threads     => \@io_threads,
+      pending_io     => \@pending_io,
+      file_io_misc   => \@file_io_misc,
+      log_statistics => \@log_statistics,
+   );
+
+   my @visible = get_visible_tables();
+   my %wanted  = map { $_ => 1 } @visible;
+
+   foreach my $cxn ( @cxns ) {
+      my $set = $vars{$cxn}->{$clock};
+      my $pre = $vars{$cxn}->{$clock-1} || $set;
+
+      if ( $set->{IB_io_complete} ) {
+         if ( $wanted{io_threads} ) {
+            my $cur_threads = $set->{IB_io_threads};
+            my $pre_threads = $pre->{IB_io_threads} || $cur_threads;
+            foreach my $key ( sort keys %$cur_threads ) {
+               my $cur_thd = $cur_threads->{$key};
+               my $pre_thd = $pre_threads->{$key} || $cur_thd;
+               my $hash = extract_values($cur_thd, $cur_thd, $pre_thd, 'io_threads');
+               $hash->{cxn} = $cxn;
+               push @io_threads, $hash;
+            }
+         }
+         if ( $wanted{pending_io} ) {
+            push @pending_io, extract_values($set, $set, $pre, 'pending_io');
+         }
+         if ( $wanted{file_io_misc} ) {
+            push @file_io_misc, extract_values(
+               $config{status_inc}->{val} ? inc(0, $cxn) : $set,
+               $set, $pre, 'file_io_misc');
+         }
+      }
+      if ( $set->{IB_lg_complete} && $wanted{log_statistics} ) {
+         push @log_statistics, extract_values($set, $set, $pre, 'log_statistics');
+      }
+   }
+
+   my $first_table = 0;
+   foreach my $tbl ( @visible ) {
+      push @display_lines, '', set_to_tbl($rows_for{$tbl}, $tbl);
+      push @display_lines, get_cxn_errors(@cxns)
+         if ( $config{debug}->{val} || !$first_table++ );
+   }
+
+   draw_screen(\@display_lines);
+}
+
+# display_L {{{3
+sub display_L {
+   my @display_lines;
+   my @cxns = get_connections();
+   get_innodb_status(\@cxns);
+
+   my @innodb_locks;
+   my %rows_for = (
+      innodb_locks => \@innodb_locks,
+   );
+
+   my @visible = get_visible_tables();
+   my %wanted  = map { $_ => 1 } @visible;
+
+   # Get info on locks
+   foreach my $cxn ( @cxns ) {
+      my $set = $vars{$cxn}->{$clock} or next;
+      my $pre = $vars{$cxn}->{$clock-1} || $set;
+
+      if ( $wanted{innodb_locks} && defined $set->{IB_tx_transactions} && @{$set->{IB_tx_transactions}} ) {
+
+         my $cur_txns = $set->{IB_tx_transactions};
+         my $pre_txns = $pre->{IB_tx_transactions} || $cur_txns;
+         my %cur_txns = map { $_->{mysql_thread_id} => $_ } @$cur_txns;
+         my %pre_txns = map { $_->{mysql_thread_id} => $_ } @$pre_txns;
+         foreach my $txn ( @$cur_txns ) {
+            foreach my $lock ( @{$txn->{locks}} ) {
+               my %hash = map { $_ => $txn->{$_} } qw(txn_id mysql_thread_id lock_wait_time active_secs);
+               map { $hash{$_} = $lock->{$_} } qw(lock_type space_id page_no n_bits index db table txn_id lock_mode special insert_intention waiting);
+               $hash{cxn} = $cxn;
+               push @innodb_locks, extract_values(\%hash, \%hash, \%hash, 'innodb_locks');
+            }
+         }
+      }
+   }
+
+   my $first_table = 0;
+   foreach my $tbl ( @visible ) {
+      push @display_lines, '', set_to_tbl($rows_for{$tbl}, $tbl);
+      push @display_lines, get_cxn_errors(@cxns)
+         if ( $config{debug}->{val} || !$first_table++ );
+   }
+
+   draw_screen(\@display_lines);
+}
+
+# display_M {{{3
+sub display_M {
+   my @display_lines;
+   my @cxns = get_connections();
+   get_master_slave_status(@cxns);
+   get_status_info(@cxns);
+
+   my @slave_sql_status;
+   my @slave_io_status;
+   my @master_status;
+   my %rows_for = (
+      slave_sql_status => \@slave_sql_status,
+      slave_io_status  => \@slave_io_status,
+      master_status    => \@master_status,
+   );
+
+   my @visible = get_visible_tables();
+   my %wanted  = map { $_ => 1 } @visible;
+
+   foreach my $cxn ( @cxns ) {
+      my $set  = $config{status_inc}->{val} ? inc(0, $cxn) : $vars{$cxn}->{$clock};
+      my $pre  = $vars{$cxn}->{$clock - 1} || $set;
+      if ( $wanted{slave_sql_status} ) {
+         push @slave_sql_status, extract_values($set, $set, $pre, 'slave_sql_status');
+      }
+      if ( $wanted{slave_io_status} ) {
+         push @slave_io_status, extract_values($set, $set, $pre, 'slave_io_status');
+      }
+      if ( $wanted{master_status} ) {
+         push @master_status, extract_values($set, $set, $pre, 'master_status');
+      }
+   }
+
+   my $first_table = 0;
+   foreach my $tbl ( @visible ) {
+      push @display_lines, '', set_to_tbl($rows_for{$tbl}, $tbl);
+      push @display_lines, get_cxn_errors(@cxns)
+         if ( $config{debug}->{val} || !$first_table++ );
+   }
+
+   draw_screen(\@display_lines);
+}
+
+# display_O {{{3
+sub display_O {
+   my @display_lines = ('');
+   my @cxns          = get_connections();
+   my @open_tables   = get_open_tables(@cxns);
+   my @tables = map { extract_values($_, $_, $_, 'open_tables') } @open_tables;
+   push @display_lines, set_to_tbl(\@tables, 'open_tables'), get_cxn_errors(@cxns);
+   draw_screen(\@display_lines);
+}
+
+# display_Q {{{3
+sub display_Q {
+   my @display_lines;
+
+   my @q_header;
+   my @processlist;
+   my %rows_for = (
+      q_header    => \@q_header,
+      processlist => \@processlist,
+   );
+
+   my @visible = $opts{n} ? 'processlist' : get_visible_tables();
+   my %wanted  = map { $_ => 1 } @visible;
+
+   # Get the data
+   my @cxns             = get_connections();
+   my @full_processlist = get_full_processlist(@cxns);
+
+   # Create header
+   if ( $wanted{q_header} ) {
+      get_status_info(@cxns);
+      foreach my $cxn ( @cxns ) {
+         my $set = $vars{$cxn}->{$clock};
+         my $pre = $vars{$cxn}->{$clock-1} || $set;
+         my $hash = extract_values($set, $set, $pre, 'q_header');
+         $hash->{cxn} = $cxn;
+         $hash->{when} = 'Total';
+         push @q_header, $hash;
+
+         if ( exists $vars{$cxn}->{$clock - 1} ) {
+            my $inc = inc(0, $cxn);
+            my $hash = extract_values($inc, $set, $pre, 'q_header');
+            $hash->{cxn} = $cxn;
+            $hash->{when} = 'Now';
+            push @q_header, $hash;
+         }
+      }
+   }
+
+   if ( $wanted{processlist} ) {
+      # TODO: save prev values
+      push @processlist, map { extract_values($_, $_, $_, 'processlist') } @full_processlist;
+   }
+
+   my $first_table = 0;
+   foreach my $tbl ( @visible ) {
+      next unless $wanted{$tbl};
+      push @display_lines, '', set_to_tbl($rows_for{$tbl}, $tbl);
+      push @display_lines, get_cxn_errors(@cxns)
+         if ( $config{debug}->{val} || !$first_table++ );
+   }
+
+   # Save queries in global variable for analysis.  The rows in %rows_for have been
+   # filtered, etc as a side effect of set_to_tbl(), so they are the same as the rows
+   # that get pushed to the screen.
+   @current_queries = map {
+      my %hash;
+      @hash{ qw(cxn id db query secs) } = @{$_}{ qw(cxn mysql_thread_id db info secs) };
+      \%hash;
+   } @{$rows_for{processlist}};
+
+   draw_screen(\@display_lines);
+}
+
+# display_R {{{3
+sub display_R {
+   my @display_lines;
+   my @cxns = get_connections();
+   get_innodb_status(\@cxns);
+
+   my @row_operations;
+   my @row_operation_misc;
+   my @semaphores;
+   my @wait_array;
+   my %rows_for = (
+      row_operations     => \@row_operations,
+      row_operation_misc => \@row_operation_misc,
+      semaphores         => \@semaphores,
+      wait_array         => \@wait_array,
+   );
+
+   my @visible = get_visible_tables();
+   my %wanted  = map { $_ => 1 } @visible;
+   my $incvar  = $config{status_inc}->{val};
+
+   foreach my $cxn ( @cxns ) {
+      my $set = $vars{$cxn}->{$clock};
+      my $pre = $vars{$cxn}->{$clock-1} || $set;
+      my $inc; # Only assigned to if wanted
+
+      if ( $set->{IB_ro_complete} ) {
+         if ( $wanted{row_operations} ) {
+            $inc ||= $incvar ? inc(0, $cxn) : $set;
+            push @row_operations, extract_values($inc, $set, $pre, 'row_operations');
+         }
+         if ( $wanted{row_operation_misc} ) {
+            push @row_operation_misc, extract_values($set, $set, $pre, 'row_operation_misc'),
+         }
+      }
+
+      if ( $set->{IB_sm_complete} && $wanted{semaphores} ) {
+         $inc ||= $incvar ? inc(0, $cxn) : $set;
+         push @semaphores, extract_values($inc, $set, $pre, 'semaphores');
+      }
+
+      if ( $set->{IB_sm_wait_array_size} && $wanted{wait_array} ) {
+         foreach my $wait ( @{$set->{IB_sm_waits}} ) {
+            my $hash = extract_values($wait, $wait, $wait, 'wait_array');
+            $hash->{cxn} = $cxn;
+            push @wait_array, $hash;
+         }
+      }
+   }
+
+   my $first_table = 0;
+   foreach my $tbl ( @visible ) {
+      push @display_lines, '', set_to_tbl($rows_for{$tbl}, $tbl);
+      push @display_lines, get_cxn_errors(@cxns)
+         if ( $config{debug}->{val} || !$first_table++ );
+   }
+
+   draw_screen(\@display_lines);
+}
+
+# display_T {{{3
+sub display_T {
+   my @display_lines;
+
+   my @t_header;
+   my @innodb_transactions;
+   my %rows_for = (
+      t_header            => \@t_header,
+      innodb_transactions => \@innodb_transactions,
+   );
+
+   my @visible = $opts{n} ? 'innodb_transactions' : get_visible_tables();
+   my %wanted  = map { $_ => 1 } @visible;
+
+   my @cxns = get_connections();
+
+   # If the header is to be shown, buffer pool data is required.
+   get_innodb_status( \@cxns, [ $wanted{t_header} ? qw(bp) : () ] );
+
+   foreach my $cxn ( get_connections() ) {
+      my $set = $vars{$cxn}->{$clock};
+      my $pre = $vars{$cxn}->{$clock-1} || $set;
+
+      next unless $set->{IB_tx_transactions};
+
+      if ( $wanted{t_header} ) {
+         my $hash = extract_values($set, $set, $pre, 't_header');
+         push @t_header, $hash;
+      }
+
+      if ( $wanted{innodb_transactions} ) {
+         my $cur_txns = $set->{IB_tx_transactions};
+         my $pre_txns = $pre->{IB_tx_transactions} || $cur_txns;
+         my %cur_txns = map { $_->{mysql_thread_id} => $_ } @$cur_txns;
+         my %pre_txns = map { $_->{mysql_thread_id} => $_ } @$pre_txns;
+         foreach my $thd_id ( sort keys %cur_txns ) {
+            my $cur_txn = $cur_txns{$thd_id};
+            my $pre_txn = $pre_txns{$thd_id} || $cur_txn;
+            my $hash    = extract_values($cur_txn, $cur_txn, $pre_txn, 'innodb_transactions');
+            $hash->{cxn} = $cxn;
+            push @innodb_transactions, $hash;
+         }
+      }
+
+   }
+
+   my $first_table = 0;
+   foreach my $tbl ( @visible ) {
+      push @display_lines, '', set_to_tbl($rows_for{$tbl}, $tbl);
+      push @display_lines, get_cxn_errors(@cxns)
+         if ( $config{debug}->{val} || !$first_table++ );
+   }
+
+   # Save queries in global variable for analysis.  The rows in %rows_for have been
+   # filtered, etc as a side effect of set_to_tbl(), so they are the same as the rows
+   # that get pushed to the screen.
+   @current_queries = map {
+      my %hash;
+      @hash{ qw(cxn id db query secs) } = @{$_}{ qw(cxn mysql_thread_id db query_text active_secs) };
+      \%hash;
+   } @{$rows_for{innodb_transactions}};
+
+   draw_screen(\@display_lines);
+}
+
+# display_S {{{3
+sub display_S {
+   my $fmt  = get_var_set('S_set');
+   my $func = $config{S_func}->{val};
+   my $inc  = $func eq 'g' || $config{status_inc}->{val};
+
+   # The table's meta-data is generated from the compiled var_set.
+   my ( $cols, $visible );
+   if ( $tbl_meta{var_status}->{fmt} && $fmt eq $tbl_meta{var_status}->{fmt} ) {
+      ( $cols, $visible ) = @{$tbl_meta{var_status}}{qw(cols visible)};
+   }
+   else {
+      ( $cols, $visible ) = compile_select_stmt($fmt);
+
+      # Apply missing values to columns.  Always apply averages across all connections.
+      map {
+         $_->{agg}   = 'avg';
+         $_->{label} = $_->{hdr};
+      } values %$cols;
+
+      $tbl_meta{var_status}->{cols}    = $cols;
+      $tbl_meta{var_status}->{visible} = $visible;
+      $tbl_meta{var_status}->{fmt}     = $fmt;
+      map { $tbl_meta{var_status}->{cols}->{$_}->{just} = ''} @$visible;
+   }
+
+   my @var_status;
+   my %rows_for = (
+      var_status => \@var_status,
+   );
+
+   my @visible = get_visible_tables();
+   my %wanted  = map { $_ => 1 } @visible;
+   my @cxns    = get_connections();
+
+   get_status_info(@cxns);
+   get_innodb_status(\@cxns);
+
+   # Set up whether to pivot and how many sets to extract.
+   $tbl_meta{var_status}->{pivot} = $func eq 'v';
+
+   my $num_sets
+      = $func eq 'v'
+      ? $config{num_status_sets}->{val}
+      : 0;
+   foreach my $set ( 0 .. $num_sets ) {
+      my @rows;
+      foreach my $cxn ( @cxns ) {
+         my $vars = $inc ? inc($set, $cxn) : $vars{$cxn}->{$clock - $set};
+         my $cur  = $vars{$cxn}->{$clock-$set};
+         my $pre  = $vars{$cxn}->{$clock-$set-1} || $cur;
+         next unless $vars && %$vars;
+         my $hash = extract_values($vars, $cur, $pre, 'var_status');
+         push @rows, $hash;
+      }
+      @rows = apply_group_by('var_status', [], @rows);
+      push @var_status, @rows;
+   }
+
+   # Recompile the sort func. TODO: avoid recompiling at every refresh.
+   # Figure out whether the data is all numeric and decide on a sort type.
+   # my $cmp
+   #   = scalar(
+   #      grep { !defined $_ || $_ !~ m/^\d+$/ }
+   #      map  { my $col = $_; map { $_->{$col} } @var_status }
+   #           $tbl_meta{var_status}->{sort_cols} =~ m/(\w+)/g)
+   #   ? 'cmp'
+   #   : '<=>';
+   $tbl_meta{var_status}->{sort_func} = make_sort_func($tbl_meta{var_status});
+
+   # ################################################################
+   # Now there is specific display code based on $config{S_func}
+   # ################################################################
+   if ( $func =~ m/s|g/ ) {
+      my $min_width = 4;
+
+      # Clear the screen if the display width changed.
+      if ( @last_term_size && $this_term_size[0] != $last_term_size[0] ) {
+         $lines_printed = 0;
+         $clear_screen_sub->();
+      }
+
+      if ( $func eq 's' ) {
+         # Decide how wide columns should be.
+         my $num_cols = scalar(@$visible);
+         my $width    = $opts{n} ? 0 : max($min_width, int(($this_term_size[0] - $num_cols + 1) / $num_cols));
+         my $g_format = $opts{n} ? ( "%s\t" x $num_cols ) : ( "%-${width}s " x $num_cols );
+
+         # Print headers every now and then.  Headers can get really long, so compact them.
+         my @hdr = @$visible;
+         if ( $opts{n} ) {
+            if ( $lines_printed == 0 ) {
+               print join("\t", @hdr), "\n";
+               $lines_printed++;
+            }
+         }
+         elsif ( $lines_printed == 0 || $lines_printed > $this_term_size[1] - 2 ) {
+            @hdr = map { donut(crunch($_, $width), $width) } @hdr;
+            print join(' ', map { sprintf( "%${width}s", donut($_, $width)) } @hdr) . "\n";
+            $lines_printed = 1;
+         }
+
+         # Design a column format for the values.
+         my $format
+            = $opts{n}
+            ? join("\t", map { '%s' } @$visible) . "\n"
+            : join(' ',  map { "%${width}s" } @hdr) . "\n";
+
+         foreach my $row ( @var_status ) {
+            printf($format, map { defined $_ ? $_ : '' } @{$row}{ @$visible });
+            $lines_printed++;
+         }
+      }
+      else { # 'g' mode
+         # Design a column format for the values.
+         my $num_cols = scalar(@$visible);
+         my $width    = $opts{n} ? 0 : int(($this_term_size[0] - $num_cols + 1) / $num_cols);
+         my $format   = $opts{n} ? ( "%s\t" x $num_cols ) : ( "%-${width}s " x $num_cols );
+         $format      =~ s/\s$/\n/;
+
+         # Print headers every now and then.
+         if ( $opts{n} ) {
+            if ( $lines_printed == 0 ) {
+               print join("\t", @$visible), "\n";
+               print join("\t", map { shorten($mvs{$_}) } @$visible), "\n";
+            }
+         }
+         elsif ( $lines_printed == 0 || $lines_printed > $this_term_size[1] - 2 ) {
+            printf($format, map { donut(crunch($_, $width), $width) } @$visible);
+            printf($format, map { shorten($mvs{$_} || 0) } @$visible);
+            $lines_printed = 2;
+         }
+
+         # Update the max ever seen, and scale by the max ever seen.
+         my $set = $var_status[0];
+         foreach my $col ( @$visible ) {
+            $set->{$col}  = 1 unless defined $set->{$col} && $set->{$col} =~ m/$num_regex/;
+            $set->{$col}  = ($set->{$col} || 1) / ($set->{Uptime_hires} || 1);
+            $mvs{$col}    = max($mvs{$col} || 1, $set->{$col});
+            $set->{$col} /= $mvs{$col};
+         }
+         printf($format, map { ( $config{graph_char}->{val} x int( $width * $set->{$_} )) || '.' } @$visible );
+         $lines_printed++;
+
+      }
+   }
+   else { # 'v'
+      my $first_table = 0;
+      my @display_lines;
+      foreach my $tbl ( @visible ) {
+         push @display_lines, '', set_to_tbl($rows_for{$tbl}, $tbl);
+         push @display_lines, get_cxn_errors(@cxns)
+            if ( $config{debug}->{val} || !$first_table++ );
+      }
+      $clear_screen_sub->();
+      draw_screen( \@display_lines );
+   }
+}
+
+# display_explain {{{3
+sub display_explain {
+   my $info = shift;
+   my $cxn   = $info->{cxn};
+   my $db    = $info->{db};
+
+   my ( $mods, $query ) = rewrite_for_explain($info->{query});
+
+   my @display_lines;
+
+   if ( $query ) {
+
+      my $part = version_ge($dbhs{$cxn}->{dbh}, '5.1.5') ? 'PARTITIONS' : '';
+      $query = "EXPLAIN $part\n" . $query;
+
+      eval {
+         if ( $db ) {
+            do_query($cxn, "use $db");
+         }
+         my $sth = do_query($cxn, $query);
+
+         my $res;
+         while ( $res = $sth->fetchrow_hashref() ) {
+            map { $res->{$_} ||= '' } ( 'partitions', keys %$res);
+            my @this_table = create_caption("Sub-Part $res->{id}",
+               create_table2(
+                  $tbl_meta{explain}->{visible},
+                  meta_to_hdr('explain'),
+                  extract_values($res, $res, $res, 'explain')));
+            @display_lines = stack_next(\@display_lines, \@this_table, { pad => '  ', vsep => 2 });
+         }
+      };
+
+      if ( $EVAL_ERROR ) {
+         push @display_lines,
+            '',
+            "The query could not be explained.  Only SELECT queries can be "
+            . "explained; innotop tries to rewrite certain REPLACE and INSERT queries "
+            . "into SELECT, but this doesn't always succeed.";
+      }
+
+   }
+   else {
+      push @display_lines, '', 'The query could not be explained.';
+   }
+
+   if ( $mods ) {
+      push @display_lines, '', '[This query has been re-written to be explainable]';
+   }
+
+   unshift @display_lines, no_ctrl_char($query);
+   draw_screen(\@display_lines, { raw => 1 } );
+}
+
+# rewrite_for_explain {{{3
+sub rewrite_for_explain {
+   my $query = shift;
+
+   my $mods = 0;
+   my $orig = $query;
+   $mods += $query =~ s/^\s*(?:replace|insert).*?select/select/is;
+   $mods += $query =~ s/^
+      \s*create\s+(?:temporary\s+)?table
+      \s+(?:\S+\s+)as\s+select/select/xis;
+   $mods += $query =~ s/\s+on\s+duplicate\s+key\s+update.*$//is;
+   return ( $mods, $query );
+}
+
+# show_optimized_query {{{3
+sub show_optimized_query {
+   my $info = shift;
+   my $cxn   = $info->{cxn};
+   my $db    = $info->{db};
+   my $meta  = $dbhs{$cxn};
+
+   my @display_lines;
+
+   my ( $mods, $query ) = rewrite_for_explain($info->{query});
+
+   if ( $mods ) {
+      push @display_lines, '[This query has been re-written to be explainable]';
+   }
+
+   if ( $query ) {
+      push @display_lines, no_ctrl_char($info->{query});
+
+      eval {
+         if ( $db ) {
+            do_query($cxn, "use $db");
+         }
+         do_query( $cxn, 'EXPLAIN EXTENDED ' . $query ) or die "Can't explain query";
+         my $sth = do_query($cxn, 'SHOW WARNINGS');
+         my $res = $sth->fetchall_arrayref({});
+
+         if ( $res ) {
+            foreach my $result ( @$res ) {
+               push @display_lines, 'Note:', no_ctrl_char($result->{message});
+            }
+         }
+         else {
+            push @display_lines, '', 'The query optimization could not be generated.';
+         }
+      };
+
+      if ( $EVAL_ERROR ) {
+         push @display_lines, '', "The optimization could not be generated: $EVAL_ERROR";
+      }
+
+   }
+   else {
+      push @display_lines, '', 'The query optimization could not be generated.';
+   }
+
+   draw_screen(\@display_lines, { raw => 1 } );
+}
+
+# display_help {{{3
+sub display_help {
+   my $mode = $config{mode}->{val};
+
+   # Get globally mapped keys, then overwrite them with mode-specific ones.
+   my %keys = map {
+         $_ => $action_for{$_}->{label}
+      } keys %action_for;
+   foreach my $key ( keys %{$modes{$mode}->{action_for}} ) {
+      $keys{$key} = $modes{$mode}->{action_for}->{$key}->{label};
+   }
+   delete $keys{'?'};
+
+   # Split them into three kinds of keys: MODE keys, action keys, and
+   # magic (special character) keys.
+   my @modes   = sort grep { m/[A-Z]/   } keys %keys;
+   my @actions = sort grep { m/[a-z]/   } keys %keys;
+   my @magic   = sort grep { m/[^A-Z]/i } keys %keys;
+
+   my @display_lines = ( '', 'Switch to a different mode:' );
+
+   # Mode keys
+   my @all_modes = map { "$_  $modes{$_}->{hdr}" } @modes;
+   my @col1 = splice(@all_modes, 0, ceil(@all_modes/3));
+   my @col2 = splice(@all_modes, 0, ceil(@all_modes/2));
+   my $max1 = max(map {length($_)} @col1);
+   my $max2 = max(map {length($_)} @col2);
+   while ( @col1 ) {
+      push @display_lines, sprintf("   %-${max1}s  %-${max2}s  %s",
+         (shift @col1      || ''),
+         (shift @col2      || ''),
+         (shift @all_modes || ''));
+   }
+
+   # Action keys
+   my @all_actions = map { "$_  $keys{$_}" } @actions;
+   @col1 = splice(@all_actions, 0, ceil(@all_actions/2));
+   $max1 = max(map {length($_)} @col1);
+   push @display_lines, '', 'Actions:';
+   while ( @col1 ) {
+      push @display_lines, sprintf("   %-${max1}s  %s",
+         (shift @col1        || ''),
+         (shift @all_actions || ''));
+   }
+
+   # Magic keys
+   my @all_magic = map { sprintf('%4s', $action_for{$_}->{key} || $_) . "  $keys{$_}" } @magic;
+   @col1 = splice(@all_magic, 0, ceil(@all_magic/2));
+   $max1 = max(map {length($_)} @col1);
+   push @display_lines, '', 'Other:';
+   while ( @col1 ) {
+      push @display_lines, sprintf("%-${max1}s%s",
+         (shift @col1      || ''),
+         (shift @all_magic || ''));
+   }
+
+   $clear_screen_sub->();
+   draw_screen(\@display_lines, { show_all => 1 } );
+   pause();
+   $clear_screen_sub->();
+}
+
+# show_full_query {{{3
+sub show_full_query {
+   my $info = shift;
+   my @display_lines = no_ctrl_char($info->{query});
+   draw_screen(\@display_lines, { raw => 1 });
+}
+
+# Formatting functions {{{2
+
+# create_table2 {{{3
+# Makes a two-column table, labels on left, data on right.
+# Takes refs of @cols, %labels and %data, %user_prefs
+sub create_table2 {
+   my ( $cols, $labels, $data, $user_prefs ) = @_;
+   my @rows;
+
+   if ( @$cols && %$data ) {
+
+      # Override defaults
+      my $p = {
+         just  => '',
+         sep   => ':',
+         just1 => '-',
+      };
+      if ( $user_prefs ) {
+         map { $p->{$_} = $user_prefs->{$_} } keys %$user_prefs;
+      }
+
+      # Fix undef values
+      map { $data->{$_} = '' unless defined $data->{$_} } @$cols;
+
+      # Format the table
+      my $max_l = max(map{ length($labels->{$_}) } @$cols);
+      my $max_v = max(map{ length($data->{$_}) } @$cols);
+      my $format    = "%$p->{just}${max_l}s$p->{sep} %$p->{just1}${max_v}s";
+      foreach my $col ( @$cols ) {
+         push @rows, sprintf($format, $labels->{$col}, $data->{$col});
+      }
+   }
+   return @rows;
+}
+
+# stack_next {{{3
+# Stacks one display section next to the other.  Accepts left-hand arrayref,
+# right-hand arrayref, and options hashref.  Tries to stack as high as
+# possible, so
+# aaaaaa
+# bbb
+# can stack ccc next to the bbb.
+# NOTE: this DOES modify its arguments, even though it returns a new array.
+sub stack_next {
+   my ( $left, $right, $user_prefs ) = @_;
+   my @result;
+
+   my $p = {
+      pad   => ' ',
+      vsep  => 0,
+   };
+   if ( $user_prefs ) {
+      map { $p->{$_} = $user_prefs->{$_} } keys %$user_prefs;
+   }
+
+   # Find out how wide the LHS can be and still let the RHS fit next to it.
+   my $pad   = $p->{pad};
+   my $max_r = max( map { length($_) } @$right) || 0;
+   my $max_l = $this_term_size[0] - $max_r - length($pad);
+
+   # Find the minimum row on the LHS that the RHS will fit next to.
+   my $i = scalar(@$left) - 1;
+   while ( $i >= 0 && length($left->[$i]) <= $max_l ) {
+      $i--;
+   }
+   $i++;
+   my $offset = $i;
+
+   if ( $i < scalar(@$left) ) {
+      # Find the max width of the section of the LHS against which the RHS
+      # will sit.
+      my $max_i_in_common = min($i + scalar(@$right) - 1, scalar(@$left) - 1);
+      my $max_width = max( map { length($_) } @{$left}[$i..$max_i_in_common]);
+
+      # Append the RHS onto the LHS until one runs out.
+      while ( $i < @$left && $i - $offset < @$right ) {
+         my $format = "%-${max_width}s$pad%${max_r}s";
+         $left->[$i] = sprintf($format, $left->[$i], $right->[$i - $offset]);
+         $i++;
+      }
+      while ( $i - $offset < @$right ) {
+         # There is more RHS to push on the end of the array
+         push @$left,
+            sprintf("%${max_width}s$pad%${max_r}s", ' ', $right->[$i - $offset]);
+         $i++;
+      }
+      push @result, @$left;
+   }
+   else {
+      # There is no room to put them side by side.  Add them below, with
+      # a blank line above them if specified.
+      push @result, @$left;
+      push @result, (' ' x $this_term_size[0]) if $p->{vsep} && @$left;
+      push @result, @$right;
+   }
+   return @result;
+}
+
+# create_caption {{{3
+sub create_caption {
+   my ( $caption, @rows ) = @_;
+   if ( @rows ) {
+
+      # Calculate the width of what will be displayed, so it can be centered
+      # in that space.  When the thing is wider than the display, center the
+      # caption in the display.
+      my $width = min($this_term_size[0], max(map { length(ref($_) ? $_->[0] : $_) } @rows));
+
+      my $cap_len = length($caption);
+
+      # It may be narrow enough to pad the sides with underscores and save a
+      # line on the screen.
+      if ( $cap_len <= $width - 6 ) {
+         my $left = int(($width - 2 - $cap_len) / 2);
+         unshift @rows,
+            ("_" x $left) . " $caption " . ("_" x ($width - $left - $cap_len - 2));
+      }
+
+      # The caption is too wide to add underscores on each side.
+      else {
+
+         # Color is supported, so we can use terminal underlining.
+         if ( $config{color}->{val} ) {
+            my $left = int(($width - $cap_len) / 2);
+            unshift @rows, [
+               (" " x $left) . $caption . (" " x ($width - $left - $cap_len)),
+               'underline',
+            ];
+         }
+
+         # Color is not supported, so we have to add a line underneath to separate the
+         # caption from whatever it's captioning.
+         else {
+            my $left = int(($width - $cap_len) / 2);
+            unshift @rows, ('-' x $width);
+            unshift @rows, (" " x $left) . $caption . (" " x ($width - $left - $cap_len));
+         }
+
+         # The caption is wider than the thing it labels, so we have to pad the
+         # thing it labels to a consistent width.
+         if ( $cap_len > $width ) {
+            @rows = map {
+               ref($_)
+                  ? [ sprintf('%-' . $cap_len . 's', $_->[0]), $_->[1] ]
+                  : sprintf('%-' . $cap_len . 's', $_);
+            } @rows;
+         }
+
+      }
+   }
+   return @rows;
+}
+
+# create_table {{{3
+# Input: an arrayref of columns, hashref of col info, and an arrayref of hashes
+# Example: [ 'a', 'b' ]
+#          { a => spec, b => spec }
+#          [ { a => 1, b => 2}, { a => 3, b => 4 } ]
+# The 'spec' is a hashref of hdr => label, just => ('-' or '').  It also supports min and max-widths
+# vi the minw and maxw params.
+# Output: an array of strings, one per row.
+# Example:
+# Column One Column Two
+# ---------- ----------
+# 1          2
+# 3          4
+sub create_table {
+   my ( $cols, $info, $data, $prefs ) = @_;
+   $prefs ||= {};
+   $prefs->{no_hdr} ||= ($opts{n} && $clock != 1);
+
+   # Truncate rows that will surely be off screen even if this is the only table.
+   if ( !$opts{n} && !$prefs->{raw} && !$prefs->{show_all} && $this_term_size[1] < @$data-1 ) {
+      $data = [ @$data[0..$this_term_size[1] - 1] ];
+   }
+
+   my @rows = ();
+
+   if ( @$cols && %$info ) {
+
+      # Fix undef values, collapse whitespace.
+      foreach my $row ( @$data ) {
+         map { $row->{$_} = collapse_ws($row->{$_}) } @$cols;
+      }
+
+      my $col_sep = $opts{n} ? "\t" : '  ';
+
+      # Find each column's max width.
+      my %width_for;
+      if ( !$opts{n} ) {
+         %width_for = map {
+            my $col_name  = $_;
+            if ( $info->{$_}->{dec} ) {
+               # Align along the decimal point
+               my $max_rodp = max(0, map { $_->{$col_name} =~ m/([^\s\d-].*)$/ ? length($1) : 0 } @$data);
+               foreach my $row ( @$data ) {
+                  my $col = $row->{$col_name};
+                  my ( $l, $r ) = $col =~ m/^([\s\d]*)(.*)$/;
+                  $row->{$col_name} = sprintf("%s%-${max_rodp}s", $l, $r);
+               }
+            }
+            my $max_width = max( length($info->{$_}->{hdr}), map { length($_->{$col_name}) } @$data);
+            if ( $info->{$col_name}->{maxw} ) {
+               $max_width = min( $max_width, $info->{$col_name}->{maxw} );
+            }
+            if ( $info->{$col_name}->{minw} ) {
+               $max_width = max( $max_width, $info->{$col_name}->{minw} );
+            }
+            $col_name => $max_width;
+         } @$cols;
+      }
+
+      # The table header.
+      if ( !$config{hide_hdr}->{val} && !$prefs->{no_hdr} ) {
+         push @rows, $opts{n}
+            ? join( $col_sep, @$cols )
+            : join( $col_sep, map { sprintf( "%-$width_for{$_}s", trunc($info->{$_}->{hdr}, $width_for{$_}) ) } @$cols );
+         if ( $config{color}->{val} && $config{header_highlight}->{val} ) {
+            push @rows, [ pop @rows, $config{header_highlight}->{val} ];
+         }
+         elsif ( !$opts{n} ) {
+            push @rows, join( $col_sep, map { "-" x $width_for{$_} } @$cols );
+         }
+      }
+
+      # The table data.
+      if ( $opts{n} ) {
+         foreach my $item ( @$data ) {
+            push @rows, join($col_sep, map { $item->{$_} } @$cols );
+         }
+      }
+      else {
+         my $format = join( $col_sep,
+            map { "%$info->{$_}->{just}$width_for{$_}s" } @$cols );
+         foreach my $item ( @$data ) {
+            my $row = sprintf($format, map { trunc($item->{$_}, $width_for{$_}) } @$cols );
+            if ( $config{color}->{val} && $item->{_color} ) {
+               push @rows, [ $row, $item->{_color} ];
+            }
+            else {
+               push @rows, $row;
+            }
+         }
+      }
+   }
+
+   return @rows;
+}
+
+# Aggregates a table.  If $group_by is an arrayref of columns, the grouping key
+# is the specified columns; otherwise it's just the empty string (e.g.
+# everything is grouped as one group).
+sub apply_group_by {
+   my ( $tbl, $group_by, @rows ) = @_;
+   my $meta = $tbl_meta{$tbl};
+   my %is_group = map { $_ => 1 } @$group_by;
+   my @non_grp  = grep { !$is_group{$_} } keys %{$meta->{cols}};
+
+   my %temp_table;
+   foreach my $row ( @rows ) {
+      my $group_key
+         = @$group_by
+         ? '{' . join('}{', map { defined $_ ? $_ : '' } @{$row}{@$group_by}) . '}'
+         : '';
+      $temp_table{$group_key} ||= [];
+      push @{$temp_table{$group_key}}, $row;
+   }
+
+   # Crush the rows together...
+   my @new_rows;
+   foreach my $key ( sort keys %temp_table ) {
+      my $group = $temp_table{$key};
+      my %new_row;
+      @new_row{@$group_by} = @{$group->[0]}{@$group_by};
+      foreach my $col ( @non_grp ) {
+         my $agg = $meta->{cols}->{$col}->{agg} || 'first';
+         $new_row{$col} = $agg_funcs{$agg}->( map { $_->{$col} } @$group );
+      }
+      push @new_rows, \%new_row;
+   }
+   return @new_rows;
+}
+
+# set_to_tbl {{{3
+# Unifies all the work of filtering, sorting etc.  Alters the input.
+# TODO: pull all the little pieces out into subroutines and stick events in each of them.
+sub set_to_tbl {
+   my ( $rows, $tbl ) = @_;
+   my $meta = $tbl_meta{$tbl} or die "No such table $tbl in tbl_meta";
+
+   # don't show cxn if there's only one connection being displayed
+   my @visible;
+   if (scalar @{$modes{$config{mode}->{val}}->{connections}} == 1) {
+      map { push @visible, $_ if $_ !~ /^cxn$/ } @{$meta->{visible}};
+      delete $$rows[0]{cxn} if defined $$rows[0]{cxn};
+   }
+   else {
+      @visible = @{$meta->{visible}};
+   }
+
+   if ( !$meta->{pivot} ) {
+
+      # Hook in event listeners
+      foreach my $listener ( @{$event_listener_for{set_to_tbl_pre_filter}} ) {
+         $listener->set_to_tbl_pre_filter($rows, $tbl);
+      }
+
+      # Apply filters.  Note that if the table is pivoted, filtering and sorting
+      # are applied later.
+      foreach my $filter ( @{$meta->{filters}} ) {
+         eval {
+            @$rows = grep { $filters{$filter}->{func}->($_) } @$rows;
+         };
+         if ( $EVAL_ERROR && $config{debug}->{val} ) {
+            die $EVAL_ERROR;
+         }
+      }
+
+      foreach my $listener ( @{$event_listener_for{set_to_tbl_pre_sort}} ) {
+         $listener->set_to_tbl_pre_sort($rows, $tbl);
+      }
+
+      # Sort.  Note that if the table is pivoted, sorting might have the wrong
+      # columns and it could crash.  This will only be an issue if it's possible
+      # to toggle pivoting on and off, which it's not at the moment.
+      if ( @$rows && $meta->{sort_func} && !$meta->{aggregate} ) {
+         if ( $meta->{sort_dir} > 0 ) {
+            @$rows = $meta->{sort_func}->( @$rows );
+         }
+         else {
+            @$rows = reverse $meta->{sort_func}->( @$rows );
+         }
+      }
+
+   }
+
+   # Stop altering arguments now.
+   my @rows = @$rows;
+
+   foreach my $listener ( @{$event_listener_for{set_to_tbl_pre_group}} ) {
+      $listener->set_to_tbl_pre_group(\@rows, $tbl);
+   }
+
+   # Apply group-by.
+   if ( $meta->{aggregate} ) {
+      @rows = apply_group_by($tbl, $meta->{group_by}, @rows);
+
+      # Sort.  Note that if the table is pivoted, sorting might have the wrong
+      # columns and it could crash.  This will only be an issue if it's possible
+      # to toggle pivoting on and off, which it's not at the moment.
+      if ( @rows && $meta->{sort_func} ) {
+         if ( $meta->{sort_dir} > 0 ) {
+            @rows = $meta->{sort_func}->( @rows );
+         }
+         else {
+            @rows = reverse $meta->{sort_func}->( @rows );
+         }
+      }
+
+   }
+
+   foreach my $listener ( @{$event_listener_for{set_to_tbl_pre_colorize}} ) {
+      $listener->set_to_tbl_pre_colorize(\@rows, $tbl);
+   }
+
+   if ( !$meta->{pivot} ) {
+      # Colorize.  Adds a _color column to rows.
+      if ( @rows && $meta->{color_func} ) {
+         eval {
+            foreach my $row ( @rows ) {
+               $row->{_color} = $meta->{color_func}->($row);
+            }
+         };
+         if ( $EVAL_ERROR ) {
+            pause($EVAL_ERROR);
+         }
+      }
+   }
+
+   foreach my $listener ( @{$event_listener_for{set_to_tbl_pre_transform}} ) {
+      $listener->set_to_tbl_pre_transform(\@rows, $tbl);
+   }
+
+   # Apply_transformations.
+   if ( @rows ) {
+      my $cols = $meta->{cols};
+      foreach my $col ( keys %{$rows->[0]} ) {
+         # Don't auto-vivify $tbl_meta{tbl}-{cols}->{_color}->{trans}
+         next if $col eq '_color';
+         foreach my $trans ( @{$cols->{$col}->{trans}} ) {
+            map { $_->{$col} = $trans_funcs{$trans}->($_->{$col}) } @rows;
+         }
+      }
+   }
+
+   my ($fmt_cols, $fmt_meta);
+
+   # Pivot.
+   if ( $meta->{pivot} ) {
+
+      foreach my $listener ( @{$event_listener_for{set_to_tbl_pre_pivot}} ) {
+         $listener->set_to_tbl_pre_pivot(\@rows, $tbl);
+      }
+
+      my @vars = @{$meta->{visible}};
+      my @tmp  = map { { name => $_ } } @vars;
+      my @cols = 'name';
+      foreach my $i ( 0..@$rows-1 ) {
+         my $col = "set_$i";
+         push @cols, $col;
+         foreach my $j ( 0..@vars-1 ) {
+            $tmp[$j]->{$col} = $rows[$i]->{$vars[$j]};
+         }
+      }
+      $fmt_meta = { map { $_ => { hdr => $_, just => '-' } } @cols };
+      $fmt_cols = \@cols;
+      @rows = @tmp;
+
+      # Hook in event listeners
+      foreach my $listener ( @{$event_listener_for{set_to_tbl_pre_filter}} ) {
+         $listener->set_to_tbl_pre_filter($rows, $tbl);
+      }
+
+      # Apply filters.
+      foreach my $filter ( @{$meta->{filters}} ) {
+         eval {
+            @rows = grep { $filters{$filter}->{func}->($_) } @rows;
+         };
+         if ( $EVAL_ERROR && $config{debug}->{val} ) {
+            die $EVAL_ERROR;
+         }
+      }
+
+      foreach my $listener ( @{$event_listener_for{set_to_tbl_pre_sort}} ) {
+         $listener->set_to_tbl_pre_sort($rows, $tbl);
+      }
+
+      # Sort.
+      if ( @rows && $meta->{sort_func} ) {
+         if ( $meta->{sort_dir} > 0 ) {
+            @rows = $meta->{sort_func}->( @rows );
+         }
+         else {
+            @rows = reverse $meta->{sort_func}->( @rows );
+         }
+      }
+
+   }
+   else {
+      # If the table isn't pivoted, just show all columns that are supposed to
+      # be shown; but eliminate aggonly columns if the table isn't aggregated.
+      my $aggregated = $meta->{aggregate};
+      $fmt_cols = [ grep { $aggregated || !$meta->{cols}->{$_}->{aggonly} } @visible ];
+      $fmt_meta = { map  { $_ => $meta->{cols}->{$_}                      } @$fmt_cols };
+
+      # If the table is aggregated, re-order the group_by columns to the left of
+      # the display.
+      if ( $aggregated ) {
+         my %is_group = map { $_ => 1 } @{$meta->{group_by}};
+         $fmt_cols = [ @{$meta->{group_by}}, grep { !$is_group{$_} } @$fmt_cols ];
+      }
+   }
+
+   foreach my $listener ( @{$event_listener_for{set_to_tbl_pre_create}} ) {
+      $listener->set_to_tbl_pre_create(\@rows, $tbl);
+   }
+
+   @rows = create_table( $fmt_cols, $fmt_meta, \@rows);
+   if ( !$meta->{hide_caption} && !$opts{n} && $config{display_table_captions}->{val} ) {
+      @rows = create_caption($meta->{capt}, @rows)
+   }
+
+   foreach my $listener ( @{$event_listener_for{set_to_tbl_post_create}} ) {
+      $listener->set_to_tbl_post_create(\@rows, $tbl);
+   }
+
+   return @rows;
+}
+
+# meta_to_hdr {{{3
+sub meta_to_hdr {
+   my $tbl = shift;
+   my $meta = $tbl_meta{$tbl};
+   my %labels = map { $_ => $meta->{cols}->{$_}->{hdr} } @{$meta->{visible}};
+   return \%labels;
+}
+
+# commify {{{3
+# From perlfaq5: add commas.
+sub commify {
+   my ( $num ) = @_;
+   $num = 0 unless defined $num;
+   $num =~ s/(^[-+]?\d+?(?=(?>(?:\d{3})+)(?!\d))|\G\d{3}(?=\d))/$1,/g;
+   return $num;
+}
+
+# set_precision {{{3
+# Trim to desired precision.
+sub set_precision {
+   my ( $num, $precision ) = @_;
+   $precision = $config{num_digits}->{val} if !defined $precision;
+   sprintf("%.${precision}f", $num);
+}
+
+# percent {{{3
+# Convert to percent
+sub percent {
+   my ( $num ) = @_;
+   $num = 0 unless defined $num;
+   my $digits = $config{num_digits}->{val};
+   return sprintf("%.${digits}f", $num * 100)
+      . ($config{show_percent}->{val} ? '%' : '');
+}
+
+# shorten {{{3
+sub shorten {
+   my ( $num, $opts ) = @_;
+
+   return $num if !defined($num) || $opts{n} || $num !~ m/$num_regex/;
+
+   $opts ||= {};
+   my $pad = defined $opts->{pad} ? $opts->{pad} : '';
+   my $num_digits = defined $opts->{num_digits}
+      ? $opts->{num_digits}
+      : $config{num_digits}->{val};
+   my $force = defined $opts->{force};
+
+   my $n = 0;
+   while ( $num >= 1_024 ) {
+      $num /= 1_024;
+      ++$n;
+   }
+   return sprintf(
+      $num =~ m/\./ || $n || $force
+         ? "%.${num_digits}f%s"
+         : '%d',
+      $num, ($pad,'k','M','G', 'T')[$n]);
+
+}
+
+# Utility functions {{{2
+# unique {{{3
+sub unique {
+   my %seen;
+   return grep { !$seen{$_}++ } @_;
+}
+
+# make_color_func {{{3
+sub make_color_func {
+   my ( $tbl ) = @_;
+   my @criteria;
+   foreach my $spec ( @{$tbl->{colors}} ) {
+      next unless exists $comp_ops{$spec->{op}};
+      my $val = $spec->{op} =~ m/^(?:eq|ne|le|ge|lt|gt)$/ ? "'$spec->{arg}'"
+              : $spec->{op} =~ m/^(?:=~|!~)$/             ? "m/" . quotemeta($spec->{arg}) . "/"
+              :                                             $spec->{arg};
+      push @criteria,
+         "( defined \$set->{$spec->{col}} && \$set->{$spec->{col}} $spec->{op} $val ) { return '$spec->{color}'; }";
+   }
+   return undef unless @criteria;
+   my $sub = eval 'sub { my ( $set ) = @_; if ' . join(" elsif ", @criteria) . '}';
+   die if $EVAL_ERROR;
+   return $sub;
+}
+
+# make_sort_func {{{3
+# Gets a list of sort columns from the table, like "+cxn -time" and returns a
+# subroutine that will sort that way.
+sub make_sort_func {
+   my ( $tbl ) = @_;
+   my @criteria;
+
+   # Pivoted tables can be sorted by 'name' and set_x columns; others must be
+   # sorted by existing columns.  TODO: this will crash if you toggle between
+   # pivoted and nonpivoted.  I have several other 'crash' notes about this if
+   # this ever becomes possible.
+
+   if ( $tbl->{pivot} ) {
+      # Sort type is not really possible on pivoted columns, because a 'column'
+      # contains data from an entire non-pivoted row, so there could be a mix of
+      # numeric and non-numeric data.  Thus everything has to be 'cmp' type.
+      foreach my $col ( split(/\s+/, $tbl->{sort_cols} ) ) {
+         next unless $col;
+         my ( $dir, $name ) = $col =~ m/([+-])?(\w+)$/;
+         next unless $name && $name =~ m/^(?:name|set_\d+)$/;
+         $dir ||= '+';
+         my $op = 'cmp';
+         my $df = "''";
+         push @criteria,
+            $dir eq '+'
+            ? "(\$a->{$name} || $df) $op (\$b->{$name} || $df)"
+            : "(\$b->{$name} || $df) $op (\$a->{$name} || $df)";
+      }
+   }
+   else {
+      foreach my $col ( split(/\s+/, $tbl->{sort_cols} ) ) {
+         next unless $col;
+         my ( $dir, $name ) = $col =~ m/([+-])?(\w+)$/;
+         next unless $name && $tbl->{cols}->{$name};
+         $dir ||= '+';
+         my $op = $tbl->{cols}->{$name}->{num} ? "<=>" : "cmp";
+         my $df = $tbl->{cols}->{$name}->{num} ? "0"   : "''";
+         push @criteria,
+            $dir eq '+'
+            ? "(\$a->{$name} || $df) $op (\$b->{$name} || $df)"
+            : "(\$b->{$name} || $df) $op (\$a->{$name} || $df)";
+      }
+   }
+   return sub { return @_ } unless @criteria;
+   my $sub = eval 'sub { sort {' . join("||", @criteria) . '} @_; }';
+   die if $EVAL_ERROR;
+   return $sub;
+}
+
+# trunc {{{3
+# Shortens text to specified length.
+sub trunc {
+   my ( $text, $len ) = @_;
+   if ( length($text) <= $len ) {
+      return $text;
+   }
+   return substr($text, 0, $len);
+}
+
+# donut {{{3
+# Takes out the middle of text to shorten it.
+sub donut {
+   my ( $text, $len ) = @_;
+   return $text if length($text) <= $len;
+   my $max = length($text) - $len;
+   my $min = $max - 1;
+
+   # Try to remove a single "word" from somewhere in the center
+   if ( $text =~ s/_[^_]{$min,$max}_/_/ ) {
+      return $text;
+   }
+
+   # Prefer removing the end of a "word"
+   if ( $text =~ s/([^_]+)[^_]{$max}_/$1_/ ) {
+      return $text;
+   }
+
+   $text = substr($text, 0, int($len/2))
+         . "_"
+         . substr($text, int($len/2) + $max + 1);
+   return $text;
+}
+
+# crunch {{{3
+# Removes vowels and compacts repeated letters to shorten text.
+sub crunch {
+   my ( $text, $len ) = @_;
+   return $text if $len && length($text) <= $len;
+   $text =~ s/^IB_\w\w_//;
+   $text =~ s/(?<![_ ])[aeiou]//g;
+   $text =~ s/(.)\1+/$1/g;
+   return $text;
+}
+
+# collapse_ws {{{3
+# Collapses all whitespace to a single space.
+sub collapse_ws {
+   my ( $text ) = @_;
+   return '' unless defined $text;
+   $text =~ s/\s+/ /g;
+   return $text;
+}
+
+# Strips out non-printable characters within fields, which freak terminals out.
+sub no_ctrl_char {
+   my ( $text ) = @_;
+   return '' unless defined $text;
+   my $charset = $config{charset}->{val};
+   if ( $charset && $charset eq 'unicode' ) {
+      $text =~ s/
+         ("(?:(?!(?<!\\)").)*"  # Double-quoted string
+         |'(?:(?!(?<!\\)').)*') # Or single-quoted string
+         /$1 =~ m#\p{IsC}# ? "[BINARY]" : $1/egx;
+   }
+   elsif ( $charset && $charset eq 'none' ) {
+      $text =~ s/
+         ("(?:(?!(?<!\\)").)*"
+         |'(?:(?!(?<!\\)').)*')
+         /[TEXT]/gx;
+   }
+   else { # The default is 'ascii'
+      $text =~ s/
+         ("(?:(?!(?<!\\)").)*"
+         |'(?:(?!(?<!\\)').)*')
+         /$1 =~ m#[^\040-\176]# ? "[BINARY]" : $1/egx;
+   }
+   return $text;
+}
+
+# word_wrap {{{3
+# Wraps text at word boundaries so it fits the screen.
+sub word_wrap {
+   my ( $text, $width) = @_;
+   $width ||= $this_term_size[0];
+   $text =~ s/(.{0,$width})(?:\s+|$)/$1\n/g;
+   $text =~ s/ +$//mg;
+   return $text;
+}
+
+# draw_screen {{{3
+# Prints lines to the screen.  The first argument is an arrayref.  Each
+# element of the array is either a string or an arrayref.  If it's a string it
+# just gets printed.  If it's an arrayref, the first element is the string to
+# print, and the second is args to colored().
+sub draw_screen {
+   my ( $display_lines, $prefs ) = @_;
+   if ( !$opts{n} && $config{show_statusbar}->{val} ) {
+      unshift @$display_lines, create_statusbar();
+   }
+
+   foreach my $listener ( @{$event_listener_for{draw_screen}} ) {
+      $listener->draw_screen($display_lines);
+   }
+
+   $clear_screen_sub->()
+      if $prefs->{clear} || !$modes{$config{mode}->{val}}->{no_clear_screen};
+   if ( $opts{n} || $prefs->{raw} ) {
+      my $num_lines = 0;
+      print join("\n",
+         map {
+            $num_lines++;
+            ref $_
+               ? colored($_->[0], $_->[1])
+               : $_;
+         }
+         grep { !$opts{n} || $_ } # Suppress empty lines
+         @$display_lines);
+      if ( $opts{n} && $num_lines ) {
+         print "\n";
+      }
+   }
+   else {
+      my $max_lines = $prefs->{show_all}
+         ? scalar(@$display_lines)- 1
+         : min(scalar(@$display_lines), $this_term_size[1]);
+      print join("\n",
+         map {
+            ref $_
+               ? colored(substr($_->[0], 0, $this_term_size[0]), $_->[1])
+               : substr($_, 0, $this_term_size[0]);
+         } @$display_lines[0..$max_lines - 1]);
+   }
+}
+
+# secs_to_time {{{3
+sub secs_to_time {
+   my ( $secs, $fmt ) = @_;
+   $secs ||= 0;
+   return '00:00' unless $secs;
+
+   # Decide what format to use, if not given
+   $fmt ||= $secs >= 86_400 ? 'd'
+          : $secs >= 3_600  ? 'h'
+          :                   'm';
+
+   return
+      $fmt eq 'd' ? sprintf(
+         "%d+%02d:%02d:%02d",
+         int($secs / 86_400),
+         int(($secs % 86_400) / 3_600),
+         int(($secs % 3_600) / 60),
+         $secs % 60)
+      : $fmt eq 'h' ? sprintf(
+         "%02d:%02d:%02d",
+         int(($secs % 86_400) / 3_600),
+         int(($secs % 3_600) / 60),
+         $secs % 60)
+      : sprintf(
+         "%02d:%02d",
+         int(($secs % 3_600) / 60),
+         $secs % 60);
+}
+
+# dulint_to_int {{{3
+# Takes a number that InnoDB formats as two ulint integers, like transaction IDs
+# and such, and turns it into a single integer
+sub dulint_to_int {
+   my $num = shift;
+   return 0 unless $num;
+   my ( $high, $low ) = $num =~ m/^(\d+) (\d+)$/;
+   return $low unless $high;
+   return $low + ( $high * $MAX_ULONG );
+}
+
+# create_statusbar {{{3
+sub create_statusbar {
+   my $mode = $config{mode}->{val};
+   my @cxns = sort { $a cmp $b } get_connections();
+
+   my $modeline        = ( $config{readonly}->{val} ? '[RO] ' : '' )
+                         . $modes{$mode}->{hdr} . " (? for help)";
+   my $mode_width      = length($modeline);
+   my $remaining_width = $this_term_size[0] - $mode_width - 1;
+   my $result;
+
+   # The thingie in top-right that says what we're monitoring.
+   my $cxn = '';
+
+   if ( 1 == @cxns && $dbhs{$cxns[0]} && $dbhs{$cxns[0]}->{dbh} ) {
+      $cxn = $dbhs{$cxns[0]}->{dbh}->{mysql_serverinfo} || '';
+   }
+   else {
+      if ( $modes{$mode}->{server_group} ) {
+         $cxn = "Servers: " . $modes{$mode}->{server_group};
+         my $err_count = grep { $dbhs{$_} && $dbhs{$_}->{err_count} } @cxns;
+         if ( $err_count ) {
+            $cxn .= "(" . ( scalar(@cxns) - $err_count ) . "/" . scalar(@cxns) . ")";
+         }
+      }
+      else {
+         $cxn = join(' ', map { ($dbhs{$_}->{err_count} ? '!' : '') . $_ }
+            grep { $dbhs{$_} } @cxns);
+      }
+   }
+
+   if ( 1 == @cxns ) {
+      get_driver_status(@cxns);
+      my $vars = $vars{$cxns[0]}->{$clock};
+      my $inc  = inc(0, $cxns[0]);
+
+      # Format server uptime human-readably, calculate QPS...
+      my $uptime = secs_to_time( $vars->{Uptime_hires} );
+      my $qps    = ($inc->{Questions}||0) / ($inc->{Uptime_hires}||1);
+      my $ibinfo = '';
+
+      if ( exists $vars->{IB_last_secs} ) {
+         $ibinfo .= "InnoDB $vars->{IB_last_secs}s ";
+         if ( $vars->{IB_got_all} ) {
+            if ( ($mode eq 'T' || $mode eq 'W')
+                  && $vars->{IB_tx_is_truncated} ) {
+               $ibinfo .= ':^|';
+            }
+            else {
+               $ibinfo .= ':-)';
+            }
+         }
+         else {
+            $ibinfo .= ':-(';
+         }
+      }
+      $result = sprintf(
+         "%-${mode_width}s %${remaining_width}s",
+         $modeline,
+         join(', ', grep { $_ } (
+            $cxns[0],
+            $uptime,
+            $ibinfo,
+            shorten($qps) . " QPS",
+            ($vars->{Threads} || 0) . "/" . ($vars->{Threads_running} || 0) . "/" . ($vars->{Threads_cached} || 0) . " con/run/cac thds",
+            $cxn)));
+   }
+   else {
+      $result = sprintf(
+         "%-${mode_width}s %${remaining_width}s",
+         $modeline,
+         $cxn);
+   }
+
+   return $config{color}->{val} ? [ $result, 'bold reverse' ] : $result;
+}
+
+# Database connections {{{3
+sub add_new_dsn {
+   my ( $name, $dsn, $dl_table, $have_user, $user, $have_pass, $pass, $savepass ) = @_;
+
+   if ( defined $name ) {
+      $name =~ s/[\s:;]//g;
+   }
+
+   if ( !$name ) {
+      print word_wrap("Choose a name for the connection.  It cannot contain "
+         . "whitespace, colons or semicolons."), "\n\n";
+      do {
+         $name = prompt("Enter a name");
+         $name =~ s/[\s:;]//g;
+      } until ( $name );
+   }
+
+   if ( !$dsn ) {
+      do {
+         $clear_screen_sub->();
+         print "Typical DSN strings look like\n   DBI:mysql:;host=hostname;port=port\n"
+            . "The db and port are optional and can usually be omitted.\n"
+            . "If you specify 'mysql_read_default_group=mysql' many options can be read\n"
+            . "from your mysql options files (~/.my.cnf, /etc/my.cnf).\n\n";
+         $dsn = prompt("Enter a DSN string", undef, "DBI:mysql:;mysql_read_default_group=mysql;host=$name");
+      } until ( $dsn );
+   }
+   if ( !$dl_table ) {
+      $clear_screen_sub->();
+      my $dl_table = prompt("Optional: enter a table (must not exist) to use when resetting InnoDB deadlock information",
+         undef, 'test.innotop_dl');
+   }
+
+   $connections{$name} = {
+      dsn       => $dsn,
+      dl_table  => $dl_table,
+      have_user => $have_user,
+      user      => $user,
+      have_pass => $have_pass,
+      pass      => $pass,
+      savepass  => $savepass
+   };
+}
+
+sub add_new_server_group {
+   my ( $name ) = @_;
+
+   if ( defined $name ) {
+      $name =~ s/[\s:;]//g;
+   }
+
+   if ( !$name ) {
+      print word_wrap("Choose a name for the group.  It cannot contain "
+         . "whitespace, colons or semicolons."), "\n\n";
+      do {
+         $name = prompt("Enter a name");
+         $name =~ s/[\s:;]//g;
+      } until ( $name );
+   }
+
+   my @cxns;
+   do {
+      $clear_screen_sub->();
+      @cxns = select_cxn("Choose servers for $name", keys %connections);
+   } until ( @cxns );
+
+   $server_groups{$name} = \@cxns;
+   return $name;
+}
+
+sub get_var_set {
+   my ( $name ) = @_;
+   while ( !$name || !exists($var_sets{$config{$name}->{val}}) ) {
+      $name = choose_var_set($name);
+   }
+   return $var_sets{$config{$name}->{val}}->{text};
+}
+
+sub add_new_var_set {
+   my ( $name ) = @_;
+
+   if ( defined $name ) {
+      $name =~ s/\W//g;
+   }
+
+   if ( !$name ) {
+      do {
+         $name = prompt("Enter a name");
+         $name =~ s/\W//g;
+      } until ( $name );
+   }
+
+   my $variables;
+   do {
+      $clear_screen_sub->();
+      $variables = prompt("Enter variables for $name", undef );
+   } until ( $variables );
+
+   $var_sets{$name} = { text => $variables, user => 1 };
+}
+
+sub next_server {
+   my $mode     = $config{mode}->{val};
+   my @cxns     = sort keys %connections;
+   my ($cur)    = get_connections($mode);
+   $cur         ||= $cxns[0];
+   my $pos      = grep { $_ lt $cur } @cxns;
+   my $newpos   = ($pos + 1) % @cxns;
+   $modes{$mode}->{server_group} = '';
+   $modes{$mode}->{connections} = [ $cxns[$newpos] ];
+   $clear_screen_sub->();
+}
+
+sub next_server_group {
+   my $mode = shift || $config{mode}->{val};
+   my @grps = sort keys %server_groups;
+   my $curr = $modes{$mode}->{server_group};
+
+   return unless @grps;
+
+   if ( $curr ) {
+      # Find the current group's position.
+      my $pos = 0;
+      while ( $curr ne $grps[$pos] ) {
+         $pos++;
+      }
+      $modes{$mode}->{server_group} = $grps[ ($pos + 1) % @grps ];
+   }
+   else {
+      $modes{$mode}->{server_group} = $grps[0];
+   }
+}
+
+# Get a list of connection names used in this mode.
+sub get_connections {
+   if ( $file ) {
+      return qw(file);
+   }
+   my $mode = shift || $config{mode}->{val};
+   my @connections = $modes{$mode}->{server_group}
+      ? @{$server_groups{$modes{$mode}->{server_group}}}
+      : @{$modes{$mode}->{connections}};
+   if ( $modes{$mode}->{one_connection} ) {
+      @connections = @connections ? $connections[0] : ();
+   }
+   return unique(@connections);
+}
+
+# Get a list of tables used in this mode.  If innotop is running non-interactively, just use the first.
+sub get_visible_tables {
+   my $mode = shift || $config{mode}->{val};
+   my @tbls = @{$modes{$mode}->{visible_tables}};
+   if ( $opts{n} ) {
+      return $tbls[0];
+   }
+   else {
+      return @tbls;
+   }
+}
+
+# Choose from among available connections or server groups.
+# If the mode has a server set in use, prefers that instead.
+sub choose_connections {
+   $clear_screen_sub->();
+   my $mode    = $config{mode}->{val};
+   my $meta    =  { map { $_ => $connections{$_}->{dsn} } keys %connections };
+   foreach my $group ( keys %server_groups ) {
+      $meta->{"#$group"} = join(' ', @{$server_groups{$group}});
+   }
+
+   my $choices = prompt_list("Choose connections or a group for $mode mode",
+      undef, sub { return keys %$meta }, $meta);
+
+   my @choices = unique(grep { $_ } split(/\s+/, $choices));
+   if ( @choices ) {
+      if ( $choices[0] =~ s/^#// && exists $server_groups{$choices[0]} ) {
+         $modes{$mode}->{server_group} = $choices[0];
+      }
+      else {
+         $modes{$mode}->{connections} = [ grep { exists $connections{$_} } @choices ];
+      }
+   }
+}
+
+# Accepts a DB connection name and the name of a prepared query (e.g. status, kill).
+# Also a list of params for the prepared query.  This allows not storing prepared
+# statements globally.  Returns a $sth that's been executed.
+# ERROR-HANDLING SEMANTICS: if the statement throws an error, propagate, but if the
+# connection has gone away or can't connect, DO NOT.  Just return undef.
+sub do_stmt {
+   my ( $cxn, $stmt_name, @args ) = @_;
+
+   return undef if $file;
+
+   # Test if the cxn should not even be tried
+   return undef if $dbhs{$cxn}
+      && $dbhs{$cxn}->{err_count} 
+      && ( !$dbhs{$cxn}->{dbh} || !$dbhs{$cxn}->{dbh}->{Active} || $dbhs{$cxn}->{mode} eq $config{mode}->{val} )
+      && $dbhs{$cxn}->{wake_up} > $clock;
+
+   my $sth;
+   my $retries = 1;
+   my $success = 0;
+   TRY:
+   while ( $retries-- >= 0 && !$success ) {
+
+      eval {
+         my $dbh = connect_to_db($cxn);
+
+         # If the prepared query doesn't exist, make it.
+         if ( !exists $dbhs{$cxn}->{stmts}->{$stmt_name} ) {
+            $dbhs{$cxn}->{stmts}->{$stmt_name} = $stmt_maker_for{$stmt_name}->($dbh);
+         }
+
+         $sth = $dbhs{$cxn}->{stmts}->{$stmt_name};
+         if ( $sth ) {
+            $sth->execute(@args);
+         }
+         $success = 1;
+      };
+      if ( $EVAL_ERROR ) {
+         if ( $EVAL_ERROR =~ m/$nonfatal_errs/ ) {
+            handle_cxn_error($cxn, $EVAL_ERROR);
+         }
+         else {
+            die "$cxn $stmt_name: $EVAL_ERROR";
+         }
+         if ( $retries < 0 ) {
+            $sth = undef;
+         }
+      }
+   }
+
+   if ( $sth && $sth->{NUM_OF_FIELDS} ) {
+      sleep($stmt_sleep_time_for{$stmt_name}) if $stmt_sleep_time_for{$stmt_name};
+      return $sth;
+   }
+}
+
+# Keeps track of error count, sleep times till retries, etc etc.
+# When there's an error we retry the connection every so often, increasing in
+# Fibonacci series to prevent too much banging on the server.
+sub handle_cxn_error {
+   my ( $cxn, $err ) = @_;
+   my $meta = $dbhs{$cxn};
+   $meta->{err_count}++;
+
+   # This is used so errors that have to do with permissions needed by the current
+   # mode will get displayed as long as we're in this mode, but get ignored if the
+   # mode changes.
+   $meta->{mode} = $config{mode}->{val};
+
+   # Strip garbage from the error text if possible.
+   $err =~ s/\s+/ /g;
+   if ( $err =~ m/failed: (.*?) at \S*innotop line/ ) {
+      $err = $1;
+   }
+
+   $meta->{last_err}   = $err;
+   my $sleep_time      = $meta->{this_sleep} + $meta->{prev_sleep};
+   $meta->{prev_sleep} = $meta->{this_sleep};
+   $meta->{this_sleep} = $sleep_time;
+   $meta->{wake_up}    = $clock + $sleep_time;
+   if ( $config{show_cxn_errors}->{val} ) {
+      print STDERR "Error at tick $clock $cxn $err" if $config{debug}->{val};
+   }
+}
+
+# Accepts a DB connection name and a (string) query.  Returns a $sth that's been
+# executed.
+sub do_query {
+   my ( $cxn, $query ) = @_;
+
+   return undef if $file;
+
+   # Test if the cxn should not even be tried
+   return undef if $dbhs{$cxn}
+      && $dbhs{$cxn}->{err_count} 
+      && ( !$dbhs{$cxn}->{dbh} || !$dbhs{$cxn}->{dbh}->{Active} || $dbhs{$cxn}->{mode} eq $config{mode}->{val} )
+      && $dbhs{$cxn}->{wake_up} > $clock;
+
+   my $sth;
+   my $retries = 1;
+   my $success = 0;
+   TRY:
+   while ( $retries-- >= 0 && !$success ) {
+
+      eval {
+         my $dbh = connect_to_db($cxn);
+
+         $sth = $dbh->prepare($query);
+         $sth->execute();
+         $success = 1;
+      };
+      if ( $EVAL_ERROR ) {
+         if ( $EVAL_ERROR =~ m/$nonfatal_errs/ ) {
+            handle_cxn_error($cxn, $EVAL_ERROR);
+         }
+         else {
+            die $EVAL_ERROR;
+         }
+         if ( $retries < 0 ) {
+            $sth = undef;
+         }
+      }
+   }
+ 
+   return $sth;
+}
+
+sub get_uptime {
+   my ( $cxn ) = @_;
+   $dbhs{$cxn}->{start_time} ||= time();
+   # Avoid dividing by zero
+   return (time() - $dbhs{$cxn}->{start_time}) || .001;
+}
+
+sub connect_to_db {
+   my ( $cxn ) = @_;
+
+   $dbhs{$cxn} ||= {
+      stmts      => {},  # bucket for prepared statements.
+      prev_sleep => 0,
+      this_sleep => 1,
+      wake_up    => 0,
+      start_time => 0,
+      dbh        => undef,
+   };
+   my $href = $dbhs{$cxn};
+
+   if ( !$href->{dbh} || ref($href->{dbh}) !~ m/DBI/ || !$href->{dbh}->ping ) {
+      my $dbh = get_new_db_connection($cxn);
+      @{$href}{qw(dbh err_count wake_up this_sleep start_time prev_sleep)}
+               = ($dbh, 0, 0, 1, 0, 0);
+
+      # Derive and store the server's start time in hi-res
+      my $uptime = $dbh->selectrow_hashref("show status like 'Uptime'")->{value};
+      $href->{start_time} = time() - $uptime;
+
+      # Set timeouts so an unused connection stays alive.
+      # For example, a connection might be used in Q mode but idle in T mode.
+      if ( version_ge($dbh, '4.0.3')) {
+         my $timeout = $config{cxn_timeout}->{val};
+         $dbh->do("set session wait_timeout=$timeout, interactive_timeout=$timeout");
+      }
+   }
+   return $href->{dbh};
+}
+
+# Compares versions like 5.0.27 and 4.1.15-standard-log
+sub version_ge {
+   my ( $dbh, $target ) = @_;
+   my $version = sprintf('%03d%03d%03d', $dbh->{mysql_serverinfo} =~ m/(\d+)/g);
+   return $version ge sprintf('%03d%03d%03d', $target =~ m/(\d+)/g);
+}
+
+# Extracts status values that can be gleaned from the DBD driver without doing a whole query.
+sub get_driver_status {
+   my @cxns = @_;
+   if ( !$info_gotten{driver_status}++ ) {
+      foreach my $cxn ( @cxns ) {
+         next unless $dbhs{$cxn} && $dbhs{$cxn}->{dbh} && $dbhs{$cxn}->{dbh}->{Active};
+         $vars{$cxn}->{$clock} ||= {};
+         my $vars = $vars{$cxn}->{$clock};
+         my %res = map {  $_ =~ s/ +/_/g; $_ } $dbhs{$cxn}->{dbh}->{mysql_stat} =~ m/(\w[^:]+): ([\d\.]+)/g;
+         map { $vars->{$_} ||= $res{$_} } keys %res;
+         $vars->{Uptime_hires} ||= get_uptime($cxn);
+         $vars->{cxn} = $cxn;
+      }
+   }
+}
+
+sub get_new_db_connection {
+   my ( $connection, $destroy ) = @_;
+   if ( $file ) {
+      die "You can't connect to a MySQL server while monitoring a file.  This is probably a bug.";
+   }
+
+   my $dsn = $connections{$connection}
+      or die "No connection named '$connection' is defined in your configuration";
+
+   # don't ask for a username if mysql_read_default_group=client is in the DSN
+   if ( !defined $dsn->{have_user} and $dsn->{dsn} !~ /mysql_read_default_group=client/ ) {
+      my $answer = prompt("Do you want to specify a username for $connection?", undef, 'n');
+      $dsn->{have_user} = $answer && $answer =~ m/1|y/i;
+   }
+
+   # don't ask for a password if mysql_read_default_group=client is in the DSN
+   if ( !defined $dsn->{have_pass} and $dsn->{dsn} !~ /mysql_read_default_group=client/ ) {
+      my $answer = prompt("Do you want to specify a password for $connection?", undef, 'n');
+      $dsn->{have_pass} = $answer && $answer =~ m/1|y/i;
+   }
+
+   if ( !$dsn->{user} && $dsn->{have_user} ) {
+      my $user = $ENV{USERNAME} || $ENV{USER} || getlogin() || getpwuid($REAL_USER_ID) || undef;
+      $dsn->{user} = prompt("Enter username for $connection", undef, $user);
+   }
+
+   if ( !defined $dsn->{user} ) {
+      $dsn->{user} = '';
+   }
+
+   if ( !$dsn->{pass} && !$dsn->{savepass} && $dsn->{have_pass} ) {
+      $dsn->{pass} = prompt_noecho("Enter password for '$dsn->{user}' on $connection");
+      print "\n";
+      if ( !defined($dsn->{savepass}) ) {
+         my $answer = prompt("Save password in plain text in the config file?", undef, 'y');
+         $dsn->{savepass} = $answer && $answer =~ m/1|y/i;
+      }
+   }
+
+   my $dbh = DBI->connect(
+      $dsn->{dsn}, $dsn->{user}, $dsn->{pass},
+      { RaiseError => 1, PrintError => 0, AutoCommit => 1 });
+   $dbh->{InactiveDestroy} = 1 unless $destroy; # Can't be set in $db_options
+   $dbh->{FetchHashKeyName} = 'NAME_lc'; # Lowercases all column names for fetchrow_hashref
+   return $dbh;
+}
+
+sub get_cxn_errors {
+   my @cxns = @_;
+   return () unless $config{show_cxn_errors_in_tbl}->{val};
+   return
+      map  { [ $_ . ': ' . $dbhs{$_}->{last_err}, 'red' ] }
+      grep { $dbhs{$_} && $dbhs{$_}->{err_count} && $dbhs{$_}->{mode} eq $config{mode}->{val} }
+      @cxns;
+}
+
+# Setup and tear-down functions {{{2
+
+# Takes a string and turns it into a hashref you can apply to %tbl_meta tables.  The string
+# can be in the form 'foo, bar, foo/bar, foo as bar' much like a SQL SELECT statement.
+sub compile_select_stmt {
+   my ($str) = @_;
+   my @exps = $str =~ m/\s*([^,]+(?i:\s+as\s+[^,\s]+)?)\s*(?=,|$)/g;
+   my %cols;
+   my @visible;
+   foreach my $exp ( @exps ) {
+      my ( $text, $colname );
+      if ( $exp =~ m/as\s+(\w+)\s*/ ) {
+         $colname = $1;
+         $exp =~ s/as\s+(\w+)\s*//;
+         $text    = $exp;
+      }
+      else {
+         $text = $colname = $exp;
+      }
+      my ($func, $err) = compile_expr($text);
+      $cols{$colname} = {
+         src  => $text,
+         hdr  => $colname,
+         num  => 0,
+         func => $func,
+      };
+      push @visible, $colname;
+   }
+   return (\%cols, \@visible);
+}
+
+# compile_filter {{{3
+sub compile_filter {
+   my ( $text ) = @_;
+   my ( $sub, $err );
+   eval "\$sub = sub { my \$set = shift; $text }";
+   if ( $EVAL_ERROR ) {
+      $EVAL_ERROR =~ s/at \(eval.*$//;
+      $sub = sub { return $EVAL_ERROR };
+      $err = $EVAL_ERROR;
+   }
+   return ( $sub, $err );
+}
+
+# compile_expr {{{3
+sub compile_expr {
+   my ( $expr ) = @_;
+   # Leave built-in functions alone so they get called as Perl functions, unless
+   # they are the only word in $expr, in which case treat them as hash keys.
+   if ( $expr =~ m/\W/ ) {
+      $expr =~ s/(?<!\{|\$)\b([A-Za-z]\w{2,})\b/is_func($1) ? $1 : "\$set->{$1}"/eg;
+   }
+   else {
+      $expr = "\$set->{$expr}";
+   }
+   my ( $sub, $err );
+   my $quoted = quotemeta($expr);
+   eval qq{
+      \$sub = sub {
+         my (\$set, \$cur, \$pre) = \@_;
+         my \$val = eval { $expr };
+         if ( \$EVAL_ERROR && \$config{debug}->{val} ) {
+            \$EVAL_ERROR =~ s/ at \\(eval.*//s;
+            die "\$EVAL_ERROR in expression $quoted";
+         }
+         return \$val;
+      }
+   };
+   if ( $EVAL_ERROR ) {
+      if ( $config{debug}->{val} ) {
+         die $EVAL_ERROR;
+      }
+      $EVAL_ERROR =~ s/ at \(eval.*$//;
+      $sub = sub { return $EVAL_ERROR };
+      $err = $EVAL_ERROR;
+   }
+   return ( $sub, $err );
+}
+
+# finish {{{3
+# This is a subroutine because it's called from a key to quit the program.
+sub finish {
+   save_config();
+   ReadMode('normal') unless $opts{n};
+   print "\n";
+   exit(0);
+}
+
+# core_dump {{{3
+sub core_dump {
+   my $msg = shift;
+   if ($config{debugfile}->{val} && $config{debug}->{val}) {
+      eval {
+         open my $file, '>>', $config{debugfile}->{val};
+         if ( %vars ) {
+            print $file "Current variables:\n" . Dumper(\%vars);
+         }
+         close $file;
+      };
+   }
+   print $msg;
+}
+
+# migrate_config {{{3
+sub migrate_config {
+
+   my ($old_filename, $new_filename) = @_;
+
+   # don't proceed if old file doesn't exist
+   if ( ! -f $old_filename ) {
+      die "Error migrating '$old_filename': file doesn't exist.\n";
+   }
+   # don't migrate files if new file exists
+   elsif ( -f $new_filename ) {
+      die "Error migrating '$old_filename' to '$new_filename': new file already exists.\n";
+   }
+   # if migrating from one file to another in the same directory, just rename them
+   if (dirname($old_filename) eq dirname($new_filename)) {
+      rename($old_filename, $new_filename)
+         or die "Can't rename '$old_filename' to '$new_filename': $OS_ERROR";
+   }
+   # otherwise, move the existing conf file to a temp file, make the necessary directory structure,
+   # and move the temp conf file to its new home
+   else {
+      my $tmp = File::Temp->new( TEMPLATE => 'innotopXXXXX', DIR => $homepath, SUFFIX => '.conf');
+      my $tmp_filename = $tmp->filename;
+      my $dirname = dirname($new_filename);
+      rename($old_filename, $tmp_filename)
+         or die "Can't rename '$old_filename' to '$tmp_filename': $OS_ERROR";
+      mkdir($dirname) or die "Can't create directory '$dirname': $OS_ERROR";
+      mkdir("$dirname/plugins") or die "Can't create directory '$dirname/plugins': $OS_ERROR";
+      rename($tmp_filename, $new_filename)
+         or die "Can't rename '$tmp_filename' to '$new_filename': $OS_ERROR";
+   }
+}
+
+# load_config {{{3
+sub load_config {
+    
+   my ($old_filename, $answer);
+
+   if ( $opts{u} or $opts{p} or $opts{h} or $opts{P} ) {
+     my @params = $dsn_parser->get_cxn_params(\%opts); # dsn=$params[0]
+     add_new_dsn($opts{h} || 'localhost', $params[0], 'test.innotop_dl', 
+                 $opts{u} ? 1 : 0, $opts{u}, $opts{p} ? 1 : 0, $opts{p});
+   }
+   if ($opts{c}) {
+      $conf_file = $opts{c};
+   }  
+   # innotop got upgraded and this is an old config file.
+   elsif ( -f "$homepath/.innotop" or -f "$homepath/.innotop/innotop.ini" ) {
+      $conf_file = $default_home_conf;
+      if ( -f  "$homepath/.innotop") {
+         $old_filename = "$homepath/.innotop";
+      }
+      elsif ( -f "$homepath/.innotop/innotop.ini" ) {
+         $old_filename = "$homepath/.innotop/innotop.ini";
+      }
+      $answer = pause("Innotop's default config location has moved to '$conf_file'.  Move old config file '$old_filename' there now? y/n");
+      if ( lc $answer eq 'y' ) {
+         migrate_config($old_filename, $conf_file);
+      }
+      else {
+         print "\nInnotop will now exit so you can fix the config file.\n";
+         exit(0);
+      }
+   }
+   elsif ( -f $default_home_conf ) {
+      $conf_file = $default_home_conf;
+   }
+   elsif ( -f $default_central_conf and not $opts{s} ) {
+      $conf_file = $default_central_conf;
+   }
+   else {
+      # If no config file was loaded, set readonly to 0 if the user wants to 
+      # write a config
+      $config{readonly}->{val} = 0 if $opts{w};
+      # If no connections have been defined, connect to a MySQL database 
+      # on localhost using mysql_read_default_group=client
+      if (!%connections) {
+         add_new_dsn('localhost', 
+                     'DBI:mysql:;host=localhost;mysql_read_default_group=client', 
+                     'test.innotop_dl');
+      }
+   }
+
+   if ( -f "$conf_file" ) {
+      open my $file, "<", $conf_file or die("Can't open '$conf_file': $OS_ERROR");
+
+      # Check config file version.  Just ignore if either innotop or the file has
+      # garbage in the version number.
+      if ( defined(my $line = <$file>) && $VERSION =~ m/\d/ ) {
+         chomp $line;
+         if ( my ($maj, $min, $rev) = $line =~ m/^version=(\d+)\.(\d+)(?:\.(\d+))?$/ ) {
+            $rev ||= 0;
+            my $cfg_ver          = sprintf('%03d-%03d-%03d', $maj, $min, $rev);
+            ( $maj, $min, $rev ) = $VERSION =~ m/^(\d+)\.(\d+)(?:\.(\d+))?$/;
+            $rev ||= 0;
+            my $innotop_ver      = sprintf('%03d-%03d-%03d', $maj, $min, $rev);
+
+            if ( $cfg_ver gt $innotop_ver ) {
+               pause("The config file is for a newer version of innotop and may not be read correctly.");
+            }
+            else {
+               my @ver_history = @config_versions;
+               while ( my ($start, $end) = splice(@ver_history, 0, 2) ) {
+                  # If the config file is between the endpoints and innotop is greater than
+                  # the endpoint, innotop has a newer config file format than the file.
+                  if ( $cfg_ver ge $start && $cfg_ver lt $end && $innotop_ver ge $end ) {
+                     my $msg = "innotop's config file format has changed.  Overwrite $conf_file?  y or n";
+                     if ( pause($msg) eq 'n' ) {
+                        $config{readonly}->{val} = 1;
+                        print "\ninnotop will not save any configuration changes you make.";
+                        pause();
+                        print "\n";
+                     }
+                     close $file;
+                     return;
+                  }
+               }
+            }
+         }
+      }
+
+      while ( my $line = <$file> ) {
+         chomp $line;
+         next unless $line =~ m/^\[([a-z_]+)\]$/;
+         if ( exists $config_file_sections{$1} ) {
+            $config_file_sections{$1}->{reader}->($file);
+         }
+         else {
+            warn "Unknown config file section '$1'";
+         }
+      }
+      close $file or die("Can't close $conf_file: $OS_ERROR");
+   }
+
+}
+
+# Do some post-processing on %tbl_meta: compile src properties into func etc.
+sub post_process_tbl_meta {
+   foreach my $table ( values %tbl_meta ) {
+      foreach my $col_name ( keys %{$table->{cols}} ) {
+         my $col_def = $table->{cols}->{$col_name};
+         my ( $sub, $err ) = compile_expr($col_def->{src});
+         $col_def->{func} = $sub;
+      }
+   }
+}
+
+# load_config_plugins {{{3
+sub load_config_plugins {
+   my ( $file ) = @_;
+
+   # First, find a list of all plugins that exist on disk, and get information about them.
+   my $dir = $config{plugin_dir}->{val};
+   foreach my $p_file ( <$dir/*.pm> ) {
+      my ($package, $desc);
+      eval {
+         open my $p_in, "<", $p_file or die $OS_ERROR;
+         while ( my $line = <$p_in> ) {
+            chomp $line;
+            if ( $line =~ m/^package\s+(.*?);/ ) {
+               $package = $1;
+            }
+            elsif ( $line =~ m/^# description: (.*)/ ) {
+               $desc = $1;
+            }
+            last if $package && $desc;
+         }
+         close $p_in;
+      };
+      if ( $package ) {
+         $plugins{$package} = {
+            file   => $p_file,
+            desc   => $desc,
+            class  => $package,
+            active => 0,
+         };
+         if ( $config{debug}->{val} && $EVAL_ERROR ) {
+            die $EVAL_ERROR;
+         }
+      }
+   }
+
+   # Now read which ones the user has activated.  Each line simply represents an active plugin.
+   while ( my $line = <$file> ) {
+      chomp $line;
+      next if $line =~ m/^#/;
+      last if $line =~ m/^\[/;
+      next unless $line && $plugins{$line};
+
+      my $obj;
+      eval {
+         require $plugins{$line}->{file};
+         $obj = $line->new(%pluggable_vars);
+         foreach my $event ( $obj->register_for_events() ) {
+            my $queue = $event_listener_for{$event};
+            if ( $queue ) {
+               push @$queue, $obj;
+            }
+         }
+      };
+      if ( $config{debug}->{val} && $EVAL_ERROR ) {
+         die $EVAL_ERROR;
+      }
+      if ( $obj ) {
+         $plugins{$line}->{active} = 1;
+         $plugins{$line}->{object} = $obj;
+      }
+   }
+}
+
+# save_config_plugins {{{3
+sub save_config_plugins {
+   my $file = shift;
+   foreach my $class ( sort keys %plugins ) {
+      next unless $plugins{$class}->{active};
+      print $file "$class\n";
+   }
+}
+
+# load_config_active_server_groups {{{3
+sub load_config_active_server_groups {
+   my ( $file ) = @_;
+   while ( my $line = <$file> ) {
+      chomp $line;
+      next if $line =~ m/^#/;
+      last if $line =~ m/^\[/;
+
+      my ( $mode, $group ) = $line =~ m/^(.*?)=(.*)$/;
+      next unless $mode && $group
+         && exists $modes{$mode} && exists $server_groups{$group};
+      $modes{$mode}->{server_group} = $group;
+   }
+}
+
+# save_config_active_server_groups {{{3
+sub save_config_active_server_groups {
+   my $file = shift;
+   foreach my $mode ( sort keys %modes ) {
+      print $file "$mode=$modes{$mode}->{server_group}\n";
+   }
+}
+
+# load_config_server_groups {{{3
+sub load_config_server_groups {
+   my ( $file ) = @_;
+   while ( my $line = <$file> ) {
+      chomp $line;
+      next if $line =~ m/^#/;
+      last if $line =~ m/^\[/;
+
+      my ( $name, $rest ) = $line =~ m/^(.*?)=(.*)$/;
+      next unless $name && $rest;
+      my @vars = unique(grep { $_ && exists $connections{$_} } split(/\s+/, $rest));
+      next unless @vars;
+      $server_groups{$name} = \@vars;
+   }
+}
+
+# save_config_server_groups {{{3
+sub save_config_server_groups {
+   my $file = shift;
+   foreach my $set ( sort keys %server_groups ) {
+      print $file "$set=", join(' ', @{$server_groups{$set}}), "\n";
+   }
+}
+
+# load_config_varsets {{{3
+sub load_config_varsets {
+   my ( $file ) = @_;
+   while ( my $line = <$file> ) {
+      chomp $line;
+      next if $line =~ m/^#/;
+      last if $line =~ m/^\[/;
+
+      my ( $name, $rest ) = $line =~ m/^(.*?)=(.*)$/;
+      next unless $name && $rest;
+      $var_sets{$name} = {
+         text => $rest,
+         user => 1,
+      };
+   }
+}
+
+# save_config_varsets {{{3
+sub save_config_varsets {
+   my $file = shift;
+   foreach my $varset ( sort keys %var_sets ) {
+      next unless $var_sets{$varset}->{user};
+      print $file "$varset=$var_sets{$varset}->{text}\n";
+   }
+}
+
+# load_config_group_by {{{3
+sub load_config_group_by {
+   my ( $file ) = @_;
+   while ( my $line = <$file> ) {
+      chomp $line;
+      next if $line =~ m/^#/;
+      last if $line =~ m/^\[/;
+
+      my ( $tbl , $rest ) = $line =~ m/^(.*?)=(.*)$/;
+      next unless $tbl && exists $tbl_meta{$tbl};
+      my @parts = unique(grep { exists($tbl_meta{$tbl}->{cols}->{$_}) } split(/\s+/, $rest));
+      $tbl_meta{$tbl}->{group_by} = [ @parts ];
+      $tbl_meta{$tbl}->{cust}->{group_by} = 1;
+   }
+}
+
+# save_config_group_by {{{3
+sub save_config_group_by {
+   my $file = shift;
+   foreach my $tbl ( sort keys %tbl_meta ) {
+      next if $tbl_meta{$tbl}->{temp};
+      next unless $tbl_meta{$tbl}->{cust}->{group_by};
+      my $aref = $tbl_meta{$tbl}->{group_by};
+      print $file "$tbl=", join(' ', @$aref), "\n";
+   }
+}
+
+# load_config_filters {{{3
+sub load_config_filters {
+   my ( $file ) = @_;
+   while ( my $line = <$file> ) {
+      chomp $line;
+      next if $line =~ m/^#/;
+      last if $line =~ m/^\[/;
+
+      my ( $key, $rest ) = $line =~ m/^(.+?)=(.*)$/;
+      next unless $key && $rest;
+
+      my %parts = $rest =~ m/(\w+)='((?:(?!(?<!\\)').)*)'/g; # Properties are single-quoted
+      next unless $parts{text} && $parts{tbls};
+
+      foreach my $prop ( keys %parts ) {
+         # Un-escape escaping
+         $parts{$prop} =~ s/\\\\/\\/g;
+         $parts{$prop} =~ s/\\'/'/g;
+      }
+
+      my ( $sub, $err ) = compile_filter($parts{text});
+      my @tbls = unique(split(/\s+/, $parts{tbls}));
+      @tbls = grep { exists $tbl_meta{$_} } @tbls;
+      $filters{$key} = {
+         func => $sub,
+         text => $parts{text},
+         user => 1,
+         name => $key,
+         note => 'User-defined filter',
+         tbls => \@tbls,
+      }
+   }
+}
+
+# save_config_filters {{{3
+sub save_config_filters {
+   my $file = shift;
+   foreach my $key ( sort keys %filters ) {
+      next if !$filters{$key}->{user} || $filters{$key}->{quick};
+      my $text = $filters{$key}->{text};
+      $text =~ s/([\\'])/\\$1/g;
+      my $tbls = join(" ", @{$filters{$key}->{tbls}});
+      print $file "$key=text='$text' tbls='$tbls'\n";
+   }
+}
+
+# load_config_visible_tables {{{3
+sub load_config_visible_tables {
+   my ( $file ) = @_;
+   while ( my $line = <$file> ) {
+      chomp $line;
+      next if $line =~ m/^#/;
+      last if $line =~ m/^\[/;
+
+      my ( $mode, $rest ) = $line =~ m/^(.*?)=(.*)$/;
+      next unless $mode && exists $modes{$mode};
+      $modes{$mode}->{visible_tables} =
+         [ unique(grep { $_ && exists $tbl_meta{$_} } split(/\s+/, $rest)) ];
+      $modes{$mode}->{cust}->{visible_tables} = 1;
+   }
+}
+
+# save_config_visible_tables {{{3
+sub save_config_visible_tables {
+   my $file = shift;
+   foreach my $mode ( sort keys %modes ) {
+      next unless $modes{$mode}->{cust}->{visible_tables};
+      my $tables = $modes{$mode}->{visible_tables};
+      print $file "$mode=", join(' ', @$tables), "\n";
+   }
+}
+
+# load_config_sort_cols {{{3
+sub load_config_sort_cols {
+   my ( $file ) = @_;
+   while ( my $line = <$file> ) {
+      chomp $line;
+      next if $line =~ m/^#/;
+      last if $line =~ m/^\[/;
+
+      my ( $key , $rest ) = $line =~ m/^(.*?)=(.*)$/;
+      next unless $key && exists $tbl_meta{$key};
+      $tbl_meta{$key}->{sort_cols} = $rest;
+      $tbl_meta{$key}->{cust}->{sort_cols} = 1;
+      $tbl_meta{$key}->{sort_func} = make_sort_func($tbl_meta{$key});
+   }
+}
+
+# save_config_sort_cols {{{3
+sub save_config_sort_cols {
+   my $file = shift;
+   foreach my $tbl ( sort keys %tbl_meta ) {
+      next unless $tbl_meta{$tbl}->{cust}->{sort_cols};
+      my $col = $tbl_meta{$tbl}->{sort_cols};
+      print $file "$tbl=$col\n";
+   }
+}
+
+# load_config_active_filters {{{3
+sub load_config_active_filters {
+   my ( $file ) = @_;
+   while ( my $line = <$file> ) {
+      chomp $line;
+      next if $line =~ m/^#/;
+      last if $line =~ m/^\[/;
+
+      my ( $tbl , $rest ) = $line =~ m/^(.*?)=(.*)$/;
+      next unless $tbl && exists $tbl_meta{$tbl};
+      my @parts = unique(grep { exists($filters{$_}) } split(/\s+/, $rest));
+      @parts = grep { grep { $tbl eq $_ } @{$filters{$_}->{tbls}} } @parts;
+      $tbl_meta{$tbl}->{filters} = [ @parts ];
+      $tbl_meta{$tbl}->{cust}->{filters} = 1;
+   }
+}
+
+# save_config_active_filters {{{3
+sub save_config_active_filters {
+   my $file = shift;
+   foreach my $tbl ( sort keys %tbl_meta ) {
+      next if $tbl_meta{$tbl}->{temp};
+      next unless $tbl_meta{$tbl}->{cust}->{filters};
+      my $aref = $tbl_meta{$tbl}->{filters};
+      print $file "$tbl=", join(' ', @$aref), "\n";
+   }
+}
+
+# load_config_active_columns {{{3
+sub load_config_active_columns {
+   my ( $file ) = @_;
+   while ( my $line = <$file> ) {
+      chomp $line;
+      next if $line =~ m/^#/;
+      last if $line =~ m/^\[/;
+
+      my ( $key , $rest ) = $line =~ m/^(.*?)=(.*)$/;
+      next unless $key && exists $tbl_meta{$key};
+      my @parts = grep { exists($tbl_meta{$key}->{cols}->{$_}) } unique split(/ /, $rest);
+      $tbl_meta{$key}->{visible} = [ @parts ];
+      $tbl_meta{$key}->{cust}->{visible} = 1;
+   }
+}
+
+# save_config_active_columns {{{3
+sub save_config_active_columns {
+   my $file = shift;
+   foreach my $tbl ( sort keys %tbl_meta ) {
+      next unless $tbl_meta{$tbl}->{cust}->{visible};
+      my $aref = $tbl_meta{$tbl}->{visible};
+      print $file "$tbl=", join(' ', @$aref), "\n";
+   }
+}
+
+# save_config_tbl_meta {{{3
+sub save_config_tbl_meta {
+   my $file = shift;
+   foreach my $tbl ( sort keys %tbl_meta ) {
+      foreach my $col ( keys %{$tbl_meta{$tbl}->{cols}} ) {
+         my $meta = $tbl_meta{$tbl}->{cols}->{$col};
+         next unless $meta->{user};
+         print $file "$col=", join(
+            " ",
+            map {
+               # Some properties (trans) are arrays, others scalars
+               my $val = ref($meta->{$_}) ? join(',', @{$meta->{$_}}) : $meta->{$_};
+               $val =~ s/([\\'])/\\$1/g;  # Escape backslashes and single quotes
+               "$_='$val'";               # Enclose in single quotes
+            }
+            grep { $_ ne 'func' }
+            keys %$meta
+         ), "\n";
+      }
+   }
+}
+
+# save_config_config {{{3
+sub save_config_config {
+   my $file = shift;
+   foreach my $key ( sort keys %config ) {
+      eval {
+      if ( $key ne 'password' || $config{savepass}->{val} ) {
+         print $file "# $config{$key}->{note}\n"
+            or die "Cannot print to file: $OS_ERROR";
+         my $val = $config{$key}->{val};
+         $val = '' unless defined($val);
+         if ( ref( $val ) eq 'ARRAY' ) {
+            print $file "$key="
+               . join( " ", @$val ) . "\n"
+               or die "Cannot print to file: $OS_ERROR";
+         }
+         elsif ( ref( $val ) eq 'HASH' ) {
+            print $file "$key="
+               . join( " ",
+                  map { "$_:$val->{$_}" } keys %$val
+               ) . "\n";
+         }
+         else {
+            print $file "$key=$val\n";
+         }
+      }
+      };
+      if ( $EVAL_ERROR ) { print "$EVAL_ERROR in $key"; };
+   }
+
+}
+
+# load_config_config {{{3
+sub load_config_config {
+   my ( $file ) = @_;
+
+   while ( my $line = <$file> ) {
+      chomp $line;
+      next if $line =~ m/^#/;
+      last if $line =~ m/^\[/;
+
+      my ( $name, $val ) = $line =~ m/^(.+?)=(.*)$/;
+      next unless defined $name && defined $val;
+
+      # Validate the incoming values...
+      if ( $name && exists( $config{$name} ) ) {
+         if ( !$config{$name}->{pat} || $val =~ m/$config{$name}->{pat}/ ) {
+            $config{$name}->{val} = $val;
+            $config{$name}->{read} = 1;
+         }
+      }
+   }
+}
+
+# load_config_tbl_meta {{{3
+sub load_config_tbl_meta {
+   my ( $file ) = @_;
+
+   while ( my $line = <$file> ) {
+      chomp $line;
+      next if $line =~ m/^#/;
+      last if $line =~ m/^\[/;
+
+      # Each tbl_meta section has all the properties defined in %col_props.
+      my ( $col , $rest ) = $line =~ m/^(.*?)=(.*)$/;
+      next unless $col;
+      my %parts = $rest =~ m/(\w+)='((?:(?!(?<!\\)').)*)'/g; # Properties are single-quoted
+
+      # Each section read from the config file has one extra property: which table it
+      # goes in.
+      my $tbl  = $parts{tbl}     or die "There's no table for tbl_meta $col";
+      my $meta = $tbl_meta{$tbl} or die "There's no table in tbl_meta named $tbl";
+
+      # The section is user-defined by definition (if that makes sense).
+      $parts{user} = 1;
+
+      # The column may already exist in the table, in which case this is just a
+      # customization.
+      $meta->{cols}->{$col} ||= {};
+
+      foreach my $prop ( keys %col_props ) {
+         if ( !defined($parts{$prop}) ) {
+            die "Undefined property $prop for column $col in table $tbl";
+         }
+
+         # Un-escape escaping
+         $parts{$prop} =~ s/\\\\/\\/g;
+         $parts{$prop} =~ s/\\'/'/g;
+
+         if ( ref $col_props{$prop} ) {
+            if ( $prop eq 'trans' ) {
+               $meta->{cols}->{$col}->{trans}
+                  = [ unique(grep { exists $trans_funcs{$_} } split(',', $parts{$prop})) ];
+            }
+            else {
+               $meta->{cols}->{$col}->{$prop} = [ split(',', $parts{$prop}) ];
+            }
+         }
+         else {
+            $meta->{cols}->{$col}->{$prop} = $parts{$prop};
+         }
+      }
+
+   }
+}
+
+# save_config {{{3
+sub save_config {
+   print "\n";
+   return if $config{readonly}->{val};
+   # return if no config file was loaded and -w wasn't specified
+   if (not $conf_file) {
+      if (not $opts{w}) {
+         return;
+      }
+      else {
+         # if no config was loaded but -w was specified,
+         # write to $default_home_conf
+         $conf_file = $default_home_conf;
+      }
+   }
+   elsif ($conf_file and $opts{w}) {
+     print "Loaded config file on start-up, so ignoring -w (see --help)\n"
+   }
+   
+   my $dirname  = dirname($conf_file);
+
+   # if directories don't exist, create them.  This could cause errors
+   # or warnings if a central config doesn't have readonly=1, but being
+   # flexible requires giving the user enough rope to hang themselves with.
+   if ( ! -d $dirname ) {
+      mkdir $dirname
+         or die "Can't create directory '$dirname': $OS_ERROR";
+   }
+   if ( ! -d "$dirname/plugins" ) {
+      mkdir "$dirname/plugins"
+         or warn "Can't create directory '$dirname/plugins': $OS_ERROR\n";
+   }
+
+   # Save to a temp file first, so a crash doesn't destroy the main config file
+   my $tmpfile = File::Temp->new( TEMPLATE => 'innotopXXXXX', DIR => $dirname, SUFFIX => '.conf.tmp');
+   open my $file, "+>", $tmpfile
+      or die("Can't write to $tmpfile: $OS_ERROR");
+   print $file "version=$VERSION\n";
+
+   foreach my $section ( @ordered_config_file_sections ) {
+      die "No such config file section $section" unless $config_file_sections{$section};
+      print $file "\n[$section]\n\n";
+      $config_file_sections{$section}->{writer}->($file);
+      print $file "\n[/$section]\n";
+   }
+
+   # Now clobber the main config file with the temp.
+   close $file or die("Can't close $tmpfile: $OS_ERROR");
+   rename($tmpfile, $conf_file) or die("Can't rename $tmpfile to $conf_file: $OS_ERROR");
+}
+
+# load_config_connections {{{3
+sub load_config_connections {
+   return if $opts{u} or $opts{p} or $opts{h} or $opts{P}; # don't load connections if DSN or user/pass options used
+   my ( $file ) = @_;
+   while ( my $line = <$file> ) {
+      chomp $line;
+      next if $line =~ m/^#/;
+      last if $line =~ m/^\[/;
+
+      my ( $key , $rest ) = $line =~ m/^(.*?)=(.*)$/;
+      next unless $key;
+      my %parts = $rest =~ m/(\S+?)=(\S*)/g;
+      my %conn  = map { $_ => $parts{$_} || '' } @conn_parts;
+      $connections{$key} = \%conn;
+   }
+}
+
+# save_config_connections {{{3
+sub save_config_connections {
+   my $file = shift;
+   foreach my $conn ( sort keys %connections ) {
+      my $href = $connections{$conn};
+      my @keys = $href->{savepass} ? @conn_parts : grep { $_ ne 'pass' } @conn_parts;
+      print $file "$conn=", join(' ', map { "$_=$href->{$_}" } grep { defined $href->{$_} } @keys), "\n";
+   }
+}
+
+sub load_config_colors {
+   my ( $file ) = @_;
+   my %rule_set_for;
+
+   while ( my $line = <$file> ) {
+      chomp $line;
+      next if $line =~ m/^#/;
+      last if $line =~ m/^\[/;
+
+      my ( $tbl, $rule ) = $line =~ m/^(.*?)=(.*)$/;
+      next unless $tbl && $rule;
+      next unless exists $tbl_meta{$tbl};
+      my %parts = $rule =~ m/(\w+)='((?:(?!(?<!\\)').)*)'/g; # Properties are single-quoted
+      next unless $parts{col} && exists $tbl_meta{$tbl}->{cols}->{$parts{col}};
+      next unless $parts{op}  && exists $comp_ops{$parts{op}};
+      next unless defined $parts{arg};
+      next unless defined $parts{color};
+      my @colors = unique(grep { exists $ansicolors{$_} } split(/\W+/, $parts{color}));
+      next unless @colors;
+
+      # Finally!  Enough validation...
+      $rule_set_for{$tbl} ||= [];
+      push @{$rule_set_for{$tbl}}, \%parts;
+   }
+
+   foreach my $tbl ( keys %rule_set_for ) {
+      $tbl_meta{$tbl}->{colors} = $rule_set_for{$tbl};
+      $tbl_meta{$tbl}->{color_func} = make_color_func($tbl_meta{$tbl});
+      $tbl_meta{$tbl}->{cust}->{colors} = 1;
+   }
+}
+
+# save_config_colors {{{3
+sub save_config_colors {
+   my $file = shift;
+   foreach my $tbl ( sort keys %tbl_meta ) {
+      my $meta = $tbl_meta{$tbl};
+      next unless $meta->{cust}->{colors};
+      foreach my $rule ( @{$meta->{colors}} ) {
+         print $file "$tbl=", join(
+            ' ',
+            map {
+               my $val = $rule->{$_};
+               $val =~ s/([\\'])/\\$1/g;  # Escape backslashes and single quotes
+               "$_='$val'";               # Enclose in single quotes
+            }
+            qw(col op arg color)
+         ), "\n";
+      }
+   }
+}
+
+# load_config_active_connections {{{3
+sub load_config_active_connections {
+   my ( $file ) = @_;
+   while ( my $line = <$file> ) {
+      chomp $line;
+      next if $line =~ m/^#/;
+      last if $line =~ m/^\[/;
+
+      my ( $key , $rest ) = $line =~ m/^(.*?)=(.*)$/;
+      next unless $key && exists $modes{$key};
+      my @parts = grep { exists $connections{$_} } split(/ /, $rest);
+      $modes{$key}->{connections} = [ @parts ] if exists $modes{$key};
+   }
+}
+
+# save_config_active_connections {{{3
+sub save_config_active_connections {
+   my $file = shift;
+   foreach my $mode ( sort keys %modes ) {
+      my @connections = get_connections($mode);
+      print $file "$mode=", join(' ', @connections), "\n";
+   }
+}
+
+# load_config_stmt_sleep_times {{{3
+sub load_config_stmt_sleep_times {
+   my ( $file ) = @_;
+   while ( my $line = <$file> ) {
+      chomp $line;
+      next if $line =~ m/^#/;
+      last if $line =~ m/^\[/;
+
+      my ( $key , $val ) = split('=', $line);
+      next unless $key && defined $val && $val =~ m/$num_regex/;
+      $stmt_sleep_time_for{$key} = $val;
+   }
+}
+
+# save_config_stmt_sleep_times {{{3
+sub save_config_stmt_sleep_times {
+   my $file = shift;
+   foreach my $key ( sort keys %stmt_sleep_time_for ) {
+      print $file "$key=$stmt_sleep_time_for{$key}\n";
+   }
+}
+
+# load_config_mvs {{{3
+sub load_config_mvs {
+   my ( $file ) = @_;
+   while ( my $line = <$file> ) {
+      chomp $line;
+      next if $line =~ m/^#/;
+      last if $line =~ m/^\[/;
+
+      my ( $key , $val ) = split('=', $line);
+      next unless $key && defined $val && $val =~ m/$num_regex/;
+      $mvs{$key} = $val;
+   }
+}
+
+# save_config_mvs {{{3
+sub save_config_mvs {
+   my $file = shift;
+   foreach my $key ( sort keys %mvs ) {
+      print $file "$key=$mvs{$key}\n";
+   }
+}
+
+# edit_configuration {{{3
+sub edit_configuration {
+   my $key = '';
+   while ( $key ne 'q' ) {
+      $clear_screen_sub->();
+      my @display_lines = '';
+
+      if ( $key && $cfg_editor_action{$key} ) {
+         $cfg_editor_action{$key}->{func}->();
+      }
+
+      # Show help
+      push @display_lines, create_caption('What configuration do you want to edit?',
+      create_table2(
+         [ sort keys %cfg_editor_action ],
+         { map { $_ => $_ } keys %cfg_editor_action },
+         { map { $_ => $cfg_editor_action{$_}->{note} } keys %cfg_editor_action },
+         { sep => '  ' }));
+
+      draw_screen(\@display_lines);
+      $key = pause('');
+   }
+}
+
+# edit_configuration_variables {{{3
+sub edit_configuration_variables {
+   $clear_screen_sub->();
+   my $mode = $config{mode}->{val};
+
+   my %config_choices
+      = map  { $_ => $config{$_}->{note} || '' }
+        # Only config values that are marked as applying to this mode.
+        grep {
+           my $key = $_;
+           $config{$key}->{conf} &&
+              ( $config{$key}->{conf} eq 'ALL'
+              || grep { $mode eq $_ } @{$config{$key}->{conf}} )
+        } keys %config;
+
+   my $key = prompt_list(
+      "Enter the name of the variable you wish to configure",
+      '',
+      sub{ return keys %config_choices },
+      \%config_choices);
+
+   if ( exists($config_choices{$key}) ) {
+      get_config_interactive($key);
+   }
+}
+
+# edit_color_rules {{{3
+sub edit_color_rules {
+   my ( $tbl ) = @_;
+   $clear_screen_sub->();
+   $tbl ||= choose_visible_table();
+   if ( $tbl && exists($tbl_meta{$tbl}) ) {
+      my $meta = $tbl_meta{$tbl};
+      my @cols = ('', qw(col op arg color));
+      my $info = { map { $_ => { hdr => $_, just => '-', } }  @cols };
+      $info->{label}->{maxw} = 30;
+      my $key;
+      my $selected_rule;
+
+      # This loop builds a tabular view of the rules.
+      do {
+
+         # Show help
+         if ( $key && $key eq '?' ) {
+            my @display_lines = '';
+            push @display_lines, create_caption('Editor key mappings',
+            create_table2(
+               [ sort keys %color_editor_action ],
+               { map { $_ => $_ } keys %color_editor_action },
+               { map { $_ => $color_editor_action{$_}->{note} } keys %color_editor_action },
+               { sep => '  ' }));
+            draw_screen(\@display_lines);
+            pause();
+            $key = '';
+         }
+         else {
+
+            # Do the action specified
+            $selected_rule ||= 0;
+            if ( $key && $color_editor_action{$key} ) {
+               $selected_rule = $color_editor_action{$key}->{func}->($tbl, $selected_rule);
+               $selected_rule ||= 0;
+            }
+
+            # Build the table of rules.  If the terminal has color, the selected rule
+            # will be highlighted; otherwise a > at the left will indicate.
+            my $data = $meta->{colors} || [];
+            foreach my $i ( 0..@$data - 1  ) {
+               $data->[$i]->{''} = $i == $selected_rule ? '>' : '';
+            }
+            my @display_lines = create_table(\@cols, $info, $data);
+
+            # Highlight selected entry
+            for my $i ( 0 .. $#display_lines ) {
+               if ( $display_lines[$i] =~ m/^>/ ) {
+                  $display_lines[$i] = [ $display_lines[$i], 'reverse' ];
+               }
+            }
+
+            # Draw the screen and wait for a command.
+            unshift @display_lines, '',
+               "Editing color rules for $meta->{capt}.  Press ? for help, q to "
+               . "quit.", '';
+            draw_screen(\@display_lines);
+            print "\n\n", word_wrap('Rules are applied in order from top to '
+               . 'bottom.  The first matching rule wins and prevents the '
+               . 'rest of the rules from being applied.');
+            $key = pause('');
+         }
+      } while ( $key ne 'q' );
+      $meta->{color_func} = make_color_func($meta);
+   }
+}
+
+# add_quick_filter {{{3
+sub add_quick_filter {
+   my $tbl = choose_visible_table();
+   if ( $tbl && exists($tbl_meta{$tbl}) ) {
+      print "\n";
+      my $response = prompt_list(
+         "Enter column name and filter text",
+         '',
+         sub { return keys %{$tbl_meta{$tbl}->{cols}} },
+         ()
+      );
+      my ( $col, $text ) = split(/\s+/, $response, 2);
+
+      # You can't filter on a nonexistent column.  But if you filter on a pivoted
+      # table, the columns are different, so on a pivoted table, allow filtering
+      # on the 'name' column.
+      # NOTE: if a table is pivoted and un-pivoted, this will likely cause crashes.
+      # Currently not an issue since there's no way to toggle pivot/nopivot.
+      return unless $col && $text &&
+         (exists($tbl_meta{$tbl}->{cols}->{$col})
+            || ($tbl_meta{$tbl}->{pivot} && $col eq 'name'));
+
+      my ( $sub, $err ) = compile_filter( "defined \$set->{$col} && \$set->{$col} =~ m/$text/" );
+      return if !$sub || $err;
+      my $name = "quick_$tbl.$col";
+      $filters{$name} = {
+         func  => $sub,
+         text  => $text,
+         user  => 1,
+         quick => 1,
+         name  => $name,
+         note  => 'Quick-filter',
+         tbls  => [$tbl],
+      };
+      push @{$tbl_meta{$tbl}->{filters}}, $name;
+   }
+}
+
+# clear_quick_filters {{{3
+sub clear_quick_filters {
+   my $tbl = choose_visible_table(
+      # Only tables that have quick-filters
+      sub {
+         my ( $tbl ) = @_;
+         return scalar grep { $filters{$_}->{quick} } @{ $tbl_meta{$tbl}->{filters} };
+      }
+   );
+   if ( $tbl && exists($tbl_meta{$tbl}) ) {
+      my @current = @{$tbl_meta{$tbl}->{filters}};
+      @current = grep { !$filters{$_}->{quick} } @current;
+      $tbl_meta{$tbl}->{filters} = \@current;
+   }
+}
+
+sub edit_plugins {
+   $clear_screen_sub->();
+
+   my @cols = ('', qw(class desc active));
+   my $info = { map { $_ => { hdr => $_, just => '-', } }  @cols };
+   my @rows = map { $plugins{$_} } sort keys %plugins;
+   my $key;
+   my $selected;
+
+   # This loop builds a tabular view of the plugins.
+   do {
+
+      # Show help
+      if ( $key && $key eq '?' ) {
+         my @display_lines = '';
+         push @display_lines, create_caption('Editor key mappings',
+         create_table2(
+            [ sort keys %plugin_editor_action ],
+            { map { $_ => $_ } keys %plugin_editor_action },
+            { map { $_ => $plugin_editor_action{$_}->{note} } keys %plugin_editor_action },
+            { sep => '  ' }));
+         draw_screen(\@display_lines);
+         pause();
+         $key = '';
+      }
+
+      # Do the action specified
+      else {
+         $selected ||= 0;
+         if ( $key && $plugin_editor_action{$key} ) {
+            $selected = $plugin_editor_action{$key}->{func}->(\@rows, $selected);
+            $selected ||= 0;
+         }
+
+         # Build the table of plugins.
+         foreach my $row ( 0.. $#rows ) {
+            $rows[$row]->{''} = $row eq $selected ? '>' : ' ';
+         }
+         my @display_lines = create_table(\@cols, $info, \@rows);
+
+         # Highlight selected entry
+         for my $i ( 0 .. $#display_lines ) {
+            if ( $display_lines[$i] =~ m/^>/ ) {
+               $display_lines[$i] = [ $display_lines[$i], 'reverse' ];
+            }
+         }
+
+         # Draw the screen and wait for a command.
+         unshift @display_lines, '',
+            "Plugin Management.  Press ? for help, q to quit.", '';
+         draw_screen(\@display_lines);
+         $key = pause('');
+      }
+   } while ( $key ne 'q' );
+}
+
+# edit_table {{{3
+sub edit_table {
+   $clear_screen_sub->();
+   my ( $tbl ) = @_;
+   $tbl ||= choose_visible_table();
+   if ( $tbl && exists($tbl_meta{$tbl}) ) {
+      my $meta = $tbl_meta{$tbl};
+      my @cols = ('', qw(name hdr label src));
+      my $info = { map { $_ => { hdr => $_, just => '-', } }  @cols };
+      $info->{label}->{maxw} = 30;
+      my $key;
+      my $selected_column;
+
+      # This loop builds a tabular view of the tbl_meta's structure, showing each column
+      # in the entry as a row.
+      do {
+
+         # Show help
+         if ( $key && $key eq '?' ) {
+            my @display_lines = '';
+            push @display_lines, create_caption('Editor key mappings',
+            create_table2(
+               [ sort keys %tbl_editor_action ],
+               { map { $_ => $_ } keys %tbl_editor_action },
+               { map { $_ => $tbl_editor_action{$_}->{note} } keys %tbl_editor_action },
+               { sep => '  ' }));
+            draw_screen(\@display_lines);
+            pause();
+            $key = '';
+         }
+         else {
+
+            # Do the action specified
+            $selected_column ||= $meta->{visible}->[0];
+            if ( $key && $tbl_editor_action{$key} ) {
+               $selected_column = $tbl_editor_action{$key}->{func}->($tbl, $selected_column);
+               $selected_column ||= $meta->{visible}->[0];
+            }
+
+            # Build the pivoted view of the table's meta-data.  If the terminal has color,
+            # The selected row will be highlighted; otherwise a > at the left will indicate.
+            my $data = [];
+            foreach my $row ( @{$meta->{visible}} ) {
+               my %hash;
+               @hash{ @cols } = @{$meta->{cols}->{$row}}{@cols};
+               $hash{src}  = '' if ref $hash{src};
+               $hash{name} = $row;
+               $hash{''}   = $row eq $selected_column ? '>' : ' ';
+               push @$data, \%hash;
+            }
+            my @display_lines = create_table(\@cols, $info, $data);
+
+            # Highlight selected entry
+            for my $i ( 0 .. $#display_lines ) {
+               if ( $display_lines[$i] =~ m/^>/ ) {
+                  $display_lines[$i] = [ $display_lines[$i], 'reverse' ];
+               }
+            }
+
+            # Draw the screen and wait for a command.
+            unshift @display_lines, '',
+               "Editing table definition for $meta->{capt}.  Press ? for help, q to quit.", '';
+            draw_screen(\@display_lines, { clear => 1 });
+            $key = pause('');
+         }
+      } while ( $key ne 'q' );
+   }
+}
+
+# choose_mode_tables {{{3
+# Choose which table(s), and in what order, to display in a given mode.
+sub choose_mode_tables {
+   my $mode = $config{mode}->{val};
+   my @tbls = @{$modes{$mode}->{visible_tables}};
+   my $new  = prompt_list(
+      "Choose tables to display",
+      join(' ', @tbls),
+      sub { return @{$modes{$mode}->{tables}} },
+      { map { $_ => $tbl_meta{$_}->{capt} } @{$modes{$mode}->{tables}} }
+   );
+   $modes{$mode}->{visible_tables} =
+      [ unique(grep { $_ && exists $tbl_meta{$_} } split(/\s+/, $new)) ];
+   $modes{$mode}->{cust}->{visible_tables} = 1;
+}
+
+# choose_visible_table {{{3
+sub choose_visible_table {
+   my ( $grep_cond ) = @_;
+   my $mode = $config{mode}->{val};
+   my @tbls
+      = grep { $grep_cond ? $grep_cond->($_) : 1 }
+        @{$modes{$mode}->{visible_tables}};
+   my $tbl = $tbls[0];
+   if ( @tbls > 1 ) {
+      $tbl = prompt_list(
+         "Choose a table",
+         '',
+         sub { return @tbls },
+         { map { $_ => $tbl_meta{$_}->{capt} } @tbls }
+      );
+   }
+   return $tbl;
+}
+
+sub toggle_aggregate {
+   my ( $tbl ) = @_;
+   $tbl ||= choose_visible_table();
+   return unless $tbl && exists $tbl_meta{$tbl};
+   my $meta = $tbl_meta{$tbl};
+   $meta->{aggregate} ^= 1;
+}
+
+sub choose_filters {
+   my ( $tbl ) = @_;
+   $tbl ||= choose_visible_table();
+   return unless $tbl && exists $tbl_meta{$tbl};
+   my $meta = $tbl_meta{$tbl};
+   $clear_screen_sub->();
+
+   print "Choose filters for $meta->{capt}:\n";
+
+   my $ini = join(' ', @{$meta->{filters}});
+   my $val = prompt_list(
+      'Choose filters',
+      $ini,
+      sub { return keys %filters },
+      {
+         map  { $_ => $filters{$_}->{note} }
+         grep { grep { $tbl eq $_ } @{$filters{$_}->{tbls}} }
+         keys %filters
+      }
+   );
+
+   my @choices = unique(split(/\s+/, $val));
+   foreach my $new ( grep { !exists($filters{$_}) } @choices ) {
+      my $answer = prompt("There is no filter called '$new'.  Create it?", undef, 'y');
+      if ( $answer eq 'y' ) {
+         create_new_filter($new, $tbl);
+      }
+   }
+   @choices = grep { exists $filters{$_} } @choices;
+   @choices = grep { grep { $tbl eq $_ } @{$filters{$_}->{tbls}} } @choices;
+   $meta->{filters} = [ @choices ];
+   $meta->{cust}->{filters} = 1;
+}
+
+sub choose_group_cols {
+   my ( $tbl ) = @_;
+   $tbl ||= choose_visible_table();
+   return unless $tbl && exists $tbl_meta{$tbl};
+   $clear_screen_sub->();
+   my $meta = $tbl_meta{$tbl};
+   my $curr = join(', ', @{$meta->{group_by}});
+   my $val = prompt_list(
+      'Group-by columns',
+      $curr,
+      sub { return keys %{$meta->{cols}} },
+      { map { $_ => $meta->{cols}->{$_}->{label} } keys %{$meta->{cols}} });
+   if ( $curr ne $val ) {
+      $meta->{group_by} = [ grep { exists $meta->{cols}->{$_} } $val =~ m/(\w+)/g ];
+      $meta->{cust}->{group_by} = 1;
+   }
+}
+
+sub choose_sort_cols {
+   my ( $tbl ) = @_;
+   $tbl ||= choose_visible_table();
+   return unless $tbl && exists $tbl_meta{$tbl};
+   $clear_screen_sub->();
+   my $meta = $tbl_meta{$tbl};
+
+   my ( $cols, $hints );
+   if ( $meta->{pivot} ) {
+      $cols  = sub { qw(name set_0) };
+      $hints = { name => 'name', set_0 => 'set_0' };
+   }
+   else {
+      $cols  = sub { return keys %{$meta->{cols}} };
+      $hints = { map { $_ => $meta->{cols}->{$_}->{label} } keys %{$meta->{cols}} };
+   }
+
+   my $val = prompt_list(
+      'Sort columns (reverse sort with -col)',
+      $meta->{sort_cols},
+      $cols,
+      $hints );
+   if ( $meta->{sort_cols} ne $val ) {
+      $meta->{sort_cols} = $val;
+      $meta->{cust}->{sort_cols} = 1;
+      $tbl_meta{$tbl}->{sort_func} = make_sort_func($tbl_meta{$tbl});
+   }
+}
+
+# create_new_filter {{{3
+sub create_new_filter {
+   my ( $filter, $tbl ) = @_;
+   $clear_screen_sub->();
+
+   if ( !$filter || $filter =~ m/\W/ ) {
+      print word_wrap("Choose a name for the filter.  This name is not displayed, and is only used "
+            . "for internal reference.  It can only contain lowercase letters, numbers, and underscores.");
+      print "\n\n";
+      do {
+         $filter = prompt("Enter filter name");
+      } while ( !$filter || $filter =~ m/\W/ );
+   }
+
+   my $completion = sub { keys %{$tbl_meta{$tbl}->{cols}} };
+   my ( $err, $sub, $body );
+   do {
+      $clear_screen_sub->();
+      print word_wrap("A filter is a Perl subroutine that accepts a hashref of columns "
+         . "called \$set, and returns a true value if the filter accepts the row.  Example:\n"
+         . "   \$set->{active_secs} > 5\n"
+         . "will only allow rows if their active_secs column is greater than 5.");
+      print "\n\n";
+      if ( $err ) {
+         print "There's an error in your filter expression: $err\n\n";
+      }
+      $body = prompt("Enter subroutine body", undef, undef, $completion);
+      ( $sub, $err ) = compile_filter($body);
+   } while ( $err );
+
+   $filters{$filter} = {
+      func => $sub,
+      text => $body,
+      user => 1,
+      name => $filter,
+      note => 'User-defined filter',
+      tbls => [$tbl],
+   };
+}
+
+# get_config_interactive {{{3
+sub get_config_interactive {
+   my $key = shift;
+   $clear_screen_sub->();
+
+   # Print help first.
+   print "Enter a new value for '$key' ($config{$key}->{note}).\n";
+
+   my $current = ref($config{$key}->{val}) ? join(" ", @{$config{$key}->{val}}) : $config{$key}->{val};
+
+   my $new_value = prompt('Enter a value', $config{$key}->{pat}, $current);
+   $config{$key}->{val} = $new_value;
+}
+
+sub edit_current_var_set {
+   my $mode = $config{mode}->{val};
+   my $name = $config{"${mode}_set"}->{val};
+   my $variables = $var_sets{$name}->{text};
+
+   my $new = $variables;
+   do {
+      $clear_screen_sub->();
+      $new = prompt("Enter variables for $name", undef, $variables);
+   } until ( $new );
+
+   if ( $new ne $variables ) {
+      @{$var_sets{$name}}{qw(text user)} = ( $new, 1);
+   }
+}
+
+
+sub choose_var_set {
+   my ( $key ) = @_;
+   $clear_screen_sub->();
+
+   my $new_value = prompt_list(
+      'Choose a set of values to display, or enter the name of a new one',
+      $config{$key}->{val},
+      sub { return keys %var_sets },
+      { map { $_ => $var_sets{$_}->{text} } keys %var_sets });
+
+   if ( !exists $var_sets{$new_value} ) {
+      add_new_var_set($new_value);
+   }
+
+   $config{$key}->{val} = $new_value if exists $var_sets{$new_value};
+}
+
+sub switch_var_set {
+   my ( $cfg_var, $dir ) = @_;
+   my @var_sets = sort keys %var_sets;
+   my $cur      = $config{$cfg_var}->{val};
+   my $pos      = grep { $_ lt $cur } @var_sets;
+   my $newpos   = ($pos + $dir) % @var_sets;
+   $config{$cfg_var}->{val} = $var_sets[$newpos];
+   $clear_screen_sub->();
+}
+
+# Online configuration and prompting functions {{{2
+
+# edit_stmt_sleep_times {{{3
+sub edit_stmt_sleep_times {
+   $clear_screen_sub->();
+   my $stmt = prompt_list('Specify a statement', '', sub { return sort keys %stmt_maker_for });
+   return unless $stmt && exists $stmt_maker_for{$stmt};
+   $clear_screen_sub->();
+   my $curr_val = $stmt_sleep_time_for{$stmt} || 0;
+   my $new_val  = prompt('Specify a sleep delay after calling this SQL', $num_regex, $curr_val);
+   if ( $new_val ) {
+      $stmt_sleep_time_for{$stmt} = $new_val;
+   }
+   else {
+      delete $stmt_sleep_time_for{$stmt};
+   }
+}
+
+# edit_server_groups {{{3
+# Choose which server connections are in a server group.  First choose a group,
+# then choose which connections are in it.
+sub edit_server_groups {
+   $clear_screen_sub->();
+   my $mode  = $config{mode}->{val};
+   my $group = $modes{$mode}->{server_group};
+   my %curr  = %server_groups;
+   my $new   = choose_or_create_server_group($group, 'to edit');
+   $clear_screen_sub->();
+   if ( exists $curr{$new} ) {
+      # Don't do this step if the user just created a new server group,
+      # because part of that process was to choose connections.
+      my $cxns  = join(' ', @{$server_groups{$new}});
+      my @conns = choose_or_create_connection($cxns, 'for this group');
+      $server_groups{$new} = \@conns;
+   }
+}
+
+# choose_server_groups {{{3
+sub choose_server_groups {
+   $clear_screen_sub->();
+   my $mode  = $config{mode}->{val};
+   my $group = $modes{$mode}->{server_group};
+   my $new   = choose_or_create_server_group($group, 'for this mode');
+   $modes{$mode}->{server_group} = $new if exists $server_groups{$new};
+}
+
+sub choose_or_create_server_group {
+   my ( $group, $prompt ) = @_;
+   my $new   = '';
+
+   my @available = sort keys %server_groups;
+
+   if ( @available ) {
+      print "You can enter the name of a new group to create it.\n";
+
+      $new = prompt_list(
+         "Choose a server group $prompt",
+         $group,
+         sub { return @available },
+         { map { $_ => join(' ', @{$server_groups{$_}}) } @available });
+
+      $new =~ s/\s.*//;
+
+      if ( !exists $server_groups{$new} ) {
+         my $answer = prompt("There is no server group called '$new'.  Create it?", undef, "y");
+         if ( $answer eq 'y' ) {
+            add_new_server_group($new);
+         }
+      }
+   }
+   else {
+      $new = add_new_server_group();
+   }
+   return $new;
+}
+
+sub choose_or_create_connection {
+   my ( $cxns, $prompt ) = @_;
+   print "You can enter the name of a new connection to create it.\n";
+
+   my @available = sort keys %connections;
+   my $new_cxns = prompt_list(
+      "Choose connections $prompt",
+      $cxns,
+      sub { return @available },
+      { map { $_ => $connections{$_}->{dsn} } @available });
+
+   my @new = unique(grep { !exists $connections{$_} } split(/\s+/, $new_cxns));
+   foreach my $new ( @new ) {
+      my $answer = prompt("There is no connection called '$new'.  Create it?", undef, "y");
+      if ( $answer eq 'y' ) {
+         add_new_dsn($new);
+      }
+   }
+
+   return unique(grep { exists $connections{$_} } split(/\s+/, $new_cxns));
+}
+
+# choose_servers {{{3
+sub choose_servers {
+   $clear_screen_sub->();
+   my $mode = $config{mode}->{val};
+   my $cxns = join(' ', get_connections());
+   my @chosen = choose_or_create_connection($cxns, 'for this mode');
+   $modes{$mode}->{connections} = \@chosen;
+   $modes{$mode}->{server_group} = ''; # Clear this because it overrides {connections}
+}
+
+# display_license {{{3
+sub display_license {
+   $clear_screen_sub->();
+
+   print $innotop_license;
+
+   pause();
+}
+
+# Data-retrieval functions {{{2
+# get_status_info {{{3
+# Get SHOW STATUS and SHOW VARIABLES together.
+sub get_status_info {
+   my @cxns = @_;
+   if ( !$info_gotten{status}++ ) {
+      foreach my $cxn ( @cxns ) {
+         $vars{$cxn}->{$clock} ||= {};
+         my $vars = $vars{$cxn}->{$clock};
+
+         my $sth = do_stmt($cxn, 'SHOW_STATUS') or next;
+         my $res = $sth->fetchall_arrayref();
+         map { $vars->{$_->[0]} = $_->[1] || 0 } @$res;
+
+         # Calculate hi-res uptime and add cxn to the hash.  This duplicates get_driver_status,
+         # but it's most important to have consistency.
+         $vars->{Uptime_hires} ||= get_uptime($cxn);
+         $vars->{cxn} = $cxn;
+
+         # Add SHOW VARIABLES to the hash
+         $sth = do_stmt($cxn, 'SHOW_VARIABLES') or next;
+         $res = $sth->fetchall_arrayref();
+         map { $vars->{$_->[0]} = $_->[1] || 0 } @$res;
+      }
+   }
+}
+
+# Chooses a thread for explaining, killing, etc...
+# First arg is a func that can be called in grep.
+sub choose_thread {
+   my ( $grep_cond, $prompt ) = @_;
+
+   # Narrow the list to queries that can be explained.
+   my %thread_for = map {
+      # Eliminate innotop's own threads.
+      $_ => $dbhs{$_}->{dbh} ? $dbhs{$_}->{dbh}->{mysql_thread_id} : 0
+   } keys %connections;
+
+   my @candidates = grep {
+      $_->{id} != $thread_for{$_->{cxn}} && $grep_cond->($_)
+   } @current_queries;
+   return unless @candidates;
+
+   # Find out which server.
+   my @cxns = unique map { $_->{cxn} } @candidates;
+   my ( $cxn ) = select_cxn('On which server', @cxns);
+   return unless $cxn && exists($connections{$cxn});
+
+   # Re-filter the list of candidates to only those on this server
+   @candidates = grep { $_->{cxn} eq $cxn } @candidates;
+
+   # Find out which thread to do.
+   my $info;
+   if ( @candidates > 1 ) {
+
+      # Sort longest-active first, then longest-idle.
+      my $sort_func = sub {
+         my ( $a, $b ) = @_;
+         return  $a->{query} && !$b->{query} ? 1
+               : $b->{query} && !$a->{query} ? -1
+               : ($a->{time} || 0) <=> ($b->{time} || 0);
+      };
+      my @threads = map { $_->{id} } reverse sort { $sort_func->($a, $b) } @candidates;
+
+      print "\n";
+      my $thread = prompt_list($prompt,
+         $threads[0],
+         sub { return @threads });
+      return unless $thread && $thread =~ m/$int_regex/;
+
+      # Find the info hash of that query on that server.
+      ( $info ) = grep { $thread == $_->{id} } @candidates;
+   }
+   else {
+      $info = $candidates[0];
+   }
+   return $info;
+}
+
+# analyze_query {{{3
+# Allows the user to show fulltext, explain, show optimized...
+sub analyze_query {
+   my ( $action ) = @_;
+
+   my $info = choose_thread(
+      sub { $_[0]->{query} },
+      'Select a thread to analyze',
+   );
+   return unless $info;
+
+   my %actions = (
+      e => \&display_explain,
+      f => \&show_full_query,
+      o => \&show_optimized_query,
+   );
+   do {
+      $actions{$action}->($info);
+      print "\n";
+      $action = pause('Press e to explain, f for full query, o for optimized query');
+   } while ( exists($actions{$action}) );
+}
+
+# inc {{{3
+# Returns the difference between two sets of variables/status/innodb stuff.
+sub inc {
+   my ( $offset, $cxn ) = @_;
+   my $vars = $vars{$cxn};
+   if ( $offset < 0 ) {
+      return $vars->{$clock};
+   }
+   elsif ( exists $vars{$clock - $offset} && !exists $vars->{$clock - $offset - 1} ) {
+      return $vars->{$clock - $offset};
+   }
+   my $cur = $vars->{$clock - $offset};
+   my $pre = $vars->{$clock - $offset - 1};
+   return {
+      # Numeric variables get subtracted, non-numeric get passed straight through.
+      map  {
+         $_ =>
+            ( (defined $cur->{$_} && $cur->{$_} =~ m/$num_regex/)
+            ?  $cur->{$_} - ($pre->{$_} || 0)
+            :  $cur->{$_} )
+      } keys %{$cur}
+   };
+}
+
+# extract_values {{{3
+# Arguments are a set of values (which may be incremental, derived from
+# current and previous), current, and previous values.
+# TODO: there are a few places that don't remember prev set so can't pass it.
+sub extract_values {
+   my ( $set, $cur, $pre, $tbl ) = @_;
+
+   # Hook in event listeners
+   foreach my $listener ( @{$event_listener_for{extract_values}} ) {
+      $listener->extract_values($set, $cur, $pre, $tbl);
+   }
+
+   my $result = {};
+   my $meta   = $tbl_meta{$tbl};
+   my $cols   = $meta->{cols};
+   foreach my $key ( keys %$cols ) {
+      my $info = $cols->{$key}
+         or die "Column '$key' doesn't exist in $tbl";
+      die "No func defined for '$key' in $tbl"
+         unless $info->{func};
+      eval {
+         $result->{$key} = $info->{func}->($set, $cur, $pre)
+      };
+      if ( $EVAL_ERROR ) {
+         if ( $config{debug}->{val} ) {
+            die $EVAL_ERROR;
+         }
+         $result->{$key} = $info->{num} ? 0 : '';
+      }
+   }
+   return $result;
+}
+
+# get_full_processlist {{{3
+sub get_full_processlist {
+   my @cxns = @_;
+   my @result;
+   foreach my $cxn ( @cxns ) {
+      my $stmt = do_stmt($cxn, 'PROCESSLIST') or next;
+      my $arr  = $stmt->fetchall_arrayref({});
+      push @result, map { $_->{cxn} = $cxn; $_ } @$arr;
+   }
+   return @result;
+}
+
+# get_open_tables {{{3
+sub get_open_tables {
+   my @cxns = @_;
+   my @result;
+   foreach my $cxn ( @cxns ) {
+      my $stmt = do_stmt($cxn, 'OPEN_TABLES') or next;
+      my $arr  = $stmt->fetchall_arrayref({});
+      push @result, map { $_->{cxn} = $cxn; $_ } @$arr;
+   }
+   return @result;
+}
+
+# get_innodb_status {{{3
+sub get_innodb_status {
+   my ( $cxns, $addl_sections ) = @_;
+   if ( !$config{skip_innodb}->{val} && !$info_gotten{innodb_status}++ ) {
+
+      # Determine which sections need to be parsed
+      my %sections_required =
+         map  { $tbl_meta{$_}->{innodb} => 1 }
+         grep { $_ && $tbl_meta{$_}->{innodb} }
+         get_visible_tables();
+
+      # Add in any other sections the caller requested.
+      foreach my $sec ( @$addl_sections ) {
+         $sections_required{$sec} = 1;
+      }
+
+      foreach my $cxn ( @$cxns ) {
+         my $innodb_status_text;
+
+         if ( $file ) { # Try to fetch status text from the file.
+            my @stat = stat($file);
+
+            # Initialize the file.
+            if ( !$file_mtime ) {
+               # Initialize to 130k from the end of the file (because the limit
+               # on the size of innodb status is 128k even with Google's patches)
+               # and try to grab the last status from the file.
+               sysseek($file, (-128 * 1_024), 2);
+            }
+
+            # Read from the file.
+            my $buffer;
+            if ( !$file_mtime || $file_mtime != $stat[9] ) {
+               $file_data = '';
+               while ( sysread($file, $buffer, 4096) ) {
+                  $file_data .= $buffer;
+               }
+               $file_mtime = $stat[9];
+            }
+
+            # Delete everything but the last InnoDB status text from the file.
+            $file_data =~ s/\A.*(?=^=====================================\n...... ........ INNODB MONITOR OUTPUT)//ms;
+            $innodb_status_text = $file_data;
+         }
+
+         else {
+            my $stmt = do_stmt($cxn, 'INNODB_STATUS') or next;
+            $innodb_status_text = $stmt->fetchrow_hashref()->{status};
+         }
+
+         next unless $innodb_status_text
+            && substr($innodb_status_text, 0, 100) =~ m/INNODB MONITOR OUTPUT/;
+
+         # Parse and merge into %vars storage
+         my %innodb_status = (
+            $innodb_parser->get_status_hash(
+               $innodb_status_text,
+               $config{debug}->{val},
+               \%sections_required,
+               0, # don't parse full lock information
+            )
+         );
+         if ( !$innodb_status{IB_got_all} && $config{auto_wipe_dl}->{val} ) {
+            clear_deadlock($cxn);
+         }
+
+         # Merge using a hash slice, which is the fastest way
+         $vars{$cxn}->{$clock} ||= {};
+         my $hash = $vars{$cxn}->{$clock};
+         @{$hash}{ keys %innodb_status } = values %innodb_status;
+         $hash->{cxn} = $cxn;
+         $hash->{Uptime_hires} ||= get_uptime($cxn);
+      }
+   }
+}
+
+# clear_deadlock {{{3
+sub clear_deadlock {
+   my ( $cxn ) = @_;
+   return if $clearing_deadlocks++;
+   my $tbl = $connections{$cxn}->{dl_table};
+   return unless $tbl;
+
+   eval {
+      # Set up the table for creating a deadlock.
+      my $engine = version_ge($dbhs{$cxn}->{dbh}, '4.1.2') ? 'engine' : 'type';
+      return unless do_query($cxn, "drop table if exists $tbl");
+      return unless do_query($cxn, "create table $tbl(a int) $engine=innodb");
+      return unless do_query($cxn, "delete from $tbl");
+      return unless do_query($cxn, "insert into $tbl(a) values(0), (1)");
+      return unless do_query($cxn, "commit"); # Or the children will block against the parent
+
+      # Fork off two children to deadlock against each other.
+      my %children;
+      foreach my $child ( 0..1 ) {
+         my $pid = fork();
+         if ( defined($pid) && $pid == 0 ) { # I am a child
+            deadlock_thread( $child, $tbl, $cxn );
+         }
+         elsif ( !defined($pid) ) {
+            die("Unable to fork for clearing deadlocks!\n");
+         }
+         # I already exited if I'm a child, so I'm the parent.
+         $children{$child} = $pid;
+      }
+
+      # Wait for the children to exit.
+      foreach my $child ( keys %children ) {
+         my $pid = waitpid($children{$child}, 0);
+      }
+
+      # Clean up.
+      do_query($cxn, "drop table $tbl");
+   };
+   if ( $EVAL_ERROR ) {
+      print $EVAL_ERROR;
+      pause();
+   }
+
+   $clearing_deadlocks = 0;
+}
+
+sub get_master_logs {
+   my @cxns = @_;
+   my @result;
+   if ( !$info_gotten{master_logs}++ ) {
+      foreach my $cxn ( @cxns ) {
+         my $stmt = do_stmt($cxn, 'SHOW_MASTER_LOGS') or next;
+         push @result, @{$stmt->fetchall_arrayref({})};
+      }
+   }
+   return @result;
+}
+
+# get_master_slave_status {{{3
+sub get_master_slave_status {
+   my @cxns = @_;
+   if ( !$info_gotten{replication_status}++ ) {
+      foreach my $cxn ( @cxns ) {
+         $vars{$cxn}->{$clock} ||= {};
+         my $vars = $vars{$cxn}->{$clock};
+         $vars->{cxn} = $cxn;
+
+         my $stmt = do_stmt($cxn, 'SHOW_MASTER_STATUS') or next;
+         my $res = $stmt->fetchall_arrayref({})->[0];
+         @{$vars}{ keys %$res } = values %$res;
+         $stmt = do_stmt($cxn, 'SHOW_SLAVE_STATUS') or next;
+         $res = $stmt->fetchall_arrayref({})->[0];
+         @{$vars}{ keys %$res } = values %$res;
+         $vars->{Uptime_hires} ||= get_uptime($cxn);
+      }
+   }
+}
+
+sub is_func {
+   my ( $word ) = @_;
+   return defined(&$word)
+      || eval "my \$x= sub { $word  }; 1"
+      || $EVAL_ERROR !~ m/^Bareword/;
+}
+
+# Documentation {{{1
+# ############################################################################
+# I put this last as per the Dog book.
+# ############################################################################
+=pod
+
+=head1 NAME
+
+innotop - MySQL and InnoDB transaction/status monitor.
+
+=head1 SYNOPSIS
+
+To monitor servers normally:
+
+ innotop
+
+To monitor InnoDB status information from a file:
+
+ innotop /var/log/mysql/mysqld.err
+
+To run innotop non-interactively in a pipe-and-filter configuration:
+
+ innotop --count 5 -d 1 -n
+
+To monitor a database on another system using a particular username and password:
+
+ innotop -u <username> -p <password> -h <hostname>
+
+=head1 DESCRIPTION
+
+innotop monitors MySQL servers.  Each of its modes shows you a different aspect
+of what's happening in the server.  For example, there's a mode for monitoring
+replication, one for queries, and one for transactions.  innotop refreshes its
+data periodically, so you see an updating view.
+
+innotop has lots of features for power users, but you can start and run it with
+virtually no configuration.  If you're just getting started, see
+L<"QUICK-START">.  Press '?' at any time while running innotop for
+context-sensitive help.
+
+=head1 QUICK-START
+
+To start innotop, open a terminal or command prompt.  If you have installed
+innotop on your system, you should be able to just type "innotop" and press
+Enter; otherwise, you will need to change to innotop's directory and type "perl
+innotop".
+
+With no options specified, innotop will attempt to connect to a MySQL server on
+localhost using mysql_read_default_group=client for other connection
+parameters.  If you need to specify a different username and password, use the
+-u and -p options, respectively.  To monitor a MySQL database on another
+host, use the -h option.
+
+After you've connected, innotop should show you something like the following:
+
+ [RO] Query List (? for help) localhost, 01:11:19, 449.44 QPS, 14/7/163 con/run
+ 
+ CXN        When   Load  QPS    Slow  QCacheHit  KCacheHit  BpsIn    BpsOut 
+ localhost  Total  0.00  1.07k   697      0.00%     98.17%  476.83k  242.83k
+
+ CXN        Cmd    ID         User  Host      DB   Time   Query
+ localhost  Query  766446598  test  10.0.0.1  foo  00:02  INSERT INTO table (
+
+
+(This sample is truncated at the right so it will fit on a terminal when running
+'man innotop')
+
+If your server is busy, you'll see more output.  Notice the first line on the
+screen, which tells you that readonly is set to true ([RO]), what mode you're
+in and what server you're connected to.  You can change to other modes with
+keystrokes; press 'T' to switch to a list of InnoDB transactions, for example.
+
+Press the '?' key to see what keys are active in the current mode.  You can
+press any of these keys and innotop will either take the requested action or
+prompt you for more input.  If your system has Term::ReadLine support, you can
+use TAB and other keys to auto-complete and edit input.
+
+To quit innotop, press the 'q' key.
+
+=head1 OPTIONS
+
+innotop is mostly configured via its configuration file, but some of the
+configuration options can come from the command line.  You can also specify a
+file to monitor for InnoDB status output; see L<"MONITORING A FILE"> for more
+details.
+
+You can negate some options by prefixing the option name with --no.  For
+example, --noinc (or --no-inc) negates L<"--inc">.
+
+=over
+
+=item --color
+
+Enable or disable terminal coloring.  Corresponds to the L<"color"> config file
+setting.
+
+=item --config
+
+Specifies a configuration file to read.  This option is non-sticky, that is to
+say it does not persist to the configuration file itself.
+
+=item --count
+
+Refresh only the specified number of times (ticks) before exiting.  Each refresh
+is a pause for L<"interval"> seconds, followed by requesting data from MySQL
+connections and printing it to the terminal.
+
+=item --delay
+
+Specifies the amount of time to pause between ticks (refreshes).  Corresponds to
+the configuration option L<"interval">.
+
+=item --help
+
+Print a summary of command-line usage and exit.
+
+=item --host
+
+Host to connect to.
+
+=item --inc
+
+Specifies whether innotop should display absolute numbers or relative numbers
+(offsets from their previous values).  Corresponds to the configuration option
+L<"status_inc">.
+
+=item --mode
+
+Specifies the mode in which innotop should start.  Corresponds to the
+configuration option L<"mode">.
+
+=item --nonint
+
+Enable non-interactive operation.  See L<"NON-INTERACTIVE OPERATION"> for more.
+
+=item --password
+
+Password to use for connection.
+
+=item --port
+
+Port to use for connection.
+
+=item --skipcentral
+
+Don't read the central configuration file.
+
+=item --user
+
+User to use for connection.
+
+=item --version
+
+Output version information and exit.
+
+=item --write
+
+Sets the configuration option L<"readonly"> to 0, making innotop write the
+running configuration to ~/.innotop/innotop.conf on exit, if no configuration
+file was loaded at start-up.
+
+=back
+
+=head1 HOTKEYS
+
+innotop is interactive, and you control it with key-presses.
+
+=over
+
+=item *
+
+Uppercase keys switch between modes.
+
+=item *
+
+Lowercase keys initiate some action within the current mode.
+
+=item *
+
+Other keys do something special like change configuration or show the
+innotop license.
+
+=back
+
+Press '?' at any time to see the currently active keys and what they do.
+
+=head1 MODES
+
+Each of innotop's modes retrieves and displays a particular type of data from
+the servers you're monitoring.  You switch between modes with uppercase keys.
+The following is a brief description of each mode, in alphabetical order.  To
+switch to the mode, press the key listed in front of its heading in the
+following list:
+
+=over
+
+=item B: InnoDB Buffers
+
+This mode displays information about the InnoDB buffer pool, page statistics,
+insert buffer, and adaptive hash index.  The data comes from SHOW INNODB STATUS.
+
+This mode contains the L<"buffer_pool">, L<"page_statistics">,
+L<"insert_buffers">, and L<"adaptive_hash_index"> tables by default.
+
+=item C: Command Summary
+
+This mode is similar to mytop's Command Summary mode.  It shows the
+L<"cmd_summary"> table, which looks something like the following:
+
+ Command Summary (? for help) localhost, 25+07:16:43, 2.45 QPS, 3 thd, 5.0.40
+ _____________________ Command Summary _____________________
+ Name                    Value    Pct     Last Incr  Pct    
+ Select_scan             3244858  69.89%          2  100.00%
+ Select_range            1354177  29.17%          0    0.00%
+ Select_full_join          39479   0.85%          0    0.00%
+ Select_full_range_join     4097   0.09%          0    0.00%
+ Select_range_check            0   0.00%          0    0.00%
+
+The command summary table is built by extracting variables from
+L<"STATUS_VARIABLES">.  The variables must be numeric and must match the prefix
+given by the L<"cmd_filter"> configuration variable.  The variables are then
+sorted by value descending and compared to the last variable, as shown above.
+The percentage columns are percentage of the total of all variables in the
+table, so you can see the relative weight of the variables.
+
+The example shows what you see if the prefix is "Select_".  The default
+prefix is "Com_".  You can choose a prefix with the 's' key.
+
+It's rather like running SHOW VARIABLES LIKE "prefix%" with memory and
+nice formatting.
+
+Values are aggregated across all servers.  The Pct columns are not correctly
+aggregated across multiple servers.  This is a known limitation of the grouping
+algorithm that may be fixed in the future.
+
+=item D: InnoDB Deadlocks
+
+This mode shows the transactions involved in the last InnoDB deadlock.  A second
+table shows the locks each transaction held and waited for.  A deadlock is
+caused by a cycle in the waits-for graph, so there should be two locks held and
+one waited for unless the deadlock information is truncated.
+
+InnoDB puts deadlock information before some other information in the SHOW
+INNODB STATUS output.  If there are a lot of locks, the deadlock information can
+grow very large, and there is a limit on the size of the SHOW INNODB
+STATUS output.  A large deadlock can fill the entire output, or even be
+truncated, and prevent you from seeing other information at all.  If you are
+running innotop in another mode, for example T mode, and suddenly you don't see
+anything, you might want to check and see if a deadlock has wiped out the data
+you need.
+
+If it has, you can create a small deadlock to replace the large one.  Use the
+'w' key to 'wipe' the large deadlock with a small one.  This will not work
+unless you have defined a deadlock table for the connection (see L<"SERVER
+CONNECTIONS">).
+
+You can also configure innotop to automatically detect when a large deadlock
+needs to be replaced with a small one (see L<"auto_wipe_dl">).
+
+This mode displays the L<"deadlock_transactions"> and L<"deadlock_locks"> tables
+by default.
+
+=item F: InnoDB Foreign Key Errors
+
+This mode shows the last InnoDB foreign key error information, such as the
+table where it happened, when and who and what query caused it, and so on.
+
+InnoDB has a huge variety of foreign key error messages, and many of them are
+just hard to parse.  innotop doesn't always do the best job here, but there's
+so much code devoted to parsing this messy, unparseable output that innotop is
+likely never to be perfect in this regard.  If innotop doesn't show you what
+you need to see, just look at the status text directly.
+
+This mode displays the L<"fk_error"> table by default.
+
+=item I: InnoDB I/O Info
+
+This mode shows InnoDB's I/O statistics, including the I/O threads, pending I/O,
+file I/O miscellaneous, and log statistics.  It displays the L<"io_threads">,
+L<"pending_io">, L<"file_io_misc">, and L<"log_statistics"> tables by default.
+
+=item L: Locks
+
+This mode shows information about current locks.  At the moment only InnoDB
+locks are supported, and by default you'll only see locks for which transactions
+are waiting.  This information comes from the TRANSACTIONS section of the InnoDB
+status text.  If you have a very busy server, you may have frequent lock waits;
+it helps to be able to see which tables and indexes are the "hot spot" for
+locks.  If your server is running pretty well, this mode should show nothing.
+
+You can configure MySQL and innotop to monitor not only locks for which a
+transaction is waiting, but those currently held, too.  You can do this with the
+InnoDB Lock Monitor (L<http://dev.mysql.com/doc/en/innodb-monitor.html>).  It's
+not documented in the MySQL manual, but creating the lock monitor with the
+following statement also affects the output of SHOW INNODB STATUS, which innotop
+uses:
+
+  CREATE TABLE innodb_lock_monitor(a int) ENGINE=INNODB;
+
+This causes InnoDB to print its output to the MySQL file every 16 seconds or so,
+as stated in the manual, but it also makes the normal SHOW INNODB STATUS output
+include lock information, which innotop can parse and display (that's the
+undocumented feature).
+
+This means you can do what may have seemed impossible: to a limited extent
+(InnoDB truncates some information in the output), you can see which transaction
+holds the locks something else is waiting for.  You can also enable and disable
+the InnoDB Lock Monitor with the key mappings in this mode.
+
+This mode displays the L<"innodb_locks"> table by default.  Here's a sample of
+the screen when one connection is waiting for locks another connection holds:
+
+ _________________________________ InnoDB Locks __________________________
+ CXN        ID  Type    Waiting  Wait   Active  Mode  DB    Table  Index
+ localhost  12  RECORD        1  00:10   00:10  X     test  t1     PRIMARY
+ localhost  12  TABLE         0  00:10   00:10  IX    test  t1
+ localhost  12  RECORD        1  00:10   00:10  X     test  t1     PRIMARY
+ localhost  11  TABLE         0  00:00   00:25  IX    test  t1
+ localhost  11  RECORD        0  00:00   00:25  X     test  t1     PRIMARY
+
+You can see the first connection, ID 12, is waiting for a lock on the PRIMARY
+key on test.t1, and has been waiting for 10 seconds.  The second connection
+isn't waiting, because the Waiting column is 0, but it holds locks on the same
+index.  That tells you connection 11 is blocking connection 12.
+
+=item M: Master/Slave Replication Status
+
+This mode shows the output of SHOW SLAVE STATUS and SHOW MASTER STATUS in three
+tables.  The first two divide the slave's status into SQL and I/O thread status,
+and the last shows master status.  Filters are applied to eliminate non-slave
+servers from the slave tables, and non-master servers from the master table.
+
+This mode displays the L<"slave_sql_status">, L<"slave_io_status">, and
+L<"master_status"> tables by default.
+
+=item O: Open Tables
+
+This section comes from MySQL's SHOW OPEN TABLES command.  By default it is
+filtered to show tables which are in use by one or more queries, so you can
+get a quick look at which tables are 'hot'.  You can use this to guess which
+tables might be locked implicitly.
+
+This mode displays the L<"open_tables"> mode by default.
+
+=item Q: Query List
+
+This mode displays the output from SHOW FULL PROCESSLIST, much like B<mytop>'s
+query list mode.  This mode does B<not> show InnoDB-related information.  This
+is probably one of the most useful modes for general usage.
+
+There is an informative header that shows general status information about
+your server.  You can toggle it on and off with the 'h' key.  By default,
+innotop hides inactive processes and its own process.  You can toggle these on
+and off with the 'i' and 'a' keys.
+
+You can EXPLAIN a query from this mode with the 'e' key.  This displays the
+query's full text, the results of EXPLAIN, and in newer MySQL versions, even
+the optimized query resulting from EXPLAIN EXTENDED.  innotop also tries to
+rewrite certain queries to make them EXPLAIN-able.  For example, INSERT/SELECT
+statements are rewritable.
+
+This mode displays the L<"q_header"> and L<"processlist"> tables by default.
+
+=item R: InnoDB Row Operations and Semaphores
+
+This mode shows InnoDB row operations, row operation miscellaneous, semaphores,
+and information from the wait array.  It displays the L<"row_operations">,
+L<"row_operation_misc">, L<"semaphores">, and L<"wait_array"> tables by default.
+
+=item S: Variables & Status
+
+This mode calculates statistics, such as queries per second, and prints them out
+in several different styles.  You can show absolute values, or incremental values
+between ticks.
+
+You can switch between the views by pressing a key.  The 's' key prints a
+single line each time the screen updates, in the style of B<vmstat>.  The 'g'
+key changes the view to a graph of the same numbers, sort of like B<tload>.
+The 'v' key changes the view to a pivoted table of variable names on the left,
+with successive updates scrolling across the screen from left to right.  You can
+choose how many updates to put on the screen with the L<"num_status_sets">
+configuration variable.
+
+Headers may be abbreviated to fit on the screen in interactive operation.  You
+choose which variables to display with the 'c' key, which selects from
+predefined sets, or lets you create your own sets.  You can edit the current set
+with the 'e' key.
+
+This mode doesn't really display any tables like other modes.  Instead, it uses
+a table definition to extract and format the data, but it then transforms the
+result in special ways before outputting it.  It uses the L<"var_status"> table
+definition for this.
+
+=item T: InnoDB Transactions
+
+This mode shows transactions from the InnoDB monitor's output, in B<top>-like
+format.  This mode is the reason I wrote innotop.
+
+You can kill queries or processes with the 'k' and 'x' keys, and EXPLAIN a query
+with the 'e' or 'f' keys.  InnoDB doesn't print the full query in transactions,
+so explaining may not work right if the query is truncated.
+
+The informational header can be toggled on and off with the 'h' key.  By
+default, innotop hides inactive transactions and its own transaction.  You can
+toggle this on and off with the 'i' and 'a' keys.
+
+This mode displays the L<"t_header"> and L<"innodb_transactions"> tables by
+default.
+
+=back
+
+=head1 INNOTOP STATUS
+
+The first line innotop displays is a "status bar" of sorts.  What it contains
+depends on the mode you're in, and what servers you're monitoring.  The first
+few words are always [RO] (if readonly is set to 1), the innotop mode, such as
+"InnoDB Txns" for T mode, followed by a reminder to press '?' for help at any
+time.
+
+=head2 ONE SERVER
+
+The simplest case is when you're monitoring a single server.  In this case, the
+name of the connection is next on the status line.  This is the name you gave
+when you created the connection -- most likely the MySQL server's hostname.
+This is followed by the server's uptime.
+
+If you're in an InnoDB mode, such as T or B, the next word is "InnoDB" followed
+by some information about the SHOW INNODB STATUS output used to render the
+screen.  The first word is the number of seconds since the last SHOW INNODB
+STATUS, which InnoDB uses to calculate some per-second statistics.  The next is
+a smiley face indicating whether the InnoDB output is truncated.  If the smiley
+face is a :-), all is well; there is no truncation.  A :^| means the transaction
+list is so long, InnoDB has only printed out some of the transactions.  Finally,
+a frown :-( means the output is incomplete, which is probably due to a deadlock
+printing too much lock information (see L<"D: InnoDB Deadlocks">).
+
+The next two words indicate the server's queries per second (QPS) and how many
+threads (connections) exist.  Finally, the server's version number is the last
+thing on the line.
+
+=head2 MULTIPLE SERVERS
+
+If you are monitoring multiple servers (see L<"SERVER CONNECTIONS">), the status
+line does not show any details about individual servers.  Instead, it shows the
+names of the connections that are active.  Again, these are connection names you
+specified, which are likely to be the server's hostname.  A connection that has
+an error is prefixed with an exclamation point.
+
+If you are monitoring a group of servers (see L<"SERVER GROUPS">), the status
+line shows the name of the group.  If any connection in the group has an
+error, the group's name is followed by the fraction of the connections that
+don't have errors.
+
+See L<"ERROR HANDLING"> for more details about innotop's error handling.
+
+=head2 MONITORING A FILE
+
+If you give a filename on the command line, innotop will not connect to ANY
+servers at all.  It will watch the specified file for InnoDB status output and
+use that as its data source.  It will always show a single connection called
+'file'.  And since it can't connect to a server, it can't determine how long the
+server it's monitoring has been up; so it calculates the server's uptime as time
+since innotop started running.
+
+=head1 SERVER ADMINISTRATION
+
+While innotop is primarily a monitor that lets you watch and analyze your
+servers, it can also send commands to servers.  The most frequently useful
+commands are killing queries and stopping or starting slaves.
+
+You can kill a connection, or in newer versions of MySQL kill a query but not a
+connection, from L<"Q: Query List"> and L<"T: InnoDB Transactions"> modes.
+Press 'k' to issue a KILL command, or 'x' to issue a KILL QUERY command.
+innotop will prompt you for the server and/or connection ID to kill (innotop
+does not prompt you if there is only one possible choice for any input).
+innotop pre-selects the longest-running query, or the oldest connection.
+Confirm the command with 'y'.
+
+In L<"M: Master/Slave Replication Status"> mode, you can start and stop slaves
+with the 'a' and 'o' keys, respectively.  You can send these commands to many
+slaves at once.  innotop fills in a default command of START SLAVE or STOP SLAVE
+for you, but you can actually edit the command and send anything you wish, such
+as SET GLOBAL SQL_SLAVE_SKIP_COUNTER=1 to make the slave skip one binlog event
+when it starts.
+
+You can also ask innotop to calculate the earliest binlog in use by any slave
+and issue a PURGE MASTER LOGS on the master.  Use the 'b' key for this.  innotop
+will prompt you for a master to run the command on, then prompt you for the
+connection names of that master's slaves (there is no way for innotop to
+determine this reliably itself).  innotop will find the minimum binlog in use by
+these slave connections and suggest it as the argument to PURGE MASTER LOGS.
+
+=head1 SERVER CONNECTIONS
+
+When you create a server connection using '@', innotop asks you for a series of
+inputs, as follows:
+
+=over
+
+=item DSN
+
+A DSN is a Data Source Name, which is the initial argument passed to the DBI
+module for connecting to a server.  It is usually of the form
+
+ DBI:mysql:;mysql_read_default_group=mysql;host=HOSTNAME
+
+Since this DSN is passed to the DBD::mysql driver, you should read the driver's
+documentation at L<"http://search.cpan.org/dist/DBD-mysql/lib/DBD/mysql.pm"> for
+the exact details on all the options you can pass the driver in the DSN.  You
+can read more about DBI at L<http://dbi.perl.org/docs/>, and especially at
+L<http://search.cpan.org/~timb/DBI/DBI.pm>.
+
+The mysql_read_default_group=mysql option lets the DBD driver read your MySQL
+options files, such as ~/.my.cnf on UNIX-ish systems.  You can use this to avoid
+specifying a username or password for the connection.
+
+=item InnoDB Deadlock Table
+
+This optional item tells innotop a table name it can use to deliberately create
+a small deadlock (see L<"D: InnoDB Deadlocks">).  If you specify this option,
+you just need to be sure the table doesn't exist, and that innotop can create
+and drop the table with the InnoDB storage engine.  You can safely omit or just
+accept the default if you don't intend to use this.
+
+=item Username
+
+innotop will ask you if you want to specify a username.  If you say 'y', it will
+then prompt you for a user name.  If you have a MySQL option file that specifies
+your username, you don't have to specify a username.
+
+The username defaults to your login name on the system you're running innotop on.
+
+=item Password
+
+innotop will ask you if you want to specify a password.  Like the username, the
+password is optional, but there's an additional prompt that asks if you want to
+save the password in the innotop configuration file.  If you don't save it in
+the configuration file, innotop will prompt you for a password each time it
+starts.  Passwords in the innotop configuration file are saved in plain text,
+not encrypted in any way.
+
+=back
+
+Once you finish answering these questions, you should be connected to a server.
+But innotop isn't limited to monitoring a single server; you can define many
+server connections and switch between them by pressing the '@' key.  See
+L<"SWITCHING BETWEEN CONNECTIONS">.
+
+=head1 SERVER GROUPS
+
+If you have multiple MySQL instances, you can put them into named groups, such
+as 'all', 'masters', and 'slaves', which innotop can monitor all together.
+
+You can choose which group to monitor with the '#' key, and you can press the
+TAB key to switch to the next group.  If you're not currently monitoring a
+group, pressing TAB selects the first group.
+
+To create a group, press the '#' key and type the name of your new group, then
+type the names of the connections you want the group to contain.
+
+=head1 SWITCHING BETWEEN CONNECTIONS
+
+innotop lets you quickly switch which servers you're monitoring.  The most basic
+way is by pressing the '@' key and typing the name(s) of the connection(s) you
+want to use.  This setting is per-mode, so you can monitor different connections
+in each mode, and innotop remembers which connections you choose.
+
+You can quickly switch to the 'next' connection in alphabetical order with the
+'n' key.  If you're monitoring a server group (see L<"SERVER GROUPS">) this will
+switch to the first connection.
+
+You can also type many connection names, and innotop will fetch and display data
+from them all.  Just separate the connection names with spaces, for example
+"server1 server2."  Again, if you type the name of a connection that doesn't
+exist, innotop will prompt you for connection information and create the
+connection.
+
+Another way to monitor multiple connections at once is with server groups.  You
+can use the TAB key to switch to the 'next' group in alphabetical order, or if
+you're not monitoring any groups, TAB will switch to the first group.
+
+innotop does not fetch data in parallel from connections, so if you are
+monitoring a large group or many connections, you may notice increased delay
+between ticks.
+
+When you monitor more than one connection, innotop's status bar changes.  See
+L<"INNOTOP STATUS">.
+
+=head1 ERROR HANDLING
+
+Error handling is not that important when monitoring a single connection, but is
+crucial when you have many active connections.  A crashed server or lost
+connection should not crash innotop.  As a result, innotop will continue to run
+even when there is an error; it just won't display any information from the
+connection that had an error.  Because of this, innotop's behavior might confuse
+you.  It's a feature, not a bug!
+
+innotop does not continue to query connections that have errors, because they
+may slow innotop and make it hard to use, especially if the error is a problem
+connecting and causes a long time-out.  Instead, innotop retries the connection
+occasionally to see if the error still exists.  If so, it will wait until some
+point in the future.  The wait time increases in ticks as the Fibonacci series,
+so it tries less frequently as time passes.
+
+Since errors might only happen in certain modes because of the SQL commands
+issued in those modes, innotop keeps track of which mode caused the error.  If
+you switch to a different mode, innotop will retry the connection instead of
+waiting.
+
+By default innotop will display the problem in red text at the bottom of the
+first table on the screen.  You can disable this behavior with the
+L<"show_cxn_errors_in_tbl"> configuration option, which is enabled by default.
+If the L<"debug"> option is enabled, innotop will display the error at the
+bottom of every table, not just the first.  And if L<"show_cxn_errors"> is
+enabled, innotop will print the error text to STDOUT as well.  Error messages
+might only display in the mode that caused the error, depending on the mode and
+whether innotop is avoiding querying that connection.
+
+=head1 NON-INTERACTIVE OPERATION
+
+You can run innotop in non-interactive mode, in which case it is entirely
+controlled from the configuration file and command-line options.  To start
+innotop in non-interactive mode, give the L"<--nonint"> command-line option.
+This changes innotop's behavior in the following ways:
+
+=over
+
+=item *
+
+Certain Perl modules are not loaded.  Term::Readline is not loaded, since
+innotop doesn't prompt interactively.  Term::ANSIColor and Win32::Console::ANSI
+modules are not loaded.  Term::ReadKey is still used, since innotop may have to
+prompt for connection passwords when starting up.
+
+=item *
+
+innotop does not clear the screen after each tick.
+
+=item *
+
+innotop does not persist any changes to the configuration file.
+
+=item *
+
+If L<"--count"> is given and innotop is in incremental mode (see L<"status_inc">
+and L<"--inc">), innotop actually refreshes one more time than specified so it
+can print incremental statistics.  This suppresses output during the first
+tick, so innotop may appear to hang.
+
+=item *
+
+innotop only displays the first table in each mode.  This is so the output can
+be easily processed with other command-line utilities such as awk and sed.  To
+change which tables display in each mode, see L<"TABLES">.  Since L<"Q: Query
+List"> mode is so important, innotop automatically disables the L<"q_header">
+table.  This ensures you'll see the L<"processlist"> table, even if you have
+innotop configured to show the q_header table during interactive operation.
+Similarly, in L<"T: InnoDB Transactions"> mode, the L<"t_header"> table is
+suppressed so you see only the L<"innodb_transactions"> table.
+
+=item *
+
+All output is tab-separated instead of being column-aligned with whitespace, and
+innotop prints the full contents of each table instead of only printing one
+screenful at a time.
+
+=item *
+
+innotop only prints column headers once instead of every tick (see
+L<"hide_hdr">).  innotop does not print table captions (see
+L<"display_table_captions">).  innotop ensures there are no empty lines in the
+output.
+
+=item *
+
+innotop does not honor the L<"shorten"> transformation, which normally shortens
+some numbers to human-readable formats.
+
+=item *
+
+innotop does not print a status line (see L<"INNOTOP STATUS">).
+
+=back
+
+=head1 CONFIGURING
+
+Nearly everything about innotop is configurable.  Most things are possible to
+change with built-in commands, but you can also edit the configuration file.
+
+While running innotop, press the '$' key to bring up the configuration editing
+dialog.  Press another key to select the type of data you want to edit:
+
+=over
+
+=item S: Statement Sleep Times
+
+Edits SQL statement sleep delays, which make innotop pause for the specified
+amount of time after executing a statement.  See L<"SQL STATEMENTS"> for a
+definition of each statement and what it does.  By default innotop does not
+delay after any statements.
+
+This feature is included so you can customize the side-effects caused by
+monitoring your server.  You may not see any effects, but some innotop users
+have noticed that certain MySQL versions under very high load with InnoDB
+enabled take longer than usual to execute SHOW GLOBAL STATUS.  If innotop calls
+SHOW FULL PROCESSLIST immediately afterward, the processlist contains more
+queries than the machine actually averages at any given moment.  Configuring
+innotop to pause briefly after calling SHOW GLOBAL STATUS alleviates this
+effect.
+
+Sleep times are stored in the L<"stmt_sleep_times"> section of the configuration
+file.  Fractional-second sleeps are supported, subject to your hardware's
+limitations.
+
+=item c: Edit Columns
+
+Starts the table editor on one of the displayed tables.  See L<"TABLE EDITOR">.
+An alternative way to start the table editor without entering the configuration
+dialog is with the '^' key.
+
+=item g: General Configuration
+
+Starts the configuration editor to edit global and mode-specific configuration
+variables (see L<"MODES">).  innotop prompts you to choose a variable from among
+the global and mode-specific ones depending on the current mode.
+
+=item k: Row-Coloring Rules
+
+Starts the row-coloring rules editor on one of the displayed table(s).  See
+L<"COLORS"> for details.
+
+=item p: Manage Plugins
+
+Starts the plugin configuration editor.  See L<"PLUGINS"> for details.
+
+=item s: Server Groups
+
+Lets you create and edit server groups.  See L<"SERVER GROUPS">.
+
+=item t: Choose Displayed Tables
+
+Lets you choose which tables to display in this mode.  See L<"MODES"> and
+L<"TABLES">.
+
+=back
+
+=head1 CONFIGURATION FILE
+
+innotop's default configuration file locations are $HOME/.innotop and
+/etc/innotop/innotop.conf, and they are looked for in that order.  If the first
+configuration file exists, the second will not be processed.  Those can be
+overridden with the L<"--config"> command-line option.  You can edit it by hand
+safely, however innotop reads the configuration file when it starts, and, if
+readonly is set to 0, writes it out again when it exits.  Thus, if readonly is
+set to 0, any changes you make by hand while innotop is running will be lost.
+
+innotop doesn't store its entire configuration in the configuration file.  It
+has a huge set of default configuration values that it holds only in memory,
+and the configuration file only overrides these defaults.  When you customize a
+default setting, innotop notices, and then stores the customizations into the
+file.  This keeps the file size down, makes it easier to edit, and makes
+upgrades easier.
+
+A configuration file is read-only be default.  You can override that with
+L<"--write">.  See L<"readonly">.
+
+The configuration file is arranged into sections like an INI file.  Each
+section begins with [section-name] and ends with [/section-name].  Each
+section's entries have a different syntax depending on the data they need to
+store.  You can put comments in the file; any line that begins with a #
+character is a comment.  innotop will not read the comments, so it won't write
+them back out to the file when it exits.  Comments in read-only configuration
+files are still useful, though.
+
+The first line in the file is innotop's version number.  This lets innotop
+notice when the file format is not backwards-compatible, and upgrade smoothly
+without destroying your customized configuration.
+
+The following list describes each section of the configuration file and the data
+it contains:
+
+=over
+
+=item general
+
+The 'general' section contains global configuration variables and variables that
+may be mode-specific, but don't belong in any other section.  The syntax is a
+simple key=value list.  innotop writes a comment above each value to help you
+edit the file by hand.
+
+=over
+
+=item S_func
+
+Controls S mode presentation (see L<"S: Variables & Status">).  If g, values are
+graphed; if s, values are like vmstat; if p, values are in a pivoted table.
+
+=item S_set
+
+Specifies which set of variables to display in L<"S: Variables & Status"> mode.
+See L<"VARIABLE SETS">.
+
+=item auto_wipe_dl
+
+Instructs innotop to automatically wipe large deadlocks when it notices them.
+When this happens you may notice a slight delay.  At the next tick, you will
+usually see the information that was being truncated by the large deadlock.
+
+=item charset
+
+Specifies what kind of characters to allow through the L<"no_ctrl_char">
+transformation.  This keeps non-printable characters from confusing a
+terminal when you monitor queries that contain binary data, such as images.
+
+The default is 'ascii', which considers anything outside normal ASCII to be a
+control character.  The other allowable values are 'unicode' and 'none'.  'none'
+considers every character a control character, which can be useful for
+collapsing ALL text fields in queries.
+
+=item cmd_filter
+
+This is the prefix that filters variables in L<"C: Command Summary"> mode.
+
+=item color
+
+Whether terminal coloring is permitted.
+
+=item cxn_timeout
+
+On MySQL versions 4.0.3 and newer, this variable is used to set the connection's
+timeout, so MySQL doesn't close the connection if it is not used for a while.
+This might happen because a connection isn't monitored in a particular mode, for
+example.
+
+=item debug
+
+This option enables more verbose errors and makes innotop more strict in some
+places.  It can help in debugging filters and other user-defined code.  It also
+makes innotop write a lot of information to L<"debugfile"> when there is a
+crash.
+
+=item debugfile
+
+A file to which innotop will write information when there is a crash.  See
+L<"FILES">.
+
+=item display_table_captions
+
+innotop displays a table caption above most tables.  This variable suppresses or
+shows captions on all tables globally.  Some tables are configured with the
+hide_caption property, which overrides this.
+
+=item global
+
+Whether to show GLOBAL variables and status.  innotop only tries to do this on
+servers which support the GLOBAL option to SHOW VARIABLES and SHOW STATUS.  In
+some MySQL versions, you need certain privileges to do this; if you don't have
+them, innotop will not be able to fetch any variable and status data.  This
+configuration variable lets you run innotop and fetch what data you can even
+without the elevated privileges.
+
+I can no longer find or reproduce the situation where GLOBAL wasn't allowed, but
+I know there was one.
+
+=item graph_char
+
+Defines the character to use when drawing graphs in L<"S: Variables & Status">
+mode.
+
+=item header_highlight
+
+Defines how to highlight column headers.  This only works if Term::ANSIColor is
+available.  Valid values are 'bold' and 'underline'.
+
+=item hide_hdr
+
+Hides column headers globally.
+
+=item interval
+
+The interval at which innotop will refresh its data (ticks).  The interval is
+implemented as a sleep time between ticks, so the true interval will vary
+depending on how long it takes innotop to fetch and render data.
+
+This variable accepts fractions of a second.
+
+=item mode
+
+The mode in which innotop should start.  Allowable arguments are the same as the
+key presses that select a mode interactively.  See L<"MODES">.
+
+=item num_digits
+
+How many digits to show in fractional numbers and percents.  This variable's
+range is between 0 and 9 and can be set directly from L<"S: Variables & Status">
+mode with the '+' and '-' keys.  It is used in the L<"set_precision">,
+L<"shorten">, and L<"percent"> transformations.
+
+=item num_status_sets
+
+Controls how many sets of status variables to display in pivoted L<"S: Variables
+& Status"> mode.  It also controls the number of old sets of variables innotop
+keeps in its memory, so the larger this variable is, the more memory innotop
+uses.
+
+=item plugin_dir
+
+Specifies where plugins can be found.  By default, innotop stores plugins in the
+'plugins' subdirectory of your innotop configuration directory.
+
+=item readonly
+
+Whether the configuration file is readonly.  This cannot be set interactively.
+
+=item show_cxn_errors
+
+Makes innotop print connection errors to STDOUT.  See L<"ERROR HANDLING">.
+
+=item show_cxn_errors_in_tbl
+
+Makes innotop display connection errors as rows in the first table on screen.
+See L<"ERROR HANDLING">.
+
+=item show_percent
+
+Adds a '%' character after the value returned by the L<"percent">
+transformation.
+
+=item show_statusbar
+
+Controls whether to show the status bar in the display.  See L<"INNOTOP
+STATUS">.
+
+=item skip_innodb
+
+Disables fetching SHOW INNODB STATUS, in case your server(s) do not have InnoDB
+enabled and you don't want innotop to try to fetch it.  This can also be useful
+when you don't have the SUPER privilege, required to run SHOW INNODB STATUS.
+
+=item status_inc
+
+Whether to show absolute or incremental values for status variables.
+Incremental values are calculated as an offset from the last value innotop saw
+for that variable.  This is a global setting, but will probably become
+mode-specific at some point.  Right now it is honored a bit inconsistently; some
+modes don't pay attention to it.
+
+=back
+
+=item plugins
+
+This section holds a list of package names of active plugins.  If the plugin
+exists, innotop will activate it.  See L<"PLUGINS"> for more information.
+
+=item filters
+
+This section holds user-defined filters (see L<"FILTERS">).  Each line is in the
+format filter_name=text='filter text' tbls='table list'.
+
+The filter text is the text of the subroutine's code.  The table list is a list
+of tables to which the filter can apply.  By default, user-defined filters apply
+to the table for which they were created, but you can manually override that by
+editing the definition in the configuration file.
+
+=item active_filters
+
+This section stores which filters are active on each table.  Each line is in the
+format table_name=filter_list.
+
+=item tbl_meta
+
+This section stores user-defined or user-customized columns (see L<"COLUMNS">).
+Each line is in the format col_name=properties, where the properties are a
+name=quoted-value list.
+
+=item connections
+
+This section holds the server connections you have defined.  Each line is in
+the format name=properties, where the properties are a name=value list.  The
+properties are self-explanatory, and the only one that is treated specially is
+'pass' which is only present if 'savepass' is set.  This section of the
+configuration file will be skipped if any DSN, username, or password
+command-line options are used.  See L<"SERVER CONNECTIONS">.
+
+=item active_connections
+
+This section holds a list of which connections are active in each mode.  Each
+line is in the format mode_name=connection_list.
+
+=item server_groups
+
+This section holds server groups.  Each line is in the format
+name=connection_list.  See L<"SERVER GROUPS">.
+
+=item active_server_groups
+
+This section holds a list of which server group is active in each mode.  Each
+line is in the format mode_name=server_group.
+
+=item max_values_seen
+
+This section holds the maximum values seen for variables.  This is used to scale
+the graphs in L<"S: Variables & Status"> mode.  Each line is in the format
+name=value.
+
+=item active_columns
+
+This section holds table column lists.  Each line is in the format
+tbl_name=column_list.  See L<"COLUMNS">.
+
+=item sort_cols
+
+This section holds the sort definition.  Each line is in the format
+tbl_name=column_list.  If a column is prefixed with '-', that column sorts
+descending.  See L<"SORTING">.
+
+=item visible_tables
+
+This section defines which tables are visible in each mode.  Each line is in the
+format mode_name=table_list.  See L<"TABLES">.
+
+=item varsets
+
+This section defines variable sets for use in L<"S: Status & Variables"> mode.
+Each line is in the format name=variable_list.  See L<"VARIABLE SETS">.
+
+=item colors
+
+This section defines colorization rules.  Each line is in the format
+tbl_name=property_list.  See L<"COLORS">.
+
+=item stmt_sleep_times
+
+This section contains statement sleep times.  Each line is in the format
+statement_name=sleep_time.  See L<"S: Statement Sleep Times">.
+
+=item group_by
+
+This section contains column lists for table group_by expressions.  Each line is
+in the format tbl_name=column_list.  See L<"GROUPING">.
+
+=back
+
+=head1 CUSTOMIZING
+
+You can customize innotop a great deal.  For example, you can:
+
+=over
+
+=item *
+
+Choose which tables to display, and in what order.
+
+=item *
+
+Choose which columns are in those tables, and create new columns.
+
+=item *
+
+Filter which rows display with built-in filters, user-defined filters, and
+quick-filters.
+
+=item *
+
+Sort the rows to put important data first or group together related rows.
+
+=item *
+
+Highlight rows with color.
+
+=item *
+
+Customize the alignment, width, and formatting of columns, and apply
+transformations to columns to extract parts of their values or format the values
+as you wish (for example, shortening large numbers to familiar units).
+
+=item *
+
+Design your own expressions to extract and combine data as you need.  This gives
+you unlimited flexibility.
+
+=back
+
+All these and more are explained in the following sections.
+
+=head2 TABLES
+
+A table is what you'd expect: a collection of columns.  It also has some other
+properties, such as a caption.  Filters, sorting rules, and colorization rules
+belong to tables and are covered in later sections.
+
+Internally, table meta-data is defined in a data structure called %tbl_meta.
+This hash holds all built-in table definitions, which contain a lot of default
+instructions to innotop.  The meta-data includes the caption, a list of columns
+the user has customized, a list of columns, a list of visible columns, a list of
+filters, color rules, a sort-column list, sort direction, and some information
+about the table's data sources.  Most of this is customizable via the table
+editor (see L<"TABLE EDITOR">).
+
+You can choose which tables to show by pressing the '$' key.  See L<"MODES"> and
+L<"TABLES">.
+
+The table life-cycle is as follows:
+
+=over
+
+=item *
+
+Each table begins with a data source, which is an array of hashes.  See below
+for details on data sources.
+
+=item *
+
+Each element of the data source becomes a row in the final table.
+
+=item *
+
+For each element in the data source, innotop extracts values from the source and
+creates a row.  This row is another hash, which later steps will refer to as
+$set.  The values innotop extracts are determined by the table's columns.  Each
+column has an extraction subroutine, compiled from an expression (see
+L<"EXPRESSIONS">).  The resulting row is a hash whose keys are named the same as
+the column name.
+
+=item *
+
+innotop filters the rows, removing those that don't need to be displayed.  See
+L<"FILTERS">.
+
+=item *
+
+innotop sorts the rows.  See L<"SORTING">.
+
+=item *
+
+innotop groups the rows together, if specified.  See L<"GROUPING">.
+
+=item *
+
+innotop colorizes the rows.  See L<"COLORS">.
+
+=item *
+
+innotop transforms the column values in each row.  See L<"TRANSFORMATIONS">.
+
+=item *
+
+innotop optionally pivots the rows (see L<"PIVOTING">), then filters and sorts
+them.
+
+=item *
+
+innotop formats and justifies the rows as a table.  During this step, innotop
+applies further formatting to the column values, including alignment, maximum
+and minimum widths.  innotop also does final error checking to ensure there are
+no crashes due to undefined values.  innotop then adds a caption if specified,
+and the table is ready to print.
+
+=back
+
+The lifecycle is slightly different if the table is pivoted, as noted above.  To
+clarify, if the table is pivoted, the process is extract, group, transform,
+pivot, filter, sort, create.  If it's not pivoted, the process is extract,
+filter, sort, group, color, transform, create.  This slightly convoluted process
+doesn't map all that well to SQL, but pivoting complicates things pretty
+thoroughly.  Roughly speaking, filtering and sorting happen as late as needed to
+effect the final result as you might expect, but as early as possible for
+efficiency.
+
+Each built-in table is described below:
+
+=over
+
+=item adaptive_hash_index
+
+Displays data about InnoDB's adaptive hash index.  Data source:
+L<"STATUS_VARIABLES">.
+
+=item buffer_pool
+
+Displays data about InnoDB's buffer pool.  Data source: L<"STATUS_VARIABLES">.
+
+=item cmd_summary
+
+Displays weighted status variables.  Data source: L<"STATUS_VARIABLES">.
+
+=item deadlock_locks
+
+Shows which locks were held and waited for by the last detected deadlock.  Data
+source: L<"DEADLOCK_LOCKS">.
+
+=item deadlock_transactions
+
+Shows transactions involved in the last detected deadlock.  Data source:
+L<"DEADLOCK_TRANSACTIONS">.
+
+=item explain
+
+Shows the output of EXPLAIN.  Data source: L<"EXPLAIN">.
+
+=item file_io_misc
+
+Displays data about InnoDB's file and I/O operations.  Data source:
+L<"STATUS_VARIABLES">.
+
+=item fk_error
+
+Displays various data about InnoDB's last foreign key error.  Data source:
+L<"STATUS_VARIABLES">.
+
+=item innodb_locks
+
+Displays InnoDB locks.  Data source: L<"INNODB_LOCKS">.
+
+=item innodb_transactions
+
+Displays data about InnoDB's current transactions.  Data source:
+L<"INNODB_TRANSACTIONS">.
+
+=item insert_buffers
+
+Displays data about InnoDB's insert buffer.  Data source: L<"STATUS_VARIABLES">.
+
+=item io_threads
+
+Displays data about InnoDB's I/O threads.  Data source: L<"IO_THREADS">.
+
+=item log_statistics
+
+Displays data about InnoDB's logging system.  Data source: L<"STATUS_VARIABLES">.
+
+=item master_status
+
+Displays replication master status.  Data source: L<"STATUS_VARIABLES">.
+
+=item open_tables
+
+Displays open tables.  Data source: L<"OPEN_TABLES">.
+
+=item page_statistics
+
+Displays InnoDB page statistics.  Data source: L<"STATUS_VARIABLES">.
+
+=item pending_io
+
+Displays InnoDB pending I/O operations.  Data source: L<"STATUS_VARIABLES">.
+
+=item processlist
+
+Displays current MySQL processes (threads/connections).  Data source:
+L<"PROCESSLIST">.
+
+=item q_header
+
+Displays various status values.  Data source: L<"STATUS_VARIABLES">.
+
+=item row_operation_misc
+
+Displays data about InnoDB's row operations.  Data source:
+L<"STATUS_VARIABLES">.
+
+=item row_operations
+
+Displays data about InnoDB's row operations.  Data source:
+L<"STATUS_VARIABLES">.
+
+=item semaphores
+
+Displays data about InnoDB's semaphores and mutexes.  Data source:
+L<"STATUS_VARIABLES">.
+
+=item slave_io_status
+
+Displays data about the slave I/O thread.  Data source: 
+L<"STATUS_VARIABLES">.
+
+=item slave_sql_status
+
+Displays data about the slave SQL thread.  Data source: L<"STATUS_VARIABLES">.
+
+=item t_header
+
+Displays various InnoDB status values.  Data source: L<"STATUS_VARIABLES">.
+
+=item var_status
+
+Displays user-configurable data.  Data source: L<"STATUS_VARIABLES">.
+
+=item wait_array
+
+Displays data about InnoDB's OS wait array.  Data source: L<"OS_WAIT_ARRAY">.
+
+=back
+
+=head2 COLUMNS
+
+Columns belong to tables.  You can choose a table's columns by pressing the '^'
+key, which starts the L<"TABLE EDITOR"> and lets you choose and edit columns.
+Pressing 'e' from within the table editor lets you edit the column's properties:
+
+=over
+
+=item *
+
+hdr: a column header.  This appears in the first row of the table.
+
+=item *
+
+just: justification.  '-' means left-justified and '' means right-justified,
+just as with printf formatting codes (not a coincidence).
+
+=item *
+
+dec: whether to further align the column on the decimal point.
+
+=item *
+
+num: whether the column is numeric.  This affects how values are sorted
+(lexically or numerically).
+
+=item *
+
+label: a small note about the column, which appears in dialogs that help the
+user choose columns.
+
+=item *
+
+src: an expression that innotop uses to extract the column's data from its
+source (see L<"DATA SOURCES">).  See L<"EXPRESSIONS"> for more on expressions.
+
+=item *
+
+minw: specifies a minimum display width.  This helps stabilize the display,
+which makes it easier to read if the data is changing frequently.
+
+=item *
+
+maxw: similar to minw.
+
+=item *
+
+trans: a list of column transformations.  See L<"TRANSFORMATIONS">.
+
+=item *
+
+agg: an aggregate function.  See L<"GROUPING">.  The default is L<"first">.
+
+=item *
+
+aggonly: controls whether the column only shows when grouping is enabled on the
+table (see L<"GROUPING">).  By default, this is disabled.  This means columns
+will always be shown by default, whether grouping is enabled or not.  If a
+column's aggonly is set true, the column will appear when you toggle grouping on
+the table.  Several columns are set this way, such as the count column on
+L<"processlist"> and L<"innodb_transactions">, so you don't see a count when the
+grouping isn't enabled, but you do when it is.
+
+=back
+
+=head2 FILTERS
+
+Filters remove rows from the display.  They behave much like a WHERE clause in
+SQL.  innotop has several built-in filters, which remove irrelevant information
+like inactive queries, but you can define your own as well.  innotop also lets
+you create quick-filters, which do not get saved to the configuration file, and
+are just an easy way to quickly view only some rows.
+
+You can enable or disable a filter on any table.  Press the '%' key (mnemonic: %
+looks kind of like a line being filtered between two circles) and choose which
+table you want to filter, if asked.  You'll then see a list of possible filters
+and a list of filters currently enabled for that table.  Type the names of
+filters you want to apply and press Enter.
+
+=head3 USER-DEFINED FILTERS
+
+If you type a name that doesn't exist, innotop will prompt you to create the
+filter.  Filters are easy to create if you know Perl, and not hard if you don't.
+What you're doing is creating a subroutine that returns true if the row should
+be displayed.  The row is a hash reference passed to your subroutine as $set.
+
+For example, imagine you want to filter the processlist table so you only see
+queries that have been running more than five minutes.  Type a new name for your
+filter, and when prompted for the subroutine body, press TAB to initiate your
+terminal's auto-completion.  You'll see the names of the columns in the
+L<"processlist"> table (innotop generally tries to help you with auto-completion
+lists).  You want to filter on the 'time' column.  Type the text "$set->{time} >
+300" to return true when the query is more than five minutes old.  That's all
+you need to do.
+
+In other words, the code you're typing is surrounded by an implicit context,
+which looks like this:
+
+ sub filter {
+    my ( $set ) = @_;
+    # YOUR CODE HERE
+ }
+
+If your filter doesn't work, or if something else suddenly behaves differently,
+you might have made an error in your filter, and innotop is silently catching
+the error.  Try enabling L<"debug"> to make innotop throw an error instead.
+
+=head3 QUICK-FILTERS
+
+innotop's quick-filters are a shortcut to create a temporary filter that doesn't
+persist when you restart innotop.  To create a quick-filter, press the '/' key.
+innotop will prompt you for the column name and filter text.  Again, you can use
+auto-completion on column names.  The filter text can be just the text you want
+to "search for."  For example, to filter the L<"processlist"> table on queries
+that refer to the products table, type '/' and then 'info product'.
+
+The filter text can actually be any Perl regular expression, but of course a
+literal string like 'product' works fine as a regular expression.
+
+Behind the scenes innotop compiles the quick-filter into a specially tagged
+filter that is otherwise like any other filter.  It just isn't saved to the
+configuration file.
+
+To clear quick-filters, press the '\' key and innotop will clear them all at
+once.
+
+=head2 SORTING
+
+innotop has sensible built-in defaults to sort the most important rows to the
+top of the table.  Like anything else in innotop, you can customize how any
+table is sorted.
+
+To start the sort dialog, start the L<"TABLE EDITOR"> with the '^' key, choose a
+table if necessary, and press the 's' key.  You'll see a list of columns you can
+use in the sort expression and the current sort expression, if any.  Enter a
+list of columns by which you want to sort and press Enter.  If you want to
+reverse sort, prefix the column name with a minus sign.  For example, if you
+want to sort by column a ascending, then column b descending, type 'a -b'.  You
+can also explicitly add a + in front of columns you want to sort ascending, but
+it's not required.
+
+Some modes have keys mapped to open this dialog directly, and to quickly reverse
+sort direction.  Press '?' as usual to see which keys are mapped in any mode.
+
+=head2 GROUPING
+
+innotop can group, or aggregate, rows together (the terms are used
+interchangeably).  This is quite similar to an SQL GROUP BY clause.  You can
+specify to group on certain columns, or if you don't specify any, the entire set
+of rows is treated as one group.  This is quite like SQL so far, but unlike SQL,
+you can also select un-grouped columns.  innotop actually aggregates every
+column.  If you don't explicitly specify a grouping function, the default is
+'first'.  This is basically a convenience so you don't have to specify an
+aggregate function for every column you want in the result.
+
+You can quickly toggle grouping on a table with the '=' key, which toggles its
+aggregate property.  This property doesn't persist to the config file.
+
+The columns by which the table is grouped are specified in its group_by
+property.  When you turn grouping on, innotop places the group_by columns at the
+far left of the table, even if they're not supposed to be visible.  The rest of
+the visible columns appear in order after them.
+
+Two tables have default group_by lists and a count column built in:
+L<"processlist"> and L<"innodb_transactions">.  The grouping is by connection
+and status, so you can quickly see how many queries or transactions are in a
+given status on each server you're monitoring.  The time columns are aggregated
+as a sum; other columns are left at the default 'first' aggregation.
+
+By default, the table shown in L<"S: Variables & Status"> mode also uses
+grouping so you can monitor variables and status across many servers.  The
+default aggregation function in this mode is 'avg'.
+
+Valid grouping functions are defined in the %agg_funcs hash.  They include
+
+=over
+
+=item first
+
+Returns the first element in the group.
+
+=item count
+
+Returns the number of elements in the group, including undefined elements, much
+like SQL's COUNT(*).
+
+=item avg
+
+Returns the average of defined elements in the group.
+
+=item sum
+
+Returns the sum of elements in the group.
+
+=back
+
+Here's an example of grouping at work.  Suppose you have a very busy server with
+hundreds of open connections, and you want to see how many connections are in
+what status.  Using the built-in grouping rules, you can press 'Q' to enter
+L<"Q: Query List"> mode.  Press '=' to toggle grouping (if necessary, select the
+L<"processlist"> table when prompted).
+
+Your display might now look like the following:
+
+ Query List (? for help) localhost, 32:33, 0.11 QPS, 1 thd, 5.0.38-log
+ 
+ CXN        Cmd        Cnt  ID      User   Host           Time   Query       
+ localhost  Query      49    12933  webusr localhost      19:38  SELECT * FROM
+ localhost  Sending Da 23     2383  webusr localhost      12:43  SELECT col1,
+ localhost  Sleep      120     140  webusr localhost    5:18:12
+ localhost  Statistics 12    19213  webusr localhost      01:19  SELECT * FROM
+
+That's actually quite a worrisome picture.  You've got a lot of idle connections
+(Sleep), and some connections executing queries (Query and Sending Data).
+That's okay, but you also have a lot in Statistics status, collectively spending
+over a minute.  That means the query optimizer is having a really hard time
+optimizing your statements.  Something is wrong; it should normally take
+milliseconds to optimize queries.  You might not have seen this pattern if you
+didn't look at your connections in aggregate.  (This is a made-up example, but
+it can happen in real life).
+
+=head2 PIVOTING
+
+innotop can pivot a table for more compact display, similar to a Pivot Table in
+a spreadsheet (also known as a crosstab).  Pivoting a table makes columns into
+rows.  Assume you start with this table:
+
+ foo bar
+ === ===
+ 1   3
+ 2   4
+
+After pivoting, the table will look like this:
+
+ name set0 set1
+ ==== ==== ====
+ foo  1    2
+ bar  3    4
+
+To get reasonable results, you might need to group as well as pivoting.
+innotop currently does this for L<"S: Variables & Status"> mode.
+
+=head2 COLORS
+
+By default, innotop highlights rows with color so you can see at a glance which
+rows are more important.  You can customize the colorization rules and add your
+own to any table.  Open the table editor with the '^' key, choose a table if
+needed, and press 'o' to open the color editor dialog.
+
+The color editor dialog displays the rules applied to the table, in the order
+they are evaluated.  Each row is evaluated against each rule to see if the rule
+matches the row; if it does, the row gets the specified color, and no further
+rules are evaluated.  The rules look like the following:
+
+ state  eq  Locked       black on_red
+ cmd    eq  Sleep        white       
+ user   eq  system user  white       
+ cmd    eq  Connect      white       
+ cmd    eq  Binlog Dump  white       
+ time   >   600          red         
+ time   >   120          yellow      
+ time   >   60           green       
+ time   >   30           cyan        
+
+This is the default rule set for the L<"processlist"> table.  In order of
+priority, these rules make locked queries black on a red background, "gray out"
+connections from replication and sleeping queries, and make queries turn from
+cyan to red as they run longer.
+
+(For some reason, the ANSI color code "white" is actually a light gray.  Your
+terminal's display may vary; experiment to find colors you like).
+
+You can use keystrokes to move the rules up and down, which re-orders their
+priority.  You can also delete rules and add new ones.  If you add a new rule,
+innotop prompts you for the column, an operator for the comparison, a value
+against which to compare the column, and a color to assign if the rule matches.
+There is auto-completion and prompting at each step.
+
+The value in the third step needs to be correctly quoted.  innotop does not try
+to quote the value because it doesn't know whether it should treat the value as
+a string or a number.  If you want to compare the column against a string, as
+for example in the first rule above, you should enter 'Locked' surrounded by
+quotes.  If you get an error message about a bareword, you probably should have
+quoted something.
+
+=head2 EXPRESSIONS
+
+Expressions are at the core of how innotop works, and are what enables you to
+extend innotop as you wish.  Recall the table lifecycle explained in
+L<"TABLES">.  Expressions are used in the earliest step, where it extracts
+values from a data source to form rows.
+
+It does this by calling a subroutine for each column, passing it the source data
+set, a set of current values, and a set of previous values.  These are all
+needed so the subroutine can calculate things like the difference between this
+tick and the previous tick.
+
+The subroutines that extract the data from the set are compiled from
+expressions.  This gives significantly more power than just naming the values to
+fill the columns, because it allows the column's value to be calculated from
+whatever data is necessary, but avoids the need to write complicated and lengthy
+Perl code.
+
+innotop begins with a string of text that can look as simple as a value's name
+or as complicated as a full-fledged Perl expression.  It looks at each
+'bareword' token in the string and decides whether it's supposed to be a key
+into the $set hash.  A bareword is an unquoted value that isn't already
+surrounded by code-ish things like dollar signs or curly brackets.  If innotop
+decides that the bareword isn't a function or other valid Perl code, it converts
+it into a hash access.  After the whole string is processed, innotop compiles a
+subroutine, like this:
+
+ sub compute_column_value {
+    my ( $set, $cur, $pre ) = @_;
+    my $val = # EXPANDED STRING GOES HERE
+    return $val;
+ }
+
+Here's a concrete example, taken from the header table L<"q_header"> in L<"Q:
+Query List"> mode.  This expression calculates the qps, or Queries Per Second,
+column's values, from the values returned by SHOW STATUS:
+
+ Questions/Uptime_hires
+
+innotop decides both words are barewords, and transforms this expression into
+the following Perl code:
+
+ $set->{Questions}/$set->{Uptime_hires}
+
+When surrounded by the rest of the subroutine's code, this is executable Perl
+that calculates a high-resolution queries-per-second value.
+
+The arguments to the subroutine are named $set, $cur, and $pre.  In most cases,
+$set and $cur will be the same values.  However, if L<"status_inc"> is set, $cur
+will not be the same as $set, because $set will already contain values that are
+the incremental difference between $cur and $pre.
+
+Every column in innotop is computed by subroutines compiled in the same fashion.
+There is no difference between innotop's built-in columns and user-defined
+columns.  This keeps things consistent and predictable.
+
+=head2 TRANSFORMATIONS
+
+Transformations change how a value is rendered.  For example, they can take a
+number of seconds and display it in H:M:S format.  The following transformations
+are defined:
+
+=over
+
+=item commify
+
+Adds commas to large numbers every three decimal places.
+
+=item dulint_to_int
+
+Accepts two unsigned integers and converts them into a single longlong.  This is
+useful for certain operations with InnoDB, which uses two integers as
+transaction identifiers, for example.
+
+=item no_ctrl_char
+
+Removes quoted control characters from the value.  This is affected by the
+L<"charset"> configuration variable.
+
+This transformation only operates within quoted strings, for example, values to
+a SET clause in an UPDATE statement.  It will not alter the UPDATE statement,
+but will collapse the quoted string to [BINARY] or [TEXT], depending on the
+charset.
+
+=item percent
+
+Converts a number to a percentage by multiplying it by two, formatting it with
+L<"num_digits"> digits after the decimal point, and optionally adding a percent
+sign (see L<"show_percent">).
+
+=item secs_to_time
+
+Formats a number of seconds as time in days+hours:minutes:seconds format.
+
+=item set_precision
+
+Formats numbers with L<"num_digits"> number of digits after the decimal point.
+
+=item shorten
+
+Formats a number as a unit of 1024 (k/M/G/T) and with L<"num_digits"> number of
+digits after the decimal point.
+
+=back
+
+=head2 TABLE EDITOR
+
+The innotop table editor lets you customize tables with keystrokes.  You start
+the table editor with the '^' key.  If there's more than one table on the
+screen, it will prompt you to choose one of them.  Once you do, innotop will
+show you something like this:
+
+ Editing table definition for Buffer Pool.  Press ? for help, q to quit.
+ 
+ name               hdr          label                  src          
+ cxn                CXN          Connection from which  cxn          
+ buf_pool_size      Size         Buffer pool size       IB_bp_buf_poo
+ buf_free           Free Bufs    Buffers free in the b  IB_bp_buf_fre
+ pages_total        Pages        Pages total            IB_bp_pages_t
+ pages_modified     Dirty Pages  Pages modified (dirty  IB_bp_pages_m
+ buf_pool_hit_rate  Hit Rate     Buffer pool hit rate   IB_bp_buf_poo
+ total_mem_alloc    Memory       Total memory allocate  IB_bp_total_m
+ add_pool_alloc     Add'l Pool   Additonal pool alloca  IB_bp_add_poo
+
+The first line shows which table you're editing, and reminds you again to press
+'?' for a list of key mappings.  The rest is a tabular representation of the
+table's columns, because that's likely what you're trying to edit.  However, you
+can edit more than just the table's columns; this screen can start the filter
+editor, color rule editor, and more.
+
+Each row in the display shows a single column in the table you're editing, along
+with a couple of its properties such as its header and source expression (see
+L<"EXPRESSIONS">).
+
+The key mappings are Vim-style, as in many other places.  Pressing 'j' and 'k'
+moves the highlight up or down.  You can then (d)elete or (e)dit the highlighted
+column.  You can also (a)dd a column to the table.  This actually just activates
+one of the columns already defined for the table; it prompts you to choose from
+among the columns available but not currently displayed.  Finally, you can
+re-order the columns with the '+' and '-' keys.
+
+You can do more than just edit the columns with the table editor, you can also
+edit other properties, such as the table's sort expression and group-by
+expression.  Press '?' to see the full list, of course.
+
+If you want to really customize and create your own column, as opposed to just
+activating a built-in one that's not currently displayed, press the (n)ew key,
+and innotop will prompt you for the information it needs:
+
+=over
+
+=item *
+
+The column name: this needs to be a word without any funny characters, e.g. just
+letters, numbers and underscores.
+
+=item *
+
+The column header: this is the label that appears at the top of the column, in
+the table header.  This can have spaces and funny characters, but be careful not
+to make it too wide and waste space on-screen.
+
+=item *
+
+The column's data source: this is an expression that determines what data from
+the source (see L<"TABLES">) innotop will put into the column.  This can just be
+the name of an item in the source, or it can be a more complex expression, as
+described in L<"EXPRESSIONS">.
+
+=back
+
+Once you've entered the required data, your table has a new column.  There is no
+difference between this column and the built-in ones; it can have all the same
+properties and behaviors.  innotop will write the column's definition to the
+configuration file, so it will persist across sessions.
+
+Here's an example: suppose you want to track how many times your slaves have
+retried transactions.  According to the MySQL manual, the
+Slave_retried_transactions status variable gives you that data: "The total
+number of times since startup that the replication slave SQL thread has retried
+transactions. This variable was added in version 5.0.4."  This is appropriate to
+add to the L<"slave_sql_status"> table.
+
+To add the column, switch to the replication-monitoring mode with the 'M' key,
+and press the '^' key to start the table editor.  When prompted, choose
+slave_sql_status as the table, then press 'n' to create the column.  Type
+'retries' as the column name, 'Retries' as the column header, and
+'Slave_retried_transactions' as the source.  Now the column is created, and you
+see the table editor screen again.  Press 'q' to exit the table editor, and
+you'll see your column at the end of the table.
+
+=head1 VARIABLE SETS
+
+Variable sets are used in L<"S: Variables & Status"> mode to define more easily
+what variables you want to monitor.  Behind the scenes they are compiled to a
+list of expressions, and then into a column list so they can be treated just
+like columns in any other table, in terms of data extraction and
+transformations.  However, you're protected from the tedious details by a syntax
+that ought to feel very natural to you: a SQL SELECT list.
+
+The data source for variable sets, and indeed the entire S mode, is the
+combination of SHOW STATUS, SHOW VARIABLES, and SHOW INNODB STATUS.  Imagine
+that you had a huge table with one column per variable returned from those
+statements.  That's the data source for variable sets.  You can now query this
+data source just like you'd expect.  For example:
+
+ Questions, Uptime, Questions/Uptime as QPS
+
+Behind the scenes innotop will split that variable set into three expressions,
+compile them and turn them into a table definition, then extract as usual.  This
+becomes a "variable set," or a "list of variables you want to monitor."
+
+innotop lets you name and save your variable sets, and writes them to the
+configuration file.  You can choose which variable set you want to see with the
+'c' key, or activate the next and previous sets with the '>' and '<' keys.
+There are many built-in variable sets as well, which should give you a good
+start for creating your own.  Press 'e' to edit the current variable set, or
+just to see how it's defined.  To create a new one, just press 'c' and type its
+name.
+
+You may want to use some of the functions listed in L<"TRANSFORMATIONS"> to help
+format the results.  In particular, L<"set_precision"> is often useful to limit
+the number of digits you see.  Extending the above example, here's how:
+
+ Questions, Uptime, set_precision(Questions/Uptime) as QPS
+
+Actually, this still needs a little more work.  If your L<"interval"> is less
+than one second, you might be dividing by zero because Uptime is incremental in
+this mode by default.  Instead, use Uptime_hires:
+
+ Questions, Uptime, set_precision(Questions/Uptime_hires) as QPS
+
+This example is simple, but it shows how easy it is to choose which variables
+you want to monitor.
+
+=head1 PLUGINS
+
+innotop has a simple but powerful plugin mechanism by which you can extend
+or modify its existing functionality, and add new functionality.  innotop's
+plugin functionality is event-based: plugins register themselves to be called
+when events happen.  They then have a chance to influence the event.
+
+An innotop plugin is a Perl module placed in innotop's L<"plugin_dir">
+directory.  On UNIX systems, you can place a symbolic link to the module instead
+of putting the actual file there.  innotop automatically discovers the file.  If
+there is a corresponding entry in the L<"plugins"> configuration file section,
+innotop loads and activates the plugin.
+
+The module must conform to innotop's plugin interface.  Additionally, the source
+code of the module must be written in such a way that innotop can inspect the
+file and determine the package name and description.
+
+=head2 Package Source Convention
+
+innotop inspects the plugin module's source to determine the Perl package name.
+It looks for a line of the form "package Foo;" and if found, considers the
+plugin's package name to be Foo.  Of course the package name can be a valid Perl
+package name, with double semicolons and so on.
+
+It also looks for a description in the source code, to make the plugin editor
+more human-friendly.  The description is a comment line of the form "#
+description: Foo", where "Foo" is the text innotop will consider to be the
+plugin's description.
+
+=head2 Plugin Interface
+
+The innotop plugin interface is quite simple: innotop expects the plugin to be
+an object-oriented module it can call certain methods on.  The methods are
+
+=over
+
+=item new(%variables)
+
+This is the plugin's constructor.  It is passed a hash of innotop's variables,
+which it can manipulate (see L<"Plugin Variables">).  It must return a reference
+to the newly created plugin object.
+
+At construction time, innotop has only loaded the general configuration and
+created the default built-in variables with their default contents (which is
+quite a lot).  Therefore, the state of the program is exactly as in the innotop
+source code, plus the configuration variables from the L<"general"> section in
+the config file.
+
+If your plugin manipulates the variables, it is changing global data, which is
+shared by innotop and all plugins.  Plugins are loaded in the order they're
+listed in the config file.  Your plugin may load before or after another plugin,
+so there is a potential for conflict or interaction between plugins if they
+modify data other plugins use or modify.
+
+=item register_for_events()
+
+This method must return a list of events in which the plugin is interested, if
+any.  See L<"Plugin Events"> for the defined events.  If the plugin returns an
+event that's not defined, the event is ignored.
+
+=item event handlers
+
+The plugin must implement a method named the same as each event for which it has
+registered.  In other words, if the plugin returns qw(foo bar) from
+register_for_events(), it must have foo() and bar() methods.  These methods are
+callbacks for the events.  See L<"Plugin Events"> for more details about each
+event.
+
+=back
+
+=head2 Plugin Variables
+
+The plugin's constructor is passed a hash of innotop's variables, which it can
+manipulate.  It is probably a good idea if the plugin object saves a copy of it
+for later use.  The variables are defined in the innotop variable
+%pluggable_vars, and are as follows:
+
+=over
+
+=item action_for
+
+A hashref of key mappings.  These are innotop's global hot-keys.
+
+=item agg_funcs
+
+A hashref of functions that can be used for grouping.  See L<"GROUPING">.
+
+=item config
+
+The global configuration hash.
+
+=item connections
+
+A hashref of connection specifications.  These are just specifications of how to
+connect to a server.
+
+=item dbhs
+
+A hashref of innotop's database connections.  These are actual DBI connection
+objects.
+
+=item filters
+
+A hashref of filters applied to table rows.  See L<"FILTERS"> for more.
+
+=item modes
+
+A hashref of modes.  See L<"MODES"> for more.
+
+=item server_groups
+
+A hashref of server groups.  See L<"SERVER GROUPS">.
+
+=item tbl_meta
+
+A hashref of innotop's table meta-data, with one entry per table (see
+L<"TABLES"> for more information).
+
+=item trans_funcs
+
+A hashref of transformation functions.  See L<"TRANSFORMATIONS">.
+
+=item var_sets
+
+A hashref of variable sets.  See L<"VARIABLE SETS">.
+
+=back
+
+=head2 Plugin Events
+
+Each event is defined somewhere in the innotop source code.  When innotop runs
+that code, it executes the callback function for each plugin that expressed its
+interest in the event.  innotop passes some data for each event.  The events are
+defined in the %event_listener_for variable, and are as follows:
+
+=over
+
+=item extract_values($set, $cur, $pre, $tbl)
+
+This event occurs inside the function that extracts values from a data source.
+The arguments are the set of values, the current values, the previous values,
+and the table name.
+
+=item set_to_tbl
+
+Events are defined at many places in this subroutine, which is responsible for
+turning an arrayref of hashrefs into an arrayref of lines that can be printed to
+the screen.  The events all pass the same data: an arrayref of rows and the name
+of the table being created.  The events are set_to_tbl_pre_filter,
+set_to_tbl_pre_sort,set_to_tbl_pre_group, set_to_tbl_pre_colorize,
+set_to_tbl_pre_transform, set_to_tbl_pre_pivot, set_to_tbl_pre_create,
+set_to_tbl_post_create.
+
+=item draw_screen($lines)
+
+This event occurs inside the subroutine that prints the lines to the screen.
+$lines is an arrayref of strings.
+
+=back
+
+=head2 Simple Plugin Example
+
+The easiest way to explain the plugin functionality is probably with a simple
+example.  The following module adds a column to the beginning of every table and
+sets its value to 1.
+
+ use strict;
+ use warnings FATAL => 'all';
+ 
+ package Innotop::Plugin::Example;
+ # description: Adds an 'example' column to every table
+ 
+ sub new {
+    my ( $class, %vars ) = @_;
+    # Store reference to innotop's variables in $self
+    my $self = bless { %vars }, $class;
+ 
+    # Design the example column
+    my $col = {
+       hdr   => 'Example',
+       just  => '',
+       dec   => 0,
+       num   => 1,
+       label => 'Example',
+       src   => 'example', # Get data from this column in the data source
+       tbl   => '',
+       trans => [],
+    };
+ 
+    # Add the column to every table.
+    my $tbl_meta = $vars{tbl_meta};
+    foreach my $tbl ( values %$tbl_meta ) {
+       # Add the column to the list of defined columns
+       $tbl->{cols}->{example} = $col;
+       # Add the column to the list of visible columns
+       unshift @{$tbl->{visible}}, 'example';
+    }
+ 
+    # Be sure to return a reference to the object.
+    return $self;
+ }
+ 
+ # I'd like to be called when a data set is being rendered into a table, please.
+ sub register_for_events {
+    my ( $self ) = @_;
+    return qw(set_to_tbl_pre_filter);
+ }
+ 
+ # This method will be called when the event fires.
+ sub set_to_tbl_pre_filter {
+    my ( $self, $rows, $tbl ) = @_;
+    # Set the example column's data source to the value 1.
+    foreach my $row ( @$rows ) {
+       $row->{example} = 1;
+    }
+ }
+ 
+ 1;
+
+=head2 Plugin Editor
+
+The plugin editor lets you view the plugins innotop discovered and activate or
+deactivate them.  Start the editor by pressing $ to start the configuration
+editor from any mode.  Press the 'p' key to start the plugin editor.  You'll see
+a list of plugins innotop discovered.  You can use the 'j' and 'k' keys to move
+the highlight to the desired one, then press the * key to toggle it active or
+inactive.  Exit the editor and restart innotop for the changes to take effect.
+
+=head1 SQL STATEMENTS
+
+innotop uses a limited set of SQL statements to retrieve data from MySQL for
+display.  The statements are customized depending on the server version against
+which they are executed; for example, on MySQL 5 and newer, INNODB_STATUS
+executes "SHOW ENGINE INNODB STATUS", while on earlier versions it executes
+"SHOW INNODB STATUS".  The statements are as follows:
+
+ Statement           SQL executed
+ =================== ===============================
+ INNODB_STATUS       SHOW [ENGINE] INNODB STATUS
+ KILL_CONNECTION     KILL
+ KILL_QUERY          KILL QUERY
+ OPEN_TABLES         SHOW OPEN TABLES
+ PROCESSLIST         SHOW FULL PROCESSLIST
+ SHOW_MASTER_LOGS    SHOW MASTER LOGS
+ SHOW_MASTER_STATUS  SHOW MASTER STATUS
+ SHOW_SLAVE_STATUS   SHOW SLAVE STATUS
+ SHOW_STATUS         SHOW [GLOBAL] STATUS
+ SHOW_VARIABLES      SHOW [GLOBAL] VARIABLES
+
+=head1 DATA SOURCES
+
+Each time innotop extracts values to create a table (see L<"EXPRESSIONS"> and
+L<"TABLES">), it does so from a particular data source.  Largely because of the
+complex data extracted from SHOW INNODB STATUS, this is slightly messy.  SHOW
+INNODB STATUS contains a mixture of single values and repeated values that form
+nested data sets.
+
+Whenever innotop fetches data from MySQL, it adds two extra bits to each set:
+cxn and Uptime_hires.  cxn is the name of the connection from which the data
+came.  Uptime_hires is a high-resolution version of the server's Uptime status
+variable, which is important if your L<"interval"> setting is sub-second.
+
+Here are the kinds of data sources from which data is extracted:
+
+=over
+
+=item STATUS_VARIABLES
+
+This is the broadest category, into which the most kinds of data fall.  It
+begins with the combination of SHOW STATUS and SHOW VARIABLES, but other sources
+may be included as needed, for example, SHOW MASTER STATUS and SHOW SLAVE
+STATUS, as well as many of the non-repeated values from SHOW INNODB STATUS.
+
+=item DEADLOCK_LOCKS
+
+This data is extracted from the transaction list in the LATEST DETECTED DEADLOCK
+section of SHOW INNODB STATUS.  It is nested two levels deep: transactions, then
+locks.
+
+=item DEADLOCK_TRANSACTIONS
+
+This data is from the transaction list in the LATEST DETECTED DEADLOCK
+section of SHOW INNODB STATUS.  It is nested one level deep.
+
+=item EXPLAIN
+
+This data is from the result set returned by EXPLAIN.
+
+=item INNODB_TRANSACTIONS
+
+This data is from the TRANSACTIONS section of SHOW INNODB STATUS.
+
+=item IO_THREADS
+
+This data is from the list of threads in the the FILE I/O section of SHOW INNODB
+STATUS.
+
+=item INNODB_LOCKS
+
+This data is from the TRANSACTIONS section of SHOW INNODB STATUS and is nested
+two levels deep.
+
+=item OPEN_TABLES
+
+This data is from SHOW OPEN TABLES.
+
+=item PROCESSLIST
+
+This data is from SHOW FULL PROCESSLIST.
+
+=item OS_WAIT_ARRAY
+
+This data is from the SEMAPHORES section of SHOW INNODB STATUS and is nested one
+level deep.  It comes from the lines that look like this:
+
+ --Thread 1568861104 has waited at btr0cur.c line 424 ....
+
+=back
+
+=head1 MYSQL PRIVILEGES
+
+=over
+
+=item *
+
+You must connect to MySQL as a user who has the SUPER privilege for many of the
+functions.
+
+=item *
+
+If you don't have the SUPER privilege, you can still run some functions, but you
+won't necessarily see all the same data.
+
+=item *
+
+You need the PROCESS privilege to see the list of currently running queries in Q
+mode.
+
+=item *
+
+You need special privileges to start and stop slave servers.
+
+=item *
+
+You need appropriate privileges to create and drop the deadlock tables if needed
+(see L<"SERVER CONNECTIONS">).
+
+=back
+
+=head1 SYSTEM REQUIREMENTS
+
+You need Perl to run innotop, of course.  You also need a few Perl modules: DBI,
+DBD::mysql,  Term::ReadKey, and Time::HiRes.  These should be included with most
+Perl distributions, but in case they are not, I recommend using versions
+distributed with your operating system or Perl distribution, not from CPAN.
+Term::ReadKey in particular has been known to cause problems if installed from
+CPAN.
+
+If you have Term::ANSIColor, innotop will use it to format headers more readably
+and compactly.  (Under Microsoft Windows, you also need Win32::Console::ANSI for
+terminal formatting codes to be honored).  If you install Term::ReadLine,
+preferably Term::ReadLine::Gnu, you'll get nice auto-completion support.
+
+I run innotop on Gentoo GNU/Linux, Debian and Ubuntu, and I've had feedback from
+people successfully running it on Red Hat, CentOS, Solaris, and Mac OSX.  I
+don't see any reason why it won't work on other UNIX-ish operating systems, but
+I don't know for sure.  It also runs on Windows under ActivePerl without
+problem.
+
+innotop has been used on MySQL versions 3.23.58, 4.0.27, 4.1.0, 4.1.22, 5.0.26,
+5.1.15, and 5.2.3.  If it doesn't run correctly for you, that is a bug that
+should be reported.
+
+=head1 FILES
+
+$HOMEDIR/.innotop and/or /etc/innotop are used to store
+configuration information.  Files include the configuration file innotop.conf,
+the core_dump file which contains verbose error messages if L<"debug"> is
+enabled, and the plugins/ subdirectory.
+
+=head1 GLOSSARY OF TERMS
+
+=over
+
+=item tick
+
+A tick is a refresh event, when innotop re-fetches data from connections and
+displays it.
+
+=back
+
+=head1 ACKNOWLEDGEMENTS
+
+The following people and organizations are acknowledged for various reasons.
+Hopefully no one has been forgotten.
+
+Allen K. Smith,
+Aurimas Mikalauskas,
+Bartosz Fenski,
+Brian Miezejewski,
+Christian Hammers, 
+Cyril Scetbon,
+Dane Miller,
+David Multer,
+Dr. Frank Ullrich,
+Giuseppe Maxia,
+Google.com Site Reliability Engineers,
+Google Code,
+Jan Pieter Kunst,
+Jari Aalto,
+Jay Pipes,
+Jeremy Zawodny,
+Johan Idren,
+Kristian Kohntopp,
+Lenz Grimmer,
+Maciej Dobrzanski,
+Michiel Betel,
+MySQL AB,
+Paul McCullagh,
+Sebastien Estienne,
+Sourceforge.net,
+Steven Kreuzer,
+The Gentoo MySQL Team,
+Trevor Price,
+Yaar Schnitman,
+and probably more people that have not been included.
+
+(If your name has been misspelled, it's probably out of fear of putting
+international characters into this documentation; earlier versions of Perl might
+not be able to compile it then).
+
+=head1 COPYRIGHT, LICENSE AND WARRANTY
+
+This program is copyright (c) 2006 Baron Schwartz.
+Feedback and improvements are welcome.
+
+THIS PROGRAM IS PROVIDED "AS IS" AND WITHOUT ANY EXPRESS OR IMPLIED
+WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF
+MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.
+
+This program is free software; you can redistribute it and/or modify it under
+the terms of the GNU General Public License as published by the Free Software
+Foundation, version 2; OR the Perl Artistic License.  On UNIX and similar
+systems, you can issue `man perlgpl' or `man perlartistic' to read these
+licenses.
+
+You should have received a copy of the GNU General Public License along with
+this program; if not, write to the Free Software Foundation, Inc., 59 Temple
+Place, Suite 330, Boston, MA  02111-1307  USA.
+
+Execute innotop and press '!' to see this information at any time.
+
+=head1 AUTHOR
+
+Originally written by Baron Schwartz; currently maintained by Aaron Racine.
+
+=head1 BUGS
+
+You can report bugs, ask for improvements, and get other help and support at
+L<http://code.google.com/p/innotop/>.  There are mailing lists, a source code
+browser, a bug tracker, etc.  Please use these instead of contacting the
+maintainer or author directly, as it makes our job easier and benefits others if the
+discussions are permanent and public.  Of course, if you need to contact us in
+private, please do.
+
+=cut
diff -uNr mysql-5.5.60.orig/debian/additions/innotop/innotop.1 mysql-5.5.60/debian/additions/innotop/innotop.1
--- mysql-5.5.60.orig/debian/additions/innotop/innotop.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/innotop/innotop.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,2084 @@
+.\" Automatically generated by Pod::Man 2.1801 (Pod::Simple 3.07)
+.\"
+.\" Standard preamble:
+.\" ========================================================================
+.de Sp \" Vertical space (when we can't use .PP)
+.if t .sp .5v
+.if n .sp
+..
+.de Vb \" Begin verbatim text
+.ft CW
+.nf
+.ne \\$1
+..
+.de Ve \" End verbatim text
+.ft R
+.fi
+..
+.\" Set up some character translations and predefined strings.  \*(-- will
+.\" give an unbreakable dash, \*(PI will give pi, \*(L" will give a left
+.\" double quote, and \*(R" will give a right double quote.  \*(C+ will
+.\" give a nicer C++.  Capital omega is used to do unbreakable dashes and
+.\" therefore won't be available.  \*(C` and \*(C' expand to `' in nroff,
+.\" nothing in troff, for use with C<>.
+.tr \(*W-
+.ds C+ C\v'-.1v'\h'-1p'\s-2+\h'-1p'+\s0\v'.1v'\h'-1p'
+.ie n \{\
+.    ds -- \(*W-
+.    ds PI pi
+.    if (\n(.H=4u)&(1m=24u) .ds -- \(*W\h'-12u'\(*W\h'-12u'-\" diablo 10 pitch
+.    if (\n(.H=4u)&(1m=20u) .ds -- \(*W\h'-12u'\(*W\h'-8u'-\"  diablo 12 pitch
+.    ds L" ""
+.    ds R" ""
+.    ds C` ""
+.    ds C' ""
+'br\}
+.el\{\
+.    ds -- \|\(em\|
+.    ds PI \(*p
+.    ds L" ``
+.    ds R" ''
+'br\}
+.\"
+.\" Escape single quotes in literal strings from groff's Unicode transform.
+.ie \n(.g .ds Aq \(aq
+.el       .ds Aq '
+.\"
+.\" If the F register is turned on, we'll generate index entries on stderr for
+.\" titles (.TH), headers (.SH), subsections (.SS), items (.Ip), and index
+.\" entries marked with X<> in POD.  Of course, you'll have to process the
+.\" output yourself in some meaningful fashion.
+.ie \nF \{\
+.    de IX
+.    tm Index:\\$1\t\\n%\t"\\$2"
+..
+.    nr % 0
+.    rr F
+.\}
+.el \{\
+.    de IX
+..
+.\}
+.\"
+.\" Accent mark definitions (@(#)ms.acc 1.5 88/02/08 SMI; from UCB 4.2).
+.\" Fear.  Run.  Save yourself.  No user-serviceable parts.
+.    \" fudge factors for nroff and troff
+.if n \{\
+.    ds #H 0
+.    ds #V .8m
+.    ds #F .3m
+.    ds #[ \f1
+.    ds #] \fP
+.\}
+.if t \{\
+.    ds #H ((1u-(\\\\n(.fu%2u))*.13m)
+.    ds #V .6m
+.    ds #F 0
+.    ds #[ \&
+.    ds #] \&
+.\}
+.    \" simple accents for nroff and troff
+.if n \{\
+.    ds ' \&
+.    ds ` \&
+.    ds ^ \&
+.    ds , \&
+.    ds ~ ~
+.    ds /
+.\}
+.if t \{\
+.    ds ' \\k:\h'-(\\n(.wu*8/10-\*(#H)'\'\h"|\\n:u"
+.    ds ` \\k:\h'-(\\n(.wu*8/10-\*(#H)'\`\h'|\\n:u'
+.    ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'^\h'|\\n:u'
+.    ds , \\k:\h'-(\\n(.wu*8/10)',\h'|\\n:u'
+.    ds ~ \\k:\h'-(\\n(.wu-\*(#H-.1m)'~\h'|\\n:u'
+.    ds / \\k:\h'-(\\n(.wu*8/10-\*(#H)'\z\(sl\h'|\\n:u'
+.\}
+.    \" troff and (daisy-wheel) nroff accents
+.ds : \\k:\h'-(\\n(.wu*8/10-\*(#H+.1m+\*(#F)'\v'-\*(#V'\z.\h'.2m+\*(#F'.\h'|\\n:u'\v'\*(#V'
+.ds 8 \h'\*(#H'\(*b\h'-\*(#H'
+.ds o \\k:\h'-(\\n(.wu+\w'\(de'u-\*(#H)/2u'\v'-.3n'\*(#[\z\(de\v'.3n'\h'|\\n:u'\*(#]
+.ds d- \h'\*(#H'\(pd\h'-\w'~'u'\v'-.25m'\f2\(hy\fP\v'.25m'\h'-\*(#H'
+.ds D- D\\k:\h'-\w'D'u'\v'-.11m'\z\(hy\v'.11m'\h'|\\n:u'
+.ds th \*(#[\v'.3m'\s+1I\s-1\v'-.3m'\h'-(\w'I'u*2/3)'\s-1o\s+1\*(#]
+.ds Th \*(#[\s+2I\s-2\h'-\w'I'u*3/5'\v'-.3m'o\v'.3m'\*(#]
+.ds ae a\h'-(\w'a'u*4/10)'e
+.ds Ae A\h'-(\w'A'u*4/10)'E
+.    \" corrections for vroff
+.if v .ds ~ \\k:\h'-(\\n(.wu*9/10-\*(#H)'\s-2\u~\d\s+2\h'|\\n:u'
+.if v .ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'\v'-.4m'^\v'.4m'\h'|\\n:u'
+.    \" for low resolution devices (crt and lpr)
+.if \n(.H>23 .if \n(.V>19 \
+\{\
+.    ds : e
+.    ds 8 ss
+.    ds o a
+.    ds d- d\h'-1'\(ga
+.    ds D- D\h'-1'\(hy
+.    ds th \o'bp'
+.    ds Th \o'LP'
+.    ds ae ae
+.    ds Ae AE
+.\}
+.rm #[ #] #H #V #F C
+.\" ========================================================================
+.\"
+.IX Title "INNOTOP 1"
+.TH INNOTOP 1 "2009-03-09" "perl v5.10.0" "User Contributed Perl Documentation"
+.\" For nroff, turn off justification.  Always turn off hyphenation; it makes
+.\" way too many mistakes in technical documents.
+.if n .ad l
+.nh
+.SH "NAME"
+innotop \- MySQL and InnoDB transaction/status monitor.
+.SH "SYNOPSIS"
+.IX Header "SYNOPSIS"
+To monitor servers normally:
+.PP
+.Vb 1
+\& innotop
+.Ve
+.PP
+To monitor InnoDB status information from a file:
+.PP
+.Vb 1
+\& innotop /var/log/mysql/mysqld.err
+.Ve
+.PP
+To run innotop non-interactively in a pipe-and-filter configuration:
+.PP
+.Vb 1
+\& innotop \-\-count 5 \-d 1 \-n
+.Ve
+.PP
+To monitor a database on another system using a particular username and password:
+.PP
+.Vb 1
+\& innotop \-u <username> \-p <password> \-h <hostname>
+.Ve
+.SH "DESCRIPTION"
+.IX Header "DESCRIPTION"
+innotop monitors MySQL servers.  Each of its modes shows you a different aspect
+of what's happening in the server.  For example, there's a mode for monitoring
+replication, one for queries, and one for transactions.  innotop refreshes its
+data periodically, so you see an updating view.
+.PP
+innotop has lots of features for power users, but you can start and run it with
+virtually no configuration.  If you're just getting started, see
+\&\*(L"QUICK-START\*(R".  Press '?' at any time while running innotop for
+context-sensitive help.
+.SH "QUICK-START"
+.IX Header "QUICK-START"
+To start innotop, open a terminal or command prompt.  If you have installed
+innotop on your system, you should be able to just type \*(L"innotop\*(R" and press
+Enter; otherwise, you will need to change to innotop's directory and type \*(L"perl
+innotop\*(R".
+.PP
+With no options specified, innotop will attempt to connect to a MySQL server on
+localhost using mysql_read_default_group=client for other connection
+parameters.  If you need to specify a different username and password, use the
+\&\-u and \-p options, respectively.  To monitor a MySQL database on another
+host, use the \-h option.
+.PP
+After you've connected, innotop should show you something like the following:
+.PP
+.Vb 1
+\& [RO] Query List (? for help) localhost, 01:11:19, 449.44 QPS, 14/7/163 con/run
+\& 
+\& CXN        When   Load  QPS    Slow  QCacheHit  KCacheHit  BpsIn    BpsOut 
+\& localhost  Total  0.00  1.07k   697      0.00%     98.17%  476.83k  242.83k
+\&
+\& CXN        Cmd    ID         User  Host      DB   Time   Query
+\& localhost  Query  766446598  test  10.0.0.1  foo  00:02  INSERT INTO table (
+.Ve
+.PP
+(This sample is truncated at the right so it will fit on a terminal when running
+\&'man innotop')
+.PP
+If your server is busy, you'll see more output.  Notice the first line on the
+screen, which tells you that readonly is set to true ([\s-1RO\s0]), what mode you're
+in and what server you're connected to.  You can change to other modes with
+keystrokes; press 'T' to switch to a list of InnoDB transactions, for example.
+.PP
+Press the '?' key to see what keys are active in the current mode.  You can
+press any of these keys and innotop will either take the requested action or
+prompt you for more input.  If your system has Term::ReadLine support, you can
+use \s-1TAB\s0 and other keys to auto-complete and edit input.
+.PP
+To quit innotop, press the 'q' key.
+.SH "OPTIONS"
+.IX Header "OPTIONS"
+innotop is mostly configured via its configuration file, but some of the
+configuration options can come from the command line.  You can also specify a
+file to monitor for InnoDB status output; see \*(L"\s-1MONITORING\s0 A \s-1FILE\s0\*(R" for more
+details.
+.PP
+You can negate some options by prefixing the option name with \-\-no.  For
+example, \-\-noinc (or \-\-no\-inc) negates \*(L"\-\-inc\*(R".
+.IP "\-\-color" 4
+.IX Item "--color"
+Enable or disable terminal coloring.  Corresponds to the \*(L"color\*(R" config file
+setting.
+.IP "\-\-config" 4
+.IX Item "--config"
+Specifies a configuration file to read.  This option is non-sticky, that is to
+say it does not persist to the configuration file itself.
+.IP "\-\-count" 4
+.IX Item "--count"
+Refresh only the specified number of times (ticks) before exiting.  Each refresh
+is a pause for \*(L"interval\*(R" seconds, followed by requesting data from MySQL
+connections and printing it to the terminal.
+.IP "\-\-delay" 4
+.IX Item "--delay"
+Specifies the amount of time to pause between ticks (refreshes).  Corresponds to
+the configuration option \*(L"interval\*(R".
+.IP "\-\-help" 4
+.IX Item "--help"
+Print a summary of command-line usage and exit.
+.IP "\-\-host" 4
+.IX Item "--host"
+Host to connect to.
+.IP "\-\-inc" 4
+.IX Item "--inc"
+Specifies whether innotop should display absolute numbers or relative numbers
+(offsets from their previous values).  Corresponds to the configuration option
+\&\*(L"status_inc\*(R".
+.IP "\-\-mode" 4
+.IX Item "--mode"
+Specifies the mode in which innotop should start.  Corresponds to the
+configuration option \*(L"mode\*(R".
+.IP "\-\-nonint" 4
+.IX Item "--nonint"
+Enable non-interactive operation.  See \*(L"NON-INTERACTIVE \s-1OPERATION\s0\*(R" for more.
+.IP "\-\-password" 4
+.IX Item "--password"
+Password to use for connection.
+.IP "\-\-port" 4
+.IX Item "--port"
+Port to use for connection.
+.IP "\-\-skipcentral" 4
+.IX Item "--skipcentral"
+Don't read the central configuration file.
+.IP "\-\-user" 4
+.IX Item "--user"
+User to use for connection.
+.IP "\-\-version" 4
+.IX Item "--version"
+Output version information and exit.
+.IP "\-\-write" 4
+.IX Item "--write"
+Sets the configuration option \*(L"readonly\*(R" to 0, making innotop write the
+running configuration to ~/.innotop/innotop.conf on exit, if no configuration
+file was loaded at start-up.
+.SH "HOTKEYS"
+.IX Header "HOTKEYS"
+innotop is interactive, and you control it with key-presses.
+.IP "\(bu" 4
+Uppercase keys switch between modes.
+.IP "\(bu" 4
+Lowercase keys initiate some action within the current mode.
+.IP "\(bu" 4
+Other keys do something special like change configuration or show the
+innotop license.
+.PP
+Press '?' at any time to see the currently active keys and what they do.
+.SH "MODES"
+.IX Header "MODES"
+Each of innotop's modes retrieves and displays a particular type of data from
+the servers you're monitoring.  You switch between modes with uppercase keys.
+The following is a brief description of each mode, in alphabetical order.  To
+switch to the mode, press the key listed in front of its heading in the
+following list:
+.IP "B: InnoDB Buffers" 4
+.IX Item "B: InnoDB Buffers"
+This mode displays information about the InnoDB buffer pool, page statistics,
+insert buffer, and adaptive hash index.  The data comes from \s-1SHOW\s0 \s-1INNODB\s0 \s-1STATUS\s0.
+.Sp
+This mode contains the \*(L"buffer_pool\*(R", \*(L"page_statistics\*(R",
+\&\*(L"insert_buffers\*(R", and \*(L"adaptive_hash_index\*(R" tables by default.
+.IP "C: Command Summary" 4
+.IX Item "C: Command Summary"
+This mode is similar to mytop's Command Summary mode.  It shows the
+\&\*(L"cmd_summary\*(R" table, which looks something like the following:
+.Sp
+.Vb 8
+\& Command Summary (? for help) localhost, 25+07:16:43, 2.45 QPS, 3 thd, 5.0.40
+\& _\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_ Command Summary _\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_
+\& Name                    Value    Pct     Last Incr  Pct    
+\& Select_scan             3244858  69.89%          2  100.00%
+\& Select_range            1354177  29.17%          0    0.00%
+\& Select_full_join          39479   0.85%          0    0.00%
+\& Select_full_range_join     4097   0.09%          0    0.00%
+\& Select_range_check            0   0.00%          0    0.00%
+.Ve
+.Sp
+The command summary table is built by extracting variables from
+\&\*(L"\s-1STATUS_VARIABLES\s0\*(R".  The variables must be numeric and must match the prefix
+given by the \*(L"cmd_filter\*(R" configuration variable.  The variables are then
+sorted by value descending and compared to the last variable, as shown above.
+The percentage columns are percentage of the total of all variables in the
+table, so you can see the relative weight of the variables.
+.Sp
+The example shows what you see if the prefix is \*(L"Select_\*(R".  The default
+prefix is \*(L"Com_\*(R".  You can choose a prefix with the 's' key.
+.Sp
+It's rather like running \s-1SHOW\s0 \s-1VARIABLES\s0 \s-1LIKE\s0 \*(L"prefix%\*(R" with memory and
+nice formatting.
+.Sp
+Values are aggregated across all servers.  The Pct columns are not correctly
+aggregated across multiple servers.  This is a known limitation of the grouping
+algorithm that may be fixed in the future.
+.IP "D: InnoDB Deadlocks" 4
+.IX Item "D: InnoDB Deadlocks"
+This mode shows the transactions involved in the last InnoDB deadlock.  A second
+table shows the locks each transaction held and waited for.  A deadlock is
+caused by a cycle in the waits-for graph, so there should be two locks held and
+one waited for unless the deadlock information is truncated.
+.Sp
+InnoDB puts deadlock information before some other information in the \s-1SHOW\s0
+\&\s-1INNODB\s0 \s-1STATUS\s0 output.  If there are a lot of locks, the deadlock information can
+grow very large, and there is a limit on the size of the \s-1SHOW\s0 \s-1INNODB\s0
+\&\s-1STATUS\s0 output.  A large deadlock can fill the entire output, or even be
+truncated, and prevent you from seeing other information at all.  If you are
+running innotop in another mode, for example T mode, and suddenly you don't see
+anything, you might want to check and see if a deadlock has wiped out the data
+you need.
+.Sp
+If it has, you can create a small deadlock to replace the large one.  Use the
+\&'w' key to 'wipe' the large deadlock with a small one.  This will not work
+unless you have defined a deadlock table for the connection (see \*(L"\s-1SERVER\s0
+\&\s-1CONNECTIONS\s0\*(R").
+.Sp
+You can also configure innotop to automatically detect when a large deadlock
+needs to be replaced with a small one (see \*(L"auto_wipe_dl\*(R").
+.Sp
+This mode displays the \*(L"deadlock_transactions\*(R" and \*(L"deadlock_locks\*(R" tables
+by default.
+.IP "F: InnoDB Foreign Key Errors" 4
+.IX Item "F: InnoDB Foreign Key Errors"
+This mode shows the last InnoDB foreign key error information, such as the
+table where it happened, when and who and what query caused it, and so on.
+.Sp
+InnoDB has a huge variety of foreign key error messages, and many of them are
+just hard to parse.  innotop doesn't always do the best job here, but there's
+so much code devoted to parsing this messy, unparseable output that innotop is
+likely never to be perfect in this regard.  If innotop doesn't show you what
+you need to see, just look at the status text directly.
+.Sp
+This mode displays the \*(L"fk_error\*(R" table by default.
+.IP "I: InnoDB I/O Info" 4
+.IX Item "I: InnoDB I/O Info"
+This mode shows InnoDB's I/O statistics, including the I/O threads, pending I/O,
+file I/O miscellaneous, and log statistics.  It displays the \*(L"io_threads\*(R",
+\&\*(L"pending_io\*(R", \*(L"file_io_misc\*(R", and \*(L"log_statistics\*(R" tables by default.
+.IP "L: Locks" 4
+.IX Item "L: Locks"
+This mode shows information about current locks.  At the moment only InnoDB
+locks are supported, and by default you'll only see locks for which transactions
+are waiting.  This information comes from the \s-1TRANSACTIONS\s0 section of the InnoDB
+status text.  If you have a very busy server, you may have frequent lock waits;
+it helps to be able to see which tables and indexes are the \*(L"hot spot\*(R" for
+locks.  If your server is running pretty well, this mode should show nothing.
+.Sp
+You can configure MySQL and innotop to monitor not only locks for which a
+transaction is waiting, but those currently held, too.  You can do this with the
+InnoDB Lock Monitor (<http://dev.mysql.com/doc/en/innodb\-monitor.html>).  It's
+not documented in the MySQL manual, but creating the lock monitor with the
+following statement also affects the output of \s-1SHOW\s0 \s-1INNODB\s0 \s-1STATUS\s0, which innotop
+uses:
+.Sp
+.Vb 1
+\&  CREATE TABLE innodb_lock_monitor(a int) ENGINE=INNODB;
+.Ve
+.Sp
+This causes InnoDB to print its output to the MySQL file every 16 seconds or so,
+as stated in the manual, but it also makes the normal \s-1SHOW\s0 \s-1INNODB\s0 \s-1STATUS\s0 output
+include lock information, which innotop can parse and display (that's the
+undocumented feature).
+.Sp
+This means you can do what may have seemed impossible: to a limited extent
+(InnoDB truncates some information in the output), you can see which transaction
+holds the locks something else is waiting for.  You can also enable and disable
+the InnoDB Lock Monitor with the key mappings in this mode.
+.Sp
+This mode displays the \*(L"innodb_locks\*(R" table by default.  Here's a sample of
+the screen when one connection is waiting for locks another connection holds:
+.Sp
+.Vb 7
+\& _\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_ InnoDB Locks _\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_\|_
+\& CXN        ID  Type    Waiting  Wait   Active  Mode  DB    Table  Index
+\& localhost  12  RECORD        1  00:10   00:10  X     test  t1     PRIMARY
+\& localhost  12  TABLE         0  00:10   00:10  IX    test  t1
+\& localhost  12  RECORD        1  00:10   00:10  X     test  t1     PRIMARY
+\& localhost  11  TABLE         0  00:00   00:25  IX    test  t1
+\& localhost  11  RECORD        0  00:00   00:25  X     test  t1     PRIMARY
+.Ve
+.Sp
+You can see the first connection, \s-1ID\s0 12, is waiting for a lock on the \s-1PRIMARY\s0
+key on test.t1, and has been waiting for 10 seconds.  The second connection
+isn't waiting, because the Waiting column is 0, but it holds locks on the same
+index.  That tells you connection 11 is blocking connection 12.
+.IP "M: Master/Slave Replication Status" 4
+.IX Item "M: Master/Slave Replication Status"
+This mode shows the output of \s-1SHOW\s0 \s-1SLAVE\s0 \s-1STATUS\s0 and \s-1SHOW\s0 \s-1MASTER\s0 \s-1STATUS\s0 in three
+tables.  The first two divide the slave's status into \s-1SQL\s0 and I/O thread status,
+and the last shows master status.  Filters are applied to eliminate non-slave
+servers from the slave tables, and non-master servers from the master table.
+.Sp
+This mode displays the \*(L"slave_sql_status\*(R", \*(L"slave_io_status\*(R", and
+\&\*(L"master_status\*(R" tables by default.
+.IP "O: Open Tables" 4
+.IX Item "O: Open Tables"
+This section comes from MySQL's \s-1SHOW\s0 \s-1OPEN\s0 \s-1TABLES\s0 command.  By default it is
+filtered to show tables which are in use by one or more queries, so you can
+get a quick look at which tables are 'hot'.  You can use this to guess which
+tables might be locked implicitly.
+.Sp
+This mode displays the \*(L"open_tables\*(R" mode by default.
+.IP "Q: Query List" 4
+.IX Item "Q: Query List"
+This mode displays the output from \s-1SHOW\s0 \s-1FULL\s0 \s-1PROCESSLIST\s0, much like \fBmytop\fR's
+query list mode.  This mode does \fBnot\fR show InnoDB-related information.  This
+is probably one of the most useful modes for general usage.
+.Sp
+There is an informative header that shows general status information about
+your server.  You can toggle it on and off with the 'h' key.  By default,
+innotop hides inactive processes and its own process.  You can toggle these on
+and off with the 'i' and 'a' keys.
+.Sp
+You can \s-1EXPLAIN\s0 a query from this mode with the 'e' key.  This displays the
+query's full text, the results of \s-1EXPLAIN\s0, and in newer MySQL versions, even
+the optimized query resulting from \s-1EXPLAIN\s0 \s-1EXTENDED\s0.  innotop also tries to
+rewrite certain queries to make them EXPLAIN-able.  For example, \s-1INSERT/SELECT\s0
+statements are rewritable.
+.Sp
+This mode displays the \*(L"q_header\*(R" and \*(L"processlist\*(R" tables by default.
+.IP "R: InnoDB Row Operations and Semaphores" 4
+.IX Item "R: InnoDB Row Operations and Semaphores"
+This mode shows InnoDB row operations, row operation miscellaneous, semaphores,
+and information from the wait array.  It displays the \*(L"row_operations\*(R",
+\&\*(L"row_operation_misc\*(R", \*(L"semaphores\*(R", and \*(L"wait_array\*(R" tables by default.
+.IP "S: Variables & Status" 4
+.IX Item "S: Variables & Status"
+This mode calculates statistics, such as queries per second, and prints them out
+in several different styles.  You can show absolute values, or incremental values
+between ticks.
+.Sp
+You can switch between the views by pressing a key.  The 's' key prints a
+single line each time the screen updates, in the style of \fBvmstat\fR.  The 'g'
+key changes the view to a graph of the same numbers, sort of like \fBtload\fR.
+The 'v' key changes the view to a pivoted table of variable names on the left,
+with successive updates scrolling across the screen from left to right.  You can
+choose how many updates to put on the screen with the \*(L"num_status_sets\*(R"
+configuration variable.
+.Sp
+Headers may be abbreviated to fit on the screen in interactive operation.  You
+choose which variables to display with the 'c' key, which selects from
+predefined sets, or lets you create your own sets.  You can edit the current set
+with the 'e' key.
+.Sp
+This mode doesn't really display any tables like other modes.  Instead, it uses
+a table definition to extract and format the data, but it then transforms the
+result in special ways before outputting it.  It uses the \*(L"var_status\*(R" table
+definition for this.
+.IP "T: InnoDB Transactions" 4
+.IX Item "T: InnoDB Transactions"
+This mode shows transactions from the InnoDB monitor's output, in \fBtop\fR\-like
+format.  This mode is the reason I wrote innotop.
+.Sp
+You can kill queries or processes with the 'k' and 'x' keys, and \s-1EXPLAIN\s0 a query
+with the 'e' or 'f' keys.  InnoDB doesn't print the full query in transactions,
+so explaining may not work right if the query is truncated.
+.Sp
+The informational header can be toggled on and off with the 'h' key.  By
+default, innotop hides inactive transactions and its own transaction.  You can
+toggle this on and off with the 'i' and 'a' keys.
+.Sp
+This mode displays the \*(L"t_header\*(R" and \*(L"innodb_transactions\*(R" tables by
+default.
+.SH "INNOTOP STATUS"
+.IX Header "INNOTOP STATUS"
+The first line innotop displays is a \*(L"status bar\*(R" of sorts.  What it contains
+depends on the mode you're in, and what servers you're monitoring.  The first
+few words are always [\s-1RO\s0] (if readonly is set to 1), the innotop mode, such as
+\&\*(L"InnoDB Txns\*(R" for T mode, followed by a reminder to press '?' for help at any
+time.
+.SS "\s-1ONE\s0 \s-1SERVER\s0"
+.IX Subsection "ONE SERVER"
+The simplest case is when you're monitoring a single server.  In this case, the
+name of the connection is next on the status line.  This is the name you gave
+when you created the connection \*(-- most likely the MySQL server's hostname.
+This is followed by the server's uptime.
+.PP
+If you're in an InnoDB mode, such as T or B, the next word is \*(L"InnoDB\*(R" followed
+by some information about the \s-1SHOW\s0 \s-1INNODB\s0 \s-1STATUS\s0 output used to render the
+screen.  The first word is the number of seconds since the last \s-1SHOW\s0 \s-1INNODB\s0
+\&\s-1STATUS\s0, which InnoDB uses to calculate some per-second statistics.  The next is
+a smiley face indicating whether the InnoDB output is truncated.  If the smiley
+face is a :\-), all is well; there is no truncation.  A :^| means the transaction
+list is so long, InnoDB has only printed out some of the transactions.  Finally,
+a frown :\-( means the output is incomplete, which is probably due to a deadlock
+printing too much lock information (see \*(L"D: InnoDB Deadlocks\*(R").
+.PP
+The next two words indicate the server's queries per second (\s-1QPS\s0) and how many
+threads (connections) exist.  Finally, the server's version number is the last
+thing on the line.
+.SS "\s-1MULTIPLE\s0 \s-1SERVERS\s0"
+.IX Subsection "MULTIPLE SERVERS"
+If you are monitoring multiple servers (see \*(L"\s-1SERVER\s0 \s-1CONNECTIONS\s0\*(R"), the status
+line does not show any details about individual servers.  Instead, it shows the
+names of the connections that are active.  Again, these are connection names you
+specified, which are likely to be the server's hostname.  A connection that has
+an error is prefixed with an exclamation point.
+.PP
+If you are monitoring a group of servers (see \*(L"\s-1SERVER\s0 \s-1GROUPS\s0\*(R"), the status
+line shows the name of the group.  If any connection in the group has an
+error, the group's name is followed by the fraction of the connections that
+don't have errors.
+.PP
+See \*(L"\s-1ERROR\s0 \s-1HANDLING\s0\*(R" for more details about innotop's error handling.
+.SS "\s-1MONITORING\s0 A \s-1FILE\s0"
+.IX Subsection "MONITORING A FILE"
+If you give a filename on the command line, innotop will not connect to \s-1ANY\s0
+servers at all.  It will watch the specified file for InnoDB status output and
+use that as its data source.  It will always show a single connection called
+\&'file'.  And since it can't connect to a server, it can't determine how long the
+server it's monitoring has been up; so it calculates the server's uptime as time
+since innotop started running.
+.SH "SERVER ADMINISTRATION"
+.IX Header "SERVER ADMINISTRATION"
+While innotop is primarily a monitor that lets you watch and analyze your
+servers, it can also send commands to servers.  The most frequently useful
+commands are killing queries and stopping or starting slaves.
+.PP
+You can kill a connection, or in newer versions of MySQL kill a query but not a
+connection, from \*(L"Q: Query List\*(R" and \*(L"T: InnoDB Transactions\*(R" modes.
+Press 'k' to issue a \s-1KILL\s0 command, or 'x' to issue a \s-1KILL\s0 \s-1QUERY\s0 command.
+innotop will prompt you for the server and/or connection \s-1ID\s0 to kill (innotop
+does not prompt you if there is only one possible choice for any input).
+innotop pre-selects the longest-running query, or the oldest connection.
+Confirm the command with 'y'.
+.PP
+In \*(L"Slave Replication Status\*(R"\*(L" in \*(R"M: Master mode, you can start and stop slaves
+with the 'a' and 'o' keys, respectively.  You can send these commands to many
+slaves at once.  innotop fills in a default command of \s-1START\s0 \s-1SLAVE\s0 or \s-1STOP\s0 \s-1SLAVE\s0
+for you, but you can actually edit the command and send anything you wish, such
+as \s-1SET\s0 \s-1GLOBAL\s0 SQL_SLAVE_SKIP_COUNTER=1 to make the slave skip one binlog event
+when it starts.
+.PP
+You can also ask innotop to calculate the earliest binlog in use by any slave
+and issue a \s-1PURGE\s0 \s-1MASTER\s0 \s-1LOGS\s0 on the master.  Use the 'b' key for this.  innotop
+will prompt you for a master to run the command on, then prompt you for the
+connection names of that master's slaves (there is no way for innotop to
+determine this reliably itself).  innotop will find the minimum binlog in use by
+these slave connections and suggest it as the argument to \s-1PURGE\s0 \s-1MASTER\s0 \s-1LOGS\s0.
+.SH "SERVER CONNECTIONS"
+.IX Header "SERVER CONNECTIONS"
+When you create a server connection using '@', innotop asks you for a series of
+inputs, as follows:
+.IP "\s-1DSN\s0" 4
+.IX Item "DSN"
+A \s-1DSN\s0 is a Data Source Name, which is the initial argument passed to the \s-1DBI\s0
+module for connecting to a server.  It is usually of the form
+.Sp
+.Vb 1
+\& DBI:mysql:;mysql_read_default_group=mysql;host=HOSTNAME
+.Ve
+.Sp
+Since this \s-1DSN\s0 is passed to the DBD::mysql driver, you should read the driver's
+documentation at \*(L"/search.cpan.org/dist/DBD\-mysql/lib/DBD/mysql.pm\*(R"\*(L" in \*(R"http: for
+the exact details on all the options you can pass the driver in the \s-1DSN\s0.  You
+can read more about \s-1DBI\s0 at <http://dbi.perl.org/docs/>, and especially at
+<http://search.cpan.org/~timb/DBI/DBI.pm>.
+.Sp
+The mysql_read_default_group=mysql option lets the \s-1DBD\s0 driver read your MySQL
+options files, such as ~/.my.cnf on UNIX-ish systems.  You can use this to avoid
+specifying a username or password for the connection.
+.IP "InnoDB Deadlock Table" 4
+.IX Item "InnoDB Deadlock Table"
+This optional item tells innotop a table name it can use to deliberately create
+a small deadlock (see \*(L"D: InnoDB Deadlocks\*(R").  If you specify this option,
+you just need to be sure the table doesn't exist, and that innotop can create
+and drop the table with the InnoDB storage engine.  You can safely omit or just
+accept the default if you don't intend to use this.
+.IP "Username" 4
+.IX Item "Username"
+innotop will ask you if you want to specify a username.  If you say 'y', it will
+then prompt you for a user name.  If you have a MySQL option file that specifies
+your username, you don't have to specify a username.
+.Sp
+The username defaults to your login name on the system you're running innotop on.
+.IP "Password" 4
+.IX Item "Password"
+innotop will ask you if you want to specify a password.  Like the username, the
+password is optional, but there's an additional prompt that asks if you want to
+save the password in the innotop configuration file.  If you don't save it in
+the configuration file, innotop will prompt you for a password each time it
+starts.  Passwords in the innotop configuration file are saved in plain text,
+not encrypted in any way.
+.PP
+Once you finish answering these questions, you should be connected to a server.
+But innotop isn't limited to monitoring a single server; you can define many
+server connections and switch between them by pressing the '@' key.  See
+\&\*(L"\s-1SWITCHING\s0 \s-1BETWEEN\s0 \s-1CONNECTIONS\s0\*(R".
+.SH "SERVER GROUPS"
+.IX Header "SERVER GROUPS"
+If you have multiple MySQL instances, you can put them into named groups, such
+as 'all', 'masters', and 'slaves', which innotop can monitor all together.
+.PP
+You can choose which group to monitor with the '#' key, and you can press the
+\&\s-1TAB\s0 key to switch to the next group.  If you're not currently monitoring a
+group, pressing \s-1TAB\s0 selects the first group.
+.PP
+To create a group, press the '#' key and type the name of your new group, then
+type the names of the connections you want the group to contain.
+.SH "SWITCHING BETWEEN CONNECTIONS"
+.IX Header "SWITCHING BETWEEN CONNECTIONS"
+innotop lets you quickly switch which servers you're monitoring.  The most basic
+way is by pressing the '@' key and typing the name(s) of the connection(s) you
+want to use.  This setting is per-mode, so you can monitor different connections
+in each mode, and innotop remembers which connections you choose.
+.PP
+You can quickly switch to the 'next' connection in alphabetical order with the
+\&'n' key.  If you're monitoring a server group (see \*(L"\s-1SERVER\s0 \s-1GROUPS\s0\*(R") this will
+switch to the first connection.
+.PP
+You can also type many connection names, and innotop will fetch and display data
+from them all.  Just separate the connection names with spaces, for example
+\&\*(L"server1 server2.\*(R"  Again, if you type the name of a connection that doesn't
+exist, innotop will prompt you for connection information and create the
+connection.
+.PP
+Another way to monitor multiple connections at once is with server groups.  You
+can use the \s-1TAB\s0 key to switch to the 'next' group in alphabetical order, or if
+you're not monitoring any groups, \s-1TAB\s0 will switch to the first group.
+.PP
+innotop does not fetch data in parallel from connections, so if you are
+monitoring a large group or many connections, you may notice increased delay
+between ticks.
+.PP
+When you monitor more than one connection, innotop's status bar changes.  See
+\&\*(L"\s-1INNOTOP\s0 \s-1STATUS\s0\*(R".
+.SH "ERROR HANDLING"
+.IX Header "ERROR HANDLING"
+Error handling is not that important when monitoring a single connection, but is
+crucial when you have many active connections.  A crashed server or lost
+connection should not crash innotop.  As a result, innotop will continue to run
+even when there is an error; it just won't display any information from the
+connection that had an error.  Because of this, innotop's behavior might confuse
+you.  It's a feature, not a bug!
+.PP
+innotop does not continue to query connections that have errors, because they
+may slow innotop and make it hard to use, especially if the error is a problem
+connecting and causes a long time-out.  Instead, innotop retries the connection
+occasionally to see if the error still exists.  If so, it will wait until some
+point in the future.  The wait time increases in ticks as the Fibonacci series,
+so it tries less frequently as time passes.
+.PP
+Since errors might only happen in certain modes because of the \s-1SQL\s0 commands
+issued in those modes, innotop keeps track of which mode caused the error.  If
+you switch to a different mode, innotop will retry the connection instead of
+waiting.
+.PP
+By default innotop will display the problem in red text at the bottom of the
+first table on the screen.  You can disable this behavior with the
+\&\*(L"show_cxn_errors_in_tbl\*(R" configuration option, which is enabled by default.
+If the \*(L"debug\*(R" option is enabled, innotop will display the error at the
+bottom of every table, not just the first.  And if \*(L"show_cxn_errors\*(R" is
+enabled, innotop will print the error text to \s-1STDOUT\s0 as well.  Error messages
+might only display in the mode that caused the error, depending on the mode and
+whether innotop is avoiding querying that connection.
+.SH "NON-INTERACTIVE OPERATION"
+.IX Header "NON-INTERACTIVE OPERATION"
+You can run innotop in non-interactive mode, in which case it is entirely
+controlled from the configuration file and command-line options.  To start
+innotop in non-interactive mode, give the L\*(L"<\-\-nonint\*(R"> command-line option.
+This changes innotop's behavior in the following ways:
+.IP "\(bu" 4
+Certain Perl modules are not loaded.  Term::Readline is not loaded, since
+innotop doesn't prompt interactively.  Term::ANSIColor and Win32::Console::ANSI
+modules are not loaded.  Term::ReadKey is still used, since innotop may have to
+prompt for connection passwords when starting up.
+.IP "\(bu" 4
+innotop does not clear the screen after each tick.
+.IP "\(bu" 4
+innotop does not persist any changes to the configuration file.
+.IP "\(bu" 4
+If \*(L"\-\-count\*(R" is given and innotop is in incremental mode (see \*(L"status_inc\*(R"
+and \*(L"\-\-inc\*(R"), innotop actually refreshes one more time than specified so it
+can print incremental statistics.  This suppresses output during the first
+tick, so innotop may appear to hang.
+.IP "\(bu" 4
+innotop only displays the first table in each mode.  This is so the output can
+be easily processed with other command-line utilities such as awk and sed.  To
+change which tables display in each mode, see \*(L"\s-1TABLES\s0\*(R".  Since \*(L"Q: Query
+List\*(R" mode is so important, innotop automatically disables the \*(L"q_header\*(R"
+table.  This ensures you'll see the \*(L"processlist\*(R" table, even if you have
+innotop configured to show the q_header table during interactive operation.
+Similarly, in \*(L"T: InnoDB Transactions\*(R" mode, the \*(L"t_header\*(R" table is
+suppressed so you see only the \*(L"innodb_transactions\*(R" table.
+.IP "\(bu" 4
+All output is tab-separated instead of being column-aligned with whitespace, and
+innotop prints the full contents of each table instead of only printing one
+screenful at a time.
+.IP "\(bu" 4
+innotop only prints column headers once instead of every tick (see
+\&\*(L"hide_hdr\*(R").  innotop does not print table captions (see
+\&\*(L"display_table_captions\*(R").  innotop ensures there are no empty lines in the
+output.
+.IP "\(bu" 4
+innotop does not honor the \*(L"shorten\*(R" transformation, which normally shortens
+some numbers to human-readable formats.
+.IP "\(bu" 4
+innotop does not print a status line (see \*(L"\s-1INNOTOP\s0 \s-1STATUS\s0\*(R").
+.SH "CONFIGURING"
+.IX Header "CONFIGURING"
+Nearly everything about innotop is configurable.  Most things are possible to
+change with built-in commands, but you can also edit the configuration file.
+.PP
+While running innotop, press the '$' key to bring up the configuration editing
+dialog.  Press another key to select the type of data you want to edit:
+.IP "S: Statement Sleep Times" 4
+.IX Item "S: Statement Sleep Times"
+Edits \s-1SQL\s0 statement sleep delays, which make innotop pause for the specified
+amount of time after executing a statement.  See \*(L"\s-1SQL\s0 \s-1STATEMENTS\s0\*(R" for a
+definition of each statement and what it does.  By default innotop does not
+delay after any statements.
+.Sp
+This feature is included so you can customize the side-effects caused by
+monitoring your server.  You may not see any effects, but some innotop users
+have noticed that certain MySQL versions under very high load with InnoDB
+enabled take longer than usual to execute \s-1SHOW\s0 \s-1GLOBAL\s0 \s-1STATUS\s0.  If innotop calls
+\&\s-1SHOW\s0 \s-1FULL\s0 \s-1PROCESSLIST\s0 immediately afterward, the processlist contains more
+queries than the machine actually averages at any given moment.  Configuring
+innotop to pause briefly after calling \s-1SHOW\s0 \s-1GLOBAL\s0 \s-1STATUS\s0 alleviates this
+effect.
+.Sp
+Sleep times are stored in the \*(L"stmt_sleep_times\*(R" section of the configuration
+file.  Fractional-second sleeps are supported, subject to your hardware's
+limitations.
+.IP "c: Edit Columns" 4
+.IX Item "c: Edit Columns"
+Starts the table editor on one of the displayed tables.  See \*(L"\s-1TABLE\s0 \s-1EDITOR\s0\*(R".
+An alternative way to start the table editor without entering the configuration
+dialog is with the '^' key.
+.IP "g: General Configuration" 4
+.IX Item "g: General Configuration"
+Starts the configuration editor to edit global and mode-specific configuration
+variables (see \*(L"\s-1MODES\s0\*(R").  innotop prompts you to choose a variable from among
+the global and mode-specific ones depending on the current mode.
+.IP "k: Row-Coloring Rules" 4
+.IX Item "k: Row-Coloring Rules"
+Starts the row-coloring rules editor on one of the displayed table(s).  See
+\&\*(L"\s-1COLORS\s0\*(R" for details.
+.IP "p: Manage Plugins" 4
+.IX Item "p: Manage Plugins"
+Starts the plugin configuration editor.  See \*(L"\s-1PLUGINS\s0\*(R" for details.
+.IP "s: Server Groups" 4
+.IX Item "s: Server Groups"
+Lets you create and edit server groups.  See \*(L"\s-1SERVER\s0 \s-1GROUPS\s0\*(R".
+.IP "t: Choose Displayed Tables" 4
+.IX Item "t: Choose Displayed Tables"
+Lets you choose which tables to display in this mode.  See \*(L"\s-1MODES\s0\*(R" and
+\&\*(L"\s-1TABLES\s0\*(R".
+.SH "CONFIGURATION FILE"
+.IX Header "CONFIGURATION FILE"
+innotop's default configuration file locations are \f(CW$HOME\fR/.innotop and
+/etc/innotop/innotop.conf, and they are looked for in that order.  If the first
+configuration file exists, the second will not be processed.  Those can be
+overridden with the \*(L"\-\-config\*(R" command-line option.  You can edit it by hand
+safely, however innotop reads the configuration file when it starts, and, if
+readonly is set to 0, writes it out again when it exits.  Thus, if readonly is
+set to 0, any changes you make by hand while innotop is running will be lost.
+.PP
+innotop doesn't store its entire configuration in the configuration file.  It
+has a huge set of default configuration values that it holds only in memory,
+and the configuration file only overrides these defaults.  When you customize a
+default setting, innotop notices, and then stores the customizations into the
+file.  This keeps the file size down, makes it easier to edit, and makes
+upgrades easier.
+.PP
+A configuration file is read-only be default.  You can override that with
+\&\*(L"\-\-write\*(R".  See \*(L"readonly\*(R".
+.PP
+The configuration file is arranged into sections like an \s-1INI\s0 file.  Each
+section begins with [section\-name] and ends with [/section\-name].  Each
+section's entries have a different syntax depending on the data they need to
+store.  You can put comments in the file; any line that begins with a #
+character is a comment.  innotop will not read the comments, so it won't write
+them back out to the file when it exits.  Comments in read-only configuration
+files are still useful, though.
+.PP
+The first line in the file is innotop's version number.  This lets innotop
+notice when the file format is not backwards-compatible, and upgrade smoothly
+without destroying your customized configuration.
+.PP
+The following list describes each section of the configuration file and the data
+it contains:
+.IP "general" 4
+.IX Item "general"
+The 'general' section contains global configuration variables and variables that
+may be mode-specific, but don't belong in any other section.  The syntax is a
+simple key=value list.  innotop writes a comment above each value to help you
+edit the file by hand.
+.RS 4
+.IP "S_func" 4
+.IX Item "S_func"
+Controls S mode presentation (see \*(L"S: Variables & Status\*(R").  If g, values are
+graphed; if s, values are like vmstat; if p, values are in a pivoted table.
+.IP "S_set" 4
+.IX Item "S_set"
+Specifies which set of variables to display in \*(L"S: Variables & Status\*(R" mode.
+See \*(L"\s-1VARIABLE\s0 \s-1SETS\s0\*(R".
+.IP "auto_wipe_dl" 4
+.IX Item "auto_wipe_dl"
+Instructs innotop to automatically wipe large deadlocks when it notices them.
+When this happens you may notice a slight delay.  At the next tick, you will
+usually see the information that was being truncated by the large deadlock.
+.IP "charset" 4
+.IX Item "charset"
+Specifies what kind of characters to allow through the \*(L"no_ctrl_char\*(R"
+transformation.  This keeps non-printable characters from confusing a
+terminal when you monitor queries that contain binary data, such as images.
+.Sp
+The default is 'ascii', which considers anything outside normal \s-1ASCII\s0 to be a
+control character.  The other allowable values are 'unicode' and 'none'.  'none'
+considers every character a control character, which can be useful for
+collapsing \s-1ALL\s0 text fields in queries.
+.IP "cmd_filter" 4
+.IX Item "cmd_filter"
+This is the prefix that filters variables in \*(L"C: Command Summary\*(R" mode.
+.IP "color" 4
+.IX Item "color"
+Whether terminal coloring is permitted.
+.IP "cxn_timeout" 4
+.IX Item "cxn_timeout"
+On MySQL versions 4.0.3 and newer, this variable is used to set the connection's
+timeout, so MySQL doesn't close the connection if it is not used for a while.
+This might happen because a connection isn't monitored in a particular mode, for
+example.
+.IP "debug" 4
+.IX Item "debug"
+This option enables more verbose errors and makes innotop more strict in some
+places.  It can help in debugging filters and other user-defined code.  It also
+makes innotop write a lot of information to \*(L"debugfile\*(R" when there is a
+crash.
+.IP "debugfile" 4
+.IX Item "debugfile"
+A file to which innotop will write information when there is a crash.  See
+\&\*(L"\s-1FILES\s0\*(R".
+.IP "display_table_captions" 4
+.IX Item "display_table_captions"
+innotop displays a table caption above most tables.  This variable suppresses or
+shows captions on all tables globally.  Some tables are configured with the
+hide_caption property, which overrides this.
+.IP "global" 4
+.IX Item "global"
+Whether to show \s-1GLOBAL\s0 variables and status.  innotop only tries to do this on
+servers which support the \s-1GLOBAL\s0 option to \s-1SHOW\s0 \s-1VARIABLES\s0 and \s-1SHOW\s0 \s-1STATUS\s0.  In
+some MySQL versions, you need certain privileges to do this; if you don't have
+them, innotop will not be able to fetch any variable and status data.  This
+configuration variable lets you run innotop and fetch what data you can even
+without the elevated privileges.
+.Sp
+I can no longer find or reproduce the situation where \s-1GLOBAL\s0 wasn't allowed, but
+I know there was one.
+.IP "graph_char" 4
+.IX Item "graph_char"
+Defines the character to use when drawing graphs in \*(L"S: Variables & Status\*(R"
+mode.
+.IP "header_highlight" 4
+.IX Item "header_highlight"
+Defines how to highlight column headers.  This only works if Term::ANSIColor is
+available.  Valid values are 'bold' and 'underline'.
+.IP "hide_hdr" 4
+.IX Item "hide_hdr"
+Hides column headers globally.
+.IP "interval" 4
+.IX Item "interval"
+The interval at which innotop will refresh its data (ticks).  The interval is
+implemented as a sleep time between ticks, so the true interval will vary
+depending on how long it takes innotop to fetch and render data.
+.Sp
+This variable accepts fractions of a second.
+.IP "mode" 4
+.IX Item "mode"
+The mode in which innotop should start.  Allowable arguments are the same as the
+key presses that select a mode interactively.  See \*(L"\s-1MODES\s0\*(R".
+.IP "num_digits" 4
+.IX Item "num_digits"
+How many digits to show in fractional numbers and percents.  This variable's
+range is between 0 and 9 and can be set directly from \*(L"S: Variables & Status\*(R"
+mode with the '+' and '\-' keys.  It is used in the \*(L"set_precision\*(R",
+\&\*(L"shorten\*(R", and \*(L"percent\*(R" transformations.
+.IP "num_status_sets" 4
+.IX Item "num_status_sets"
+Controls how many sets of status variables to display in pivoted \*(L"S: Variables
+& Status\*(R" mode.  It also controls the number of old sets of variables innotop
+keeps in its memory, so the larger this variable is, the more memory innotop
+uses.
+.IP "plugin_dir" 4
+.IX Item "plugin_dir"
+Specifies where plugins can be found.  By default, innotop stores plugins in the
+\&'plugins' subdirectory of your innotop configuration directory.
+.IP "readonly" 4
+.IX Item "readonly"
+Whether the configuration file is readonly.  This cannot be set interactively.
+.IP "show_cxn_errors" 4
+.IX Item "show_cxn_errors"
+Makes innotop print connection errors to \s-1STDOUT\s0.  See \*(L"\s-1ERROR\s0 \s-1HANDLING\s0\*(R".
+.IP "show_cxn_errors_in_tbl" 4
+.IX Item "show_cxn_errors_in_tbl"
+Makes innotop display connection errors as rows in the first table on screen.
+See \*(L"\s-1ERROR\s0 \s-1HANDLING\s0\*(R".
+.IP "show_percent" 4
+.IX Item "show_percent"
+Adds a '%' character after the value returned by the \*(L"percent\*(R"
+transformation.
+.IP "show_statusbar" 4
+.IX Item "show_statusbar"
+Controls whether to show the status bar in the display.  See \*(L"\s-1INNOTOP\s0
+\&\s-1STATUS\s0\*(R".
+.IP "skip_innodb" 4
+.IX Item "skip_innodb"
+Disables fetching \s-1SHOW\s0 \s-1INNODB\s0 \s-1STATUS\s0, in case your server(s) do not have InnoDB
+enabled and you don't want innotop to try to fetch it.  This can also be useful
+when you don't have the \s-1SUPER\s0 privilege, required to run \s-1SHOW\s0 \s-1INNODB\s0 \s-1STATUS\s0.
+.IP "status_inc" 4
+.IX Item "status_inc"
+Whether to show absolute or incremental values for status variables.
+Incremental values are calculated as an offset from the last value innotop saw
+for that variable.  This is a global setting, but will probably become
+mode-specific at some point.  Right now it is honored a bit inconsistently; some
+modes don't pay attention to it.
+.RE
+.RS 4
+.RE
+.IP "plugins" 4
+.IX Item "plugins"
+This section holds a list of package names of active plugins.  If the plugin
+exists, innotop will activate it.  See \*(L"\s-1PLUGINS\s0\*(R" for more information.
+.IP "filters" 4
+.IX Item "filters"
+This section holds user-defined filters (see \*(L"\s-1FILTERS\s0\*(R").  Each line is in the
+format filter_name=text='filter text' tbls='table list'.
+.Sp
+The filter text is the text of the subroutine's code.  The table list is a list
+of tables to which the filter can apply.  By default, user-defined filters apply
+to the table for which they were created, but you can manually override that by
+editing the definition in the configuration file.
+.IP "active_filters" 4
+.IX Item "active_filters"
+This section stores which filters are active on each table.  Each line is in the
+format table_name=filter_list.
+.IP "tbl_meta" 4
+.IX Item "tbl_meta"
+This section stores user-defined or user-customized columns (see \*(L"\s-1COLUMNS\s0\*(R").
+Each line is in the format col_name=properties, where the properties are a
+name=quoted\-value list.
+.IP "connections" 4
+.IX Item "connections"
+This section holds the server connections you have defined.  Each line is in
+the format name=properties, where the properties are a name=value list.  The
+properties are self-explanatory, and the only one that is treated specially is
+\&'pass' which is only present if 'savepass' is set.  This section of the
+configuration file will be skipped if any \s-1DSN\s0, username, or password
+command-line options are used.  See \*(L"\s-1SERVER\s0 \s-1CONNECTIONS\s0\*(R".
+.IP "active_connections" 4
+.IX Item "active_connections"
+This section holds a list of which connections are active in each mode.  Each
+line is in the format mode_name=connection_list.
+.IP "server_groups" 4
+.IX Item "server_groups"
+This section holds server groups.  Each line is in the format
+name=connection_list.  See \*(L"\s-1SERVER\s0 \s-1GROUPS\s0\*(R".
+.IP "active_server_groups" 4
+.IX Item "active_server_groups"
+This section holds a list of which server group is active in each mode.  Each
+line is in the format mode_name=server_group.
+.IP "max_values_seen" 4
+.IX Item "max_values_seen"
+This section holds the maximum values seen for variables.  This is used to scale
+the graphs in \*(L"S: Variables & Status\*(R" mode.  Each line is in the format
+name=value.
+.IP "active_columns" 4
+.IX Item "active_columns"
+This section holds table column lists.  Each line is in the format
+tbl_name=column_list.  See \*(L"\s-1COLUMNS\s0\*(R".
+.IP "sort_cols" 4
+.IX Item "sort_cols"
+This section holds the sort definition.  Each line is in the format
+tbl_name=column_list.  If a column is prefixed with '\-', that column sorts
+descending.  See \*(L"\s-1SORTING\s0\*(R".
+.IP "visible_tables" 4
+.IX Item "visible_tables"
+This section defines which tables are visible in each mode.  Each line is in the
+format mode_name=table_list.  See \*(L"\s-1TABLES\s0\*(R".
+.IP "varsets" 4
+.IX Item "varsets"
+This section defines variable sets for use in \*(L"S: Status & Variables\*(R" mode.
+Each line is in the format name=variable_list.  See \*(L"\s-1VARIABLE\s0 \s-1SETS\s0\*(R".
+.IP "colors" 4
+.IX Item "colors"
+This section defines colorization rules.  Each line is in the format
+tbl_name=property_list.  See \*(L"\s-1COLORS\s0\*(R".
+.IP "stmt_sleep_times" 4
+.IX Item "stmt_sleep_times"
+This section contains statement sleep times.  Each line is in the format
+statement_name=sleep_time.  See \*(L"S: Statement Sleep Times\*(R".
+.IP "group_by" 4
+.IX Item "group_by"
+This section contains column lists for table group_by expressions.  Each line is
+in the format tbl_name=column_list.  See \*(L"\s-1GROUPING\s0\*(R".
+.SH "CUSTOMIZING"
+.IX Header "CUSTOMIZING"
+You can customize innotop a great deal.  For example, you can:
+.IP "\(bu" 4
+Choose which tables to display, and in what order.
+.IP "\(bu" 4
+Choose which columns are in those tables, and create new columns.
+.IP "\(bu" 4
+Filter which rows display with built-in filters, user-defined filters, and
+quick-filters.
+.IP "\(bu" 4
+Sort the rows to put important data first or group together related rows.
+.IP "\(bu" 4
+Highlight rows with color.
+.IP "\(bu" 4
+Customize the alignment, width, and formatting of columns, and apply
+transformations to columns to extract parts of their values or format the values
+as you wish (for example, shortening large numbers to familiar units).
+.IP "\(bu" 4
+Design your own expressions to extract and combine data as you need.  This gives
+you unlimited flexibility.
+.PP
+All these and more are explained in the following sections.
+.SS "\s-1TABLES\s0"
+.IX Subsection "TABLES"
+A table is what you'd expect: a collection of columns.  It also has some other
+properties, such as a caption.  Filters, sorting rules, and colorization rules
+belong to tables and are covered in later sections.
+.PP
+Internally, table meta-data is defined in a data structure called \f(CW%tbl_meta\fR.
+This hash holds all built-in table definitions, which contain a lot of default
+instructions to innotop.  The meta-data includes the caption, a list of columns
+the user has customized, a list of columns, a list of visible columns, a list of
+filters, color rules, a sort-column list, sort direction, and some information
+about the table's data sources.  Most of this is customizable via the table
+editor (see \*(L"\s-1TABLE\s0 \s-1EDITOR\s0\*(R").
+.PP
+You can choose which tables to show by pressing the '$' key.  See \*(L"\s-1MODES\s0\*(R" and
+\&\*(L"\s-1TABLES\s0\*(R".
+.PP
+The table life-cycle is as follows:
+.IP "\(bu" 4
+Each table begins with a data source, which is an array of hashes.  See below
+for details on data sources.
+.IP "\(bu" 4
+Each element of the data source becomes a row in the final table.
+.IP "\(bu" 4
+For each element in the data source, innotop extracts values from the source and
+creates a row.  This row is another hash, which later steps will refer to as
+\&\f(CW$set\fR.  The values innotop extracts are determined by the table's columns.  Each
+column has an extraction subroutine, compiled from an expression (see
+\&\*(L"\s-1EXPRESSIONS\s0\*(R").  The resulting row is a hash whose keys are named the same as
+the column name.
+.IP "\(bu" 4
+innotop filters the rows, removing those that don't need to be displayed.  See
+\&\*(L"\s-1FILTERS\s0\*(R".
+.IP "\(bu" 4
+innotop sorts the rows.  See \*(L"\s-1SORTING\s0\*(R".
+.IP "\(bu" 4
+innotop groups the rows together, if specified.  See \*(L"\s-1GROUPING\s0\*(R".
+.IP "\(bu" 4
+innotop colorizes the rows.  See \*(L"\s-1COLORS\s0\*(R".
+.IP "\(bu" 4
+innotop transforms the column values in each row.  See \*(L"\s-1TRANSFORMATIONS\s0\*(R".
+.IP "\(bu" 4
+innotop optionally pivots the rows (see \*(L"\s-1PIVOTING\s0\*(R"), then filters and sorts
+them.
+.IP "\(bu" 4
+innotop formats and justifies the rows as a table.  During this step, innotop
+applies further formatting to the column values, including alignment, maximum
+and minimum widths.  innotop also does final error checking to ensure there are
+no crashes due to undefined values.  innotop then adds a caption if specified,
+and the table is ready to print.
+.PP
+The lifecycle is slightly different if the table is pivoted, as noted above.  To
+clarify, if the table is pivoted, the process is extract, group, transform,
+pivot, filter, sort, create.  If it's not pivoted, the process is extract,
+filter, sort, group, color, transform, create.  This slightly convoluted process
+doesn't map all that well to \s-1SQL\s0, but pivoting complicates things pretty
+thoroughly.  Roughly speaking, filtering and sorting happen as late as needed to
+effect the final result as you might expect, but as early as possible for
+efficiency.
+.PP
+Each built-in table is described below:
+.IP "adaptive_hash_index" 4
+.IX Item "adaptive_hash_index"
+Displays data about InnoDB's adaptive hash index.  Data source:
+\&\*(L"\s-1STATUS_VARIABLES\s0\*(R".
+.IP "buffer_pool" 4
+.IX Item "buffer_pool"
+Displays data about InnoDB's buffer pool.  Data source: \*(L"\s-1STATUS_VARIABLES\s0\*(R".
+.IP "cmd_summary" 4
+.IX Item "cmd_summary"
+Displays weighted status variables.  Data source: \*(L"\s-1STATUS_VARIABLES\s0\*(R".
+.IP "deadlock_locks" 4
+.IX Item "deadlock_locks"
+Shows which locks were held and waited for by the last detected deadlock.  Data
+source: \*(L"\s-1DEADLOCK_LOCKS\s0\*(R".
+.IP "deadlock_transactions" 4
+.IX Item "deadlock_transactions"
+Shows transactions involved in the last detected deadlock.  Data source:
+\&\*(L"\s-1DEADLOCK_TRANSACTIONS\s0\*(R".
+.IP "explain" 4
+.IX Item "explain"
+Shows the output of \s-1EXPLAIN\s0.  Data source: \*(L"\s-1EXPLAIN\s0\*(R".
+.IP "file_io_misc" 4
+.IX Item "file_io_misc"
+Displays data about InnoDB's file and I/O operations.  Data source:
+\&\*(L"\s-1STATUS_VARIABLES\s0\*(R".
+.IP "fk_error" 4
+.IX Item "fk_error"
+Displays various data about InnoDB's last foreign key error.  Data source:
+\&\*(L"\s-1STATUS_VARIABLES\s0\*(R".
+.IP "innodb_locks" 4
+.IX Item "innodb_locks"
+Displays InnoDB locks.  Data source: \*(L"\s-1INNODB_LOCKS\s0\*(R".
+.IP "innodb_transactions" 4
+.IX Item "innodb_transactions"
+Displays data about InnoDB's current transactions.  Data source:
+\&\*(L"\s-1INNODB_TRANSACTIONS\s0\*(R".
+.IP "insert_buffers" 4
+.IX Item "insert_buffers"
+Displays data about InnoDB's insert buffer.  Data source: \*(L"\s-1STATUS_VARIABLES\s0\*(R".
+.IP "io_threads" 4
+.IX Item "io_threads"
+Displays data about InnoDB's I/O threads.  Data source: \*(L"\s-1IO_THREADS\s0\*(R".
+.IP "log_statistics" 4
+.IX Item "log_statistics"
+Displays data about InnoDB's logging system.  Data source: \*(L"\s-1STATUS_VARIABLES\s0\*(R".
+.IP "master_status" 4
+.IX Item "master_status"
+Displays replication master status.  Data source: \*(L"\s-1STATUS_VARIABLES\s0\*(R".
+.IP "open_tables" 4
+.IX Item "open_tables"
+Displays open tables.  Data source: \*(L"\s-1OPEN_TABLES\s0\*(R".
+.IP "page_statistics" 4
+.IX Item "page_statistics"
+Displays InnoDB page statistics.  Data source: \*(L"\s-1STATUS_VARIABLES\s0\*(R".
+.IP "pending_io" 4
+.IX Item "pending_io"
+Displays InnoDB pending I/O operations.  Data source: \*(L"\s-1STATUS_VARIABLES\s0\*(R".
+.IP "processlist" 4
+.IX Item "processlist"
+Displays current MySQL processes (threads/connections).  Data source:
+\&\*(L"\s-1PROCESSLIST\s0\*(R".
+.IP "q_header" 4
+.IX Item "q_header"
+Displays various status values.  Data source: \*(L"\s-1STATUS_VARIABLES\s0\*(R".
+.IP "row_operation_misc" 4
+.IX Item "row_operation_misc"
+Displays data about InnoDB's row operations.  Data source:
+\&\*(L"\s-1STATUS_VARIABLES\s0\*(R".
+.IP "row_operations" 4
+.IX Item "row_operations"
+Displays data about InnoDB's row operations.  Data source:
+\&\*(L"\s-1STATUS_VARIABLES\s0\*(R".
+.IP "semaphores" 4
+.IX Item "semaphores"
+Displays data about InnoDB's semaphores and mutexes.  Data source:
+\&\*(L"\s-1STATUS_VARIABLES\s0\*(R".
+.IP "slave_io_status" 4
+.IX Item "slave_io_status"
+Displays data about the slave I/O thread.  Data source: 
+\&\*(L"\s-1STATUS_VARIABLES\s0\*(R".
+.IP "slave_sql_status" 4
+.IX Item "slave_sql_status"
+Displays data about the slave \s-1SQL\s0 thread.  Data source: \*(L"\s-1STATUS_VARIABLES\s0\*(R".
+.IP "t_header" 4
+.IX Item "t_header"
+Displays various InnoDB status values.  Data source: \*(L"\s-1STATUS_VARIABLES\s0\*(R".
+.IP "var_status" 4
+.IX Item "var_status"
+Displays user-configurable data.  Data source: \*(L"\s-1STATUS_VARIABLES\s0\*(R".
+.IP "wait_array" 4
+.IX Item "wait_array"
+Displays data about InnoDB's \s-1OS\s0 wait array.  Data source: \*(L"\s-1OS_WAIT_ARRAY\s0\*(R".
+.SS "\s-1COLUMNS\s0"
+.IX Subsection "COLUMNS"
+Columns belong to tables.  You can choose a table's columns by pressing the '^'
+key, which starts the \*(L"\s-1TABLE\s0 \s-1EDITOR\s0\*(R" and lets you choose and edit columns.
+Pressing 'e' from within the table editor lets you edit the column's properties:
+.IP "\(bu" 4
+hdr: a column header.  This appears in the first row of the table.
+.IP "\(bu" 4
+just: justification.  '\-' means left-justified and '' means right-justified,
+just as with printf formatting codes (not a coincidence).
+.IP "\(bu" 4
+dec: whether to further align the column on the decimal point.
+.IP "\(bu" 4
+num: whether the column is numeric.  This affects how values are sorted
+(lexically or numerically).
+.IP "\(bu" 4
+label: a small note about the column, which appears in dialogs that help the
+user choose columns.
+.IP "\(bu" 4
+src: an expression that innotop uses to extract the column's data from its
+source (see \*(L"\s-1DATA\s0 \s-1SOURCES\s0\*(R").  See \*(L"\s-1EXPRESSIONS\s0\*(R" for more on expressions.
+.IP "\(bu" 4
+minw: specifies a minimum display width.  This helps stabilize the display,
+which makes it easier to read if the data is changing frequently.
+.IP "\(bu" 4
+maxw: similar to minw.
+.IP "\(bu" 4
+trans: a list of column transformations.  See \*(L"\s-1TRANSFORMATIONS\s0\*(R".
+.IP "\(bu" 4
+agg: an aggregate function.  See \*(L"\s-1GROUPING\s0\*(R".  The default is \*(L"first\*(R".
+.IP "\(bu" 4
+aggonly: controls whether the column only shows when grouping is enabled on the
+table (see \*(L"\s-1GROUPING\s0\*(R").  By default, this is disabled.  This means columns
+will always be shown by default, whether grouping is enabled or not.  If a
+column's aggonly is set true, the column will appear when you toggle grouping on
+the table.  Several columns are set this way, such as the count column on
+\&\*(L"processlist\*(R" and \*(L"innodb_transactions\*(R", so you don't see a count when the
+grouping isn't enabled, but you do when it is.
+.SS "\s-1FILTERS\s0"
+.IX Subsection "FILTERS"
+Filters remove rows from the display.  They behave much like a \s-1WHERE\s0 clause in
+\&\s-1SQL\s0.  innotop has several built-in filters, which remove irrelevant information
+like inactive queries, but you can define your own as well.  innotop also lets
+you create quick-filters, which do not get saved to the configuration file, and
+are just an easy way to quickly view only some rows.
+.PP
+You can enable or disable a filter on any table.  Press the '%' key (mnemonic: %
+looks kind of like a line being filtered between two circles) and choose which
+table you want to filter, if asked.  You'll then see a list of possible filters
+and a list of filters currently enabled for that table.  Type the names of
+filters you want to apply and press Enter.
+.PP
+\fIUSER-DEFINED \s-1FILTERS\s0\fR
+.IX Subsection "USER-DEFINED FILTERS"
+.PP
+If you type a name that doesn't exist, innotop will prompt you to create the
+filter.  Filters are easy to create if you know Perl, and not hard if you don't.
+What you're doing is creating a subroutine that returns true if the row should
+be displayed.  The row is a hash reference passed to your subroutine as \f(CW$set\fR.
+.PP
+For example, imagine you want to filter the processlist table so you only see
+queries that have been running more than five minutes.  Type a new name for your
+filter, and when prompted for the subroutine body, press \s-1TAB\s0 to initiate your
+terminal's auto-completion.  You'll see the names of the columns in the
+\&\*(L"processlist\*(R" table (innotop generally tries to help you with auto-completion
+lists).  You want to filter on the 'time' column.  Type the text \*(L"$set\->{time} >
+300\*(R" to return true when the query is more than five minutes old.  That's all
+you need to do.
+.PP
+In other words, the code you're typing is surrounded by an implicit context,
+which looks like this:
+.PP
+.Vb 4
+\& sub filter {
+\&    my ( $set ) = @_;
+\&    # YOUR CODE HERE
+\& }
+.Ve
+.PP
+If your filter doesn't work, or if something else suddenly behaves differently,
+you might have made an error in your filter, and innotop is silently catching
+the error.  Try enabling \*(L"debug\*(R" to make innotop throw an error instead.
+.PP
+\fIQUICK-FILTERS\fR
+.IX Subsection "QUICK-FILTERS"
+.PP
+innotop's quick-filters are a shortcut to create a temporary filter that doesn't
+persist when you restart innotop.  To create a quick-filter, press the '/' key.
+innotop will prompt you for the column name and filter text.  Again, you can use
+auto-completion on column names.  The filter text can be just the text you want
+to \*(L"search for.\*(R"  For example, to filter the \*(L"processlist\*(R" table on queries
+that refer to the products table, type '/' and then 'info product'.
+.PP
+The filter text can actually be any Perl regular expression, but of course a
+literal string like 'product' works fine as a regular expression.
+.PP
+Behind the scenes innotop compiles the quick-filter into a specially tagged
+filter that is otherwise like any other filter.  It just isn't saved to the
+configuration file.
+.PP
+To clear quick-filters, press the '\e' key and innotop will clear them all at
+once.
+.SS "\s-1SORTING\s0"
+.IX Subsection "SORTING"
+innotop has sensible built-in defaults to sort the most important rows to the
+top of the table.  Like anything else in innotop, you can customize how any
+table is sorted.
+.PP
+To start the sort dialog, start the \*(L"\s-1TABLE\s0 \s-1EDITOR\s0\*(R" with the '^' key, choose a
+table if necessary, and press the 's' key.  You'll see a list of columns you can
+use in the sort expression and the current sort expression, if any.  Enter a
+list of columns by which you want to sort and press Enter.  If you want to
+reverse sort, prefix the column name with a minus sign.  For example, if you
+want to sort by column a ascending, then column b descending, type 'a \-b'.  You
+can also explicitly add a + in front of columns you want to sort ascending, but
+it's not required.
+.PP
+Some modes have keys mapped to open this dialog directly, and to quickly reverse
+sort direction.  Press '?' as usual to see which keys are mapped in any mode.
+.SS "\s-1GROUPING\s0"
+.IX Subsection "GROUPING"
+innotop can group, or aggregate, rows together (the terms are used
+interchangeably).  This is quite similar to an \s-1SQL\s0 \s-1GROUP\s0 \s-1BY\s0 clause.  You can
+specify to group on certain columns, or if you don't specify any, the entire set
+of rows is treated as one group.  This is quite like \s-1SQL\s0 so far, but unlike \s-1SQL\s0,
+you can also select un-grouped columns.  innotop actually aggregates every
+column.  If you don't explicitly specify a grouping function, the default is
+\&'first'.  This is basically a convenience so you don't have to specify an
+aggregate function for every column you want in the result.
+.PP
+You can quickly toggle grouping on a table with the '=' key, which toggles its
+aggregate property.  This property doesn't persist to the config file.
+.PP
+The columns by which the table is grouped are specified in its group_by
+property.  When you turn grouping on, innotop places the group_by columns at the
+far left of the table, even if they're not supposed to be visible.  The rest of
+the visible columns appear in order after them.
+.PP
+Two tables have default group_by lists and a count column built in:
+\&\*(L"processlist\*(R" and \*(L"innodb_transactions\*(R".  The grouping is by connection
+and status, so you can quickly see how many queries or transactions are in a
+given status on each server you're monitoring.  The time columns are aggregated
+as a sum; other columns are left at the default 'first' aggregation.
+.PP
+By default, the table shown in \*(L"S: Variables & Status\*(R" mode also uses
+grouping so you can monitor variables and status across many servers.  The
+default aggregation function in this mode is 'avg'.
+.PP
+Valid grouping functions are defined in the \f(CW%agg_funcs\fR hash.  They include
+.IP "first" 4
+.IX Item "first"
+Returns the first element in the group.
+.IP "count" 4
+.IX Item "count"
+Returns the number of elements in the group, including undefined elements, much
+like \s-1SQL\s0's \s-1COUNT\s0(*).
+.IP "avg" 4
+.IX Item "avg"
+Returns the average of defined elements in the group.
+.IP "sum" 4
+.IX Item "sum"
+Returns the sum of elements in the group.
+.PP
+Here's an example of grouping at work.  Suppose you have a very busy server with
+hundreds of open connections, and you want to see how many connections are in
+what status.  Using the built-in grouping rules, you can press 'Q' to enter
+\&\*(L"Q: Query List\*(R" mode.  Press '=' to toggle grouping (if necessary, select the
+\&\*(L"processlist\*(R" table when prompted).
+.PP
+Your display might now look like the following:
+.PP
+.Vb 1
+\& Query List (? for help) localhost, 32:33, 0.11 QPS, 1 thd, 5.0.38\-log
+\& 
+\& CXN        Cmd        Cnt  ID      User   Host           Time   Query       
+\& localhost  Query      49    12933  webusr localhost      19:38  SELECT * FROM
+\& localhost  Sending Da 23     2383  webusr localhost      12:43  SELECT col1,
+\& localhost  Sleep      120     140  webusr localhost    5:18:12
+\& localhost  Statistics 12    19213  webusr localhost      01:19  SELECT * FROM
+.Ve
+.PP
+That's actually quite a worrisome picture.  You've got a lot of idle connections
+(Sleep), and some connections executing queries (Query and Sending Data).
+That's okay, but you also have a lot in Statistics status, collectively spending
+over a minute.  That means the query optimizer is having a really hard time
+optimizing your statements.  Something is wrong; it should normally take
+milliseconds to optimize queries.  You might not have seen this pattern if you
+didn't look at your connections in aggregate.  (This is a made-up example, but
+it can happen in real life).
+.SS "\s-1PIVOTING\s0"
+.IX Subsection "PIVOTING"
+innotop can pivot a table for more compact display, similar to a Pivot Table in
+a spreadsheet (also known as a crosstab).  Pivoting a table makes columns into
+rows.  Assume you start with this table:
+.PP
+.Vb 4
+\& foo bar
+\& === ===
+\& 1   3
+\& 2   4
+.Ve
+.PP
+After pivoting, the table will look like this:
+.PP
+.Vb 4
+\& name set0 set1
+\& ==== ==== ====
+\& foo  1    2
+\& bar  3    4
+.Ve
+.PP
+To get reasonable results, you might need to group as well as pivoting.
+innotop currently does this for \*(L"S: Variables & Status\*(R" mode.
+.SS "\s-1COLORS\s0"
+.IX Subsection "COLORS"
+By default, innotop highlights rows with color so you can see at a glance which
+rows are more important.  You can customize the colorization rules and add your
+own to any table.  Open the table editor with the '^' key, choose a table if
+needed, and press 'o' to open the color editor dialog.
+.PP
+The color editor dialog displays the rules applied to the table, in the order
+they are evaluated.  Each row is evaluated against each rule to see if the rule
+matches the row; if it does, the row gets the specified color, and no further
+rules are evaluated.  The rules look like the following:
+.PP
+.Vb 9
+\& state  eq  Locked       black on_red
+\& cmd    eq  Sleep        white       
+\& user   eq  system user  white       
+\& cmd    eq  Connect      white       
+\& cmd    eq  Binlog Dump  white       
+\& time   >   600          red         
+\& time   >   120          yellow      
+\& time   >   60           green       
+\& time   >   30           cyan
+.Ve
+.PP
+This is the default rule set for the \*(L"processlist\*(R" table.  In order of
+priority, these rules make locked queries black on a red background, \*(L"gray out\*(R"
+connections from replication and sleeping queries, and make queries turn from
+cyan to red as they run longer.
+.PP
+(For some reason, the \s-1ANSI\s0 color code \*(L"white\*(R" is actually a light gray.  Your
+terminal's display may vary; experiment to find colors you like).
+.PP
+You can use keystrokes to move the rules up and down, which re-orders their
+priority.  You can also delete rules and add new ones.  If you add a new rule,
+innotop prompts you for the column, an operator for the comparison, a value
+against which to compare the column, and a color to assign if the rule matches.
+There is auto-completion and prompting at each step.
+.PP
+The value in the third step needs to be correctly quoted.  innotop does not try
+to quote the value because it doesn't know whether it should treat the value as
+a string or a number.  If you want to compare the column against a string, as
+for example in the first rule above, you should enter 'Locked' surrounded by
+quotes.  If you get an error message about a bareword, you probably should have
+quoted something.
+.SS "\s-1EXPRESSIONS\s0"
+.IX Subsection "EXPRESSIONS"
+Expressions are at the core of how innotop works, and are what enables you to
+extend innotop as you wish.  Recall the table lifecycle explained in
+\&\*(L"\s-1TABLES\s0\*(R".  Expressions are used in the earliest step, where it extracts
+values from a data source to form rows.
+.PP
+It does this by calling a subroutine for each column, passing it the source data
+set, a set of current values, and a set of previous values.  These are all
+needed so the subroutine can calculate things like the difference between this
+tick and the previous tick.
+.PP
+The subroutines that extract the data from the set are compiled from
+expressions.  This gives significantly more power than just naming the values to
+fill the columns, because it allows the column's value to be calculated from
+whatever data is necessary, but avoids the need to write complicated and lengthy
+Perl code.
+.PP
+innotop begins with a string of text that can look as simple as a value's name
+or as complicated as a full-fledged Perl expression.  It looks at each
+\&'bareword' token in the string and decides whether it's supposed to be a key
+into the \f(CW$set\fR hash.  A bareword is an unquoted value that isn't already
+surrounded by code-ish things like dollar signs or curly brackets.  If innotop
+decides that the bareword isn't a function or other valid Perl code, it converts
+it into a hash access.  After the whole string is processed, innotop compiles a
+subroutine, like this:
+.PP
+.Vb 5
+\& sub compute_column_value {
+\&    my ( $set, $cur, $pre ) = @_;
+\&    my $val = # EXPANDED STRING GOES HERE
+\&    return $val;
+\& }
+.Ve
+.PP
+Here's a concrete example, taken from the header table \*(L"q_header\*(R" in \*(L"Q:
+Query List\*(R" mode.  This expression calculates the qps, or Queries Per Second,
+column's values, from the values returned by \s-1SHOW\s0 \s-1STATUS:\s0
+.PP
+.Vb 1
+\& Questions/Uptime_hires
+.Ve
+.PP
+innotop decides both words are barewords, and transforms this expression into
+the following Perl code:
+.PP
+.Vb 1
+\& $set\->{Questions}/$set\->{Uptime_hires}
+.Ve
+.PP
+When surrounded by the rest of the subroutine's code, this is executable Perl
+that calculates a high-resolution queries-per-second value.
+.PP
+The arguments to the subroutine are named \f(CW$set\fR, \f(CW$cur\fR, and \f(CW$pre\fR.  In most cases,
+\&\f(CW$set\fR and \f(CW$cur\fR will be the same values.  However, if \*(L"status_inc\*(R" is set, \f(CW$cur\fR
+will not be the same as \f(CW$set\fR, because \f(CW$set\fR will already contain values that are
+the incremental difference between \f(CW$cur\fR and \f(CW$pre\fR.
+.PP
+Every column in innotop is computed by subroutines compiled in the same fashion.
+There is no difference between innotop's built-in columns and user-defined
+columns.  This keeps things consistent and predictable.
+.SS "\s-1TRANSFORMATIONS\s0"
+.IX Subsection "TRANSFORMATIONS"
+Transformations change how a value is rendered.  For example, they can take a
+number of seconds and display it in H:M:S format.  The following transformations
+are defined:
+.IP "commify" 4
+.IX Item "commify"
+Adds commas to large numbers every three decimal places.
+.IP "dulint_to_int" 4
+.IX Item "dulint_to_int"
+Accepts two unsigned integers and converts them into a single longlong.  This is
+useful for certain operations with InnoDB, which uses two integers as
+transaction identifiers, for example.
+.IP "no_ctrl_char" 4
+.IX Item "no_ctrl_char"
+Removes quoted control characters from the value.  This is affected by the
+\&\*(L"charset\*(R" configuration variable.
+.Sp
+This transformation only operates within quoted strings, for example, values to
+a \s-1SET\s0 clause in an \s-1UPDATE\s0 statement.  It will not alter the \s-1UPDATE\s0 statement,
+but will collapse the quoted string to [\s-1BINARY\s0] or [\s-1TEXT\s0], depending on the
+charset.
+.IP "percent" 4
+.IX Item "percent"
+Converts a number to a percentage by multiplying it by two, formatting it with
+\&\*(L"num_digits\*(R" digits after the decimal point, and optionally adding a percent
+sign (see \*(L"show_percent\*(R").
+.IP "secs_to_time" 4
+.IX Item "secs_to_time"
+Formats a number of seconds as time in days+hours:minutes:seconds format.
+.IP "set_precision" 4
+.IX Item "set_precision"
+Formats numbers with \*(L"num_digits\*(R" number of digits after the decimal point.
+.IP "shorten" 4
+.IX Item "shorten"
+Formats a number as a unit of 1024 (k/M/G/T) and with \*(L"num_digits\*(R" number of
+digits after the decimal point.
+.SS "\s-1TABLE\s0 \s-1EDITOR\s0"
+.IX Subsection "TABLE EDITOR"
+The innotop table editor lets you customize tables with keystrokes.  You start
+the table editor with the '^' key.  If there's more than one table on the
+screen, it will prompt you to choose one of them.  Once you do, innotop will
+show you something like this:
+.PP
+.Vb 1
+\& Editing table definition for Buffer Pool.  Press ? for help, q to quit.
+\& 
+\& name               hdr          label                  src          
+\& cxn                CXN          Connection from which  cxn          
+\& buf_pool_size      Size         Buffer pool size       IB_bp_buf_poo
+\& buf_free           Free Bufs    Buffers free in the b  IB_bp_buf_fre
+\& pages_total        Pages        Pages total            IB_bp_pages_t
+\& pages_modified     Dirty Pages  Pages modified (dirty  IB_bp_pages_m
+\& buf_pool_hit_rate  Hit Rate     Buffer pool hit rate   IB_bp_buf_poo
+\& total_mem_alloc    Memory       Total memory allocate  IB_bp_total_m
+\& add_pool_alloc     Add\*(Aql Pool   Additonal pool alloca  IB_bp_add_poo
+.Ve
+.PP
+The first line shows which table you're editing, and reminds you again to press
+\&'?' for a list of key mappings.  The rest is a tabular representation of the
+table's columns, because that's likely what you're trying to edit.  However, you
+can edit more than just the table's columns; this screen can start the filter
+editor, color rule editor, and more.
+.PP
+Each row in the display shows a single column in the table you're editing, along
+with a couple of its properties such as its header and source expression (see
+\&\*(L"\s-1EXPRESSIONS\s0\*(R").
+.PP
+The key mappings are Vim-style, as in many other places.  Pressing 'j' and 'k'
+moves the highlight up or down.  You can then (d)elete or (e)dit the highlighted
+column.  You can also (a)dd a column to the table.  This actually just activates
+one of the columns already defined for the table; it prompts you to choose from
+among the columns available but not currently displayed.  Finally, you can
+re-order the columns with the '+' and '\-' keys.
+.PP
+You can do more than just edit the columns with the table editor, you can also
+edit other properties, such as the table's sort expression and group-by
+expression.  Press '?' to see the full list, of course.
+.PP
+If you want to really customize and create your own column, as opposed to just
+activating a built-in one that's not currently displayed, press the (n)ew key,
+and innotop will prompt you for the information it needs:
+.IP "\(bu" 4
+The column name: this needs to be a word without any funny characters, e.g. just
+letters, numbers and underscores.
+.IP "\(bu" 4
+The column header: this is the label that appears at the top of the column, in
+the table header.  This can have spaces and funny characters, but be careful not
+to make it too wide and waste space on-screen.
+.IP "\(bu" 4
+The column's data source: this is an expression that determines what data from
+the source (see \*(L"\s-1TABLES\s0\*(R") innotop will put into the column.  This can just be
+the name of an item in the source, or it can be a more complex expression, as
+described in \*(L"\s-1EXPRESSIONS\s0\*(R".
+.PP
+Once you've entered the required data, your table has a new column.  There is no
+difference between this column and the built-in ones; it can have all the same
+properties and behaviors.  innotop will write the column's definition to the
+configuration file, so it will persist across sessions.
+.PP
+Here's an example: suppose you want to track how many times your slaves have
+retried transactions.  According to the MySQL manual, the
+Slave_retried_transactions status variable gives you that data: \*(L"The total
+number of times since startup that the replication slave \s-1SQL\s0 thread has retried
+transactions. This variable was added in version 5.0.4.\*(R"  This is appropriate to
+add to the \*(L"slave_sql_status\*(R" table.
+.PP
+To add the column, switch to the replication-monitoring mode with the 'M' key,
+and press the '^' key to start the table editor.  When prompted, choose
+slave_sql_status as the table, then press 'n' to create the column.  Type
+\&'retries' as the column name, 'Retries' as the column header, and
+\&'Slave_retried_transactions' as the source.  Now the column is created, and you
+see the table editor screen again.  Press 'q' to exit the table editor, and
+you'll see your column at the end of the table.
+.SH "VARIABLE SETS"
+.IX Header "VARIABLE SETS"
+Variable sets are used in \*(L"S: Variables & Status\*(R" mode to define more easily
+what variables you want to monitor.  Behind the scenes they are compiled to a
+list of expressions, and then into a column list so they can be treated just
+like columns in any other table, in terms of data extraction and
+transformations.  However, you're protected from the tedious details by a syntax
+that ought to feel very natural to you: a \s-1SQL\s0 \s-1SELECT\s0 list.
+.PP
+The data source for variable sets, and indeed the entire S mode, is the
+combination of \s-1SHOW\s0 \s-1STATUS\s0, \s-1SHOW\s0 \s-1VARIABLES\s0, and \s-1SHOW\s0 \s-1INNODB\s0 \s-1STATUS\s0.  Imagine
+that you had a huge table with one column per variable returned from those
+statements.  That's the data source for variable sets.  You can now query this
+data source just like you'd expect.  For example:
+.PP
+.Vb 1
+\& Questions, Uptime, Questions/Uptime as QPS
+.Ve
+.PP
+Behind the scenes innotop will split that variable set into three expressions,
+compile them and turn them into a table definition, then extract as usual.  This
+becomes a \*(L"variable set,\*(R" or a \*(L"list of variables you want to monitor.\*(R"
+.PP
+innotop lets you name and save your variable sets, and writes them to the
+configuration file.  You can choose which variable set you want to see with the
+\&'c' key, or activate the next and previous sets with the '>' and '<' keys.
+There are many built-in variable sets as well, which should give you a good
+start for creating your own.  Press 'e' to edit the current variable set, or
+just to see how it's defined.  To create a new one, just press 'c' and type its
+name.
+.PP
+You may want to use some of the functions listed in \*(L"\s-1TRANSFORMATIONS\s0\*(R" to help
+format the results.  In particular, \*(L"set_precision\*(R" is often useful to limit
+the number of digits you see.  Extending the above example, here's how:
+.PP
+.Vb 1
+\& Questions, Uptime, set_precision(Questions/Uptime) as QPS
+.Ve
+.PP
+Actually, this still needs a little more work.  If your \*(L"interval\*(R" is less
+than one second, you might be dividing by zero because Uptime is incremental in
+this mode by default.  Instead, use Uptime_hires:
+.PP
+.Vb 1
+\& Questions, Uptime, set_precision(Questions/Uptime_hires) as QPS
+.Ve
+.PP
+This example is simple, but it shows how easy it is to choose which variables
+you want to monitor.
+.SH "PLUGINS"
+.IX Header "PLUGINS"
+innotop has a simple but powerful plugin mechanism by which you can extend
+or modify its existing functionality, and add new functionality.  innotop's
+plugin functionality is event-based: plugins register themselves to be called
+when events happen.  They then have a chance to influence the event.
+.PP
+An innotop plugin is a Perl module placed in innotop's \*(L"plugin_dir\*(R"
+directory.  On \s-1UNIX\s0 systems, you can place a symbolic link to the module instead
+of putting the actual file there.  innotop automatically discovers the file.  If
+there is a corresponding entry in the \*(L"plugins\*(R" configuration file section,
+innotop loads and activates the plugin.
+.PP
+The module must conform to innotop's plugin interface.  Additionally, the source
+code of the module must be written in such a way that innotop can inspect the
+file and determine the package name and description.
+.SS "Package Source Convention"
+.IX Subsection "Package Source Convention"
+innotop inspects the plugin module's source to determine the Perl package name.
+It looks for a line of the form \*(L"package Foo;\*(R" and if found, considers the
+plugin's package name to be Foo.  Of course the package name can be a valid Perl
+package name, with double semicolons and so on.
+.PP
+It also looks for a description in the source code, to make the plugin editor
+more human-friendly.  The description is a comment line of the form \*(L"#
+description: Foo\*(R", where \*(L"Foo\*(R" is the text innotop will consider to be the
+plugin's description.
+.SS "Plugin Interface"
+.IX Subsection "Plugin Interface"
+The innotop plugin interface is quite simple: innotop expects the plugin to be
+an object-oriented module it can call certain methods on.  The methods are
+.IP "new(%variables)" 4
+.IX Item "new(%variables)"
+This is the plugin's constructor.  It is passed a hash of innotop's variables,
+which it can manipulate (see \*(L"Plugin Variables\*(R").  It must return a reference
+to the newly created plugin object.
+.Sp
+At construction time, innotop has only loaded the general configuration and
+created the default built-in variables with their default contents (which is
+quite a lot).  Therefore, the state of the program is exactly as in the innotop
+source code, plus the configuration variables from the \*(L"general\*(R" section in
+the config file.
+.Sp
+If your plugin manipulates the variables, it is changing global data, which is
+shared by innotop and all plugins.  Plugins are loaded in the order they're
+listed in the config file.  Your plugin may load before or after another plugin,
+so there is a potential for conflict or interaction between plugins if they
+modify data other plugins use or modify.
+.IP "\fIregister_for_events()\fR" 4
+.IX Item "register_for_events()"
+This method must return a list of events in which the plugin is interested, if
+any.  See \*(L"Plugin Events\*(R" for the defined events.  If the plugin returns an
+event that's not defined, the event is ignored.
+.IP "event handlers" 4
+.IX Item "event handlers"
+The plugin must implement a method named the same as each event for which it has
+registered.  In other words, if the plugin returns qw(foo bar) from
+\&\fIregister_for_events()\fR, it must have \fIfoo()\fR and \fIbar()\fR methods.  These methods are
+callbacks for the events.  See \*(L"Plugin Events\*(R" for more details about each
+event.
+.SS "Plugin Variables"
+.IX Subsection "Plugin Variables"
+The plugin's constructor is passed a hash of innotop's variables, which it can
+manipulate.  It is probably a good idea if the plugin object saves a copy of it
+for later use.  The variables are defined in the innotop variable
+\&\f(CW%pluggable_vars\fR, and are as follows:
+.IP "action_for" 4
+.IX Item "action_for"
+A hashref of key mappings.  These are innotop's global hot-keys.
+.IP "agg_funcs" 4
+.IX Item "agg_funcs"
+A hashref of functions that can be used for grouping.  See \*(L"\s-1GROUPING\s0\*(R".
+.IP "config" 4
+.IX Item "config"
+The global configuration hash.
+.IP "connections" 4
+.IX Item "connections"
+A hashref of connection specifications.  These are just specifications of how to
+connect to a server.
+.IP "dbhs" 4
+.IX Item "dbhs"
+A hashref of innotop's database connections.  These are actual \s-1DBI\s0 connection
+objects.
+.IP "filters" 4
+.IX Item "filters"
+A hashref of filters applied to table rows.  See \*(L"\s-1FILTERS\s0\*(R" for more.
+.IP "modes" 4
+.IX Item "modes"
+A hashref of modes.  See \*(L"\s-1MODES\s0\*(R" for more.
+.IP "server_groups" 4
+.IX Item "server_groups"
+A hashref of server groups.  See \*(L"\s-1SERVER\s0 \s-1GROUPS\s0\*(R".
+.IP "tbl_meta" 4
+.IX Item "tbl_meta"
+A hashref of innotop's table meta-data, with one entry per table (see
+\&\*(L"\s-1TABLES\s0\*(R" for more information).
+.IP "trans_funcs" 4
+.IX Item "trans_funcs"
+A hashref of transformation functions.  See \*(L"\s-1TRANSFORMATIONS\s0\*(R".
+.IP "var_sets" 4
+.IX Item "var_sets"
+A hashref of variable sets.  See \*(L"\s-1VARIABLE\s0 \s-1SETS\s0\*(R".
+.SS "Plugin Events"
+.IX Subsection "Plugin Events"
+Each event is defined somewhere in the innotop source code.  When innotop runs
+that code, it executes the callback function for each plugin that expressed its
+interest in the event.  innotop passes some data for each event.  The events are
+defined in the \f(CW%event_listener_for\fR variable, and are as follows:
+.ie n .IP "extract_values($set, $cur, $pre, $tbl)" 4
+.el .IP "extract_values($set, \f(CW$cur\fR, \f(CW$pre\fR, \f(CW$tbl\fR)" 4
+.IX Item "extract_values($set, $cur, $pre, $tbl)"
+This event occurs inside the function that extracts values from a data source.
+The arguments are the set of values, the current values, the previous values,
+and the table name.
+.IP "set_to_tbl" 4
+.IX Item "set_to_tbl"
+Events are defined at many places in this subroutine, which is responsible for
+turning an arrayref of hashrefs into an arrayref of lines that can be printed to
+the screen.  The events all pass the same data: an arrayref of rows and the name
+of the table being created.  The events are set_to_tbl_pre_filter,
+set_to_tbl_pre_sort,set_to_tbl_pre_group, set_to_tbl_pre_colorize,
+set_to_tbl_pre_transform, set_to_tbl_pre_pivot, set_to_tbl_pre_create,
+set_to_tbl_post_create.
+.IP "draw_screen($lines)" 4
+.IX Item "draw_screen($lines)"
+This event occurs inside the subroutine that prints the lines to the screen.
+\&\f(CW$lines\fR is an arrayref of strings.
+.SS "Simple Plugin Example"
+.IX Subsection "Simple Plugin Example"
+The easiest way to explain the plugin functionality is probably with a simple
+example.  The following module adds a column to the beginning of every table and
+sets its value to 1.
+.PP
+.Vb 2
+\& use strict;
+\& use warnings FATAL => \*(Aqall\*(Aq;
+\& 
+\& package Innotop::Plugin::Example;
+\& # description: Adds an \*(Aqexample\*(Aq column to every table
+\& 
+\& sub new {
+\&    my ( $class, %vars ) = @_;
+\&    # Store reference to innotop\*(Aqs variables in $self
+\&    my $self = bless { %vars }, $class;
+\& 
+\&    # Design the example column
+\&    my $col = {
+\&       hdr   => \*(AqExample\*(Aq,
+\&       just  => \*(Aq\*(Aq,
+\&       dec   => 0,
+\&       num   => 1,
+\&       label => \*(AqExample\*(Aq,
+\&       src   => \*(Aqexample\*(Aq, # Get data from this column in the data source
+\&       tbl   => \*(Aq\*(Aq,
+\&       trans => [],
+\&    };
+\& 
+\&    # Add the column to every table.
+\&    my $tbl_meta = $vars{tbl_meta};
+\&    foreach my $tbl ( values %$tbl_meta ) {
+\&       # Add the column to the list of defined columns
+\&       $tbl\->{cols}\->{example} = $col;
+\&       # Add the column to the list of visible columns
+\&       unshift @{$tbl\->{visible}}, \*(Aqexample\*(Aq;
+\&    }
+\& 
+\&    # Be sure to return a reference to the object.
+\&    return $self;
+\& }
+\& 
+\& # I\*(Aqd like to be called when a data set is being rendered into a table, please.
+\& sub register_for_events {
+\&    my ( $self ) = @_;
+\&    return qw(set_to_tbl_pre_filter);
+\& }
+\& 
+\& # This method will be called when the event fires.
+\& sub set_to_tbl_pre_filter {
+\&    my ( $self, $rows, $tbl ) = @_;
+\&    # Set the example column\*(Aqs data source to the value 1.
+\&    foreach my $row ( @$rows ) {
+\&       $row\->{example} = 1;
+\&    }
+\& }
+\& 
+\& 1;
+.Ve
+.SS "Plugin Editor"
+.IX Subsection "Plugin Editor"
+The plugin editor lets you view the plugins innotop discovered and activate or
+deactivate them.  Start the editor by pressing $ to start the configuration
+editor from any mode.  Press the 'p' key to start the plugin editor.  You'll see
+a list of plugins innotop discovered.  You can use the 'j' and 'k' keys to move
+the highlight to the desired one, then press the * key to toggle it active or
+inactive.  Exit the editor and restart innotop for the changes to take effect.
+.SH "SQL STATEMENTS"
+.IX Header "SQL STATEMENTS"
+innotop uses a limited set of \s-1SQL\s0 statements to retrieve data from MySQL for
+display.  The statements are customized depending on the server version against
+which they are executed; for example, on MySQL 5 and newer, \s-1INNODB_STATUS\s0
+executes \*(L"\s-1SHOW\s0 \s-1ENGINE\s0 \s-1INNODB\s0 \s-1STATUS\s0\*(R", while on earlier versions it executes
+\&\*(L"\s-1SHOW\s0 \s-1INNODB\s0 \s-1STATUS\s0\*(R".  The statements are as follows:
+.PP
+.Vb 12
+\& Statement           SQL executed
+\& =================== ===============================
+\& INNODB_STATUS       SHOW [ENGINE] INNODB STATUS
+\& KILL_CONNECTION     KILL
+\& KILL_QUERY          KILL QUERY
+\& OPEN_TABLES         SHOW OPEN TABLES
+\& PROCESSLIST         SHOW FULL PROCESSLIST
+\& SHOW_MASTER_LOGS    SHOW MASTER LOGS
+\& SHOW_MASTER_STATUS  SHOW MASTER STATUS
+\& SHOW_SLAVE_STATUS   SHOW SLAVE STATUS
+\& SHOW_STATUS         SHOW [GLOBAL] STATUS
+\& SHOW_VARIABLES      SHOW [GLOBAL] VARIABLES
+.Ve
+.SH "DATA SOURCES"
+.IX Header "DATA SOURCES"
+Each time innotop extracts values to create a table (see \*(L"\s-1EXPRESSIONS\s0\*(R" and
+\&\*(L"\s-1TABLES\s0\*(R"), it does so from a particular data source.  Largely because of the
+complex data extracted from \s-1SHOW\s0 \s-1INNODB\s0 \s-1STATUS\s0, this is slightly messy.  \s-1SHOW\s0
+\&\s-1INNODB\s0 \s-1STATUS\s0 contains a mixture of single values and repeated values that form
+nested data sets.
+.PP
+Whenever innotop fetches data from MySQL, it adds two extra bits to each set:
+cxn and Uptime_hires.  cxn is the name of the connection from which the data
+came.  Uptime_hires is a high-resolution version of the server's Uptime status
+variable, which is important if your \*(L"interval\*(R" setting is sub-second.
+.PP
+Here are the kinds of data sources from which data is extracted:
+.IP "\s-1STATUS_VARIABLES\s0" 4
+.IX Item "STATUS_VARIABLES"
+This is the broadest category, into which the most kinds of data fall.  It
+begins with the combination of \s-1SHOW\s0 \s-1STATUS\s0 and \s-1SHOW\s0 \s-1VARIABLES\s0, but other sources
+may be included as needed, for example, \s-1SHOW\s0 \s-1MASTER\s0 \s-1STATUS\s0 and \s-1SHOW\s0 \s-1SLAVE\s0
+\&\s-1STATUS\s0, as well as many of the non-repeated values from \s-1SHOW\s0 \s-1INNODB\s0 \s-1STATUS\s0.
+.IP "\s-1DEADLOCK_LOCKS\s0" 4
+.IX Item "DEADLOCK_LOCKS"
+This data is extracted from the transaction list in the \s-1LATEST\s0 \s-1DETECTED\s0 \s-1DEADLOCK\s0
+section of \s-1SHOW\s0 \s-1INNODB\s0 \s-1STATUS\s0.  It is nested two levels deep: transactions, then
+locks.
+.IP "\s-1DEADLOCK_TRANSACTIONS\s0" 4
+.IX Item "DEADLOCK_TRANSACTIONS"
+This data is from the transaction list in the \s-1LATEST\s0 \s-1DETECTED\s0 \s-1DEADLOCK\s0
+section of \s-1SHOW\s0 \s-1INNODB\s0 \s-1STATUS\s0.  It is nested one level deep.
+.IP "\s-1EXPLAIN\s0" 4
+.IX Item "EXPLAIN"
+This data is from the result set returned by \s-1EXPLAIN\s0.
+.IP "\s-1INNODB_TRANSACTIONS\s0" 4
+.IX Item "INNODB_TRANSACTIONS"
+This data is from the \s-1TRANSACTIONS\s0 section of \s-1SHOW\s0 \s-1INNODB\s0 \s-1STATUS\s0.
+.IP "\s-1IO_THREADS\s0" 4
+.IX Item "IO_THREADS"
+This data is from the list of threads in the the \s-1FILE\s0 I/O section of \s-1SHOW\s0 \s-1INNODB\s0
+\&\s-1STATUS\s0.
+.IP "\s-1INNODB_LOCKS\s0" 4
+.IX Item "INNODB_LOCKS"
+This data is from the \s-1TRANSACTIONS\s0 section of \s-1SHOW\s0 \s-1INNODB\s0 \s-1STATUS\s0 and is nested
+two levels deep.
+.IP "\s-1OPEN_TABLES\s0" 4
+.IX Item "OPEN_TABLES"
+This data is from \s-1SHOW\s0 \s-1OPEN\s0 \s-1TABLES\s0.
+.IP "\s-1PROCESSLIST\s0" 4
+.IX Item "PROCESSLIST"
+This data is from \s-1SHOW\s0 \s-1FULL\s0 \s-1PROCESSLIST\s0.
+.IP "\s-1OS_WAIT_ARRAY\s0" 4
+.IX Item "OS_WAIT_ARRAY"
+This data is from the \s-1SEMAPHORES\s0 section of \s-1SHOW\s0 \s-1INNODB\s0 \s-1STATUS\s0 and is nested one
+level deep.  It comes from the lines that look like this:
+.Sp
+.Vb 1
+\& \-\-Thread 1568861104 has waited at btr0cur.c line 424 ....
+.Ve
+.SH "MYSQL PRIVILEGES"
+.IX Header "MYSQL PRIVILEGES"
+.IP "\(bu" 4
+You must connect to MySQL as a user who has the \s-1SUPER\s0 privilege for many of the
+functions.
+.IP "\(bu" 4
+If you don't have the \s-1SUPER\s0 privilege, you can still run some functions, but you
+won't necessarily see all the same data.
+.IP "\(bu" 4
+You need the \s-1PROCESS\s0 privilege to see the list of currently running queries in Q
+mode.
+.IP "\(bu" 4
+You need special privileges to start and stop slave servers.
+.IP "\(bu" 4
+You need appropriate privileges to create and drop the deadlock tables if needed
+(see \*(L"\s-1SERVER\s0 \s-1CONNECTIONS\s0\*(R").
+.SH "SYSTEM REQUIREMENTS"
+.IX Header "SYSTEM REQUIREMENTS"
+You need Perl to run innotop, of course.  You also need a few Perl modules: \s-1DBI\s0,
+DBD::mysql,  Term::ReadKey, and Time::HiRes.  These should be included with most
+Perl distributions, but in case they are not, I recommend using versions
+distributed with your operating system or Perl distribution, not from \s-1CPAN\s0.
+Term::ReadKey in particular has been known to cause problems if installed from
+\&\s-1CPAN\s0.
+.PP
+If you have Term::ANSIColor, innotop will use it to format headers more readably
+and compactly.  (Under Microsoft Windows, you also need Win32::Console::ANSI for
+terminal formatting codes to be honored).  If you install Term::ReadLine,
+preferably Term::ReadLine::Gnu, you'll get nice auto-completion support.
+.PP
+I run innotop on Gentoo GNU/Linux, Debian and Ubuntu, and I've had feedback from
+people successfully running it on Red Hat, CentOS, Solaris, and Mac \s-1OSX\s0.  I
+don't see any reason why it won't work on other UNIX-ish operating systems, but
+I don't know for sure.  It also runs on Windows under ActivePerl without
+problem.
+.PP
+innotop has been used on MySQL versions 3.23.58, 4.0.27, 4.1.0, 4.1.22, 5.0.26,
+5.1.15, and 5.2.3.  If it doesn't run correctly for you, that is a bug that
+should be reported.
+.SH "FILES"
+.IX Header "FILES"
+\&\f(CW$HOMEDIR\fR/.innotop and/or /etc/innotop are used to store
+configuration information.  Files include the configuration file innotop.conf,
+the core_dump file which contains verbose error messages if \*(L"debug\*(R" is
+enabled, and the plugins/ subdirectory.
+.SH "GLOSSARY OF TERMS"
+.IX Header "GLOSSARY OF TERMS"
+.IP "tick" 4
+.IX Item "tick"
+A tick is a refresh event, when innotop re-fetches data from connections and
+displays it.
+.SH "ACKNOWLEDGEMENTS"
+.IX Header "ACKNOWLEDGEMENTS"
+The following people and organizations are acknowledged for various reasons.
+Hopefully no one has been forgotten.
+.PP
+Allen K. Smith,
+Aurimas Mikalauskas,
+Bartosz Fenski,
+Brian Miezejewski,
+Christian Hammers, 
+Cyril Scetbon,
+Dane Miller,
+David Multer,
+Dr. Frank Ullrich,
+Giuseppe Maxia,
+Google.com Site Reliability Engineers,
+Google Code,
+Jan Pieter Kunst,
+Jari Aalto,
+Jay Pipes,
+Jeremy Zawodny,
+Johan Idren,
+Kristian Kohntopp,
+Lenz Grimmer,
+Maciej Dobrzanski,
+Michiel Betel,
+MySQL \s-1AB\s0,
+Paul McCullagh,
+Sebastien Estienne,
+Sourceforge.net,
+Steven Kreuzer,
+The Gentoo MySQL Team,
+Trevor Price,
+Yaar Schnitman,
+and probably more people that have not been included.
+.PP
+(If your name has been misspelled, it's probably out of fear of putting
+international characters into this documentation; earlier versions of Perl might
+not be able to compile it then).
+.SH "COPYRIGHT, LICENSE AND WARRANTY"
+.IX Header "COPYRIGHT, LICENSE AND WARRANTY"
+This program is copyright (c) 2006 Baron Schwartz.
+Feedback and improvements are welcome.
+.PP
+\&\s-1THIS\s0 \s-1PROGRAM\s0 \s-1IS\s0 \s-1PROVIDED\s0 \*(L"\s-1AS\s0 \s-1IS\s0\*(R" \s-1AND\s0 \s-1WITHOUT\s0 \s-1ANY\s0 \s-1EXPRESS\s0 \s-1OR\s0 \s-1IMPLIED\s0
+\&\s-1WARRANTIES\s0, \s-1INCLUDING\s0, \s-1WITHOUT\s0 \s-1LIMITATION\s0, \s-1THE\s0 \s-1IMPLIED\s0 \s-1WARRANTIES\s0 \s-1OF\s0
+\&\s-1MERCHANTIBILITY\s0 \s-1AND\s0 \s-1FITNESS\s0 \s-1FOR\s0 A \s-1PARTICULAR\s0 \s-1PURPOSE\s0.
+.PP
+This program is free software; you can redistribute it and/or modify it under
+the terms of the \s-1GNU\s0 General Public License as published by the Free Software
+Foundation, version 2; \s-1OR\s0 the Perl Artistic License.  On \s-1UNIX\s0 and similar
+systems, you can issue `man perlgpl' or `man perlartistic' to read these
+licenses.
+.PP
+You should have received a copy of the \s-1GNU\s0 General Public License along with
+this program; if not, write to the Free Software Foundation, Inc., 59 Temple
+Place, Suite 330, Boston, \s-1MA\s0  02111\-1307  \s-1USA\s0.
+.PP
+Execute innotop and press '!' to see this information at any time.
+.SH "AUTHOR"
+.IX Header "AUTHOR"
+Originally written by Baron Schwartz; currently maintained by Aaron Racine.
+.SH "BUGS"
+.IX Header "BUGS"
+You can report bugs, ask for improvements, and get other help and support at
+<http://code.google.com/p/innotop/>.  There are mailing lists, a source code
+browser, a bug tracker, etc.  Please use these instead of contacting the
+maintainer or author directly, as it makes our job easier and benefits others if the
+discussions are permanent and public.  Of course, if you need to contact us in
+private, please do.
diff -uNr mysql-5.5.60.orig/debian/additions/msql2mysql.1 mysql-5.5.60/debian/additions/msql2mysql.1
--- mysql-5.5.60.orig/debian/additions/msql2mysql.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/msql2mysql.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,16 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+msql2mysql \- MySQL importer for msql style data.
+.SH SYNOPSIS
+msql2mysql [options]
+.SH DESCRIPTION
+This program imports old msql database files.
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/my.cnf mysql-5.5.60/debian/additions/my.cnf
--- mysql-5.5.60.orig/debian/additions/my.cnf	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/my.cnf	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,128 @@
+#
+# The MySQL database server configuration file.
+#
+# You can copy this to one of:
+# - "/etc/mysql/my.cnf" to set global options,
+# - "~/.my.cnf" to set user-specific options.
+# 
+# One can use all long options that the program supports.
+# Run program with --help to get a list of available options and with
+# --print-defaults to see which it would actually understand and use.
+#
+# For explanations see
+# http://dev.mysql.com/doc/mysql/en/server-system-variables.html
+
+# This will be passed to all mysql clients
+# It has been reported that passwords should be enclosed with ticks/quotes
+# escpecially if they contain "#" chars...
+# Remember to edit /etc/mysql/debian.cnf when changing the socket location.
+[client]
+port		= 3306
+socket		= /var/run/mysqld/mysqld.sock
+
+# Here is entries for some specific programs
+# The following values assume you have at least 32M ram
+
+# This was formally known as [safe_mysqld]. Both versions are currently parsed.
+[mysqld_safe]
+socket		= /var/run/mysqld/mysqld.sock
+nice		= 0
+
+[mysqld]
+#
+# * Basic Settings
+#
+user		= mysql
+pid-file	= /var/run/mysqld/mysqld.pid
+socket		= /var/run/mysqld/mysqld.sock
+port		= 3306
+basedir		= /usr
+datadir		= /var/lib/mysql
+tmpdir		= /tmp
+lc-messages-dir	= /usr/share/mysql
+skip-external-locking
+#
+# Instead of skip-networking the default is now to listen only on
+# localhost which is more compatible and is not less secure.
+bind-address		= 127.0.0.1
+#
+# * Fine Tuning
+#
+key_buffer		= 16M
+max_allowed_packet	= 16M
+thread_stack		= 192K
+thread_cache_size       = 8
+# This replaces the startup script and checks MyISAM tables if needed
+# the first time they are touched
+myisam-recover         = BACKUP
+#max_connections        = 100
+#table_cache            = 64
+#thread_concurrency     = 10
+#
+# * Query Cache Configuration
+#
+query_cache_limit	= 1M
+query_cache_size        = 16M
+#
+# * Logging and Replication
+#
+# Both location gets rotated by the cronjob.
+# Be aware that this log type is a performance killer.
+# As of 5.1 you can enable the log at runtime!
+#general_log_file        = /var/log/mysql/mysql.log
+#general_log             = 1
+#
+# Error log - should be very few entries.
+#
+log_error = /var/log/mysql/error.log
+#
+# Here you can see queries with especially long duration
+#slow_query_log_file = /var/log/mysql/mysql-slow.log
+#slow_query_log      = 1
+#long_query_time = 2
+#log_queries_not_using_indexes
+#
+# The following can be used as easy to replay backup logs or for replication.
+# note: if you are setting up a replication slave, see README.Debian about
+#       other settings you may need to change.
+#server-id		= 1
+#log_bin			= /var/log/mysql/mysql-bin.log
+expire_logs_days	= 10
+max_binlog_size         = 100M
+#binlog_do_db		= include_database_name
+#binlog_ignore_db	= include_database_name
+#
+# * InnoDB
+#
+# InnoDB is enabled by default with a 10MB datafile in /var/lib/mysql/.
+# Read the manual for more InnoDB related options. There are many!
+#
+# * Security Features
+#
+# Read the manual, too, if you want chroot!
+# chroot = /var/lib/mysql/
+#
+# For generating SSL certificates I recommend the OpenSSL GUI "tinyca".
+#
+# ssl-ca=/etc/mysql/cacert.pem
+# ssl-cert=/etc/mysql/server-cert.pem
+# ssl-key=/etc/mysql/server-key.pem
+
+
+
+[mysqldump]
+quick
+quote-names
+max_allowed_packet	= 16M
+
+[mysql]
+#no-auto-rehash	# faster start of mysql but no tab completition
+
+[isamchk]
+key_buffer		= 16M
+
+#
+# * IMPORTANT: Additional settings that can override those from this file!
+#   The files must end with '.cnf', otherwise they'll be ignored.
+#
+!includedir /etc/mysql/conf.d/
diff -uNr mysql-5.5.60.orig/debian/additions/my_print_defaults.1 mysql-5.5.60/debian/additions/my_print_defaults.1
--- mysql-5.5.60.orig/debian/additions/my_print_defaults.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/my_print_defaults.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,16 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+my_print_defaults \- MySQL helper script that prints defaults.
+.SH SYNOPSIS
+my_print_defaults [options]
+.SH DESCRIPTION
+Prints all arguments that is give to some program using the default files.
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/myisam_ftdump.1 mysql-5.5.60/debian/additions/myisam_ftdump.1
--- mysql-5.5.60.orig/debian/additions/myisam_ftdump.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/myisam_ftdump.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,16 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+myisam_ftdump \- Dumps full text tables.
+.SH SYNOPSIS
+myisam_ftdump [options]
+.SH DESCRIPTION
+Dumps information and contents of full text tables.
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/myisamchk.1 mysql-5.5.60/debian/additions/myisamchk.1
--- mysql-5.5.60.orig/debian/additions/myisamchk.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/myisamchk.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,17 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+myisamchk \- Checks MySQL myisam type databases. 
+.SH SYNOPSIS
+myisamchk [options]
+.SH DESCRIPTION
+Description, check and repair of ISAM tables.
+Used without options all tables on the command will be checked for errors
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/myisamlog.1 mysql-5.5.60/debian/additions/myisamlog.1
--- mysql-5.5.60.orig/debian/additions/myisamlog.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/myisamlog.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,16 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+myisamlog \- MySQL helper script.
+.SH SYNOPSIS
+myisamlog [options]
+.SH DESCRIPTION
+Function unknown. Mail to ch@debian.org.
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/myisampack.1 mysql-5.5.60/debian/additions/myisampack.1
--- mysql-5.5.60.orig/debian/additions/myisampack.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/myisampack.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,19 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+myisampack \- Compresses MySQL database files.
+.SH SYNOPSIS
+myisampack [options]
+.SH DESCRIPTION
+Pack a MyISAM-table to take much less space.
+Keys are not updated, you must run myisamchk -rq on the datafile
+afterwards to update the keys.
+You should give the .MYI file as the filename argument.
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/mysql-server.lintian-overrides mysql-5.5.60/debian/additions/mysql-server.lintian-overrides
--- mysql-5.5.60.orig/debian/additions/mysql-server.lintian-overrides	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysql-server.lintian-overrides	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,2 @@
+W: mysql-dfsg source: maintainer-script-lacks-debhelper-token debian/mysql-server.postinst
+W: mysql-server: possible-bashism-in-maintainer-script postinst:68 'p{("a".."z","A".."Z",0..9)[int(rand(62))]}'
diff -uNr mysql-5.5.60.orig/debian/additions/mysql_config.1 mysql-5.5.60/debian/additions/mysql_config.1
--- mysql-5.5.60.orig/debian/additions/mysql_config.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysql_config.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,17 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+mysqlconfig \- MySQL compile settings.
+.SH SYNOPSIS
+mysqlconfig [options]
+.SH DESCRIPTION
+This program is only useful for people who want to compile agains
+libmysqlclient.
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/mysql_convert_table_format.1 mysql-5.5.60/debian/additions/mysql_convert_table_format.1
--- mysql-5.5.60.orig/debian/additions/mysql_convert_table_format.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysql_convert_table_format.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,17 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+mysql_convert_table_format \- MySQL table converter.
+.SH SYNOPSIS
+mysql_convert_table_format [options]
+.SH DESCRIPTION
+Conversion of a MySQL tables to other table types.
+If no tables has been specifed, all tables in the database will be converted.
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/mysql_find_rows.1 mysql-5.5.60/debian/additions/mysql_find_rows.1
--- mysql-5.5.60.orig/debian/additions/mysql_find_rows.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysql_find_rows.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,18 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+mysql_find_rows \- MySQL shell skript for searching in update logs.
+.SH SYNOPSIS
+mysql_find_rows [options]
+.SH DESCRIPTION
+Prints all SQL queries that matches a regexp or contains a 'use
+database' or 'set ..' command to stdout.  A SQL query may contain
+newlines.  This is useful to find things in a MySQL update log.
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/mysql_fix_extensions.1 mysql-5.5.60/debian/additions/mysql_fix_extensions.1
--- mysql-5.5.60.orig/debian/additions/mysql_fix_extensions.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysql_fix_extensions.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,18 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+mysql_fix_extensions \- Corrects MySQL database file names.
+.SH SYNOPSIS
+mysql_fix_extensions <datadir>
+.SH DESCRIPTION
+Makes .frm lowercase and .MYI/MYD/ISM/ISD uppercase
+useful when datafiles are copied from windows.
+Does not work with RAID, with InnoDB or BDB tables.
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (8)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/mysql_install_db.1 mysql-5.5.60/debian/additions/mysql_install_db.1
--- mysql-5.5.60.orig/debian/additions/mysql_install_db.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysql_install_db.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,16 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+mysql_install_db \- MySQL helper program.
+.SH SYNOPSIS
+mysql_install_db [options]
+.SH DESCRIPTION
+This program is normally not needed by any user.
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/mysql_secure_installation.1 mysql-5.5.60/debian/additions/mysql_secure_installation.1
--- mysql-5.5.60.orig/debian/additions/mysql_secure_installation.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysql_secure_installation.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,17 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+mysql_secure_installation \- Secures the MySQL access control lists.
+.SH SYNOPSIS
+mysql_secure_installation [options]
+.SH DESCRIPTION
+This interactive programm suggests changes like removing anonymous users that
+are supposed to make your installation more secure.
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (8)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/mysql_setpermission.1 mysql-5.5.60/debian/additions/mysql_setpermission.1
--- mysql-5.5.60.orig/debian/additions/mysql_setpermission.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysql_setpermission.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,23 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+mysql_setpermission \- Adds MySQL users or changes passwords.
+.SH SYNOPSIS
+mysql_setpermission [options]
+.SH DESCRIPTION
+The permission setter is a little program which can help you add users
+or databases or change passwords in MySQL. Keep in mind that we don't
+check permissions which already been set in MySQL. So if you can't
+connect to MySQL using the permission you just added, take a look at
+the permissions which have already been set in MySQL.
+
+The permission setter first reads your .my.cnf file in your Home
+directory if it exists.
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/mysql_tableinfo.1 mysql-5.5.60/debian/additions/mysql_tableinfo.1
--- mysql-5.5.60.orig/debian/additions/mysql_tableinfo.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysql_tableinfo.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,322 @@
+.\" Automatically generated by Pod::Man v1.34, Pod::Parser v1.13
+.\"
+.\" Standard preamble:
+.\" ========================================================================
+.de Sh \" Subsection heading
+.br
+.if t .Sp
+.ne 5
+.PP
+\fB\\$1\fR
+.PP
+..
+.de Sp \" Vertical space (when we can't use .PP)
+.if t .sp .5v
+.if n .sp
+..
+.de Vb \" Begin verbatim text
+.ft CW
+.nf
+.ne \\$1
+..
+.de Ve \" End verbatim text
+.ft R
+.fi
+..
+.\" Set up some character translations and predefined strings.  \*(-- will
+.\" give an unbreakable dash, \*(PI will give pi, \*(L" will give a left
+.\" double quote, and \*(R" will give a right double quote.  | will give a
+.\" real vertical bar.  \*(C+ will give a nicer C++.  Capital omega is used to
+.\" do unbreakable dashes and therefore won't be available.  \*(C` and \*(C'
+.\" expand to `' in nroff, nothing in troff, for use with C<>.
+.tr \(*W-|\(bv\*(Tr
+.ds C+ C\v'-.1v'\h'-1p'\s-2+\h'-1p'+\s0\v'.1v'\h'-1p'
+.ie n \{\
+.    ds -- \(*W-
+.    ds PI pi
+.    if (\n(.H=4u)&(1m=24u) .ds -- \(*W\h'-12u'\(*W\h'-12u'-\" diablo 10 pitch
+.    if (\n(.H=4u)&(1m=20u) .ds -- \(*W\h'-12u'\(*W\h'-8u'-\"  diablo 12 pitch
+.    ds L" ""
+.    ds R" ""
+.    ds C` ""
+.    ds C' ""
+'br\}
+.el\{\
+.    ds -- \|\(em\|
+.    ds PI \(*p
+.    ds L" ``
+.    ds R" ''
+'br\}
+.\"
+.\" If the F register is turned on, we'll generate index entries on stderr for
+.\" titles (.TH), headers (.SH), subsections (.Sh), items (.Ip), and index
+.\" entries marked with X<> in POD.  Of course, you'll have to process the
+.\" output yourself in some meaningful fashion.
+.if \nF \{\
+.    de IX
+.    tm Index:\\$1\t\\n%\t"\\$2"
+..
+.    nr % 0
+.    rr F
+.\}
+.\"
+.\" For nroff, turn off justification.  Always turn off hyphenation; it makes
+.\" way too many mistakes in technical documents.
+.hy 0
+.if n .na
+.\"
+.\" Accent mark definitions (@(#)ms.acc 1.5 88/02/08 SMI; from UCB 4.2).
+.\" Fear.  Run.  Save yourself.  No user-serviceable parts.
+.    \" fudge factors for nroff and troff
+.if n \{\
+.    ds #H 0
+.    ds #V .8m
+.    ds #F .3m
+.    ds #[ \f1
+.    ds #] \fP
+.\}
+.if t \{\
+.    ds #H ((1u-(\\\\n(.fu%2u))*.13m)
+.    ds #V .6m
+.    ds #F 0
+.    ds #[ \&
+.    ds #] \&
+.\}
+.    \" simple accents for nroff and troff
+.if n \{\
+.    ds ' \&
+.    ds ` \&
+.    ds ^ \&
+.    ds , \&
+.    ds ~ ~
+.    ds /
+.\}
+.if t \{\
+.    ds ' \\k:\h'-(\\n(.wu*8/10-\*(#H)'\'\h"|\\n:u"
+.    ds ` \\k:\h'-(\\n(.wu*8/10-\*(#H)'\`\h'|\\n:u'
+.    ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'^\h'|\\n:u'
+.    ds , \\k:\h'-(\\n(.wu*8/10)',\h'|\\n:u'
+.    ds ~ \\k:\h'-(\\n(.wu-\*(#H-.1m)'~\h'|\\n:u'
+.    ds / \\k:\h'-(\\n(.wu*8/10-\*(#H)'\z\(sl\h'|\\n:u'
+.\}
+.    \" troff and (daisy-wheel) nroff accents
+.ds : \\k:\h'-(\\n(.wu*8/10-\*(#H+.1m+\*(#F)'\v'-\*(#V'\z.\h'.2m+\*(#F'.\h'|\\n:u'\v'\*(#V'
+.ds 8 \h'\*(#H'\(*b\h'-\*(#H'
+.ds o \\k:\h'-(\\n(.wu+\w'\(de'u-\*(#H)/2u'\v'-.3n'\*(#[\z\(de\v'.3n'\h'|\\n:u'\*(#]
+.ds d- \h'\*(#H'\(pd\h'-\w'~'u'\v'-.25m'\f2\(hy\fP\v'.25m'\h'-\*(#H'
+.ds D- D\\k:\h'-\w'D'u'\v'-.11m'\z\(hy\v'.11m'\h'|\\n:u'
+.ds th \*(#[\v'.3m'\s+1I\s-1\v'-.3m'\h'-(\w'I'u*2/3)'\s-1o\s+1\*(#]
+.ds Th \*(#[\s+2I\s-2\h'-\w'I'u*3/5'\v'-.3m'o\v'.3m'\*(#]
+.ds ae a\h'-(\w'a'u*4/10)'e
+.ds Ae A\h'-(\w'A'u*4/10)'E
+.    \" corrections for vroff
+.if v .ds ~ \\k:\h'-(\\n(.wu*9/10-\*(#H)'\s-2\u~\d\s+2\h'|\\n:u'
+.if v .ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'\v'-.4m'^\v'.4m'\h'|\\n:u'
+.    \" for low resolution devices (crt and lpr)
+.if \n(.H>23 .if \n(.V>19 \
+\{\
+.    ds : e
+.    ds 8 ss
+.    ds o a
+.    ds d- d\h'-1'\(ga
+.    ds D- D\h'-1'\(hy
+.    ds th \o'bp'
+.    ds Th \o'LP'
+.    ds ae ae
+.    ds Ae AE
+.\}
+.rm #[ #] #H #V #F C
+.\" ========================================================================
+.\"
+.IX Title "MYSQL_TABLEINFO 1"
+.TH MYSQL_TABLEINFO 1 "2003-04-05" "perl v5.8.0" "User Contributed Perl Documentation"
+.SH "NAME"
+mysql_tableinfo \- creates and populates information tables with 
+the output of SHOW DATABASES, SHOW TABLES (or SHOW TABLE STATUS), 
+SHOW COLUMNS and SHOW INDEX.
+.PP
+This is version 1.1.
+.SH "SYNOPSIS"
+.IX Header "SYNOPSIS"
+.Vb 1
+\&  mysql_tableinfo [OPTIONS] database_to_write [database_like_wild] [table_like_wild]
+.Ve
+.PP
+.Vb 2
+\&  Do not backquote (``) database_to_write, 
+\&  and do not quote ('') database_like_wild or table_like_wild
+.Ve
+.PP
+.Vb 1
+\&  Examples:
+.Ve
+.PP
+.Vb 1
+\&  mysql_tableinfo info
+.Ve
+.PP
+.Vb 1
+\&  mysql_tableinfo info this_db
+.Ve
+.PP
+.Vb 1
+\&  mysql_tableinfo info %a% b%
+.Ve
+.PP
+.Vb 1
+\&  mysql_tableinfo info --clear-only
+.Ve
+.PP
+.Vb 1
+\&  mysql_tableinfo info --col --idx --table-status
+.Ve
+.SH "DESCRIPTION"
+.IX Header "DESCRIPTION"
+mysql_tableinfo asks a MySQL server information about its
+databases, tables, table columns and index, and stores this
+in tables called `db`, `tbl` (or `tbl_status`), `col`, `idx` 
+(with an optional prefix specified with \-\-prefix).
+After that, you can query these information tables, for example
+to build your admin scripts with \s-1SQL\s0 queries, like
+.PP
+\&\s-1SELECT\s0 \s-1CONCAT\s0(\*(L"\s-1CHECK\s0 \s-1TABLE\s0 \*(R",`database`,\*(L".\*(R",`table`,\*(L" \s-1EXTENDED\s0;\*(R") 
+\&\s-1FROM\s0 info.tbl \s-1WHERE\s0 ... ;
+.PP
+as people usually do with some other \s-1RDBMS\s0
+(note: to increase the speed of your queries on the info tables,
+you may add some index on them).
+.PP
+The database_like_wild and table_like_wild instructs the program
+to gather information only about databases and tables
+whose names match these patterns. If the info
+tables already exist, their rows matching the patterns are simply
+deleted and replaced by the new ones. That is,
+old rows not matching the patterns are not touched.
+If the database_like_wild and table_like_wild arguments
+are not specified on the command-line they default to \*(L"%\*(R".
+.PP
+The program :
+.PP
+\&\- does \s-1CREATE\s0 \s-1DATABASE\s0 \s-1IF\s0 \s-1NOT\s0 \s-1EXISTS\s0 database_to_write
+where database_to_write is the database name specified on the command\-line.
+.PP
+\&\- does \s-1CREATE\s0 \s-1TABLE\s0 \s-1IF\s0 \s-1NOT\s0 \s-1EXISTS\s0 database_to_write.`db`
+.PP
+\&\- fills database_to_write.`db` with the output of
+\&\s-1SHOW\s0 \s-1DATABASES\s0 \s-1LIKE\s0 database_like_wild
+.PP
+\&\- does \s-1CREATE\s0 \s-1TABLE\s0 \s-1IF\s0 \s-1NOT\s0 \s-1EXISTS\s0 database_to_write.`tbl`
+(respectively database_to_write.`tbl_status`
+if the \-\-tbl\-status option is on)
+.PP
+\&\- for every found database,
+fills database_to_write.`tbl` (respectively database_to_write.`tbl_status`)
+with the output of 
+\&\s-1SHOW\s0 \s-1TABLES\s0 \s-1FROM\s0 found_db \s-1LIKE\s0 table_like_wild
+(respectively \s-1SHOW\s0 \s-1TABLE\s0 \s-1STATUS\s0 \s-1FROM\s0 found_db \s-1LIKE\s0 table_like_wild)
+.PP
+\&\- if the \-\-col option is on,
+    * does \s-1CREATE\s0 \s-1TABLE\s0 \s-1IF\s0 \s-1NOT\s0 \s-1EXISTS\s0 database_to_write.`col`
+    * for every found table,
+      fills database_to_write.`col` with the output of 
+      \s-1SHOW\s0 \s-1COLUMNS\s0 \s-1FROM\s0 found_tbl \s-1FROM\s0 found_db
+.PP
+\&\- if the \-\-idx option is on,
+    * does \s-1CREATE\s0 \s-1TABLE\s0 \s-1IF\s0 \s-1NOT\s0 \s-1EXISTS\s0 database_to_write.`idx`
+    * for every found table,
+      fills database_to_write.`idx` with the output of 
+      \s-1SHOW\s0 \s-1INDEX\s0 \s-1FROM\s0 found_tbl \s-1FROM\s0 found_db
+.PP
+Some options may modify this general scheme (see below).
+.PP
+As mentioned, the contents of the info tables are the output of
+\&\s-1SHOW\s0 commands. In fact the contents are slightly more complete :
+.PP
+\&\- the `tbl` (or `tbl_status`) info table 
+  has an extra column which contains the database name,
+.PP
+\&\- the `col` info table
+  has an extra column which contains the table name,
+  and an extra column which contains, for each described column,
+  the number of this column in the table owning it (this extra column
+  is called `Seq_in_table`). `Seq_in_table` makes it possible for you
+  to retrieve your columns in sorted order, when you are querying
+  the `col` table. 
+.PP
+\&\- the `index` info table
+  has an extra column which contains the database name.
+.PP
+Caution: info tables contain certain columns (e.g.
+Database, Table, Null...) whose names, as they are MySQL reserved words,
+need to be backquoted (`...`) when used in \s-1SQL\s0 statements.
+.PP
+Caution: as information fetching and info tables filling happen at the
+same time, info tables may contain inaccurate information about
+themselves.
+.SH "OPTIONS"
+.IX Header "OPTIONS"
+.IP "\-\-clear" 4
+.IX Item "--clear"
+Does \s-1DROP\s0 \s-1TABLE\s0 on the info tables (only those that the program is
+going to fill, for example if you do not use \-\-col it won't drop
+the `col` table) and processes normally. Does not drop database_to_write.
+.IP "\-\-clear\-only" 4
+.IX Item "--clear-only"
+Same as \-\-clear but exits after the DROPs.
+.IP "\-\-col" 4
+.IX Item "--col"
+Adds columns information (into table `col`).
+.IP "\-\-idx" 4
+.IX Item "--idx"
+Adds index information (into table `idx`).
+.IP "\-\-prefix prefix" 4
+.IX Item "--prefix prefix"
+The info tables are named from the concatenation of prefix and,
+respectively, db, tbl (or tbl_status), col, idx. Do not quote ('')
+or backquote (``) prefix.
+.IP "\-q, \-\-quiet" 4
+.IX Item "-q, --quiet"
+Does not warn you about what the script is going to do (\s-1DROP\s0 \s-1TABLE\s0 etc)
+and does not ask for a confirmation before starting.
+.IP "\-\-tbl\-status" 4
+.IX Item "--tbl-status"
+Instead of using \s-1SHOW\s0 \s-1TABLES\s0, uses \s-1SHOW\s0 \s-1TABLE\s0 \s-1STATUS\s0
+(much more complete information, but slower). 
+.IP "\-\-help" 4
+.IX Item "--help"
+Display helpscreen and exit
+.IP "\-u, \-\-user=#" 4
+.IX Item "-u, --user=#"
+user for database login if not current user. Give a user
+who has sufficient privileges (\s-1CREATE\s0, ...).
+.IP "\-p, \-\-password=# (INSECURE)" 4
+.IX Item "-p, --password=# (INSECURE)"
+password to use when connecting to server.
+WARNING: Providing a password on command line is insecure as it is visible through /proc to anyone for a short time.
+.IP "\-h, \-\-host=#" 4
+.IX Item "-h, --host=#"
+host to connect to
+.IP "\-P, \-\-port=#" 4
+.IX Item "-P, --port=#"
+port to use when connecting to server
+.IP "\-S, \-\-socket=#" 4
+.IX Item "-S, --socket=#"
+\&\s-1UNIX\s0 domain socket to use when connecting to server
+.SH "WARRANTY"
+.IX Header "WARRANTY"
+This software is free and comes without warranty of any kind. You
+should never trust backup software without studying the code yourself.
+Study the code inside this script and only rely on it if \fIyou\fR believe
+that it does the right thing for you.
+.Sp
+Patches adding bug fixes, documentation and new features are welcome.
+.SH "TO DO"
+.IX Header "TO DO"
+Use extended inserts to be faster (for servers with many databases
+or tables). But to do that, must care about net\-buffer\-length.
+.SH "AUTHOR"
+.IX Header "AUTHOR"
+2002\-06\-18 Guilhem Bichot (guilhem.bichot@mines\-paris.org)
+.Sp
+And all the authors of mysqlhotcopy, which served as a model for 
+the structure of the program.
diff -uNr mysql-5.5.60.orig/debian/additions/mysql_waitpid.1 mysql-5.5.60/debian/additions/mysql_waitpid.1
--- mysql-5.5.60.orig/debian/additions/mysql_waitpid.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysql_waitpid.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,20 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+mysql_waitpid \- Waits a specified amount of seconds for a PID to terminate.
+.SH SYNOPSIS
+mysql_waitpid [options] <pid> <seconds>
+.SH DESCRIPTION
+Description: Waits for a program, which program id is #pid, to
+terminate within #time seconds. If the program terminates within
+this time, or if the #pid no longer exists, value 0 is returned.
+Otherwise 1 is returned. Both #pid and #time must be positive
+integer arguments.
+
+See mysql_waitpid for options.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/mysqlbinlog.1 mysql-5.5.60/debian/additions/mysqlbinlog.1
--- mysql-5.5.60.orig/debian/additions/mysqlbinlog.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysqlbinlog.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,17 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+mysqlbinlog \- Dumps MySQL binary logs.
+.SH SYNOPSIS
+mysqlbinlog [options]
+.SH DESCRIPTION
+Dumps a MySQL binary log in a format usable for viewing or for pipeing to
+the mysql command line client
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/mysqlbug.1 mysql-5.5.60/debian/additions/mysqlbug.1
--- mysql-5.5.60.orig/debian/additions/mysqlbug.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysqlbug.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,14 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+mysqlbug \- MySQL bug reporting tool.
+.SH SYNOPSIS
+mysqlbug [options]
+.SH DESCRIPTION
+Interactive bug reporting tool. Use reportbug on Debian systems.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/mysqlcheck.1 mysql-5.5.60/debian/additions/mysqlcheck.1
--- mysql-5.5.60.orig/debian/additions/mysqlcheck.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysqlcheck.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,28 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+mysqlcheck \- MySQL program for repairing, checking and optimizing tables.
+.SH SYNOPSIS
+mysqlcheck | mysqlanalyze | mysqloptimize [options]
+.SH DESCRIPTION
+This program can be used to CHECK (-c,-m,-C), REPAIR (-r), ANALYZE (-a)
+or OPTIMIZE (-o) tables. Some of the options (like -e or -q) can be
+used same time. It works on MyISAM and in some cases on BDB tables.
+Please consult the MySQL manual for latest information about the
+above. The options -c,-r,-a and -o are exclusive to each other, which
+means that the last option will be used, if several was specified.
+
+The option -c will be used by default, if none was specified. You
+can change the default behavior by making a symbolic link, or
+copying this file somewhere with another name, the alternatives are:
+mysqlrepair:   The default option will be -r
+mysqlanalyze:  The default option will be -a
+mysqloptimize: The default option will be -o
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (8)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/mysqld_safe_syslog.cnf mysql-5.5.60/debian/additions/mysqld_safe_syslog.cnf
--- mysql-5.5.60.orig/debian/additions/mysqld_safe_syslog.cnf	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysqld_safe_syslog.cnf	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,2 @@
+[mysqld_safe]
+syslog
diff -uNr mysql-5.5.60.orig/debian/additions/mysqldumpslow.1 mysql-5.5.60/debian/additions/mysqldumpslow.1
--- mysql-5.5.60.orig/debian/additions/mysqldumpslow.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysqldumpslow.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,50 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+mysqldumpslow \- Parse and summarize the MySQL slow query log.
+.SH SYNOPSIS
+mysqldumpslow [options]
+.SH DESCRIPTION
+This program parses and summarizes a 'slow query log'.
+
+.TP
+\fB\-v\fR 
+verbose
+.TP
+\fB\-d\fR 
+debug
+.TP
+\fB\-s=WORD\fR 
+what to sort by (t, at, l, al, r, ar etc)
+.TP
+\fB\-r\fR  
+reverse the sort order (largest last instead of first)
+.TP
+\fB\-t=NUMBER\fR 
+just show the top n queries
+.TP
+\fB\-a\fR  
+don't abstract all numbers to N and strings to 'S'
+.TP
+\fB\-n=NUMBER\fR
+abstract numbers with at least n digits within names
+.TP
+\fB\-g=WORD\fR 
+grep: only consider stmts that include this string
+.TP
+\fB\-h=WORD\fR
+hostname of db server for *-slow.log filename (can be wildcard)
+.TP
+\fB\-i=WORD\fR 
+name of server instance (if using mysql.server startup script)
+.TP
+\fB\-l\fR  
+don't subtract lock time from total time
+
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org> based on
+the commends in the code.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/mysqlimport.1 mysql-5.5.60/debian/additions/mysqlimport.1
--- mysql-5.5.60.orig/debian/additions/mysqlimport.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysqlimport.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,20 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+mysqlimport \- Imports text files with MySQL database queries.
+.SH SYNOPSIS
+mysqlimport [options]
+.SH DESCRIPTION
+Loads tables from text files in various formats.  The base name of the
+text file must be the name of the table that should be used.
+If one uses sockets to connect to the MySQL server, the server will open and
+read the text file directly. In other cases the client will open the text
+file. The SQL command 'LOAD DATA INFILE' is used to import the rows.
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/mysqlreport mysql-5.5.60/debian/additions/mysqlreport
--- mysql-5.5.60.orig/debian/additions/mysqlreport	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysqlreport	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,1298 @@
+#!/usr/bin/perl -w
+
+# mysqlreport v3.5 Apr 16 2008
+# http://hackmysql.com/mysqlreport
+
+# mysqlreport makes an easy-to-read report of important MySQL status values.
+# Copyright 2006-2008 Daniel Nichter
+#
+# This program is free software; you can redistribute it and/or
+# modify it under the terms of the GNU General Public License
+# as published by the Free Software Foundation; either version 2
+# of the License, or (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# The GNU General Public License is available at:
+# http://www.gnu.org/copyleft/gpl.html
+
+use strict;
+use File::Temp qw(tempfile);
+use DBI;
+use Getopt::Long;
+eval { require Term::ReadKey; };
+my $RK = ($@ ? 0 : 1);
+
+sub have_op;
+
+my $WIN = ($^O eq 'MSWin32' ? 1 : 0);
+my %op;
+my %mycnf; # ~/.my.cnf
+my ($tmpfile_fh, $tmpfile);
+my ($stat_name, $stat_val, $stat_label);
+my $MySQL_version;
+my (%stats, %vars); # SHOW STATUS, SHOW VARIABLES
+my (%DMS_vals, %Com_vals, %ib_vals);
+my ($dbh, $query);
+my ($questions, $key_read_ratio, $key_write_ratio, $dms, $slow_query_t);
+my ($key_cache_block_size, $key_buffer_used, $key_buffer_usage);
+my ($qc_mem_used, $qc_hi_r, $qc_ip_r); # Query Cache
+my $have_innodb_vals;
+my ($ib_bp_used, $ib_bp_total, $ib_bp_read_ratio);
+my ($relative_live, $relative_infiles);
+my $real_uptime;
+my (%stats_present, %stats_past); # For relative reports
+      
+GetOptions (
+   \%op,
+   "user=s",
+   "password:s",
+   "host=s",
+   "port=s",
+   "socket=s",
+   "no-mycnf",
+   "infile|in=s",
+   "outfile=s",
+   "flush-status",
+   "email=s",
+   "r|relative:i",
+   "c|report-count=i",
+   "detach",
+   "help|?",
+   "debug"
+);
+
+show_help_and_exit() if $op{'help'};
+
+get_user_mycnf() unless $op{'no-mycnf'};
+
+# Command line options override ~/.my.cnf
+$mycnf{'host'}   = $op{'host'}   if have_op 'host';
+$mycnf{'port'}   = $op{'port'}   if have_op 'port';
+$mycnf{'socket'} = $op{'socket'} if have_op 'socket'; 
+$mycnf{'user'}   = $op{'user'}   if have_op 'user';
+
+$mycnf{'user'} ||= $ENV{'USER'};
+
+if(exists $op{'password'})
+{
+   if($op{'password'} eq '') # Prompt for password
+   {
+      Term::ReadKey::ReadMode(2) if $RK;
+      print "Password for database user $mycnf{'user'}: ";
+      chomp($mycnf{'pass'} = <STDIN>);
+      Term::ReadKey::ReadMode(0), print "\n" if $RK;
+   }
+   else { $mycnf{'pass'} = $op{'password'}; } # Use password given on command line
+}
+
+$op{'com'} ||= 3;
+$op{'c'}   ||= 1; # Used in collect_reports() if --r given integer value
+
+$relative_live    = 0;
+$relative_infiles = 0;
+
+if(defined $op{'r'})
+{
+   if($op{r}) { $relative_live    = 1; }  # if -r was given an integer value
+   else       { $relative_infiles = 1; }
+}
+
+# The report is written to a tmp file first.
+# Later it will be moved to $op{'outfile'} or emailed $op{'email'} if needed.
+($tmpfile_fh, $tmpfile) = tempfile() or die "Cannot open temporary file for writing: $!\n";
+
+if($op{'detach'})
+{
+   $SIG{'TERM'} = 'sig_handler';
+
+   if(fork())
+   {
+      print "mysqlreport has forked and detached.\n";
+      print "While running detached, mysqlreport writes reports to '$tmpfile'.\n";
+
+      exit;
+   }
+
+   open(STDIN, "</dev/null");
+   open(STDOUT, "> $tmpfile") or die "Cannot dup STDOUT: $!\n";
+   open(STDERR, "> $tmpfile") or die "Cannot dup STDERR: $!\n";
+}
+
+select $tmpfile_fh;
+$| = 1 if ($op{'detach'} || $relative_live);
+
+print "tmp file: $tmpfile\n" if $op{debug};
+
+# Connect to MySQL
+if(!$op{'infile'} && !$relative_infiles)
+{
+   connect_to_MySQL();
+}
+
+$have_innodb_vals = 1; # This might be set to 0 later in get_MySQL_version()
+
+if(defined $op{'r'})
+{
+   if($relative_live)
+   { 
+      print STDERR "mysqlreport is writing relative reports to '$tmpfile'.\n" unless $op{'detach'}; 
+      get_MySQL_version();
+      collect_reports();
+   }
+
+   if($relative_infiles) { read_relative_infiles(); }
+}
+else
+{
+   if(!$op{'infile'})
+   {
+      get_MySQL_version();
+      get_vals();
+      get_vars();
+   }
+   else
+   {
+      read_infile($op{'infile'});
+   }
+
+   get_Com_values();
+
+   set_myisam_vals();
+   set_ib_vals() if $have_innodb_vals;
+
+   write_report();
+}
+
+exit_tasks_and_cleanup();
+
+exit;
+
+#
+# Subroutines
+#
+sub show_help_and_exit
+{
+   print <<"HELP";
+mysqlreport v3.5 Apr 16 2008
+mysqlreport makes an easy-to-read report of important MySQL status values.
+
+Command line options (abbreviations work):
+   --user USER       Connect to MySQL as USER
+   --password PASS   Use PASS or prompt for MySQL user's password
+   --host ADDRESS    Connect to MySQL at ADDRESS
+   --port PORT       Connect to MySQL at PORT
+   --socket SOCKET   Connect to MySQL at SOCKET
+   --no-mycnf        Don't read ~/.my.cnf
+   --infile FILE     Read status values from FILE instead of MySQL
+   --outfile FILE    Write report to FILE
+   --email ADDRESS   Email report to ADDRESS (doesn't work on Windows)
+   --flush-status    Issue FLUSH STATUS; after getting current values
+   --relative X      Generate relative reports. If X is an integer,
+                     reports are live from the MySQL server X seconds apart.
+                     If X is a list of infiles (file1 file2 etc.),
+                     reports are generated from the infiles in the order
+                     that they are given.
+   --report-count N  Collect N number of live relative reports (default 1)
+   --detach          Fork and detach from terminal (run in background)
+   --help            Prints this
+   --debug           Print debugging information
+
+Visit http://hackmysql.com/mysqlreport for more information.
+HELP
+
+   exit;
+}
+
+sub get_user_mycnf
+{
+   print "get_user_mycnf\n" if $op{debug};
+
+   return if $WIN;
+   open MYCNF, "$ENV{HOME}/.my.cnf" or return;
+   while(<MYCNF>)
+   {
+      if(/^(.+?)\s*=\s*"?(.+?)"?\s*$/)
+      {
+         $mycnf{$1} = $2;
+         print "get_user_mycnf: read '$1 = $2'\n" if $op{debug};
+      }
+   }
+   $mycnf{'pass'} ||= $mycnf{'password'} if exists $mycnf{'password'};
+   close MYCNF;
+}
+
+sub connect_to_MySQL
+{
+   print "connect_to_MySQL\n" if $op{debug};
+
+   my $dsn;
+
+   if($mycnf{'socket'} && -S $mycnf{'socket'})
+   {
+      $dsn = "DBI:mysql:mysql_socket=$mycnf{socket}";
+   }
+   elsif($mycnf{'host'})
+   {
+      $dsn = "DBI:mysql:host=$mycnf{host}" . ($mycnf{port} ? ";port=$mycnf{port}" : "");
+   }
+   else
+   {
+      $dsn = "DBI:mysql:host=localhost";
+   }
+
+   print "connect_to_MySQL: DBI DSN: $dsn\n" if $op{debug};
+
+   $dbh = DBI->connect($dsn, $mycnf{'user'}, $mycnf{'pass'}) or die;
+}
+
+sub collect_reports
+{
+   print "collect_reports\n" if $op{debug};
+
+   my $i;
+
+   get_vals();
+   get_vars();
+
+   get_Com_values();
+
+   %stats_past = %stats;
+
+   set_myisam_vals();
+   set_ib_vals() if $have_innodb_vals;
+
+   print "#\n# Beginning report, 0 0:0:0\n#\n";
+
+   write_report();
+
+   for($i = 0; $i < $op{'c'}; $i++)
+   {
+      $dbh->disconnect();
+
+      sleep($op{'r'});
+
+      connect_to_MySQL();
+
+      print "\n#\n# Interval report " , $i + 1 , ", +", sec_to_dhms(($i + 1) * $op{'r'}), "\n#\n";
+
+      get_vals();
+
+      write_relative_report();
+   }
+}
+
+sub read_relative_infiles
+{
+   print "read_relative_infiles\n" if $op{debug};
+
+   my $slurp;    # Used to check infiles for multiple sets of status values
+   my $n_stats;  # Number of multiple sets of status values in an infile
+   my $infile;
+   my $report_n; # Report number
+
+   $report_n = 1;
+
+   foreach $infile (@ARGV)
+   {
+      # Read all of infile into $slurp
+      open INFILE, "< $infile" or warn and next;
+      $slurp = do { local $/;  <INFILE> };
+      close INFILE;
+
+      $n_stats = 0;
+
+      # Count number of status value sets
+      $n_stats++ while $slurp =~ /Aborted_clients/g;
+
+      print "read_relative_infiles: found $n_stats sets of status values in file '$infile'\n"
+         if $op{debug};
+
+      if($n_stats == 1)
+      {
+         read_infile($infile);
+         relative_infile_report($report_n++);
+      }
+
+      if($n_stats > 1)
+      {
+         my @tmpfile_fh;
+         my @tmpfile_name;
+         my $i;
+         my $stat_n;  # Status value set number
+
+         # Create a tmp file for each set of status values
+         for($i = 0; $i < $n_stats; $i++)
+         {
+            my ($fh, $name) = tempfile()
+               or die "read_relative_infiles: cannot open temporary file for writing: $!\n";
+
+            push(@tmpfile_fh, $fh);
+            push(@tmpfile_name, $name);
+
+            print "read_relative_infiles: created tmp file '$name' for set $i\n" if $op{debug};
+         }
+
+         $i = 0;
+         $stat_n = 0;
+
+         select $tmpfile_fh[$i];
+
+         # Read infile again and copy each set of status values to seperate tmp files
+         open INFILE, "< $infile" or warn and next;
+         while(<INFILE>)
+         {
+            next if /^\+/;
+            next if /^$/;
+
+            # The infile must begin with the system variable values.
+            # Therefore, the first occurance of Aborted_clients indicates the beginning
+            # of the first set of status values if no sets have occured yet ($stat_n == 0).
+            # In this case, the following status values are printed to the current fh,
+            # along with the system variable values read thus far, until Aborted_clients
+            # occurs again. Then begins the second and subsequent sets of status values.
+
+            if(/Aborted_clients/)
+            {
+               print and next if $stat_n++ == 0;
+               select $tmpfile_fh[++$i];
+            }
+
+            print;
+         }
+         close INFILE;
+
+         # Re-select the main tmp file into which the reports are being written.
+         select $tmpfile_fh;
+
+         for($i = 0; $i < $n_stats; $i++)
+         {
+            close $tmpfile_fh[$i];
+
+            print "read_relative_infiles: reading set $i tmp file '$tmpfile_name[$i]'\n"
+               if $op{debug};
+
+            read_infile($tmpfile_name[$i]);
+            relative_infile_report($report_n++);
+
+            if($WIN) { `del $tmpfile_name[$i]`;   }
+            else     { `rm -f $tmpfile_name[$i]`; }
+
+            print "read_relative_infiles: deleted set $i tmp file '$tmpfile_name[$i]'\n"
+               if $op{debug};
+         }
+
+      } # if($n_stats > 1)
+   } # foreach $infile (@files)
+}
+
+sub relative_infile_report
+{
+   print "relative_infile_report\n" if $op{debug};
+
+   my $report_n = shift;
+
+   if($report_n == 1)
+   {
+      get_Com_values();
+
+      %stats_past = %stats;
+
+      set_myisam_vals();
+      set_ib_vals() if $have_innodb_vals;
+
+      print "#\n# Beginning report, 0 0:0:0\n#\n";
+
+      write_report();
+   }
+   else
+   {
+      print "\n#\n# Interval report ", $report_n - 1, ", +",
+         sec_to_dhms($stats{Uptime} - $stats_past{Uptime}),
+         "\n#\n";
+
+      write_relative_report();
+   }
+}
+
+sub get_vals
+{
+   print "get_vals\n" if $op{debug};
+
+   my @row;
+
+   # Get status values
+   if($MySQL_version >= 50002)
+   {
+      $query = $dbh->prepare("SHOW GLOBAL STATUS;");
+   }
+   else
+   {
+      $query = $dbh->prepare("SHOW STATUS;");
+   }
+   $query->execute();
+   while(@row = $query->fetchrow_array()) { $stats{$row[0]} = $row[1]; }
+
+   $real_uptime = $stats{'Uptime'};
+}
+
+sub get_vars
+{
+   print "get_vars\n" if $op{debug};
+
+   my @row;
+
+   # Get server system variables
+   $query = $dbh->prepare("SHOW VARIABLES;");
+   $query->execute();
+   while(@row = $query->fetchrow_array()) { $vars{$row[0]} = $row[1]; }
+
+   # table_cache was renamed to table_open_cache in MySQL 5.1.3
+   if($MySQL_version >= 50103)
+   {
+      $vars{'table_cache'} = $vars{'table_open_cache'};
+   }
+}
+
+sub read_infile
+{
+   print "read_infile\n" if $op{debug};
+
+   my $infile = shift;
+
+   # Default required system variable values if not set in INFILE.
+   # As of mysqlreport v3.5 the direct output from SHOW VARIABLES;
+   # can be put into INFILE instead. See http://hackmysql.com/mysqlreportdoc
+   # for details.
+   $vars{'version'} = "0.0.0"         if !exists $vars{'version'};
+   $vars{'table_cache'} = 64          if !exists $vars{'table_cache'};
+   $vars{'max_connections'} = 100     if !exists $vars{'max_connections'};
+   $vars{'key_buffer_size'} = 8388600 if !exists $vars{'key_buffer_size'}; # 8M
+   $vars{'thread_cache_size'} = 0     if !exists $vars{'thread_cache_size'}; 
+   $vars{'tmp_table_size'} = 0        if !exists $vars{'tmp_table_size'};
+   $vars{'long_query_time'} = '?'     if !exists $vars{'long_query_time'};
+   $vars{'log_slow_queries'} = '?'    if !exists $vars{'log_slow_queries'};
+
+   # One should also add:
+   #    key_cache_block_size
+   #    query_cache_size
+   # to INFILE if needed.
+
+   open INFILE, "< $infile" or die "Cannot open INFILE '$infile': $!\n";
+
+   while(<INFILE>)
+   {
+      last if !defined $_;
+
+      next if /^\+/;  # skip divider lines 
+      next if /^$/;   # skip blank lines
+
+      next until /(Aborted_clients|back_log|=)/;
+
+      if($1 eq 'Aborted_clients')  # status values
+      {
+         print "read_infile: start stats\n" if $op{debug};
+
+         while($_)
+         {
+            chomp;
+            if(/([A-Za-z_]+)[\s\t|]+(\d+)/)
+            {
+               $stats{$1} = $2;
+               print "read_infile: save $1 = $2\n" if $op{debug};
+            }
+            else { print "read_infile: ignore '$_'\n" if $op{debug}; }
+
+            last if $1 eq 'Uptime';  # exit while() if end of status values
+            $_ = <INFILE>; # otherwise, read next line of status values
+         }
+      }
+      elsif($1 eq  'back_log')  # system variable values
+      {
+         print "read_infile: start vars\n" if $op{debug};
+
+         while($_)
+         {
+            chomp;
+            if(/([A-Za-z_]+)[\s\t|]+([\w\.\-]+)/)  # This will exclude some vars
+            {                                      # like pid_file which we don't need
+               $vars{$1} = $2;
+               print "read_infile: save $1 = $2\n" if $op{debug};
+            }
+            else { print "read_infile: ignore '$_'\n" if $op{debug}; }
+
+            last if $1 eq 'wait_timeout';  # exit while() if end of vars
+            $_ = <INFILE>; # otherwise, read next line of vars
+         }
+      }
+      elsif($1 eq '=')  # old style, manually added system variable values
+      {
+         print "read_infile: start old vars\n" if $op{debug};
+
+         while($_ && $_ =~ /=/)
+         {
+            chomp;
+            if(/^\s*(\w+)\s*=\s*([0-9.]+)(M*)\s*$/)  # e.g.: key_buffer_size = 128M
+            {
+               $vars{$1} = ($3 ? $2 * 1024 * 1024 : $2);
+               print "read_infile: read '$_' as $1 = $vars{$1}\n" if $op{debug};
+            }
+            else { print "read_infile: ignore '$_'\n" if $op{debug}; }
+
+            $_ = <INFILE>; # otherwise, read next line of old vars
+         }
+
+         redo;
+      }
+      else
+      {
+         print "read_infile: unrecognized line: '$_'\n" if $op{debug};
+      }
+   }
+
+   close INFILE;
+
+   $real_uptime = $stats{'Uptime'};
+
+   $vars{'table_cache'} = $vars{'table_open_cache'} if exists $vars{'table_open_cache'};
+
+   get_MySQL_version();
+}
+
+sub get_MySQL_version
+{
+   print "get_MySQL_version\n" if $op{debug};
+
+   return if $MySQL_version;
+
+   my ($major, $minor, $patch);
+
+   if($op{'infile'} || $relative_infiles)
+   {
+      ($major, $minor, $patch) = ($vars{'version'} =~ /(\d{1,2})\.(\d{1,2})\.(\d{1,2})/);
+   }
+   else
+   {
+      my @row;
+
+      $query = $dbh->prepare("SHOW VARIABLES LIKE 'version';");
+      $query->execute();
+      @row = $query->fetchrow_array();
+      ($major, $minor, $patch) = ($row[1] =~ /(\d{1,2})\.(\d{1,2})\.(\d{1,2})/);
+   }
+
+   $MySQL_version = sprintf("%d%02d%02d", $major, $minor, $patch);
+
+   # Innodb_ status values were added in 5.0.2
+   if($MySQL_version < 50002)
+   {
+      $have_innodb_vals = 0;
+      print "get_MySQL_version: no InnoDB reports because MySQL version is older than 5.0.2\n" if $op{debug};
+   }
+}
+
+sub set_myisam_vals
+{
+   print "set_myisam_vals\n" if $op{debug};
+
+   $questions = $stats{'Questions'};
+
+   $key_read_ratio = sprintf "%.2f",
+                     ($stats{'Key_read_requests'} ?
+                      100 - ($stats{'Key_reads'} / $stats{'Key_read_requests'}) * 100 :
+                      0);
+
+   $key_write_ratio = sprintf "%.2f",
+                      ($stats{'Key_write_requests'} ?
+                       100 - ($stats{'Key_writes'} / $stats{'Key_write_requests'}) * 100 :
+                       0);
+
+   $key_cache_block_size = (defined $vars{'key_cache_block_size'} ?
+                            $vars{'key_cache_block_size'} :
+                            1024);
+
+   $key_buffer_used = $stats{'Key_blocks_used'} * $key_cache_block_size;
+
+   if(defined $stats{'Key_blocks_unused'}) # MySQL 4.1.2+
+   {
+      $key_buffer_usage =  $vars{'key_buffer_size'} -
+                           ($stats{'Key_blocks_unused'} * $key_cache_block_size);
+   }
+   else { $key_buffer_usage = -1; }
+
+   # Data Manipulation Statements: http://dev.mysql.com/doc/refman/5.0/en/data-manipulation.html
+   %DMS_vals =
+   (
+      SELECT  => $stats{'Com_select'},
+      INSERT  => $stats{'Com_insert'}  + $stats{'Com_insert_select'},
+      REPLACE => $stats{'Com_replace'} + $stats{'Com_replace_select'},
+      UPDATE  => $stats{'Com_update'}  +
+                 (exists $stats{'Com_update_multi'} ? $stats{'Com_update_multi'} : 0),
+      DELETE  => $stats{'Com_delete'}  +
+                 (exists $stats{'Com_delete_multi'} ? $stats{'Com_delete_multi'} : 0)
+   );
+
+   $dms = $DMS_vals{SELECT} + $DMS_vals{INSERT} + $DMS_vals{REPLACE} + $DMS_vals{UPDATE} + $DMS_vals{DELETE};
+
+   $slow_query_t = format_u_time($vars{long_query_time});
+
+}
+
+sub set_ib_vals
+{
+   print "set_ib_vals\n" if $op{debug};
+
+   $ib_bp_used  = ($stats{'Innodb_buffer_pool_pages_total'} -
+                   $stats{'Innodb_buffer_pool_pages_free'}) *
+                   $stats{'Innodb_page_size'};
+
+   $ib_bp_total = $stats{'Innodb_buffer_pool_pages_total'} * $stats{'Innodb_page_size'};
+
+   $ib_bp_read_ratio = sprintf "%.2f",
+                       ($stats{'Innodb_buffer_pool_read_requests'} ?
+                        100 - ($stats{'Innodb_buffer_pool_reads'} /
+                           $stats{'Innodb_buffer_pool_read_requests'}) * 100 :
+                        0);
+}
+
+sub write_relative_report
+{
+   print "write_relative_report\n" if $op{debug};
+
+   %stats_present = %stats;
+
+   for(keys %stats)
+   {
+      if($stats_past{$_} =~ /\d+/)
+      {
+         if($stats_present{$_} >= $stats_past{$_}) # Avoid negative values
+         {
+            $stats{$_} = $stats_present{$_} - $stats_past{$_};
+         }
+      }
+   }
+
+   # These values are either "at present" or "high water marks".
+   # Therefore, it is more logical to not relativize these values.
+   # Doing otherwise causes strange and misleading values.
+   $stats{'Key_blocks_used'}      = $stats_present{'Key_blocks_used'};
+   $stats{'Open_tables'}          = $stats_present{'Open_tables'};
+   $stats{'Max_used_connections'} = $stats_present{'Max_used_connections'};
+   $stats{'Threads_running'}      = $stats_present{'Threads_running'};
+   $stats{'Threads_connected'}    = $stats_present{'Threads_connected'};
+   $stats{'Threads_cached'}       = $stats_present{'Threads_cached'};
+   $stats{'Qcache_free_blocks'}   = $stats_present{'Qcache_free_blocks'};
+   $stats{'Qcache_total_blocks'}  = $stats_present{'Qcache_total_blocks'};
+   $stats{'Qcache_free_memory'}   = $stats_present{'Qcache_free_memory'};
+   if($have_innodb_vals)
+   {
+      $stats{'Innodb_page_size'}                 = $stats_present{'Innodb_page_size'};
+      $stats{'Innodb_buffer_pool_pages_data'}    = $stats_present{'Innodb_buffer_pool_pages_data'};
+      $stats{'Innodb_buffer_pool_pages_dirty'}   = $stats_present{'Innodb_buffer_pool_pages_dirty'};
+      $stats{'Innodb_buffer_pool_pages_free'}    = $stats_present{'Innodb_buffer_pool_pages_free'};
+      $stats{'Innodb_buffer_pool_pages_latched'} = $stats_present{'Innodb_buffer_pool_pages_latched'};
+      $stats{'Innodb_buffer_pool_pages_misc'}    = $stats_present{'Innodb_buffer_pool_pages_misc'};
+      $stats{'Innodb_buffer_pool_pages_total'}   = $stats_present{'Innodb_buffer_pool_pages_total'};
+      $stats{'Innodb_data_pending_fsyncs'}       = $stats_present{'Innodb_data_pending_fsyncs'};
+      $stats{'Innodb_data_pending_reads'}        = $stats_present{'Innodb_data_pending_reads'};
+      $stats{'Innodb_data_pending_writes'}       = $stats_present{'Innodb_data_pending_writes'};
+
+      # Innodb_row_lock_ values were added in MySQL 5.0.3
+      if($MySQL_version >= 50003)
+      {
+         $stats{'Innodb_row_lock_current_waits'} = $stats_present{'Innodb_row_lock_current_waits'};
+         $stats{'Innodb_row_lock_time_avg'}      = $stats_present{'Innodb_row_lock_time_avg'};
+         $stats{'Innodb_row_lock_time_max'}      = $stats_present{'Innodb_row_lock_time_max'};
+      }
+   }
+
+   get_Com_values();
+
+   %stats_past = %stats_present;
+
+   set_myisam_vals();
+   set_ib_vals() if $have_innodb_vals;
+
+   write_report();
+}
+
+sub write_report
+{
+   print "write_report\n" if $op{debug};
+
+   $~ = 'MYSQL_TIME', write;
+   $~ = 'KEY_BUFF_MAX', write;
+   if($key_buffer_usage != -1) { $~ = 'KEY_BUFF_USAGE', write }
+   $~ = 'KEY_RATIOS', write;
+   write_DTQ();
+   $~ = 'SLOW_DMS', write;
+   write_DMS();
+   write_Com();
+   $~ = 'SAS', write; 
+   write_qcache(); 
+   $~ = 'REPORT_END', write;
+   $~ = 'TAB', write;
+
+   write_InnoDB() if $have_innodb_vals;
+}
+
+sub sec_to_dhms # Seconds to days hours:minutes:seconds
+{
+   my $s = shift;
+   my ($d, $h, $m) = (0, 0, 0);
+
+   return '0 0:0:0' if $s <= 0;
+
+   if($s >= 86400)
+   {
+      $d = int $s / 86400;
+      $s -= $d * 86400;
+   }
+
+   if($s >= 3600)
+   {
+     $h = int $s / 3600;
+     $s -= $h * 3600;
+   }
+   
+   $m = int $s / 60;
+   $s -= $m * 60;
+   
+   return "$d $h:$m:$s";
+}
+
+sub make_short
+{
+   my ($number, $kb, $d) = @_;
+   my $n = 0;
+   my $short;
+
+   $d ||= 2;
+
+   if($kb) { while ($number > 1023) { $number /= 1024; $n++; }; }
+   else { while ($number > 999) { $number /= 1000; $n++; }; }
+
+   $short = sprintf "%.${d}f%s", $number, ('','k','M','G','T')[$n];
+   if($short =~ /^(.+)\.(00)$/) { return $1; } # 12.00 -> 12 but not 12.00k -> 12k
+
+   return $short;
+}
+
+# What began as a simple but great idea has become the new standard:
+# long_query_time in microseconds. For MySQL 5.1.21+ and 6.0.4+ this
+# is now standard. For 4.1 and 5.0 patches, the architects of this
+# idea provide: http://www.mysqlperformanceblog.com/mysql-patches/
+# Relevant notes in MySQL manual:
+# http://dev.mysql.com/doc/refman/5.1/en/slow-query-log.html
+# http://dev.mysql.com/doc/refman/6.0/en/slow-query-log.html
+#
+# The format_u_time sub simply beautifies long_query_time.
+
+sub format_u_time  # format microsecond () time value
+{
+   # 0.000000 - 0.000999 = 0 - 999 
+   # 0.001000 - 0.999999 = 1 ms - 999.999 ms
+   # 1.000000 - n.nnnnnn = 1 s - n.nnnnn s
+
+   my $t = shift;
+   my $f;  # formatted  time
+   my $u = chr(($WIN ? 230 : 181));
+
+   $t = 0 if $t < 0;
+
+   if($t > 0 && $t <= 0.000999)
+   {
+      $f = ($t * 1000000) . " $u";
+   }
+   elsif($t >= 0.001000 && $t <= 0.999999)
+   {
+      $f = ($t * 1000) . ' ms';
+   }
+   elsif($t >= 1)
+   {
+      $f = ($t * 1) . ' s';  # * 1 to remove insignificant zeros
+   }
+   else
+   {
+      $f = 0;  # $t should = 0 at this point
+   }
+
+   return $f;
+}
+
+sub perc # Percentage
+{
+   my($is, $of) = @_;
+   $is = 0 if (not defined $is);
+   return sprintf "%.2f", ($is * 100) / ($of ||= 1);
+}
+
+sub t # Time average per second
+{
+   my $val = shift;
+   return 0 if !$val;
+   return(make_short($val / $stats{'Uptime'}, 0, 1));
+}
+
+sub email_report # Email given report to $op{'email'}
+{
+   print "email_report\n" if $op{debug};
+
+   return if $WIN;
+
+   my $report = shift;
+
+   open SENDMAIL, "|/usr/sbin/sendmail -t";
+   print SENDMAIL "From: mysqlreport\n";
+   print SENDMAIL "To: $op{email}\n";
+   print SENDMAIL "Subject: MySQL status report on " . ($mycnf{'host'} || 'localhost') . "\n\n";
+   print SENDMAIL `cat $report`;
+   close SENDMAIL;
+}
+
+sub cat_report # Print given report to screen
+{
+   print "cat_report\n" if $op{debug};
+
+   my $report = shift;
+   my @report;
+
+   open REPORT, "< $report";
+   @report = <REPORT>;
+   close REPORT;
+   print @report;
+}
+
+sub get_Com_values
+{
+   print "get_Com_values\n" if $op{debug};
+
+   %Com_vals = ();
+
+   # Make copy of just the Com_ values
+   for(keys %stats)
+   {
+      if(grep /^Com_/, $_ and $stats{$_} > 0)
+      {
+         /^Com_(.*)/;
+         $Com_vals{$1} = $stats{$_};
+      }
+   }
+
+   # Remove DMS values
+   delete $Com_vals{'select'};
+   delete $Com_vals{'insert'};
+   delete $Com_vals{'insert_select'};
+   delete $Com_vals{'replace'};
+   delete $Com_vals{'replace_select'};
+   delete $Com_vals{'update'};
+   delete $Com_vals{'update_multi'} if exists $Com_vals{'update_multi'};
+   delete $Com_vals{'delete'};
+   delete $Com_vals{'delete_multi'} if exists $Com_vals{'delete_multi'};
+}
+
+sub write_DTQ # Write DTQ report in descending order by values
+{
+   print "write_DTQ\n" if $op{debug};
+
+   $~ = 'DTQ';
+
+   my %DTQ;
+   my $first = 1;
+
+   # Total Com values
+   $stat_val = 0;
+   for(values %Com_vals) { $stat_val += $_; }
+   $DTQ{'Com_'} = $stat_val;
+
+   $DTQ{'DMS'}      = $dms;
+   $DTQ{'QC Hits'}  = $stats{'Qcache_hits'} if $stats{'Qcache_hits'} != 0;
+   $DTQ{'COM_QUIT'} = int (($stats{'Connections'} - 2) - ($stats{'Aborted_clients'} / 2));
+
+   $stat_val = 0;
+   for(values %DTQ) { $stat_val += $_; }
+   if($questions != $stat_val)
+   {
+      $DTQ{($questions > $stat_val ? '+Unknown' : '-Unknown')} = abs $questions - $stat_val;
+   }
+
+   for(sort { $DTQ{$b} <=> $DTQ{$a} } keys(%DTQ))
+   {
+      if($first) { $stat_label = '%Total:'; $first = 0; }
+      else       { $stat_label = ''; }
+
+      $stat_name = $_;
+      $stat_val  = $DTQ{$_};
+      write;
+   }
+}
+
+sub write_DMS # Write DMS report in descending order by values
+{
+   print "write_DMS\n" if $op{debug};
+
+   $~ = 'DMS';
+
+   for(sort { $DMS_vals{$b} <=> $DMS_vals{$a} } keys(%DMS_vals))
+   {
+      $stat_name = $_;
+      $stat_val  = $DMS_vals{$_};
+      write;
+   }
+}
+
+sub write_Com # Write COM report in descending order by values
+{
+   print "write_Com\n" if $op{debug};
+
+   my $i = $op{'com'};
+
+   $~ = 'COM_1';
+
+   # Total Com values and write first line of COM report
+   $stat_label = '%Total:' unless $op{'dtq'};
+   $stat_val   = 0;
+   for(values %Com_vals) { $stat_val += $_; }
+   write;
+
+   $~ = 'COM_2';
+
+   # Sort remaining Com values, print only the top $op{'com'} number of values
+   for(sort { $Com_vals{$b} <=> $Com_vals{$a} } keys(%Com_vals))
+   {
+      $stat_name = $_;
+      $stat_val  = $Com_vals{$_};
+      write;
+
+      last if !(--$i);
+   }
+}
+
+sub write_qcache
+{
+   print "write_qcache\n" if $op{debug};
+
+   # Query cache was added in 4.0.1, but have_query_cache was added in 4.0.2,
+   # ergo this method is slightly more reliable
+   return if not exists $vars{'query_cache_size'};
+   return if $vars{'query_cache_size'} == 0;
+
+   $qc_mem_used = $vars{'query_cache_size'} - $stats{'Qcache_free_memory'};
+   $qc_hi_r = sprintf "%.2f", $stats{'Qcache_hits'} / ($stats{'Qcache_inserts'} ||= 1);
+   $qc_ip_r = sprintf "%.2f", $stats{'Qcache_inserts'} / ($stats{'Qcache_lowmem_prunes'} ||= 1);
+
+   $~ = 'QCACHE';
+   write;
+}
+
+sub write_InnoDB
+{
+   print "write_InnoDB\n" if $op{debug};
+
+   return if not defined $stats{'Innodb_page_size'};
+
+   $stats{'Innodb_buffer_pool_pages_latched'} = 0 if not defined $stats{'Innodb_buffer_pool_pages_latched'};
+
+   $~ = 'IB';
+   write;
+
+   # Innodb_row_lock_ values were added in MySQL 5.0.3
+   if($MySQL_version >= 50003)
+   {
+      $~ = 'IB_LOCK';
+      write;
+   }
+
+   # Data, Pages, Rows
+   $~ = 'IB_DPR';
+   write;
+}
+
+sub have_op
+{
+   my $key = shift;
+   return 1 if (exists $op{$key} && $op{$key} ne '');
+   return 0;
+}
+
+sub sig_handler
+{
+   print "\nReceived signal at " , scalar localtime , "\n";
+   exit_tasks_and_cleanup();
+   exit;
+}
+
+sub exit_tasks_and_cleanup
+{
+   print "exit_tasks_and_cleanup\n" if $op{debug};
+
+   close $tmpfile_fh;
+   select STDOUT unless $op{'detach'};
+
+   email_report($tmpfile) if $op{'email'};
+
+   cat_report($tmpfile) unless $op{'detach'};
+
+   if($op{'outfile'})
+   {
+      if($WIN) { `move $tmpfile $op{outfile}`; }
+      else     { `mv $tmpfile $op{outfile}`;   }
+   }
+   else
+   {
+      if($WIN) { `del $tmpfile`;   }
+      else     { `rm -f $tmpfile`; }
+   }
+
+   if(!$op{'infile'} && !$relative_infiles)
+   {
+      if($op{'flush-status'})
+      {
+         $query = $dbh->prepare("FLUSH STATUS;");
+         $query->execute();
+      }
+
+      $query->finish();
+      $dbh->disconnect();
+   }
+}
+
+#
+# Formats
+#
+
+format MYSQL_TIME =
+MySQL @<<<<<<<<<<<<<<<<  uptime @<<<<<<<<<<<   @>>>>>>>>>>>>>>>>>>>>>>>>
+$vars{'version'}, sec_to_dhms($real_uptime), (($op{infile} || $relative_infiles) ? '' : scalar localtime)
+.
+
+format KEY_BUFF_MAX =
+
+__ Key _________________________________________________________________
+Buffer used   @>>>>>> of @>>>>>>  %Used: @>>>>>
+make_short($key_buffer_used, 1), make_short($vars{'key_buffer_size'}, 1), perc($key_buffer_used, $vars{'key_buffer_size'})
+.
+
+format KEY_BUFF_USAGE =
+  Current     @>>>>>>            %Usage: @>>>>>
+make_short($key_buffer_usage, 1), perc($key_buffer_usage, $vars{'key_buffer_size'})
+.
+
+format KEY_RATIOS =
+Write hit     @>>>>>%
+$key_write_ratio
+Read hit      @>>>>>%
+$key_read_ratio
+
+__ Questions ___________________________________________________________
+Total       @>>>>>>>>  @>>>>>/s
+make_short($questions), t($questions)
+.
+
+format DTQ =
+  @<<<<<<<  @>>>>>>>>  @>>>>>/s  @>>>>>> @>>>>>
+$stat_name, make_short($stat_val), t($stat_val), $stat_label, perc($stat_val, $questions)
+.
+
+format SLOW_DMS =
+Slow @<<<<<<< @>>>>>>  @>>>>>/s          @>>>>>  %DMS: @>>>>>  Log: @>> 
+$slow_query_t, make_short($stats{'Slow_queries'}), t($stats{'Slow_queries'}), perc($stats{'Slow_queries'}, $questions), perc($stats{'Slow_queries'}, $dms), $vars{'log_slow_queries'}
+DMS         @>>>>>>>>  @>>>>>/s          @>>>>>
+make_short($dms), t($dms), perc($dms, $questions)
+.
+
+format DMS =
+  @<<<<<<<  @>>>>>>>>  @>>>>>/s          @>>>>>        @>>>>>
+$stat_name, make_short($stat_val), t($stat_val), perc($stat_val, $questions), perc($stat_val, $dms)
+.
+
+format COM_1 =
+Com_        @>>>>>>>>  @>>>>>/s          @>>>>>
+make_short($stat_val), t($stat_val), perc($stat_val, $questions)
+.
+
+format COM_2 =
+  @<<<<<<<<<< @>>>>>>  @>>>>>/s          @>>>>>
+$stat_name, make_short($stat_val), t($stat_val), perc($stat_val, $questions)
+.
+
+format SAS =
+
+__ SELECT and Sort _____________________________________________________
+Scan          @>>>>>>   @>>>>/s %SELECT: @>>>>>
+make_short($stats{'Select_scan'}), t($stats{'Select_scan'}), perc($stats{'Select_scan'}, $stats{'Com_select'})
+Range         @>>>>>>   @>>>>/s          @>>>>>
+make_short($stats{'Select_range'}), t($stats{'Select_range'}), perc($stats{'Select_range'}, $stats{'Com_select'})
+Full join     @>>>>>>   @>>>>/s          @>>>>>
+make_short($stats{'Select_full_join'}), t($stats{'Select_full_join'}), perc($stats{'Select_full_join'}, $stats{'Com_select'})
+Range check   @>>>>>>   @>>>>/s          @>>>>>
+make_short($stats{'Select_range_check'}), t($stats{'Select_range_check'}), perc($stats{'Select_range_check'}, $stats{'Com_select'})
+Full rng join @>>>>>>   @>>>>/s          @>>>>>
+make_short($stats{'Select_full_range_join'}), t($stats{'Select_full_range_join'}), perc($stats{'Select_full_range_join'}, $stats{'Com_select'})
+Sort scan     @>>>>>>   @>>>>/s
+make_short($stats{'Sort_scan'}), t($stats{'Sort_scan'})
+Sort range    @>>>>>>   @>>>>/s
+make_short($stats{'Sort_range'}), t($stats{'Sort_range'})
+Sort mrg pass @>>>>>>   @>>>>/s
+make_short($stats{'Sort_merge_passes'}), t($stats{'Sort_merge_passes'})
+.
+
+format QCACHE =
+
+__ Query Cache _________________________________________________________
+Memory usage  @>>>>>> of @>>>>>>  %Used: @>>>>>
+make_short($qc_mem_used, 1), make_short($vars{'query_cache_size'}, 1), perc($qc_mem_used, $vars{'query_cache_size'})
+Block Fragmnt @>>>>>%
+perc($stats{'Qcache_free_blocks'}, $stats{'Qcache_total_blocks'})
+Hits          @>>>>>>   @>>>>/s
+make_short($stats{'Qcache_hits'}), t($stats{'Qcache_hits'})
+Inserts       @>>>>>>   @>>>>/s
+make_short($stats{'Qcache_inserts'}), t($stats{'Qcache_inserts'})
+Insrt:Prune @>>>>>>:1   @>>>>/s
+make_short($qc_ip_r), t($stats{'Qcache_inserts'} - $stats{'Qcache_lowmem_prunes'})
+Hit:Insert  @>>>>>>:1
+$qc_hi_r, t($qc_hi_r)
+.
+
+# Not really the end...
+format REPORT_END =
+
+__ Table Locks _________________________________________________________
+Waited      @>>>>>>>>  @>>>>>/s  %Total: @>>>>>
+make_short($stats{'Table_locks_waited'}), t($stats{'Table_locks_waited'}), perc($stats{'Table_locks_waited'}, $stats{'Table_locks_waited'} + $stats{'Table_locks_immediate'});
+Immediate   @>>>>>>>>  @>>>>>/s
+make_short($stats{'Table_locks_immediate'}), t($stats{'Table_locks_immediate'})
+
+__ Tables ______________________________________________________________
+Open        @>>>>>>>> of @>>>    %Cache: @>>>>>
+$stats{'Open_tables'}, $vars{'table_cache'}, perc($stats{'Open_tables'}, $vars{'table_cache'})
+Opened      @>>>>>>>>  @>>>>>/s
+make_short($stats{'Opened_tables'}), t($stats{'Opened_tables'})
+
+__ Connections _________________________________________________________
+Max used    @>>>>>>>> of @>>>      %Max: @>>>>>
+$stats{'Max_used_connections'}, $vars{'max_connections'}, perc($stats{'Max_used_connections'}, $vars{'max_connections'})
+Total       @>>>>>>>>  @>>>>>/s
+make_short($stats{'Connections'}), t($stats{'Connections'})
+
+__ Created Temp ________________________________________________________
+Disk table  @>>>>>>>>  @>>>>>/s
+make_short($stats{'Created_tmp_disk_tables'}), t($stats{'Created_tmp_disk_tables'})
+Table       @>>>>>>>>  @>>>>>/s    Size: @>>>>>
+make_short($stats{'Created_tmp_tables'}), t($stats{'Created_tmp_tables'}), make_short($vars{'tmp_table_size'}, 1, 1)
+File        @>>>>>>>>  @>>>>>/s
+make_short($stats{'Created_tmp_files'}), t($stats{'Created_tmp_files'})
+.
+
+format TAB =
+
+__ Threads _____________________________________________________________
+Running     @>>>>>>>> of @>>>
+$stats{'Threads_running'}, $stats{'Threads_connected'}
+Cached      @>>>>>>>> of @>>>      %Hit: @>>>>>
+$stats{'Threads_cached'}, $vars{'thread_cache_size'}, make_short(100 - perc($stats{'Threads_created'}, $stats{'Connections'}))
+Created     @>>>>>>>>  @>>>>>/s
+make_short($stats{'Threads_created'}), t($stats{'Threads_created'})
+Slow        @>>>>>>>>  @>>>>>/s
+$stats{'Slow_launch_threads'}, t($stats{'Slow_launch_threads'})
+
+__ Aborted _____________________________________________________________
+Clients     @>>>>>>>>  @>>>>>/s
+make_short($stats{'Aborted_clients'}), t($stats{'Aborted_clients'})
+Connects    @>>>>>>>>  @>>>>>/s
+make_short($stats{'Aborted_connects'}), t($stats{'Aborted_connects'})
+
+__ Bytes _______________________________________________________________
+Sent        @>>>>>>>>  @>>>>>/s
+make_short($stats{'Bytes_sent'}), t($stats{'Bytes_sent'})
+Received    @>>>>>>>>  @>>>>>/s
+make_short($stats{'Bytes_received'}), t($stats{'Bytes_received'})
+.
+
+format IB =
+
+__ InnoDB Buffer Pool __________________________________________________
+Usage         @>>>>>> of @>>>>>>  %Used: @>>>>>
+make_short($ib_bp_used, 1), make_short($ib_bp_total, 1), perc($ib_bp_used, $ib_bp_total)
+Read hit      @>>>>>%
+$ib_bp_read_ratio;
+Pages
+  Free      @>>>>>>>>            %Total: @>>>>>
+make_short($stats{'Innodb_buffer_pool_pages_free'}), perc($stats{'Innodb_buffer_pool_pages_free'}, $stats{'Innodb_buffer_pool_pages_total'})
+  Data      @>>>>>>>>                    @>>>>> %Drty: @>>>>>
+make_short($stats{'Innodb_buffer_pool_pages_data'}), perc($stats{'Innodb_buffer_pool_pages_data'}, $stats{'Innodb_buffer_pool_pages_total'}), perc($stats{'Innodb_buffer_pool_pages_dirty'}, $stats{'Innodb_buffer_pool_pages_data'})
+  Misc      @>>>>>>>>                    @>>>>>
+  $stats{'Innodb_buffer_pool_pages_misc'}, perc($stats{'Innodb_buffer_pool_pages_misc'}, $stats{'Innodb_buffer_pool_pages_total'})
+  Latched   @>>>>>>>>                    @>>>>>
+$stats{'Innodb_buffer_pool_pages_latched'}, perc($stats{'Innodb_buffer_pool_pages_latched'}, $stats{'Innodb_buffer_pool_pages_total'})
+Reads       @>>>>>>>>  @>>>>>/s  
+make_short($stats{'Innodb_buffer_pool_read_requests'}), t($stats{'Innodb_buffer_pool_read_requests'})
+  From file @>>>>>>>>  @>>>>>/s          @>>>>>
+make_short($stats{'Innodb_buffer_pool_reads'}), t($stats{'Innodb_buffer_pool_reads'}), perc($stats{'Innodb_buffer_pool_reads'}, $stats{'Innodb_buffer_pool_read_requests'})
+  Ahead Rnd @>>>>>>>>  @>>>>>/s
+$stats{'Innodb_buffer_pool_read_ahead_rnd'}, t($stats{'Innodb_buffer_pool_read_ahead_rnd'})
+  Ahead Sql @>>>>>>>>  @>>>>>/s
+$stats{'Innodb_buffer_pool_read_ahead_seq'}, t($stats{'Innodb_buffer_pool_read_ahead_seq'})
+Writes      @>>>>>>>>  @>>>>>/s
+make_short($stats{'Innodb_buffer_pool_write_requests'}), t($stats{'Innodb_buffer_pool_write_requests'})
+Flushes     @>>>>>>>>  @>>>>>/s
+make_short($stats{'Innodb_buffer_pool_pages_flushed'}), t($stats{'Innodb_buffer_pool_pages_flushed'})
+Wait Free   @>>>>>>>>  @>>>>>/s
+$stats{'Innodb_buffer_pool_wait_free'}, t($stats{'Innodb_buffer_pool_wait_free'})
+.
+
+format IB_LOCK =
+
+__ InnoDB Lock _________________________________________________________
+Waits       @>>>>>>>>  @>>>>>/s
+$stats{'Innodb_row_lock_waits'}, t($stats{'Innodb_row_lock_waits'})
+Current     @>>>>>>>>
+$stats{'Innodb_row_lock_current_waits'}
+Time acquiring
+  Total     @>>>>>>>> ms
+$stats{'Innodb_row_lock_time'}
+  Average   @>>>>>>>> ms
+$stats{'Innodb_row_lock_time_avg'}
+  Max       @>>>>>>>> ms
+$stats{'Innodb_row_lock_time_max'}
+.
+
+format IB_DPR =
+
+__ InnoDB Data, Pages, Rows ____________________________________________
+Data
+  Reads     @>>>>>>>>  @>>>>>/s
+make_short($stats{'Innodb_data_reads'}), t($stats{'Innodb_data_reads'})
+  Writes    @>>>>>>>>  @>>>>>/s
+make_short($stats{'Innodb_data_writes'}), t($stats{'Innodb_data_writes'})
+  fsync     @>>>>>>>>  @>>>>>/s
+make_short($stats{'Innodb_data_fsyncs'}), t($stats{'Innodb_data_fsyncs'})
+  Pending
+    Reads   @>>>>>>>>
+$stats{'Innodb_data_pending_reads'}, t($stats{'Innodb_data_pending_reads'})
+    Writes  @>>>>>>>>
+$stats{'Innodb_data_pending_writes'}, t($stats{'Innodb_data_pending_writes'})
+    fsync   @>>>>>>>>
+$stats{'Innodb_data_pending_fsyncs'}, t($stats{'Innodb_data_pending_fsyncs'})
+
+Pages
+  Created   @>>>>>>>>  @>>>>>/s
+make_short($stats{'Innodb_pages_created'}), t($stats{'Innodb_pages_created'})
+  Read      @>>>>>>>>  @>>>>>/s
+make_short($stats{'Innodb_pages_read'}), t($stats{'Innodb_pages_read'})
+  Written   @>>>>>>>>  @>>>>>/s
+make_short($stats{'Innodb_pages_written'}), t($stats{'Innodb_pages_written'})
+
+Rows
+  Deleted   @>>>>>>>>  @>>>>>/s
+make_short($stats{'Innodb_rows_deleted'}), t($stats{'Innodb_rows_deleted'})
+  Inserted  @>>>>>>>>  @>>>>>/s
+make_short($stats{'Innodb_rows_inserted'}), t($stats{'Innodb_rows_inserted'})
+  Read      @>>>>>>>>  @>>>>>/s
+make_short($stats{'Innodb_rows_read'}), t($stats{'Innodb_rows_read'})
+  Updated   @>>>>>>>>  @>>>>>/s
+make_short($stats{'Innodb_rows_updated'}), t($stats{'Innodb_rows_updated'})
+.
diff -uNr mysql-5.5.60.orig/debian/additions/mysqlreport.1 mysql-5.5.60/debian/additions/mysqlreport.1
--- mysql-5.5.60.orig/debian/additions/mysqlreport.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysqlreport.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,180 @@
+.TH "mysqlreport" "1" "2.5 2006-09-01 (docrev 2006-05-19)" "Daniel Nichter" "MYSQL"
+.SH "NAME"
+.LP 
+mysqlreport \- Makes a friendly report of important MySQL status values
+.SH "SYNTAX"
+.LP 
+mysqlreport [\fIoptions\fP]
+.SH "DESCRIPTION"
+.LP 
+mysqlreport makes a friendly report of important MySQL status values. Actually,
+it makes a friendly report of nearly every status value from SHOW STATUS.
+Unlike SHOW STATUS which simply dumps over 100 values to screen in one long
+list, mysqlreport interprets and formats the values and presents the basic
+values and many more inferred values in a human\-readable format. Numerous
+example reports are available at the mysqlreport web page at
+http://hackmysql.com/mysqlreport.
+
+The benefit of mysqlreport is that it allows you to very quickly see a wide
+array of performance indicators for your MySQL server which would otherwise
+need to be calculated by hand from all the various SHOW STATUS values. For
+example, the Index Read Ratio is an important value but it's not present in
+SHOW STATUS; it's an inferred value (the ratio of Key_reads to
+Key_read_requests).
+
+This documentation outlines all the command line options in mysqlreport, most
+of which control which reports are printed. This document does not address
+how to interpret these reports; that topic is covered in the document Guide
+To Understanding mysqlreport at http://hackmysql.com/mysqlreportguide.
+
+.SH "OPTIONS"
+Technically, command line options are in the form \-\-option, but \-option works
+too. All options can be abbreviated if the abbreviation is unique. For example,
+option \-\-host can be abbreviated \-\-ho but not \-\-h because \-\-h is ambiguous: it
+could mean \-\-host or \-\-help.
+
+.LP 
+
+.TP 
+\fB\-\-help\fR
+Output help information and exit.
+
+.TP 
+\fB\-\-user USER\fR
+
+.TP 
+\fB\-\-password\fR
+As of version 2.3 \-\-password can take the password on the
+command line like "\-\-password FOO". Using \-\-password
+alone without giving a password on the command line
+causes mysqlreport to prompt for a password.
+
+.TP 
+\fB\-\-host ADDRESS\fR
+
+.TP 
+\fB\-\-port PORT\fR
+
+.TP
+\fB\-\-socket SOCKET\fR
+
+.TP 
+\fB\-\-no\-mycnf\fR
+\-\-no\-mycnf makes mysqlreport not read ~/.my.cnf which it does by default
+otherwise. \-\-user and \-\-password always override values from ~/.my.cnf.
+
+.TP 
+\fB\-\-dtq\fR
+Print Distribution of Total Queries (DTQ) report (under
+Total in Questions report). Queries (or Questions) can
+be divided into four main areas: DMS (see \-\-dms below),
+Com_ (see \-\-com below), COM_QUIT (see COM_QUIT and
+Questions at http://hackmysql.com/com_quit), and
+Unknown. \-\-dtq lists the number of queries in each of
+these areas in descending order.
+
+.TP 
+\fB\-\-dms\fR
+Print Data Manipulation Statements (DMS) report (under
+DMS in Questions report). DMS are those from the MySQL
+manual section 13.2. Data Manipulation Statements.
+(Currently, mysqlreport considers only SELECT, INSERT,
+REPLACE, UPDATE, and DELETE.) Each DMS is listed in
+descending order by count.
+
+.TP 
+\fB\-\-com N\fR
+Print top N number of non\-DMS Com_ status values in
+descending order (after DMS in Questions report). If N
+is not given, default is 3. Such non\-DMS Com_ values
+include Com_change_db, Com_show_tables, Com_rollback,
+etc.
+
+.TP 
+\fB\-\-sas\fR
+Print report for Select_ and Sort_ status values (after
+Questions report). See MySQL Select and Sort Status
+Variables at http://hackmysql.com/selectandsort.
+
+.TP
+\fB\-\-tab\fR
+Print Threads, Aborted, and Bytes status reports (after
+Created temp report). As of mysqlreport v2.3 the
+Threads report reports on all Threads_ status values.
+
+.TP
+\fB\-\-qcache\fR
+Print Query Cache report.
+.TP
+\fB\-\-all\fR
+Equivalent to "\-\-dtq \-\-dms \-\-com 3 \-\-sas \-\-qcache".
+(Notice \-\-tab is not invoked by \-\-all.)
+
+.TP
+\fB\-\-infile FILE\fR
+Instead of getting SHOW STATUS values from MySQL, read
+values from FILE. FILE is often a copy of the output of
+SHOW STATUS including formatting characters (|, +, \-).
+mysqlreport expects FILE to have the format
+" value number " where value is only alpha and
+underscore characters (A\-Z and _) and number is a
+positive integer. Anything before, between, or after
+value and number is ignored. mysqlreport also needs
+the following MySQL server variables: version,
+table_cache, max_connections, key_buffer_size,
+query_cache_size. These values can be specified in
+INFILE in the format "name = value" where name is one
+of the aforementioned server variables and value is a
+positive integer with or without a trailing M and
+possible periods (for version). For example, to specify
+an 18M key_buffer_size: key_buffer_size = 18M. Or, a
+256 table_cache: table_cache = 256. The M implies
+Megabytes not million, so 18M means 18,874,368 not
+18,000,000. If these server variables are not specified
+the following defaults are used (respectively) which
+may cause strange values to be reported: 0.0.0, 64,
+100, 8M, 0.
+
+.TP
+\fB\-\-outfile FILE\fR  
+After printing the report to screen, print the report
+to FILE too. Internally, mysqlreport always writes the
+report to a temp file first: /tmp/mysqlreport.PID on
+*nix, c:\mysqlreport.PID on Windows (PID is the
+script's process ID). Then it prints the temp file to
+screen. Then if \-\-outfile is specified, the temp file
+is copied to OUTFILE. After \-\-email (below), the temp
+file is deleted.
+
+.TP
+\fB\-\-email ADDRESS\fR
+After printing the report to screen, email the report
+to ADDRESS. This option requires sendmail in
+/usr/sbin/, therefore it does not work on Windows.
+/usr/sbin/sendmail can be a sym link to qmail, for
+example, or any MTA that emulates sendmail's \-t
+command line option and operation. The FROM: field is
+"mysqlreport", SUBJECT: is "MySQL status report".
+
+.TP
+\fB\-\-flush\-status\fR
+Execute a "FLUSH STATUS;" after generating the reports.
+If you do not have permissions in MySQL to do this an
+error from DBD::mysql::st will be printed after the
+reports.
+
+.SH "AUTHORS"
+.LP 
+Daniel Nichter
+
+If mysqlreport breaks, send me a message from 
+http://hackmysql.com/feedback 
+with the error.
+
+.SH "SEE ALSO"
+.LP 
+mytop(1)
+.LP
+The comprehensive Guide To Understanding mysqlreport at 
+http://hackmysql.com/mysqlreportguide.
+
diff -uNr mysql-5.5.60.orig/debian/additions/mysqltest.1 mysql-5.5.60/debian/additions/mysqltest.1
--- mysql-5.5.60.orig/debian/additions/mysqltest.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/mysqltest.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,16 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+mysqltest \- Regressiontest program for MySQL.
+.SH SYNOPSIS
+mysqltest [options]
+.SH DESCRIPTION
+Runs a test against the mysql server and compares output with a results file.
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/pack_isam.1 mysql-5.5.60/debian/additions/pack_isam.1
--- mysql-5.5.60.orig/debian/additions/pack_isam.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/pack_isam.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,19 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+myisampack \- Compresses MySQL database files.
+.SH SYNOPSIS
+myisampack [options]
+.SH DESCRIPTION
+Pack a ISAM-table to take much smaller space
+Keys are not updated, so you must run isamchk -rq on any table
+that has keys after you have compressed it
+You should give the .ISM file as the filename argument
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/resolve_stack_dump.1 mysql-5.5.60/debian/additions/resolve_stack_dump.1
--- mysql-5.5.60.orig/debian/additions/resolve_stack_dump.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/resolve_stack_dump.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,16 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+resolve_stack_dump \- MySQL helper program for reporting bugs.
+.SH SYNOPSIS
+resolve_stack_dump [options]
+.SH DESCRIPTION
+Resolve numeric stack strace dump into symbols.
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/additions/resolveip.1 mysql-5.5.60/debian/additions/resolveip.1
--- mysql-5.5.60.orig/debian/additions/resolveip.1	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/additions/resolveip.1	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,16 @@
+.TH mysql 1 "17 March 2003" "MySQL 3.23" "MySQL database"
+.SH NAME
+resolveip \- MySQL helper program to retrive IP addresses.
+.SH SYNOPSIS
+resolveip [options]
+.SH DESCRIPTION
+Get hostname based on IP-address or IP-address based on hostname.
+
+For more information start the program with '--help'.
+.SH "SEE ALSO"
+mysql (1), mysqld (1)
+.SH AUTHOR
+This manpage was written by Christian Hammers <ch@debian.org>.
+
+MySQL is available at http://www.mysql.com/.
+.\" end of man page
diff -uNr mysql-5.5.60.orig/debian/apparmor-profile mysql-5.5.60/debian/apparmor-profile
--- mysql-5.5.60.orig/debian/apparmor-profile	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/apparmor-profile	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,45 @@
+# vim:syntax=apparmor
+# Last Modified: Tue Jun 19 17:37:30 2007
+#include <tunables/global>
+
+/usr/sbin/mysqld {
+  #include <abstractions/base>
+  #include <abstractions/nameservice>
+  #include <abstractions/user-tmp>
+  #include <abstractions/mysql>
+  #include <abstractions/winbind>
+
+  capability dac_override,
+  capability sys_resource,
+  capability setgid,
+  capability setuid,
+
+  network tcp,
+
+  /etc/hosts.allow r,
+  /etc/hosts.deny r,
+
+  /etc/mysql/*.pem r,
+  /etc/mysql/conf.d/ r,
+  /etc/mysql/conf.d/* r,
+  /etc/mysql/*.cnf r,
+  /usr/lib/mysql/plugin/ r,
+  /usr/lib/mysql/plugin/*.so* mr,
+  /usr/sbin/mysqld mr,
+  /usr/share/mysql/** r,
+  /var/log/mysql.log rw,
+  /var/log/mysql.err rw,
+  /var/lib/mysql/ r,
+  /var/lib/mysql/** rwk,
+  /var/log/mysql/ r,
+  /var/log/mysql/* rw,
+  /var/run/mysqld/mysqld.pid rw,
+  /var/run/mysqld/mysqld.sock w,
+  /run/mysqld/mysqld.pid rw,
+  /run/mysqld/mysqld.sock w,
+
+  /sys/devices/system/cpu/ r,
+
+  # Site-specific additions and overrides. See local/README for details.
+  #include <local/usr.sbin.mysqld>
+}
diff -uNr mysql-5.5.60.orig/debian/changelog mysql-5.5.60/debian/changelog
--- mysql-5.5.60.orig/debian/changelog	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/changelog	2018-12-02 00:07:20.698467573 +0800
@@ -0,0 +1,5367 @@
+mysql-5.5 (5.5.60-0) jessie-security; urgency=high
+
+  * Non-maintainer upload by the Security Team.
+  * Imported Upstream version 5.5.60 to fix security issues:
+    - http://www.oracle.com/technetwork/security-advisory/cpuapr2018-3678067.html
+    - CVE-2018-2755 CVE-2018-2761 CVE-2018-2771 CVE-2018-2773 CVE-2018-2781
+      CVE-2018-2813 CVE-2018-2817 CVE-2018-2818 CVE-2018-2819
+  * Don't install obsolete manpages.
+    Do not try to install anymore obsolete manpages for mysql_client_test,
+    mysql_client_test_embedded and mysqltest_embedded.
+
+ -- Salvatore Bonaccorso <carnil@debian.org>  Wed, 18 Apr 2018 22:28:36 +0200
+
+mysql-5.5 (5.5.59-0+deb8u1) jessie-security; urgency=high
+
+  * Non-maintainer upload by the Security Team.
+  * Imported Upstream version 5.5.59 to fix security issues:
+    - http://www.oracle.com/technetwork/security-advisory/cpujan2018-3236628.html
+    - CVE-2018-2562 CVE-2018-2622 CVE-2018-2640 CVE-2018-2665 CVE-2018-2668
+
+ -- Salvatore Bonaccorso <carnil@debian.org>  Wed, 17 Jan 2018 13:36:35 +0100
+
+mysql-5.5 (5.5.58-0+deb8u1) jessie-security; urgency=high
+
+  * Imported upstream version 5.5.58 to fix security issues:
+    - http://www.oracle.com/technetwork/security-advisory/cpuoct2017-3236626.html
+    - CVE-2017-10268 CVE-2017-10378 CVE-2017-10379 CVE-2017-10384
+    (Closes: #878402)
+
+ -- Lars Tangvald <lars.tangvald@oracle.com>  Tue, 17 Oct 2017 10:20:55 +0200
+
+mysql-5.5 (5.5.57-0+deb8u1) jessie-security; urgency=high
+
+  * Imported upstream version 5.5.57 to fix security issues:
+    - http://www.oracle.com/technetwork/security-advisory/cpujul2017-3236622.html
+    - CVE-2017-3635 CVE-2017-3636 CVE-2017-3641 CVE-2017-3648
+    - CVE-2017-3651 CVE-2017-3652 CVE-2017-3653 
+    (Closes: #868788)
+
+ -- Lars Tangvald <lars.tangvald@oracle.com>  Thu, 20 Jul 2017 07:03:49 +0200
+
+mysql-5.5 (5.5.55-0+deb8u1) jessie-security; urgency=high
+
+  * Imported upstream version 5.5.55 to fix security issues:
+    - http://www.oracle.com/technetwork/security-advisory/cpuapr2017-3236618.html
+    - CVE-2017-3302 CVE-2017-3305 CVE-2017-3308 CVE-2017-3309
+    - CVE-2017-3329 CVE-2017-3453 CVE-2017-3456 CVE-2017-3461
+    - CVE-2017-3462 CVE-2017-3463 CVE-2017-3464 CVE-2017-3600
+    (Closes: #860544, #854713)
+  * d/patches: refreshed 62_disable_tests.patch
+  * d/patches: dropped fix_test_events_2.patch. Issue fixed upstream
+
+ -- Lars Tangvald <lars.tangvald@oracle.com>  Tue, 18 Apr 2017 09:24:12 +0200
+
+mysql-5.5 (5.5.54-0+deb8u1) jessie-security; urgency=high
+
+  * Imported upstream version 5.5.54 to fix security issues:
+    - http://www.oracle.com/technetwork/security-advisory/cpujan2017-2881727.html
+    - CVE-2017-3238 CVE-2017-3243 CVE-2017-3244 CVE-2017-3258
+    - CVE-2017-3265 CVE-2017-3291 CVE-2017-3312 CVE-2017-3313
+    - CVE-2017-3317 CVE-2017-3318
+    (Closes: #851233)
+  * Fix failing test main.events_2
+    The test was failing due to hardcoded date (2017-01-01). Added patch
+    pending upstream fix.
+
+ -- Lars Tangvald <lars.tangvald@oracle.com>  Tue, 17 Jan 2017 13:04:58 +0100
+
+mysql-5.5 (5.5.53-0+deb8u1) jessie-security; urgency=high
+
+  * Imported upstream version 5.5.53 to fix security issues:
+    - http://www.oracle.com/technetwork/security-advisory/cpuoct2016-2881722.html
+    - CVE-2016-7440 CVE-2016-5584
+    (Closes: #841050)
+  * Packaging will now create /var/lib/mysql-files, as server will now by
+    default restrict all import/export operations to this directory. This
+    can be changed using the secure-file-priv config option.
+
+ -- Lars Tangvald <lars.tangvald@oracle.com>  Mon, 17 Oct 2016 10:49:23 +0200
+
+mysql-5.5 (5.5.52-0+deb8u1) jessie-security; urgency=high
+
+  * Non-maintainer upload by the Security Team.
+  * Imported Upstream version 5.5.52 to fix security issues:
+    - CVE-2016-6662
+
+ -- Salvatore Bonaccorso <carnil@debian.org>  Tue, 13 Sep 2016 20:02:30 +0200
+
+mysql-5.5 (5.5.50-0+deb8u1) jessie-security; urgency=high
+
+  * Non-maintainer upload by the Security Team.
+  * Imported Upstream version 5.5.50 to fix security issues:
+    - http://www.oracle.com/technetwork/security-advisory/cpujul2016-2881720.html
+    - CVE-2016-3477 CVE-2016-3521 CVE-2016-3615 CVE-2016-5440
+
+ -- Salvatore Bonaccorso <carnil@debian.org>  Thu, 21 Jul 2016 07:03:59 +0200
+
+mysql-5.5 (5.5.49-0+deb8u1) jessie-security; urgency=high
+
+  * Imported Upstream version 5.5.49 to fix security issues:
+    - http://www.oracle.com/technetwork/topics/security/cpuapr2016-2881694.html
+    - CVE-2016-0640 CVE-2016-0641 CVE-2016-0642 CVE-2016-0643 CVE-2016-0644
+      CVE-2016-0646 CVE-2016-0647 CVE-2016-0648 CVE-2016-0649 CVE-2016-0650
+      CVE-2016-0666 CVE-2016-2047 
+    (Closes: #821100)
+
+ -- Lars Tangvald <lars.tangvald@oracle.com>  Mon, 18 Apr 2016 07:53:29 +0200
+
+mysql-5.5 (5.5.47-0+deb8u1) jessie-security; urgency=high
+
+  * Imported Upstream version 5.5.47 to fix security issues:
+    - http://www.oracle.com/technetwork/topics/security/cpujan2016-2367955.html
+    - CVE-2016-0546 CVE-2016-0505 CVE-2016-0596 CVE-2016-0597 CVE-2016-0616
+      CVE-2016-0598 CVE-2016-0600 CVE-2016-0606 CVE-2016-0608 CVE-2016-0609
+    (Closes: #811428)
+  * fix-test-suite-failure-caused-by-arbitrary-date-in-the-future-patch is no
+    longer needed, as bug is fixed in new Upstream version
+
+ -- Lars Tangvald <lars.tangvald@oracle.com>  Wed, 13 Jan 2016 12:53:26 +0100
+
+mysql-5.5 (5.5.46-0+deb8u1) jessie-security; urgency=high
+
+  * Non-maintainer upload by the Security Team.
+  * Imported Upstream version 5.5.46 to fix security issues:
+    - http://www.oracle.com/technetwork/topics/security/cpuoct2015-2367953.html
+    - CVE-2015-4792 CVE-2015-4802 CVE-2015-4815 CVE-2015-4816 CVE-2015-4819
+      CVE-2015-4826 CVE-2015-4830 CVE-2015-4836 CVE-2015-4858 CVE-2015-4861
+      CVE-2015-4870 CVE-2015-4879 CVE-2015-4913
+    (Closes: #802564)
+  * Add fix-test-suite-failure-caused-by-arbitrary-date-in-the-future.patch.
+    Fix test suite failure caused by arbitrary date in the future.
+    Thanks to Marc Deslauriers <marc.deslauriers@canonical.com>
+
+ -- Salvatore Bonaccorso <carnil@debian.org>  Fri, 23 Oct 2015 13:35:23 +0200
+
+mysql-5.5 (5.5.44-0+deb8u1) jessie-security; urgency=high
+
+  * Non-maintainer upload by the Security Team.
+  * Imported Upstream version 5.5.44 to fix security issues:
+    - http://www.oracle.com/technetwork/topics/security/cpujul2015-2367936.html
+    - CVE-2015-4752 CVE-2015-4737 CVE-2015-2648 CVE-2015-2643 CVE-2015-2620
+      CVE-2015-2582
+    (Closes: #792445)
+
+ -- Salvatore Bonaccorso <carnil@debian.org>  Wed, 15 Jul 2015 17:00:27 +0200
+
+mysql-5.5 (5.5.43-0+deb8u1) jessie-security; urgency=high
+
+  * Non-maintainer upload by the Security Team.
+  * Imported Upstream version 5.5.43 to fix security issues:
+    - http://www.oracle.com/technetwork/topics/security/cpuapr2015-2365600.html
+    - CVE-2015-0499 CVE-2015-0501 CVE-2015-0505 CVE-2015-2571
+    (Closes: #782645)
+  * Update copyright years for upstream files
+
+ -- Salvatore Bonaccorso <carnil@debian.org>  Sat, 18 Apr 2015 06:07:42 +0200
+
+mysql-5.5 (5.5.42-1) unstable; urgency=medium
+
+  [ James Page ]
+  * SECURITY UPDATE: Update to 5.5.41 to fix security issues:
+    - http://www.oracle.com/technetwork/topics/security/cpujan2015-1972971.html
+    - CVE-2015-0411, CVE-2015-0382, CVE-2015-0381, CVE-2015-0432,
+      CVE-2014-6568, CVE-2015-0374
+    (Closes: #775881).
+  * d/p/fix-func_math-test-failure.patch: Dropped, included upstream.
+
+  [ Akhil Mohan ]
+  * New upstream version, resolving date driven test failures in certs.
+  * Example option in log_slow_queries d/additions/my.cnf is deprecated
+    and replaced with options slow_query_log_file and slow_query_log.
+    (Closes: #677222)
+
+ -- James Page <james.page@ubuntu.com>  Mon, 09 Feb 2015 14:12:44 +0000
+
+mysql-5.5 (5.5.40-1) unstable; urgency=medium
+
+  * SECURITY UPDATE: Update to 5.5.40 to fix security issues:
+    - http://www.oracle.com/technetwork/topics/security/cpuoct2014-1972960.html
+    - CVE-2012-5615, CVE-2014-4274, CVE-2014-4287, CVE-2014-6463,
+      CVE-2014-6464, CVE-2014-6469, CVE-2014-6478, CVE-2014-6484,
+      CVE-2014-6491, CVE-2014-6494, CVE-2014-6495, CVE-2014-6496,
+      CVE-2014-6500, CVE-2014-6505, CVE-2014-6507, CVE-2014-6520,
+      CVE-2014-6530, CVE-2014-6551, CVE-2014-6555, CVE-2014-6559
+    (Closes: #765663, #769337)
+  * d/p/fix-mysqlhotcopy-test-failure.patch: Add return code 255 to the list
+    of allowable return codes for mysqlhotcopy tests.
+  * d/rules: Enable parallel builds.
+
+ -- James Page <james.page@ubuntu.com>  Mon, 24 Nov 2014 16:31:57 +0000
+
+mysql-5.5 (5.5.39-1) unstable; urgency=medium
+
+  * SECURITY UPDATE: Update to 5.5.38 to fix security issues:
+    - http://www.oracle.com/technetwork/topics/security/cpujul2014-1972956.html
+    - CVE-2014-2494
+    - CVE-2014-4207
+    - CVE-2014-4258
+    - CVE-2014-4260
+  * New upstream release.
+  * d/p/fix-func_math-test-failure.patch: Fix for failing func_math test
+    (Closes: #753196, #746883).
+
+ -- James Page <james.page@ubuntu.com>  Mon, 01 Sep 2014 13:20:20 +0100
+
+mysql-5.5 (5.5.37-1) unstable; urgency=medium
+
+  * SECURITY UPDATE: Update to 5.5.37 to fix security issues (Closes: #744910)
+    - http://www.oracle.com/technetwork/topics/security/cpuapr2014-1972952.html
+    - CVE-2014-0001 (Closes: #737596).
+    - CVE-2014-0384
+    - CVE-2014-2419
+    - CVE-2014-2430
+    - CVE-2014-2431
+    - CVE-2014-2432
+    - CVE-2014-2436
+    - CVE-2014-2438
+    - CVE-2014-2440
+  * d/mysql-server-5.5.mysql.init: Fixup indentation on previous change
+    (Closes: #739846).
+  * d/rules: Always install apparmor profile, not just on Ubuntu
+    (Closes: #736087).
+  * d/control: Update for use of virtual-* packages for switching to/from
+    MySQL alternatives.
+  * d/watch,repack.*: Drop repackaging as upstream tarball is now DFSG
+    compliant.
+
+ -- James Page <jamespage@debian.org>  Thu, 24 Apr 2014 18:03:59 +0100
+
+mysql-5.5 (5.5.35+dfsg-2) unstable; urgency=low
+
+  [ Clint Byrum ]
+  * d/mysql-server-5.5.mysql.init: Increase timeout to 30s (Closes: #736452).
+  * d/mysql-server-5.5.postinst: Run mysql_install_db as mysql so tables are
+    not created as root (Closes: #737224).
+
+  [ Robie Basak ]
+  * Re-sync relevant Ubuntu changes:
+    - d/control: Make innotop usable without installing Suggests.
+    - d/rules: Build with debug symbols.
+    - d/{additions/my.cnf,mysql-server-5.5.mysql-server.logrotate}:
+      Write an error log and logrotate it.
+    - d/control,rules,apparmor-profile,mysql-server-5.5.files:
+      Add AppArmor profile (Closes: #736087).
+    - d/control: Move mailx from Recommends to Suggests.
+    - d/control,d/tests/*: Add DEP-8 tests.
+    - d/control: Re-add mysql-testsuite metapackage.
+
+  [ James Page ]
+  * d/control: Drop Nicholas from Uploaders, MIA (Closes: #739361).
+
+ -- James Page <jamespage@debian.org>  Wed, 19 Feb 2014 12:37:01 +0000
+
+mysql-5.5 (5.5.35+dfsg-1) unstable; urgency=low
+
+  [ Clint Byrum ]
+  * Drop creation of insecure database permissions (Closes: #732306):
+    - d/p/33_scripts__mysql_create_system_tables__no_test.patch,
+      d/p/41_scripts__mysql_install_db.sh__no_test.patch,
+      d/p/50_mysql-test__db_test.patch: Restored from mysql-5.1
+      package, inadvertently dropped in 5.5 transition. This
+      removes the global anonymous access to the database which
+      is a security concern.
+
+  [ James Page ]
+  * New upstream release:
+    - d/p/fix-racey-rpltests.patch: Dropped - no longer required.
+    - d/p/50_mysql-test__db_test.patch: Add extra permissions to
+      mysql-run-tests.pl for test_% accounts, fixing failing tests.
+    - d/p/*: Refreshed patches.
+    - SECURITY UPDATE:
+      http://www.oracle.com/technetwork/topics/security/cpujan2014-1972949.html
+      - CVE-2013-5891
+      - CVE-2013-5908
+      - CVE-2014-0386
+      - CVE-2014-0393
+      - CVE-2014-0401
+      - CVE-2014-0402
+      - CVE-2014-0412
+      - CVE-2014-0420
+      - CVE-2014-0437
+  * Sync changes from NMU 5.5.33+dfsg-0+wheezy1:
+    - d/NEWS: Add NEWS file to document changes needed to existing databases
+      to drop insecure database permissions.
+    - SECURITY UPDATE: Insecure creation of the credential file debian.cnf.
+      - d/mysql-server-5.5.postinst: Set umask to 066 before creating
+        debian.cnf file (Closes: #711600).
+      - CVE-2013-2162
+    - d/copyright: Update copyright years for upstream files.
+  * d/control: Update VCS field for new git location.
+  * d/control: Add myself to Uploaders.
+  * d/*: Wrap and sort.
+  * d/control: Bumped Standards-Version, no changes.
+
+ -- James Page <jamespage@debian.org>  Sat, 18 Jan 2014 21:38:18 +0000
+
+mysql-5.5 (5.5.33+dfsg-1) unstable; urgency=low
+
+  * d/rules, d/control: Remove gcc-4.4 dependency and disable X86
+    assembly in taocrypt. (Closes: #707280) (Closes: #678252)
+  * d/patches/fix-mips64el-ftbfs.patch: Fix FTBFS on mips64el.
+    (Closes: #719196) Thanks YunQuiang Su.
+  * New upstream release.
+    SECURITY UPDATE: CVE-2013-1861 CVE-2013-3783 CVE-2013-3793
+    CVE-2013-3804 CVE-2013-3802 CVE-2013-3809 CVE-2013-3812
+    (Closes: #706715) (Closes: #712730)
+  * d/patches/work_around_failing_rpl_deadlock.patch: Test suite
+    changes upstream have left some connections active. This
+    patch fixes that. Thanks Kristian Nielsen!
+  * d/patches/fix-racey-rpltests.patch: Fix from Oracle for failing
+    tests.
+
+ -- Clint Byrum <spamaps@debian.org>  Thu, 26 Sep 2013 09:14:47 -0700
+
+mysql-5.5 (5.5.31+dfsg-1) unstable; urgency=high
+
+  * New upstream release.
+    SECURITY UPDATE: CVE-2013-2375 CVE-2013-1544 CVE-2013-1532
+    CVE-2013-2389 CVE-2013-2392 CVE-2013-2376 CVE-2013-1511
+    CVE-2013-2391 CVE-2013-1502
+    - Patches refreshed.
+    - d/p/yassl.patch - dropped, applied upstream
+    - d/p/debian-mdev382-fixup.patch: dropped, fixed upstream.
+
+ -- Clint Byrum <clint@ubuntu.com>  Mon, 06 May 2013 12:22:55 -0700
+
+mysql-5.5 (5.5.30+dfsg-1.1) unstable; urgency=low
+
+  * Non-maintainer upload.
+  * d/p/yassl.patch - patch for CVE-2013-0169 (Closes: #699886)
+
+ -- Michael Stapelberg <stapelberg@debian.org>  Sun, 14 Apr 2013 12:45:53 +0200
+
+mysql-5.5 (5.5.30+dfsg-1) unstable; urgency=low
+
+  * New upstream release.
+  * d/p/debian-mdev382-fixup.patch - patch from MariaDB, Thanks
+    Kristian Nielsen. resolves  CVE-2012-4414 (Closes: #698068)
+
+ -- Clint Byrum <clint@ubuntu.com>  Sun, 24 Mar 2013 16:22:56 -0700
+
+mysql-5.5 (5.5.29+dfsg-1) unstable; urgency=low
+
+  [ Clint Byrum ]
+  * d/mysql-server-5.5.postinst: Patch from Alex Bligh to fix privilege
+    regression that was introduced in the switch from 5.1 to 5.5.
+    (Closes: #692871)
+  * New upstream release. (Closes: #695001) Refreshed patches.
+
+ -- Nicholas Bamber <nicholas@periapt.co.uk>  Fri, 11 Jan 2013 15:29:53 +0000
+
+mysql-5.5 (5.5.28+dfsg-1) unstable; urgency=low
+
+  * New upstream release (resolves CVE-2012-3163, CVE-2012-3158, CVE-2012-3177,
+    CVE-2012-3147, CVE-2012-3166, CVE-2012-3173, CVE-2012-3144, CVE-2012-3150,
+    CVE-2012-3180, CVE-2012-3149, CVE-2012-3156, CVE-2012-3167, CVE-2012-3197,
+    CVE-2012-3160) (Closes: #690778)
+  * Removed debian/patches/73_mysqlcheck_tests.patch and
+    debian/patches/2_main_openssl_1.patch as they did not apply cleanly and did
+    not seem to be required any longer
+  * Refreshed patches and updated headers:
+    - debian/patches/73_mysqlcheck_tests.patch
+    - debian/patches/94_spelling.patch
+    - debian/patches/70_mysql_va_list.patch
+
+ -- Nicholas Bamber <nicholas@periapt.co.uk>  Sun, 28 Oct 2012 09:22:24 +0000
+
+mysql-5.5 (5.5.24+dfsg-9) unstable; urgency=low
+
+  * Danish debconf translation (Closes: #684566)
+  * Turkish debconf translation (Closes: #688294)
+  * Loosened versioned dependency between mysql-server-5.5 and
+    mysql-server-core-5.5, hopefully (Closes: #686803)
+  * Restored zlib1g-dev (>= 1:1.1.3-5) as a build dependency
+    and made the use of system libz explicit in debian/rules
+
+ -- Nicholas Bamber <nicholas@periapt.co.uk>  Sat, 22 Sep 2012 15:01:11 +0100
+
+mysql-5.5 (5.5.24+dfsg-8) unstable; urgency=low
+
+  * Updated debian/copyright after analysis from development version
+    of license-reconcile (Closes: #682311)
+    - 'Comments' field to corrected to 'Comment'
+    - Missing paragraphs for '*', 'debian/*' and for the mysqlreport
+      and innotop scripts
+    - Removed duplicate entries from Files listings
+    - Added clause for files licensed under BSD (4-clause)
+    - Clarified 'BSD (3 clause) GPL-2' as being 'BSD (3 clause) or GPL-2'
+  * Updated Slovak debconf translation (Closes: #684644)
+
+ -- Nicholas Bamber <nicholas@periapt.co.uk>  Tue, 04 Sep 2012 06:56:24 +0100
+
+mysql-5.5 (5.5.24+dfsg-7) unstable; urgency=low
+
+  * Updated Turkish debconf translation (Closes: #683733)
+  * Use xz compression for binary packages (Closes: #684146)
+
+ -- Nicholas Bamber <nicholas@periapt.co.uk>  Sat, 11 Aug 2012 21:02:27 +0100
+
+mysql-5.5 (5.5.24+dfsg-6) unstable; urgency=low
+
+  * Updated Czech debconf translation (Closes: #681711)
+
+ -- Nicholas Bamber <nicholas@periapt.co.uk>  Sun, 29 Jul 2012 13:04:46 +0100
+
+mysql-5.5 (5.5.24+dfsg-5) unstable; urgency=medium
+
+  * Spanish debconf translation (Closes: #679053)
+
+ -- Nicholas Bamber <nicholas@periapt.co.uk>  Sat, 14 Jul 2012 13:36:13 +0100
+
+mysql-5.5 (5.5.24+dfsg-4) unstable; urgency=low
+
+  * Made DFSG repacking mechanism independent of local installs, improved
+    the documentation and added debian/README.source
+  * Setting the gcc/g++ version to 4.4 on i386 platforms and removed
+    patch disabling tests (Closes: #674267) but see #678252 for follow
+    up from upstream
+  * Danish debconf translation (Closes: #599483)
+
+ -- Nicholas Bamber <nicholas@periapt.co.uk>  Thu, 21 Jun 2012 13:36:40 +0100
+
+mysql-5.5 (5.5.24+dfsg-3) unstable; urgency=high
+
+  * Added versioned dependency on initscripts and revert /var/run
+    to /run change (Closes: #676560)
+
+ -- Nicholas Bamber <nicholas@periapt.co.uk>  Thu, 07 Jun 2012 23:29:32 +0100
+
+mysql-5.5 (5.5.24+dfsg-2) unstable; urgency=low
+
+  * Really bumped the version in shlibs
+
+ -- Nicholas Bamber <nicholas@periapt.co.uk>  Mon, 04 Jun 2012 23:03:35 +0100
+
+mysql-5.5 (5.5.24+dfsg-1) unstable; urgency=low
+
+  * New upstream release. Fixes CVE-2012-2102 mysql DoS by authenticated user
+  * Updated Portuguese translation (Closes: #674953)
+  * Updated Swedish translation (Closes: #675108)
+  * Updated German translation (Closes: #675766)
+  * Refreshed spelling patch
+  * Added patch to libmysql/CMakeLists.txt to restore symbol versioning
+    and bumped dependency in shlibs (Closes: #660686)
+  * Ensured that /etc/mysql/conf.d is installed as part of mysql-common
+    so that client programs work without a co-located server (Closes: #672359)
+  * Added versioned Breaks clause against amarok (cf. #675304)
+
+ -- Nicholas Bamber <nicholas@periapt.co.uk>  Mon, 04 Jun 2012 18:17:04 +0100
+
+mysql-5.5 (5.5.23+dfsg-2) unstable; urgency=low
+
+  * Fixing regular expression in tests to guard against build path containing
+    the '+' symbol (Closes: #674210)
+  * Disabled certain SSL tests pending investigation (cf. #674267)
+  * Updated French translation (Closes: #674025)
+  * Updated Dutch translation (Closes: #674124)
+  * Updated Russian translation (Closes: #674189)
+
+ -- Nicholas Bamber <nicholas@periapt.co.uk>  Fri, 25 May 2012 23:38:16 +0100
+
+mysql-5.5 (5.5.23+dfsg-1) unstable; urgency=low
+
+  * Revert having libssl-dev as a build dependency and changed
+    WITH_SSL option to 'bundled' from 'yes' (Closes: #590905)
+    and (Closes: #673865)
+  * Standardized debian/watch and get-orig-source and made DFSG exclusion
+    of Docs/mysql.info explicit (Closes: #673528)
+  * Located and installed upstream changelog
+
+ -- Nicholas Bamber <nicholas@periapt.co.uk>  Tue, 22 May 2012 21:42:39 +0100
+
+mysql-5.5 (5.5.23-2) unstable; urgency=low
+
+  * Stopped overriding the -j build parameter (Closes: #512964)
+  * Stopped testing for /proc filesystem. It is no longer used
+    for determining the number of CPUs.
+  * Removed unnecessary build dependencies:
+    - procps as it is required by cmake, cf. #96768
+    - zlib1g newer version required by cmake
+    - libtool obsoleted by cmake
+    - file required by debhelper
+  * Migrated libmysqld-dev, libmysqld-pic, libmysqlclient18 to using
+    dh_install rather than dh_movefiles
+  * Changed /var/run to /run as required by Debian Policy 3.9.3 (9.1.1)
+  * Raised standards version to 3.9.3
+  * Moved '-e' from shebang line to explicit 'set -e' as requested by lintian
+  * Restored ha_example.so to mysql-server-5.5 but added Breaks/Replaces
+    clauses (cf. LP: #912487) and (Closes: #666721)
+  * Added additional Breaks/Replaces clauses for other clashes:
+    - mysql-server-5.5 overwrites perror from mysql-client-5.1
+    - mysql-server-core-5.5 overwrites my_print_defaults from mysql-client-5.1
+
+ -- Nicholas Bamber <nicholas@periapt.co.uk>  Tue, 08 May 2012 05:59:09 +0100
+
+mysql-5.5 (5.5.23-1) experimental; urgency=low
+
+  * Added patch to test suite to accept socket paths less than 40
+    characters long (Closes: #540153)
+  * Disabled some more tests including some reported by Olaf van der Speck
+  * Removed ha_example.so from mysql-server-5.5 install (Closes: #666721)
+  * New upstream release: unspecified security issues CVE-2012-1697,
+    CVE-2012-1696 
+  * Added patch to correct spelling mistakes: preceeding -> preceding
+
+ -- Nicholas Bamber <nicholas@periapt.co.uk>  Thu, 03 May 2012 18:03:34 +0100
+
+mysql-5.5 (5.5.20-1) experimental; urgency=low
+
+  [ Guillaume Plessis ]
+  * d/rules: Enabling ARCHIVE, BLACKHOLE, and FEDERATED engines.
+    (Closes: #649484)
+  * d/rules: Turn off embedded libedit/readline.(Closes: #659566)
+
+  [ Clint Byrum ]
+  * New Upstream Release
+  * d/copyright: rearranging to have standalone license paragraphs
+    silencing lintian complaints about missing paragraphs.
+  * d/mysql-client-5.5.files: add mysql_plugin
+  * d/rules, d/control: 5.5.20 Fixes segfault on tests with gcc 4.6,
+    change compiler back to system default.
+  * Sync changes back from Ubuntu:
+      * d/control: need to also break mysql-client-core-5.1 and
+        mysql-server-core-5.1 as well so that apt knows not to
+        remove mysql-server/mysql-client.
+      * d/control: convert mysql-server back to a meta-package
+      * d/control: convert mysql-client back to a meta-package as well.
+      * d/patches/72_fix_standalone_tests.patch: fix testsuite so it
+        will run all tests when run from system /usr/lib/mysql-testsuite
+        directory.
+        5.1 is removed from the archive.
+      * d/control: mysql-common includes configuration items that only
+        work on mysql 5.5, so adding Breaks: for client and server 5.1.
+        This will make mysql-server-5.1 and mysql-client-5.1 
+        uninstallable which is actually desired.
+      * d/patches/71_disable_rpl_tests.patch: disables this test until
+        Ubuntu bug #894146 can be triaged.
+      * d/mysql-client-5.5.files: add missing mysql_plugin
+      * d/libmysqlcient18.files,libmysqlclient-dev.files,d/rules: re-add
+        libmysqlclient_r. In hindsight, removing it was not a productive
+        change.
+      * d/libmysqlclient-dev.files: ship entire contents of include dir,
+        some of these files are included internally by others in the 
+        main dir.
+      * d/patches/70_mysql_va_list.patch: cherry pick patch from
+        upstream bug tracker to fix ARM build failure. (LP: #700982)
+
+  [ Nicholas Bamber ]
+  * Added myself to Uploaders
+  * Added libssl-dev as a build dependency and patched main.openssl_1 test
+    so that it works with that library (Closes: #660799)
+  * Added patch to provide cmake options for GNU/Hurd (Closes: #651002)
+    and tweaked debian/rules so that only 'make test' is run on Hurd.
+  * Tweaked debian/rules to make build logs verbose (Closes: #651003)
+  * Refreshed patches - and added a new patch to disable a further flurry
+    of failing tests
+  * Switched on native AIO in linux builds (Closes: #659565)
+  * Numerous minor changes to improve lintian cleanliness (Closes: #663354)
+    - Added dh_lintian lines to debian/rules to ensure that lintian
+      overrides take effect and removed old commented out lines
+    - Clarified Hurd procps dependency in debian/control
+    - Rewrote short description of the libmysqld-pic package to be more accurate
+    - Depersonalised long description of mysql-client
+    - Removed dependencies relating to mysql-common-4.1
+    - Tightened Breaks clauses for mysql-common
+    - Removed duplicate entry from Replaces clauses for mysql-server-core-5.5
+    - Rexpressed Conflicts clause as versioned dependency
+      for mysql-testsuite-5.5
+    - Added DEP-5 header fields to two patches
+    - Refreshed and commented all lintian overrides and added override
+      concerning lack of upstream changelog to all packages
+    - Cleaned up debian/copyright
+      * upgraded to latest version of DEP-5
+      * encoding issues
+      * out of date FSF address
+      * Updated License short name from "PD" to "public-domain"
+  * Converted to short form debhelper rules
+    - Renamed stamp files to end in '-stamp' so that they are cleaned up
+      automatically by dh_clean
+    - Removed commented out lines
+    - Removed obsolete -DINSTALL_LIBDIR clause from pic build
+    - Overrode dh_auto_install so that the rules only run once
+    - Migrated mysql-source, mysql-testsuite, mysql-common from
+    dh_movefiles to dh_install
+
+ -- Nicholas Bamber <nicholas@periapt.co.uk>  Sat, 28 Apr 2012 15:02:16 +0100
+
+mysql-5.5 (5.5.17-4) experimental; urgency=low
+
+  * d/control: Pre-Depend on multiarch-support and misc:Pre-Depends.
+    also bump debhelper Build-Dep for multiarch.
+    d/compat: raise to 9 for multiarch support.
+
+ -- Clint Byrum <clint@ubuntu.com>  Thu, 17 Nov 2011 17:38:19 -0800
+
+mysql-5.5 (5.5.17-3) experimental; urgency=low
+
+  [Clint Byrum]
+  * d/control: setting Multi-Arch fields where appropriate.
+
+  [Norbert Tretkowski]
+  * Add Clint Byrum to Uploaders.
+
+ -- Clint Byrum <clint@ubuntu.com>  Thu, 17 Nov 2011 14:36:50 -0800
+
+mysql-5.5 (5.5.17-2) experimental; urgency=low
+
+  * d/rules, d/control: Build with gcc 4.5 to avoid
+    gcc 4.6 compile problems (see Debian bug number 630471)
+  * d/rules, d/libmysqlclient*.files: changes to support
+    multiarch.
+  * d/libmysqlclient18.files, d/libmysqlclient-dev.files: install
+    symlinks to dev libraries properly and remove libmysqlclient_r
+    since it is no longer needed. libmysqlclient is now perfectly
+    thread safe. This will cause FTBFS but can be corrected by simply
+    removing _r, and avoids uncomfortable problem of trying to properly
+    mangle libmysqlclient_r symlinks to libmysqlclient.so.
+
+ -- Clint Byrum <clint@ubuntu.com>  Wed, 09 Nov 2011 23:27:36 -0800
+
+mysql-5.5 (5.5.17-1) experimental; urgency=low
+
+  [Norbert Tretkowski]
+  * New upstream release.
+  * Fix empty libmysqld-pic package.
+  * Run dh_apparmor on Ubuntu only.
+
+  [Clint Byrum]
+  * Rewrote debian/copyright file from scratch.
+
+ -- Clint Byrum <clint@ubuntu.com>  Tue, 08 Nov 2011 11:31:13 -0800
+
+mysql-5.5 (5.5.13-1) experimental; urgency=low
+
+  [Clint Byrum]
+  * New upstream major release. Changing source name to mysql-5.5.
+    (closes: #609592, #637274)
+  * Dropping usr/lib/libmysqlclient*.la as they are no longer built
+    by the cmake build, and are not necessary for linking properly.
+  * Removing obsolete automake and dpatch build deps.
+  * Converted source format to 3.0 (quilt).
+  * debian/patches: Converted to quilt, and removed all except disable
+    long filename check to allow building on sbuild/chroots.
+  * Renamed packages with -5.1 suffix to -5.5.
+  * Renaming mysql-testsuite to mysql-testsuite-5.5.
+  * Dropping unneeded docs files.
+  * Dropping libmysqlclient16-dev as transition is complete.
+  * Bumping libmysqlclient to v18 for new SONAME.
+
+  [Norbert Tretkowski]
+  * Update my.cnf to use --lc-messages-dir instead --language.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Thu, 23 Jun 2011 10:25:33 +0200
+
+mysql-5.1 (5.1.58-1) unstable; urgency=low
+
+  * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sun, 17 Jul 2011 17:26:27 +0200
+
+mysql-5.1 (5.1.57-3) unstable; urgency=low
+
+  * Really fix syntax warning in preinst. (closes: #630672)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Tue, 21 Jun 2011 10:33:25 +0200
+
+mysql-5.1 (5.1.57-2) unstable; urgency=low
+
+  * Acknowledge NMUs. (closes: #614044)
+  * Fix syntax warning in preinst. (closes: #630672)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sat, 18 Jun 2011 19:28:35 +0200
+
+mysql-5.1 (5.1.57-1.3) unstable; urgency=high
+
+  * Non-maintainer upload.
+  * Use correct DEB_HOST_GNU_TYPE and not DEB_HOST_BUILD_TYPE.
+
+ -- Ondej Sur <ondrej@debian.org>  Mon, 13 Jun 2011 17:02:50 +0200
+
+mysql-5.1 (5.1.57-1.2) unstable; urgency=high
+
+  * Non-maintainer upload.
+  * Prefix gcc-4.5 and g++-4.5 with DEB_BUILD_GNU_TYPE to fix FTBFS on
+    ia64, s390 and maybe more.
+
+ -- Ondej Sur <ondrej@debian.org>  Mon, 13 Jun 2011 13:20:37 +0200
+
+mysql-5.1 (5.1.57-1.1) unstable; urgency=high
+
+  * Non-maintainer upload (with permission of maintainer).
+  * Build with gcc-4.5 (Closes: #614044)
+  * Revert: "Build with -O2 instead -O3, MySQL seems not yet ready for -
+    O3 when using gcc-4.6." since we are building with gcc-4.5.
+
+ -- Ondej Sur <ondrej@debian.org>  Mon, 13 Jun 2011 08:51:51 +0200
+
+mysql-5.1 (5.1.57-1) unstable; urgency=medium
+
+  * Bump libmysqlclient16 shlibs to 5.1.50-1 as it introduced a new symbol.
+    (closes: #617240)
+  * Build with -O2 instead -O3, MySQL seems not yet ready for -O3 when using
+    gcc-4.6. (closes: #614044)
+  * Ignore errors in testsuite run on ia64.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sat, 14 May 2011 14:56:13 +0200
+
+mysql-5.1 (5.1.56-1) unstable; urgency=low
+
+  * New upstream release.
+  * Replace doxygen and texlive-latex-base build-deps with doxygen-latex.
+    (closes: #616270)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Tue, 08 Mar 2011 20:59:41 +0100
+
+mysql-5.1 (5.1.55-1) unstable; urgency=low
+
+  * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Tue, 08 Feb 2011 12:56:42 +0100
+
+mysql-5.1 (5.1.54-2) unstable; urgency=low
+
+  * Upload to unstable.
+  * Add mysql-source-5.1 package, patch from Clint Byrum. (closes: #611965)
+  * Update debconf translations:
+    - Dutch, from Eric Spreen. (closes: #605590)
+    - Slovak, from Slavko. (closes: #608885)
+  * Fix minor grammar infelicity in debian-start script. (closes: #582955)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Fri, 04 Feb 2011 16:28:08 +0100
+
+mysql-5.1 (5.1.54-1) experimental; urgency=low
+
+  * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Fri, 17 Dec 2010 06:06:18 +0100
+
+mysql-5.1 (5.1.53-1) experimental; urgency=low
+
+  * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Wed, 01 Dec 2010 12:41:28 +0100
+
+mysql-5.1 (5.1.51-1) experimental; urgency=low
+
+   * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sat, 02 Oct 2010 16:18:30 +0200
+
+mysql-5.1 (5.1.50-1) experimental; urgency=low
+
+   * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sun, 12 Sep 2010 20:13:25 +0200 
+
+mysql-5.1 (5.1.49-3) unstable; urgency=high
+
+  * SECURITY UPDATE: denial of service via incorrect propagation of type
+    errors.
+    - debian/patches/61_CVE-2010-3833.dpatch: properly check for execution
+      errors in sql/item_func.cc. Add tests to mysql-test/*.
+    - CVE-2010-3833
+  * SECURITY UPDATE: denial of service via derived table materializing.
+    - debian/patches/61_CVE-2010-3834.dpatch: handle temporary tables in
+      sql/field.cc, sql/sql_select.*. Add tests to mysql-test/*.
+    - CVE-2010-3834
+  * SECURITY UPDATE: denial of service via user-variable assignment
+    expression.
+    - debian/patches/61_CVE-2010-3835.dpatch: fix logic in sql/item_func.*,
+      Add tests to mysql-test/*.
+    - CVE-2010-3835
+  * SECURITY UPDATE: denial of service via pre-evaluation of LIKE
+    predicates during view preparation.
+    - debian/patches/61_CVE-2010-3836.dpatch: make sure we're not in view
+      preparation mode in sql/item_cmpfunc.cc. Add tests to mysql-test/*.
+    - CVE-2010-3836
+  * SECURITY UPDATE: denial of service via use of GROUP_CONCAT() and
+    WITH ROLLUP together.
+    - debian/patches/61_CVE-2010-3837.dpatch: create a copy of the order
+      structures in sql/item_sum.cc, sql/table.h. Add tests to
+      mysql-test/*.
+    - CVE-2010-3837
+  * SECURITY UPDATE: denial of service via longblob and union or update
+    with subquery.
+    - debian/patches/61_CVE-2010-3838.dpatch: handle REAL_RESULT in
+      sql/item_func.cc. Add tests to mysql-test/*.
+    - CVE-2010-3838
+  * SECURITY UPDATE: denial of service via certain queries with nested
+    joins.
+    - debian/patches/61_CVE-2010-3839.dpatch: fix nesting in
+      sql/sql_select.cc. Add tests to mysql-test/*.
+    - CVE-2010-3839
+  * SECURITY UPDATE: denial of service via PolyFromWKB() function and
+    improper data.
+    - debian/patches/61_CVE-2010-3840.dpatch: improve data handling in
+      sql/spatial.cc. Add tests to mysql-test/*.
+    - CVE-2010-3840
+
+  * Patches and changelog entries taken from Ubuntu. (closes: #599937)
+  * Import and ACK NMU 5.1.49-2.1. (closes: #595120, #601152)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Tue, 30 Nov 2010 09:20:33 +0100
+
+mysql-5.1 (5.1.49-2.1) unstable; urgency=high
+
+  * Non-maintainer upload.
+  * debian/mysql-server-5.1.mysql.init: Remove $named from
+    Should-Start/Should-Stop (closes: #595120).
+    Thanks for Clint Byrum <clint@ubuntu.com> patch.
+  * Update Portuguese translation (closes: #601152).
+    Thanks for Miguel Figueiredo <elmig@debianpt.org> patch.
+
+ -- Xavier Oswald <xoswald@debian.org>  Sat, 27 Nov 2010 17:43:13 +0100
+
+mysql-5.1 (5.1.49-2) unstable; urgency=low
+
+  * Check for server binary before executing any script. (closes: #583611)
+  * Move my_print_defaults and perror from mysql-server-5.1 to mysql-client-5.1
+    package. (closes: #591373)
+  * Update debconf translations:
+    - Spanish, from Javier Fernndez-Sanguino. (closes: #592171)
+    - Galician, from Jorge Barreiro. (closes: #592813)
+    - Arabic, from Ossama Khayat. (closes: #596169, #600884)
+    - Czech, from Miroslav Kure. (closes: #598339)
+    - Danish, from Joe Dalton. (closes: #599483)
+    - Portuguese, from Rui Branco. (closes: #599759)
+    - Catalan, from Jordi Mallach. (closes: #601098)
+  * Add patch 99_fix_testsuite_for_installed_env.dpatch from Ubuntu to fix
+    mysql-testsuite to work with the installation location.
+  * Add README.source file to make lintian happy.
+  * Update Standards-Version to 3.9.1, no changes required.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Wed, 27 Oct 2010 14:41:19 +0200
+
+mysql-5.1 (5.1.49-1) unstable; urgency=low
+
+  * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sat, 31 Jul 2010 12:34:43 +0200
+
+mysql-5.1 (5.1.48-1) unstable; urgency=low
+
+  * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Thu, 17 Jun 2010 22:38:56 +0200
+
+mysql-5.1 (5.1.47-1) unstable; urgency=low
+
+  * New upstream release. (closes: #582526)
+  * Add patch to fix compile issue with embedded enabled.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sat, 22 May 2010 08:59:41 +0200
+
+mysql-5.1 (5.1.46-1) unstable; urgency=low
+
+  * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Tue, 11 May 2010 18:47:32 +0200
+
+mysql-5.1 (5.1.45-3) unstable; urgency=low
+
+  * Upload to unstable.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sat, 10 Apr 2010 19:22:55 +0200
+
+mysql-5.1 (5.1.45-2) experimental; urgency=low
+
+  * Add mysql-server-core-5.1 package, containing the package and its manpage,
+    to let packages like akonadi use the mysqld binary without using system
+    databases. Thanks to Didier Raboud for the patch! (closes: #548419)
+  * Add libterm-readkey-perl suggestion to mysql-client-5.1 package.
+    (closes: #574505, #575769)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Wed, 31 Mar 2010 11:36:25 +0200
+
+mysql-5.1 (5.1.45-1) unstable; urgency=low
+
+  * New upstream release.
+  * Drop patch 10_readline_build_fix.dpatch.
+  * Rename source package to mysql-5.1.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Wed, 17 Mar 2010 14:56:02 +0100
+
+mysql-dfsg-5.1 (5.1.44-3) unstable; urgency=low
+
+  * Add patch that reinstates the reloading of character set data when a
+    mysql_library_init() is done after a mysql_library_end().
+    (closes: #569549, #569595)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Mon, 01 Mar 2010 18:22:35 +0100
+
+mysql-dfsg-5.1 (5.1.44-2) unstable; urgency=low
+
+  * Disable innodb.innodb_information_schema test in testsuite run, it fails
+    randomly on at least i386. (closes: #570693)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sun, 21 Feb 2010 20:45:59 +0100
+
+mysql-dfsg-5.1 (5.1.44-1) unstable; urgency=low
+
+  * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Thu, 18 Feb 2010 21:38:09 +0100
+
+mysql-dfsg-5.1 (5.1.43-1) unstable; urgency=low
+
+  * New upstream release.
+  * Drop patches:
+    + 11_binlog_wrong_offset.dpatch
+    + 96_SECURITY_CVE-2009-4484.dpatch
+  * Disable SSL related test in the testsuite until MySQL gets shipped with an
+    updated SSL certificate.
+  * Include symlinks for mysqlcheck manpages. (closes: #558760)
+  * Fix some lintian warnings:
+    + debian-news-entry-has-unknown-version
+    + postinst-has-useless-call-to-ldconfig
+    + postrm-has-useless-call-to-ldconfig
+  * Bump Standards-Version to 3.8.4, no changes required.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Mon, 01 Feb 2010 22:03:42 +0100
+
+mysql-dfsg-5.1 (5.1.41-4) unstable; urgency=high
+
+  * SECURITY:
+    Fix for CVE-2009-4484: Copying name tags into an internal buffer from
+    incoming stream we didn't check the buffer overflow. That may lead to
+    memory overrun, crash etc.
+  * Add -fno-strict-aliasing to $CFLAGS to get around testsuite errors when
+    building with gcc 4.4.x. (closes: #554207)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Mon, 18 Jan 2010 19:03:25 +0100
+
+mysql-dfsg-5.1 (5.1.41-3) unstable; urgency=low
+
+  * Let mysql-server-5.1 replace libmysqlclient-dev (>= 5.1.41-1) because of
+    moved InnoDB plugin. (closes: #557806)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Tue, 24 Nov 2009 19:20:36 +0100
+
+mysql-dfsg-5.1 (5.1.41-2) unstable; urgency=low
+
+  * Move InnoDB plugin into -server package.
+  * Fix some lintian errors and warnings:
+    + weak-library-dev-dependency
+    + dir-or-file-in-var-run
+    + command-with-path-in-maintainer-script
+  * Ignore errors in testsuite run on s390.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sat, 21 Nov 2009 13:37:17 +0100
+
+mysql-dfsg-5.1 (5.1.41-1) unstable; urgency=medium
+
+  * New upstream release.
+  * Drop patch 60_zlib_innodb_workaround.dpatch, merged upstream.
+  * Make $DATADIR readable/writeable only for user mysql. (closes: #555626)
+  * Build with --without-readline to use system readline instead of bundled
+    copy. (closes: #552003)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Fri, 20 Nov 2009 17:35:42 +0100
+
+mysql-dfsg-5.1 (5.1.40-1) unstable; urgency=low
+
+  * New upstream release.
+  * Set thread_stack size to 192K rather than 128K.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Fri, 23 Oct 2009 19:12:45 +0200
+
+mysql-dfsg-5.1 (5.1.39-1) unstable; urgency=low
+
+  * New upstream release.
+  * New patch 60_zlib_innodb_workaround.dpatch to fix an incompatibility
+    between zlib and innodb during testsuite run.
+  * Wait in the SIGHUP trap to avoid killing an existing mysqld process when a
+    HUP signal is sent to mysqld_safe, patch based based on Mathias Gug's fix
+    from 5.0 series. (closes: #545044)
+  * Update debconf translations:
+    - Japanese, from Hideki Yamane. (closes: #545329)
+    - Swedish, from Martin Bagge. (closes: #545731)
+  * Fix some options in my.cnf about log_file have their named changed, patch
+    from Mathias Gug. (closes: #545761)
+  * Do not upgrade if there is an ndb management node configured, patch from
+    Mathias Gug. (closes: #545760)
+  * Switch build-dependency from libreadline5-dev to libreadline-dev.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Mon, 28 Sep 2009 17:41:51 +0200
+
+mysql-dfsg-5.1 (5.1.37-2) unstable; urgency=low
+
+  * Update debconf translations:
+    - Swedish, from Martin Bagge. (closes: #539207)
+    - Russian, from Yuri Kozlov. (closes: #540216)
+    - French, from Christian Perrier. (closes: #540508)
+    - Italian, from Luca Monducci. (closes: #541465)
+    - German, from Thomas Mueller. (closes: #544477)
+  * Handle DEB_BUILD_OPTIONS correctly, patch from Stephen Depooter.
+    (closes: #523928)
+  * Support ANSI mode in debian-start.inc.sh, patch from Mathias Gug.
+    (closes: #534606)
+  * Enable hardening. (closes: #542746)
+  * Drop old_passwords option. (closes: #540366)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Wed, 02 Sep 2009 20:26:59 +0200
+
+mysql-dfsg-5.1 (5.1.37-1) unstable; urgency=low
+
+  * New upstream release.
+  * Drop empty transitional package libmysqlclient15-dev, and provide/replace
+    it with libmysqlclient-dev. (closes: #538659)
+  * Ignore errors in testsuite on all archs but amd64, i386, ia64 and s390.
+    (closes: #539679)
+  * Update debconf translations:
+    - French, from Christian Perrier. (closes: #539703)
+  * Fixed typo regarding log_type in my.cnf.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Tue, 04 Aug 2009 19:25:45 +0200
+
+mysql-dfsg-5.1 (5.1.36-5) unstable; urgency=low
+
+  [ Christian Hammers ]
+  * Applied debconf template patch from debian-l10n-english (thanks to
+    Justin B Rye).
+  * Added a missing misc:Depends to debian/control for lintian.
+  * Fixes typo in initscript (thanks to Gaspar Lajos).
+
+  [ Norbert Tretkowski ]
+  * Ignore errors in testsuite run on mips. (closes: #539095)
+  * Update debconf translations:
+    - Basque, from Piarres Beobide. (closes: #539130)
+    - Russian, from Yuri Kozlov. (closes: #539459)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sat, 01 Aug 2009 11:13:55 +0200
+
+mysql-dfsg-5.1 (5.1.36-4) unstable; urgency=low
+
+  * dpkg-gensymbols caused a lot of FTBFS because the C++ libraries have
+    slightly different symbol names on other archs (long vs. int somebody
+    told me on IRC). We now limit the ABI compatibility check to amd64.
+
+ -- Christian Hammers <ch@debian.org>  Sun, 26 Jul 2009 11:46:20 +0200
+
+mysql-dfsg-5.1 (5.1.36-3) unstable; urgency=low
+
+  * Moving from experimental to unstable!
+
+ -- Christian Hammers <ch@debian.org>  Sat, 25 Jul 2009 20:42:39 +0200
+
+mysql-dfsg-5.1 (5.1.36-2) experimental; urgency=low
+
+  * Build both -fPIC (libmysql_pic.a) and non -fPIC (libmysqld.a) as
+    some packages seem to need the -fPIC variant for their own build
+    process. Documented in README.Debian. Thanks to Modestas Vainius
+    for the patch. Closes: #508406
+  * Switch to out-of-source true build mode was a side effect of this change.
+  * Added libmysqlclient16.symbols file (thanks to Raphael Hertzog).
+  * Raised debian/compat from 4 to 7.
+  * Updated innotop to 1.7.1.
+  * Minor cleanups that lintian suggested.
+
+ -- Christian Hammers <ch@debian.org>  Sun, 19 Jul 2009 18:48:53 +0200
+
+mysql-dfsg-5.1 (5.1.36-1) experimental; urgency=low
+
+  * Ex-maintainer upload :)
+  * New upstream release.
+  * SECURITY: Upstream fix for "mysql client does not escape strings in 
+    --html mode." (CVE-2008-4456) Closes: #526254
+  * Upstream fixes REPEAT() function. Closes: #447028
+  * Upstream fixes problems when mixing ORDER and GROUP BY. Closes: #470854
+  * There were many innodb fixes in the last two years, probably
+    also for this unreproducible crash. CLoses: #447713
+  * Removed amd64 specific -fPIC compiler option that was introduced
+    especially for building the NDB cluster module which is no longer
+    part of this package (thanks to Modestas Vainius). Closes: #508406
+  * Put /etc/mysql/conf.d to mysql-server-5.1.dirs (thanks to Alexander 
+    Gerasiov). Closes: #515145
+  * Fixed mysql-test suite by adding 50_mysql-test__db_test.dpatch.
+    It now passes 100% of the tests again. Also Closes: #533999
+  * Preinst now prevents Installation if NDB configuration is detected.
+  * Applied Ubuntu patch that fixes privilege bootstrapping in postinst
+    (thanks to Mathias Gug). Closes: #535492
+  * Applied Ubuntu patch that sets the debconf prio for the root password
+    question to high and prevents it from being asked on 5.0 -> 5.1 upgrades
+    (thanks to Mathias Gug). Closes: #535500
+  * Removed the check for ISAM tables as the only supported upgrade path is
+    from lenny's MySQL-5.0.
+  * Added /etc/mysql/conf.d/mysqld_safe_syslog.cnf which enables mysqld_safe
+    to pipe all mysqld output into the syslog. The reason for not letting dpkg
+    handle it via a normal config file change was that my.cnf is usually
+    heavily tuned by the admin so the setting would go lost too easily.
+  * Updated mysqlreport to version 3.5 (including two minor patches by me).
+
+ -- Christian Hammers <ch@debian.org>  Wed, 01 Jul 2009 20:54:58 +0200
+
+mysql-dfsg-5.1 (5.1.34-1) experimental; urgency=low
+
+  * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Mon, 20 Apr 2009 20:23:10 +0200
+
+mysql-dfsg-5.1 (5.1.33-2) experimental; urgency=low
+
+  * Remove no longer active developers from uploaders field.
+  * Drop workaround for upgrades from MySQL 3.23, not necessary any more.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Tue, 07 Apr 2009 11:23:25 +0200
+
+mysql-dfsg-5.1 (5.1.33-1) experimental; urgency=low
+
+  * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Thu, 02 Apr 2009 21:12:23 +0200
+
+mysql-dfsg-5.1 (5.1.32-1) experimental; urgency=low
+
+  * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Fri, 06 Mar 2009 18:48:23 +0100
+
+mysql-dfsg-5.1 (5.1.31-2) experimental; urgency=low
+
+  * Update SSL certificates, and re-enable SSL related tests when running
+    the testsuite.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Tue, 10 Feb 2009 16:08:42 +0100
+
+mysql-dfsg-5.1 (5.1.31-1) experimental; urgency=low
+
+  * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sun, 08 Feb 2009 17:07:11 +0100
+
+mysql-dfsg-5.1 (5.1.30-2) experimental; urgency=low
+
+  * Drop MySQL Cluster support, it's deprecated since 5.1.24-RC.
+  * Fix FTBFS if build twice in a row. (closes: #487091)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Fri, 05 Dec 2008 21:04:55 +0100
+
+mysql-dfsg-5.1 (5.1.30-1) experimental; urgency=low
+
+  * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Thu, 27 Nov 2008 09:09:55 +0100
+
+mysql-dfsg-5.1 (5.1.29rc-1) experimental; urgency=low
+
+  * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Mon, 27 Oct 2008 20:00:43 +0100
+
+mysql-dfsg-5.1 (5.1.26rc-1) experimental; urgency=low
+
+  * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Mon, 14 Jul 2008 21:46:59 +0200
+
+mysql-dfsg-5.1 (5.1.25rc-1) experimental; urgency=low
+
+  * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sat, 21 Jun 2008 13:55:02 +0200
+
+mysql-dfsg-5.1 (5.1.24rc-1) experimental; urgency=low
+
+  * New upstream release.
+  * Ignore errors in testsuite on ia64 and s390.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Wed, 16 Apr 2008 22:03:44 +0200
+
+mysql-dfsg-5.1 (5.1.23rc-1) experimental; urgency=low
+
+  * New upstream release.
+
+  [ Christian Hammers ]
+  * Add PIC support for NDB libraries on amd64 (thanks to Monty Taylor).
+  * Add extra information when aborting due to a detected downgrade (thanks to
+    Raphael Pinson).
+  * Move libndbclient.so.3 to its own package as it now has a version != 0
+    (thanks to Raphael Pinson for reminding me).
+
+  [ Monty Taylor ]
+  * Remove 85_ndb__staticlib.dpatch since we have a libndbclient package now.
+  * Add myself to the uploaders so that I don't get complaints about package
+    signing.
+  * Add libndbclient-dev package to go with libndbclient3.
+
+  [ Norbert Tretkowski ]
+  * Update patches:
+    + 41_scripts__mysql_install_db.sh__no_test.dpatch
+  * Drop patches:
+    + 70_upstream_debian__configure.dpatch
+    + 71_upstream_debian__Makefile.in.dpatch
+    + 99_TEMP_minmax.dpatch
+  * Remove Adam Conrad from uploaders on his request. Thanks for your work in
+    the past!
+  * Ignore errors in testsuite on amd64 and i386.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Fri, 29 Feb 2008 10:38:27 +0100
+
+mysql-dfsg-5.1 (5.1.22rc-1) experimental; urgency=low
+
+  * New upstream version.
+  * Let mysql-server-5.1 pre-depend on debconf as it uses it in the preinst.
+  * Fixed mysql-client-5.1 menu entry for upcoming menu policy 1.4.
+
+ -- Christian Hammers <ch@debian.org>  Tue, 02 Oct 2007 22:45:37 +0200
+
+mysql-dfsg-5.1 (5.1.21beta-1) experimental; urgency=low
+
+  * My "Greetings from FrOSCon!" release.
+  * New upstream version.
+  * libmysqlclient.so.15 has been superseded by libmysqlclient.so.16.
+  * Renamed libmysqlclient15-dev to libmysqlclient-dev but added an empty
+    package libmysqlclient15-dev to ease the transition for packages with
+    a versioned build-dep to libmysqlclient15-dev which is something that
+    currently does not work with "Provides:".
+  * Synced with 5.0 branch up to subversion release r909.
+  * Commented out most of the compile conditionals in the hope that
+    all architectures can be build the same way.
+  * Added a lot of new binaries and manpages.
+  * Switched to plugin based engines.
+
+ -- Christian Hammers <ch@debian.org>  Sat, 25 Aug 2007 14:24:40 +0200
+
+mysql-dfsg-5.1 (5.1.19beta-1) experimental; urgency=low
+
+  * New upstream release.
+
+ -- Christian Hammers <ch@debian.org>  Mon, 11 Jun 2007 23:18:35 +0200
+
+mysql-dfsg-5.1 (5.1.16beta-4) experimental; urgency=high
+
+  * Merged with 5.0 r850:
+    * SECURITY:
+      In some previous versions mysql_install_db was not idempotent and did
+      always create passwordless root accounts although it should only on
+      initial installs (thanks to Olaf van der Spek). Closes: #418672
+    * Added check for passwordless root accounts to debian-start.
+    * As MySQL-5.0 is, at least currently, incompatible with Kernel 2.4 the
+      installation is aborted for such old kernels. Debian Etch does not
+      support them anyway according to the release notes but this might be 
+      unexpected and many production servers still have self build ones 
+      installed (thanks to Marc-Christian Petersen). See: #416841
+    * Adjusted TeX build-deps to texlive.
+    * Added innotop. 
+    * Changed maintainer email address to
+      pkg-mysql-commits@lists.alioth.debian.org 
+
+ -- Christian Hammers <ch@debian.org>  Thu, 19 Apr 2007 19:29:29 +0200
+
+mysql-dfsg-5.1 (5.1.16beta-3) experimental; urgency=low
+
+  * Merged with 5.0 r837:
+    * Activated the blackhole engine as it's needed for replicating partition
+      designs (thanks to Cyril SCETBON). 
+    * Fixed segfault on i486 systems without cpuid instruction (thanks to
+      Lennart Sorensen). Closes: #410474
+    * Only use of the non-essential debconf package in postrm if it is
+      still installed (thanks to Michael Ablassmeier). Closes: #416838
+
+ -- Christian Hammers <ch@debian.org>  Sun, 18 Mar 2007 21:48:11 +0100
+
+mysql-dfsg-5.1 (5.1.16beta-2) experimental; urgency=low
+
+  * Merged with 5.0 r818:
+    * Fixed FTBFS on Sparc introduced with the "make -j" trick in
+      5.0.32-8 (thanks to Frank Lichtenheld). Closes: #415026
+
+ -- Christian Hammers <ch@debian.org>  Sun, 18 Mar 2007 21:20:11 +0100
+
+mysql-dfsg-5.1 (5.1.16beta-1) experimental; urgency=low
+
+  * New upstream release. 
+    * SECURITY: Using an INFORMATION_SCHEMA table with ORDER BY in a subquery
+      could cause a server crash (CVE-2007-1420).
+    * Added temporary patch 90_TEMP_sqlparse-ifdef to avoid build problems.
+  * Merged with 5.0 r809:
+    * Updated mysqlreport to latest upstream (and patched --help usage
+      message and "return if qcache_size==0").
+  * Merged with 5.0 r798:
+    * Adapt MAKE_J to use the -j option with the number of available
+      processors. (thanks to Raphael Pinson).
+  * Merged with 5.0 r758:
+    * Changed minimum required version in dh_makeshlibs to 5.0.27-1 as
+      5.0.26 had an ABI breakage in it!
+      This is the cause for Perl programs crashing with the following error: 
+      Transactions not supported by database at /usr/lib/perl5/DBI.pm line 672
+    * Added some more comments to the default my.cnf.
+    * Added support for /etc/mysql/conf.d/.
+    * The debian-start script that runs on every server start now first upgrades
+      the system tables (if neccessary) and then check them as it sometimes did
+      not work the other way around (e.g. for MediaWiki). The script now uses 
+      mysql_update instead of mysql_update_script as recommended. See: 409780
+
+ -- Christian Hammers <ch@debian.org>  Fri,  2 Mar 2007 01:00:55 +0100
+
+mysql-dfsg-5.1 (5.1.15beta-1) experimental; urgency=low
+
+  * New upstream release.
+  [Monty Taylor]
+  * Removed patches/25_mysys__default.c - fixed upstream.
+  * Removed patches/26_client__mysql_upgrade.c - fixed upstream.
+  * Removed patches/29_scripts__mysqlbug.sh - fixed upstream.
+  * Removed patches/39_scripts__mysqld_safe.sh__port_dir - fixed upstream.
+  * Removed patches/42_scripts__mysqldumpslow__slowdir - fixed upstream.
+  * Removed patches/45_warn-CLI-passwords - fixed upstream.
+  * Removed patches/89_ndb__records.dpatch - fixed upstream.
+  * Removed patches/86_ndbapi_tc_selection.dpatch - fixed upstream.
+  [Christian Hammers]
+  * Synced with 5.0.32-4.
+    * mysql-server-5.0 pre-depends on adduser now and has --disabled-login
+      explicitly added to be on the safe side (thanks to the puiparts team).
+      Closes: #408362
+    * Corrections the terminology regarding NDB in the comments of all config
+      files and init scripts (thanks to Geert Vanderkelen of MySQL).
+
+ -- Christian Hammers <ch@debian.org>  Wed,  7 Feb 2007 11:34:52 -0200
+
+mysql-dfsg-5.1 (5.1.14beta-2) experimental; urgency=low
+
+  [Christian Hammers]
+  * Readded 85_ndb__staticlib.dpatch with slight modifications. 
+  * Backported debian-start scripts from 5.0.
+  [Monty Taylor]
+  * Now build-depends on bison.
+  * Updated to standards 3.7.2.
+  * Removed references to comp_err.
+  * build-depend on automake1.9 to match upstream 
+  * Merged runlevel changes from 5.0.
+  * Added 26_client__mysql_upgrade.c.dpatch to fix a segfault in mysql_upgrade
+    when using a password. It's been fixed upstream in 5.1.15. 
+  * Moved BDB check to sanity_checks() and added a note about deprecation.
+  * Use my_print_defaults instead of mysqld --print-defaults
+  * Changed NDB Data and Management node startup seqence. Prevented both
+    from restarting on upgrade to address rolling upgrade issues.
+  * Added a "start-initial" option to the Data Node init script to support
+    initial node starts.
+  * Added 86_ndbapi_tc_selection.dpatch to fix a bug that causes a segfault
+    when using the NdbApi. http://bugs.mysql.com/bug.php?id=24914
+    Fixed in 5.1.15
+  * Added 89_ndb__records.dpatch to fix
+    http://bugs.mysql.com/bug.php?id=25567, which causes a table scan per
+    table per query.
+
+ -- Christian Hammers <ch@debian.org>  Wed, 31 Jan 2007 01:17:35 +0100
+
+mysql-dfsg-5.1 (5.1.14beta-1) experimental; urgency=low
+
+  * New upstream.
+  * Removed references to mysql_explain_log
+  * Changed context for patch to mysqld_multi.1
+  * Removed 70_kfreebsd.dpatch - applied to upstream
+  * Removed 87_ps_Hurd - applied to upstream
+  * Replaced --without-readline to --with-libedit to configure options, as
+    --without-readline doesn't seem to do the right thing anymore.
+
+ -- Monty Taylor <mordred@inaugust.com>  Wed, 10 Jan 2007 12:59:55 -0800
+
+mysql-dfsg-5.1 (5.1.11beta-1) experimental; urgency=low
+
+  * Starting new 5.1 branch!
+  * FIXME: Following patch couldn't be applied:
+      ## 85_ndb__staticlib.dpatch by  <ch@debian.org>
+  * FIXME: Following patch couldn't be applied:
+      ## 86_PATH_MAX.dpatch
+
+ -- Christian Hammers <ch@debian.org>  Sat, 29 Jul 2006 11:35:42 +0200
+
+mysql-dfsg-5.0 (5.0.84-1) unstable; urgency=low
+
+  * New upstream release.
+  * Update patches:
+    + debian/patches/60_disabled_tests.dpatch
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Fri, 24 Jul 2009 18:05:11 +0200
+
+mysql-dfsg-5.0 (5.0.83-1) unstable; urgency=low
+
+  * New upstream release.
+  * Update patches:
+    + debian/patches/45_warn-CLI-passwords.dpatch (closes: #536548)
+    + debian/patches/60_disabled_tests.dpatch
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sat, 18 Jul 2009 08:18:53 +0200
+
+mysql-dfsg-5.0 (5.0.81-1) unstable; urgency=low
+
+  * New upstream release.
+  * Remove patches:
+    + debian/patches/63_update_ssl_certs.dpatch
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Mon, 04 May 2009 18:53:05 +0200
+
+mysql-dfsg-5.0 (5.0.77-1) unstable; urgency=low
+
+  * New upstream release.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Tue, 17 Feb 2009 18:42:46 +0100
+
+mysql-dfsg-5.0 (5.0.75-1) unstable; urgency=low
+
+  * New upstream release.
+  * Update patches:
+    + debian/patches/33_scripts__mysql_create_system_tables__no_test.dpatch
+  * Remove patches:
+    + debian/patches/50_fix_agg_functions.dpatch
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Mon, 22 Dec 2008 11:01:38 +0100
+
+mysql-dfsg-5.0 (5.0.67-3) unstable; urgency=low
+
+  * Really apply patch from 5.0.74 to fix check for non-aggregated columns
+    in queries.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Tue, 16 Dec 2008 07:19:23 +0100
+
+mysql-dfsg-5.0 (5.0.67-2) unstable; urgency=low
+
+  * New patch from 5.0.74 to fix check for non-aggregated columns in queries.
+    (closes: #505179, #505181)
+  * Add patch from Dan Munckton:
+    + Clearly indicate that we do not support running multiple instances
+      of mysqld by duplicating the init script.
+      (closes: #314785, #324834, #435165, #444216)
+    + Properly parameterize all existing references to the mysql config
+      file (/etc/mysql/my.cnf).
+  * Really fix FTBFS if build twice in a row. (closes: #442684)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sun, 14 Dec 2008 10:12:30 +0100
+
+mysql-dfsg-5.0 (5.0.67-1) unstable; urgency=low
+
+  * New upstream release.
+  * Update patches:
+    + debian/patches/25_mysys__default.c.dpatch
+    + debian/patches/80_fix_user_setup_on_localhost.dpatch
+  * Remove patches:
+    + debian/patches/50_fix_mysqldump.dpatch
+    + debian/patches/51_incorrect-order.dpatch
+    + debian/patches/52_ndb-gcc-4.2.dpatch
+    + debian/patches/53_integer-gcc-4.2.dpatch
+    + debian/patches/54_ssl-client-support.dpatch
+    + debian/patches/55_testsuite-2008.dpatch
+    + debian/patches/56_fix_order_by.dpatch
+    + debian/patches/57_fix_mysql_replication.dpatch
+    + debian/patches/58_disable-ndb-backup-print.dpatch
+    + debian/patches/59_fix_relay_logs_corruption.dpatch
+    + debian/patches/60_rpl_test_failure.dpatch
+    + debian/patches/90_upstreamdebiandir.dpatch
+    + debian/patches/91_SECURITY_CVE-2007-5925.dpatch
+    + debian/patches/92_SECURITY_CVE-2008-2079.dpatch
+    + debian/patches/93_SECURITY_CVE-2008-3963.dpatch
+  * Fix FTBFS if build twice in a row. (closes: #442684)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sun, 02 Nov 2008 13:51:50 +0100
+
+mysql-dfsg-5.0 (5.0.51a-24) testing-proposed-updates; urgency=low
+
+  * Update SSL certificates, and re-enable SSL related tests when running
+    the testsuite.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Tue, 03 Feb 2009 15:40:47 +0100
+
+mysql-dfsg-5.0 (5.0.51a-23) testing-proposed-updates; urgency=medium
+
+  * Reset debconf password variable root_password_again immediately after
+    using it. (closes: #513262)
+  * Disable SSL related tests when running the testsuite until MySQL bug
+    #42366 gets fixed.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Thu, 29 Jan 2009 14:07:32 +0100
+
+mysql-dfsg-5.0 (5.0.51a-22) testing-proposed-updates; urgency=low
+
+  * New patch 10_mysql_secure_installation.dpatch to fix failure on passwords
+    which need quoting. (closes: #511929)
+  * New patch 62_delete_with_self-join.dpatch from 5.0.54 to fix MyISAM
+    storage engine error (134) doing delete with self-join. (closes: #512651)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sun, 25 Jan 2009 10:02:35 +0100
+
+mysql-dfsg-5.0 (5.0.51a-21) testing-proposed-updates; urgency=low
+
+  * Ask for MySQL root password at high priority, because otherwise all
+    default installations will miss this question, thanks to Thijs Kinkhorst
+    for the patch. (closes: #510875)
+  * Do not fail checking tables when using sql-mode ansi-quotes, thanks to
+    Renato Alves for the patch. (closes: #507049)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Fri, 09 Jan 2009 10:24:23 +0100
+
+mysql-dfsg-5.0 (5.0.51a-20) testing-proposed-updates; urgency=low
+
+  * New patch 60_fix_leap_seconds.dpatch from 5.0.74 to return leap second
+    values with a time part that ends with :59:59. (closes: #510177)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Tue, 30 Dec 2008 10:32:46 +0100
+
+mysql-dfsg-5.0 (5.0.51a-19) testing-proposed-updates; urgency=low
+
+  * New patch 50_fix_mysqldump2.dpatch from 5.0.60 to fix dumping databases
+    from mysql 4.0 server. (closes: #507789)
+  * Do not create a guest account during bootstrap. (closes: #463704)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Thu, 04 Dec 2008 23:07:19 +0100
+
+mysql-dfsg-5.0 (5.0.51a-18) testing-proposed-updates; urgency=high
+
+  * SECURITY:
+    Fix for CVE-2008-4098: Inadequate validation of paths used in DATA
+    DIRECTORY and INDEX DIRECTORY clauses of CREATE TABLE statements enabled
+    attackers to write to tables in other databases to which they could not
+    ordinarily have access.
+
+ -- Devin Carraway <devin@debian.org>  Tue, 25 Nov 2008 05:38:45 +0000
+
+mysql-dfsg-5.0 (5.0.51a-17) testing-proposed-updates; urgency=low
+
+  * Don't use commented out passwords from debian.cnf. (closes: #453820)
+  * Update watch file to recognize releases > 5.0.45.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sun, 02 Nov 2008 13:31:32 +0100
+
+mysql-dfsg-5.0 (5.0.51a-16) unstable; urgency=low
+
+  * New patch 60_rpl_test_failure.dpatch from 5.0.54 to fix a race condition
+    with the rpl_packet test in some cases. (closes: #501413)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Thu, 09 Oct 2008 08:50:43 +0200
+
+mysql-dfsg-5.0 (5.0.51a-15) unstable; urgency=high
+
+  * SECURITY:
+    Fix for CVE-2008-3963: An empty bit-string literal (b'') caused a server
+    crash. Now the value is parsed as an empty bit value (which is treated as
+    an empty string in string context or 0 in numeric context).
+    (closes: #498362)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sun, 14 Sep 2008 18:27:46 +0200
+
+mysql-dfsg-5.0 (5.0.51a-14) unstable; urgency=low
+
+  * Update debconf translations:
+    - Swedish, from Martin Bagge. (closes: #491688)
+    - Netherlands, from Thijs Kinkhorst. (closes: #492723)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sun, 07 Sep 2008 20:18:31 +0200
+
+mysql-dfsg-5.0 (5.0.51a-13) unstable; urgency=medium
+
+  * New patch 59_fix_relay_logs_corruption.dpatch from 5.0.56 to fix
+    corruption in relay logs. (closes: #463515)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Wed, 03 Sep 2008 09:13:46 +0200
+
+mysql-dfsg-5.0 (5.0.51a-12) unstable; urgency=low
+
+  * Disable rpl_ndb_innodb_trans test when running the testsuite, fails
+    randomly on i386. (closes: #494238)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sat, 09 Aug 2008 15:56:45 +0200
+
+mysql-dfsg-5.0 (5.0.51a-11) unstable; urgency=low
+
+  * Disable innodb_handler test when running the testsuite, fails randomly
+    on s390. (closes: #491363)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Wed, 23 Jul 2008 08:34:51 +0200
+
+mysql-dfsg-5.0 (5.0.51a-10) unstable; urgency=high
+
+  * Merge testing-security upload to finally fix CVE-2008-2079, thanks to
+    Devin Carraway and Steffen Joeris. (closes: #480292)
+  * New patch 58_disable-ndb-backup-print.dpatch from 5.0.54 to disable
+    ndb_backup_print, ndb_alter_table and ndb_replace tests when running the
+    testsuite. (closes: #474893)
+  * Reenable error handling in testsuite on i386, disabling it was just a
+    workaround for the problem which is now fixed with the above patch.
+  * Update debconf translations:
+    - Vietnamese, from Clytie Siddall. (closes: #486443)
+    - Spanish, from Javier Fernndez-Sanguino Pea. (closes: #488740)
+    - Slovak, from helix84. (closes: #489266)
+  * Make lintian happy:
+    - Fix build-dependency on -1 revision.
+    - Fix deprecated chown usage.
+    - Fix spelling error in description.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Tue, 15 Jul 2008 19:37:35 +0200
+
+mysql-dfsg-5.0 (5.0.51a-9+lenny2) testing-security; urgency=high
+
+  * Non-maintainer upload by the security team.
+  * Correct error number in symlink.test to avoid FTBFS on some archs.
+
+ -- Steffen Joeris <white@debian.org>  Sun, 13 Jul 2008 11:44:57 +0000
+
+mysql-dfsg-5.0 (5.0.51a-9+lenny1) testing-security; urgency=high
+
+  * Non-maintainer upload by the security team.
+  * Correct and expand 92_SECURITY_CVE-2008-2079.dpatch to cover all symlinks
+    and check the output of fn_format(). (closes: #480292)
+    Fixes: CVE-2008-2079
+
+ -- Steffen Joeris <white@debian.org>  Sat, 12 Jul 2008 05:30:39 +0000
+
+mysql-dfsg-5.0 (5.0.51a-9) unstable; urgency=low
+
+  * Ignore errors in testsuite on i386. (workaround for #474893)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Wed, 25 Jun 2008 15:07:03 +0200
+
+mysql-dfsg-5.0 (5.0.51a-8) unstable; urgency=low
+
+  * New patch 80_fix_user_setup_on_localhost.dpatch from Daniel Hahler to fix
+    a duplicate key error when install MySQL server on a host with hostname
+    localhost. (closes: #478319)
+  * Really fix build on non-linux systems, this time without producing a build
+    error on some architectures. (closes: #485971)
+  * Update debconf translations:
+    - French, from Christian Perrier. (closes: #478553)
+    - German, from Alwin Meschede. (closes: #478672)
+    - Italian, from Luca Monducci. (closes: #479363)
+    - Czech, from Miroslav Kure. (closes: #480924)
+    - Galician, from Jacobo Tarrio. (closes: #480965)
+    - Basque, from Piarres Beobide. (closes: #481840)
+    - Swedish, from Martin Bagge. (closes: #482466, #486307)
+    - Turkish, from Mert Dirik. (closes: #484704)
+    - Russian, from Yuri Kozlov. (closes: #486149)
+    - Finnish, from Esko Arajrvi. (closes: #486554)
+    - Portuguese, from Miguel Figueiredo. (closes: #486709)
+    - Romanian, from Eddy Petrior. (closes: #486944)
+    - Japanese, from Hideki Yamane. (closes: #487270)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sat, 21 Jun 2008 19:20:48 +0200
+
+mysql-dfsg-5.0 (5.0.51a-7) unstable; urgency=high
+
+  [ Norbert Tretkowski ]
+  * SECURITY:
+    Fix for CVE-2008-2079: It was possible to circumvent privileges through
+    the creation of MyISAM tables employing the DATA DIRECTORY and INDEX
+    DIRECTORY options to overwrite existing table files in the MySQL data
+    directory. Use of the MySQL data directory in DATA DIRECTORY and INDEX
+    DIRECTORY is now disallowed. Patch from openSUSE 11.0, thanks to Michal
+    Marek. (closes: #480292)
+  * Fix build on non-linux systems, like hurd-i386. (closes: #480362)
+  * Include symlinks for mysqlcheck. (closes: #480647)
+
+  [ Monty Taylor ]
+  * Remove ndb_cpcd, as it is only for the NDB test suite and not useful as a
+    public program.
+  * Fix debian-start.inc.sh for table names with characters needing quotes.
+    Thanks Felix Rublack! (closes: #480525, #481154, #481303, #484012) 
+  * Delete mysql-common.README.Debian. Nothing in it was relevant, and the
+    useful information is in mysql-server anyway. (closes: #480940)
+  * Remove a spurious HOME= in logrotate script.  
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Thu, 05 Jun 2008 11:49:45 +0200
+
+mysql-dfsg-5.0 (5.0.51a-6) unstable; urgency=low
+
+  * Fix debian-start.inc.sh to not print the row counts of the tables
+    queried. (closes: #478256, #479697)
+
+ -- Monty Taylor <mordred@inaugust.com>  Wed, 14 May 2008 00:47:46 -0700
+
+mysql-dfsg-5.0 (5.0.51a-5) unstable; urgency=medium
+
+  * New patch 57_fix_mysql_replication.dpatch from 5.0.54 to fix directory for
+    relay logs when using replication.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sun, 27 Apr 2008 13:55:04 +0200
+
+mysql-dfsg-5.0 (5.0.51a-4) unstable; urgency=low
+
+  [ Monty Taylor ]
+  * Remove build of ndb docs, since they are not installed. Removed build deps
+    on TeX and doxygen since that's all they were there for.
+  * Replace script in check_for_crashed_tables with a myisam-recover option
+    and a script to trigger a check of those tables. (thanks HarrisonF and
+    kolbe)
+  * Replace direct calls to test suite with calls to the make targets used by
+    the MySQL build and qa teams for releases.
+  * Add --skip-ndbcluster to the postinst bootstrap command. It's really a
+    workaround for a bug in 5.1, but it's probably a good idea anyway since we
+    certainly don't need cluster to spin up, and if people have enabled
+    cluster in their my.cnf file, there could be postinst issues if cluster
+    isn't running.
+  * Remove reference to configure options that no longer exist.
+  * Add myself to uploaders.
+
+  [ Norbert Tretkowski ]
+  * New patch 56_fix_order_by.dpatch from Ubuntu to fix ORDER BY not working
+    with GROUP BY. (closes: #471737)
+  * Add note about filename extensions in the /etc/mysql/conf.d/ directory in
+    my.cnf. (closes: #461759)
+  * Confirm password on install, patch from Nicolas Valcrcel.
+    (closes: #471887)
+  * Remove Adam Conrad from uploaders on his request. Thanks for your work in
+    the past!
+  * Use lsb_release to detect distribution.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sat, 05 Apr 2008 21:51:43 +0200
+
+mysql-dfsg-5.0 (5.0.51a-3) unstable; urgency=low
+
+  * Disable patch 60_raise-max-keylength.dpatch in default build, but still
+    ship it in the source package.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sun, 17 Feb 2008 18:54:42 +0100
+
+mysql-dfsg-5.0 (5.0.51a-2) unstable; urgency=low
+
+  * Replace 54_ssl-client-support.dpatch added in 5.0.51-2 with patch from
+    upstream.
+  * Ignore errors in testsuite on powerpc.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sun, 17 Feb 2008 12:42:58 +0100
+
+mysql-dfsg-5.0 (5.0.51a-1) unstable; urgency=low
+
+  [ Norbert Tretkowski ]
+  * New upstream security hotfix release. Low priority upload anyway because
+    5.0.51-3 already contained all security fixes.
+  * Remove patches:
+    + debian/patches/51_mysqlcheck-result.dpatch
+    + debian/patches/92_SECURITY_CVE-2007-6303.dpatch
+    + debian/patches/93_SECURITY_CVE-2007-6304.dpatch
+    + debian/patches/94_SECURITY_CVE-2008-0226+0227.dpatch
+  * Add recommendation on libhtml-template-perl to -server package, used by
+    ndb_size. (closes: #462265)
+  * New patch 60_raise-max-keylength.dpatch to raise the maximum key length to
+    4005 bytes or 1335 UTF-8 characters. (closes: #463137)
+  * New patch 51_sort-order.dpatch from 5.0.52 to fix incorrect order when
+    using range conditions on 2 tables or more.
+  * Support DEB_BUILD_OPTIONS option 'nocheck' to skip tests.
+  * Update mysqlreport to 3.4a release.
+
+  [ Luk Claes ]
+  * Updated Japanese debconf translation. (closes: #462158)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Wed, 06 Feb 2008 11:57:45 +0100
+
+mysql-dfsg-5.0 (5.0.51-3) unstable; urgency=high
+
+  * SECURITY:
+    Fix for CVE-2008-0226 and CVE-2008-0227: Three vulnerabilities in yaSSL
+    versions 1.7.5 and earlier were discovered that could lead to a server
+    crash or execution of unauthorized code. The exploit requires a server
+    with yaSSL enabled and TCP/IP connections enabled, but does not require
+    valid MySQL account credentials. The exploit does not apply to OpenSSL.
+    (closes: #460873)
+  * Fix LSB header in init scripts (patch from Petter Reinholdtsen).
+    (closes: #458798)
+  * Run testsuite on all archs, but ignore errors on alpha, arm, armel, hppa,
+    mipsel and sparc. (closes: #460402)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Wed, 23 Jan 2008 11:37:11 +0100
+
+mysql-dfsg-5.0 (5.0.51-2) unstable; urgency=low
+
+  [ Monty Taylor ]
+  * Added --with-system-type to set the version_compile_os field.
+  * Cleaned up some lintian warnings.
+  * Removed 43_scripts__mysql_update__password.dpatch since we don't use
+    mysql_upgrade_shell anymore and use mysql_upgrade instead.
+  * Removed 88_mctype_attrib.dpatch, http://bugs.mysql.com/bug.php?id=25118 is
+    closed with http://lists.mysql.com/commits/24337
+  * Added mysql-community/mysql-enterprise virtual packages in provides and
+    conflicts to ease transitions between versions.
+
+  [ Norbert Tretkowski ]
+  * Add -fPIC to CFLAGS to allow other packages to be built against
+    libmysqld.a on amd64. (closes: #457915)
+  * New patch 55_testsuite-2008.dpatch to fix FTBFS in testsuite.
+    (closes: #458695)
+  * New patch 54_ssl-client-support.dpatch to fix SSL client support.
+  * Don't run testsuite on alpha, arm, hppa, mipsel and sparc.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Wed, 02 Jan 2008 18:40:04 +0100
+
+mysql-dfsg-5.0 (5.0.51-1) unstable; urgency=low
+
+  * New upstream release.
+    + Fix a crash in mysql_client_test due to gcc 4.x optimizations.
+      (closes: #452558)
+  * Update patches:
+    + debian/patches/41_scripts__mysql_install_db.sh__no_test.dpatch
+    + debian/patches/89_ndb__staticlib.dpatch
+  * Run testsuite after build.
+  * Re-add manpages, they are licensed under GPL now and redistribution is
+    permitted.
+  * Drop linux-libc-dev build-dependency, it's now being pulled by libc-dev
+    which is build-essential. (closes: #431018)
+  * Remove old optimizations for MySQL 3.23.x, they are no longer required.
+    (closes: #436552)
+  * Don't fail when upgrading mysql-common if $datadir is empty or not defined
+    (patch from Edward Allcutt). (closes: #453127)
+  * New patch from 5.0.52 to fix mysqldump because 'null' is shown as type of
+    fields for view with bad definer. (closes: #454227)
+  * New patch from 5.0.52 to fix mysqlcheck test result.
+  * New patch from 5.0.52 to fix wrong optimization in ndb code when building
+    with gcc 4.2.x.
+  * New patch from 5.0.54 to fix wrong number output due to integer overflow
+    when building with gcc 4.2.x.
+  * New Finnish debconf translation from Esko Arajrvi. (closes: #448776)
+  * Update Basque debconf translation from Aitor Ibaez. (closes: #456193)
+  * Add Vcs-* and Homepage fields to source stanza in control file.
+  * Update mysqlreport to 3.2 release.
+  * Let mysql-server-5.0 pre-depend on debconf, because it's preinst is using
+    it.
+  * Drop menu item for innotop.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Fri, 14 Dec 2007 09:59:36 +0100
+
+mysql-dfsg-5.0 (5.0.45-5) unstable; urgency=high
+
+  * SECURITY:
+    Fix for CVE-2007-6303: ALTER VIEW retained the original DEFINER value,
+    even when altered by another user, which could allow that user to gain the
+    access rights of the view. Now ALTER VIEW is allowed only to the original
+    definer or users with the SUPER privilege. (closes: #455737)
+  * SECURITY:
+    Fix for CVE-2007-6304: When using a FEDERATED table, the local server can
+    be forced to crash if the remote server returns a result with fewer columns
+    than expected.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Wed, 12 Dec 2007 20:23:43 +0100
+
+mysql-dfsg-5.0 (5.0.45-4) unstable; urgency=high
+
+  * SECURITY:
+    Fix for CVE-2007-5969: Using RENAME TABLE against a table with explicit
+    DATA DIRECTORY and INDEX DIRECTORY options can be used to overwrite system
+    table information by replacing the file to which the symlink points.
+    (closes: #455010)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sun, 09 Dec 2007 12:29:54 +0100
+
+mysql-dfsg-5.0 (5.0.45-3) unstable; urgency=high
+
+  * SECURITY:
+    Fix for CVE-2007-5925: The convert_search_mode_to_innobase function in
+    ha_innodb.cc in the InnoDB engine in MySQL 5.1.23-BK and earlier allows
+    remote authenticated users to cause a denial of service (database crash)
+    via a certain CONTAINS operation on an indexed column, which triggers an
+    assertion error. (closes: #451235)
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Thu, 15 Nov 2007 18:40:11 +0100
+
+mysql-dfsg-5.0 (5.0.45-2) unstable; urgency=low
+
+  * Package is now team-maintained. (closes: #421026)
+
+  [ Sean Finney ]
+  * New/updated debconf translations:
+    - Spanish, from Javier Fernndez-Sanguino Pea (closes: #426442).
+    - German, from Alwin Meschede (closes: #426545).
+    - Danish, from Claus Hindsgaul (closes: #426783).
+    - French, from Christian Perrier (closes: #430944).
+  * Add Recommends on libterm-readkey-perl for mysql-client-5.0 package, used
+    by mysqlreport add-on to mask password entry (closes: #438375).
+
+  [ Norbert Tretkowski ]
+  * Add myself to uploaders.
+  * Suggest usage of an update statement on the user table to change the mysql
+    root user password instead using mysqladmin, to catch all root users from
+    all hosts. (closes: #435744)
+  * Remove informations about a crash in the server during flush-logs when
+    having expire_logs_days enabled but log-bin not, this bug was fixed in
+    5.0.32 already. (closes: #368547)
+  * Disable log_bin option in default config file and add a note to the NEWS
+    file. (closes: #349661)
+  * Fix FTBFS if build twice in a row. (closes: #442684)
+  * Remove check for buggy options from init script.
+  * Update innotop to 1.6.0 release.
+  * Add mysqlreport and innotop to mysql-client description.
+  * Use shorter server version string.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Wed, 14 Nov 2007 20:00:06 +0100
+
+mysql-dfsg-5.0 (5.0.45-1) unstable; urgency=low
+
+  * New upstream release.
+
+  [sean finney]
+  * removed patches that are incorporated into the latest release:
+    - 70_cpuid_on_i486.dpatch
+    - 91_SECURITY_CVE-2007-2691_alter-drop
+  * new patch 90_upstreamdebiandir.dpatch to keep a few lingering references
+    to the upstream ./debian dir out of the build, at least until we find
+    a nice way to collaborate on sharing the directory.
+  * updated CRUFT list to fix double-build breakage (closes: #424590).
+  * add conditional build-deps for linux-libc-dev to fix FTBFS for
+    non-linux arch's (closes: #431018).
+  * added notes to my.cnf and README.Debian about setting tmpdir when
+    configuring a replication slave.  thanks to Rudy Gevaert for pointing
+    this out (closes: #431825).
+
+ -- sean finney <seanius@debian.org>  Tue, 17 Jul 2007 23:50:33 +0200
+
+mysql-dfsg-5.0 (5.0.41a-1) unstable; urgency=high
+
+  [sean finney]
+  * SECURITY:
+    Fix for CVE-2007-2691: DROP/RENAME TABLE statements (closes: #424778).
+  [Christian Hammers]
+  * Removed all manpages from the source (therefore the "41a") as they 
+    are not licensed under the GPL and redistribution is not permitted
+    (thanks to Mathias Gug). Closes: #430018
+  * Added linux-libc-dev to the build-depends as else an illegal dependency to
+    asm/atomic.h is generated in /usr/include/mysql/my_global.h. Closes: 424276
+  [Christian Perrier]
+  * Debconf templates and debian/control reviewed by the debian-l10n-
+    english team as part of the Smith review project. Closes: #419974
+  * Debconf translation updates:
+    - French. Closes: #422187
+    - Galician. Closes: #420118
+    - Italian. Closes: #421349
+    - Brazilian Portuguese. Closes: #421516
+    - Arabic. Closes: #421751
+    - Czech. Closes: #421766
+    - Portuguese. Closes: #422428
+
+ -- Christian Hammers <ch@debian.org>  Sun, 24 Jun 2007 21:12:42 +0200
+
+mysql-dfsg-5.0 (5.0.41-2) unstable; urgency=low
+
+  * the previous "translation changes" inadvertently introduced unrelated
+    changes in the package control file.
+
+ -- sean finney <seanius@debian.org>  Sun, 13 May 2007 12:32:45 +0200
+
+mysql-dfsg-5.0 (5.0.41-1) unstable; urgency=low
+
+  * New upstream release
+  [sean finney]
+  * Bump the priority of the debconf prompt for the root password to high, to 
+    ensure the question shows up in a default installation (closes: #418672).
+  * Debconf templates and debian/control reviewed by the debian-l10n-
+    english team as part of the Smith review project. Closes: #419974
+  * Debconf translation updates:
+    - French. Closes: #422187
+    - Galician. Closes: #420118
+    - Italian. Closes: #421349
+    - Brazilian Portuguese. Closes: #421516
+    - Arabic. Closes: #421751
+    - Czech. Closes: #421766
+    - Portuguese. Closes: #422428
+  * massaged the local PATH_MAX patch.
+  * removed temp sql parsing patch which has been incorporated upstream
+  * upstream no longer includes the mysql_create_system_tables command,
+    so removed our local patches for it.
+  * the following issues may have been fixed in a previous version of
+    mysql-server-5.0, but the exact version is not clear so they will be
+    marked as fixed in this version. 
+  * lots of NDB-related fixes, including those related to problems with
+    AUTO_INCREMENT (closes: #310878).
+  * fix for "connections remaining in sleep state" (closes: #318011).
+  * fix for "denies queries randomly" (closes: #399602).
+  * problems indexing on char() binary fields were ISAM specific, which is
+    no longer supported (closes: #326698).
+  * fix for problems with "complicated joins" (closes: 348682).
+  * fix for problems with "flushing logs, server crash" (closes: #348682).
+  * fix for AUTO_INCREMENT and duplicate keys (closes: #416145).
+  * fix for "DROP FUNCTIONS doesn't work" (closes: #290670).
+
+ -- sean finney <seanius@debian.org>  Sat, 12 May 2007 12:10:20 +0200
+
+mysql-dfsg-5.0 (5.0.38-3) unstable; urgency=low
+
+  * Added innotop. 
+  * Changed maintainer email address to
+    pkg-mysql-commits@lists.alioth.debian.org 
+
+ -- Christian Hammers <ch@debian.org>  Thu, 19 Apr 2007 19:21:15 +0200
+
+mysql-dfsg-5.0 (5.0.38-2) unstable; urgency=high
+
+  * SECURITY:
+    In some previous versions mysql_install_db was not idempotent and did
+    always create passwordless root accounts although it should only on
+    initial installs (thanks to Olaf van der Spek). Closes: #418672
+  * Added check for passwordless root accounts to debian-start.
+  * As MySQL-5.0 is, at least currently, incompatible with Kernel 2.4 the
+    installation is aborted for such old kernels. Debian Etch does not support
+    them anyway according to the release notes but this might be unexpected
+    and many production servers still have self build ones installed (thanks
+    to Marc-Christian Petersen). See: #416841
+  * Adjusted TeX build-deps to texlive.
+
+ -- Christian Hammers <ch@debian.org>  Tue, 17 Apr 2007 01:00:41 +0200
+
+mysql-dfsg-5.0 (5.0.38-1) unstable; urgency=low
+
+  * New upstream release.
+  * Activated the blackhole engine as it's needed for replicating partition
+    designs (thanks to Cyril SCETBON). 
+  * Fixed segfault on i486 systems without cpuid instruction (thanks to
+    Lennart Sorensen). Closes: #410474
+  * Only use of the non-essential debconf package in postrm if it is still
+    installed (thanks to Michael Ablassmeier). Closes: #416838
+
+ -- Christian Hammers <ch@debian.org>  Thu,  5 Apr 2007 22:43:41 +0200
+
+mysql-dfsg-5.0 (5.0.36-1) unstable; urgency=low
+
+  * New upstream release.
+    Closes: #400460, #408159, #408533
+
+ -- Christian Hammers <ch@debian.org>  Thu, 22 Mar 2007 22:16:31 +0100
+
+mysql-dfsg-5.0 (5.0.32-10) unstable; urgency=high
+
+  * Really fixed FTBFS on Sparc introduced with the "make -j" trick in 
+    5.0.32-8 (thanks to Frank Lichtenheld). Closes: #415026
+
+ -- Christian Hammers <ch@debian.org>  Sun, 18 Mar 2007 20:52:33 +0100
+
+mysql-dfsg-5.0 (5.0.32-9) unstable; urgency=high
+
+  * Fixed FTBFS on Sparc introduced with the "make -j" trick in 5.0.32-8
+    (thanks to Frank Lichtenheld). Closes: #415026
+
+ -- Christian Hammers <ch@debian.org>  Tue, 15 Mar 2007 18:55:42 +0100
+
+mysql-dfsg-5.0 (5.0.32-8) unstable; urgency=high
+
+  [Sean Finney]
+  * SECURITY:
+    - CVE-2007-1420: Single Row Subselect DoS.  Specially crafted subselect
+      queries could crash the mysql server.  Patch backported from upstream
+      changeset 19685 (46_CVE-2007-1420_subselect_dos.dpatch) 
+      closes: #414790.
+  [Christian Hammers]
+  * Adapt MAKE_J to use the -j option with the number of available processors.
+    (thanks to Raphael Pinson).
+  * Updated mysqlreport to latest upstream (and patched --help usage message
+    and "return if qcache_size==0").
+
+ -- sean finney <seanius@debian.org>  Wed, 14 Mar 2007 20:19:08 +0100
+
+mysql-dfsg-5.0 (5.0.32-7) unstable; urgency=low
+
+  * Updated French Debconf translation (thanks to Christian Perrier).
+    Closes: #411330
+  * Updated Danish Debconf translation (thanks to Claus Hindsgaul).
+    Closes: #411328
+  * Updated Portuguese Debconf translation (thanks to "Traduz").
+    Closes: #411339
+  * Updated Czech Debconf translation (thanks to Miroslav Kure).
+    Closes: #411341
+  * Added Norwegian Debconf translation (thanks to Bjorn Steensrud).
+    Closes: #411345
+  * Updated Spanish Debconf translation (thanks to Javier Fernandez-Sanguino
+    Pena). Closes: #411347
+  * Updated Japanese Debconf translation (thanks to Hideki Yamane).
+    Closes: #411368
+  * Updated Swedish Debconf translation (thanks to Andreas Henriksson).
+    Closes: #411370
+  * Updated Italian Debconf translation (thanks to Luca Monducci).
+    Closes: #411377
+  * Updated Galician Debconf translation (thanks to Jacobo Tarrio).
+    Closes: #411379
+  * Updated Russian Debconf translation (thanks to Yuriy Talakan).
+    Closes: #411442
+  * Updated Basque Debconf translation (thanks to Piarres Beobide).
+    Closes: #411457
+  * Updated German Debconf translation (thanks to Alwin Meschede).
+    Closes: #411480
+  * Updated Dutch Debconf translation (thanks to Thijs Kinkhorst).
+  * Updated Brazilian Portuguese translation (thanks to Andre Luis Lopes).
+    Closes: #411536
+  * Updated Romanian Debconf translation (thanks to Stan Ioan-Eugen). 
+    Closes: #411764
+
+ -- Christian Hammers <ch@debian.org>  Fri, 16 Feb 2007 23:20:42 +0100
+
+mysql-dfsg-5.0 (5.0.32-6) unstable; urgency=low
+
+  * Changed wording in Debconf templates to better fit to the graphical
+    interface (thanks to Frank Kuester). Closes: #411165
+  * Lintian suggested style changes to some other Debconf questions.
+  * Removed accidently stdout output from init script.
+
+ -- Christian Hammers <ch@debian.org>  Fri, 16 Feb 2007 20:29:18 +0100
+
+mysql-dfsg-5.0 (5.0.32-5) unstable; urgency=medium
+
+  * Backported upstream patch for a bug that crashed the server when using
+    certain join/group/limit combinations. 
+    Users of the Joomla CMS seemed to be affected by this. Closes: #403721
+  * The debian-start script that runs on every server start now first upgrades
+    the system tables (if neccessary) and then check them as it sometimes did
+    not work the other way around (e.g. for MediaWiki). The script now uses 
+    mysql_update instead of mysql_update_script as recommended. Closes: 409780
+  * Remove the Debconf generated config file in postrm.
+
+ -- Christian Hammers <ch@debian.org>  Thu, 15 Feb 2007 04:47:04 +0100
+
+mysql-dfsg-5.0 (5.0.32-4) unstable; urgency=high
+
+  [Christian Hammers]
+  * Changed minimum required version in dh_makeshlibs to 5.0.27-1 as
+    5.0.26 had an ABI breakage in it!
+    This is the cause for Perl programs crashing with the following error: 
+    "Transactions not supported by database at /usr/lib/perl5/DBI.pm line 672"
+  * The old_passwords setting that is set according to a Debconf question is
+    now written to /etc/mysql/conf.d/old_passwords.cnf instead directly to the
+    conffile /etc/mysql/my.cnf which would be fobidden by policy (thanks to
+    Robert Bihlmeyer). Closes: #409750
+  * Added some more comments to the default my.cnf.
+  [Monty Taylor]
+  * Added bison to build dependencies.
+  * Added a "start-initial" option to the Data Node init script to support
+    initial node starts.
+  * Changed NDB Data and Management node startup seqence. Prevented both from
+    restarting on upgrade to address rolling upgrade issues.
+  * Updated build-depends to depend on automake1.9 instead of automake1.8
+    to match what upstream uses. 
+
+ -- Christian Hammers <ch@debian.org>  Wed, 31 Jan 2007 01:14:09 +0100
+
+mysql-dfsg-5.0 (5.0.32-3) unstable; urgency=high
+
+  * mysql-server-5.0 pre-depends on adduser now and has --disabled-login
+    explicitly added to be on the safe side (thanks to the puiparts team).
+    Closes: #408362
+  * Corrections the terminology regarding NDB in the comments of all config
+    files and init scripts (thanks to Geert Vanderkelen of MySQL).
+  * Updated Swedish Debconf translation (thanks to Andreas Henriksson).
+    Closes: #407859
+  * Updated Czech Debconf translation (thanks to Miroslav Kure).
+    Closes: #407809
+
+ -- Christian Hammers <ch@debian.org>  Thu, 11 Jan 2007 11:18:47 +0100
+
+mysql-dfsg-5.0 (5.0.32-2) unstable; urgency=high
+
+  * The last upload suffered from a regression that made NDB totally
+    unusable and caused a dependency to libmysqlclient15-dev in the
+    mysql-server-5.0 package. The relevant 85_* patch was re-added again.
+    Closes: #406435
+  * Added lintian-overrides for an error that does not affect our packages.
+    There are now only warnings and not errors left.
+
+ -- Christian Hammers <ch@debian.org>  Tue,  9 Jan 2007 23:55:10 +0100
+
+mysql-dfsg-5.0 (5.0.32-1) unstable; urgency=high
+
+  * New upstream version.
+    * SECURITY: mysql_fix_privilege_tables.sql altered the 
+      table_privs.table_priv column to contain too few privileges, causing
+      loss of the CREATE VIEW and SHOW VIEW privileges. (MySQL Bug#20589)
+    * SECURITY (DoS): ALTER TABLE statements that performed both RENAME TO
+      and {ENABLE|DISABLE} KEYS operations caused a server crash. (MySQL
+      Bug#24089)
+    * SECURITY (DoS): LAST_DAY('0000-00-00') could cause a server crash.
+      (MySQL Bug#23653)
+    * SECURITY (DoS): Using EXPLAIN caused a server crash for queries that 
+      selected from INFORMATION_SCHEMA in a subquery in the FROM clause.
+      (MySQL Bug#22413)
+    * SECURITY (DoS): Invalidating the query cache (e.g. when using stored procedures) 
+      caused a server crash for INSERT INTO ... SELECT statements that 
+      selected from a view. (MySQL Bug#20045)
+    * Using mysql_upgrade with a password crashed the server. Closes: #406229
+    * yaSSL crashed on pre-Pentium Intel and Cyrix CPUs. (MySQL Bug#21765)
+      Closes: #383759
+    * Lots of small fixes to the NDB cluster storage engine.
+  * Updated Japanese Debconf template (thanks to Hideki Yamane).
+    Closes: #405793
+  * Fixed comment regarding "mycheck" in debian-start (thanks to
+    Enrico Zini). Closes: #405787
+
+ -- Christian Hammers <ch@debian.org>  Sat,  6 Jan 2007 14:26:20 +0100
+
+mysql-dfsg-5.0 (5.0.30-3) unstable; urgency=low
+
+  * Updated Brazilian Debconf translation (thanks to Andre Luis Lopes).
+    Closes: #403821
+  * Added Romanian Debconf translation (thanks to Stan Ioan-Eugen).
+    Closes: #403943
+  * Updated Spanish Debconf translation (thanks to Javier Fernandez-Sanguino
+    Pena). Closes: #404084
+  * Updated Galician Debconf translation (thanks to Jacobo Tarrio).
+    Closes: #404318
+  * Updated Dutch Debconf translation (thanks to Vincent Zweije).
+    Closes: #404566
+  * Updated Danish Debconf translation (thanks to Claus Hindsgaul).
+    Closes: #405018
+
+ -- Christian Hammers <ch@debian.org>  Thu, 21 Dec 2006 21:35:09 +0100
+
+mysql-dfsg-5.0 (5.0.30-2) unstable; urgency=high
+
+  * Fixed upstream regression in header files that lead to FTBFS for
+    mysql-admin, mysql-query-browser and probably other pacakges.
+    (thanks to Andreas Henriksson). Closes: #403081, #403082
+  * Fixed some upstream scripts by replacing /etc by /etc/mysql (thanks to
+    Julien Antony). Closes: #401083
+  * Updated French Debconf translation (thanks to Christian Perrier).
+    Closes: #401434
+  * Added Spanish Debconf translation (thanks to Javier Fernandez-Sanguino
+    Pena). Closes: #401953
+  * Marked a Debconf question that is just a dummy and only internally
+    used as not-needing-translation. Closes: #403163
+  * Fixed mysqlslowdump patch to not remove the usage() function (thanks 
+    to Monty Tailor).
+
+ -- Christian Hammers <ch@debian.org>  Sun,  3 Dec 2006 19:20:10 +0100
+
+mysql-dfsg-5.0 (5.0.30-1) unstable; urgency=low
+
+  * New upstream version (switch to the MySQL Enterprise branch).
+  * Upstream bugfix for the Innodb performance bug:
+    "Very poor performance with multiple queries running
+     concurrently (Bug#15815)".
+  * Upstream bugfix for a possible server crash:
+    "Selecting from a MERGE table could result in a server crash if the
+     underlying tables had fewer indexes than the MERGE table itself
+     (Bug#22937)"
+  * Upstream bugfies for *lot* of NDB problems.
+  * Upstream bugfix for Innodb optimizer bug. Closes: #397597
+  * Updated Italian Debconf translation (thanks to Luca Monducci).
+    Closes: #401305 
+  * Updated debian/watch file to MySQL Enterprise branch.
+
+ -- Christian Hammers <ch@debian.org>  Sat,  2 Dec 2006 16:36:38 +0100
+
+mysql-dfsg-5.0 (5.0.27-2) unstable; urgency=medium
+
+  * Disabled YaSSL x86 assembler as it was reported to crash applications
+    like pam-mysql or proftpd-mysql which are linked against libmysqlclient
+    on i486 and Cyrix (i586) CPUs. Closes: #385147
+  * Adjusted mysql-server-4.1 priority to extra and section to oldlibs
+    according to the ftp masters overrides.
+  * Updated German Debconf translation (thanks to Alwin Meschede).
+    Closes: #400809
+
+ -- Christian Hammers <ch@debian.org>  Wed, 22 Nov 2006 13:36:31 +0100
+
+mysql-dfsg-5.0 (5.0.27-1) unstable; urgency=medium
+
+  * New upstream version (but no codechange, the only difference to 5.0.26
+    was a patch to the ABI change which Debian already included.
+  * When dist-upgrading from mysql-server-4.1/sarge dpkg does not longer
+    ask unnecessary "config file has changed" questions regarding
+    /etc/init.d/mysql, /etc/logrotate.d/mysql-server and
+    /etc/mysql/debian-start just because these files previously belonged
+    to mysql-server-4.1 and not to mysql-server-5.0.
+    To archive this mysql-server-5.0 now pre-depends on mysql-common which
+    provides current versions of those files.
+  * The automatic run mysql_upgrade now works with non-standard datadir
+    settings, too (thanks to Benjami Villoslada). Closes: #394607
+  * Debconf now asks if the old_passwords option is really needed.
+  * Improved explanations of the old_passwords variable in my.cnf.
+  * Removed possibly leftover cron script from MySQL-4.1 (thanks to
+    Mario Oyorzabal Salgado). Closes: #390889
+  * Postrm ignores failed "userdel mysql".
+  * Updated Danish Debconf translation (thanks to Claus Hindsgaul).
+    Closes: #398784
+  * Added Euskarian Debconf translation (thanks to Piarres Beobide).
+    Closes: #399045
+  * Updated Japanese Debconf translation (thanks to Hideki Yamane).
+    Closes: #399074
+  * Updated German Debconf translation (thanks to Alwin Meschede).
+    Closes: #399087
+  * New Portuguese debconf translations from Miguel Figueiredo. 
+    Closes: #398186
+
+ -- Christian Hammers <ch@debian.org>  Tue,  7 Nov 2006 21:26:25 +0100
+
+mysql-dfsg-5.0 (5.0.26-3) unstable; urgency=high
+
+  [sean finney]
+  * Fix for the deadly ISAM trap.  Now during upgrades we will do our
+    very best to convert pre-existing ISAM format tables using the
+    binaries from the previous package.  Success is not guaranteed, but
+    this is probably as good as it gets.  Note that this also necessitates
+    re-introducing an (empty transitional) mysql-server-4.1 package.
+    Closes: #354544, #354850
+  * Remove a couple spurious and wrongly placed WARNING statements from
+    45_warn-CLI-passwords.dpatch.  thanks to Dan Jacobsen for pointing these
+    out.  Closes: #394262
+
+ -- sean finney <seanius@debian.org>  Fri, 03 Nov 2006 18:34:46 +0100
+
+mysql-dfsg-5.0 (5.0.26-2) unstable; urgency=high
+
+  * Fixed FTBFS for Alpha by applying an upstream patch (thanks to Falk
+    Hueffner). Closes: #395921
+
+ -- Christian Hammers <ch@debian.org>  Sat, 28 Oct 2006 20:13:46 +0200
+
+mysql-dfsg-5.0 (5.0.26-1) unstable; urgency=high
+
+  * SECURITY: 
+    This combined release of 5.0.25 and 5.0.26 fixes lot of possible server
+    crashs so it should get into Etch. Quoting the changelog (bug numbers are
+    bugs.mysql.com ones):
+    - character_set_results can be NULL to signify no conversion, but some
+      code did not check for NULL, resulting in a server crash. (Bug#21913)
+    - Using cursors with READ COMMITTED isolation level could cause InnoDB to
+      crash. (Bug#19834)
+    - Some prepared statements caused a server crash when executed a second
+      time. (Bug#21166)
+    - When DROP DATABASE or SHOW OPEN TABLES was issued while concurrently 
+      issuing DROP TABLE (or RENAME TABLE, CREATE TABLE LIKE or any other 
+      statement that required a name lock) in another connection, the server 
+      crashed. (Bug#21216)
+    - Use of zero-length variable names caused a server crash. (Bug#20908)
+    - For InnoDB tables, the server could crash when executing NOT IN () 
+      subqueries. (Bug#21077) 
+    - Repeated DROP TABLE statements in a stored procedure could sometimes
+      cause the server to crash. (Bug#19399)
+    - Performing an INSERT on a view that was defined using a SELECT that 
+      specified a collation and a column alias caused the server to crash 
+      (Bug#21086).
+    - A query of the form shown here caused the server to crash. (Bug#21007)
+    - NDB Cluster: Some queries involving joins on very large NDB tables could
+      crash the MySQL server. (Bug#21059)
+    - The character set was not being properly initialized for CAST() with a
+      type like CHAR(2) BINARY, which resulted in incorrect results or even a 
+      server crash. (Bug#17903)
+    - For certain queries, the server incorrectly resolved a reference to an
+      aggregate function and crashed. (Bug#20868)
+    - The server crashed when using the range access method to execut a
+      subquery with a ORDER BY DESC  clause. (Bug#20869)
+    - Triggers on tables in the mysql database caused a server crash. Triggers
+      for tables in this database now are disallowed. (Bug#18361)
+    - Using SELECT on a corrupt MyISAM table using the dynamic record format 
+      could cause a server crash. (Bug#19835) 
+    - Use of MIN() or MAX()  with GROUP BY on a ucs2  column could cause a
+      server crash. (Bug#20076)
+    - Selecting from a MERGE table could result in a server crash if the
+      underlying tables had fewer indexes than the MERGE table itself. 
+      (Bug#21617, Bug#22937)
+
+  * New upstream release.
+    - This bug would cause trouble for Sarge->Etch upgrades, it was supposed to
+      have been fixed in 5.0.16 but that apparently did not fix the whole
+      problem:
+      Using tables from MySQL 4.x in MySQL 5.x, in particular those with VARCHAR
+      fields and using INSERT DELAYED to update data in the table would result in
+      either data corruption or a server crash. (Bug#16611, Bug#16218, Bug#17294) 
+      Closes: #386337
+    - Fixes data corruption as an automatic client reconnect used to set
+      the wrong character set. Closes: #365050
+    - Fixes an undefined ulong type in an include file. Closes: #389102
+    - Fixes wrong output format when using Unicode characters. Closes: #355302
+    - Fixes mysql_upgrade when using a password. Closes: #371841
+ 
+  [Christian Hammers]
+  * Removed --sysconfdir from debian/rules as it puts /etc/mysql/ at the
+    end of the my.cnf search patch thus overriding $HOME/my.cnf
+    (thanks to Christoph Biedl). Closes: #394992
+  * The provided patch from bug #385947 was wrong, the variable is called
+    BLOCKSIZE not BLOCK_SIZE according to "strings `which df`" (thanks to
+    Bruno Muller). Closes: #385947
+
+  [sean finney]
+  * new dutch debconf translations from Vincent Zweije (closes: #392809).
+  * new japanese debconf translations from Hideki Yamane (closes: #391625).
+  * new italian debconf translations from Luca Monducci (closes: #391741).
+  * new french debconf translations from Christian Perrier (closes: #393334).
+  * ran debconf-updatepo to merge the fuzzies into svn.
+  * massage the following patches so they continue to apply cleanly:
+    - 44_scripts__mysql_config__libs.dpatch to cleanly apply.
+    - 45_warn-CLI-passwords.dpatch
+    - 96_TEMP__libmysqlclient_ssl_symbols.dpatch (note, this patch might
+      no longer be needed, but is retained "just in case" after massaging it)
+  * the following patches have been incorporated upstream:
+    - 70_kfreebsd.dpatch
+    - 80_hurd_mach.dpatch
+    - 87_ps_Hurd.dpatch
+    - 90_TEMP__client__mysql_upgrade__O_EXEC.dpatch
+    - 91_TEMP__client__mysql_upgrade__password.dpatch
+    - 92_TEMP__client__mysql_upgrade__defaultgroups.dpatch
+    - 94_TEMP__CVE-2006-4227.dpatch
+    - 95_TEMP__CVE-2006-4226.dpatch
+  * the udf_example.cc has disappeared from the source code, but there's
+    a udf_example.c which seems to be a good example to use instead :)
+  * update documentation in the configuration to no longer reference
+    using my.cnf in the DATADIR, as it's never been the recommended
+    method for debian systems and hasn't worked since 5.0 was released
+    anyway (closes: #393868).
+
+ -- Christian Hammers <ch@debian.org>  Wed, 25 Oct 2006 19:54:04 +0200
+
+mysql-dfsg-5.0 (5.0.24a-9) unstable; urgency=medium
+
+  * Having expire_logs_days enabled but log-bin not crashes the server. Using
+    both or none of those options is safe. To prevent this happening during the 
+    nightly log rotation via /etc/logrotate.d/mysql the initscript checks for 
+    malicious combination of options. See: #368547
+  * The Sarge package "mysql-server" which used to include the mysqld daemon
+    may still be in unselected-configured state (i.e. after a remove but not
+    purge) in which case its now obsolete cronscript has to be moved away
+    (thanks to Charles Lepple). Closes: #385669
+  * Updated Danish Debconf translation (thanks to Claus Hindsgaul).
+    Closes: #390315
+  * Updated Frensh Debconf translation (thanks to Christian Perrier).
+    Closes: #390980
+
+ -- Christian Hammers <ch@debian.org>  Tue,  3 Oct 2006 14:55:31 +0200
+
+mysql-dfsg-5.0 (5.0.24a-8) unstable; urgency=low
+
+  * (broken upload)
+
+ -- Christian Hammers <ch@debian.org>  Tue,  3 Oct 2006 14:55:31 +0200
+
+mysql-dfsg-5.0 (5.0.24a-7) unstable; urgency=low
+
+  * Stopped mysql_config from announcing unnecessary library dependencies
+    which until now cause "NEEDED" dependencies in the "readelf -d" output
+    of libraries who only depend on libmysqlclient.so (thanks to Michal
+    Cihar). Closes: #390692
+
+ -- Christian Hammers <ch@debian.org>  Sun,  1 Oct 2006 23:59:43 +0200
+
+mysql-dfsg-5.0 (5.0.24a-6) unstable; urgency=low
+
+  [sean finney]
+  * finally add support for setting a root password at install.
+    while this is not a random password as requested in one bug
+    report, we believe it is the best solution and provides a
+    means to set a random password via preseeding if it's really
+    desired (Closes: #316127, #298295).
+
+ -- sean finney <seanius@debian.org>  Sun, 01 Oct 2006 23:34:30 +0200
+
+mysql-dfsg-5.0 (5.0.24a-5) unstable; urgency=low
+
+  * Added ${shlibs:Depends} to debian/control section libmysqlclient-dev as it
+    contains the experimental /usr/lib/mysql/libndbclient.so.0.0.0.
+  * Bumped standards version to 3.7.2.
+  * Added LSB info section to init scripts.
+  * Rephrased Debconf templates as suggested by lintian.
+  * Added benchmark suite in /usr/share/mysql/sql-bench/.
+  * The mysql.timezone* tables are now filled by the postinst script (thanks
+    to Mark Sheppard). Closes: #388491
+  * Moved Debconf install notes to README.Debian. Displaying them with
+    medium priority was a bug anyway. Closes: #388941
+  * Replaced /usr/bin/mysql_upgrade by /usr/bin/mysql_upgrade_shell in
+    /etc/mysql/debian-start.sh as it works without errors (thanks to Javier
+    Kohen). Closes: #389443
+
+ -- Christian Hammers <ch@debian.org>  Wed, 20 Sep 2006 15:01:42 +0200
+
+mysql-dfsg-5.0 (5.0.24a-4) unstable; urgency=high
+
+  * libmysqlclient.so.15 from 5.0.24 accidentaly exports some symbols that are
+    historically exported by OpenSSL's libcrypto.so. This bug was supposed to
+    be fixed in 5.0.24a bug according to the mysql bug tracking system will
+    only be fixed in 5.0.25 so I backported the patch. People already reported
+    crashing apps due to this (thanks to Duncan Simpson). See also: #385348
+    Closes: #388262
+  * Fixed BLOCKSIZE to BLOCK_SIZE in initscript (thanks to Bruno Muller).
+    Closes: #385947
+  * Added hint to "--extended-insert=0" to mysqldump manpage (thanks to Martin
+    Schulze).
+  * Documented the meaning of "NDB" in README.Debian (thanks to Dan Jacobson).
+    Closes: #386274
+  * Added patch to build on hurd-i386 (thanks to Cyril Brulebois). Closes: #387369
+  * Fixed debian-start script to work together with the recend LSB modifications in
+    the initscript (thanks to wens). Closes: #387481
+  * Reverted tmpdir change in my.cnf back to /tmp to comply with FHS (thanks
+    to Alessandro Valente). Closes: #382778
+  * Added logcheck filter rule (thanks to Paul Wise). Closes: #381043
+  * I will definetly not disable InnoDB but added a note to the default my.cnf
+    that disabling it saves about 100MB virtual memory (thanks to Olivier
+    Berger). Closes: #384399
+  * Added thread_cache_size=8 to default my.cnf as this variable seems to have
+    a negligible memory footprint but can improve performance when lots of
+    threads connect simultaneously as often seen on web servers.
+
+ -- Christian Hammers <ch@debian.org>  Mon,  4 Sep 2006 00:21:50 +0200
+
+mysql-dfsg-5.0 (5.0.24a-3) unstable; urgency=low
+
+  * Fixed potential tempfile problem in the newly added mysqlreport script.
+
+ -- Christian Hammers <ch@debian.org>  Sun,  3 Sep 2006 23:17:24 +0200
+
+mysql-dfsg-5.0 (5.0.24a-2) unstable; urgency=low
+
+  * Added "mysqlreport" (GPL'ed) from hackmysql.com.
+  * Temporarily disabled expire_days option as it causes the server
+    to crash. See #368547
+  * Made output of init scripts LSB compliant (thanks to David Haerdeman).
+    Closes: #385874
+
+ -- Christian Hammers <ch@debian.org>  Sun,  3 Sep 2006 19:06:53 +0200
+
+mysql-dfsg-5.0 (5.0.24a-1) unstable; urgency=high
+
+  * New upstream version.
+  * The shared library in the 5.0.24 upstream release accidently exported 
+    some symbols that are also exported by the OpenSSL libraries (notably
+    BN_bin2bn) causing unexpected behaviour in applications using these 
+    functions (thanks to Peter Cernak). Closes: #385348
+  * Added note about possible crash on certain i486 clone CPUs.
+  * Made recipient address of startup mysqlcheck output configurable
+    (thanks to Mattias Guns). Closes: #385119
+
+ -- Christian Hammers <ch@debian.org>  Mon, 28 Aug 2006 01:22:12 +0200
+
+mysql-dfsg-5.0 (5.0.24-3) unstable; urgency=high
+
+  * SECURITY:
+    CVE-2006-4226:
+    When run on case-sensitive filesystems, MySQL allows remote
+    authenticated users to create or access a database when the database 
+    name differs only in case from a database for which they have
+    permissions.
+    CVE-2006-4227:
+    MySQL evaluates arguments of suid routines in the security context of
+    the routine's definer instead of the routine's caller, which allows
+    remote authenticated users to gain privileges through a routine that 
+    has been made available using GRANT EXECUTE.
+    Thanks to Stefan Fritsch for reporting. Closes: #384798
+
+ -- Christian Hammers <ch@debian.org>  Sat, 26 Aug 2006 04:55:17 +0200
+
+mysql-dfsg-5.0 (5.0.24-2) unstable; urgency=high
+
+  * 5.0.24-1 introduced an ABI incompatibility, which this patch reverts.
+    Programs compiled against 5.0.24-1 are not compatible with any other
+    version and needs a rebuild.
+    This bug already caused a lot of segfaults and crashes in various 
+    programs. Thanks to Chad MILLER from MySQL for quickly providing a patch.
+    The shlibdeps version has been increased to 5.0.24-2.
+    Closes: #384047, #384221, #383700
+
+ -- Christian Hammers <ch@debian.org>  Fri, 25 Aug 2006 21:47:35 +0200
+
+mysql-dfsg-5.0 (5.0.24-1) unstable; urgency=high
+ 
+  * SECURITY: Upstream fixes a security bug which allows a user to continue
+    accessing a table using a MERGE TABLE after the right to direct access to
+    the database has been revoked (CVE-2006-4031, MySQL bug #15195).
+    (Well they did not exactly fixed it, they documented the behaviour and
+    allow the admin to disable merge table alltogether...). Closes: #380271
+  * SECURITY: Applied patch that fixes a possibly insecure filehandling
+    in the recently added mysql_upgrade binary file (MySQL bug #10320).
+  * New upstream version.
+    - Fixes nasty MySQL bug #19618 that leads to crashes when using
+      "SELECT ... WHERE ... not in (1, -1)" (e.g. vbulletin was affected).
+    - Fixes upstream bug #16803 so that linking ~/.mysql_history to /dev/null
+      now has the desired effect of having no history.
+  * Really fixed the runlevels. Closes: #377651
+  * Added patch for broken upstream handling of "host=" to mysql_upgrade.c.
+  * Adjusted /etc/mysql/debian-start to new mysql_upgrade.c
+
+ -- Christian Hammers <ch@debian.org>  Tue,  8 Aug 2006 00:44:13 +0200
+
+mysql-dfsg-5.0 (5.0.22-5) unstable; urgency=low
+
+  * Added further line to the logcheck ignore files (thanks to Paul Wise).
+    Closes: #381038
+
+ -- Christian Hammers <ch@debian.org>  Wed,  2 Aug 2006 00:28:50 +0200
+
+mysql-dfsg-5.0 (5.0.22-4) unstable; urgency=low
+
+  * Upstream fixes a bug in the (never released) version 5.0.23 which could
+    maybe used to crash the server if the mysqlmanager daemon is in use
+    which is not yet the default in Debian. (CVE-2006-3486 *DISPUTED*)
+  * Changed runlevel priority of mysqld from 20 to 19 so that it gets started
+    before apache and proftpd etc. which might depend on an already running
+    database server (thanks to Martin Gruner). Closes: #377651
+  * Added patch which sets PATH_MAX in ndb (thanks to Cyril Brulebois).
+    Closes: #378949
+  * Activated YaSSL as licence issues are settled according to:
+    http://bugs.mysql.com/?id=16755. This also closes the FTBFS bug
+    regarding OpenSSL as it is discouraged to use now. Closes: #368639
+  * Removed SSL-MINI-HOWTO as the official documentation is good enough now.
+  * mysql_upgrade no longer gives --password on the commandline which would
+    be insecure (thanks to Dean Gaudet). Closes: #379199
+  * Adjusted debian/patches/45* to make consecutive builds in the same source
+    tree possible (thanks to Bob Tanner). Closes: #368661
+  * mysql-server-5.0 is now suggesting tinyca as yaSSL is enabled and tinyca
+    was found to be really cool :)
+  * Moved tempdir from /tmp to /var/tmp as it will more likely have enough
+    free space as /tmp is often on the root partition and /var or at least
+    /var/tmp is on a bigger one.
+
+ -- Christian Hammers <ch@debian.org>  Mon, 10 Jul 2006 23:30:26 +0200
+
+mysql-dfsg-5.0 (5.0.22-3) unstable; urgency=low
+
+  * Added patch for MySQL bug #19618: "select x from x
+    where x not in(1,-1)" may crash the server" (thanks to
+    Ruben Puettmann).
+
+ -- Christian Hammers <ch@debian.org>  Fri,  9 Jun 2006 01:41:44 +0200
+
+mysql-dfsg-5.0 (5.0.22-2) unstable; urgency=high
+
+  * Fixed debian-sys-maint related bug in postinst (thanks to
+    Jean-Christophe Dubacq). Closes: #369970
+  * The last upload was a security patch (which I did not know as I
+    uploaded before the announcement came). I now added the CVE id for
+    reference and set urgency to high as the last entry did not.
+
+ -- Christian Hammers <ch@debian.org>  Wed, 31 May 2006 01:04:11 +0200
+
+mysql-dfsg-5.0 (5.0.22-1) unstable; urgency=low
+
+  * SECURITY: This upstream release fixes an SQL-injection with multibyte 
+    encoding problem. (CVE-2006-2753)
+  * New upstream release.
+  * Upstream fixes REPAIR TABLE problem. Closes: #354300
+  * Upstream fixes problem that empty strings in varchar and text columns
+    are displayed as NULL. Closes: #368663
+
+ -- Christian Hammers <ch@debian.org>  Tue, 30 May 2006 23:43:24 +0200
+
+mysql-dfsg-5.0 (5.0.21-4) unstable; urgency=low
+
+  * Added "BLOCKSIZE=" to the diskfree check (thanks to Farzad FARID).
+    Closes: #367027, #367083
+  * Further fixed mysql_upgrade upstream script (thanks to Andreas Pakulat)
+    Closes: #366155
+  * Adjusted the /proc test in debian/rules from /proc/1 to /proc/self
+    to make building on grsec systems possible (thanks to K. Rosenegger).
+    Closes: #366824
+  * Updated Russion Debconf translation (thanks to Yuriy Talakan).
+    Closes: #367141
+  * Updated Czech Debconf translation (thanks to Kiroslav Kure).
+    Closes: #367160
+  * Updated Galician Debconf translation (thanks to Jacobo Tarrio).
+    Closes: #367384
+  * Updated Swedish Debconf translation (thanks to Daniel Nylander).
+    Closes: #368186
+
+ -- Christian Hammers <ch@debian.org>  Wed, 10 May 2006 08:45:42 +0200
+
+mysql-dfsg-5.0 (5.0.21-3) unstable; urgency=low
+
+  * Fixed FTBFS problem which was caused by a patch that modifies Makefile.am
+    as well as Makefile.in and was not deteced because my desktop was fast
+    enough to patch both files within the same second and so fooled automake.
+    (thanks to Blars Blarson for notifying me). Closes: #366534
+
+ -- Christian Hammers <ch@debian.org>  Sat,  6 May 2006 19:03:58 +0200
+
+mysql-dfsg-5.0 (5.0.21-2) unstable; urgency=low
+
+  * Fixed bug in postinst that did not correctly rewrite 
+    /etc/mysql/debian.cnf (thanks to Daniel Leidert). 
+    Closes: #365433, #366155
+
+ -- Christian Hammers <ch@debian.org>  Thu,  4 May 2006 02:37:03 +0200
+
+mysql-dfsg-5.0 (5.0.21-1) unstable; urgency=high
+
+  * SECURITY: New upstream release with some security relevant bugfixes:
+    * "Buffer over-read in check_connection with usernames lacking a
+      trailing null byte" (CVE-2006-1516)
+    * "Anonymous Login Handshake - Information Leakage" (CVE-2006-1517)
+    * "COM_TABLE_DUMP Information Leakage and Arbitrary command execution"
+       (CVE-2006-1518)
+    Closes: #365938, #365939
+  * Added diskfree check to the init script (thanks to Tim Baverstock).
+    Closes: #365460
+  * First amd64 upload!
+
+ -- Christian Hammers <ch@debian.org>  Sat, 29 Apr 2006 04:31:27 +0200
+  
+mysql-dfsg-5.0 (5.0.20a-2) unstable; urgency=low
+
+  * The new mysql-upgrade which is started from /etc/mysql/debian-start
+    does now use the debian-sys-maint user for authentication (thanks to
+    Philipp). Closes: #364991
+  * Wrote patch debian/patches/43* which adds a password option to
+    mysql_update. See MySQL bug #19400.
+  * Added "Provides: libmysqlclient-dev" to libmysqlclient15-dev as I saw no
+    obvious reasons against it (problems should be documented in
+    debian/README.Maintainer!) (thanks to Olaf van der Spek). Closes: #364899
+  * Updated Netherlands debconf translation (thanks to Vincent Zweije)
+    Closes: #364464
+  * Updated French debconf translation (thanks to Christian Perrier)
+    Closes: #364401
+  * Updated Danish debconf translation (thanks to Claus Hindsgaul)
+    Closes: #365135
+
+ -- Christian Hammers <ch@debian.org>  Wed, 26 Apr 2006 01:14:53 +0200
+
+mysql-dfsg-5.0 (5.0.20a-1) unstable; urgency=low
+
+  * New upstream release.
+  * Added the new mysql_upgrade script and added it to
+    /etc/mysql/debian-start (thanks to Alessandro Polverini). 
+    The script is currently very noise that is a known bug and will be
+    fixed in the next release!
+    Closes: #363458
+  * No longer creates the "test" database. This actuallay had been tried
+    to archive before (at least patches) exists but apparently was not the
+    case in the last versions (thanks to Olaf van der Spek). Closes: #362126
+  * Reformatted libmysqlclient15off.NEWS.Debian to changelog format
+    (thanks to Peter Palfrader). Closes: #363062
+
+ -- Christian Hammers <ch@debian.org>  Sat, 15 Apr 2006 13:05:22 +0200
+
+mysql-dfsg-5.0 (5.0.20-1) unstable; urgency=high
+
+  * Upstream contains a fix for a nasty bug (MySQL#18153) that users 
+    already experienced and that caused corrupted triggers after
+    REPAIR/OPTIMIZE/ALTER TABLE statements.
+    (thanks to Jerome Despatis for pointing out)
+  * Added patch for the "updates on multiple tables is buggy after 
+    upgrading from 4.1 to 5.0" problem which MySQL has been committed
+    for the upcoming 5.0.21 release. Closes #352704
+  * Added Netherlands debconf translation (thanks to Vincent Zweije).
+    Closes: #360443
+  * Added Galician debconf translation (thanks to Jacobo Tarrio).
+    Closes: #361257
+
+ -- Christian Hammers <ch@debian.org>  Fri,  7 Apr 2006 00:00:43 +0200
+
+mysql-dfsg-5.0 (5.0.19-3) unstable; urgency=high
+
+  [ Christian Hammers ]
+  * Fixed libmysqlclient15.README.Debian regarding package name changes
+    (thanks to Leppo).
+  * Moved libheap.a etc. back to /usr/lib/mysql/ as their names are just
+    too generic. Closes: #353924
+  [ Sean Finney ]
+  * updated danish debconf translation, thanks to Claus Hindsgaul
+    (closes: #357424).
+  [ Adam Conrad ]
+  * Send stderr from 'find' in preinst to /dev/null to tidy up chatter.
+  * Backport patch for CVE-2006-0903 from the upcoming release to resolve
+    a log bypass vulnerability when using non-binary logs (closes: #359701)
+
+ -- Adam Conrad <adconrad@0c3.net>  Tue,  4 Apr 2006 15:23:18 +1000
+
+mysql-dfsg-5.0 (5.0.19-2) unstable; urgency=medium
+
+  * New upstream release.
+  * Renamed package libmysqlclient15 to libmysqlclient15off due to
+    binary incompatible changes.
+    See /usr/share/doc/libmysqlclient15off/README.Debian
+  * Updated Czech debconf translation (thanks to Miroslav Kure).
+    Closes: #356503
+  * Updated French debconf translation (thanks to Christian Perrier).
+    Closes: #356332
+  * Improved README.Debian (thanks to Olaf van der Spek). Closes: #355702
+  * Fixed 5.0.18-8 changelog by saying in which package the NEWS.Debian
+    file is (thanks to Ross Boylan). Closes: #355978
+
+ -- Christian Hammers <ch@debian.org>  Fri, 17 Mar 2006 02:32:19 +0100
+
+mysql-dfsg-5.0 (5.0.19-1) experimental; urgency=medium
+
+  * New upstream release.
+  * SECURITY: CVE-2006-3081: A bug where str_to_date(1,NULL) lead to a 
+    server crash has been fixed. 
+    (this note has been added subsequently for reference)
+  * Renamed package libmysqlclient15 to libmysqlclient15off.
+    See /usr/share/doc/libmysqlclient15off/NEWS.Debian
+  * Updated Czech debconf translation (thanks to Miroslav Kure).
+    Closes: #356503
+  * Updated French debconf translation (thanks to Christian Perrier).
+    Closes: #356332
+  * Improved README.Debian (thanks to Olaf van der Spek). Closes: #355702
+  * Fixed 5.0.18-8 changelog by saying in which package the NEWS.Debian
+    file is (thanks to Ross Boylan). Closes: #355978
+
+ -- Christian Hammers <ch@debian.org>  Tue, 14 Mar 2006 22:56:13 +0100
+
+mysql-dfsg-5.0 (5.0.18-9) unstable; urgency=medium
+
+  [ Christian Hammers ]
+  * When using apt-get the check for left-over ISAM tables can abort the
+    installation of mysql-server-5.0 but not prevent the mysql-server-4.1
+    package from getting removed. The only thing I can do is reflect this
+    in the Debconf notice that is shown and suggest to reinstall
+    mysql-server-4.1 for converting. See: #354850
+  * Suggests removing of /etc/cron.daily/mysql-server in last NEWS message
+    (thanks to Mourad De Clerck). Closes: #354111
+  * Added versioned symbols for kfreebsd and Hurd, too (thanks to Aurelien
+    Jarno and Michael Bank). Closes: #353971 
+  * Added versioned symbols for kfreebsd, too (thanks to Aurelien Jarno).
+    Closes: #353971
+  [ Adam Conrad ]
+  * Add 39_scripts__mysqld_safe.sh__port_dir.dpatch to ensure that the
+    permissions on /var/run/mysqld are always correct, even on a tmpfs.
+
+ -- Christian Hammers <ch@debian.org>  Mon,  6 Mar 2006 21:42:13 +0100
+
+mysql-dfsg-5.0 (5.0.18-8) unstable; urgency=low
+
+  * The rotation of the binary logs is now configured via
+    expire-logs-days in /etc/mysql/my.cnf and handled completely
+    by the server and no longer in configured in debian-log-rotate.conf
+    and handled by a cron job. Thanks to David Johnson.
+    See /usr/share/doc/mysql-server-5.0/NEWS.Debian
+  * Ran aspell over some files in debian/ and learned a lot :)
+  * debian/rules: Added check if versioned symbols are really there.
+  * Updated SSL-MINI-HOWTO.
+  * Updated copyright (removed the parts regarding the now removed
+    BerkeleyDB table handler and mysql-doc package).
+  * Relocated a variable in preinst (thanks to Michael Heldebrant).
+    Closes: #349258, #352587, #351216
+  * Updated Danish debconf translation (thanks to Claus Hindsgaul).
+    Closes: #349013  
+  * Updated Swedish debconf translation (thanks to Daniel Nylander).
+    Closes: #349522
+  * Updated French debconf translation (thanks to Christian Perrier).
+    Closes: #349592
+  * Fixed typo in README.Debian (thanks to Vincent Ricard).
+  * Prolonged waiting time for mysqld in the init script. Closes: #352070
+
+ -- Christian Hammers <ch@debian.org>  Mon, 23 Jan 2006 23:13:46 +0100
+
+mysql-dfsg-5.0 (5.0.18-7) unstable; urgency=low
+
+  * Made mailx in debian-start.inc.sh optional and changed the dependency on it
+    on it to a mere recommendation. Closes: #316297
+  * the previous FTBFS patches for GNU/Hurd inadvertently led to configure
+    being regenerating, losing a couple trivial things like our versioned
+    symbols patch, causing many nasty problems (closes: #348854).
+
+ -- sean finney <seanius@debian.org>  Fri, 20 Jan 2006 20:59:27 +0100
+
+mysql-dfsg-5.0 (5.0.18-6) unstable; urgency=low
+
+  * Added version comment (thanks to Daniel van Eeden). 
+  * Added two patches to build on GNU/Hurd (thanks to Michael Bank).
+    Closes: #348182
+  * Abort upgrade if old and now unsupported ISAM tables are present
+    (thanks to David Coe). Closes: #345895
+
+ -- Christian Hammers <ch@debian.org>  Tue, 17 Jan 2006 19:25:59 +0100
+
+mysql-dfsg-5.0 (5.0.18-5) unstable; urgency=low
+
+  * Bump shlibdeps for libmysqlclient15 to (>= 5.0.15-1), which was
+    the first non-beta release from upstream, as well as being shortly
+    after we broke the ABI in Debian by introducing versioned symbols.
+
+ -- Adam Conrad <adconrad@0c3.net>  Fri, 13 Jan 2006 13:18:03 +1100
+
+mysql-dfsg-5.0 (5.0.18-4) unstable; urgency=low
+
+  * Munge our dependencies further to smooth upgrades even more, noting
+    that we really need 5.0 to conflict with 4.1, and stealing a page from
+    the book of mysql-common, it doesn't hurt to hint package managers in
+    the direction of "hey, this stuff is a complete replacement for 4.1"
+  * Change the description of mysql-server and mysql-client to remove the
+    references to it being "transition", and instead point out that it's
+    the way to get the "current best version" of each package installed.
+
+ -- Adam Conrad <adconrad@0c3.net>  Wed, 11 Jan 2006 11:39:45 +1100
+
+mysql-dfsg-5.0 (5.0.18-3) unstable; urgency=low
+
+  * Make the mysql-{client,server}-5.0 conflict against mysql-{client,server}
+    versioned, so they can be installed side-by-side and upgrade properly.
+  * Add myself to Uploaders; since I have access to the alioth repository.
+
+ -- Adam Conrad <adconrad@0c3.net>  Tue, 10 Jan 2006 19:15:48 +1100
+
+mysql-dfsg-5.0 (5.0.18-2) unstable; urgency=low
+
+  * Removed the transitional package that forced an upgrade from
+    mysql-server-4.1 to mysql-server-5.0 as I was convinced that
+    having a general "mysql-server" package with adjusted dependencies
+    is enough (thanks to Adam Conrad).
+  * Updated logcheck.ignore files (thanks to Jamie McCarthy). Closes: #340193
+
+ -- Christian Hammers <ch@debian.org>  Mon,  9 Jan 2006 21:54:53 +0100
+
+mysql-dfsg-5.0 (5.0.18-1) unstable; urgency=low
+
+  * New upstream version. 
+  * Added empty transitional packages that force an upgrade from the
+    server and client packages that have been present in Sarge.
+  * Fixed SSL-MINI-HOWTO (thanks to Jonas Smedegaard). Closes: #340589 
+
+ -- Christian Hammers <ch@debian.org>  Mon,  2 Jan 2006 21:17:51 +0100
+
+mysql-dfsg-5.0 (5.0.17-1) unstable; urgency=low
+
+  * Never released as Debian package.
+
+ -- Christian Hammers <ch@debian.org>  Thu, 22 Dec 2005 07:49:52 +0100
+
+mysql-dfsg-5.0 (5.0.16-1) unstable; urgency=low
+
+  * New upstream version.
+  * Removed the error logs from the logrotate script as Debian does
+    not use them anymore. Closes: #339628
+
+ -- Christian Hammers <ch@debian.org>  Tue, 22 Nov 2005 01:19:11 +0100
+
+mysql-dfsg-5.0 (5.0.15-2) unstable; urgency=medium
+
+  * Added 14_configure__gcc-atomic.h.diff to fix FTBFS on m68k
+    (thanks to Stephen R Marenka). Closes: #337082
+  * Removed dynamic linking against libstdc++ as it was not really
+    needed (thanks to Adam Conrad). Closes: #328613
+  * Fixed the "/var/lib/mysql is a symlink" workaround that accidently
+    left a stalled symlink (thanks to Thomas Lamy). Closes: #336759
+  * As the init script cannot distinguish between a broken startup and
+    one that just takes very long the "failed" message now says
+    "or took more than 6s" (thanks to Olaf van der Spek). Closes: #335547
+
+ -- Christian Hammers <ch@debian.org>  Thu,  3 Nov 2005 22:00:15 +0100
+
+mysql-dfsg-5.0 (5.0.15-1) unstable; urgency=low
+
+  * New upstream version. 5.0 has finally been declared STABLE!
+  * Added small patch to debian/rules that fixed sporadic build errors
+    where stdout and stderr were piped together, got mixed up and broke
+  * Added --with-big-tables to ./configure (thanks to tj.trevelyan).
+    Closes: #333090
+  * Added capability to parse "-rc" to debian/watch.
+  * Fixed cronscript (thanks to Andrew Deason). Closes: #335244
+  * Added Swedish debconf translation (thanks to Daniel Nylander).
+    Closes: #333670
+  * Added comment to README.Debian regarding applications that manually
+    set new-style passwords... Closes: #334444
+  * Sean Finney:
+    - Fix duplicate reference to [-e|--extended-insert]. Closes: #334957
+    - Fix default behavior for mysqldumpslow. Closes: #334517
+    - Reference documentation issue in mysql manpage. Closes: #335219
+
+ -- Christian Hammers <ch@debian.org>  Fri, 30 Sep 2005 00:10:39 +0200
+
+mysql-dfsg-5.0 (5.0.13rc-1) unstable; urgency=low
+
+  * New upstream release. Now "release-candidate"! 
+  * Removed any dynamic link dependencies to libndbclient.so.0 which
+    is due to its version only distributed as a static library.
+  * Sean Finney:
+    - FTBFS fix related to stripping rpath in debian/rules
+
+ -- Christian Hammers <ch@debian.org>  Mon, 26 Sep 2005 22:09:26 +0200
+
+mysql-dfsg-5.0 (5.0.12beta-5) unstable; urgency=low
+
+  * The recent FTBFS were probably result of a timing bug in the
+    debian/patches/75_*.dpatch file where Makefile.in got patched just
+    before the Makefile.shared which it depended on. For that reason
+    only some of the autobuilders failed. Closes: #330149
+  * Fixed chrpath removal (option -k had to be added).
+  * Corrected debconf dependency as requested by Joey Hess.
+
+ -- Christian Hammers <ch@debian.org>  Mon, 26 Sep 2005 18:37:07 +0200
+
+mysql-dfsg-5.0 (5.0.12beta-4) unstable; urgency=low
+
+  * Removed experimental shared library libndbclient.so.0.0.0 as it
+    is doomed to cause trouble as long as it is present in both MySQL 4.1
+    and 5.0 without real soname and its own package. We still have
+    libndbclient.a for developers. (thanks to Adam Conrad and 
+    mediaforest.net). Closes: #329772
+
+ -- Christian Hammers <ch@debian.org>  Fri, 23 Sep 2005 12:36:48 +0200
+
+mysql-dfsg-5.0 (5.0.12beta-3) unstable; urgency=medium
+
+  * Symbol versioning support!  wooooohoooooo!
+    (thanks to Steve Langasek) Closes: #236288
+  * Moved libndbcclient.so.0 to the -dev package as it is provided by
+    libmysqlclient14 and -15 which must be installable simultaneously.
+  * Removed mysql-*-doc suggestions.
+
+ -- Christian Hammers <ch@debian.org>  Tue, 20 Sep 2005 00:07:03 +0200
+
+mysql-dfsg-5.0 (5.0.12beta-2) unstable; urgency=low
+
+  * Added patch to build on GNU/kFreeBSD (thanks to Aurelien Jarno).
+    Closes: #327702
+  * Added patch that was already been present on the 4.1 branch which
+    makes the "status" command of the init script more sensible
+    (thanks to Stephen Gildea). Closes: #311836
+  * Added Vietnamese Debconf translation (thanks to Clytie Siddal).
+    Closes: #313006
+  * Updated German Debconf translation (thanks to Jens Seidel).
+    Closes: #313957
+  * Corrected commends in example debian-log-rotate.conf. The default is
+    unlike the mysql-sever-4.1 package which needed to stay backwards
+    compatible now 2 to avoid filling up the disk endlessly.
+  * Fixed watch file to be "-beta" aware.
+
+ -- Christian Hammers <ch@debian.org>  Thu, 15 Sep 2005 20:50:19 +0200
+
+mysql-dfsg-5.0 (5.0.12beta-1) unstable; urgency=medium
+
+  * Christian Hammers:
+    - New upstream release.
+    - Changed build-dep to libreadline5-dev as requested by Matthias Klose.
+      Closes: #326316
+    - Applied fix for changed output format of SHOW MASTER LOGS for
+      binary log rotation (thanks to Martin Krueger). Closes: #326427, #326427
+    - Removed explicit setting of $PATH as I saw no sense in it and
+      it introduced a bug (thanks to Quim Calpe). Closes: #326769
+    - Removed PID file creation from /etc/init.d/mysql-ndb as it does
+      not work with this daemon (thanks to Quim Calpe).
+    - Updated French Debconf translation (thanks to Christian Perrier).
+      Closes: #324805
+    - Moved conflicts line in debian/control from libmysqlclient15 to
+      libmysqlclient15-dev and removed some pre-sarge conflicts as
+      suggested by Adam Majer. Closes: #324623
+  * Sean Finney:
+    - For posterity, CAN-2005-2558 has been fixed since 5.0.7beta.
+
+ -- Christian Hammers <ch@debian.org>  Thu, 15 Sep 2005 19:58:22 +0200
+
+mysql-dfsg-5.0 (5.0.11beta-3) unstable; urgency=low
+
+  * Temporarily build only with -O2 to circumvent gcc internal errors
+    (thanks to Matthias Klose). Related to: #321165 
+
+ -- Christian Hammers <ch@debian.org>  Thu, 18 Aug 2005 15:44:04 +0200
+
+mysql-dfsg-5.0 (5.0.11beta-2) unstable; urgency=low
+
+  * Fixed README.Debian regarding the status of mysql-doc.
+  * Added "set +e" around chgrp in mysql-server-5.0.preinst to
+    not fail on .journal files (thanks to Christophe Nowicki).
+    Closes: #318435
+
+ -- Christian Hammers <ch@debian.org>  Sun, 14 Aug 2005 18:02:08 +0200
+
+mysql-dfsg-5.0 (5.0.11beta-1) unstable; urgency=low
+
+  * New upstream version. 
+  * Added Danish Debconf translations (thanks to Claus Hindsgaul).
+    Closes: #322384
+  * Updated Czech Debconf translations (thanks to Miroslav Kure).
+    Closes: #321765
+
+ -- Christian Hammers <ch@debian.org>  Sat, 13 Aug 2005 11:56:15 +0000
+
+mysql-dfsg-5.0 (5.0.10beta-1) unstable; urgency=low
+
+  * New upstream release.
+  * Christian Hammers:
+    - Added check for mounted /proc to debian/rules.
+  * Sean Finney:
+    - fix for fix_mysql_privilege_tables/mysql_fix_privilege_tables typo
+      in mysql-server-5.0's README.Debian (see #319838).
+
+ -- Christian Hammers <ch@debian.org>  Sun, 31 Jul 2005 00:30:45 +0200
+
+mysql-dfsg-5.0 (5.0.7beta-1) unstable; urgency=low
+
+  * Second try for new upstream release. 
+  * Renamed mysql-common-5.0 to mysql-common as future libmysqlclient16
+    from e.g. MySQL-5.1 would else introduce mysql-common-5.1 which makes
+    a simultanous installation of libmysqlclient14 impossible as that
+    depends on either mysql-common or mysql-common-5.0 but not on future
+    versions. Thus we decided to always let the newest MySQL version
+    provide mysql-common.
+  * Added ${misc:Depends} as suggested by debhelper manpage. 
+  * Raised standard in control file to 3.6.2.
+  * Removed DH_COMPAT from rules in faviour of debian/compat.
+  * Checkes for presence of init script before executing it in preinst.
+    Referres: 315959
+  * Added 60_includes_mysys.h__gcc40.dpatch for GCC-4.0 compatibility.
+
+ -- Christian Hammers <ch@debian.org>  Wed, 29 Jun 2005 00:39:05 +0200
+
+mysql-dfsg-5.0 (5.0.5beta-1) unstable; urgency=low
+
+  * New major release! Still beta so be carefull...
+  * Added federated storage engine.
+
+ -- Christian Hammers <ch@debian.org>  Wed,  8 Jun 2005 19:29:45 +0200
+
+mysql-dfsg-4.1 (4.1.12-1) unstable; urgency=low
+
+  * Christian Hammers:
+    - New upstream release.
+    - Disabled BerkeleyDB finally. It has been obsoleted by InnoDB.
+  * Sean Finney:
+    - Updated French translation from Christian Perrier (Closes: #310526).
+    - Updated Japanese translation from Hideki Yamane (Closes: #310263).
+    - Updated Russian translation from Yuriy Talakan (Closes: #310197).
+
+ -- Christian Hammers <ch@debian.org>  Sat,  4 Jun 2005 05:49:11 +0200
+
+mysql-dfsg-4.1 (4.1.11a-4) unstable; urgency=high
+
+  * Fixed FTBFS problem which was caused due to the fact that last uploads
+    BerkeleyDB patch was tried to applied on all architectures and not only
+    on those where BerkeleyDB is actually beeing built. Closes: #310296
+
+ -- Christian Hammers <ch@debian.org>  Mon, 23 May 2005 00:54:51 +0200
+
+mysql-dfsg-4.1 (4.1.11a-3) unstable; urgency=high
+
+  * Added patch from Piotr Roszatycki to compile the bundled db3 library
+    that is needed for the BerkeleyDB support with versioned symbols so
+    that mysqld no longer crashes when it gets linked together with the
+    Debian db3 version which happens when e.g. using libnss-db.
+    Closes: #308966
+
+ -- Christian Hammers <ch@debian.org>  Thu, 19 May 2005 01:41:14 +0200
+
+mysql-dfsg-4.1 (4.1.11a-2) unstable; urgency=high
+
+  * Okay, the hackery with /var/lib/dpkg/info/mysql-server.list will not
+    stand and is removed from the preinst of mysql-server.
+  * New workaround for the symlink problem that does not involve mucking
+    with dpkg's file lists is storing the symlinks in a temporary location
+    across upgrades.
+    As this sometimes fails since apt-get does not always call new.preinst
+    before old.postrm, some remarks were added to README.Debian and the
+    Debconf installation notes to minimize the inconvinience this causes.
+
+ -- sean finney <seanius@debian.org>  Sun, 15 May 2005 10:25:31 -0400
+
+mysql-dfsg-4.1 (4.1.11a-1) unstable; urgency=high
+
+  * Added the "a" to the version number to be able to upload a new
+    .orig.tar.gz file which now has the non-free Docs/ directory removed
+    as this has been forgotten in the 4.1.11 release (thanks to Goeran
+    Weinholt). Closes: #308691
+  * The Woody package listed /var/lib/mysql and /var/log/mysql in its
+    /var/lib/dpkg/info/mysql-server.list. These directories are often
+    replaced by symlinks to data partitions which triggers a dpkg bug
+    that causes these symlinks to be removed on upgrades. The new preinst
+    prevents this by removing the two lines from the .list file
+    (thanks to Andreas Barth and Jamin W. Collins). See dpkg bug #287978.
+  * Updated French Debconf translation (thanks to Christian Perrier).
+    Closes: #308353
+
+ -- Christian Hammers <ch@debian.org>  Thu, 12 May 2005 21:52:46 +0200
+
+mysql-dfsg-4.1 (4.1.11-3) unstable; urgency=high
+
+  * The "do you want to remove /var/lib/mysql when purging the package" flag
+    from old versions is removed once this package is beeing installed so
+    that purging an old Woody mysql-server package while having a
+    mysql-server-4.1 package installed can no longer lead to the removal of
+    all databases. Additionaly clarified the wording of this versions Debconf
+    template and added a check that skips this purge in the postrm script
+    if another mysql-server* package has /usr/sbin/mysqld installed.
+    (thanks to Adrian Bunk for spotting that problem) Closes: #307473
+  * Cronfile was not beeing installed as the filename was not in the
+    correct format for "dh_installcron --name" (thanks to Tomislav
+    Gountchev). Closes: #302712
+
+ -- Christian Hammers <ch@debian.org>  Sat, 23 Apr 2005 22:55:15 +0200
+
+mysql-dfsg-4.1 (4.1.11-2) unstable; urgency=low
+
+  * Sean Finney:
+    - don't freak out if we can't remove /etc/mysql during purge.
+    - debian/rules clean works again.
+  * Christian Hammers:
+    - Fixed typo in README.Debian (thanks to Joerg Rieger). Closes: #304897
+    - Completely removed the passwordless test user as it was not only
+      insecure but also lead to irritations as MySQL checks first the
+      permissions of this user and then those of a password having one.
+      See bug report from Hilko Bengen for details. Closes: #301741
+
+ -- Christian Hammers <ch@debian.org>  Sat, 16 Apr 2005 15:55:00 +0200
+
+mysql-dfsg-4.1 (4.1.11-1) unstable; urgency=low
+
+  * New upstream version. 
+  * Upstream fix for charset/collation problem. Closes: #282256
+  * Upstream fix for subselect crash. Closes: #297687
+  * Corrected minor issue in Debconf template regarding skip-networking
+    (thanks to Isaac Clerencia). Closes: #303417
+  * Made dependency to gawk unnecessary (thanks to Zoran Dzelajlija).
+    Closes: #302284
+  * Removed obsolete 50_innodb_mixlen.dpatch.
+  * Removed obsolete 51_CAN-2004-0957_db_grant_underscore.dpatch.
+
+ -- Christian Hammers <ch@debian.org>  Fri,  8 Apr 2005 00:23:53 +0200
+
+mysql-dfsg-4.1 (4.1.10a-7) unstable; urgency=low
+
+  * Sean Finney:
+    - fix for the mysteriously disappeared cronjob.  thanks to
+      Peter Palfrader <weasel@debian.org> for pointing out this omission.
+      (closes: #302712).
+
+ -- sean finney <seanius@debian.org>  Sat, 02 Apr 2005 16:54:13 -0500
+
+mysql-dfsg-4.1 (4.1.10a-6) unstable; urgency=high
+
+  * Sean Finney:
+    - the previous upload did not completely address the issue.  this one
+      should do so.  d'oh.
+
+ -- sean finney <seanius@debian.org>  Thu, 31 Mar 2005 03:35:50 +0000
+
+mysql-dfsg-4.1 (4.1.10a-5) unstable; urgency=high
+
+  * Sean Finney:
+    - the following security issue is addressed in this upload:
+      CAN-2004-0957 (grant privilege escalation on tables with underscores)
+      thanks to sergei at mysql for all his help with this.
+
+ -- sean finney <seanius@debian.org>  Wed, 30 Mar 2005 21:19:26 -0500
+
+mysql-dfsg-4.1 (4.1.10a-4) unstable; urgency=low
+
+  * Sean Finney:
+    - FTBFS fix for amd64/gcc-4.0.  Thanks to Andreas Jochens <aj@andaco.de>
+      for reporting this (closes: #301807).
+    - ANSI-compatible quoting fix in daily cron job.  thanks to 
+      Karl Hammar <karl@aspodata.se> for pointing out the problem in
+      the 4.0 branch.
+    - Added myself as a co-maintainer in the control file (closes: #295312).
+
+ -- sean finney <seanius@debian.org>  Tue, 29 Mar 2005 18:54:42 -0500
+
+mysql-dfsg-4.1 (4.1.10a-3) unstable; urgency=low
+
+  * BerkeleyDB is now disabled by default as its use is discouraged by MySQL.
+  * Added embedded server libraries as they finally do compile.
+    They are currently in libmysqlclient-dev as they are still 
+    experimental and only available as .a library (thanks to Keith Packard).
+    Closes: #297062
+  * Fixed obsolete "tail" syntax (thanks to Sven Mueller). Closes: #301413
+  * Added CAN numbers for the latest security bugfix upload.
+  * Updated manpage of mysqlmanager (thanks to Justin Pryzby). Closes: #299844
+  * Added comments to default configuration.
+
+ -- Christian Hammers <ch@debian.org>  Sun, 20 Mar 2005 17:40:18 +0100
+
+mysql-dfsg-4.1 (4.1.10a-2) unstable; urgency=low
+
+  * Disabled "--with-mysqld-ldflags=-all-static" as it causes sig11 crashes
+    if LDAP is used for groups in /etc/nsswitch.conf. Confirmed by Sean Finney
+    and Daniel Dehennin. Closes: #299382
+
+ -- Christian Hammers <ch@debian.org>  Mon, 14 Mar 2005 03:01:03 +0100
+
+mysql-dfsg-4.1 (4.1.10a-1) unstable; urgency=high
+
+  * SECURITY:
+    - The following security related updates are addressed: 
+      CAN-2005-0711 (temporary file creation with "CREATE TEMPORARY TABLE")
+      CAN-2005-0709 (arbitrary library injection in udf_init())
+      CAN-2005-0710 (arbitrary code execution via "CREATE FUNCTION")
+      Closes: #299029, #299031, #299065
+  * New Upstream Release.
+    - Fixes some server crash conditions.
+    - Upstream includes fix for TMPDIR overriding my.cnf tmpdir setting
+      Closes: #294347
+    - Fixes InnoDB error message. Closes: #298875
+    - Fixes resouce limiting. Closes: #285044
+  * Improved checking whether or not the server is alive in the init script
+    which should make it possible to run several mysqld instances in
+    different chroot environments. Closes: #297772
+  * Fixed cron script name as dots are not allowed (thanks to Michel
+    v/d Ven). Closes: #298447
+  * Added -O3 and --with-mysqld-ldflags=-all-static as MySQL recommends to
+    build the server binary statically in order to gain about 13% more
+    performance (thanks to Marcin Kowalski).
+  * Added patch to let mysqld_safe react to signals (thanks to Erich 
+    Schubert). Closes: #208364
+  * (Thanks to Sean Finney for doing a great share of work for this release!)
+
+ -- Christian Hammers <ch@debian.org>  Thu,  3 Mar 2005 02:36:39 +0100
+
+mysql-dfsg-4.1 (4.1.10-4) unstable; urgency=medium
+
+  * Fixed bug that prevented MySQL from starting after upgrades.
+    Closes: #297198, #296403
+  * Added comment about logging to syslog to the default my.cnf
+    and the logrotate script (thanks to Ryszard Lach). Closes: #295507
+
+ -- Christian Hammers <ch@debian.org>  Thu,  3 Mar 2005 00:28:02 +0100
+
+mysql-dfsg-4.1 (4.1.10-3) unstable; urgency=low
+
+  * Sean Finney: Cronjobs now exit silently when the server package
+    has been removed but not purged (thanks to Vineet Kumar).
+    Closes: #297404
+  * Fixed comments of /etc/mysql/debian-log-rotate.conf (thanks to
+    Philip Ross). Closes: #297467
+  * Made mysqld_safe reacting sane on signals (thanks to Erich Schubert).
+    Closes: #208364
+ 
+ -- Christian Hammers <ch@debian.org>  Tue,  1 Mar 2005 19:44:34 +0100
+
+mysql-dfsg-4.1 (4.1.10-2) unstable; urgency=low
+
+  * Converted to dpatch.
+  * debian/ is now maintained via Subversion on svn.debian.org. 
+
+ -- Christian Hammers <ch@debian.org>  Tue,  1 Mar 2005 02:16:36 +0100
+
+mysql-dfsg-4.1 (4.1.10-1) unstable; urgency=low
+
+  * New upstream version.
+  * Upstream fixed memleak bug. Closes: #205587
+  * Added debian/copyright.more for personal reference.
+  * Lowered default query cache size as suggested by Arjen from MySQL.
+  * Switched from log to log-bin as suggested by Arjen from MySQL.
+  * Fixed typo in my.cnf (thanks to Sebastian Feltel). Closes: #295247
+  * Replaced --defaults-extra-file by --defaults-file in Debian scripts
+    as former lets password/host etc be overwriteable by /root/.my.cnf.
+    Added socket to /etc/mysql/debian.cnf to let it work. (thanks to
+    SATOH Fumiyasu). Closes: #295170
+
+ -- Christian Hammers <ch@debian.org>  Tue, 15 Feb 2005 23:47:02 +0100
+
+mysql-dfsg-4.1 (4.1.9-4) unstable; urgency=low
+
+  * Improved the way mysqld is started and registered with update-rc.d
+    in cases where the admin modifies the runlevel configuration.
+    Most notably removed the debconf question whether or not mysql should
+    start on when booting. Closes: #274264
+  * Renamed configuration option old-passwords to the more preferred
+    naming convention old_passwords. Same for some others (thanks to
+    Patrice Pawlak). Closes: #293983
+
+ -- Christian Hammers <ch@debian.org>  Tue,  8 Feb 2005 02:21:18 +0100
+
+mysql-dfsg-4.1 (4.1.9-3) unstable; urgency=low
+
+  * Renamed ca_ES.po to ca.po to reach a broader audience (thanks to 
+    Christian Perrier). Closes: #293786 
+  * Expicitly disabled mysqlfs support as it has never been enabled by
+    configure during the autodetection but fails due to broken upstream
+    code when users try to build the package theirselves while having
+    liborbit-dev installed which triggers the mysqlfs autodetection
+    (thanks to Max Kellermann). Closes: #293431
+  * Added dependencies to gawk as one script does not work with original-awk
+    (thanks to Petr Ferschmann). Closes: #291634
+
+ -- Christian Hammers <ch@debian.org>  Sun,  6 Feb 2005 23:33:11 +0100
+
+mysql-dfsg-4.1 (4.1.9-2) unstable; urgency=high
+
+  * SECURITY:
+    For historical reasons /usr/share/mysql/ was owned and writable by
+    the user "mysql". This is a security problem as some scripts that
+    are run by root are in this directory and could be modified and used
+    by a malicious user who already has mysql privileges to gain full root
+    rights (thanks to Matt Brubeck). Closes: #293345
+  * Changed "skip-networking" to "bind-address 127.0.0.1" which is more
+    compatible and not less secure but maybe even more, as less people enable
+    networking for all interfaces (thanks to Arjen Lentz).
+  * Enabled InnoDB by default as recommended by Arjen Lentz from MySQL.
+  * Added remarks about hosts.allow to README.Debian (thanks to David
+    Chappell). Closes: #291300
+  * mysql-server-4.1 now provides mysql-server (thanks to Paul van den Berg).
+    Closes: #287735
+
+ -- Christian Hammers <ch@debian.org>  Wed,  2 Feb 2005 23:31:55 +0100
+
+mysql-dfsg-4.1 (4.1.9-1) unstable; urgency=low
+
+  * New upstream version.
+  * mysql-client-4.1 now provides "mysql-client" so that packages depending
+    on mysql-client (ca. 40) can now be used with MySQL-4.1, too.
+
+ -- Christian Hammers <ch@debian.org>  Sun, 23 Jan 2005 22:52:48 +0100
+
+mysql-dfsg-4.1 (4.1.8a-6) unstable; urgency=high
+
+  * SECURITY:
+    Javier Fernandez-Sanguino Pena from the Debian Security Audit Project
+    discovered a temporary file vulnerability in the mysqlaccess script of
+    MySQL that could allow an unprivileged user to let root overwrite
+    arbitrary files via a symlink attack and could also could unveil the
+    contents of a temporary file which might contain sensitive information.
+    (CAN-2005-0004, http://lists.mysql.com/internals/20600) Closes: #291122
+
+ -- Christian Hammers <ch@debian.org>  Tue, 18 Jan 2005 23:11:48 +0100
+
+mysql-dfsg-4.1 (4.1.8a-5) unstable; urgency=medium
+
+  * Fixed important upstream bug that causes from_unixtime(0) to return
+    NULL instead of "1970-01-01 00:00:00" which fails on NOT NULL columns.
+    Closes: #287792
+  * Fixes upstream bug in mysql_list_fields() . Closes: #282486
+  * Fixes bug that lead to double rotated logfiles when mysql-server 4.0
+    was previously installed (thanks to Olaf van der Spek). Closes: #289851
+  * Fixed typo in README.Debian (thanks to Mark Nipper). Closes: #289131
+  * Changed max_allowed_packet in my.cnf to 16M as in 4.0.x (thanks to
+    Olaf van der Spek). Closes: #289840
+  * Updated French debconf translation (thanks to Christian Perrier).
+    Closes: #287955
+
+ -- Christian Hammers <ch@debian.org>  Thu, 13 Jan 2005 01:29:05 +0100
+
+mysql-dfsg-4.1 (4.1.8a-4) unstable; urgency=low
+
+  * Broken patch again :-(
+
+ -- Christian Hammers <ch@debian.org>  Sun,  9 Jan 2005 23:47:55 +0100
+
+mysql-dfsg-4.1 (4.1.8a-3) unstable; urgency=low
+
+  * The mutex patch was a bit too x86 centric. This broke the alpha build.
+
+ -- Christian Hammers <ch@debian.org>  Sun,  9 Jan 2005 14:18:49 +0100
+
+mysql-dfsg-4.1 (4.1.8a-2) unstable; urgency=medium
+ 
+  * Some Makefiles that were patched by me got overwritten by the GNU
+    autotools, probably because I also patched ./configure. Fixed now,
+    the critical mutex patch is now back in again. Closes: #286961
+  * Added patch to make MySQL compile on ARM (thanks to Adam Majer).
+    Closes: #285071
+
+ -- Christian Hammers <ch@debian.org>  Thu,  6 Jan 2005 09:30:13 +0100
+
+mysql-dfsg-4.1 (4.1.8a-1) unstable; urgency=medium
+
+  * Upstream 4.1.8 had some problems in their GNU Autotools files so they
+    released 4.1.8a. Debian's 4.1.8 was fixed by running autoreconf but this
+    again overwrote MySQL changes to ltmain.sh which are supposed to fix some
+    problems on uncommon architectures (maybe the FTBFS on alpha, arm, m68k
+    and sparc?).
+  * libmysqlclient_r.so.14 from 4.1.8-3 also missed a link dependency to
+    libz which lead to unresolved symbols visible with "ldd -r" (thanks
+    to Laurent Bonnaud). Closes: #287573
+
+ -- Christian Hammers <ch@debian.org>  Wed, 29 Dec 2004 14:26:33 +0100
+
+mysql-dfsg-4.1 (4.1.8-3) unstable; urgency=low
+
+  * Fixed checking for error messages by forcing english language
+    output by adding LC_ALL=C to debian-start (thanks to Rene
+    Konasz) Closes: #285709
+  * Fixed bashisms in Debian scripts. Closes: #286863
+  * Updated Japanese Debconf translation (thanks to Hideki Yamane).
+    Closes: #287003
+  * Improved 4.0 to 4.1 upgrade if /var/lib/mysql is a symlink
+    (thanks to Thomas Lamy). Closes: #286560
+  * Added patch for FTBFS problem where no LinuxThreads can be found.
+    I don't know if this still applies but it should not hurt.
+    The patch is debian/patches/configure__AMD64-LinuxThreads-vs-NPTL.diff
+
+ -- Christian Hammers <ch@debian.org>  Sun, 26 Dec 2004 14:04:20 +0100
+
+mysql-dfsg-4.1 (4.1.8-2) unstable; urgency=low
+
+  * If /var/lib/mysql is a symlink then it is kept as such.
+  * Added the old-passwords option to the default my.cnf to stay
+    compatible to clients that are still compiled to libmysqlclient10
+    and libmysqlclient12 for licence reasons. 
+  * Adjusted tetex build-deps to ease backporting (thanks to Norbert
+    Tretkowski from backports.org).
+
+ -- Christian Hammers <ch@debian.org>  Tue, 21 Dec 2004 01:00:27 +0100
+
+mysql-dfsg-4.1 (4.1.8-1) unstable; urgency=medium
+
+  * New upstream version. Closes: #286175
+  * Added conflict to libmysqlclient-dev (thanks to Adam Majer).
+    Closes: #286538
+  * Added debconf-updatepo to debian/rules:clean.
+  * Updated Japanese Debconf translation (thanks to Hideki Yamane).
+    Closes: #285107
+  * Updated French Debconf translation (thanks to Christian Perrier).
+    Closes: #285977
+  * Renamed cz.po to cs.po (thanks to Miroslav Kure). Closes: #285438
+  * Aplied patch for changed server notice to debian-start (thanks to
+    Adam Majer). Closes: #286035
+  * Changed nice value in default my.cnf as nohup changed its behaviour
+    (thanks to Dariush Pietrzak). Closes: #285446
+  * Increased verbosity of preinst script in cases where it cannot stop
+    a running server (thanks to Jan Minar). Closes: #285982
+  * Splitted the code parts of /etc/mysql/debian-start to
+    /usr/share/mysql/debian-start.inc.sh (thanks to Jan Minar).
+    Closes: #285988
+
+ -- Christian Hammers <ch@debian.org>  Mon, 20 Dec 2004 00:33:21 +0100
+
+mysql-dfsg-4.1 (4.1.7-4) unstable; urgency=medium
+
+  * Removed OpenSSL support.
+    After a short discussion with MySQL, I decided to drop OpenSSL support as
+    1. MySQL started shipping their binaries without it, too and do not
+       seem to support it in favour of using a different library somewhen.
+    2. MySQL did not adjust their licence to grant permission to link
+       against OpenSSL.
+    3. Even if they did, third parties who use libmysqlclient.so often
+       do not realise licencing problems or even do not want OpenSSL.
+    (thanks to Jordi Mallach and the responders to MySQL bug #6924)
+    Closes: #283786
+  * debian/control: Improved depends and conflicts to mysql-4.0.
+
+ -- Christian Hammers <ch@debian.org>  Thu,  2 Dec 2004 22:02:28 +0100
+
+mysql-dfsg-4.1 (4.1.7-3) unstable; urgency=low
+
+  * Raised version to make it higher as the one in experimental. 
+
+ -- Christian Hammers <ch@debian.org>  Wed,  1 Dec 2004 21:09:20 +0100
+
+mysql-dfsg-4.1 (4.1.7-2) unstable; urgency=low
+
+  * Patched scripts/mysql_install_db so that it no longer creates a
+    passwordless test database during installation (thanks to Patrick
+    Schnorbus). Closes: #281158
+  * Added Czech debconf translation (thanks to Miroslav Kure).
+    Closes: #283222
+
+ -- Christian Hammers <ch@debian.org>  Wed,  1 Dec 2004 01:29:31 +0100
+
+mysql-dfsg-4.1 (4.1.7-1) unstable; urgency=low
+
+  * New upstream branch! 
+  * Adjusted debian/control to make this package suitable to get parallel
+    to version 4.0.x into unstable and sarge. The package names are
+    different so that "mysql-server" still defaults to the rock-stable
+    4.0 instead to this announced-to-be-stable 4.1.
+  * Added --with-mutex=i86/gcc-assemler to the Berkeley-DB configure
+    to prevent the use of NPLT threads when compiling under kernel 2.6
+    because the binaries are else not runable on kernel 2.4 hosts.
+    Closes: #278638, #274598 
+
+ -- Christian Hammers <ch@debian.org>  Sun, 31 Oct 2004 20:15:03 +0100
+
+mysql-dfsg (4.1.6-1) experimental; urgency=low
+
+  * New upstream version.
+  * Fixed symlinks in libmysqlclient-dev package. Closes: #277028
+  * This time I did not update the libtool files as they were pretty
+    up to date and I want to have a shorter diff file.
+
+ -- Christian Hammers <ch@debian.org>  Wed, 20 Oct 2004 00:07:58 +0200
+
+mysql-dfsg (4.1.5-3) experimental; urgency=low
+
+  * debian/postinst: mysql_install_db changed parameter from --IN-RPM
+    to --rpm which caused problems during installs. Closes: #276320
+
+ -- Christian Hammers <ch@debian.org>  Sat, 16 Oct 2004 20:36:46 +0200
+
+mysql-dfsg (4.1.5-2) experimental; urgency=low
+
+  * Activated support for ndb clustering (thanks to Kevin M. Rosenberg).
+    Closes: #275109
+
+ -- Christian Hammers <ch@debian.org>  Wed,  6 Oct 2004 01:58:00 +0200
+
+mysql-dfsg (4.1.5-1) experimental; urgency=low
+
+  * WARNING:
+    The upstream branch 4.1 is still considered BETA.
+    The Debian packages for 4.1 were done without big testing. If you miss
+    a new functionality or binary, contact me and I check add the relevant
+    configure option or include the program.
+  * New MAJOR upstream version.
+    Thanks to the great demand here's now the first MySQL 4.1 experimental
+    release. FEEDBACK IS WELCOME.
+  * 4.0->4.1 notes:
+    - debian/patches/alpha.diff could not be applied, I fix that later
+    - debian/patches/scripts__mysql_install_db.sh.diff was obsolete
+    - debian/patches/scripts__Makefile.in was neccessary due to a dependency
+      to the removed non-free Docs/ directory. Upstream has been contacted.
+    - Build-Deps: += automake1.7
+    - debian/rules: embedded servers examples did not compile, removed
+
+ -- Christian Hammers <ch@debian.org>  Sun, 26 Sep 2004 19:46:47 +0200
+
+mysql-dfsg (4.0.21-3) unstable; urgency=low
+
+  * Upstream tried to fix a security bug in mysqlhotcopy and broke it :-)
+    Applied a patch (see debian/patches) from Martin Pitt. Closes: #271632
+  * Between 4.0.20 and 4.0.21 the Debian specific changes in
+    /usr/bin/mysqld_safe that piped the error log to syslog got lost
+    and are now back again. 
+  * Fixed capitalization in debconf headings.
+  * Changed wording of the initscript status message to make heartbeat
+    happier. Closes: #271591
+
+ -- Christian Hammers <ch@debian.org>  Fri, 17 Sep 2004 18:42:25 +0200
+
+mysql-dfsg (4.0.21-2) unstable; urgency=medium
+
+  * The dependencies between mysql-client and libmysqlclient12 were
+    too loose, when upgrading only the client this can lead to non working
+    binaries due to relocation errors (thanks to Dominic Cleal).
+    Closes: #271803
+  * Fixed typo in mysqldump.1 manpage (thanks to Nicolas Francois).
+    Closes: #271334
+
+ -- Christian Hammers <ch@debian.org>  Wed, 15 Sep 2004 15:38:11 +0200
+
+mysql-dfsg (4.0.21-1) unstable; urgency=high
+
+  * SECURITY:
+    This upstream version fixes some security problems that might at least
+    allow a DoS attack on the server.
+    * Fixed an old bug in concurrent accesses to `MERGE' tables (even
+      one `MERGE' table and `MyISAM' tables), that could've resulted in
+      a crash or hang of the server. (Bug #2408)
+    * Fixed bug in privilege checking where, under some conditions, one
+      was able to grant privileges on the database, he has no privileges
+      on. (Bug #3933)
+    * Fixed crash in `MATCH ... AGAINST()' on a phrase search operator
+      with a missing closing double quote. (Bug #3870)
+    * Fixed potential memory overrun in `mysql_real_connect()' (which
+      required a compromised DNS server and certain operating systems).
+      (Bug #4017)
+  * New upstream version.
+    * Fixes bug that made x="foo" in WHERE sometimes the same as x="foo ".
+      Closes: #211618
+  * Updated Japanese Debconf translation (thanks to Hideki Yamane).
+    Closes: #271097
+
+ -- Christian Hammers <ch@debian.org>  Sat, 11 Sep 2004 23:15:44 +0200
+
+mysql-dfsg (4.0.20-14) unstable; urgency=low
+
+  * Dave Rolsky spottet that -DBIG_JOINS was not properly enabled.
+    It allowes joining 64 instead of an 32 tables to join.
+
+ -- Christian Hammers <ch@debian.org>  Thu,  9 Sep 2004 20:24:02 +0200
+
+mysql-dfsg (4.0.20-13) unstable; urgency=medium
+
+  * Fixed a bug in the initscript which caused the check for not properly
+    closed i.e. corrupt tables that is executed when the server starts
+    not to run in background as supposed.
+    Although the check does not repair anything on servers with several
+    thousand tables the script was reported to take some minutes which
+    is quite annoying. (Thanks to Jakob Goldbach). Closes: #270800
+
+ -- Christian Hammers <ch@debian.org>  Thu,  9 Sep 2004 17:11:05 +0200
+
+mysql-dfsg (4.0.20-12) unstable; urgency=medium
+
+  * Filter messages regarding table handles that do not support CHECK TABLE
+    in the script that checks for corrupted tables on every start which lead
+    to unnecessary mails (thanks to David Everly). Closes: #269811 
+  * Added a note to the corrupt-table-check mail which notes that a
+    false-positive is reported in the case that immediately after starting
+    the server a client starts using a table (thanks to Uwe Kappe).
+    Closes: #269985
+  * Added "quote-names" as default to the [mysqldump] section in
+    /etc/mysql/my.cnf as too many users stumble over dump files that
+    could not be read in again due to the valid use of reserved words
+    as table names. This has also be done by upstream in 4.1.1 and has
+    no known drawbacks. Closes: #269865
+  * Binary logs can now be rotated as well. Defaults to off, though, for
+    compatibilty reasons (thanks to Mark Ferlatte). Closes: #94230, #269110
+  * The mysql user "debian-sys-maint" now gets all possible rights which
+    makes binary logging possible and helps other package maintainer who
+    wants to use it to create package specific databases and users.
+  * Added example how to change daemon nice level via /etc/mysql/my.cnf
+  * Updated French debconf translations (thanks to Christian Perrier).
+    Closes: #265811
+  * Renamed options in the default config file that still had old names
+    (thanks to Yves Kreis). Closes: #266445
+  * Fixed spelling in debconf note.
+  * Added -l and -L to dh_shlibdeps.
+
+ -- Christian Hammers <ch@debian.org>  Fri,  3 Sep 2004 20:10:46 +0200
+
+mysql-dfsg (4.0.20-11) unstable; urgency=high
+
+  * SECURITY
+    This version fixes a security flaw in mysqlhotcopy which created
+    temporary files in /tmp which had predictable filenames and such
+    could be used for a tempfile run attack.
+    The issue has been recorded as CAN-2004-0457.
+
+ -- Christian Hammers <ch@debian.org>  Sat, 14 Aug 2004 18:27:19 +0200
+
+mysql-dfsg (4.0.20-10) unstable; urgency=low
+
+  * MySQL finally updated their copyright page and installed v1.5 of
+    the "Free/Libre and Open Source Software License (FLOSS) - Exception"
+    which will hopefully end the license hell they created by putting the
+    client libraries under GPL instead of LGPL which conflicts with PHP and
+    other software that used to link against MySQL.
+    The license text is not yet in any release MySQL version but visible
+    on their web site and copied into the debian/copyright file.
+    Special thanks to Zak Greant <zak@mysql.com> and the debian-legal list
+    for helping to solve this release critical problem.
+    Closes: #242449
+  * Updated Brazil debconf translation (thanks to Andre Luis Lopes).
+    Closes: #264233
+  * Updated Japanese debconf translation (thanks to Hideki Yamane).
+    Closes: #264620
+  * Fixed minor typo in debconf description (thanks to TROJETTE Mohammed
+    Adnene). Closes: #264840
+  * Improved init and preinst script which now detects stalled servers which
+    do no longer communicate but are present in the process list (thanks to
+    Henrik Johansson). Closes: #263215
+
+ -- Christian Hammers <ch@debian.org>  Mon,  9 Aug 2004 19:44:28 +0200
+
+mysql-dfsg (4.0.20-9) unstable; urgency=medium
+
+  * Partly reverted the last patch which gave the mysql-user
+    "debian-sys-maint" more rights as there are old versions of MySQL which
+    have fewer privlige columns. Now only those are set (thanks to Alan Tam).
+    Closes: #263111
+
+ -- Christian Hammers <ch@debian.org>  Tue,  3 Aug 2004 13:03:02 +0200
+
+mysql-dfsg (4.0.20-8) unstable; urgency=low
+
+  * The mysqlcheck that is started from the initscript will now be
+    backgrounded because it might else prevent the boot process to continue.
+    It also now notifies root by mail and syslog if a table is corrupt.
+  * The "debian-sys-maint" MySQL user now has almost full rights so that other
+    packages might use this account to create databases and user (thanks to
+    Andreas Barth). Closes: #262541
+  * Added paranoid rules for logcheck.
+
+ -- Christian Hammers <ch@debian.org>  Sun,  1 Aug 2004 21:00:55 +0200
+
+mysql-dfsg (4.0.20-8) unstable; urgency=low
+
+  * Upload stalled. Not released.
+
+ -- Christian Hammers <ch@debian.org>  Sun,  1 Aug 2004 20:27:55 +0200
+
+mysql-dfsg (4.0.20-7) unstable; urgency=medium
+
+  * Solved the upstream bug that error messages of the server are written
+    in a file that is then rotated away leaving mysqld logging effectively
+    to /dev/null. It now logs to a /usr/bin/logger process which puts the
+    messages into the syslog.
+    Modified files: /etc/init.d/mysql, /usr/bin/mysqld_safe and the 
+    logchecker files. Closes: #254070
+  * The initscript does no longer call mysqlcheck directly but via
+    /etc/mysql/debian-start which is a user customizable config script.
+  * Splitted the debconf "install and update notes" and only show them
+    when it is appropriate (thanks to Steve Langasek). Closes: #240515
+  * Added NEWS.Debian.
+  * Added hint to -DBIG_ROWS, which is currently not used, to README.Debian.
+  * Corrected typo in myisampack manpage (thanks to Marc Lehmann). 
+    Closes: #207090
+  * Added Catalan debconf translation (thanks to Aleix Badia i Bosch).
+    Closes: #236651
+
+ -- Christian Hammers <ch@debian.org>  Wed, 28 Jul 2004 01:41:51 +0200
+
+mysql-dfsg (4.0.20-6) unstable; urgency=low
+
+  * The build arch detected by configure was "pc-linux-gnu (i686)"
+    instead of "pc-linux-gnu (i386)". Was no problem AFAIK but
+    Adam Majer asked me to explicitly change it to i386. Closes: #261382
+  * Removed some unused shell scripts from /usr/share/mysql.
+  * Added lintian overrides.
+  * Removed rpath by using chrpath.
+
+ -- Christian Hammers <ch@debian.org>  Mon, 26 Jul 2004 00:17:12 +0200
+
+mysql-dfsg (4.0.20-5) unstable; urgency=medium
+
+  * The mysqlcheck in the init script is only called when the server
+    is really alive. Also, the mysql-user 'debian-sys-maint' now has
+    global select rights (thanks to Nathan Poznick). Closes: #261130 
+  * Moved the debconf question whether to remove the databases or not
+    from mysql-server.config to mysql-server.postrm so that it shows
+    up on purge time and not months earlier (thanks to Wouter Verhelst).
+    Closes: #251838
+
+ -- Christian Hammers <ch@debian.org>  Fri, 23 Jul 2004 22:41:13 +0200
+
+mysql-dfsg (4.0.20-4) unstable; urgency=low
+
+  * Added a "mysqlcheck -A --fast" to the 'start' section of the
+    init script to help admins detect corrupt tables after a server crash.
+    Currently it exists with an error message but leaves the server
+    running. Feedback appreciated!
+  * Made postinst script more robust by calling db_stop earlier and
+    so prevent pipe-deadlocks.
+  * Fixed minor typos in initscript (thanks to "C.Y.M."). Closes: 259518
+  * Added the undocumented "-DBIG_JOINS" that MySQL apparently uses in
+    their MAX binaries. It enables 62 instead of 30 tables in a "join".
+    (thanks to Dave Rolsky). Closes: #260843
+  * Added a "df --portability /var/lib/mysql/." check to the preinst
+    script as users experienced hard to kill hanging mysqlds in such
+    a situation (thanks to Vaidas Pilkauskas). Closes: #260306
+
+ -- Christian Hammers <ch@debian.org>  Fri, 23 Jul 2004 00:51:32 +0200
+
+mysql-dfsg (4.0.20-3) unstable; urgency=low
+
+  * Improved tolerance if the init script has been deleted (thanks to
+    Leonid Shulov for spotting the problem).
+  * Minor wording changes to README.Debian generalizing /root/ by $HOME
+    (thanks to Santiago Vila). Closes: #257725
+  * Added Japanese debconf translation (thanks to Hideki Yamane).
+    Closes: #256485
+  * Fixed commend in my.cnf regarding logfile directory (thanks to Jayen
+    Ashar). Closes: #253434
+  * Correted "ease to" by "ease of" in package description (thanks to
+    Johannes Berg). Closes: #253510 
+
+ -- Christian Hammers <ch@debian.org>  Fri,  9 Jul 2004 00:57:42 +0200
+
+mysql-dfsg (4.0.20-2) unstable; urgency=low
+
+  * Removed RPM .spec file from the included documentation as it is pretty
+    useless (thanks to Loic Minier).
+  * Added turkish debconf translation (thanks to Recai Oktas). Closes: #252802
+
+ -- Christian Hammers <ch@debian.org>  Sun,  6 Jun 2004 14:48:26 +0200
+
+mysql-dfsg (4.0.20-1) unstable; urgency=low
+
+  * New upstream version. 
+
+ -- Christian Hammers <ch@debian.org>  Mon, 31 May 2004 23:36:39 +0200
+
+mysql-dfsg (4.0.18-8) unstable; urgency=low
+
+  * Updated french translation (thanks to Christian Perrier). Closes: #246789
+
+ -- Christian Hammers <ch@debian.org>  Tue,  4 May 2004 23:26:54 +0200
+
+mysql-dfsg (4.0.18-7) unstable; urgency=low
+
+  * Added CVE ids for the recent security fixes.
+    4.0.18-4 is CAN-2004-0381 (mysqlbug) and
+    4.0.18-6 is CAN-2004-0388 (mysql_multi)
+
+ -- Christian Hammers <ch@debian.org>  Mon, 19 Apr 2004 18:32:03 +0200
+
+mysql-dfsg (4.0.18-6) unstable; urgency=medium
+
+  * SECURITY:
+    Fixed minor tempfile-run security problem in mysqld_multi.
+    Unprivileged users could create symlinks to files which were then
+    unknowingly overwritten by run when this script gets executed.
+    Upstream informed. Thanks to Martin Schulze for finding this.
+
+ -- Christian Hammers <ch@debian.org>  Wed,  7 Apr 2004 01:28:22 +0200
+
+mysql-dfsg (4.0.18-5) unstable; urgency=low
+
+  * Little improvements in debian scripts for last upload. 
+  * Added check to logrotate script for the case that a mysql
+    server is running but not be accessible with the username and
+    password from /etc/mysql/debian.conf (thanks to Jeffrey W. Baker).
+    Closes: 239421
+
+ -- Christian Hammers <ch@debian.org>  Sun,  4 Apr 2004 15:27:40 +0200
+
+mysql-dfsg (4.0.18-4) unstable; urgency=medium
+
+  * SECURITY: 
+    Aplied fix for unprobable tempfile-symlink security problem in 
+    mysqlbug reported by Shaun Colley on bugtraq on 2004-03-24.
+  * Updated french debconf translation (thanks to Christian Perrier).
+    Closes: #236878 
+  * Updated portugesian debconf translation (thanks to Nuno Senica).
+    Closes: #239168
+  * Updated german debconf translation (thanks to Alwin Meschede).
+    Closes: #241749
+  * Improved debconf template regarding fix_privileges_tables (thanks 
+    to Matt Zimmermann for suggestions). Closes: #219400
+  * Improved README.Debian regarding to password settings (thanks to
+    Yann Dirson). Closes: #241328
+
+ -- Christian Hammers <ch@debian.org>  Sat,  3 Apr 2004 19:52:15 +0200
+
+mysql-dfsg (4.0.18-3) unstable; urgency=medium
+
+  * Added Build-Depend to po-debconf to let it build everywhere.
+
+ -- Christian Hammers <ch@debian.org>  Wed, 31 Mar 2004 23:43:33 +0200
+
+mysql-dfsg (4.0.18-2) unstable; urgency=low
+
+  * Added a "2>/dev/null" to a "which" command as there are two
+    "which" versions in Debian of which one needs it. Closes: #235363
+
+ -- Christian Hammers <ch@debian.org>  Tue,  2 Mar 2004 23:31:28 +0100
+
+mysql-dfsg (4.0.18-1) unstable; urgency=low
+
+  * New upstream version.
+  * Should now compile and run on ia64 (thanks to Thorsten Werner and
+    David Mosberger-Tang). Closes: #226863 #228834 
+  * Converted init scripts to invoce-rc.d (thanks to Erich Schubert).
+    Closes: 232118 
+  * Secondlast upload changed logfile location. Closes: #182655
+  * Updated Brasilian translation (thanks to Andre Luis Lopes). Closes:
+    #219847
+
+ -- Christian Hammers <ch@debian.org>  Tue, 17 Feb 2004 23:44:58 +0100
+
+mysql-dfsg (4.0.17-2) unstable; urgency=low
+
+  * Improved manpage for mysqldumpslow.1 (thanks to Anthony DeRobertis).
+    Closes: #231039
+  * Improved stopping of crashed daemons in init script (thanks to
+    Matthias Urlichs). Closes: #230327
+
+ -- Christian Hammers <ch@debian.org>  Mon,  9 Feb 2004 21:54:29 +0100
+
+mysql-dfsg (4.0.17-1) unstable; urgency=low
+
+  * Made logging into /var/log/mysql/ the default. Closes: #225206
+ 
+  * New upstream version. Closes: #225028
+  * Turned on a 25MB query cache by default (thanks to Cyril Bouthors).
+    Closes: #226789
+  * Updated russian translation (thanks to Ilgiz Kalmetev). Closes: #219263
+  * Upstream fixes the problem that AND was not commutative (thanks for
+    Iain D Broadfoot for mentioning). Closes: #227927
+  * Fixed minor typo in my.cnf comments (thanks to James Renken). 
+    Closes: #221496
+  * Better documents regex. Closes: #214952
+  * Fixed minor germanism in debconf template (thanks to Marc Haber).
+    Closes: #224148
+  * Added explaining comment to my.cnf regarding quoted passwords 
+    (Thanks to Patrick von der Hagen). Closes: #224906
+  * Changed "find -exec" to "find -print0 | xargs -0" in preinst to
+    speed it up. Thanks to Cyril Bouthors. Closes: #220229
+
+ -- Christian Hammers <ch@debian.org>  Sun, 18 Jan 2004 16:16:25 +0100
+
+mysql-dfsg (4.0.16-2) unstable; urgency=low
+
+  * Tried to repair undefined weak symbols by adding a little Makefile
+    patch. Closes: #215973
+
+ -- Christian Hammers <ch@debian.org>  Mon, 27 Oct 2003 22:52:10 +0100
+
+mysql-dfsg (4.0.16-1) unstable; urgency=low
+
+  * New upstream release.
+    (Mostly little memory problems and other bugfixes it seems)
+  * Replaced "." by ":" in chown calls to comply with the env setting
+  	"_POSIX2_VERSION=2000112" (thanks to Robert Luberda). Closes: #217399
+  * Adjusted syntax in my.cnf to 4.x standard (thanks to Guillaume Plessis).
+    Closes: #217273
+  * Improved README.Debian password instructions (thanks to Levi Waldron).
+    Closes: #215046
+  * Improved NIS warning debconf-template (thanks to Jeff Breidenbach).
+    Closes: #215791
+  * Explicitly added libssl-dev to the libmysqlclient-dev package as it
+    is needed for mysql_config and the libmysqlclient package only depends
+    on libssl which has no unnumbered .so version (thanks to Simon Peter
+    and Davor Ocelic). Closes: #214436, #216162
+  * Added "-lwrap" to "mysql_config --libmysqld-libs" and filed it as
+    upstream bug #1650 (thanks to Noah Levitt). Closes: #214636
+
+ -- Christian Hammers <ch@debian.org>  Sat, 25 Oct 2003 01:09:27 +0200
+
+mysql-dfsg (4.0.15a-1) unstable; urgency=low
+
+  * Same package as 4.0.15-2 but I could not convince the Debian
+    installer to move the packages out of incoming.
+
+ -- Christian Hammers <ch@debian.org>  Tue,  7 Oct 2003 15:10:26 +0200
+
+mysql-dfsg (4.0.15-2) unstable; urgency=low
+
+  * Updated package description (thanks to Adrian Bunk). Closes: #210988 
+  * Fixed small typos in manpages (thanks to Nicolas Francois).
+    Closes: #211983
+  * More updates to package description (thanks to Matthias Lutz/ddtp).
+    Closes: #213456
+  * Updated standards to 3.6.1.
+  * Closes "new 4.0.15 available" bug. Closes: #213349
+  * Updated README.Debian with notes regarding the MySQL manual section
+    "2.4 Post-installation Setup and Testing" (thanks to Daniel B.).
+    Closes: #210841
+
+ -- Christian Hammers <ch@debian.org>  Fri,  3 Oct 2003 15:59:39 +0200
+
+mysql-dfsg (4.0.15-1) unstable; urgency=high
+
+  * SECURITY:
+    Users who are able to use the "ALTER TABLE" command on the "mysql"
+    database may be able to exploit this vulnerability to gain a shell with
+    the privileges of the mysql server (usually running as the 'mysql' user).
+    Closes: #210403
+  * Fixes small description typos (thanks to Oscar Jarkvik).
+  * Updated Brazilian Portuguese debconf translation. (thanks to Andre Luis
+    Lopes). Closes: 208030
+  * Replaced depricated '.' by ':' in chown (thanks to Matt Zimmerman).
+  * Fixed manpage typo (thanks to Marc Lehmann). Closes: #207090
+
+ -- Christian Hammers <ch@debian.org>  Fri,  3 Oct 2003 15:59:35 +0200
+
+mysql-dfsg (4.0.14-1) unstable; urgency=low
+
+  * New upstream version. 
+
+ -- Christian Hammers <ch@debian.org>  Sun, 24 Aug 2003 16:40:36 +0200
+
+mysql-dfsg (4.0.13-3) unstable; urgency=low
+
+  * Now start mysqld as default unless you choose not when configurig
+    with debconf priority low. So packages depending on the server when
+    installing can access it. Thanks Matt Zimmermann (Closes: #200277)
+  * Made mysql-server de-installable if the config and database files were
+    removed by hand before. Thanks to Ard van Breemen (Closes: #200304)
+
+ -- Christian Hammers <ch@debian.org>  Tue,  8 Jul 2003 22:30:40 +0200
+
+mysql-dfsg (4.0.13-2) unstable; urgency=low
+
+  * Added "nice" option for mysqld_safe to give mysqld a different priority.
+    Submitted to upstream as MySQL Bug #627. Closes: #192087
+  * Fixed possible unbound variable in init script. Closes: #194621
+  * Fixed french debconf translation (thx Christian Perrier) Closes: #194739
+  * Get rid of automake1.5 (for Eric Dorland). 
+
+ -- Christian Hammers <ch@debian.org>  Wed, 11 Jun 2003 18:58:32 +0200
+
+mysql-dfsg (4.0.13-1) unstable; urgency=medium
+
+  * New upstream version.
+    !!! Fixes a very bad natural join bug which justifies the urgency=medium.
+    !!! http://bugs.mysql.com/bug.php?id=291
+  * Fixed mysql_fix_privileges manpage (Frederic Briere) Closes: #191776
+  * preinst: "which" is more chatty normal executable than as builtin.
+    (Thanks to David B Harris). Closes: #188659
+
+ -- Christian Hammers <ch@debian.org>  Tue,  6 May 2003 22:03:45 +0200
+
+mysql-dfsg (4.0.12-3) unstable; urgency=medium
+
+  * Reincluded new way of creating my debian-sys-maint user from
+    an old release from experimental. Now works again with old
+    and new privilege table format. (Thanks to Vincent Danjean
+    for spotting the problem) Closes: #188201
+  * Reincluded hurd build dependency fix from 3.23 branch.
+    (Thanks to Robert Millan). Closes: #185929
+  * Fixed soname in libmysqlclient-dev.  Closes: #188160
+  * Remove /var/log/mysql/ when purging the package. Closes: #188064
+  * Removed /usr/share/doc/mysql/ from mysql-server. Closes: #188066
+  * Let group "adm" be able to read logfiles. Closes: #188067
+  * Do not call usermod on every upgrade. Closes: #188248
+    (Thanks to Philippe Troin for the last three)
+  * Fixed mysql-server.preinst so that it works on shells where 
+    which is a builtin, too. (Thanks to Erich Schubert) Closes: #181525
+
+ -- Christian Hammers <ch@debian.org>  Fri, 11 Apr 2003 11:32:45 +0200
+
+mysql-dfsg (4.0.12-2) unstable; urgency=low
+
+  *
+  * NEW MAJOR UPSTREAM RELEASE:
+  *
+    MySQL 4 has finally been declared as 'stable'. Hurray! Read changelogs.
+    Thanks to all testers, esp. Jose Luis Tallon, of the versions
+    that were in the "experimental" section before.
+  * Modified postinst script to run mysql_fix_privileges on every update.
+    IMPORTANT: Please report if this breaks anything, it is not supposed to.
+  * Wrote a SSL-MINI-HOWTO.txt!
+  * Added zlib1g-dev to libmysqlclient12-dev. Closes: 186656
+  * Changed section of libmysqlclient12-dev to libdevel.
+  * Added even more selfwritten manpages.
+  * Fixed typos.
+
+ -- Christian Hammers <ch@debian.org>  Sun,  6 Apr 2003 13:47:32 +0200
+
+mysql-dfsg (4.0.10.gamma-1) experimental; urgency=low
+
+  * New upstream version.
+  * They merged some of my patches from debian/patches. Whoa!
+  * This release should fix the error-logfile problem where mysqld
+    keeps the error.log open while logrotate removes it.
+
+ -- Christian Hammers <ch@debian.org>  Wed, 12 Feb 2003 22:39:48 +0100
+
+mysql-dfsg (4.0.9.gamma-1) experimental; urgency=low
+
+  * New upstream version. 
+  * Updated the GNU autoconf files to make building on MIPS work.
+    See bug #176829.
+
+ -- Christian Hammers <ch@debian.org>  Wed, 29 Jan 2003 22:07:44 +0100
+
+mysql-dfsg (4.0.8.gamma-1) experimental; urgency=low
+
+  * New upstream release. 
+  * Improved logging of init script. Closes: #174790
+  * We have now libmysqlclient.so.12 instead of .11.
+
+ -- Christian Hammers <ch@debian.org>  Thu,  9 Jan 2003 20:14:11 +0100
+
+mysql-dfsg (4.0.7.gamma-1) experimental; urgency=high
+
+  * SECURITY: This version fixes an upstream security release that is only
+              present in the 4.x branch which is currently only in the
+              experimental distribution and therefore will not get a DSA. 
+  * New upstream release.
+
+ -- Christian Hammers <ch@debian.org>  Sat, 28 Dec 2002 15:51:39 +0100
+
+mysql-dfsg (4.0.6.gamma-2) experimental; urgency=low
+
+  * Added --system to addgroup. Closes: #173866
+
+ -- Christian Hammers <ch@debian.org>  Sat, 21 Dec 2002 15:28:26 +0100
+
+mysql-dfsg (4.0.6.gamma-1) experimental; urgency=low
+
+  * New upstream version. Now Gamma!
+  * There are no longer changes to the .orig.tar.gz neccessary to make diff
+    happy. docs/ has still to be deleted, although, as it is non-free.
+  * Incorporated patches from unstable.
+  * Added mysqlmanager and a couple of other new scripts.
+  * Enabled libmysqld embedded server library.
+  * Enabled SSL and Virtual-IO support.
+    (CORBA based MySQL-FS seems to be not existing..)
+
+ -- Christian Hammers <ch@debian.org>  Fri, 20 Dec 2002 22:30:51 +0100
+
+mysql-dfsg (4.0.5a.beta-3) experimental; urgency=low
+
+  * Modified postinst to work with old and new mysql.user table format
+    and fixed spelling typo in postinst. Thanks to Roger Aich.
+  * Updated config.{guess,sub} to make the mipsel porters happy.
+    Thanks to Ryan Murray. Closes: #173553
+
+ -- Christian Hammers <ch@debian.org>  Wed, 18 Dec 2002 15:56:34 +0100
+
+mysql-dfsg (4.0.5a.beta-2) experimental; urgency=low
+
+  * Upstream removed option "--skip-gemini". So did I. Closes: 173142
+
+ -- Christian Hammers <ch@debian.org>  Tue, 17 Dec 2002 10:35:49 +0100
+
+mysql-dfsg (4.0.5a.beta-1) experimental; urgency=low
+
+  * First 4.x experimental package due to continuous user requests :-)
+    Please test and report!
+  * upstream: safe_mysqld has been renamed to mysqld_safe
+  * upstream: new library soname version libmysqlclient.so.11
+  * Renamed libmysqlclientXX-dev to libmysqlclient-dev as I don't plan to
+    support more than one development environment and this makes the 
+    dependencies easier.
+  * FIXME: Skipped parts of the debian/patches/alpha patch as the global.h 
+    is not existing.
+  * FIXME: How to get rid this? Old ltconfig patch already applied.
+    "lintian: binary-or-shlib-defines-rpath ./usr/bin/mysql /usr/lib/mysql"
+
+ -- Christian Hammers <ch@debian.org>  Sun,  1 Dec 2002 18:32:32 +0100
+
+mysql-dfsg (3.23.53-4) unstable; urgency=medium
+
+  * Fixed errno.h problem. Closes: #168533, #168535 
+
+ -- Christian Hammers <ch@debian.org>  Sun, 10 Nov 2002 18:32:08 +0100
+
+mysql-dfsg (3.23.53-3) unstable; urgency=medium
+
+  * Changed automake build-dep to unversioned automake1.4. Closes: #166391
+  * Fixed description. Closes: #167270
+    (Thanks to Soren Boll Overgaard)
+
+ -- Christian Hammers <ch@debian.org>  Tue,  5 Nov 2002 01:25:01 +0100
+ 
+mysql-dfsg (3.23.53-2) unstable; urgency=low
+
+  * Reverted user creation in init scripts. Closes: #166432
+    (Thanks to Birzan George Cristian) 
+
+ -- Christian Hammers <ch@debian.org>  Thu, 31 Oct 2002 15:36:25 +0100
+
+mysql-dfsg (3.23.53-1) unstable; urgency=low
+
+  * New upstream release. 
+
+ -- Christian Hammers <ch@debian.org>  Thu, 24 Oct 2002 23:04:16 +0200
+
+mysql-dfsg (3.23.52-3) unstable; urgency=low
+
+  * Substituted the first-install 'debian-sys-maint' user creation by
+    something ANSI SQL compliant. Closes: #163497
+    (Thanks to Karl Hammar)
+  * Tightend dependency to debhelper (>= 4.0.12) to be sure that
+    debconf-utils gets installed, too, as I use dh_installdebconf.
+  * Fixed upstream manpage bug in mysqldump.1. Closes: #159779
+    (Thanks to Colin Watson) 
+  * Added comment about MIN_WORD_LEN to mysql-server.README.Debian
+    (Thanks to Philipp Dreimann)
+  * Added a dependency for zlib1g-dev to libmysqlclient10-dev.
+    (Thanks to Jordi Mallach)
+
+ -- Christian Hammers <ch@debian.org>  Sun, 15 Sep 2002 17:14:44 +0200
+
+mysql-dfsg (3.23.52-2) unstable; urgency=low
+
+  * Fixed typo in preinst scripts.
+  * Removed bashism in init script.
+  * Fixed ambiguous debconf example. Closes: #158884
+
+ -- Christian Hammers <ch@debian.org>  Fri, 30 Aug 2002 00:51:29 +0200
+
+mysql-dfsg (3.23.52-1) unstable; urgency=low
+
+  * New upstream version. Closes: #157731
+  * Clearified the meaning of the debian-sys-maint special user in the
+    README.Debian file. Closes: #153702
+  * Wrote some words regarding the skip-networking in README.Debian.
+    Closes: #157038
+  * Added dependency to passwd. 
+  * Fixes typo and unnecessarily complication in is_mysql_alive().
+  * Added check for /etc/mysql/my.cnf in init script.
+
+ -- Christian Hammers <ch@debian.org>  Tue, 27 Aug 2002 01:53:32 +0200
+
+mysql-dfsg (3.23.51-4) unstable; urgency=low
+
+  * Added a compressed "nm mysqld" output to allow people to trace
+    core dumps with /usr/bin/resolve_stack_dump as suggested in the
+    INSTALL-SOURCE file. Thanks to atudor@labs.agilent.com for the hint.
+
+ -- Christian Hammers <ch@debian.org>  Wed, 24 Jul 2002 20:44:55 +0200
+
+mysql-dfsg (3.23.51-3) unstable; urgency=low
+
+  * Corrected copyright file: the MySQL client library is licenced under
+    the LGPL-2 not the GPL. From version 4.x it actually will be GPL this
+    is why parts of http://www.mysql.com/ already say so. Closes: #153591
+  * Corrected german translation.
+    Thanks to Roland Rosenfeld <roland@spinnaker.de>. Closes: #151903 
+
+ -- Christian Hammers <ch@debian.org>  Thu, 11 Jul 2002 20:32:28 +0200
+
+mysql-dfsg (3.23.51-2) unstable; urgency=low
+
+  * Improved NIS tolerance in preinst script. 
+
+ -- Christian Hammers <ch@debian.org>  Sun,  7 Jul 2002 04:43:28 +0200
+
+mysql-dfsg (3.23.51-1) unstable; urgency=medium
+
+  * New upstream version.
+  * I applied a patch that fixes a binary imcompatibility in
+    the shared libary libmysqlclient.so.10 between 3.23.50 and
+    some versions earlier. Upstream has been contacted and asked
+    for clarification. Closes: #149952
+  * Added support for NIS i.e. it shows a warning and fails if the
+    needed 'mysql' user does not exists but works if it does.
+    Closes: #143282, #147869
+  * Substituted $0 in init scripts by something really weird so that
+    "./S20mysql restart" works now, too. (BTW: S20? install file-rc!!!)
+    Closes: #148658
+  * Now postinst works even if /etc/init.d/mysql is removed. Closes: #151021
+  * Decided to leave "set +x" in postinst but wrote comment. Closes: #151022
+
+ -- Christian Hammers <ch@debian.org>  Sun,  7 Jul 2002 04:43:25 +0200
+
+mysql-dfsg (3.23.50-1) unstable; urgency=medium
+
+  * New upstream version.
+    Fixes a very annoying and important bug that lets all mysql programs
+    including perl scripts etc. segfault when using the read_default_group()
+    function. 3.23.50 is currently a pre-release and expected to be released
+    next week. I plan to propose it for woody as soon as its stability has
+    been proven. The following bug reports are all regarding this issue.
+    Closes: #144960, #145322, #136798, #138143,
+
+ -- Christian Hammers <ch@debian.org>  Sat, 18 May 2002 21:14:01 +0200
+
+mysql-dfsg (3.23.49x-1) unstable; urgency=low
+
+  * I had to split the package to seperate the manual as it is not GPL
+    like the rest of the software and docs but under a license that
+    e.g. forbids selling printed versions. 
+    .
+    The upstream authors were contacted a while ago but did not like to
+    change the situation.
+    .
+    The names of the resulting packages have not changed as the manual
+    already was in a seperate mysql-doc package due to it's size. 
+    The source packages are now splitted from one "mysql" to 
+    "mysql-dfsg" in main and "mysql-nonfree" in non-free.
+  * No code change! 
+    The "x" at the end of the version number ist just to be able to 
+    upload a new source package. ("a" was already taken by upstream 
+    for their binary upload correction)  
+
+ -- Christian Hammers <ch@debian.org>  Wed,  8 May 2002 02:01:41 +0200
+
+mysql (3.23.49-8) unstable; urgency=low
+
+  * Substituted $0 in init script to let e.g. "/etc# ./init.d/mysql restart"
+    works, too. Closes: #141555
+
+ -- Christian Hammers <ch@debian.org>  Sun,  7 Apr 2002 15:00:44 +0200
+
+mysql (3.23.49-7) unstable; urgency=low
+
+  * The Makefiles are totally broken for the --enable-local-infile
+    option. I now patched libmysql/libmysql.c#mysql_init() manually.
+    Closes: #138347 
+
+ -- Christian Hammers <ch@debian.org>  Fri, 29 Mar 2002 23:55:15 +0100
+
+mysql (3.23.49-6) unstable; urgency=low
+
+  * Moved mysqlcheck from server to client package. Closes: #139799
+  * Added manpage for mysqlhotcopy. Regarding: #87097 
+  * Added 'sharedscripts' directive to the logrotate script.
+  * Replaced grep by /usr/bin/getent to let the group/user checking work
+    on NIS/LDAP systems, too. Closes: #115677, #101529
+
+ -- Christian Hammers <ch@debian.org>  Fri, 22 Mar 2002 22:40:51 +0100
+
+mysql (3.23.49-5) unstable; urgency=low
+
+  * Added skip-innodb to default my.cnf.
+  * Enabled --enable-local-infile, it seems to be a new option that
+    defaults to disable a formerly enabled feaure. Closes: #137115
+
+ -- Christian Hammers <ch@debian.org>  Sat, 16 Mar 2002 00:29:10 +0100
+
+mysql (3.23.49-4) unstable; urgency=medium
+
+  * Recompiled against fixed libz.
+
+  * Enabled --enable-local-infile, it seems to be a new option that
+    defaults to disable a formerly enabled feaure. Closes: #137115
+  * Fixed README.compile_on_potato. Closes: #136529 
+  * Now a ext3 .jounal file in /var/lib/mysql does not prevent the
+    installation (happens when creating a jounal on an already mounted
+    partition). Closes: #137146
+
+ -- Christian Hammers <ch@debian.org>  Wed, 13 Mar 2002 13:34:24 +0100
+
+mysql (3.23.49-3) unstable; urgency=low
+
+  * Added Russian translation. Closes: #135846
+  * Fixed installation of .info documents. Closes: #135030
+
+ -- Christian Hammers <ch@debian.org>  Wed, 27 Feb 2002 23:36:35 +0100
+
+mysql (3.23.49-2) unstable; urgency=low
+
+  * Updated french translation and split template files. Closes: #134754 
+  * Fixed a small debian.cnf related bug in mysql-server.postinst.
+
+ -- Christian Hammers <ch@debian.org>  Tue, 19 Feb 2002 23:13:58 +0100
+
+mysql (3.23.49-1) unstable; urgency=low
+
+  * New upstream release.
+    (Mainly InnoDB related fixes)
+  * Exported a $HOME variable in the scripts so that /root/.my.cnf
+    is not read anymore. This will avoid problems when admins put 
+    only passwords but no usernames in this file. Closes: #132048
+  * New debian-sys-maint password algorithm (now ~96bit :-)) Closes: #133863
+  * Recreating debian-sys-main pwd on every install to help people who
+    accidently delete user or password files...
+  * Added /var/log/mysql so that user can put the binary logs in there as
+    mysql cannot write the .001 etc files itself in /var/log which is 
+    owned by root.
+
+ -- Christian Hammers <ch@debian.org>  Thu, 14 Feb 2002 22:17:45 +0100
+
+mysql (3.23.47-6) unstable; urgency=low
+
+  * Dropped a sentence about the new debian-sys-maint user in the
+    debconf note and updated the README.Debian.  Related: #132048
+  * Added more french translation. Closes: #132390 
+
+ -- Christian Hammers <ch@debian.org>  Wed,  6 Feb 2002 09:41:29 +0100
+
+mysql (3.23.47-5) unstable; urgency=low
+
+  * Fixed grammar error in template. Closes: #132238 
+  * Really fixed typo in logrotate script. Closes: #131711
+
+ -- Christian Hammers <ch@debian.org>  Tue,  5 Feb 2002 14:20:08 +0100
+
+mysql (3.23.47-4) unstable; urgency=medium
+
+  * Fixes typo in postinst that let init script fail. Closes: #131743
+  * Fixed bashism bug that failed on ash. Closes: #131697
+  * Fixed typo in logrotate script. Closes: #131711
+
+ -- Christian Hammers <ch@debian.org>  Thu, 31 Jan 2002 23:58:46 +0100
+
+mysql (3.23.47-3) unstable; urgency=low
+
+  * Added new Debian specific mysql user called 'debian-sys-maint' which
+    is used for pinging the server status, flushing the logs or shutting
+    down the server in maintenance scripts. The credentials of this user
+    are stored in the UID0-only readable file /etc/mysql/debian.cnf.
+    Closes: #129887, #130326, #99274
+  * Fixed unintended server startup at boottime. Closes: #122676, #130105
+  * New upstream fixes command line parsing bug: Closes: #128473
+  * Fixed manpage headers to let apropos work: Closes: #119122
+  * Added "status" options for /etc/init.d/mysql. Closes: #129020
+
+ -- Christian Hammers <ch@debian.org>  Sun, 27 Jan 2002 19:46:11 +0100
+
+mysql (3.23.47-2) unstable; urgency=low
+
+  * Enhanced init scripts by using mysqladmin instead of kill $pid.
+    Thanks to Aaron Brick. 
+
+ -- Christian Hammers <ch@debian.org>  Fri, 18 Jan 2002 01:42:23 +0100
+
+mysql (3.23.47-1) unstable; urgency=low
+
+  * New upstream release.
+  * Updated brazilian translation of debconf descriptions. Closes: #123332
+
+ -- Christian Hammers <ch@debian.org>  Sun,  6 Jan 2002 21:11:17 +0100
+
+mysql (3.23.46-3) unstable; urgency=low
+
+  * Fixed bug in postinst where a script was accidently called with
+    "bash -c <script> -IN_RPM" prevting the first argument to take effect
+    and then leading to failures on hosts with unresolvable hostnames.
+    Closes: #126147
+  * Small changes and comments in postinst. 
+
+ -- Christian Hammers <ch@debian.org>  Sat, 22 Dec 2001 14:03:02 +0100
+
+mysql (3.23.46-2) unstable; urgency=low
+
+  * Start/stop behaviour now configurable via debconf. Closes: #112174 
+
+ -- Christian Hammers <ch@debian.org>  Sun,  9 Dec 2001 21:38:54 +0100
+
+mysql (3.23.46-1) unstable; urgency=low
+
+  * New upstream release. 
+    Only few fixes, mainly innodb related. 
+
+ -- Christian Hammers <ch@debian.org>  Sun,  2 Dec 2001 03:08:48 +0100
+
+mysql (3.23.45-1) unstable; urgency=low
+
+  * New upstream version. 
+    Only few fixes, mainly innodb related. 
+  * Added debconf note regarding the skip-networking option.
+
+ -- Christian Hammers <ch@debian.org>  Sun, 25 Nov 2001 16:50:37 +0100
+
+mysql (3.23.44-2) unstable; urgency=low
+
+  * Finally removed debconf toggled "skip-networking" line add/remove 
+    code for /etc/mysql/my.cnf. I don't like editing a file that's tagged
+    as configuration file.
+    I disabled networking by default for security reasons. Better ideas?
+
+ -- Christian Hammers <ch@debian.org>  Fri, 16 Nov 2001 02:11:02 +0100
+
+mysql (3.23.44-1) unstable; urgency=low
+
+  * New upstream release.
+    - fixes replication bug (core dump)
+  * Made description better english :) Thanks to D. Welton. 
+
+ -- Christian Hammers <ch@debian.org>  Sun, 11 Nov 2001 15:44:07 +0100
+
+mysql (3.23.43-4) unstable; urgency=low
+
+  * Disabled statically linking. 
+
+ -- Christian Hammers <ch@debian.org>  Sat, 10 Nov 2001 03:15:56 +0100
+
+mysql (3.23.43-3) unstable; urgency=low
+
+  * Changed compiler settings after one user reported instabilities.
+    See #116631 for more information. 
+
+ -- Christian Hammers <ch@debian.org>  Tue, 30 Oct 2001 21:39:17 +0100
+
+mysql (3.23.43-2) unstable; urgency=low
+
+  * Patched sparc mutexes again. Closes: #113430 
+
+ -- Christian Hammers <ch@debian.org>  Sun,  7 Oct 2001 15:09:00 +0200
+
+mysql (3.23.43-1) unstable; urgency=low
+
+  * New upstream version.
+    - Fixed some unlikely(sic!) bugs and core dumps.
+    - Fixed a bug with BDB tables and UNIQUE columns that are NULL.
+    - [more minor bugs were fixed; see changelog]
+  * Adjusted build depends on libwrap0 for IA-64. Closes: #114582
+  * Added the mysqlcheck binary. Closes: #114490
+  * Fixed rules for arm architecture. Closes: #88186
+  * Renamed mysql_print_defaults to the original name my_print_defaults.
+    Isn't as descriptive but else I'd have to patch too much. Closes: #114492
+
+ -- Christian Hammers <ch@debian.org>  Fri,  5 Oct 2001 22:24:40 +0200
+
+mysql (3.23.42-2) unstable; urgency=low
+
+  * Applied patch for m68k compile. Closes: #112904 
+
+ -- Christian Hammers <ch@debian.org>  Sun, 23 Sep 2001 21:32:57 +0200
+
+mysql (3.23.42-1) unstable; urgency=low
+
+  * New upstream releae.
+    Fixes critical bug with InnoDB and large BLOBs. 
+
+ -- Christian Hammers <ch@debian.org>  Tue, 18 Sep 2001 22:25:47 +0200
+
+mysql (3.23.41-2) unstable; urgency=low
+
+  * Fixed shlibs.local problem. Closes: #111573 
+  * Replaced emacs by sensible-editor in mysqlbug.sh. Thanks Hans Ginzel.
+
+ -- Christian Hammers <ch@debian.org>  Sun,  9 Sep 2001 17:16:42 +0200
+
+mysql (3.23.41-1) unstable; urgency=low
+
+  * New upstream release
+  * Fixed build problem on ia64. Closes: #110624
+
+ -- Christian Hammers <ch@debian.org>  Tue, 14 Aug 2001 23:20:35 +0200
+
+mysql (3.23.40-1) unstable; urgency=low
+
+  * New upstream release
+
+ -- Christian Hammers <ch@debian.org>  Sun,  5 Aug 2001 19:46:18 +0200
+
+mysql (3.23.39-5) unstable; urgency=low
+
+  * Added debconf template for brazil. Closes: #106934, #106752 
+  * Tightened dependencies on debconf.
+  * Adjusted mysql.err permissions in logrotate script to 0600. Closes: #105672
+
+ -- Christian Hammers <ch@debian.org>  Mon, 30 Jul 2001 00:10:12 +0200
+
+mysql (3.23.39-4.1) unstable; urgency=low
+
+  * Maintainer-requested NMU.
+  * Fixing thread mutexes on Sparc and Alpha
+    (closes: Bug#101783)
+  * Added --enable-assembler for sparc.  This should
+    allow mysql on sparc to use assembler versions of
+    some string functions (read: should speed up a bit).
+
+ -- Christopher C. Chimelis <chris@debian.org>  Fri, 13 Jul 2001 15:09:30 -0400
+  
+mysql (3.23.39-4) unstable; urgency=low
+
+  * Porting fixes.
+
+ -- Christian Hammers <ch@debian.org>  Mon,  9 Jul 2001 17:56:54 +0200
+
+mysql (3.23.39-3.1) unstable; urgency=low
+
+  * NMU (for porting)
+  * Update config.sub and config.guess for hppa, sh & s390.
+  * Add --with-client-ldflags=-lstdc++ to configure line.  Closes: #100884
+
+ -- Matthew Wilcox <willy@debian.org>  Sun,  8 Jul 2001 19:26:59 -0600
+
+mysql (3.23.39-3) unstable; urgency=low
+
+  * Disabled berkeley-db on sparc again. Mutexes aren't working again :-( 
+
+ -- Christian Hammers <ch@debian.org>  Sat,  7 Jul 2001 18:30:08 +0200
+
+mysql (3.23.39-2) unstable; urgency=low
+
+  * Bugfixed the m68k mutex patch. Thanks to Michael Fedrowitz. Closes: #103145 
+  * Removed config.cache files in bdb/ and innobase/. Closes: #103143
+
+ -- Christian Hammers <ch@debian.org>  Wed,  4 Jul 2001 22:06:58 +0200
+
+mysql (3.23.39-1) unstable; urgency=low
+
+  * New upstream release. Minor bugfixes only. 
+
+ -- Christian Hammers <ch@debian.org>  Thu, 14 Jun 2001 13:53:03 +0200
+
+mysql (3.23.38-4) unstable; urgency=low
+
+  * Added logcheck files. Closes: #99131
+    (I can't let the usermod away since I don't know of an easy way to
+    retrive "passwd" information in a shell script considering that 
+    people use different storage methods like LDAP/NIS instead of passwd.)
+
+ -- Christian Hammers <ch@debian.org>  Fri,  8 Jun 2001 21:04:25 +0200
+
+mysql (3.23.38-3) unstable; urgency=low
+
+  * Explicit pointet to /root/.my.cnf to let /etc/init.d/mysql stop
+    work in sudo environments with $HOME!=/root work, too. Closes: #98324
+  * Removes empty /etc/mysql on purge. Closes: #98164
+
+ -- Christian Hammers <ch@debian.org>  Tue, 22 May 2001 10:13:06 +0200
+
+mysql (3.23.38-2) unstable; urgency=low
+
+  * Added depends to libdbd-mysql-perl for mysql-server. Closes: #94306
+
+ -- Christian Hammers <ch@debian.org>  Sat, 19 May 2001 19:43:26 +0200
+
+mysql (3.23.38-1) unstable; urgency=low
+
+  * New upstream release. 
+  * Added Build-Depends to procps. Closes: #96768
+
+ -- Christian Hammers <ch@debian.org>  Sun, 13 May 2001 17:30:15 +0200
+
+mysql (3.23.37-5) unstable; urgency=low
+
+  * Applied mutex patch for bdb support on m68k. 
+    Thanks to Michael Fedrowitz for the patch.
+
+ -- Christian Hammers <ch@debian.org>  Mon,  7 May 2001 12:30:40 +0200
+
+mysql (3.23.37-4) unstable; urgency=low
+
+  * Enable bdb support for m68k architecture.
+
+ -- Christian Hammers <ch@debian.org>  Sat,  5 May 2001 16:47:36 +0200
+
+mysql (3.23.37-3) unstable; urgency=low
+
+  * Added thread-safe client library. Thanks to Shane Wegner. Closes: #95441 
+
+ -- Christian Hammers <ch@debian.org>  Sat, 28 Apr 2001 09:45:00 -0400
+
+mysql (3.23.37-2) unstable; urgency=low
+
+  * Added sparc to the list of BDB supporting architectures after some
+    tests on vore.debian.org and mails with Ben Collons.
+
+ -- Christian Hammers <ch@debian.org>  Fri, 27 Apr 2001 09:30:09 -0400
+
+mysql (3.23.37-1) unstable; urgency=low
+
+  * New upstream version. 
+  * Added gemini table support.
+  * Does anybody know how to enable SSL?
+  * Fixed ARM compilation problem. Closes: #88186
+
+ -- Christian Hammers <ch@debian.org>  Sat, 21 Apr 2001 11:48:46 -0400
+
+mysql (3.23.36-2) unstable; urgency=low
+
+  * Added patch by Christopher C. Chimelis <chris@debian.org> to make
+    Berkeley db3 work again on Alpha architecture. Closes: #92787
+
+ -- Christian Hammers <ch@debian.org>  Tue,  3 Apr 2001 23:41:46 +0200
+
+mysql (3.23.36-1) unstable; urgency=high
+
+  * New upstream version.
+  * SECURITY FIX: One could place database tables outside the database
+    directory by using '..' in one of the mysql helper programs where the
+    table name was not checked correctly. This could lead to root compromise
+    if the server would be running as root else you could at least do bad
+    things as user mysql.
+  * upstream: Fixed bug when thread creation failed.
+  * upstream: Fixed problem in Innobase with non-latin1 charsets
+  * upstream: Fixed a core-dump bug when using very complex query with DISTINGT
+  * upstream: many others so called minor bugs...
+  * fixes bug in init script. Closes: #90257 
+    (this report was agains some older problem that has been fixed too in .33)
+
+ -- Christian Hammers <ch@debian.org>  Fri, 30 Mar 2001 02:55:12 +0200
+
+mysql (3.23.35-1) unstable; urgency=medium
+
+  * New upstream relase.
+  * Fixes problem in ORDER BY clause. People using 3.33.34 should upgrade!
+  * Includes innobase support.
+    (Hope this is not such a catastrophe like berkeley db...)
+
+ -- Christian Hammers <ch@debian.org>  Fri, 16 Mar 2001 23:30:30 +0100
+
+mysql (3.23.33-3) unstable; urgency=low
+
+  * Forgot #!/bin/sh at top of mysql-doc.postinst. Closes: #89801 
+
+ -- Christian Hammers <ch@vore.debian.org>  Thu, 15 Mar 2001 20:38:35 -0500
+
+mysql (3.23.33-2) unstable; urgency=low
+
+  * Added some missing scripts and manpages. Closes: #84068
+  * Added dependency to perl-5.6. Closes: #81942 
+  * Added french templates somewhen ago. Closes: #83790
+  * Added patch to get db3 working on Alpha. Closes: #86033
+    Thanks to Christopher C. Chimelis <chris@debian.org>. The patch
+    itself is included as debian/patch.alpha, too.
+
+ -- Christian Hammers <ch@debian.org>  Sun, 18 Feb 2001 06:40:40 +0100
+
+mysql (3.23.33-1) unstable; urgency=high
+
+  * Fixes two security bugs that allowes crashing the server and maybe
+    gaining the UID of the process that is linked against libmysqlclient!
+
+ -- Christian Hammers <ch@debian.org>  Tue, 13 Feb 2001 23:01:18 +0100
+
+mysql (3.23.32-1) unstable; urgency=low
+
+  * New upstream releaes.
+    (just minor fixes)
+  * Added french and german debconf templates. 
+
+ -- Christian Hammers <ch@debian.org>  Sun,  4 Feb 2001 17:27:07 +0100
+
+mysql (3.23.31-1) unstable; urgency=high
+
+  * New upstream release.
+  * Fixes security bug that was announced at BUGTRAQ mailing list.
+    (Disappointingly not by mysql.com!). And allows a buffer overflow
+    and therefore access to the mysql UID and all databases when already
+    having a valid account. Closes: #82881
+
+ -- Christian Hammers <ch@debian.org>  Sat, 20 Jan 2001 11:14:36 +0100
+
+mysql (3.23.30-2) unstable; urgency=low
+
+  * Recompiled with new dpkg-dev. 
+
+ -- Christian Hammers <ch@debian.org>  Sun, 14 Jan 2001 22:20:55 +0100
+
+mysql (3.23.30-1) unstable; urgency=low
+
+  * New upstream release. 
+
+ -- Christian Hammers <ch@debian.org>  Sun,  7 Jan 2001 22:10:18 +0100
+
+mysql (3.23.28-10) testing unstable; urgency=low
+
+  * I must upload to "testing" to get it into woody, right?! 
+
+ -- Christian Hammers <ch@debian.org>  Fri, 29 Dec 2000 14:43:57 +0100
+
+mysql (3.23.28-9) unstable; urgency=low
+
+  * Made it a replacement for libmysqlclient9. 
+
+ -- Christian Hammers <ch@westend.com>  Mon, 25 Dec 2000 19:15:04 +0100
+
+mysql (3.23.28-8) unstable; urgency=low
+
+  * Applied patch from a user to get the skip-networking option working!
+    Approved from a mysql employee but please test anyways.
+    This finally: Closes: #79672, #78634, #79660, #79658
+
+ -- Christian Hammers <ch@debian.org>  Sat, 16 Dec 2000 14:01:36 +0100
+
+mysql (3.23.28-6) unstable; urgency=medium
+
+  * Fixed error in postinst. Closes: #79392, #79400, #79451, #79550
+  * Added .info files again on user request. Closes: #78988, #75737 
+
+ -- Christian Hammers <ch@debian.org>  Wed, 13 Dec 2000 21:18:24 +0100
+
+mysql (3.23.28-5) unstable; urgency=low
+
+  * Fixed a stupid bug in mysql-server.postinst regarding the 
+    configuration of skip-networking. Closes: #78639, 78634
+  * Used patched bdb which hopefully enables mutexes on Alpha. Closes: #78197
+  * Added dependency to adduser. Closes: #76798
+
+ -- Christian Hammers <ch@debian.org>  Sun, 10 Dec 2000 16:55:48 +0100
+
+mysql (3.23.28-4) unstable; urgency=low
+
+  [never uploaded]
+  * Fixed a stupid bug in mysql-server.postinst regarding the 
+    configuration of skip-networking. Closes: #78639, 78634
+  * Used patched bdb which hopefully enables mutexes on Alpha. Closes: #78197
+
+ -- Christian Hammers <ch@debian.org>  Sun,  3 Dec 2000 17:49:44 +0100
+
+mysql (3.23.28-3) unstable; urgency=low
+
+  * This time really fixed m68k build error. Closes: #78235 
+
+ -- Christian Hammers <ch@debian.org>  Sun,  3 Dec 2000 15:02:55 +0100
+
+mysql (3.23.28-2) unstable; urgency=low
+
+  * Adjusted rules file to make it buildable on m86k. Closes: #78235 
+
+ -- Christian Hammers <ch@debian.org>  Fri,  1 Dec 2000 20:07:26 +0100
+
+mysql (3.23.28-1) unstable; urgency=low
+
+  * New upstream vesrion. Now gamma! 
+  * Changed umask of mysql.log making it o-rw
+  * Disabled listening on network reachable TCP ports by default due to
+    security considerations.
+
+ -- Christian Hammers <ch@debian.org>  Thu, 23 Nov 2000 20:12:50 +0100
+
+mysql (3.23.27-1) unstable; urgency=low
+
+  * New upstream version.
+  * Closes: #75711
+
+ -- Christian Hammers <ch@debian.org>  Sun, 29 Oct 2000 14:29:51 +0100
+
+mysql (3.23.25-4) unstable; urgency=low
+
+  * Recompiled to get rid of the dependency for zlib1 (libc5).
+    Closes: #74952, #74939
+
+ -- Christian Hammers <ch@debian.org>  Tue, 17 Oct 2000 14:34:52 +0200
+
+mysql (3.23.25-3.1) unstable; urgency=low
+
+  * Maintainer-approved NMU.
+  * Includes patch to fix and enable db3 support on Alpha.
+  * Enable support for thread mutexes in db3 on sparc
+    (it works after all, according to Ben Collins)
+  * Removed atomic_ functions for Alpha since they are no
+    longer supported in the current glibc in woody.
+  * Cleaned up rules file a bit.
+
+ -- Christopher C. Chimelis <chris@debian.org>  Sat, 14 Oct 2000 04:22:02 -0400
+
+mysql (3.23.25-3) unstable; urgency=low
+
+  * Upstream decided not to include my_config.h,my_dir.h into the installed
+    header files. As this file contains at least informative material
+    and more important is checked by several autoconf scripts I
+    included it by hand again.
+  * Made building of berkeley db conditional to architecture until
+    I get response whether it works on sparc/alpha now.
+
+ -- Christian Hammers <ch@debian.org>  Wed, 11 Oct 2000 23:58:38 +0200
+
+mysql (3.23.25-2) unstable; urgency=medium
+
+  * Last build went terrible wrong.. Here's the changelog again:
+  * New upstream release.
+  * Shared library version was raised from 9 to 10.
+    Maintainers of packets using libmysqlclient9 must recompile!
+
+ -- Christian Hammers <ch@debian.org>  Wed, 11 Oct 2000 01:16:34 +0200
+
+mysql (3.23.25-1) unstable; urgency=low
+
+  * New upstream release.
+  * Shared library version was raised from 9 to 10.
+    Maintainers of packets using libmysqlclient9 must recompile!
+
+ -- Christian Hammers <ch@debian.org>  Sat,  7 Oct 2000 18:21:51 +0200
+
+mysql (3.23.24-2) unstable; urgency=low
+
+  * Applied upstream patch regarding quoting of mysqldump.
+  * Updated to db-3.1.17-patched (from www.mysql.com)
+
+ -- Christian Hammers <ch@debian.org>  Fri, 15 Sep 2000 18:58:14 +0200
+
+mysql (3.23.24-1) unstable; urgency=medium
+
+  * New upstream version with some important fixes.
+  * upstream: Last version corrupted CHAR/VARCHAR/BLOB columns with 
+    chararacters above ASCII 128! Check and repair all these tables. 
+  * upstream: fixed small memory leak
+  * upstream: fixed problem with BDB tables and reading on unique
+              (not primary) key.
+  * Disabled BDB tables on all architectures except i386 due to many
+    bug reports (see #71206).  -> HELP APPRECIATED <-
+
+ -- Christian Hammers <ch@debian.org>  Tue, 12 Sep 2000 06:18:54 +0200
+
+mysql (3.23.23-2) unstable; urgency=low
+
+  * Strange... "nohup nice" gives differnet results and let therefore
+    crash safe_mysqld when starting up. Apparently it seems to be
+    kernel dependand. Now fixed by another conditional. This
+    more or less Closes: #71057
+  * This bug was reported (accidently) in the following identical reports:
+    Closes: #71253, #71254, #71257, #71258, #71259, #71262, #71266, #71267
+    Closes: #71268, #71271, #71275, #71277, #71278, #71283, #71291
+
+ -- Christian Hammers <ch@debian.org>  Sat,  9 Sep 2000 20:13:50 +0200
+
+mysql (3.23.23-1) unstable; urgency=low
+
+  * New upstream version. Feature freeze!
+  * Fixed source build problem. Closes: #70707 
+
+ -- Christian Hammers <ch@debian.org>  Thu, 31 Aug 2000 10:03:35 +0200
+
+mysql (3.23.22b-1) unstable; urgency=low
+
+  * Reorganised docs. Now we have several small html files instead of
+    one with almost 2M. Closes: 70431
+  * Removed pdf,ps and html from source package shrinked it about 3M
+    (therefore the .orig.tar.gz is called 3.23.22b!)
+  * -> Last upload failed due to problems at the FTP site so here the 
+    -> changelog again:
+  * Fixes memory leak, commit/rollback, reserved word "MASTER" ...
+  * Added Berkeley DB3 source code to the Debian diff to be able to
+    compile with bdb transaction support! (Great feature!!!)
+  * Upstream correction of error message. Closes: #68939
+  * Upstream correction of reserved word "source".
+
+ -- Christian Hammers <ch@debian.org>  Fri, 25 Aug 2000 19:21:24 +0200
+
+mysql (3.23.22-1) unstable; urgency=low
+
+  * New upstream version.
+  * Fixes memory leak, commit/rollback, reserved word "MASTER" ...
+  * Added Berkeley DB3 source code to the Debian diff to be able to
+    compile with bdb transaction support! (Great feature!!!)
+  * Upstream correction of error message. Closes: #68939
+  * Upstream correction of reserved word "source".
+
+ -- Christian Hammers <ch@debian.org>  Sun, 20 Aug 2000 09:05:48 +0200
+
+mysql (3.23.21-4) unstable; urgency=low
+
+  * Added libmysqlclient9.shlibs and shlibs.local file. Closes: #68669
+
+ -- Christian Hammers <ch@debian.org>  Wed,  9 Aug 2000 14:22:49 +0200
+
+mysql (3.23.21-3) unstable; urgency=low
+
+  * Let "/etc/init.d/mysql restart" wait until the pid has been
+    removed before (but max 6 seconds) before restarting. Closes: 65070
+  * Added build dependencies. 
+
+ -- Christian Hammers <ch@debian.org>  Sun, 30 Jul 2000 16:16:48 +0200
+
+mysql (3.23.21-2) unstable; urgency=low
+
+  * Typo in safe_mysqld prevents start.
+
+ -- Christian Hammers <ch@debian.org>  Sat, 29 Jul 2000 13:40:50 +0200
+
+mysql (3.23.21-1) unstable; urgency=low
+
+  * New upstream version.
+
+ -- Christian Hammers <ch@debian.org>  Mon, 10 Jul 2000 22:54:17 +0200
+
+mysql (3.23.20-1) unstable; urgency=low
+
+  * MySQL finally got fully GPL'ed! This means that there is only one
+    souce package and only main/* binary packages from now on.
+  * Fixed symlink in libmysqlclient9-dev. Closes: 66452
+  * Apart from that the usual bug fixes for BETA software.
+
+ -- Christian Hammers <ch@debian.org>  Mon,  3 Jul 2000 20:05:38 +0200
+
+mysql-pd (3.23.16-1) unstable; urgency=low
+
+  * New upstream release. (Actually a brand new upstream branch!)
+  * Added mysql-common package as the configuration file can be used
+    by all versions of the mysql client library.
+    Did some more package reorganisations, too. See README.Debian file!
+  * libmysqlclient.so raised major version from 6 to 9.
+  * Minor beautifications in the debian/ directory.
+
+ -- Christian Hammers <ch@debian.org>  Sat, 27 May 2000 20:30:01 +0200
+
+mysql-gpl (3.22.30-2) frozen unstable; urgency=low
+
+  * Fixed path in libmysqlclient.la. Closes: #58875 
+
+ -- Christian Hammers <ch@debian.org>  Sat, 25 Jan 2000 20:27:29 -0700
+
+mysql-gpl (3.22.30-1) frozen unstable; urgency=low
+
+  * A small change in the libmysqlclient6 causes mysqladmin to print an
+    shared library error when displaying the defaults. Everything else
+    works fine so this error wasn't detected untill now. Closes: #58033
+  * TcX released a new MySQL version that includes another security patch,
+    this time against mysqlaccess. The author told me that it would be 
+    fine if I just included the new .c in this source since I don't want
+    go to 3.22.32 in frozen.
+  * ->Release Manager: Although the version number increased there is
+    no new coded except for the shared library. The rest is the same
+    as in mysql-server and mysql-client.
+
+ -- Christian Hammers <ch@debian.org>  Tue, 15 Feb 2000 23:26:54 +0100
+
+mysql-gpl (3.22.29-1) unstable; urgency=low
+
+  * New upstream version.
+
+ -- Christian Hammers <ch@debian.org>  Thu,  6 Jan 2000 20:37:23 +0100
+
+mysql-gpl (3.22.27a-3) unstable; urgency=low
+
+  * Use system readline instead of bundled version. Closes: #50069 
+    Any objections ?
+
+ -- Christian Hammers <ch@debian.org>  Sun, 14 Nov 1999 18:09:48 +0100
+
+mysql-gpl (3.22.27a-2) unstable; urgency=low
+
+  * Now building mysql-gpl-doc in binary-indep. 
+
+ -- Christian Hammers <ch@debian.org>  Sat, 23 Oct 1999 04:22:36 +0200
+
+mysql-gpl (3.22.27a-1) unstable; urgency=low
+
+  * Adjusted version number to allow new orig.tar.gz.
+    The old seems broken :-( People reported compilation problems.
+  * Changed mysql-gpl-doc to "Architecture: all". 
+
+ -- Christian Hammers <ch@debian.org>  Sun, 17 Oct 1999 13:01:35 +0200
+
+mysql-gpl (3.22.27-1) unstable; urgency=low
+
+  * New upstream release. Fixes charset problem.
+
+ -- Christian Hammers <ch@debian.org>  Mon, 11 Oct 1999 18:01:40 +0200
+
+mysql-gpl (3.22.26a-1) unstable; urgency=low
+
+  * New upstream version. Just some small bug fixes.
+  * FHS compliance.
+
+ -- Christian Hammers <ch@debian.org>  Sun,  3 Oct 1999 10:16:14 +0200
+
+mysql-gpl (3.22.25-2) unstable; urgency=low
+
+  * Added conflict to all old mysql-dev packages. (fixes: #42966) 
+
+ -- Christian Hammers <ch@debian.org>  Sun, 15 Aug 1999 11:35:46 +0200
+
+mysql-gpl (3.22.25-1) unstable; urgency=low
+
+  * New upstream version. (We are waiting for 3.23.x !)
+  * Fixes some upstream small bugs.
+
+ -- Christian Hammers <ch@debian.org>  Sun, 18 Jul 1999 22:02:06 +0200
+
+mysql-gpl (3.22.23b-4) unstable; urgency=low
+
+  * Rebuild for new perl. 
+
+ -- Christian Hammers <ch@debian.org>  Thu,  8 Jul 1999 01:09:57 +0200
+
+mysql-gpl (3.22.23b-3) unstable; urgency=low
+
+  * libmysqlclient had the wrong socket path.
+
+ -- Christian Hammers <ch@debian.org>  Sun, 03 Jul 1999 23:13:30 +0200
+
+mysql-gpl (3.22.23b-2) unstable; urgency=low
+
+  * Missed one replace tag to an very old version of mysql-devel.
+
+ -- Christian Hammers <ch@debian.org>  Sun, 27 Jun 1999 19:13:30 +0200
+
+mysql-gpl (3.22.23b-1) unstable; urgency=low
+
+  * New upstream minor version.
+  * Cleaned up the dependencies a bit.
+
+ -- Christian Hammers <ch@debian.org>  Sun, 27 Jun 1999 19:13:30 +0200
+
+mysql-gpl (3.22.22-1) unstable; urgency=low
+
+  * New upstream version. (closes Bug#36493,37340)
+  * New maintainer upload.
+  * Package reorganisation: We prepare for the GPL'ed server which will
+  *  be released soon and make the structure more clear to the user.
+
+ -- Christian Hammers <ch@debian.org>  Mon,  3 May 1999 20:43:41 +0200
+
+mysql (3.22.21-1) unstable; urgency=low
+
+  * Never released. TcX was too fast :-)
+
+ -- Christian Hammers <ch@debian.org>  Tue, 20 Apr 1999 17:22:04 +0200
+
+mysql-freebits (3.21.33b-3) unstable; urgency=low
+
+  * Recompile with libncurses
+
+ -- Scott Hanson <shanson@debian.org>  Sat, 31 Oct 1998 15:04:39 +0100
+
+mysql-freebits (3.21.33b-2) unstable; urgency=low
+
+  * Recompile with libstdc++2.9 (fixes #27792)
+
+ -- Scott Hanson <shanson@debian.org>  Mon, 12 Oct 1998 18:47:25 +0200
+
+mysql-freebits (3.21.33b-1) unstable; urgency=low
+
+  * New upstream version (probably the last for 3.21)
+
+ -- Scott Hanson <shanson@debian.org>  Tue,  8 Sep 1998 18:59:37 +0200
+
+mysql-freebits (3.21.33-4) unstable; urgency=low
+
+  * Separate out non-free source files, move mysql-base, mysql-dev, and
+  *  mysql-doc to main distribution
+  * Locale files /usr/share/mysql/ now in server, not base; therefore...
+  * Add conflict to mysql-server <=3.21.33-3
+
+ -- Scott Hanson <shanson@debian.org>  Fri, 31 Jul 1998 19:16:08 +0200
+
+mysql (3.21.33-3) unstable; urgency=low
+
+  * Release to unstable with moved socket (fixes #24574)
+  * Add conflict to old libdbd-mysql-perl package
+
+ -- Scott Hanson <shanson@debian.org>  Wed, 22 Jul 1998 22:17:43 +0200
+
+mysql (3.21.33-2) experimental; urgency=low
+
+  * Move socket from /tmp to /var/run (see #24574) 
+  * Release to experimental, since this breaks everything statically
+  *  linked to libmysqlclient!
+
+ -- Scott Hanson <shanson@debian.org>  Wed, 15 Jul 1998 19:37:01 +0200
+
+mysql (3.21.33-1) unstable; urgency=low
+
+  * New upstream release
+
+ -- Scott Hanson <shanson@debian.org>  Sun, 12 Jul 1998 08:18:18 +0200
+
+mysql (3.21.32a-1) unstable; urgency=low
+
+  * New upstream release 
+  * Lintian bugs: ldconfig, missing manpage, call to perl5
+  * Lintian bug shlib-with-non-pic-code _not_ yet fixed 
+
+ -- Scott Hanson <shanson@debian.org>  Sat,  4 Jul 1998 07:57:13 +0200
+
+mysql (3.21.31-1) unstable frozen; urgency=low
+
+  * New upstream release for hamm and slink (bug fixes only)
+  * Fix unsecure use of temp file in mysqlbug (fixes #23606) 
+  * Added brief licensing information to control file
+
+ -- Scott Hanson <shanson@debian.org>  Tue, 16 Jun 1998 10:52:44 +0200
+
+mysql (3.21.30-3) unstable; urgency=low
+
+  * Restore missing shared library dependencies for mysql-server
+
+ -- Scott Hanson <shanson@debian.org>  Mon, 15 Jun 1998 07:51:58 +0200
+
+mysql (3.21.30-2) unstable; urgency=low
+
+  * Simplify debian/rules (fixes #17662)
+  * Edit manual.texi to add "Debian notes" to documentation
+  * Add note about passwords on command line (fixes #16471)
+  * Add note about getting privleges for users (fixes #22891)
+  * Correct "Possible license changes" heading (fixes #22711)
+  * Add uninstalled header files to /usr/doc/mysql-dev/examples (fixes #22627)
+  * Add udf_example.cc to /usr/doc/mysql-dev/examples (fixes #22710)
+
+ -- Scott Hanson <shanson@debian.org>  Sun,  7 Jun 1998 13:05:37 +0200
+
+mysql (3.21.30-1) unstable; urgency=low
+
+  * Stable upstream release
+
+ -- Scott Hanson <shanson@debian.org>  Tue, 12 May 1998 22:13:25 +0200
+
+mysql (3.21.29gamma-1) unstable; urgency=low
+
+  * New upstream release
+  * Do not create 'mysql' subdirectory for libs and headers (fixes #19020)
+  * Remove 'CXX=gcc' flag from configure (g++ now standard)
+      
+ -- Scott Hanson <shanson@debian.org>  Sun, 12 Apr 1998 18:38:03 +0200
+
+mysql (3.21.28gamma-1) unstable; urgency=low
+
+  * New upstream release
+  * Unstable-only release; hamm stays at 3.21.25 for now
+
+ -- Scott Hanson <shanson@debian.org>  Thu,  2 Apr 1998 21:33:51 +0200
+
+mysql (3.21.25gamma-3) unstable frozen; urgency=low
+
+  * Have mysql-base suggest perl >= 5.004 for mysqlaccess (fixes #19593)
+  * Fix shlibs to refer to mysql-base rather than the no-longer-existant mysql
+
+ -- Scott Hanson <shanson@debian.org>  Thu, 26 Mar 1998 18:22:59 +0100
+
+mysql (3.21.25gamma-2) unstable; urgency=low
+
+  * Restore libmysqlclient.so symlink to mysql-dev (fixes #19036)
+
+ -- Scott Hanson <shanson@debian.org>  Sun,  8 Mar 1998 10:46:43 +0100
+
+mysql (3.21.25gamma-1) unstable; urgency=low
+
+  * Check if running as root in init.d script (fixes #18577)
+  * New upstream release
+
+ -- Scott Hanson <shanson@debian.org>  Fri, 27 Feb 1998 20:01:30 +0100
+
+mysql (3.21.24gamma-1) unstable; urgency=low
+
+  * New upstream release
+
+ -- Scott Hanson <shanson@debian.org>  Mon, 23 Feb 1998 08:14:17 +0100
+
+mysql (3.21.23beta-3) unstable; urgency=low
+
+  * Squashed errors found by lintian
+
+ -- Scott Hanson <shanson@debian.org>  Tue, 17 Feb 1998 20:19:01 +0100
+
+mysql (3.21.23beta-2) unstable; urgency=low
+
+  * Fixed overlaps with old mysql package (fixes #17843)
+
+ -- Scott Hanson <shanson@debian.org>  Thu,  5 Feb 1998 22:55:00 +0100
+
+mysql (3.21.23beta-1) unstable; urgency=low
+
+  * New upstream release
+  * Fix include lines in mysql.h (fixes #17827)
+  * Move /usr/include/mysql to mysql-dev
+
+ -- Scott Hanson <shanson@debian.org>  Wed,  4 Feb 1998 19:59:14 +0100
+
+mysql (3.21.22beta-3) unstable; urgency=low
+
+  * Correct descriptions in control file (fixes #17698)
+  * Clean up output of shutdown script
+
+ -- Scott Hanson <shanson@debian.org>  Sat, 31 Jan 1998 19:04:29 +0100
+
+mysql (3.21.22beta-2) unstable; urgency=low
+
+  * Split out mysql-dev and mysql-bench subpackages
+
+ -- Scott Hanson <shanson@debian.org>  Wed, 28 Jan 1998 19:52:27 +0100
+
+mysql (3.21.22beta-1) unstable; urgency=low
+
+  * New upstream release 
+  
+ -- Scott Hanson <shanson@debian.org>  Wed, 28 Jan 1998 18:59:09 +0100
+
+mysql (3.21.21a.beta-2) unstable; urgency=low
+
+  * Compile with libpthreads from libc6-dev_2.0.6-3 rather than statically 
+    linking to patched libpthreads (see changes to 3.20.29-2)
+  
+ -- Scott Hanson <shanson@debian.org>  Sun, 25 Jan 1998 13:17:15 +0100
+
+mysql (3.21.21a.beta-1) unstable; urgency=low
+
+  * Put initial database, mysql_install_db, safe_mysqld, isamlog and 
+    isamchk in mysql-server 	
+  * Correct upstream release number so source packages are correctly built
+
+ -- Scott Hanson <shanson@debian.org>  Mon, 19 Jan 1998 07:52:48 +0100
+
+mysql (3.21.21.beta-1) unstable; urgency=low
+
+  * Use debhelper where possible in rules
+  * Split binary packages into mysql-base, mysql-client, mysql-doc	
+  * New upstream release
+
+ -- Scott Hanson <shanson@debian.org>  Thu, 15 Jan 1998 08:12:17 +0100
+
+mysql (3.21.19.beta-1) unstable; urgency=low
+
+  * Offer to set root password in mysql_install_db
+  * Kill `pidof mysqld` on shutdown rather than use mysqladmin
+  * New upstream version
+
+ -- Scott Hanson <shanson@debian.org>  Fri,  9 Jan 1998 20:06:35 +0100
+
+mysql (3.21.17a.beta-2) unstable; urgency=low
+
+  * Remove perl stuff (it's going back into libdbd-mysql-perl)
+  * Remove conflict with libdbd-mysql-perl
+  * Do not compress *html files (fixes #16314)
+
+ -- Scott Hanson <shanson@debian.org>  Tue, 30 Dec 1997 07:34:20 +0100
+
+mysql (3.21.17a.beta-1) unstable; urgency=low
+
+  * Add conflict to libdbd-mysql-perl
+  * Use --pid-file option to place pid file in /var/run rather than patching 
+  * Add install-info to postinst and postrm
+  * Add filename to message shown by mysql_install_db (fixes #16621)
+  * New upstream version
+
+ -- Scott Hanson <shanson@debian.org>  Sun, 21 Dec 1997 19:41:45 +0100
+
+mysql (3.20.32a-5) unstable; urgency=low
+
+  * Move mysqld to /usr/lib/mysql, per policy discussion
+  * Adjust makefiles so perl libs get installed 
+
+ -- Scott Hanson <shanson@debian.org>  Wed,  3 Dec 1997 22:37:45 +0100
+
+mysql (3.20.32a-4) unstable; urgency=low
+
+  * Move mysqld to /usr/sbin to comply with FSSTND
+
+ -- Scott Hanson <shanson@debian.org>  Mon,  3 Nov 1997 20:12:29 +0100
+
+mysql (3.20.32a-3) unstable; urgency=low
+
+  * Comment out tests in mysql_install_db... for real this time!
+
+ -- Scott Hanson <shanson@debian.org>  Mon,  3 Nov 1997 07:32:53 +0100
+
+mysql (3.20.32a-2) unstable; urgency=low
+
+  * Comment out tests in mysql_install_db (fixes #14304)
+
+ -- Scott Hanson <shanson@debian.org>  Sat,  1 Nov 1997 18:45:25 +0100
+
+mysql (3.20.32a-1) unstable; urgency=low
+
+  * New upstream version
+
+ -- Scott Hanson <shanson@debian.org>  Wed, 29 Oct 1997 07:11:42 +0100
+
+mysql (3.20.29-2) unstable; urgency=low
+ 
+  * New maintainer
+  * Statically link mysqld to patched glibc-2.0.5 libpthread 
+    (works around #13586; see README.debian.glibc-2.0.5)
+  * Conflict with libpthread0 (fixes #13448)
+  * Don't link libg++, avoiding problems with glibc libpthread 
+
+ -- Scott Hanson <shanson@debian.org>  Thu, 16 Oct 1997 19:25:23 +0200
+
+mysql (3.20.29-1) unstable; urgency=low
+
+  * New upstream version
+  * Recompiled with libc6
+  * Include mysql-faq_toc.html (fixes #10885)
+  * Reworked /etc/init.d/mysql script (thanks to Heiko)
+  * Remove file /usr/lib/libmysqlclient.so.4 when package is removed.
+  * Use absolute path specification for conffile
+  * Use /usr/bin/perl instead of /bin/perl (fixes #10654)
+  * Do not depend on mysql (fixes #12427)
+  * Installed missing manpage for Mysql perl module
+  * Don't use debstd anymore
+  * Pristine source
+  * Set section to `non-free/devel'
+  * Upgraded to standards version 2.3.0.0
+
+ -- Christian Schwarz <schwarz@debian.org>  Fri, 12 Sep 1997 02:12:58 +0200
+
+mysql (3.20.16beta-2) unstable; urgency=low
+
+  * Uses /usr/bin/perl instead of /bin/perl (fixes bug #9731)
+  * Don't run mysqld with --log option
+  * Don't install regex manual pages
+  * Suggest package mysql-manual
+  * Fixed typo in changelog
+  * Upgrade to policy 2.1.3.2
+
+ -- Christian Schwarz <schwarz@debian.org>  Sun, 11 May 1997 14:19:26 +0200
+
+mysql (3.20.16beta-1) unstable; urgency=low
+
+  * Initial Release.
+
+ -- Christian Schwarz <schwarz@debian.org>  Sat, 12 Apr 1997 13:51:28 +0200
diff -uNr mysql-5.5.60.orig/debian/compat mysql-5.5.60/debian/compat
--- mysql-5.5.60.orig/debian/compat	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/compat	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1 @@
+9
diff -uNr mysql-5.5.60.orig/debian/control mysql-5.5.60/debian/control
--- mysql-5.5.60.orig/debian/control	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/control	2018-12-02 00:08:57.455380989 +0800
@@ -0,0 +1,271 @@
+Source: mysql-5.5
+Section: database
+Priority: optional
+Maintainer: Debian MySQL Maintainers <pkg-mysql-maint@lists.alioth.debian.org>
+Uploaders:
+ Norbert Tretkowski <norbert@tretkowski.de>,
+ Clint Byrum <clint@ubuntu.com>,
+ James Page <jamespage@debian.org>
+Build-Depends:
+ bison,
+ chrpath,
+ cmake,
+ debhelper (>= 8.1.3~),
+ dh-apparmor,
+ doxygen-latex,
+ gawk,
+ ghostscript,
+ libaio-dev[linux-any],
+ libncurses5-dev (>= 5.0-6),
+ libreadline-dev,
+ libwrap0-dev (>= 7.6-8.3),
+ lsb-release,
+ perl,
+ po-debconf,
+ psmisc,
+ zlib1g-dev (>= 1:1.1.3-5)
+Standards-Version: 3.9.5
+Homepage: http://dev.mysql.com/
+Vcs-Git: git://git.debian.org/git/pkg-mysql/mysql-5.5.git
+Vcs-Browser: http://git.debian.org/?p=pkg-mysql/mysql-5.5.git
+XS-Testsuite: autopkgtest
+
+Package: libmysqlclient18
+Section: libs
+Architecture: any
+Depends: mysql-common (>= ${source:Version}), ${misc:Depends}, ${shlibs:Depends}
+Pre-Depends: multiarch-support, ${misc:Pre-Depends}
+Multi-Arch: same
+Description: MySQL database client library
+ MySQL is a fast, stable and true multi-user, multi-threaded SQL database
+ server. SQL (Structured Query Language) is the most popular database query
+ language in the world. The main goals of MySQL are speed, robustness and
+ ease of use.
+ .
+ This package includes the client library.
+
+Package: libmysqld-pic
+Architecture: any
+Section: libdevel
+Depends: libmysqlclient-dev (>= ${source:Version}), ${misc:Depends}
+Description: PIC version of MySQL embedded server development files
+ MySQL is a fast, stable and true multi-user, multi-threaded SQL database
+ server. SQL (Structured Query Language) is the most popular database query
+ language in the world. The main goals of MySQL are speed, robustness and
+ ease of use.
+ .
+ This package includes the -fPIC version of the embedded server library.
+
+Package: libmysqld-dev
+Architecture: any
+Section: libdevel
+Depends: libmysqlclient-dev (>= ${source:Version}), ${misc:Depends}
+Description: MySQL embedded database development files
+ MySQL is a fast, stable and true multi-user, multi-threaded SQL database
+ server. SQL (Structured Query Language) is the most popular database query
+ language in the world. The main goals of MySQL are speed, robustness and
+ ease of use.
+ .
+ This package includes the embedded server library and header files.
+
+Package: libmysqlclient-dev
+Architecture: any
+Section: libdevel
+Depends:
+ libmysqlclient18 (= ${binary:Version}),
+ zlib1g-dev,
+ ${misc:Depends},
+ ${shlibs:Depends}
+Conflicts:
+ libmysqlclient10-dev,
+ libmysqlclient12-dev,
+ libmysqlclient14-dev,
+ libmysqlclient15-dev
+Provides: libmysqlclient15-dev
+Replaces: libmysqlclient15-dev
+Description: MySQL database development files
+ MySQL is a fast, stable and true multi-user, multi-threaded SQL database
+ server. SQL (Structured Query Language) is the most popular database query
+ language in the world. The main goals of MySQL are speed, robustness and
+ ease of use.
+ .
+ This package includes development libraries and header files.
+
+Package: mysql-common
+Architecture: all
+Depends: ${misc:Depends}, ${shlibs:Depends}
+Breaks:
+ amarok (<< 2.5.0-2),
+ mysql-client-5.1 (<< 5.5),
+ mysql-server-5.1 (<< 5.5),
+ mysql-server-core-5.1 (<< 5.5)
+Multi-Arch: foreign
+Description: MySQL database common files, e.g. /etc/mysql/my.cnf
+ MySQL is a fast, stable and true multi-user, multi-threaded SQL database
+ server. SQL (Structured Query Language) is the most popular database query
+ language in the world. The main goals of MySQL are speed, robustness and
+ ease of use.
+ .
+ This package includes files needed by all versions of the client library,
+ e.g. /etc/mysql/my.cnf.
+
+Package: mysql-client-5.5
+Architecture: any
+Depends:
+ debianutils (>=1.6),
+ libdbd-mysql-perl (>= 1.2202),
+ libdbi-perl,
+ libterm-readkey-perl,
+ mysql-common (>= ${source:Version}),
+ ${misc:Depends},
+ ${perl:Depends},
+ ${shlibs:Depends}
+Provides: mysql-client, virtual-mysql-client, virtual-mysql-client-core
+Breaks:
+ mysql-client (<< ${source:Version}),
+ mysql-client-5.0,
+ mysql-client-5.1,
+ virtual-mysql-client,
+ virtual-mysql-client-core
+Replaces:
+ mysql-client (<< ${source:Version}),
+ mysql-client-5.0,
+ mysql-client-5.1,
+ virtual-mysql-client,
+ virtual-mysql-client-core
+Description: MySQL database client binaries
+ MySQL is a fast, stable and true multi-user, multi-threaded SQL database
+ server. SQL (Structured Query Language) is the most popular database query
+ language in the world. The main goals of MySQL are speed, robustness and
+ ease of use.
+ .
+ This package includes the client binaries and the additional tools
+ innotop and mysqlreport.
+
+Package: mysql-server-core-5.5
+Architecture: any
+Depends: ${misc:Depends}, ${shlibs:Depends}
+Breaks:
+ mysql-client-5.1,
+ mysql-server-5.0,
+ mysql-server-5.1,
+ mysql-server-core-5.1,
+ virtual-mysql-server-core
+Provides: mysql-server-core, virtual-mysql-server-core
+Replaces:
+ mysql-client-5.1,
+ mysql-server-5.0,
+ mysql-server-5.1,
+ mysql-server-core-5.0,
+ mysql-server-core-5.1,
+ virtual-mysql-server-core
+Description: MySQL database server binaries
+ MySQL is a fast, stable and true multi-user, multi-threaded SQL database
+ server. SQL (Structured Query Language) is the most popular database query
+ language in the world. The main goals of MySQL are speed, robustness and
+ ease of use.
+ .
+ This package includes the server binaries but doesn't contain all the
+ infrastructure needed to setup system databases.
+
+Package: mysql-server-5.5
+Architecture: any
+Suggests: mailx, tinyca
+Recommends: libhtml-template-perl
+Pre-Depends: adduser (>= 3.40), debconf, mysql-common (>= ${source:Version})
+Depends:
+ initscripts (>= 2.88dsf-13.3),
+ libdbi-perl,
+ lsb-base (>= 3.0-10),
+ mysql-client-5.5 (>= ${source:Version}),
+ mysql-server-core-5.5 (>= ${source:Version}),
+ passwd,
+ perl (>= 5.6),
+ psmisc,
+ ${misc:Depends},
+ ${shlibs:Depends}
+Breaks:
+ libmysqlclient-dev ( << 5.5.17~),
+ mysql-client-5.1,
+ mysql-server (<< ${source:Version}),
+ mysql-server-5.1,
+ virtual-mysql-server
+Provides: virtual-mysql-server
+Replaces:
+ libmysqlclient-dev ( << 5.5.17~),
+ mysql-client-5.1,
+ mysql-server (<< ${source:Version}),
+ mysql-server-5.0,
+ mysql-server-5.1,
+ virtual-mysql-server
+Description: MySQL database server binaries and system database setup
+ MySQL is a fast, stable and true multi-user, multi-threaded SQL database
+ server. SQL (Structured Query Language) is the most popular database query
+ language in the world. The main goals of MySQL are speed, robustness and
+ ease of use.
+ .
+ This package contains all the infrastructure needed to setup system
+ databases.
+
+Package: mysql-server
+Architecture: all
+Depends: mysql-server-5.5, ${misc:Depends}
+Description: MySQL database server (metapackage depending on the latest version)
+ This is an empty package that depends on the current "best" version of
+ mysql-server (currently mysql-server-5.5), as determined by the MySQL
+ maintainers. Install this package if in doubt about which MySQL
+ version you need. That will install the version recommended by the
+ package maintainers.
+ .
+ MySQL is a fast, stable and true multi-user, multi-threaded SQL database
+ server. SQL (Structured Query Language) is the most popular database query
+ language in the world. The main goals of MySQL are speed, robustness and
+ ease of use.
+
+Package: mysql-client
+Architecture: all
+Depends: mysql-client-5.5, ${misc:Depends}
+Description: MySQL database client (metapackage depending on the latest version)
+ This is an empty package that depends on the current "best" version of
+ mysql-client (currently mysql-client-5.5), as determined by the MySQL
+ maintainers.  Install this package if in doubt about which MySQL version
+ you want, as this is the one considered to be in the best shape by the
+ Maintainers.
+
+Package: mysql-testsuite
+Architecture: all
+Depends: mysql-testsuite-5.5, ${misc:Depends}
+Description: MySQL testsuite
+ This is an empty package that depends on the current "best" version of
+ mysql-testsuite (currently mysql-testsuite-5.5), as determined by the
+ MySQL maintainers.  Install this package if in doubt about which MySQL
+ version you want, as this is the one we consider to be in the best shape.
+
+Package: mysql-testsuite-5.5
+Architecture: any
+Depends:
+ mysql-client (= ${source:Version}),
+ mysql-server (= ${source:Version}),
+ ${misc:Depends},
+ ${shlibs:Depends}
+Provides: virtual-mysql-testsuite
+Breaks: virtual-mysql-testsuite
+Replaces: virtual-mysql-testsuite
+Description: MySQL testsuite
+ MySQL is a fast, stable, and true multi-user, multi-threaded SQL database
+ server.  SQL (Structured Query Language) is the most popular database query
+ language in the world. The main goals of MySQL are speed, robustness and
+ ease of use.
+ .
+ This package includes the MySQL testsuite.
+
+Package: mysql-source-5.5
+Architecture: any
+Depends: ${misc:Depends}, ${shlibs:Depends}
+Description: MySQL source
+ MySQL is a fast, stable, and true multi-user, multi-threaded SQL database
+ server.  SQL (Structured Query Language) is the most popular database query
+ language in the world. The main goals of MySQL are speed, robustness and
+ ease of use.
+ .
+ This package includes the MySQL source code as configured before building.
diff -uNr mysql-5.5.60.orig/debian/copyright mysql-5.5.60/debian/copyright
--- mysql-5.5.60.orig/debian/copyright	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/copyright	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,815 @@
+Format: http://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
+Upstream-Name: MySQL 5.5
+Upstream-Contact: http://bugs.mysql.com/
+Source: http://dev.mysql.com/downloads/mysql/5.5.html
+Comment:
+ The file Docs/mysql.info is removed from the upstream source
+ because it is incompatible with the Debian Free Software Guidelines.
+ See debian/README.source for how this repacking was done.
+ .
+ Originally produced by a modified version of licensecheck2dep5
+ from CDBS by Clint Byrum <clint@ubuntu.com>. Hand modified to reduce
+ redundancy in the output and add appropriate license text. The file
+ has been rechecked against the source using the development version
+ of license-reconcile, see #686485.
+ .
+ Also, MySQL carries the "FOSS License Exception" specified in README
+ .
+ Quoting from README:
+ .
+ MySQL FOSS License Exception We want free and open source
+ software applications under certain licenses to be able to use
+ specified GPL-licensed MySQL client libraries despite the fact
+ that not all such FOSS licenses are compatible with version
+ 2 of the GNU General Public License.  Therefore there are
+ special exceptions to the terms and conditions of the GPLv2
+ as applied to these client libraries, which are identified
+ and described in more detail in the FOSS License Exception at
+ <http://www.mysql.com/about/legal/licensing/foss-exception.html>.
+ .
+ The text of the Above URL is quoted below, as of Aug 17, 2011.
+ .
+ > FOSS License Exception
+ > .
+ > Updated July 1, 2010
+ > .
+ > What is the FOSS License Exception?  Oracle's Free and Open Source
+ > Software ("FOSS") License Exception (formerly known as the FLOSS
+ > License Exception) allows developers of FOSS applications to include
+ > Oracle's MySQL Client Libraries (also referred to as "MySQL Drivers"
+ > or "MySQL Connectors") with their FOSS applications. MySQL Client
+ > Libraries are typically licensed pursuant to version 2 of the General
+ > Public License ("GPL"), but this exception permits distribution of
+ > certain MySQL Client Libraries with a developer's FOSS applications
+ > licensed under the terms of another FOSS license listed below,
+ > even though such other FOSS license may be incompatible with the GPL.
+ > .
+ > The following terms and conditions describe the circumstances under
+ > which Oracle's FOSS License Exception applies.
+ > .
+ > Oracle's FOSS License Exception Terms and Conditions Definitions.
+ > "Derivative Work" means a derivative work, as defined under applicable
+ > copyright law, formed entirely from the Program and one or more
+ > FOSS Applications.
+ > .
+ > "FOSS Application" means a free and open source software application
+ > distributed subject to a license listed in the section below titled
+ > "FOSS License List."
+ > .
+ > "FOSS Notice" means a notice placed by Oracle or MySQL in a copy
+ > of the MySQL Client Libraries stating that such copy of the MySQL
+ > Client Libraries may be distributed under Oracle's or MySQL's FOSS
+ > (or FLOSS) License Exception.
+ > .
+ > "Independent Work" means portions of the Derivative Work that are not
+ > derived from the Program and can reasonably be considered independent
+ > and separate works.
+ > .
+ > "Program" means a copy of Oracle's MySQL Client Libraries that
+ > contains a FOSS Notice.
+ > .
+ > A FOSS application developer ("you" or "your") may distribute a
+ > Derivative Work provided that you and the Derivative Work meet all
+ > of the following conditions: You obey the GPL in all respects for
+ > the Program and all portions (including modifications) of the Program
+ > included in the Derivative Work (provided that this condition does not
+ > apply to Independent Works); The Derivative Work does not include any
+ > work licensed under the GPL other than the Program; You distribute
+ > Independent Works subject to a license listed in the section below
+ > titled "FOSS License List"; You distribute Independent Works in
+ > object code or executable form with the complete corresponding
+ > machine-readable source code on the same medium and under the same
+ > FOSS license applying to the object code or executable forms; All
+ > works that are aggregated with the Program or the Derivative Work
+ > on a medium or volume of storage are not derivative works of the
+ > Program, Derivative Work or FOSS Application, and must reasonably
+ > be considered independent and separate works.  Oracle reserves all
+ > rights not expressly granted in these terms and conditions. If all
+ > of the above conditions are not met, then this FOSS License Exception
+ > does not apply to you or your Derivative Work.
+ > .
+ > FOSS License List
+ > .
+ > License Name    Version(s)/Copyright Date
+ > Release Early    Certified Software
+ > Academic Free License    2.0
+ > Apache Software License  1.0/1.1/2.0
+ > Apple Public Source License  2.0
+ > Artistic license     From Perl 5.8.0
+ > BSD license  "July 22 1999"
+ > Common Development and Distribution License (CDDL)   1.0
+ > Common Public License    1.0
+ > Eclipse Public License   1.0
+ > European Union Public License (EUPL)[1]    1.1
+ > GNU Library or "Lesser" General Public License (LGPL)    2.0/2.1/3.0
+ > GNU General Public License (GPL)     3.0
+ > IBM Public License   1.0
+ > Jabber Open Source License   1.0
+ > MIT License (As listed in file MIT-License.txt)  -
+ > Mozilla Public License (MPL)     1.0/1.1
+ > Open Software License    2.0
+ > OpenSSL license (with original SSLeay license)   "2003" ("1998")
+ > PHP License  3.0/3.01
+ > Python license (CNRI Python License)     -
+ > Python Software Foundation License   2.1.1
+ > Sleepycat License   "1999"
+ > University of Illinois/NCSA Open Source License  -
+ > W3C License  "2001"
+ > X11 License  "2001"
+ > Zlib/libpng License  -
+ > Zope Public License  2.0
+ > [1] When an Independent Work is licensed under a "Compatible License"
+ > pursuant to the EUPL, the Compatible License rather than the EUPL is
+ > the applicable license for purposes of these FOSS License Exception
+ > Terms and Conditions.
+ .
+ The above text is subject to this copyright notice:
+  2010, Oracle and/or its affiliates.
+
+Files: *
+Copyright: 2000, 2015, Oracle and/or its affiliates. All rights reserved.
+License: GPL-2
+
+Files: debian/*
+Copyright:
+ 1997-1998, Scott Hanson <shanson@debian.org>
+ 1997, Christian Schwarz <schwarz@debian.org>
+ 1999-2007, 2009, Christian Hammers <ch@debian.org>
+ 2000-2001, Christopher C. Chimelis <chris@debian.org>
+ 2001, Matthew Wilcox <willy@debian.org>
+ 2005-2007, sean finney <seanius@debian.org>
+ 2006, Adam Conrad <adconrad@0c3.net>
+ 2007-2011, Norbert Tretkowski <norbert@tretkowski.de>
+ 2007-2008, Monty Taylor <mordred@inaugust.com>
+ 2008, Devin Carraway <devin@debian.org>
+ 2008, Steffen Joeris <white@debian.org>
+ 2010, Xavier Oswald <xoswald@debian.org>
+ 2011, Clint Byrum <clint@ubuntu.com>
+ 2011, Ondej Sur <ondrej@debian.org>
+ 2012, Nicholas Bamber <nicholas@periapt.co.uk>
+License: GPL-2+
+
+Files: debian/additions/mysqlreport*
+Copyright: 2006-2008, Daniel Nichter <public@codenode.com>
+License: GPL-2+
+
+Files: debian/additions/innotop/*
+Copyright: 2006, Baron Schwartz <baron at xaprb dot com>
+License: Artistic or GPL-2
+
+Files: cmd-line-utils/libedit/config.h
+ dbug/example1.c
+ dbug/example2.c
+ dbug/example3.c
+ dbug/factorial.c
+ dbug/main.c
+ dbug/my_main.c
+ dbug/remove_function_from_trace.pl
+ dbug/tests.c
+ dbug/tests-t.pl
+ extra/yassl/src/dummy.cpp
+ include/probes_mysql_nodtrace.h
+ libmysqld/resource.h
+ mysql-test/*
+ regex/*
+ sql-bench/graph-compare-results.sh
+ storage/ndb/bin/*
+ storage/ndb/demos/*
+ support-files/binary-configure.sh
+ support-files/my-huge.cnf.sh
+ support-files/my-innodb-heavy-4G.cnf.sh
+ support-files/my-large.cnf.sh
+ support-files/my-medium.cnf.sh
+ support-files/my-small.cnf.sh
+ support-files/mysqld_multi.server.sh
+ support-files/mysql-log-rotate.sh
+ support-files/mysql.server-sys5.sh
+ Docs/*
+Copyright: UNKNOWN
+Comment: These files fall under the blanket license specified in the file
+ COPYING and README
+License: GPL-2
+ GPLv2 Disclaimer
+ For the avoidance of doubt, except that if any license choice
+ other than GPL or LGPL is available it will apply instead,
+ Oracle elects to use only the General Public License version 2
+ (GPLv2) at this time for any software where a choice of GPL
+ license versions is made available with the language indicating
+ that GPLv2 or any later version may be used, or where a choice
+ of which version of the GPL is applied is otherwise unspecified.
+
+Files: BUILD/*
+ client/*
+ client/echo.c
+ client/get_password.c
+ cmake/*
+ dbug/dbug_add_tags.pl
+ extra/*
+ include/*
+ libmysql/*
+ libmysqld/*
+ libservices/*
+ mysql-test/include/have_perfschema.inc
+ mysql-test/lib/mtr_cases.pm
+ mysql-test/lib/mtr_gcov.pl
+ mysql-test/lib/mtr_gprof.pl
+ mysql-test/lib/mtr_io.pl
+ mysql-test/lib/mtr_match.pm
+ mysql-test/lib/mtr_misc.pl
+ mysql-test/lib/mtr_process.pl
+ mysql-test/lib/mtr_report.pm
+ mysql-test/lib/mtr_results.pm
+ mysql-test/lib/mtr_stress.pl
+ mysql-test/lib/mtr_unique.pm
+ mysql-test/lib/My/Config.pm
+ mysql-test/lib/My/CoreDump.pm
+ mysql-test/lib/My/File/*
+ mysql-test/lib/My/Find.pm
+ mysql-test/lib/My/Handles.pm
+ mysql-test/lib/My/Options.pm
+ mysql-test/lib/My/Platform.pm
+ mysql-test/lib/My/SafeProcess/Base.pm
+ mysql-test/lib/My/SafeProcess/safe_kill_win.cc
+ mysql-test/lib/My/SafeProcess/safe_process.cc
+ mysql-test/lib/My/SafeProcess/safe_process.pl
+ mysql-test/lib/My/SafeProcess/safe_process_win.cc
+ mysql-test/lib/My/SysInfo.pm
+ mysql-test/lib/My/Test.pm
+ mysql-test/lib/t/*
+ mysql-test/lib/v1/mtr_cases.pl
+ mysql-test/lib/v1/mtr_gcov.pl
+ mysql-test/lib/v1/mtr_gprof.pl
+ mysql-test/lib/v1/mtr_im.pl
+ mysql-test/lib/v1/mtr_io.pl
+ mysql-test/lib/v1/mtr_match.pl
+ mysql-test/lib/v1/mtr_misc.pl
+ mysql-test/lib/v1/mtr_process.pl
+ mysql-test/lib/v1/mtr_report.pl
+ mysql-test/lib/v1/mtr_stress.pl
+ mysql-test/lib/v1/mtr_timer.pl
+ mysql-test/lib/v1/mtr_unique.pl
+ mysql-test/lib/v1/My/*
+ mysql-test/lib/v1/mysql-test-run.pl
+ mysql-test/mysql-stress-test.pl
+ mysql-test/mysql-test-run.pl
+ mysql-test/std_data/*
+ mysql-test/suite/perfschema/include/*
+ mysql-test/suite/perfschema_stress/include/*
+ mysys/*
+ packaging/WiX/ca/*
+ plugin/audit_null/*
+ plugin/auth/*
+ plugin/daemon_example/*
+ plugin/fulltext/*
+ plugin/semisync/semisync_slave.cc
+ plugin/semisync/semisync_slave.h
+ scripts/*
+ sql/*
+ sql-common/*
+ storage/*
+ strings/*
+ support-files/config.huge.ini.sh
+ support-files/config.medium.ini.sh
+ support-files/config.small.ini.sh
+ support-files/MacOSX/Description.plist.sh
+ support-files/MacOSX/Info.plist.sh
+ support-files/MacOSX/StartupParameters.plist.sh
+ support-files/MySQL-shared-compat.spec.sh
+ support-files/mysql.spec.sh
+ support-files/ndb-config-2-node.ini.sh
+ tests/*
+ unittest/*
+ vio/*
+Copyright: 1979-2008 MySQL AB
+           1995-2010 MySQL AB Sun Microsystems Inc
+           1994-1997,2000-2011 Oracle and/or its affiliates.
+License: GPL-2
+
+Files: storage/innobase/*
+Copyright: 1994-2011 Innobase Oy.
+License: GPL-2
+
+Files: cmd-line-utils/readline/*
+Copyright: 1987-2006 Free Software Foundation Inc
+License: GPL-2+
+
+Files: cmd-line-utils/libedit/*
+Copyright: 1989-1990,1992-1993 The Regents of the University of California.
+License: BSD (3 clause)
+
+Files: cmd-line-utils/libedit/chartype.* cmd-line-utils/libedit/eln.c
+Copyright: 2009, The NetBSD Foundation, Inc.
+License: BSD (4 clause)
+
+Files: cmd-line-utils/libedit/filecomplete.c
+ cmd-line-utils/libedit/filecomplete.h
+ cmd-line-utils/libedit/np/fgetln.c
+ cmd-line-utils/libedit/read.h
+ cmd-line-utils/libedit/readline.c
+ cmd-line-utils/libedit/readline/*
+Copyright: 1997-2001 The NetBSD Foundation Inc
+License: BSD (2 clause)
+ This code is derived from software contributed to The NetBSD Foundation
+ by Jaromir Dolecek.
+ .
+ Redistribution and use in source and binary forms, with or without
+ modification, are permitted provided that the following conditions
+ are met:
+ 1. Redistributions of source code must retain the above copyright
+    notice, this list of conditions and the following disclaimer.
+ 2. Redistributions in binary form must reproduce the above copyright
+    notice, this list of conditions and the following disclaimer in the
+    documentation and/or other materials provided with the distribution.
+ .
+ THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS
+ ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
+ TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
+ PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR CONTRIBUTORS
+ BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
+ CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
+ SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
+ INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
+ CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
+ POSSIBILITY OF SUCH DAMAGE.
+
+Files: client/completion_hash.h
+ scripts/mysqlaccess.sh
+ scripts/mysql_fix_extensions.sh
+ scripts/mysql_setpermission.sh
+ sql-bench/*
+ storage/myisam/ftbench/ft-test-run.sh
+ storage/myisam/mi_test_all.sh
+ storage/ndb/test/run-test/atrt-*
+ storage/ndb/test/run-test/make-config.sh
+ storage/ndb/test/run-test/make-html-reports.sh
+ storage/ndb/test/run-test/make-index.sh
+ storage/ndb/test/run-test/ndb-autotest.sh
+ strings/strxmov.c
+ strings/strxnmov.c
+ strings/ctype-uca.c
+ strings/ctype-ucs2.c
+ strings/strend.c
+ strings/ctype-utf8.c
+ support-files/MacOSX/postflight.sh
+ support-files/MacOSX/preflight.sh
+ mysql-test/lib/My/SafeProcess.pm
+ mysql-test/lib/My/ConfigFactory.pm
+ mysql-test/lib/mtr_misc.pl
+ mysql-test/mysql-stress-test.pl
+ BUILD/*.sh
+ BUILD/compile-amd64-debug-max-no-ndb
+ BUILD/compile-solaris-amd64
+ BUILD/compile-amd64-valgrind-max
+ BUILD/compile-pentium64-max
+ BUILD/compile-pentium64
+ BUILD/compile-pentium-valgrind-max-no-ndb
+ scripts/mysqlhotcopy.sh
+ scripts/mysqld_multi.sh
+ mysql-test/lib/mtr_misc.pl
+ mysql-test/mysql-stress-test.pl
+ mysql-test/std_data/checkDBI_DBD-mysql.pl
+Copyright: 2000-2009 MySQL AB Sun Microsystems Inc
+           2000-2007 MySQL AB
+License: LGPL
+
+Files: storage/archive/azio.c
+ storage/archive/azlib.h
+ zlib/*
+Copyright: 1995-2005 Jean-loup Gailly and Mark Adler
+License: zlib/libpng
+  This software is provided 'as-is', without any express or implied
+  warranty.  In no event will the authors be held liable for any damages
+  arising from the use of this software.
+  .
+  Permission is granted to anyone to use this software for any purpose,
+  including commercial applications, and to alter it and redistribute it
+  freely, subject to the following restrictions:
+  .
+  1. The origin of this software must not be misrepresented; you must not
+     claim that you wrote the original software. If you use this software
+     in a product, an acknowledgment in the product documentation would be
+     appreciated but is not required.
+  2. Altered source versions must be plainly marked as such, and must not be
+     misrepresented as being the original software.
+  3. This notice may not be removed or altered from any source distribution.
+
+Files: sql-bench/innotest1.sh
+ sql-bench/innotest1a.sh
+ sql-bench/innotest1b.sh
+ sql-bench/innotest2.sh
+ sql-bench/innotest2a.sh
+ sql-bench/innotest2b.sh
+Copyright: 2000-2002 Innobase Oy & MySQL AB
+Comment: These files fall under the blanket license specified in the file COPYING
+License: GPL-2
+
+Files: storage/innobase/btr/btr0sea.c
+ storage/innobase/include/log0log.h
+ storage/innobase/include/os0sync.h
+ storage/innobase/log/log0log.c
+ storage/innobase/row/row0sel.c
+Copyright: 1995-1997,2009-2010 Innobase Oy.
+ 2008-2009 Google Inc
+License: GPL-2
+
+Files: storage/innobase/btr/btr0cur.c
+ storage/innobase/buf/buf0buf.c
+ storage/innobase/include/sync0rw.h
+ storage/innobase/include/sync0sync.h
+ storage/innobase/sync/*
+Copyright: 1994-2011 Oracle and/or its affiliates.
+ 2008 Google Inc
+License: GPL-2
+
+Files: storage/myisam/rt_index.h
+ storage/myisam/rt_key.c
+ storage/myisam/rt_mbr.c
+ storage/myisam/rt_mbr.h
+ storage/myisam/sp_defs.h
+Copyright: 2000,2002-2006 MySQL AB & Ramil Kalimullin
+License: GPL-2
+
+Files: storage/innobase/include/ut0bh.h
+ storage/innobase/trx/trx0rseg.c
+ storage/innobase/ut/ut0bh.c
+ storage/innobase/ut/ut0ut.c
+Copyright: 1996,2010-2011 Oracle Corpn.
+License: GPL-2
+
+Files: plugin/semisync/semisync.cc
+ plugin/semisync/semisync.h
+ plugin/semisync/semisync_slave_plugin.cc
+Copyright: 2008 MySQL AB
+ 2007 Google Inc
+License: GPL-2
+
+Files: strings/ctype-bin.c
+ strings/ctype-eucjpms.c
+ strings/ctype-ujis.c
+Copyright: 2000,2002,2005-2011 Oracle and/or its affiliates. & tommy@valley.ne.jp
+License: LGPL
+ On Debian and systems the full text of the GNU Library General Public
+ License version 2 can be found in the file
+ `/usr/share/common-licenses/LGPL-2`
+
+Files: scripts/mysqld_safe.sh
+ support-files/mysql-multi.server.sh
+ support-files/mysql.server.sh
+Copyright: 1996 Abandoned TCX DataKonsult AB & Monty Program KB & Detron HB
+License: public-domain
+ This file is public domain and comes with NO WARRANTY of any kind
+
+Files: sql/sql_yacc.cc
+ sql/sql_yacc.h
+Copyright: 1984,1989-1990,2000-2006 Free Software Foundation, Inc.
+License: GPL-2+
+
+Files: storage/innobase/include/pars0grm.h
+ storage/innobase/pars/pars0grm.c
+Copyright: 1995-2009 Innobase Oy.
+ 1984,1989-1990,2000-2004 Free Software Foundation Inc.
+License: GPL-2
+ As a special exception, when this file is copied by Bison into a
+ Bison output file, you may use that output file without restriction.
+ This special exception was added by the Free Software Foundation
+ in version 1.24 of Bison.
+ .
+ This program is free software; you can redistribute it and/or modify it under
+ the terms of the GNU General Public License as published by the Free Software
+ Foundation; version 2 of the License.
+ .
+ This program is distributed in the hope that it will be useful, but WITHOUT
+ ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
+ FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
+ .
+ You should have received a copy of the GNU General Public License along with
+ this program; if not, write to the Free Software Foundation, Inc.,
+ 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA.
+
+Files: storage/innobase/include/srv0srv.h
+ storage/innobase/srv/srv0start.c
+Copyright: 1995-1996,2010-2011 Innobase Oy.
+ 2008-2009 Google Inc
+ 2009 Percona Inc
+License: GPL-2
+
+Files: plugin/semisync/semisync_master.cc
+ plugin/semisync/semisync_master_plugin.cc
+Copyright: 2008-2009 MySQL AB Sun Microsystems Inc
+ 2007 Google Inc
+License: GPL-2
+
+Files: storage/innobase/include/os0file.h
+ storage/innobase/os/os0file.c
+Copyright: 1995-2010 Innobase Oy.
+ 2009 Percona Inc
+License: GPL-2
+
+Files: include/t_ctype.h
+ strings/t_ctype.h
+Copyright: 2000 MySQL AB
+ 1998 Theppitak Karoonboonyanan
+ 1998-1999 Pruet Boonma
+License: GPL-2
+
+Files: cmd-line-utils/libedit/np/strlcat.c
+ cmd-line-utils/libedit/np/strlcpy.c
+Copyright: 1998 Todd C. Miller <Todd.Miller@courtesan.com>
+License: ISC
+ Permission to use, copy, modify, and distribute this software for any
+ purpose with or without fee is hereby granted, provided that the above
+ copyright notice and this permission notice appear in all copies.
+ .
+ THE SOFTWARE IS PROVIDED "AS IS" AND TODD C. MILLER DISCLAIMS ALL
+ WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES
+ OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL TODD C. MILLER BE LIABLE
+ FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
+ WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION
+ OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN
+ CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
+
+Files: sql/nt_servc.cc
+ sql/nt_servc.h
+Copyright: 1998 Abandoned Irena Pancirov - Irnet Snc
+License: public-domain
+ This file is public domain and comes with NO WARRANTY of any kind
+
+Files: dbug/dbug.c
+ dbug/dbug_long.h
+Copyright: 1987 Abandoned Fred Fish
+License: public-domain
+ N O T I C E
+ .
+ Copyright Abandoned, 1987, Fred Fish
+ .
+ .
+ This previously copyrighted work has been placed into the  public
+ domain	by  the  author  and  may be freely used for any purpose,
+ private or commercial.
+ .
+ Because of the number of inquiries I was receiving about the  use
+ of this product in commercially developed works I have decided to
+ simply make it public domain to further its unrestricted use.	I
+ specifically  would  be  most happy to see this material become a
+ part of the standard Unix distributions by AT&T and the  Berkeley
+ Computer  Science  Research Group, and a standard part of the GNU
+ system from the Free Software Foundation.
+ .
+ I would appreciate it, as a courtesy, if this notice is  left  in
+ all copies and derivative works.  Thank you.
+ .
+ The author makes no warranty of any kind  with	respect  to  this
+ product  and  explicitly disclaims any implied warranties of mer-
+ chantability or fitness for any particular purpose.
+
+Files: cmd-line-utils/libedit/np/vis.c
+Copyright: 1989-1993 The Regents of the University of California.
+ 1999-2005 The NetBSD Foundation Inc
+License: BSD (3 clause)
+ Redistribution and use in source and binary forms, with or without
+ modification, are permitted provided that the following conditions
+ are met:
+ 1. Redistributions of source code must retain the above copyright
+    notice, this list of conditions and the following disclaimer.
+ 2. Redistributions in binary form must reproduce the above copyright
+    notice, this list of conditions and the following disclaimer in the
+    documentation and/or other materials provided with the distribution.
+ 3. Neither the name of the University nor the names of its contributors
+    may be used to endorse or promote products derived from this software
+    without specific prior written permission.
+ .
+ THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
+ ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+ IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+ ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
+ FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
+ DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
+ OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+ HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
+ LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
+ OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
+ SUCH DAMAGE.
+
+Files: scripts/dheadgen.pl
+Copyright: 2008-2009 Sun Microsystems Inc
+License: BSD (3 clause)
+
+Files: storage/ndb/test/src/getarg.c
+Copyright: 1997-2000 - Kungliga Tekniska Hgskolan
+License: BSD (3 clause)
+
+Files: storage/ndb/test/include/getarg.h
+Copyright: 2003 MySQL AB
+ 1997-1999 Kungliga Tekniska Hgskolan
+License: BSD (3 clause) or GPL-2
+
+Files: storage/innobase/handler/ha_innodb.cc
+Copyright: 2008-2009 Google Inc
+ 2009 Percona Inc
+ 2000-2011 MySQL AB & Innobase Oy.
+License: GPL-2
+
+Files: plugin/semisync/semisync_master.h
+Copyright: 2008-2009 MySQL AB Sun Microsystems Inc
+ 2007 Google Inc
+License: GPL-2
+
+Files: storage/innobase/srv/srv0srv.c
+Copyright: 2008-2009 Google Inc
+ 1995-2011 Oracle and/or its affiliates.
+ 2009 Percona Inc
+License: GPL-2
+
+Files: storage/innobase/ut/ut0rbt.c
+Copyright: 2007-2010 Innobase Oy.
+ 2007 Oracle/Innobase Oy
+License: GPL-2
+
+Files: strings/ctype-win1250ch.c
+Copyright: 2002-2010 Oracle and/or its affiliates.
+ 2001 Jan Pazdziora
+License: GPL-2
+
+Files: strings/ctype-tis620.c
+Copyright: 1998 Theppitak Karoonboonyanan <thep@links.nectec.or.th>
+ 1989-1991 Samphan Raruenrom <samphan@thai.com>
+ 2000-2010 Oracle and/or its affiliates.
+ 2003 Sathit Jittanupat
+ 2001 Korakot Chaovavanich <korakot@iname.com> and
+ 1998-1999 Pruet Boonma <pruet@eng.cmu.ac.th>
+License: GPL-2
+
+Files: storage/innobase/handler/ha_innodb.h
+Copyright: 2000-2010 MySQL AB & Innobase Oy.
+License: GPL-2
+
+Files: strings/dtoa.c
+Copyright: 2007-2010 Oracle and/or its affiliates.
+ 1991,2000-2001 Lucent Technologies
+License: LGPL
+
+Files: scripts/mysqldumpslow.sh
+Copyright: 2000-2002,2005-2009 MySQL AB Sun Microsystems Inc
+License: LGPL
+
+Files: libmysqld/lib_sql.cc
+Copyright: 2000 SWsoft  company
+License: SWsoft
+ This material is provided "as is", with absolutely no warranty expressed
+ or implied. Any use is at your own risk.
+ .
+ Permission to use or copy this software for any purpose is hereby granted
+ without fee, provided the above notices are retained on all copies.
+ Permission to modify the code and to distribute modified code is granted,
+ provided the above notices are retained, and a notice that the code was
+ modified is included with the above copyright notice.
+
+Files: tests/mail_to_db.pl
+Copyright: 1998 Abandoned TCX DataKonsult AB & Monty Program KB & Detron HB
+License: public-domain
+ This file is public domain and comes with NO WARRANTY of any kind
+
+Files: dbug/dbug_analyze.c
+Copyright: 1987 June Binayak Banerjee
+License: public-domain
+ This program may be freely distributed under the same terms and
+ conditions as Fred Fish's Dbug package.
+
+Files: regex/regexp.c
+Copyright: 1986 University of Toronto
+License: BSD-like
+ Permission is granted to anyone to use this software for any
+ purpose on any computer system, and to redistribute it freely,
+ subject to the following restrictions:
+ .
+ 1. The author is not responsible for the consequences of use of
+        this software, no matter how awful, even if they arise
+    from defects in it.
+ .
+ 2. The origin of this software must not be misrepresented, either
+    by explicit claim or by omission.
+ .
+ 3. Altered versions must be plainly marked as such, and must not
+    be misrepresented as being the original software.
+
+License: Artistic
+ This program is free software; you can redistribute it and/or modify
+ it under the terms of the Artistic License, which comes with Perl.
+ .
+ On Debian systems, the complete text of the Artistic License can be
+ found in `/usr/share/common-licenses/Artistic'.
+
+License: GPL-2
+ This program is free software; you can redistribute it and/or modify
+ it under the terms of the GNU General Public License as published by
+ the Free Software Foundation; version 2 of the License.
+ .
+ This program is distributed in the hope that it will be useful,
+ but WITHOUT ANY WARRANTY; without even the implied warranty of
+ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ GNU General Public License for more details.
+ .
+ You should have received a copy of the GNU General Public License
+ along with this program; if not, write to the Free Software Foundation, Inc.,
+ 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA.
+ .
+ On Debian and systems the full text of the GNU General Public
+ License version 2 can be found in the file
+ `/usr/share/common-licenses/GPL-2`
+
+License: GPL-2+
+ This file is part of GNU Readline, a library for reading lines
+ of text with interactive input and history editing.
+ .
+ Readline is free software; you can redistribute it and/or modify it
+ under the terms of the GNU General Public License as published by the
+ Free Software Foundation; either version 2, or (at your option) any
+ later version.
+ .
+ Readline is distributed in the hope that it will be useful, but
+ WITHOUT ANY WARRANTY; without even the implied warranty of
+ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ General Public License for more details.
+ .
+ You should have received a copy of the GNU General Public License
+ along with Readline; see the file COPYING.  If not, write to the Free
+ Software Foundation, 59 Temple Place, Suite 330, Boston, MA 02111 USA. */
+ .
+ On Debian and systems the full text of the GNU General Public
+ License version 2 can be found in the file
+ `/usr/share/common-licenses/GPL-2`
+
+License: LGPL
+ This library is free software; you can redistribute it and/or
+ modify it under the terms of the GNU Library General Public
+ License as published by the Free Software Foundation; version 2
+ of the License.
+ .
+ This library is distributed in the hope that it will be useful,
+ but WITHOUT ANY WARRANTY; without even the implied warranty of
+ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ Library General Public License for more details.
+ .
+ You should have received a copy of the GNU Library General Public
+ License along with this library; if not, write to the Free
+ Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston,
+ MA 02110-1301, USA
+ .
+ On Debian and systems the full text of the GNU Library General Public
+ License version 2 can be found in the file
+ `/usr/share/common-licenses/LGPL-2`
+
+License: BSD (3 clause)
+ Redistribution and use in source and binary forms, with or without
+ modification, are permitted provided that the following conditions
+ are met:
+ 1. Redistributions of source code must retain the above copyright
+    notice, this list of conditions and the following disclaimer.
+ 2. Redistributions in binary form must reproduce the above copyright
+    notice, this list of conditions and the following disclaimer in the
+    documentation and/or other materials provided with the distribution.
+ 3. Neither the name of the University nor the names of its contributors
+    may be used to endorse or promote products derived from this software
+    without specific prior written permission.
+ .
+ THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
+ ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+ IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+ ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
+ FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
+ DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
+ OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+ HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
+ LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
+ OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
+ SUCH DAMAGE.
+
+License: BSD (4 clause)
+ Redistribution and use in source and binary forms, with or without
+ modification, are permitted provided that the following conditions
+ are met:
+ 1. Redistributions of source code must retain the above copyright
+    notice, this list of conditions and the following disclaimer.
+ 2. Redistributions in binary form must reproduce the above copyright
+    notice, this list of conditions and the following disclaimer in the
+    documentation and/or other materials provided with the distribution.
+ 3. All advertising materials mentioning features or use of this software
+    must display the following acknowledgement:
+        This product includes software developed by the NetBSD
+        Foundation, Inc. and its contributors.
+ 4. Neither the name of The NetBSD Foundation nor the names of its
+    contributors may be used to endorse or promote products derived
+    from this software without specific prior written permission.
+ .
+ THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS
+ ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
+ TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
+ PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR CONTRIBUTORS
+ BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
+ CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
+ SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
+ INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
+ CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
+ POSSIBILITY OF SUCH DAMAGE.
diff -uNr mysql-5.5.60.orig/debian/gbp.conf mysql-5.5.60/debian/gbp.conf
--- mysql-5.5.60.orig/debian/gbp.conf	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/gbp.conf	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,3 @@
+[DEFAULT]
+debian-branch = master
+pristine-tar = True
diff -uNr mysql-5.5.60.orig/debian/libmysqlclient-dev.README.Maintainer mysql-5.5.60/debian/libmysqlclient-dev.README.Maintainer
--- mysql-5.5.60.orig/debian/libmysqlclient-dev.README.Maintainer	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/libmysqlclient-dev.README.Maintainer	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,4 @@
+The examples directory includes files that might be needed by some
+developers:
+- header files not installed by default
+- the example file udf_example.c
diff -uNr mysql-5.5.60.orig/debian/libmysqlclient-dev.dirs mysql-5.5.60/debian/libmysqlclient-dev.dirs
--- mysql-5.5.60.orig/debian/libmysqlclient-dev.dirs	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/libmysqlclient-dev.dirs	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,2 @@
+usr/include/
+usr/lib/
diff -uNr mysql-5.5.60.orig/debian/libmysqlclient-dev.examples mysql-5.5.60/debian/libmysqlclient-dev.examples
--- mysql-5.5.60.orig/debian/libmysqlclient-dev.examples	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/libmysqlclient-dev.examples	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1 @@
+sql/udf_example.c
diff -uNr mysql-5.5.60.orig/debian/libmysqlclient-dev.files mysql-5.5.60/debian/libmysqlclient-dev.files
--- mysql-5.5.60.orig/debian/libmysqlclient-dev.files	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/libmysqlclient-dev.files	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,11 @@
+usr/bin/mysql_config
+usr/include/mysql/*
+usr/lib/*/libmysqlclient.a
+usr/lib/*/libmysqlclient.so
+usr/lib/*/libmysqlclient_r.a
+usr/lib/*/libmysqlclient_r.so
+usr/lib/*/mysql/plugin/ha_example.*
+usr/lib/*/mysql/plugin/ha_*_plugin.a
+usr/lib/*/mysql/plugin/ha_*_plugin.la
+usr/share/aclocal/mysql.m4
+usr/share/man/man1/mysql_config.1
diff -uNr mysql-5.5.60.orig/debian/libmysqlclient18.dirs mysql-5.5.60/debian/libmysqlclient18.dirs
--- mysql-5.5.60.orig/debian/libmysqlclient18.dirs	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/libmysqlclient18.dirs	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1 @@
+usr/lib/
diff -uNr mysql-5.5.60.orig/debian/libmysqlclient18.install mysql-5.5.60/debian/libmysqlclient18.install
--- mysql-5.5.60.orig/debian/libmysqlclient18.install	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/libmysqlclient18.install	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,2 @@
+usr/lib/*/libmysqlclient.so.*
+usr/lib/*/libmysqlclient_r.so.*
diff -uNr mysql-5.5.60.orig/debian/libmysqld-dev.install mysql-5.5.60/debian/libmysqld-dev.install
--- mysql-5.5.60.orig/debian/libmysqld-dev.install	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/libmysqld-dev.install	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,2 @@
+usr/lib/*/libmysqld.a
+usr/lib/*/libmysqlservices.a
diff -uNr mysql-5.5.60.orig/debian/libmysqld-pic.README.Debian mysql-5.5.60/debian/libmysqld-pic.README.Debian
--- mysql-5.5.60.orig/debian/libmysqld-pic.README.Debian	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/libmysqld-pic.README.Debian	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,5 @@
+This package was requested in http://bugs.debian.org/508406 because it
+is needed by programs want to include the embedded MySQL into their
+shared libraries.
+
+In order to get the full compile flags, use /bin/mysql_config_pic
diff -uNr mysql-5.5.60.orig/debian/libmysqld-pic.install mysql-5.5.60/debian/libmysqld-pic.install
--- mysql-5.5.60.orig/debian/libmysqld-pic.install	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/libmysqld-pic.install	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,2 @@
+usr/bin/mysql_config_pic
+usr/lib/mysql/libmysqld_pic.a
diff -uNr mysql-5.5.60.orig/debian/mysql-client-5.5.README.Debian mysql-5.5.60/debian/mysql-client-5.5.README.Debian
--- mysql-5.5.60.orig/debian/mysql-client-5.5.README.Debian	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-client-5.5.README.Debian	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,4 @@
+FAQ:
+
+Q: My <tab> completition is gone, why?
+A: You have "no-auto-rehash" in the "[mysql]" section of /etc/mysql/my.cnf!
diff -uNr mysql-5.5.60.orig/debian/mysql-client-5.5.dirs mysql-5.5.60/debian/mysql-client-5.5.dirs
--- mysql-5.5.60.orig/debian/mysql-client-5.5.dirs	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-client-5.5.dirs	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,3 @@
+usr/bin/
+usr/share/man/man1/
+usr/share/perl5/
diff -uNr mysql-5.5.60.orig/debian/mysql-client-5.5.docs mysql-5.5.60/debian/mysql-client-5.5.docs
--- mysql-5.5.60.orig/debian/mysql-client-5.5.docs	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-client-5.5.docs	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,2 @@
+debian/additions/innotop/changelog.innotop
+README
diff -uNr mysql-5.5.60.orig/debian/mysql-client-5.5.files mysql-5.5.60/debian/mysql-client-5.5.files
--- mysql-5.5.60.orig/debian/mysql-client-5.5.files	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-client-5.5.files	2018-04-19 04:28:36.000000000 +0800
@@ -0,0 +1,38 @@
+usr/bin/mysql
+usr/bin/mysqlcheck
+usr/share/man/man1/mysql.1
+usr/share/man/man1/mysqlcheck.1
+usr/bin/innochecksum
+usr/bin/innotop
+usr/bin/myisam_ftdump
+usr/bin/mysqlaccess
+usr/bin/mysqladmin
+usr/bin/mysqlbug
+usr/bin/mysql_client_test
+usr/bin/mysqldump
+usr/bin/mysqldumpslow
+usr/bin/mysql_find_rows
+usr/bin/mysql_fix_extensions
+usr/bin/mysqlimport
+usr/bin/mysqlreport
+usr/bin/mysqlshow
+usr/bin/mysqlslap
+usr/bin/mysql_waitpid
+usr/bin/mysql_plugin
+usr/share/man/man1/innotop.1
+usr/share/man/man1/myisam_ftdump.1
+usr/share/man/man1/mysqlaccess.1
+usr/share/man/man1/mysqladmin.1
+usr/share/man/man1/mysqlbug.1
+usr/share/man/man1/mysqldump.1
+usr/share/man/man1/mysqldumpslow.1
+usr/share/man/man1/mysql_find_rows.1
+usr/share/man/man1/mysql_fix_extensions.1
+usr/share/man/man1/mysqlimport.1
+usr/share/man/man1/mysqlman.1
+usr/share/man/man1/mysqlreport.1
+usr/share/man/man1/mysqlshow.1
+usr/share/man/man1/mysqlslap.1
+usr/share/man/man1/mysql_tableinfo.1
+usr/share/man/man1/mysql_waitpid.1
+usr/share/man/man1/mysql_plugin.1
diff -uNr mysql-5.5.60.orig/debian/mysql-client-5.5.links mysql-5.5.60/debian/mysql-client-5.5.links
--- mysql-5.5.60.orig/debian/mysql-client-5.5.links	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-client-5.5.links	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,6 @@
+usr/bin/mysqlcheck usr/bin/mysqlrepair
+usr/bin/mysqlcheck usr/bin/mysqlanalyze
+usr/bin/mysqlcheck usr/bin/mysqloptimize
+usr/share/man/man1/mysqlcheck.1.gz usr/share/man/man1/mysqlrepair.1.gz
+usr/share/man/man1/mysqlcheck.1.gz usr/share/man/man1/mysqlanalyze.1.gz
+usr/share/man/man1/mysqlcheck.1.gz usr/share/man/man1/mysqloptimize.1.gz
diff -uNr mysql-5.5.60.orig/debian/mysql-client-5.5.lintian-overrides mysql-5.5.60/debian/mysql-client-5.5.lintian-overrides
--- mysql-5.5.60.orig/debian/mysql-client-5.5.lintian-overrides	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-client-5.5.lintian-overrides	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,2 @@
+# 2012-03-08 periapt
+mysql-client-5.5: binary-without-manpage usr/bin/innochecksum
diff -uNr mysql-5.5.60.orig/debian/mysql-common.dirs mysql-5.5.60/debian/mysql-common.dirs
--- mysql-5.5.60.orig/debian/mysql-common.dirs	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-common.dirs	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1 @@
+etc/mysql/conf.d/
diff -uNr mysql-5.5.60.orig/debian/mysql-common.install mysql-5.5.60/debian/mysql-common.install
--- mysql-5.5.60.orig/debian/mysql-common.install	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-common.install	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,2 @@
+debian/additions/my.cnf etc/mysql/
+debian/tmp/etc/mysql/conf.d/.keepme etc/mysql/conf.d
diff -uNr mysql-5.5.60.orig/debian/mysql-common.postrm mysql-5.5.60/debian/mysql-common.postrm
--- mysql-5.5.60.orig/debian/mysql-common.postrm	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-common.postrm	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,9 @@
+#!/bin/bash
+
+set -e
+
+if [ "$1" = "purge" ]; then
+  rmdir /etc/mysql 2>/dev/null || true
+fi
+
+#DEBHELPER#
diff -uNr mysql-5.5.60.orig/debian/mysql-server-5.5.NEWS mysql-5.5.60/debian/mysql-server-5.5.NEWS
--- mysql-5.5.60.orig/debian/mysql-server-5.5.NEWS	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-server-5.5.NEWS	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,34 @@
+mysql-dfsg-5.1 (5.1.36-1) unstable; urgency=low
+
+  * Please read http://dev.mysql.com/doc/refman/5.1/en/upgrading-from-5-0.html
+  * Make sure to do a REPAIR TABLE on all tables that use UTF-8 and have a
+    FULLTEXT index.
+
+ -- Christian Hammers <ch@debian.org>  Sat,  4 Jul 2009 02:31:21 +0200
+
+mysql-dfsg-5.0 (5.1.14beta-2) unstable; urgency=low
+
+  * The BerkeleyDB Storage Engine is no longer supported. If the options
+    have-bdb or skip-bdb are found, MySQL will not start. If you have BDB
+    tables, you should change them to use another storage engine before 
+    upgrading to 5.1.   
+
+ -- Monty Taylor <mordred@inaugust.com>  Thu, 18 Jan 2007 12:28:21 -0800
+
+mysql-dfsg-5.0 (5.0.45-2) unstable; urgency=low
+
+  * Binary logging is now disabled by default. If you really need it (e.g. on
+    a replication master), remove the comment from the log_bin line in my.cnf.
+
+ -- Norbert Tretkowski <norbert@tretkowski.de>  Sat, 10 Nov 2007 16:26:35 +0100
+
+mysql-dfsg-5.0 (5.0.18-9) unstable; urgency=low
+
+  * Rotation of the binary logs is now configured in /etc/mysql/my.cnf with
+    "expire-logs-days" which defaults to 20 days. The old file
+    /etc/mysql/debian-log-rotate.conf should be removed together with
+    /etc/cron.daily/mysql-server after this value has been adjusted. Note that
+    the old variable defined the number of files whereas the new one defines 
+    a time span in days.
+
+ -- Christian Hammers <ch@debian.org>  Tue, 24 Jan 2006 22:18:21 +0100
diff -uNr mysql-5.5.60.orig/debian/mysql-server-5.5.README.Debian mysql-5.5.60/debian/mysql-server-5.5.README.Debian
--- mysql-5.5.60.orig/debian/mysql-server-5.5.README.Debian	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-server-5.5.README.Debian	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,109 @@
+* MYSQL WON'T START OR STOP?:
+=============================
+You may never ever delete the special mysql user "debian-sys-maint". This
+user together with the credentials in /etc/mysql/debian.cnf are used by the
+init scripts to stop the server as they would require knowledge of the mysql
+root users password else.
+So in most of the times you can fix the situation by making sure that the
+debian.cnf file contains the right password, e.g. by setting a new one
+(remember to do a "flush privileges" then).
+
+* WHAT TO DO AFTER UPGRADES:
+============================
+The privilege tables are automatically updated so all there is left is read
+the changelogs on dev.mysql.com to see if any changes affect custom apps.
+
+* WHAT TO DO AFTER INSTALLATION:
+================================
+The MySQL manual describes certain steps to do at this stage in a separate
+chapter.  They are not necessary as the Debian packages does them
+automatically.
+
+The only thing that is left over for the admin is 
+ - setting the passwords
+ - creating new users and databases
+ - read the rest of this text
+
+* DOWNGRADING TO 4.0 or 4.1:
+============================
+Unsupported. Period.
+But if you do and get problems or make interesting experiences, mail me, it
+might help others.
+Ok, if you really want, I would recommend to "mysqldump --opt" all tables,
+then purge 4.1, delete /var/lib/mysql, install 4.0 and insert the dumps.  Be
+carefully, though, with the "mysql" table, you might not simply overwrite that
+one as the password for the mysql "debian-sys-maint" user is stored in
+/etc/mysql/debian.cnf and needed by /etc/init.d/ to start mysql and check if
+it's alive. 
+
+* SOME APPLICATION CAN NO LONGER CONNECT:
+=========================================
+This application is probably linked against libmysqlclient12 or below and
+somebody has created a mysql user with new-style passwords.
+The old_passwords=1 option in /etc/mysql/my.cnf might help. If not the
+application that inserted the user has to be changed or the application that
+tries to connect updated to libmysqlclient14 or -15.
+
+* NETWORKING:
+=============
+For security reasons, the Debian package has enabled networking only on the
+loop-back device using "bind-address" in /etc/mysql/my.cnf.  Check with
+"netstat -tlnp" where it is listening. If your connection is aborted
+immediately see if "mysqld: all" or similar is in /etc/hosts.allow and read
+hosts_access(5).
+
+* WHERE IS THE DOCUMENTATION?:
+==============================
+Unfortunately due to licensing restrictions, debian currently not able
+to provide the mysql-doc package in any format.  For the most up to date
+documentation, please go to http://dev.mysql.com/doc.
+
+* PASSWORDS:
+============
+It is strongly recommended to set a password for the mysql root user (which
+  /usr/bin/mysql -u root -D mysql -e "update user set password=password('new-password') where user='root'"
+  /usr/bin/mysql -u root -e "flush privileges"
+If you already had a password set add "-p" before "-u" to the lines above.
+
+
+If you are tired to type the password in every time or want to automate your
+scripts you can store it in the file $HOME/.my.cnf. It should be chmod 0600
+(-rw------- username username .my.cnf) to ensure that nobody else can read
+it.  Every other configuration parameter can be stored there, too. You will
+find an example below and more information in the MySQL manual in
+/usr/share/doc/mysql-doc or www.mysql.com.
+
+ATTENTION: It is necessary, that a .my.cnf from root always contains a "user"
+line wherever there is a "password" line, else, the Debian maintenance
+scripts, that use /etc/mysql/debian.cnf, will use the username
+"debian-sys-maint" but the password that is in root's .my.cnf. Also note,
+that every change you make in the /root/.my.cnf will affect the mysql cron
+script, too.
+
+        # an example of $HOME/.my.cnf
+	[client]
+	user		= your-mysql-username
+	password	= enter-your-good-new-password-here
+
+* BIG_ROWS FOR EVEN MORE ROWS IN A TABLE:
+=========================================
+If you ever run out of rows in a table there is the possibility of building
+the package with "-DBIG_ROWS" which, according to a MySQL employee on
+packagers@lists.mysql.com should lead to a 64bit row index (I guess > 2^32
+rows) but also to an approx. 5% performance loss.
+
+* BerkeleyDB Storage Engine
+===========================
+Support for BerkeleyDB has been removed in 5.1, and consequently both the
+have-bdb and skip-bdb configuration options will cause the server to fail. 
+Removing the options from /etc/mysql/my.cnf will fix this problem.
+
+* FURTHER NOTES ON REPLICATION
+===============================
+If the MySQL server is acting as a replication slave, you should not
+set --tmpdir to point to a directory on a memory-based filesystem or to
+a directory that is cleared when the server host restarts. A replication
+slave needs some of its temporary files to survive a machine restart so
+that it can replicate temporary tables or LOAD DATA INFILE operations. If
+files in the temporary file directory are lost when the server restarts,
+replication fails.
diff -uNr mysql-5.5.60.orig/debian/mysql-server-5.5.config mysql-5.5.60/debian/mysql-server-5.5.config
--- mysql-5.5.60.orig/debian/mysql-server-5.5.config	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-server-5.5.config	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,48 @@
+#!/bin/bash
+
+set -e
+
+. /usr/share/debconf/confmodule
+
+if [ -n "$DEBIAN_SCRIPT_DEBUG" ]; then set -v -x; DEBIAN_SCRIPT_TRACE=1; fi
+${DEBIAN_SCRIPT_TRACE:+ echo "#42#DEBUG# RUNNING $0 $*" 1>&2 }
+
+CNF=/etc/mysql/my.cnf
+
+# Beware that there are two ypwhich one of them needs the 2>/dev/null!
+if test -n "`which ypwhich 2>/dev/null`"  &&  ypwhich >/dev/null 2>&1; then
+  db_input high mysql-server-5.5/nis_warning || true
+  db_go
+fi
+
+# only ask this question on fresh installs, during "reconfiguration" and when 
+# not upgrading from an existing 5.0 installation.
+# there is also an additional check for empty root passwords in the
+# postinst script when the tools are available for us to use.
+if [ "$1" = "configure" ] && ([ -z "$2" ] && [ ! -e "/var/lib/mysql/debian-5.0.flag" ] ) || [ "$1" = "reconfigure" ]; then
+  while :; do
+    RET=""
+    db_input high mysql-server/root_password || true
+    db_go
+    db_get mysql-server/root_password
+    # if password isn't empty we ask for password verification
+    if [ -z "$RET" ]; then
+      db_fset mysql-server/root_password seen false
+      db_fset mysql-server/root_password_again seen false
+      break
+    fi
+    ROOT_PW="$RET"
+    db_input high mysql-server/root_password_again || true
+    db_go
+    db_get mysql-server/root_password_again
+    if [ "$RET" == "$ROOT_PW" ]; then
+      ROOT_PW=''
+      break
+    fi
+    db_fset mysql-server/password_mismatch seen false
+    db_input critical mysql-server/password_mismatch
+    db_set mysql-server/root_password "" 
+    db_set mysql-server/root_password_again ""
+    db_go
+  done
+fi
diff -uNr mysql-5.5.60.orig/debian/mysql-server-5.5.dirs mysql-5.5.60/debian/mysql-server-5.5.dirs
--- mysql-5.5.60.orig/debian/mysql-server-5.5.dirs	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-server-5.5.dirs	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,6 @@
+etc/init.d
+etc/logrotate.d
+etc/mysql/conf.d
+usr/bin
+usr/share/mysql
+var/lib/mysql-upgrade
diff -uNr mysql-5.5.60.orig/debian/mysql-server-5.5.files mysql-5.5.60/debian/mysql-server-5.5.files
--- mysql-5.5.60.orig/debian/mysql-server-5.5.files	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-server-5.5.files	2018-04-19 04:28:36.000000000 +0800
@@ -0,0 +1,57 @@
+usr/lib/mysql/*so*
+usr/lib/mysql/plugin/*.so
+etc/mysql/debian-start
+etc/mysql/conf.d/mysqld_safe_syslog.cnf
+usr/bin/msql2mysql
+usr/bin/myisamchk
+usr/bin/myisamlog
+usr/bin/myisampack
+usr/bin/mysql_convert_table_format
+usr/bin/mysql_secure_installation
+usr/bin/mysql_setpermission
+usr/bin/mysql_tzinfo_to_sql
+usr/bin/mysql_zap
+usr/bin/mysqlbinlog
+usr/bin/mysqld_multi
+usr/bin/mysqld_safe
+usr/bin/mysqlhotcopy
+usr/bin/mysqltest
+usr/bin/perror
+usr/bin/replace
+usr/bin/resolve_stack_dump
+usr/bin/resolveip
+usr/share/doc/mysql-server-5.5/
+usr/share/man/man1/msql2mysql.1
+usr/share/man/man1/myisamchk.1
+usr/share/man/man1/myisamlog.1
+usr/share/man/man1/myisampack.1
+usr/share/man/man1/mysqlbinlog.1
+usr/share/man/man1/mysql_convert_table_format.1
+usr/share/man/man1/mysqld_multi.1
+usr/share/man/man1/mysqld_safe.1
+usr/share/man/man1/mysqlhotcopy.1
+usr/share/man/man1/mysql_secure_installation.1
+usr/share/man/man1/mysql_setpermission.1
+usr/share/man/man1/mysqltest.1
+usr/share/man/man1/mysql_zap.1
+usr/share/man/man1/perror.1
+usr/share/man/man1/replace.1
+usr/share/man/man1/resolveip.1
+usr/share/man/man1/resolve_stack_dump.1
+usr/share/man/man1/innochecksum.1
+usr/share/man/man1/mysql_tzinfo_to_sql.1
+usr/share/mysql/debian-start.inc.sh
+usr/share/mysql/echo_stderr
+usr/share/mysql/errmsg-utf8.txt
+usr/share/mysql/mysqld_multi.server
+usr/share/mysql/mysql_test_data_timezone.sql
+usr/share/mysql/config.huge.ini
+usr/share/mysql/config.medium.ini
+usr/share/mysql/config.small.ini
+usr/share/mysql/ndb-config-2-node.ini
+usr/share/mysql/debian-start.inc.sh
+usr/share/mysql/echo_stderr
+usr/share/mysql/errmsg-utf8.txt
+usr/share/mysql/mysqld_multi.server
+usr/share/mysql/mysql_test_data_timezone.sql
+etc/apparmor.d/usr.sbin.mysqld
diff -uNr mysql-5.5.60.orig/debian/mysql-server-5.5.logcheck.ignore.paranoid mysql-5.5.60/debian/mysql-server-5.5.logcheck.ignore.paranoid
--- mysql-5.5.60.orig/debian/mysql-server-5.5.logcheck.ignore.paranoid	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-server-5.5.logcheck.ignore.paranoid	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,9 @@
+/etc/init.d/mysql\[[0-9]+\]: Check that mysqld is running and that the socket: '/var/run/mysqld/mysqld.sock' exists\!$
+/etc/init.d/mysql\[[0-9]+\]: '/usr/bin/mysqladmin --defaults-(extra-)?file=/etc/mysql/debian.cnf ping' resulted in$
+/etc/mysql/debian-start\[[0-9]+\]: Checking for crashed MySQL tables\.$
+mysqld\[[0-9]+\]: $
+mysqld\[[0-9]+\]: Version: .* socket: '/var/run/mysqld/mysqld.sock'  port: 3306$
+mysqld\[[0-9]+\]: Warning: Ignoring user change to 'mysql' because the user was set to 'mysql' earlier on the command line$
+mysqld_safe\[[0-9]+\]: started$
+usermod\[[0-9]+\]: change user `mysql' GID from `([0-9]+)' to `\1'$
+usermod\[[0-9]+\]: change user `mysql' shell from `/bin/false' to `/bin/false'$
diff -uNr mysql-5.5.60.orig/debian/mysql-server-5.5.logcheck.ignore.server mysql-5.5.60/debian/mysql-server-5.5.logcheck.ignore.server
--- mysql-5.5.60.orig/debian/mysql-server-5.5.logcheck.ignore.server	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-server-5.5.logcheck.ignore.server	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,32 @@
+/etc/init.d/mysql\[[0-9]+\]: [0-9]+ processes alive and '/usr/bin/mysqladmin --defaults-(extra-)?file=/etc/mysql/debian.cnf ping' resulted in$
+/etc/init.d/mysql\[[0-9]+\]: Check that mysqld is running and that the socket: '/var/run/mysqld/mysqld.sock' exists\!$
+/etc/init.d/mysql\[[0-9]+\]: '/usr/bin/mysqladmin --defaults-(extra-)?file=/etc/mysql/debian.cnf ping' resulted in$
+/etc/mysql/debian-start\[[0-9]+\]: Checking for crashed MySQL tables\.$
+mysqld\[[0-9]+\]: ?$
+mysqld\[[0-9]+\]: .*InnoDB: Shutdown completed
+mysqld\[[0-9]+\]: .*InnoDB: Started;
+mysqld\[[0-9]+\]: .*InnoDB: Starting shutdown\.\.\.$
+mysqld\[[0-9]+\]: .*\[Note\] /usr/sbin/mysqld: Normal shutdown$
+mysqld\[[0-9]+\]: .*\[Note\] /usr/sbin/mysqld: ready for connections\.$
+mysqld\[[0-9]+\]: .*\[Note\] /usr/sbin/mysqld: Shutdown complete$
+mysqld\[[0-9]+\]: /usr/sbin/mysqld: ready for connections\.$
+mysqld\[[0-9]+\]: .*/usr/sbin/mysqld: Shutdown Complete$
+mysqld\[[0-9]+\]: Version: .* socket
+mysqld\[[0-9]+\]: Warning: Ignoring user change to 'mysql' because the user was set to 'mysql' earlier on the command line$
+mysqld_safe\[[0-9]+\]: ?$
+mysqld_safe\[[0-9]+\]: able to use the new GRANT command!$
+mysqld_safe\[[0-9]+\]: ended$
+mysqld_safe\[[0-9]+\]: http://www.mysql.com$
+mysqld_safe\[[0-9]+\]: NOTE:  If you are upgrading from a MySQL <= 3.22.10 you should run$
+mysqld_safe\[[0-9]+\]: PLEASE REMEMBER TO SET A PASSWORD FOR THE MySQL root USER !$
+mysqld_safe\[[0-9]+\]: Please report any problems with the /usr/bin/mysqlbug script!$
+mysqld_safe\[[0-9]+\]: See the manual for more instructions.$
+mysqld_safe\[[0-9]+\]: started$
+mysqld_safe\[[0-9]+\]: Support MySQL by buying support/licenses at https://order.mysql.com$
+mysqld_safe\[[0-9]+\]: The latest information about MySQL is available on the web at$
+mysqld_safe\[[0-9]+\]: the /usr/bin/mysql_fix_privilege_tables. Otherwise you will not be$
+mysqld_safe\[[0-9]+\]: To do so, start the server, then issue the following commands:$
+mysqld_safe\[[0-9]+\]: /usr/bin/mysqladmin -u root -h app109 password 'new-password'$
+mysqld_safe\[[0-9]+\]: /usr/bin/mysqladmin -u root password 'new-password'$
+usermod\[[0-9]+\]: change user `mysql' GID from `([0-9]+)' to `\1'$
+usermod\[[0-9]+\]: change user `mysql' shell from `/bin/false' to `/bin/false'$
diff -uNr mysql-5.5.60.orig/debian/mysql-server-5.5.logcheck.ignore.workstation mysql-5.5.60/debian/mysql-server-5.5.logcheck.ignore.workstation
--- mysql-5.5.60.orig/debian/mysql-server-5.5.logcheck.ignore.workstation	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-server-5.5.logcheck.ignore.workstation	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,32 @@
+/etc/init.d/mysql\[[0-9]+\]: [0-9]+ processes alive and '/usr/bin/mysqladmin --defaults-(extra-)?file=/etc/mysql/debian.cnf ping' resulted in$
+/etc/init.d/mysql\[[0-9]+\]: Check that mysqld is running and that the socket: '/var/run/mysqld/mysqld.sock' exists\!$
+/etc/init.d/mysql\[[0-9]+\]: '/usr/bin/mysqladmin --defaults-(extra-)?file=/etc/mysql/debian.cnf ping' resulted in$
+/etc/mysql/debian-start\[[0-9]+\]: Checking for crashed MySQL tables\.$
+mysqld\[[0-9]+\]: ?$
+mysqld\[[0-9]+\]: .*InnoDB: Shutdown completed
+mysqld\[[0-9]+\]: .*InnoDB: Started;
+mysqld\[[0-9]+\]: .*InnoDB: Starting shutdown\.\.\.$
+mysqld\[[0-9]+\]: .*\[Note\] /usr/sbin/mysqld: Normal shutdown$
+mysqld\[[0-9]+\]: .*\[Note\] /usr/sbin/mysqld: ready for connections\.$
+mysqld\[[0-9]+\]: .*\[Note\] /usr/sbin/mysqld: Shutdown complete$
+mysqld\[[0-9]+\]: /usr/sbin/mysqld: ready for connections\.$
+mysqld\[[0-9]+\]: .*/usr/sbin/mysqld: Shutdown Complete$
+mysqld\[[0-9]+\]: Version: .* socket
+mysqld\[[0-9]+\]: Warning: Ignoring user change to 'mysql' because the user was set to 'mysql' earlier on the command line$
+mysqld_safe\[[0-9]+\]: ?$
+mysqld_safe\[[0-9]+\]: able to use the new GRANT command!$
+mysqld_safe\[[0-9]+\]: ended$
+mysqld_safe\[[0-9]+\]: http://www.mysql.com$
+mysqld_safe\[[0-9]+\]: NOTE:  If you are upgrading from a MySQL <= 3.22.10 you should run$
+mysqld_safe\[[0-9]+\]: PLEASE REMEMBER TO SET A PASSWORD FOR THE MySQL root USER !$
+mysqld_safe\[[0-9]+\]: Please report any problems with the /usr/bin/mysqlbug script!$
+mysqld_safe\[[0-9]+\]: See the manual for more instructions.$
+mysqld_safe\[[0-9]+\]: started$
+mysqld_safe\[[0-9]+\]: Support MySQL by buying support/licenses at https://order.mysql.com$
+mysqld_safe\[[0-9]+\]: The latest information about MySQL is available on the web at$
+mysqld_safe\[[0-9]+\]: the /usr/bin/mysql_fix_privilege_tables. Otherwise you will not be$
+mysqld_safe\[[0-9]+\]: To do so, start the server, then issue the following commands:$
+mysqld_safe\[[0-9]+\]: /usr/bin/mysqladmin -u root -h app109 password 'new-password'$
+mysqld_safe\[[0-9]+\]: /usr/bin/mysqladmin -u root password 'new-password'$
+usermod\[[0-9]+\]: change user `mysql' GID from `([0-9]+)' to `\1'$
+usermod\[[0-9]+\]: change user `mysql' shell from `/bin/false' to `/bin/false'$
diff -uNr mysql-5.5.60.orig/debian/mysql-server-5.5.mysql-server.logrotate mysql-5.5.60/debian/mysql-server-5.5.mysql-server.logrotate
--- mysql-5.5.60.orig/debian/mysql-server-5.5.mysql-server.logrotate	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-server-5.5.mysql-server.logrotate	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,26 @@
+# - I put everything in one block and added sharedscripts, so that mysql gets 
+#   flush-logs'd only once.
+#   Else the binary logs would automatically increase by n times every day.
+/var/log/mysql.log /var/log/mysql/mysql.log /var/log/mysql/mysql-slow.log /var/log/mysql/error.log {
+	daily
+	rotate 7
+	missingok
+	create 640 mysql adm
+	compress
+	sharedscripts
+	postrotate
+		test -x /usr/bin/mysqladmin || exit 0
+		# If this fails, check debian.conf! 
+		MYADMIN="/usr/bin/mysqladmin --defaults-file=/etc/mysql/debian.cnf"
+		if [ -z "`$MYADMIN ping 2>/dev/null`" ]; then
+		  # Really no mysqld or rather a missing debian-sys-maint user?
+		  # If this occurs and is not a error please report a bug.
+		  #if ps cax | grep -q mysqld; then
+		  if killall -q -s0 -umysql mysqld; then
+ 		    exit 1
+		  fi 
+		else
+		  $MYADMIN flush-logs
+		fi
+	endscript
+}
diff -uNr mysql-5.5.60.orig/debian/mysql-server-5.5.mysql.init mysql-5.5.60/debian/mysql-server-5.5.mysql.init
--- mysql-5.5.60.orig/debian/mysql-server-5.5.mysql.init	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-server-5.5.mysql.init	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,188 @@
+#!/bin/bash
+#
+### BEGIN INIT INFO
+# Provides:          mysql
+# Required-Start:    $remote_fs $syslog
+# Required-Stop:     $remote_fs $syslog
+# Should-Start:      $network $time
+# Should-Stop:       $network $time
+# Default-Start:     2 3 4 5
+# Default-Stop:      0 1 6
+# Short-Description: Start and stop the mysql database server daemon
+# Description:       Controls the main MySQL database server daemon "mysqld"
+#                    and its wrapper script "mysqld_safe".
+### END INIT INFO
+#
+set -e
+set -u
+${DEBIAN_SCRIPT_DEBUG:+ set -v -x}
+
+test -x /usr/bin/mysqld_safe || exit 0
+
+. /lib/lsb/init-functions
+
+SELF=$(cd $(dirname $0); pwd -P)/$(basename $0)
+CONF=/etc/mysql/my.cnf
+MYADMIN="/usr/bin/mysqladmin --defaults-file=/etc/mysql/debian.cnf"
+
+# priority can be overriden and "-s" adds output to stderr
+ERR_LOGGER="logger -p daemon.err -t /etc/init.d/mysql -i"
+
+# Safeguard (relative paths, core dumps..)
+cd /
+umask 077
+
+# mysqladmin likes to read /root/.my.cnf. This is usually not what I want
+# as many admins e.g. only store a password without a username there and
+# so break my scripts.
+export HOME=/etc/mysql/
+
+## Fetch a particular option from mysql's invocation.
+#
+# Usage: void mysqld_get_param option
+mysqld_get_param() {
+	/usr/sbin/mysqld --print-defaults \
+		| tr " " "\n" \
+		| grep -- "--$1" \
+		| tail -n 1 \
+		| cut -d= -f2
+}
+
+## Do some sanity checks before even trying to start mysqld.
+sanity_checks() {
+  # check for config file
+  if [ ! -r /etc/mysql/my.cnf ]; then
+    log_warning_msg "$0: WARNING: /etc/mysql/my.cnf cannot be read. See README.Debian.gz"
+    echo                "WARNING: /etc/mysql/my.cnf cannot be read. See README.Debian.gz" | $ERR_LOGGER
+  fi
+
+  # check for diskspace shortage
+  datadir=`mysqld_get_param datadir`
+  if LC_ALL=C BLOCKSIZE= df --portability $datadir/. | tail -n 1 | awk '{ exit ($4>4096) }'; then
+    log_failure_msg "$0: ERROR: The partition with $datadir is too full!"
+    echo                "ERROR: The partition with $datadir is too full!" | $ERR_LOGGER
+    exit 1
+  fi
+}
+
+## Checks if there is a server running and if so if it is accessible.
+#
+# check_alive insists on a pingable server
+# check_dead also fails if there is a lost mysqld in the process list
+#
+# Usage: boolean mysqld_status [check_alive|check_dead] [warn|nowarn]
+mysqld_status () {
+    ping_output=`$MYADMIN ping 2>&1`; ping_alive=$(( ! $? ))
+
+    ps_alive=0
+    pidfile=`mysqld_get_param pid-file`
+    if [ -f "$pidfile" ] && ps `cat $pidfile` >/dev/null 2>&1; then ps_alive=1; fi
+    
+    if [ "$1" = "check_alive"  -a  $ping_alive = 1 ] ||
+       [ "$1" = "check_dead"   -a  $ping_alive = 0  -a  $ps_alive = 0 ]; then
+	return 0 # EXIT_SUCCESS
+    else
+  	if [ "$2" = "warn" ]; then
+  	    echo -e "$ps_alive processes alive and '$MYADMIN ping' resulted in\n$ping_output\n" | $ERR_LOGGER -p daemon.debug
+	fi
+  	return 1 # EXIT_FAILURE
+    fi
+}
+
+#
+# main()
+#
+
+case "${1:-''}" in
+  'start')
+	sanity_checks;
+	# Start daemon
+	log_daemon_msg "Starting MySQL database server" "mysqld"
+	if mysqld_status check_alive nowarn; then
+	   log_progress_msg "already running"
+	   log_end_msg 0
+	else
+	    # Could be removed during boot
+	    test -e /var/run/mysqld || install -m 755 -o mysql -g root -d /var/run/mysqld
+
+	    # Start MySQL! 
+  	    /usr/bin/mysqld_safe > /dev/null 2>&1 &
+
+	    # 6s was reported in #352070 to be too few when using ndbcluster
+	    # 14s was reported in #736452 to be too few with large installs
+	    for i in $(seq 1 30); do
+                sleep 1
+	        if mysqld_status check_alive nowarn ; then break; fi
+		log_progress_msg "."
+	    done
+	    if mysqld_status check_alive warn; then
+                log_end_msg 0
+	        # Now start mysqlcheck or whatever the admin wants.
+	        output=$(/etc/mysql/debian-start)
+		[ -n "$output" ] && log_action_msg "$output"
+	    else
+	        log_end_msg 1
+		log_failure_msg "Please take a look at the syslog"
+	    fi
+	fi
+	;;
+
+  'stop')
+	# * As a passwordless mysqladmin (e.g. via ~/.my.cnf) must be possible
+	# at least for cron, we can rely on it here, too. (although we have 
+	# to specify it explicit as e.g. sudo environments points to the normal
+	# users home and not /root)
+	log_daemon_msg "Stopping MySQL database server" "mysqld"
+	if ! mysqld_status check_dead nowarn; then
+	  set +e
+	  shutdown_out=`$MYADMIN shutdown 2>&1`; r=$?
+	  set -e
+	  if [ "$r" -ne 0 ]; then
+	    log_end_msg 1
+	    [ "$VERBOSE" != "no" ] && log_failure_msg "Error: $shutdown_out"
+	    log_daemon_msg "Killing MySQL database server by signal" "mysqld"
+	    killall -15 mysqld
+            server_down=
+	    for i in 1 2 3 4 5 6 7 8 9 10; do
+              sleep 1
+              if mysqld_status check_dead nowarn; then server_down=1; break; fi
+            done
+          if test -z "$server_down"; then killall -9 mysqld; fi
+	  fi
+        fi
+
+        if ! mysqld_status check_dead warn; then
+	  log_end_msg 1
+	  log_failure_msg "Please stop MySQL manually and read /usr/share/doc/mysql-server-5.5/README.Debian.gz!"
+	  exit -1
+	else
+	  log_end_msg 0
+        fi
+	;;
+
+  'restart')
+	set +e; $SELF stop; set -e
+	$SELF start 
+	;;
+
+  'reload'|'force-reload')
+  	log_daemon_msg "Reloading MySQL database server" "mysqld"
+	$MYADMIN reload
+	log_end_msg 0
+	;;
+
+  'status')
+	if mysqld_status check_alive nowarn; then
+	  log_action_msg "$($MYADMIN version)"
+	else
+	  log_action_msg "MySQL is stopped."
+	  exit 3
+	fi
+  	;;
+
+  *)
+	echo "Usage: $SELF start|stop|restart|reload|force-reload|status"
+	exit 1
+	;;
+esac
+
diff -uNr mysql-5.5.60.orig/debian/mysql-server-5.5.postinst mysql-5.5.60/debian/mysql-server-5.5.postinst
--- mysql-5.5.60.orig/debian/mysql-server-5.5.postinst	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-server-5.5.postinst	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,289 @@
+#!/bin/bash
+
+set -e
+
+. /usr/share/debconf/confmodule
+
+if [ -n "$DEBIAN_SCRIPT_DEBUG" ]; then set -v -x; DEBIAN_SCRIPT_TRACE=1; fi
+${DEBIAN_SCRIPT_TRACE:+ echo "#42#DEBUG# RUNNING $0 $*" 1>&2 }
+ 
+export PATH=$PATH:/sbin:/usr/sbin:/bin:/usr/bin
+
+# This command can be used as pipe to syslog. With "-s" it also logs to stderr.
+ERR_LOGGER="logger -p daemon.err -t mysqld_safe -i"
+
+invoke() {
+  if [ -x /usr/sbin/invoke-rc.d ]; then
+    invoke-rc.d mysql $1
+  else
+    /etc/init.d/mysql $1
+  fi
+}
+
+MYSQL_BOOTSTRAP="/usr/sbin/mysqld --bootstrap --user=mysql --skip-grant-tables"
+
+test_mysql_access() {
+       mysql --no-defaults -u root -h localhost </dev/null >/dev/null 2>&1
+}
+
+# call with $1 = "online" to connect to the server, otherwise it bootstraps
+set_mysql_rootpw() {
+       # forget we ever saw the password.  don't use reset to keep the seen status
+       db_set mysql-server/root_password ""
+       db_set mysql-server/root_password_again ""
+
+       tfile=`mktemp`
+       if [ ! -f "$tfile" ]; then
+               return 1
+       fi
+
+       # this avoids us having to call "test" or "[" on $rootpw
+       cat << EOF > $tfile
+USE mysql;
+UPDATE user SET password=PASSWORD("$rootpw") WHERE user='root';
+FLUSH PRIVILEGES;
+EOF
+       if grep -q 'PASSWORD("")' $tfile; then
+               retval=0
+       elif [ "$1" = "online" ]; then
+               mysql --no-defaults -u root -h localhost <$tfile >/dev/null
+               retval=$?
+       else
+               $MYSQL_BOOTSTRAP <$tfile
+               retval=$?
+       fi
+       rm -f $tfile
+       return $retval
+}
+
+# This is necessary because mysql_install_db removes the pid file in /var/run
+# and because changed configuration options should take effect immediately.
+# In case the server wasn't running at all it should be ok if the stop
+# script fails. I can't tell at this point because of the cleaned /var/run.
+set +e; invoke stop; set -e
+    
+case "$1" in
+  configure)
+    mysql_datadir=/usr/share/mysql
+    mysql_statedir=/var/lib/mysql
+    mysql_rundir=/var/run/mysqld
+    mysql_logdir=/var/log
+    mysql_cfgdir=/etc/mysql
+    mysql_newlogdir=/var/log/mysql
+    mysql_upgradedir=/var/lib/mysql-upgrade
+    mysql_filesdir=/var/lib/mysql-files
+
+    # first things first, if the following symlink exists, it is a preserved
+    # copy the old data dir from a mysql upgrade that would have otherwise
+    # been replaced by an empty mysql dir.  this should restore it.
+    for dir in DATADIR LOGDIR; do
+        if [ "$dir" = "DATADIR" ]; then targetdir=$mysql_statedir; else targetdir=$mysql_newlogdir; fi
+        savelink="$mysql_upgradedir/$dir.link"
+        if [ -L "$savelink" ]; then
+            # If the targetdir was a symlink before we upgraded it is supposed
+            # to be either still be present or not existing anymore now.
+            if [ -L "$targetdir" ]; then
+                rm "$savelink"
+            elif [ ! -d "$targetdir" ]; then
+                mv "$savelink" "$targetdir"
+            else
+                # this should never even happen, but just in case...
+                mysql_tmp=`mktemp -d -t mysql-symlink-restore-XXXXXX`
+                echo "this is very strange!  see $mysql_tmp/README..." >&2
+                mv "$targetdir" "$mysql_tmp"
+                cat << EOF > "$mysql_tmp/README"
+
+if you're reading this, it's most likely because you had replaced /var/lib/mysql
+with a symlink, then upgraded to a new version of mysql, and then dpkg
+removed your symlink (see #182747 and others).  the mysql packages noticed
+that this happened, and as a workaround have restored it.  however, because
+/var/lib/mysql seems to have been re-created in the meantime, and because
+we don't want to rm -rf something we don't know as much about, we're going
+to leave this unexpected directory here.  if your database looks normal,
+and this is not a symlink to your database, you should be able to blow
+this all away.
+
+EOF
+            fi
+        fi
+	rmdir $mysql_upgradedir 2>/dev/null || true
+    done
+    
+    # Ensure the existence and right permissions for the database and
+    # log files.
+    if [ ! -d "$mysql_statedir"       -a ! -L "$mysql_statedir"       ]; then mkdir "$mysql_statedir"; fi
+    if [ ! -d "$mysql_statedir/mysql" -a ! -L "$mysql_statedir/mysql" ]; then mkdir "$mysql_statedir/mysql"; fi
+    if [ ! -d "$mysql_newlogdir"      -a ! -L "$mysql_newlogdir"      ]; then mkdir "$mysql_newlogdir"; fi
+    if [ ! -d "$mysql_filesdir"       -a ! -L "$mysql_filesdir"       ]; then mkdir "$mysql_filesdir"; fi
+    # When creating an ext3 jounal on an already mounted filesystem like e.g.
+    # /var/lib/mysql, you get a .journal file that is not modifyable by chown.
+    # The mysql_datadir must not be writable by the mysql user under any
+    # circumstances as it contains scripts that are executed by root.
+    set +e
+    chown -R 0:0 $mysql_datadir
+    chown -R mysql $mysql_statedir
+    chmod 700 $mysql_statedir $mysql_statedir/mysql
+    if [ ! -d "$mysql_rundir" ]; then mkdir "$mysql_rundir"; fi
+    chown -R mysql $mysql_rundir
+    chown -R mysql:adm $mysql_newlogdir;	chmod 2750 $mysql_newlogdir;
+    for i in log err; do
+      touch             $mysql_logdir/mysql.$i
+      chown mysql:adm   $mysql_logdir/mysql.$i
+      chmod 0640        $mysql_logdir/mysql.$i
+    done
+    chown -R mysql:mysql $mysql_filesdir
+    chmod 700 $mysql_filesdir
+    set -e
+
+    # This is important to avoid dataloss when there is a removed
+    # mysql-server version from Woody lying around which used the same
+    # data directory and then somewhen gets purged by the admin.
+    db_set mysql-server/postrm_remove_database false || true
+
+    # To avoid downgrades.
+    touch $mysql_statedir/debian-5.5.flag
+
+    # initiate databases. Output is not allowed by debconf :-(
+    # Debian: beware of the bashisms... 
+    # Debian: can safely run on upgrades with existing databases 
+    set +e
+    bash /usr/bin/mysql_install_db --user mysql --rpm 2>&1 | $ERR_LOGGER
+    if [ "$?" != "0" ]; then
+      echo "ATTENTION: An error has occured. More info is in the syslog!"
+    fi
+    set -e
+    
+    ## On every reconfiguration the maintenance user is recreated.
+    #
+    # - It is easier to regenerate the password every time but as people
+    #   use fancy rsync scripts and file alteration monitors, the existing
+    #   password is used and existing files not touched.
+    # - The mysqld statement is like that in mysql_install_db because the
+    #   server is not already running. This has some implications:
+    # 	- The amount of newlines and semicolons in the query is important!
+    #   - GRANT is not possible with --skip-grant-tables and "INSERT
+    #     (user,host..) VALUES" is not --ansi compliant
+    # - The echo is just for readability. ash's buildin has no "-e" so use /bin/echo.
+    # - The Super_priv, Show_db_priv, Create_tmp_table_priv and Lock_tables_priv
+    #   may not be present as old Woody 3.23 databases did not have it and the
+    #   admin might not already have run mysql_upgrade which adds them.
+    #   As the binlog cron scripts to need at least the Super_priv, I do first
+    #   the old query which always succeeds and then the new which may or may not.
+
+    # recreate the credentials file if not present or without mysql_upgrade stanza
+    dc=$mysql_cfgdir/debian.cnf; 
+    if [ -e "$dc" -a -n "`fgrep mysql_upgrade $dc 2>/dev/null`" ]; then
+        pass="`sed -n 's/^[     ]*password *= *// p' $dc | head -n 1`"
+    else
+	pass=`perl -e 'print map{("a".."z","A".."Z",0..9)[int(rand(62))]}(1..16)'`;
+        if [ ! -d "$mysql_cfgdir" ]; then install -o 0 -g 0 -m 0755 -d $mysql_cfgdir; fi
+	umask 066
+        cat /dev/null > $dc
+	umask 022
+        echo "# Automatically generated for Debian scripts. DO NOT TOUCH!" >>$dc
+        echo "[client]"                                                    >>$dc
+        echo "host     = localhost"                                        >>$dc
+        echo "user     = debian-sys-maint"                                 >>$dc
+        echo "password = $pass"                                            >>$dc
+        echo "socket   = $mysql_rundir/mysqld.sock"                        >>$dc
+        echo "[mysql_upgrade]"                                             >>$dc
+        echo "host     = localhost"                                        >>$dc
+        echo "user     = debian-sys-maint"                                 >>$dc
+        echo "password = $pass"                                            >>$dc
+        echo "socket   = $mysql_rundir/mysqld.sock"                        >>$dc
+        echo "basedir  = /usr"                                             >>$dc
+    fi
+    # If this dir chmod go+w then the admin did it. But this file should not.
+    chown 0:0 $dc
+    chmod 0600 $dc
+
+    # update privilege tables
+    password_column_fix_query=`echo -e \
+        "USE mysql\n" \
+        "ALTER TABLE user CHANGE Password Password char(41) character set latin1 collate latin1_bin DEFAULT '' NOT NULL"`;
+    replace_query=`echo -e \
+        "USE mysql\n" \
+        "REPLACE INTO user SET " \
+        "  host='localhost', user='debian-sys-maint', password=password('$pass'), " \
+        "  Select_priv='Y', Insert_priv='Y', Update_priv='Y', Delete_priv='Y', " \
+        "  Create_priv='Y', Drop_priv='Y', Reload_priv='Y', Shutdown_priv='Y', " \
+        "  Process_priv='Y',  File_priv='Y', Grant_priv='Y', References_priv='Y', " \
+        "  Index_priv='Y', Alter_priv='Y', Super_priv='Y', Show_db_priv='Y', "\
+        "  Create_tmp_table_priv='Y', Lock_tables_priv='Y', Execute_priv='Y', "\
+        "  Repl_slave_priv='Y', Repl_client_priv='Y', Create_view_priv='Y', "\
+        "  Show_view_priv='Y', Create_routine_priv='Y', Alter_routine_priv='Y', "\
+        "  Create_user_priv='Y', Event_priv='Y', Trigger_priv='Y', Create_tablespace_priv='Y' "`;
+    fix_privs=`echo -e \
+        "USE mysql;\n" \
+        "ALTER TABLE user ADD column Create_view_priv enum('N','Y') CHARACTER SET utf8 NOT NULL DEFAULT 'N'; " \
+        "ALTER TABLE user ADD column Show_view_priv enum('N','Y') CHARACTER SET utf8 NOT NULL DEFAULT 'N'; " \
+        "ALTER TABLE user ADD column Create_routine_priv enum('N','Y') CHARACTER SET utf8 NOT NULL DEFAULT 'N'; " \
+        "ALTER TABLE user ADD column Alter_routine_priv enum('N','Y') CHARACTER SET utf8 NOT NULL DEFAULT 'N'; " \
+        "ALTER TABLE user ADD column Create_user_priv enum('N','Y') CHARACTER SET utf8 NOT NULL DEFAULT 'N'; " \
+        "ALTER TABLE user ADD column Event_priv enum('N','Y') CHARACTER SET utf8 NOT NULL DEFAULT 'N'; " \
+        "ALTER TABLE user ADD column Trigger_priv enum('N','Y') CHARACTER SET utf8 NOT NULL DEFAULT 'N'; " \
+        "ALTER TABLE user ADD column Create_tablespace_priv enum('N','Y') CHARACTER SET utf8 NOT NULL DEFAULT 'N'; " `
+    # Engines supported by etch should be installed per default. The query sequence is supposed
+    # to be aborted if the CREATE TABLE fails due to an already existent table in which case the
+    # admin might already have chosen to remove one or more plugins. Newlines are necessary.
+    install_plugins=`echo -e \
+        "USE mysql;\n" \
+        "CREATE TABLE plugin (name char(64) COLLATE utf8_bin NOT NULL DEFAULT '', " \
+        "  dl char(128) COLLATE utf8_bin NOT NULL DEFAULT '', " \
+        "  PRIMARY KEY (name)) ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='MySQL plugins';\n" \
+        "INSERT INTO plugin VALUES ('innodb',    'ha_innodb.so');\n" \
+        "INSERT INTO plugin VALUES ('federated', 'ha_federated.so');\n" \
+        "INSERT INTO plugin VALUES ('blackhole', 'ha_blackhole.so');\n" \
+        "INSERT INTO plugin VALUES ('archive',   'ha_archive.so');" `
+
+    # Upgrade password column format before the root password gets set.
+    echo "$password_column_fix_query"                        | $MYSQL_BOOTSTRAP 2>&1 | $ERR_LOGGER
+
+    db_get mysql-server/root_password && rootpw="$RET"
+    if ! set_mysql_rootpw; then
+        password_error="yes"
+    fi
+
+    echo "$fix_privs"                                        | $MYSQL_BOOTSTRAP 2>&1 | $ERR_LOGGER
+    echo "$replace_query"                                    | $MYSQL_BOOTSTRAP 2>&1 | $ERR_LOGGER
+    set +e
+    echo "$install_plugins"                                  | $MYSQL_BOOTSTRAP 2>&1 | $ERR_LOGGER
+    set -e
+  ;;
+
+  abort-upgrade|abort-remove|abort-configure)
+  ;;
+
+  *)
+    echo "postinst called with unknown argument '$1'" 1>&2
+    exit 1
+  ;;
+esac
+
+# here we check to see if we can connect as root without a password
+# this should catch upgrades from previous versions where the root
+# password wasn't set.  if there is a password, or if the connection
+# fails for any other reason, nothing happens.
+if [ "$1" = "configure" ]; then
+       if test_mysql_access; then
+               db_input medium mysql-server/root_password || true
+               db_go
+               db_get mysql-server/root_password && rootpw="$RET"
+
+               if ! set_mysql_rootpw "online"; then
+                       password_error="yes"
+               fi
+       fi
+
+       if [ "$password_error" = "yes" ]; then
+               db_input high mysql-server/error_setting_password || true
+               db_go
+       fi
+
+fi
+
+db_stop # in case invoke failes
+
+#DEBHELPER#
+
+exit 0
diff -uNr mysql-5.5.60.orig/debian/mysql-server-5.5.postrm mysql-5.5.60/debian/mysql-server-5.5.postrm
--- mysql-5.5.60.orig/debian/mysql-server-5.5.postrm	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-server-5.5.postrm	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,85 @@
+#!/bin/bash
+
+set -e
+
+# It is possible that Debconf has already been removed, too.
+if [ -f /usr/share/debconf/confmodule ]; then
+  . /usr/share/debconf/confmodule
+fi
+
+if [ -n "$DEBIAN_SCRIPT_DEBUG" ]; then set -v -x; DEBIAN_SCRIPT_TRACE=1; fi
+${DEBIAN_SCRIPT_TRACE:+ echo "#42#DEBUG# RUNNING $0 $*" 1>&2 }
+
+MYADMIN="/usr/bin/mysqladmin --defaults-file=/etc/mysql/debian.cnf"
+
+# Try to stop the server in a sane way. If it does not success let the admin
+# do it himself. No database directories should be removed while the server
+# is running!
+stop_server() {
+  set +e
+  if [ -x /usr/sbin/invoke-rc.d ]; then
+    invoke-rc.d mysql stop
+  else
+    /etc/init.d/mysql stop
+  fi
+  errno=$?
+  set -e
+
+  if [ "$?" != 0 ]; then
+    echo "Trying to stop the MySQL server resulted in exitcode $?." 1>&2
+    echo "Stop it yourself and try again!" 1>&2
+    exit 1
+  fi
+}
+
+case "$1" in
+  purge|remove|upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
+    if [ -n "`$MYADMIN ping 2>/dev/null`" ]; then
+      stop_server
+      sleep 2
+    fi
+  ;;
+  *)
+    echo "postrm called with unknown argument '$1'" 1>&2
+    exit 1
+  ;;
+esac
+
+#
+# - Do NOT purge logs or data if another mysql-sever* package is installed (#307473)
+# - Remove the mysql user only after all his owned files are purged.
+#   
+if [ "$1" = "purge" -a ! \( -x /usr/sbin/mysqld -o -L /usr/sbin/mysqld \) ]; then
+  # we remove the mysql user only after all his owned files are purged
+  rm -f /var/log/mysql.{log,err}{,.0,.[1234567].gz}
+  rm -rf /var/log/mysql
+
+  db_input high mysql-server-5.5/postrm_remove_databases || true
+  db_go || true
+  db_get mysql-server-5.5/postrm_remove_databases || true
+  if [ "$RET" = "true" ]; then
+    # never remove the debian.cnf when the databases are still existing
+    # else we ran into big trouble on the next install!
+    rm -f /etc/mysql/debian.cnf
+    rm -rf /var/lib/mysql
+    rm -rf /var/run/mysqld
+    userdel mysql || true
+  fi
+
+  # (normally) Automatically added by dh_installinit
+  if [ "$1" = "purge" ] ; then
+        update-rc.d mysql remove >/dev/null || exit 0
+  fi
+  # (normally) End automatically added section
+fi
+
+# (normally) Automatically added by dh_installdebconf
+if [ "$1" = purge ] && [ -e /usr/share/debconf/confmodule ]; then
+        . /usr/share/debconf/confmodule
+        db_purge
+fi
+# (normally) End automatically added section
+
+# no DEBHELPER here, "update-rc.d remove" fails if mysql-server-5.5 is installed
+
+exit 0
diff -uNr mysql-5.5.60.orig/debian/mysql-server-5.5.preinst mysql-5.5.60/debian/mysql-server-5.5.preinst
--- mysql-5.5.60.orig/debian/mysql-server-5.5.preinst	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-server-5.5.preinst	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,185 @@
+#!/bin/bash
+#
+# summary of how this script can be called:
+#        * <new-preinst> install
+#        * <new-preinst> install <old-version>
+#        * <new-preinst> upgrade <old-version>
+#        * <old-preinst> abort-upgrade <new-version>
+#
+
+set -e
+
+. /usr/share/debconf/confmodule
+
+if [ -n "$DEBIAN_SCRIPT_DEBUG" ]; then set -v -x; DEBIAN_SCRIPT_TRACE=1; fi
+${DEBIAN_SCRIPT_TRACE:+ echo "#42#DEBUG# RUNNING $0 $*" 1>&2 }
+
+export PATH=$PATH:/sbin:/usr/sbin:/bin:/usr/bin
+MYADMIN="/usr/bin/mysqladmin --defaults-file=/etc/mysql/debian.cnf"
+DATADIR=/var/lib/mysql
+LOGDIR=/var/log/mysql
+UPGRADEDIR=/var/lib/mysql-upgrade
+
+# Try to stop the server in a sane way. If it does not success let the admin
+# do it himself. No database directories should be removed while the server
+# is running! Another mysqld in e.g. a different chroot is fine for us.
+stop_server() {
+    if [ ! -x /etc/init.d/mysql ]; then return; fi
+
+    set +e
+    if [ -x /usr/sbin/invoke-rc.d ]; then
+      cmd="invoke-rc.d mysql stop"
+    else
+      cmd="/etc/init.d/mysql stop"
+    fi
+    $cmd
+    errno=$?
+    set -e
+   
+    # 0=ok, 100=no init script (fresh install)
+    if [ "$errno" != 0 -a "$errno" != 100 ]; then
+      echo "${cmd/ */} returned $errno" 1>&2
+      echo "There is a MySQL server running, but we failed in our attempts to stop it." 1>&2
+      echo "Stop it yourself and try again!" 1>&2
+      db_stop  	
+      exit 1
+    fi
+}
+
+################################ main() ##########################
+
+this_version=5.5
+
+# Abort if an NDB cluster is in use.
+if egrep -qi -r '^[^#]*ndb.connectstring|^[[:space:]]*\[[[:space:]]*ndb_mgmd' /etc/mysql/; then
+  db_fset mysql-server/no_upgrade_when_using_ndb seen false || true
+  db_input high mysql-server/no_upgrade_when_using_ndb || true
+  db_go
+  db_stop
+  exit 1
+fi
+
+# Abort if skip-bdb option is enabled, required for 5.0 -> 5.1 upgrades.
+#TODO
+
+# Safe the user from stupidities.
+show_downgrade_warning=0
+for i in `ls $DATADIR/debian-*.flag 2>/dev/null`; do
+  found_version=`echo $i | sed 's/.*debian-\([0-9\.]\+\).flag/\1/'`
+  if dpkg --compare-versions "$this_version" '<<' "$found_version"; then
+    show_downgrade_warning=1
+    break;
+  fi
+done
+if [ "$show_downgrade_warning" = 1 ]; then
+  db_fset mysql-server-$this_version/really_downgrade seen false || true
+  db_input medium mysql-server-$this_version/really_downgrade || true
+  db_go
+  db_get mysql-server-$this_version/really_downgrade || true
+  if [ "$RET" = "true" ]; then
+    rm -f $DATADIR/debian-*.flag
+    touch $DATADIR/debian-$this_version.flag
+  else
+    echo "Aborting downgrade from (at least) $found_version to $this_version." 1>&2
+    echo "If are sure you want to downgrade to $this_version, remove the file" 1>&2
+    echo "$DATADIR/debian-*.flag and try installing again." 1>&2
+    db_stop
+    exit 1
+  fi
+fi
+
+# to be sure
+stop_server
+
+# If we use NIS then errors should be tolerated. It's up to the
+# user to ensure that the mysql user is correctly setup.
+# Beware that there are two ypwhich one of them needs the 2>/dev/null!
+if test -n "`which ypwhich 2>/dev/null`"  &&  ypwhich >/dev/null 2>&1; then
+  set +e
+fi
+
+#
+# Now we have to ensure the following state:
+# /etc/passwd: mysql:x:100:101:MySQL Server:/nonexistent:/bin/false
+# /etc/group:  mysql:x:101:
+# 
+# Sadly there could any state be present on the system so we have to
+# modify everything carefully i.e. not doing a chown before creating
+# the user etc...
+#
+
+# creating mysql group if he isn't already there
+if ! getent group mysql >/dev/null; then
+ 	# Adding system group: mysql.
+	addgroup --system mysql >/dev/null
+fi
+
+# creating mysql user if he isn't already there
+if ! getent passwd mysql >/dev/null; then
+	# Adding system user: mysql.
+	adduser \
+	  --system \
+          --disabled-login \
+	  --ingroup mysql \
+	  --no-create-home \
+	  --home /nonexistent \
+	  --gecos "MySQL Server" \
+	  --shell /bin/false \
+	  mysql  >/dev/null
+fi
+
+# end of NIS tolerance zone
+set -e
+
+# if there's a symlink, let's store where it's pointing, because otherwise
+# it's going to be lost in some situations
+for dir in DATADIR LOGDIR; do
+    checkdir=`eval echo "$"$dir`
+    if [ -L "$checkdir" ]; then
+	mkdir -p "$UPGRADEDIR"
+	cp -d "$checkdir" "$UPGRADEDIR/$dir.link"
+    fi
+done
+
+# creating mysql home directory
+if [ ! -d $DATADIR -a ! -L $DATADIR ]; then
+ 	mkdir $DATADIR
+fi
+
+# checking disc space
+if LC_ALL=C BLOCKSIZE= df --portability $DATADIR/. | tail -n 1 | awk '{ exit ($4>1000) }'; then
+  echo "ERROR: There's not enough space in $DATADIR/" 1>&2
+  db_stop
+  exit 1
+fi
+
+# Since the home directory was created before putting the user into
+# the mysql group and moreover we cannot guarantee that the 
+# permissions were correctly *before* calling this script, we fix them now.
+# In case we use NIS and no mysql user is present then this script should
+# better fail now than later..
+# The "set +e" is necessary as e.g. a ".journal" of a ext3 partition is
+# not chgrp'able (#318435).
+set +e
+chown mysql:mysql $DATADIR
+find $DATADIR -follow -not -group mysql -print0 2>/dev/null \
+  | xargs -0 --no-run-if-empty chgrp mysql
+set -e
+
+# Some files below /etc/ were possibly in the mysql-server-5.0/etch package
+# before. They get overwritten by current ones to avoid unnecessary dpkg questions.
+while read md5 file; do
+  if [ "`md5sum $file 2>/dev/null`" = "$md5  $file" ]; then
+    cp /usr/share/mysql-common/internal-use-only/`echo $file | sed 's/_g'` $file
+  fi
+done <<EOT
+6691f2fdc5c6d27ff0260eb79813e1bc  /etc/init.d/mysql
+b53b9552d44661361d39157c3c7c51d3  /etc/logrotate.d/mysql-server
+57f3e58f72582ca55100dc1ba0f1a8ae  /etc/mysql/debian-start
+EOT
+
+db_stop
+
+#DEBHELPER#
+
+exit 0
diff -uNr mysql-5.5.60.orig/debian/mysql-server-5.5.prerm mysql-5.5.60/debian/mysql-server-5.5.prerm
--- mysql-5.5.60.orig/debian/mysql-server-5.5.prerm	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-server-5.5.prerm	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,10 @@
+#!/bin/bash
+
+set -e
+
+. /usr/share/debconf/confmodule
+
+if [ -n "$DEBIAN_SCRIPT_DEBUG" ]; then set -v -x; DEBIAN_SCRIPT_TRACE=1; fi
+${DEBIAN_SCRIPT_TRACE:+ echo "#42#DEBUG# RUNNING $0 $*" 1>&2 }
+
+#DEBHELPER#
diff -uNr mysql-5.5.60.orig/debian/mysql-server-5.5.templates mysql-5.5.60/debian/mysql-server-5.5.templates
--- mysql-5.5.60.orig/debian/mysql-server-5.5.templates	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-server-5.5.templates	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,89 @@
+# These templates have been reviewed by the debian-l10n-english
+# team
+#
+# If modifications/additions/rewording are needed, please ask
+# for an advice to debian-l10n-english@lists.debian.org
+#
+# Even minor modifications require translation updates and such
+# changes should be coordinated with translators and reviewers.
+
+Template: mysql-server-5.5/really_downgrade
+Type: boolean
+Default: false
+_Description: Really proceed with downgrade?
+ A file named /var/lib/mysql/debian-*.flag exists on this system.
+ .
+ Such a file is an indication that a mysql-server package with a higher
+ version has been installed previously.
+ .
+ There is no guarantee that the version you're currently installing
+ will be able to use the current databases.
+
+Template: mysql-server-5.5/nis_warning
+Type: note
+#flag:translate!:3,5
+_Description: Important note for NIS/YP users
+ Using MySQL under NIS/YP requires a mysql user account to be added on
+ the local system with:
+ .
+  adduser --system --group --home /var/lib/mysql mysql
+ .
+ You should also check the permissions and ownership of the
+ /var/lib/mysql directory:
+ .
+  /var/lib/mysql: drwxr-xr-x   mysql    mysql
+
+Template: mysql-server-5.5/postrm_remove_databases
+Type: boolean
+Default: false
+_Description: Remove all MySQL databases?
+ The /var/lib/mysql directory which contains the MySQL databases is about
+ to be removed.
+ .
+ If you're removing the MySQL package in order to later install a more
+ recent version or if a different mysql-server package is already
+ using it, the data should be kept.
+
+Template: mysql-server-5.5/start_on_boot
+Type: boolean
+Default: true
+_Description: Start the MySQL server on boot?
+ The MySQL server can be launched automatically at boot time or manually
+ with the '/etc/init.d/mysql start' command.
+
+Template: mysql-server/root_password
+Type: password
+_Description: New password for the MySQL "root" user:
+ While not mandatory, it is highly recommended that you set a password
+ for the MySQL administrative "root" user.
+ .
+ If this field is left blank, the password will not be changed.
+
+Template: mysql-server/root_password_again
+Type: password
+_Description: Repeat password for the MySQL "root" user:
+
+Template: mysql-server/error_setting_password
+Type: error
+_Description: Unable to set password for the MySQL "root" user
+ An error occurred while setting the password for the MySQL
+ administrative user. This may have happened because the account
+ already has a password, or because of a communication problem with
+ the MySQL server.
+ .
+ You should check the account's password after the package installation.
+ .
+ Please read the /usr/share/doc/mysql-server-5.5/README.Debian file
+ for more information.
+
+Template: mysql-server/password_mismatch
+Type: error
+_Description: Password input error
+ The two passwords you entered were not the same. Please try again.
+
+Template: mysql-server/no_upgrade_when_using_ndb
+Type: error
+_Description: NDB Cluster seems to be in use
+ MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new
+ mysql-cluster-server package and remove all lines starting with "ndb" from
+ all config files below /etc/mysql/.
diff -uNr mysql-5.5.60.orig/debian/mysql-server-core-5.5.dirs mysql-5.5.60/debian/mysql-server-core-5.5.dirs
--- mysql-5.5.60.orig/debian/mysql-server-core-5.5.dirs	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-server-core-5.5.dirs	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,2 @@
+usr/sbin
+usr/share/man/man8
diff -uNr mysql-5.5.60.orig/debian/mysql-server-core-5.5.files mysql-5.5.60/debian/mysql-server-core-5.5.files
--- mysql-5.5.60.orig/debian/mysql-server-core-5.5.files	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-server-core-5.5.files	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,61 @@
+usr/bin/my_print_defaults
+usr/bin/mysql_install_db
+usr/bin/mysql_upgrade
+usr/sbin/mysqld
+usr/share/man/man1/my_print_defaults.1
+usr/share/man/man1/mysql_install_db.1
+usr/share/man/man1/mysql_upgrade.1
+usr/share/man/man8/mysqld.8
+usr/share/mysql/charsets
+usr/share/mysql/czech
+usr/share/mysql/danish
+usr/share/mysql/dutch
+usr/share/mysql/english
+usr/share/mysql/estonian
+usr/share/mysql/french
+usr/share/mysql/fill_help_tables.sql
+usr/share/mysql/mysql_system_tables.sql
+usr/share/mysql/mysql_system_tables_data.sql
+usr/share/mysql/german
+usr/share/mysql/greek
+usr/share/mysql/hungarian
+usr/share/mysql/italian
+usr/share/mysql/japanese
+usr/share/mysql/korean
+usr/share/mysql/norwegian
+usr/share/mysql/norwegian-ny
+usr/share/mysql/polish
+usr/share/mysql/portuguese
+usr/share/mysql/romanian
+usr/share/mysql/russian
+usr/share/mysql/serbian
+usr/share/mysql/slovak
+usr/share/mysql/spanish
+usr/share/mysql/swedish
+usr/share/mysql/ukrainian
+usr/sbin/mysqld
+usr/share/man/man8/mysqld.8
+usr/share/mysql/charsets
+usr/share/mysql/czech
+usr/share/mysql/danish
+usr/share/mysql/dutch
+usr/share/mysql/english
+usr/share/mysql/estonian
+usr/share/mysql/french
+usr/share/mysql/german
+usr/share/mysql/greek
+usr/share/mysql/hungarian
+usr/share/mysql/italian
+usr/share/mysql/japanese
+usr/share/mysql/korean
+usr/share/mysql/norwegian
+usr/share/mysql/norwegian-ny
+usr/share/mysql/polish
+usr/share/mysql/portuguese
+usr/share/mysql/romanian
+usr/share/mysql/russian
+usr/share/mysql/serbian
+usr/share/mysql/slovak
+usr/share/mysql/spanish
+usr/share/mysql/swedish
+usr/share/mysql/ukrainian
diff -uNr mysql-5.5.60.orig/debian/mysql-source-5.5.install mysql-5.5.60/debian/mysql-source-5.5.install
--- mysql-5.5.60.orig/debian/mysql-source-5.5.install	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-source-5.5.install	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1 @@
+debian/mysql-source*.tar.gz usr/src/mysql/
diff -uNr mysql-5.5.60.orig/debian/mysql-testsuite-5.5.dirs mysql-5.5.60/debian/mysql-testsuite-5.5.dirs
--- mysql-5.5.60.orig/debian/mysql-testsuite-5.5.dirs	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-testsuite-5.5.dirs	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1 @@
+/usr/lib/mysql-testsuite
diff -uNr mysql-5.5.60.orig/debian/mysql-testsuite-5.5.install mysql-5.5.60/debian/mysql-testsuite-5.5.install
--- mysql-5.5.60.orig/debian/mysql-testsuite-5.5.install	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/mysql-testsuite-5.5.install	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1 @@
+/usr/share/mysql-test/* /usr/lib/mysql-testsuite/
diff -uNr mysql-5.5.60.orig/debian/po/POTFILES.in mysql-5.5.60/debian/po/POTFILES.in
--- mysql-5.5.60.orig/debian/po/POTFILES.in	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/POTFILES.in	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1 @@
+[type: gettext/rfc822deb] mysql-server-5.5.templates
diff -uNr mysql-5.5.60.orig/debian/po/ar.po mysql-5.5.60/debian/po/ar.po
--- mysql-5.5.60.orig/debian/po/ar.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/ar.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,252 @@
+# translation of templates.po to Arabic
+# Copyright (C) YEAR THE PACKAGE'S COPYRIGHT HOLDER
+# This file is distributed under the same license as the PACKAGE package.
+#
+# Ossama M. Khayat <okhayat@yahoo.com>, 2007.
+msgid ""
+msgstr ""
+"Project-Id-Version: templates\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2007-05-01 13:04+0300\n"
+"Last-Translator: Ossama M. Khayat <okhayat@yahoo.com>\n"
+"Language-Team: Arabic <support@arabeyes.org>\n"
+"Language: ar\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+"X-Generator: KBabel 1.11.4\n"
+"Plural-Forms: nplurals=6; plural=n==1 ? 0 : n==0 ? 1 : n==2 ? 2: n%100>=3 && "
+"n%100<=10 ? 3 : n%100>=11 && n%100<=99 ? 4 : 5\n"
+": n%100>=3 && n%100<=10 ? 3 : n%100>=11 && n%100<=99 ? 4 : 5\n"
+": n%100>=3 && n%100<=10 ? 3 : n%100>=11 && n%100<=99 ? 4 : 5\n"
+": n%100>=3 && n%100<=10 ? 3 : n%100>=11 && n%100<=99 ? 4 : 5\n"
+": n%100>=3 && n%100<=10 ? 3 : n%100>=11 && n%100<=99 ? 4 : 5\n"
+": n%100>=3 && n%100<=10 ? 3 : n%100>=11 && n%100<=99 ? 4 : 5\n"
+": n%100>=3 && n%100<=10 ? 3 : n%100>=11 && n%100<=99 ? 4 : 5\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr "   "
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr "   /var/lib/mysql/debian-*.flag    ."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+#, fuzzy
+#| msgid ""
+#| "Such file is an indication that a mysql-server package with a higher "
+#| "version has been installed earlier."
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+"         mysql-server   ."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+"             "
+"  ."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid "Important note for NIS/YP users"
+msgstr "   NIS/YP"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+#, fuzzy
+#| msgid ""
+#| "You should also check the permissions and the owner of the /var/lib/mysql "
+#| "directory:"
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr "         /var/lib/mysql: "
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr "    MySQL"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr " /var/lib/mysql     MySQL  ."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"     MySQL           "
+"mysql-server     ."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid "Start the MySQL server on boot?"
+msgstr "  MySQL  "
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"   MySQL        '/etc/init.d/"
+"mysql start'."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr "    \"root\"  MySQL:"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"              "
+"MySQL  \"root\"."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+#, fuzzy
+#| msgid "If that field is left blank, the password will not be changed."
+msgid "If this field is left blank, the password will not be changed."
+msgstr "        ."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+#, fuzzy
+#| msgid "New password for the MySQL \"root\" user:"
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "    \"root\"  MySQL:"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr "     \"root\"  MySQL."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"       MySQL .      "
+"               "
+"MySQL."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+#, fuzzy
+#| msgid ""
+#| "You should check the account's password after tha package installation."
+msgid "You should check the account's password after the package installation."
+msgstr "         ."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+#, fuzzy
+#| msgid ""
+#| "Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for "
+#| "more information."
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+"   /usr/share/doc/mysql-server-5.5/README.Debian   "
+"."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+
+#~ msgid ""
+#~ "To use MySQL, the following entries for users and groups should be added "
+#~ "to the system:"
+#~ msgstr ""
+#~ "  MySQL        "
+#~ " :"
+
+#~ msgid ""
+#~ "Support MySQL connections from hosts running Debian \"sarge\" or older?"
+#~ msgstr ""
+#~ "    MySQL       \"sarge\"  "
+#~ ""
+
+#~ msgid ""
+#~ "In old versions of MySQL clients on Debian, passwords were not stored "
+#~ "securely. This has been improved since then, however clients (such as "
+#~ "PHP) from hosts running Debian 3.1 Sarge will not be able to connect to "
+#~ "recent accounts or accounts whose password have been changed."
+#~ msgstr ""
+#~ "   MySQL          "
+#~ ".         ( PHP)   "
+#~ "    Sarge 3.1       "
+#~ "        ."
diff -uNr mysql-5.5.60.orig/debian/po/ca.po mysql-5.5.60/debian/po/ca.po
--- mysql-5.5.60.orig/debian/po/ca.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/ca.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,227 @@
+# mysql-dfsg (debconf) translation to Catalan.
+# Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004 Free Software Foundation, Inc.
+# Aleix Badia i Bosch <abadia@ica.es> 2004
+#
+msgid ""
+msgstr ""
+"Project-Id-Version: mysql-dfsg-4.1\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2004-01-31 19:20GMT\n"
+"Last-Translator: Aleix Badia i Bosch <abadia@ica.es>\n"
+"Language-Team: Debian L10n Catalan <debian-l10n-catalan@lists.debian.org>\n"
+"Language: \n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=ISO-8859-1\n"
+"Content-Transfer-Encoding: 8bit\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+"Aquest fitxer indica que anteriorment s'ha instalat un paquet mysql-server "
+"amb una versi posterior."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+"No hi ha cap garantia que la versi que esteu instalant actualment puga "
+"emprar les bases de dades actuals."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+#, fuzzy
+#| msgid "Important note for NIS/YP users!"
+msgid "Important note for NIS/YP users"
+msgstr "Nota important pels usuaris de NIS/YP"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+"Si empreu MySQL sota NIS/YP, heu d'afegir un compte d'usuari mysql al "
+"sistema local amb:"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr ""
+"Tamb haureu de comprovar els permisos i propietaris del directori /var/"
+"lib/mysql:"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+"El directori /var/lib/mysql que cont les bases de dades de MySQL est a "
+"punt deser suprimit."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"Si esteu suprimint el paquet MySQL per a posteriorment instalar una versi "
+"ms recent, o si un paquet mysql-server diferent ja l'est emprant, les "
+"dades s'haurien de mantenir."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+#, fuzzy
+#| msgid "Should MySQL start on boot?"
+msgid "Start the MySQL server on boot?"
+msgstr "Voleu que el MySQL s'inici a l'arrencada ?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+#, fuzzy
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"El MySQL es pot executar automticament a l'arrencada o manualment amb "
+"l'ordre /etc/init.d/mysql start."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr ""
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"Tot i que no s requerida, s molt recomanable que establiu una "
+"contrasenya per a root, l'usuari administratiu del MySQL."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "If this field is left blank, the password will not be changed."
+msgstr ""
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"S'ha produt un error en establir la contrasenya de l'usuari administratiu "
+"del MySQL. Aix pot haver passat perqu el compte ja t una una "
+"contrasenya, o per un problema de comunicaci amb el servidor de MySQL."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "You should check the account's password after the package installation."
+msgstr ""
+"Haureu de comprovar la contrasenya del compte desprs de la instalaci "
+"del paquet."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+#, fuzzy
+#| msgid ""
+#| "Please read the /usr/share/doc/mysql-server-5.1/README.Debian file for "
+#| "more information."
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+"Llegiu el fitxer /usr/share/doc/mysql-server-5.1/README.Debian per a obtenir "
+"ms informaci."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr ""
+"Les dos contrasenyes que heu introdut no sn la mateixa. Proveu-ho de nou."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+
+#~ msgid ""
+#~ "MySQL-5.1 no longer provides NDB Cluster support. Please migrate to the "
+#~ "new "
+#~ msgstr ""
+#~ "El MySQL-5.1 ja no implementa el clster NDB. Migreu al nou paquet mysql-"
+#~ "cluster i suprimiu totes les lnies que comencen per ndb de tots els "
+#~ "fitxers de configuraci sota /etc/mysql/."
diff -uNr mysql-5.5.60.orig/debian/po/cs.po mysql-5.5.60/debian/po/cs.po
--- mysql-5.5.60.orig/debian/po/cs.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/cs.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,332 @@
+#
+#    Translators, if you are not familiar with the PO format, gettext
+#    documentation is worth reading, especially sections dedicated to
+#    this format, e.g. by running:
+#         info -n '(gettext)PO Files'
+#         info -n '(gettext)Header Entry'
+#
+#    Some information specific to po-debconf are available at
+#            /usr/share/doc/po-debconf/README-trans
+#         or http://www.debian.org/intl/l10n/po-debconf/README-trans
+#
+#    Developers do not need to manually edit POT or PO files.
+#
+msgid ""
+msgstr ""
+"Project-Id-Version: mysql-dfsg-5.5\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2012-07-15 21:05+0200\n"
+"Last-Translator: Miroslav Kure <kurem@debian.cz>\n"
+"Language-Team: Czech <debian-l10n-czech@lists.debian.org>\n"
+"Language: cs\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr "Opravdu pokraovat v degradaci?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr "V systmu existuje soubor /var/lib/mysql/debian-*.flag."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr "To znamen, e ji byl nainstalovn balk mysql-server s vy verz."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+"Neexistuje dn zruka, e momentln instalovan verze bude umt pracovat "
+"se stvajcmi databzemi."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid "Important note for NIS/YP users"
+msgstr "Dleit poznmka pro uivatele NIS/YP"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+"Pouvn MySQL pod NIS/YP vyaduje, aby byl uivatelsk et mysql pidn "
+"na mstnm systmu pkazem:"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr ""
+"Tak byste mli zkontrolovat vlastnka a oprvnn adrese /var/lib/mysql:"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr "Odstranit vechny MySQL databze?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+"Adres /var/lib/mysql, ve kterm se nachz MySQL databze, bude odstrann."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"Jestlie odstraujete balk MySQL za elem instalace novj verze MySQL, "
+"nebo pokud tato data soubn vyuv jin balk mysql-server, mli byste "
+"data ponechat."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid "Start the MySQL server on boot?"
+msgstr "Spustit MySQL server pi startu systmu?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"MySQL se me spoutt automaticky pi startu systmu, nebo run pkazem /"
+"etc/init.d/mysql start."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr "Nov heslo MySQL uivatele root:"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"Pestoe to nen nezbytn, je siln doporueno nastavit heslo u "
+"sprvcovskho MySQL tu root."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "If this field is left blank, the password will not be changed."
+msgstr "Ponechte-li pole przdn, heslo se nezmn."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "Zopakujte heslo MySQL uivatele root:"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr "Nelze nastavit heslo MySQL uivatele root"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"Bhem nastavovn hesla pro sprvcovskho uivatele MySQL se vyskytla chyba. "
+"To se mohlo stt teba proto, protoe uivatel ji ml heslo nastaveno, nebo "
+"protoe nastal problm v komunikaci s MySQL serverem."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "You should check the account's password after the package installation."
+msgstr "Po instalaci balku byste mli heslo ovit."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+"Vce informac naleznete v /usr/share/doc/mysql-server-5.5/README.Debian."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr "Chyba zadvn hesla"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr "Zadan hesla nejsou stejn. Zkuste to prosm znovu."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr "Zd se, e je pouvn NBD cluster"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+"MySQL-5.5 ji NBD cluster nepodporuje. Pejdte prosm na nov balk "
+"mysql-cluster-server a ze vech konfiguranch soubor pod /etc/mysql/ "
+"odstrate vechny dky zanajc na nbd."
+
+#~ msgid ""
+#~ "To use MySQL, the following entries for users and groups should be added "
+#~ "to the system:"
+#~ msgstr ""
+#~ "Abyste mohli MySQL pouvat, muste v systmu zaloit nsledujc "
+#~ "uivatele a skupiny:"
+
+#~ msgid "Cannot upgrade if ISAM tables are present!"
+#~ msgstr "Aktualizace nelze provst pokud jsou ptomny tabulky ISAM!"
+
+#~ msgid ""
+#~ "Recent versions of MySQL can no longer use the old ISAM table format and "
+#~ "it is necessary to convert your tables to e.g. MyISAM before upgrading by "
+#~ "using \"mysql_convert_table_format\" or \"ALTER TABLE x ENGINE=MyISAM\". "
+#~ "The installation of mysql-server-5.5 will now abort. In case your old "
+#~ "mysql-server-4.1 gets removed nevertheless just reinstall it to convert "
+#~ "those tables."
+#~ msgstr ""
+#~ "Posledn verze MySQL ji nemohou pouvat star formt tabulek ISAM a "
+#~ "ped aktualizac je nutn pevst tyto tabulky nap. do formtu MyISAM "
+#~ "pomoc \"mysql_convert_table_format\" nebo \"ALTER TABLE x ENGINE=MyISAM"
+#~ "\". Instalace mysql-server-5.5 se nyn peru. V ppad, e se mezitm "
+#~ "odinstaloval pvodn mysql-server-4.1, jednodue jej znovu nainstalujte a "
+#~ "tabulky pevete."
+
+#~ msgid ""
+#~ "Support MySQL connections from hosts running Debian \"sarge\" or older?"
+#~ msgstr ""
+#~ "Podporovat MySQL pipojen z pota pouvajcch Debian Sarge nebo "
+#~ "star?"
+
+#~ msgid ""
+#~ "In old versions of MySQL clients on Debian, passwords were not stored "
+#~ "securely. This has been improved since then, however clients (such as "
+#~ "PHP) from hosts running Debian 3.1 Sarge will not be able to connect to "
+#~ "recent accounts or accounts whose password have been changed."
+#~ msgstr ""
+#~ "Zpsob, jakm se dve ukldala hesla, nebyl pli bezpen. To se nyn "
+#~ "zlepilo, ale nevhodou je, e se klienti z Debianu 3.1 Sarge (nap. PHP) "
+#~ "nebudou moci pipojit na nov ty, nebo na ty, u nich se heslo "
+#~ "zmnilo."
+
+#~ msgid ""
+#~ "To use mysql you must install an equivalent user and group to the "
+#~ "following and ensure yourself that /var/lib/mysql has the right "
+#~ "permissions (the uid/gid may be different)."
+#~ msgstr ""
+#~ "Abyste mohli mysql pouvat, muste do nsledujcch soubor pidat "
+#~ "ekvivalentnho uivatele a skupinu a zajistit, e /var/lib/mysql m "
+#~ "sprvn prva (uid/gid se mohou liit)."
+
+#~ msgid "Remove the databases used by all MySQL versions?"
+#~ msgstr "Odstranit databze pouvan vemi verzemi MySQL?"
+
+#~ msgid ""
+#~ "If you do not provide a password no changes will be made to the account."
+#~ msgstr "Nezadte-li heslo, dn zmny se s tem neprovedou."
+
+#~ msgid ""
+#~ "When installation finishes, you should verify that the account is "
+#~ "properly protected with a password (see README.Debian for more "
+#~ "information)."
+#~ msgstr ""
+#~ "Po skonen instalace byste mli ovit, e je et chrnn heslem (vce "
+#~ "informac naleznete v souboru README.Debian)."
+
+#~ msgid "Update Hints"
+#~ msgstr "Poznmky k aktualizaci"
+
+#~ msgid ""
+#~ "You have to run \"mysql_upgrade\" after the upgrade, else tables can be  "
+#~ "corrupted! This script also enhances the privilege tables but is not  "
+#~ "supposed to give any user more rights that he had before,"
+#~ msgstr ""
+#~ "Po aktualizaci jet muste spustit \"mysql_upgrade\", protoe jinak by "
+#~ "se tabulky mohly naruit! Tento skript tak roziuje tabulky privilegi, "
+#~ "ovem neml by uivatelm pidat vce prv, ne mli dosud."
+
+#~ msgid "Please also read http://www.mysql.com/doc/en/Upgrade.html"
+#~ msgstr "Tak si pette http://www.mysql.com/doc/en/Upgrade.html"
+
+#~ msgid ""
+#~ "MySQL will only install if you have a non-numeric hostname that is "
+#~ "resolvable via the /etc/hosts file. E.g. if the \"hostname\" command "
+#~ "returns \"myhostname\" then there must be a line like \"10.0.0.1 "
+#~ "myhostname\"."
+#~ msgstr ""
+#~ "MySQL se nainstaluje pouze v ppad, e pouvte nenumerick jmno "
+#~ "potae, kter se d peloit pes soubor /etc/hosts. Nap. kdy pkaz "
+#~ "\"hostname\" vrt \"diamond\", tak v /etc/hosts mus existovat obdobn "
+#~ "dek jako \"10.0.0.1 diamond\"."
+
+#~ msgid ""
+#~ "A new mysql user \"debian-sys-maint\" will be created. This mysql account "
+#~ "is used in the start/stop and cron scripts. Don't delete."
+#~ msgstr ""
+#~ "Bude vytvoen nov mysql uivatel \"debian-sys-maint\". Tento mysql et "
+#~ "se pouv ve startovacch, ukonovacch a cronovch skriptech. Nemate "
+#~ "jej."
+
+#~ msgid ""
+#~ "Please remember to set a PASSWORD for the MySQL root user! If you use a /"
+#~ "root/.my.cnf, always write the \"user\" and the \"password\" lines in "
+#~ "there, never only the password!"
+#~ msgstr ""
+#~ "Nezapomete nastavit heslo pro et administrtora MySQL! Pouvte-li /"
+#~ "root/.my.cnf, vdy zde zadejte jak dek \"user\", tak dek \"password"
+#~ "\". Nikdy zde nezadvejte jenom heslo!"
+
+#~ msgid ""
+#~ "Should I remove the complete /var/lib/mysql directory tree which is used "
+#~ "by all MySQL versions, not necessarily only the one you are about to "
+#~ "purge?"
+#~ msgstr ""
+#~ "Mm odstranit kompletn adresov strom /var/lib/mysql, kter se pouv "
+#~ "pro vechny verze MySQL, tedy ne nutn pouze pro verzi, kterou se "
+#~ "chystte vyistit?"
diff -uNr mysql-5.5.60.orig/debian/po/da.po mysql-5.5.60/debian/po/da.po
--- mysql-5.5.60.orig/debian/po/da.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/da.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,213 @@
+# Danish translation mysql-5.5.
+# Copyright (C) 2010 mysql-5.5 & nedenstende oversttere.
+# This file is distributed under the same license as the mysql-5.5 package.
+# Claus Hindsgaul <claus_h@image.dk> 2005, 2006, 2007.
+# Joe Hansen <joedalton2@yahoo.dk>, 2010, 2012.
+#
+msgid ""
+msgstr ""
+"Project-Id-Version: mysql-5.5\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2012-08-11 05:26+0100\n"
+"Last-Translator: Joe Hansen <joedalton2@yahoo.dk>\n"
+"Language-Team: Danish <debian-l10n-danish@lists.debian.org> \n"
+"Language: \n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr "nsker du virkelig at fortstte nedgraderingen?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr "Der er en fil med navnet /var/lib/mysql/debian-*.flag p dette system."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+"Sdan en fil tyder p, at der tidligere har vret installeret en hjere "
+"version af mysql-server-pakken."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+"Det kan ikke garanteres at den version, du er ved at installere, kan benytte "
+"data fra de eksisterende databaser."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid "Important note for NIS/YP users"
+msgstr "Vigtig oplysning til NIS/YP-brugere"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+"Brug af MySQL under NIS/YP krver at en mysql-brugerkonto tilfjes p det "
+"lokale system med:"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr ""
+"Du br ogs tjekke rettighederne og ejerskabet af mappen /var/lib/mysql:"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr "Fjern alle MySQL-databaser?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+"Mappen /var/lib/mysql, der indeholder MySQL-databaserne, er ved at blive "
+"fjernet."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"Hvis du fjerner MySQL-pakken for senere at installere en nyere version, "
+"eller hvis en anden mysql-server-pakke allerede benytter den, br dataene "
+"bevares."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid "Start the MySQL server on boot?"
+msgstr "Start MySQL-serveren under systemopstart?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"MySQL-serveren kan enten startes op automatisk under systemopstarten, eller "
+"manuelt med kommandoen '/etc/init.d/mysql start'."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr "Ny adgangskode for MySQL's rootbruger:"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"Selvom det ikke krves, anbefales det kraftigt, at du stter en adgangskode "
+"for MySQL's administrationsbruger root."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "If this field is left blank, the password will not be changed."
+msgstr "Hvis du lader dette felt st tomt, vil adgangskoden ikke blive ndret."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "Gentag adgangskode for MySQL's root-bruger:"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr "Kunne ikke stte adgangskoden for MySQL's root-bruger"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"Der opstod en fejl, da adgangskoden for MySQL's administrationsbruger blev "
+"forsgt ndret. Dette kan vre sket, fordi brugeren allerede har en "
+"adgangskode, eller fordi der var problemer med at kommunikere med MySQL-"
+"serveren."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "You should check the account's password after the package installation."
+msgstr "Du br tjekke kontoens adgangskode efter pakkeinstallationen."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+"Ls venligst filen /usr/share/doc/mysql-server-5.5/README.Debian for "
+"yderligere oplysninger."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr "Inddatafejl for adgangskode"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr ""
+"De to adgangskoder du indtastede var ikke de samme. Forsg venligst igen."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr "NDB-cluster ser ud til at vre i brug"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+"MySQL-5.5 tilbyder ikke lngere NDB-clusterunderstttelse. Migrer venligst "
+"til den nye pakke mysql-cluster og fjern alle linjer der starter med ndb "
+"fra alle konfigurationsfiler under /etc/mysql/."
diff -uNr mysql-5.5.60.orig/debian/po/de.po mysql-5.5.60/debian/po/de.po
--- mysql-5.5.60.orig/debian/po/de.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/de.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,230 @@
+# translation of mysql-dfsg-5.5_5.5.37-1_de.po to Deutsch
+#
+#    Translators, if you are not familiar with the PO format, gettext
+#    documentation is worth reading, especially sections dedicated to
+#    this format, e.g. by running:
+#         info -n '(gettext)PO Files'
+#         info -n '(gettext)Header Entry'
+#    Some information specific to po-debconf are available at
+#            /usr/share/doc/po-debconf/README-trans
+#         or http://www.debian.org/intl/l10n/po-debconf/README-trans#
+#    Developers do not need to manually edit POT or PO files.
+#
+# Alwin Meschede <ameschede@gmx.de>, 2006, 2007.
+# Thomas Mueller <thomas.mueller@tmit.eu>, 2009.
+msgid ""
+msgstr ""
+"Project-Id-Version: mysql-dfsg 5.5.23-2\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2012-06-03 10:33+0200\n"
+"Last-Translator: Thomas Mueller <thomas.mueller@tmit.eu>\n"
+"Language-Team: german <debian-l10n-german@lists.debian.org>\n"
+"Language: \n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+"X-Generator: KBabel 1.11.4\n"
+"Plural-Forms:  nplurals=2; plural=(n != 1);\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr "Mchten Sie wirklich eine ltere Version einspielen?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr ""
+"Auf diesem System existiert eine Datei mit dem Namen /var/lib/mysql/debian-*."
+"flag"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+"Diese Datei ist ein Hinweis darauf, dass frher ein MySQL-Server-Paket mit "
+"einer hheren Version installiert war."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+"Es kann nicht garantiert werden, dass die gegenwrtig zu installierende "
+"Version dessen Daten benutzen kann."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid "Important note for NIS/YP users"
+msgstr "Wichtige Anmerkung fr NIS/YP-Benutzer!"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+"Falls MySQL mit NIS/YP genutzt wird, ist ein mysql-Benutzerkonto auf dem "
+"lokalen System notwendig:"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr ""
+"Sie sollten auerdem Besitzer und Zugriffsrechte des Verzeichnisses /var/lib/"
+"mysql berprfen:"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr "Alle MySQL-Datenbanken entfernen?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+"Das Verzeichnis /var/lib/mysql mit den MySQL-Datenbanken soll entfernt "
+"werden."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"Falls geplant ist, nur eine hhere Version von MySQL zu installieren oder "
+"ein anderes mysql-server-Paket dieses bereits benutzt, sollten die Daten "
+"behalten werden."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid "Start the MySQL server on boot?"
+msgstr "Soll der MySQL-Server automatisch beim Booten starten?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"Der MySQL-Dienst kann entweder automatisch beim Systemstart oder manuell "
+"durch Eingabe des Befehls /etc/init.d/mysql start gestartet werden."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr "Neues Passwort fr den MySQL root-Benutzer:"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"Obwohl es nicht zwingend erforderlich ist, wird nachdrcklich empfohlen fr "
+"den administrativen MySQL root-Benutzer ein Passwort zu setzen."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "If this field is left blank, the password will not be changed."
+msgstr "Wenn dieses Feld freigelassen wird, wird das Passwort nicht gendert."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "Wiederholen Sie das Passwort fr den MySQL-root-Benutzer:"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr "Konnte fr den MySQL-root-Benutzer kein Passwort setzen"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"Beim setzen des Passworts fr den administrativen MySQL-Benutzer ist ein "
+"Fehler aufgetreten. Dies knnte daran liegen, dass der Benutzer bereits ein "
+"Passwort hat oder dass es ein Problem mit der Kommunikation mit dem MySQL-"
+"Server gibt."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "You should check the account's password after the package installation."
+msgstr ""
+"Sie sollten das Passwort des administrativen Benutzers nach der "
+"Paketinstallation prfen."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+"Fr weitere Informationen lesen Sie /usr/share/doc/mysql-server-5.5/README."
+"Debian."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr "Passwort-Eingabefehler"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr ""
+"Die beiden von Ihnen eingegebenen Passwrter sind nicht identisch. Bitte "
+"erneut versuchen."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr "NDB-Cluster scheint gerade benutzt zu werden"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+"MySQL-5.5 bietet keine NDB-Clusteruntersttzung mehr. Bitte migrieren Sie "
+"Ihr System zum neuen mysql-cluster-server-Paket und entfernen Sie alle Zeilen, "
+"die mit ndb beginnen aus allen Konfigurationsdateien im Verzeichnis /etc/"
+"mysql/."
diff -uNr mysql-5.5.60.orig/debian/po/es.po mysql-5.5.60/debian/po/es.po
--- mysql-5.5.60.orig/debian/po/es.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/es.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,382 @@
+# mysql-5.5 translation to spanish
+# Copyright (C) 2005-2012 Software in the Public Interest, SPI Inc.
+# This file is distributed under the same license as the mysql-5.5 package.
+#
+# Changes:
+# - Initial translation
+#       Jesus Aneiros, 2006
+# - Updated
+#       Javier Fernandez-Sanguino, 2006-2012
+# - Revision
+#       Nacho Barrientos Arias
+#       Fernando Cerezal
+#       David Martnez Moreno
+#       Ricardo Mones
+#       Carlos Galisteo
+#       Javier Fernandez-Sanguino
+#       Fernando C. Estrada
+#
+#  Traductores, si no conoce el formato PO, merece la pena leer la 
+#  documentacin de gettext, especialmente las secciones dedicadas a este
+#  formato, por ejemplo ejecutando:
+#         info -n '(gettext)PO Files'
+#         info -n '(gettext)Header Entry'
+#
+# Equipo de traduccin al espaol, por favor lean antes de traducir
+# los siguientes documentos:
+#
+# - El proyecto de traduccin de Debian al espaol
+#   http://www.debian.org/intl/spanish/
+#   especialmente las notas y normas de traduccin en
+#   http://www.debian.org/intl/spanish/notas
+#
+# - La gua de traduccin de po's de debconf:
+#   /usr/share/doc/po-debconf/README-trans
+#   o http://www.debian.org/intl/l10n/po-debconf/README-trans
+#
+# Si tiene dudas o consultas sobre esta traduccin consulte con el ltimo
+# traductor (campo Last-Translator) y ponga en copia a la lista de
+# traduccin de Debian al espaol (<debian-l10n-spanish@lists.debian.org>)
+msgid ""
+msgstr ""
+"Project-Id-Version: mysql-5.5\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2012-06-17 09:49-0500\n"
+"Last-Translator: Javier Fernndez-Sanguino <jfs@debian.org>\n"
+"Language-Team: Debian l10 Spanish <debian-l10n-spanish@lists.debian.org>\n"
+"Language: es\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+"Plural-Forms: nplurals=2; plural=(n != 1);\n"
+"X-Generator: Virtaal 0.7.1\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr "Desea realmente continuar con la desactualizacin?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr ""
+"Existe un fichero con el nombre /var/lib/mysql/debian-*.flag en este sistema."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+"Este fichero indica que se instal previamente una versin superior del "
+"paquete mysql-server."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+"No se puede garantizar que la versin que est instalando pueda usar la base "
+"de datos actual."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid "Important note for NIS/YP users"
+msgstr "Nota importante para los usuarios de NIS/YP"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+"Utilizar MySQL con NIS/YP requiere que una cuenta de usuario de mysql sea "
+"agregada en el sistema local como:"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr ""
+"Tambin debera comprobar los permisos y el propietario del directorio: /var/"
+"lib/mysql"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr "Desea eliminar todas las bases de datos MySQL?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+"El directorio /var/lib/mysql contiene bases de datos MySQL que van a "
+"eliminarse."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"Debera mantener los datos si tiene planificado instalar una versin de "
+"MySQL ms reciente o si hay un paquete mysql-server distinto que los est "
+"utilizando."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid "Start the MySQL server on boot?"
+msgstr "Desea que el servidor MySQL se ejecute al iniciar el sistema?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"El servidor MySQL puede iniciarse en el momento de arranque del sistema o "
+"manualmente si escribe la orden /etc/init.d/mysql start."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr "Nueva contrasea para el usuario root de MySQL:"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"Se recomienda que configure una contrasea para el usuario "
+"root (administrador) de MySQL, aunque no es obligatorio."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "If this field is left blank, the password will not be changed."
+msgstr "No se modificar la contrasea si deja el espacio en blanco."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "Nueva contrasea para el usuario root de MySQL:"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr "No se pudo fijar la contrasea para el usuario root de MySQL"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"Se produjo un error mientras intentaba fijar la contrasea para el usuario "
+"administrador de MySQL. Esto puede haber sucedido porque la cuenta ya tena "
+"una contrasea o porque se produjo un error de comunicacin con el servidor "
+"MySQL."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "You should check the account's password after the package installation."
+msgstr ""
+"Debera comprobar la contrasea de la cuenta despus de la instalacin del "
+"paquete."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+"Consulte /usr/share/doc/mysql-server-5.5/README.Debian para ms informacin."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr "Se ha producido un error al introducir la contrasea"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr ""
+"Las dos contraseas que ha introducido son distintas. Intente de nuevo."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr "NDB Cluster parece estar en uso"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+"MySQL-5.5 ya no brinda soporte para NDB Cluster. Migre al nuevo paquete "
+"mysql-cluster-server y elimine todas las lneas que empiecen con \"ndb\" "
+"de todos los ficheros de configuracin bajo /etc/mysql/."
+
+#~ msgid ""
+#~ "To use MySQL, the following entries for users and groups should be added "
+#~ "to the system:"
+#~ msgstr ""
+#~ "Deben aadirse las siguientes entradas para usuarios y grupos en el "
+#~ "sistema para poder utilizar MySQL:"
+
+#~ msgid "Cannot upgrade if ISAM tables are present!"
+#~ msgstr "No se puede actualizar si ya hay tablas ISAM!"
+
+#~ msgid ""
+#~ "Recent versions of MySQL can no longer use the old ISAM table format and "
+#~ "it is necessary to convert your tables to e.g. MyISAM before upgrading by "
+#~ "using \"mysql_convert_table_format\" or \"ALTER TABLE x ENGINE=MyISAM\". "
+#~ "The installation of mysql-server-5.5 will now abort. In case your old "
+#~ "mysql-server-4.1 gets removed nevertheless just reinstall it to convert "
+#~ "those tables."
+#~ msgstr ""
+#~ "Las versiones recientes de MySQL ya no soportan el antiguo formato de "
+#~ "tabla ISAM. Antes de realizar la actualizacin es necesario convertir sus "
+#~ "tablas a por ejemplo, MyISAM, usando mysql_convert_table_format o "
+#~ "ALTER TABLE x ENGINE=MyISAM. Se va a interrumpir ahora la instalacin "
+#~ "de mysql-server-5.5. Si an as su mysql-server-4.1 se elimina an as, "
+#~ "puede reinstalarlo para convertir ese tipo de tablas."
+
+#~ msgid ""
+#~ "Support MySQL connections from hosts running Debian \"sarge\" or older?"
+#~ msgstr ""
+#~ "Soportar las conexiones MySQL establecidadas desde sistemas que ejecutan "
+#~ "Debian Sarge o versiones anteriores?"
+
+#~ msgid ""
+#~ "In old versions of MySQL clients on Debian, passwords were not stored "
+#~ "securely. This has been improved since then, however clients (such as "
+#~ "PHP) from hosts running Debian 3.1 Sarge will not be able to connect to "
+#~ "recent accounts or accounts whose password have been changed."
+#~ msgstr ""
+#~ "No era muy segura la forma en la que se almacenaban las contraseas en "
+#~ "versiones anteriores del cliente de MySQL en Debian. Este problema se ha "
+#~ "mejorado posteriormente con el inconveniente, sin embargo, de que "
+#~ "clientes (por ejemplo, PHP) en sistemas que ejecutan Debian 3.1 Sarge "
+#~ "no podrn conectarse a cuentas que son nuevas o a las que se le haya "
+#~ "cambiado la contrasea."
+
+#~ msgid ""
+#~ "To use mysql you must install an equivalent user and group to the "
+#~ "following and ensure yourself that /var/lib/mysql has the right "
+#~ "permissions (the uid/gid may be different)."
+#~ msgstr ""
+#~ "Para utilizar mysql debe instalar un usuario y grupo equivalente al "
+#~ "siguiente y asegurarse de que /var/lib/mysql tiene los permisos correctos "
+#~ "(los valores del uid y del gid pueden ser diferentes)."
+
+#~ msgid ""
+#~ "/etc/passwd:      mysql:x:100:101:MySQL Server:/var/lib/mysql:/bin/false"
+#~ msgstr ""
+#~ "/etc/passwd:      mysql:x:100:101:MySQL Server:/var/lib/mysql:/bin/false"
+
+#~ msgid "/etc/group:       mysql:x:101:"
+#~ msgstr "/etc/group:       mysql:x:101:"
+
+#~ msgid "/var/lib/mysql:   drwxr-xr-x   mysql    mysql"
+#~ msgstr "/var/lib/mysql:   drwxr-xr-x   mysql    mysql"
+
+#~ msgid "Remove the databases used by all MySQL versions?"
+#~ msgstr ""
+#~ "Eliminar las bases de datos utilizadas por todas las versiones de MySQL?"
+
+#~ msgid ""
+#~ "If you do not provide a password no changes will be made to the account."
+#~ msgstr ""
+#~ "No se har ningn cambio en la cuenta si no introduce una contrasea."
+
+#~ msgid ""
+#~ "When installation finishes, you should verify that the account is "
+#~ "properly protected with a password (see README.Debian for more "
+#~ "information)."
+#~ msgstr ""
+#~ "Debera confirmar que la contrasea est correctamente protegida con una "
+#~ "contrasea cuando termine la instalacin (consulte el fichero README."
+#~ "Debian si desea ms informacin)."
+
+#~ msgid "Install Hints"
+#~ msgstr "Sugerencias para la instalacin"
+
+#~ msgid ""
+#~ "On upgrades from MySQL 3.23, as shipped with Debian Woody, symlinks in "
+#~ "place of /var/lib/mysql or /var/log/mysql gets accidently removed and "
+#~ "have manually be restored."
+#~ msgstr ""
+#~ "Al actualizar a la versin de MySQL 3.23, la vrsin proporcionada en "
+#~ "Debian Woody, se eliminan de manera accidental, los enlaces simblicos a "
+#~ "/var/lib/mysql o /var/log/mysql y tienen que restaurarse manualmente."
+
+#~ msgid ""
+#~ "MySQL will only install if you have a non-numeric hostname that is "
+#~ "resolvable via the /etc/hosts file. E.g. if the \"hostname\" command "
+#~ "returns \"myhostname\" then there must be a line like \"10.0.0.1 "
+#~ "myhostname\"."
+#~ msgstr ""
+#~ "Slo se instalar MySQL si tiene un nombre de equipo que no sea una "
+#~ "direccin IP y pueda resolverse a travs del fichero /etc/hosts. Por "
+#~ "ejemplo, si la orden hostname devuelve MiNombreEquipo entonces deber "
+#~ "existir una lnea 10.0.0.1 MiNombreEquipo en dicho fichero."
+
+#~ msgid ""
+#~ "A new mysql user \"debian-sys-maint\" will be created. This mysql account "
+#~ "is used in the start/stop and cron scripts. Don't delete."
+#~ msgstr ""
+#~ "Se crear un nuevo usuario debian-sys-maint. Esta cuenta de mysql se "
+#~ "utilizar en los scripts de inicio y parada y en los scripts cron. No "
+#~ "la elimine."
+
+#~ msgid ""
+#~ "Please remember to set a PASSWORD for the MySQL root user! If you use a /"
+#~ "root/.my.cnf, always write the \"user\" and the \"password\" lines in "
+#~ "there, never only the password!"
+#~ msgstr ""
+#~ "Por favor, recuerde crear una CONTRASEA para el usuario root de "
+#~ "MySQL! Si utiliza /root/.my.cnf debe escribir las lneas user y "
+#~ "password en dicho fichero, no incluya slo la contrasea!"
+
+#~ msgid ""
+#~ "Should I remove the complete /var/lib/mysql directory tree which is used "
+#~ "by all MySQL versions, not necessarily only the one you are about to "
+#~ "purge?"
+#~ msgstr ""
+#~ "Debera eliminar el rbol de directorio /var/lib/mysql completo? Tenga "
+#~ "en cuenta que lo utilizan todas las versiones de MySQL y no slo la que "
+#~ "est a punto de purgar."
diff -uNr mysql-5.5.60.orig/debian/po/eu.po mysql-5.5.60/debian/po/eu.po
--- mysql-5.5.60.orig/debian/po/eu.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/eu.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,236 @@
+# translation of eu.po to Euskara
+# Piarres BEobide <pi@beobide.net>, 2006.
+# Piarres Beobide <pi@beobide.net>, 2009.
+# Copyright (C) YEAR THE PACKAGE'S COPYRIGHT HOLDER
+# This file is distributed under the same license as the PACKAGE package.
+msgid ""
+msgstr ""
+"Project-Id-Version: eu\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2009-07-29 11:59+0200\n"
+"Last-Translator: Piarres Beobide <pi@beobide.net>\n"
+"Language-Team: Euskara <debian-l10n-eu@lists.debian.org>\n"
+"Language: \n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+"Plural-Forms: nplurals=2; plural=(n != 1);\n"
+"X-Generator: KBabel 1.11.4\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr "Benetan bertsio zaharragora itzuli nahi duzu?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr "Sisteman badago /var/lib/mysql/debian-*.flag izeneko fitxategi bat."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+#, fuzzy
+#| msgid ""
+#| "Such file is an indication that a mysql-server package with a higher "
+#| "version has been installed earlier."
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+"Fitxategi honek aurretik bertsio berriagoko mysql-zerbitzari pakete bat "
+"instalatu dela adierazten du."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+"Ezin da ziurtatu instalatzen ari zaren bertsio honek dauden datubaseak "
+"erabili ahal izango dituenik."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid "Important note for NIS/YP users"
+msgstr "NIS/YP erabiltzaileentzat ohar garrantzitsua"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+#, fuzzy
+#| msgid ""
+#| "You should also check the permissions and the owner of the /var/lib/mysql "
+#| "directory:"
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr ""
+"Honetaz gain /var/lib/mysql direktorioaren jabea eta baimenak egiaztatu "
+"beharko zenituzke:"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr "Ezabatu MySQL datubase guztiak?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr "MySQL datubaseak dituen /var/lib/mysql direktorioa ezabatua izango da."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"MySQL paketea beranduago bertsio berriago bat instalatzeko kentzen ari "
+"bazara, edo beste mysql-server pakete bat berau erabiltzen ari bada, datuak "
+"mantendu egin beharko lirateke."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid "Start the MySQL server on boot?"
+msgstr "Abioan MySQL zerbitzaria abiarazi?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"Sistema abioan MySQL automatikoki abiarazi daiteke edo eskuz '/etc/init.d/"
+"mysql start' eginaz."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr "MySQL \"root\" erabiltzailearen pasahitz berria:"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"Derrigorrezkoa ez denean, oso gomendagarria da MySQL administratzaile \"root"
+"\" erabiltzaileari pasahitz bat ezartzea."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+#, fuzzy
+#| msgid "If that field is left blank, the password will not be changed."
+msgid "If this field is left blank, the password will not be changed."
+msgstr "Eremua hau zurian utziaz gero ez da pasahitza aldatuko."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "Errepikatu MySQL \"root\" erabiltzailearen pasahitza:"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr "Ezin da MySQL \"root\" erabiltzailearen pasahitza ezarri"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"Errore bat gertatu da MySQL administratzaile kontuaren pasahitza ezartzean.  "
+"Hau erabiltzaileak dagoeneko pasahitz bat duelako edo MySQL "
+"zerbitzariarekiko konexioan erroreak daudelako gertatu daiteke."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "You should check the account's password after the package installation."
+msgstr ""
+"Kontuaren pasahitza egiaztatu beharko zenuke paketea instalatu aurretik."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+#, fuzzy
+#| msgid ""
+#| "Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for "
+#| "more information."
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+"Mesedez irakurri /usr/share/doc/mysql-server-5.5/README.Debian fitxategia "
+"xehetasun gehiagorako."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr "Pasahitz sarrera errorea"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr "Idatzi dituzun bi pasahitzak ez dira berdina. Mesedez saiatu berriz."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr "Dirudienez NDB Cluster-a erabilia dago"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+#, fuzzy
+#| msgid ""
+#| "MySQL-5.5 has orphaned NDB Cluster support. Please migrate to the new "
+#| "mysql-cluster package and remove all lines starting with \"ndb\" from all "
+#| "config files below /etc/mysql/."
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+"MySQL-5.5-ek NDB cluster euskarri umezurtz bat behar du. Mesedez migratu "
+"mysql-cluster pakete berrira eta /etc/mysql/ azpiko konfigurazio fitxategi "
+"guztietan \"ndb\"-ez hasten diren lerro guztiak ezabatu."
+
+#~ msgid ""
+#~ "To use MySQL, the following entries for users and groups should be added "
+#~ "to the system:"
+#~ msgstr ""
+#~ "MySQL erabili ahal izateko, hurrengo erabiltzaile eta taldeak gehitu "
+#~ "behar dira sisteman:"
diff -uNr mysql-5.5.60.orig/debian/po/fr.po mysql-5.5.60/debian/po/fr.po
--- mysql-5.5.60.orig/debian/po/fr.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/fr.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,242 @@
+# Translation of mysql-dfsg-* debconf templates to French
+# Copyright (C) 2004-2009 Debian French l10n team <debian-l10n-french@lists.debian.org>
+# This file is distributed under the same license as the mysql-dfsg-* packages.
+#
+# Translators:
+# Christian Perrier <bubulle@debian.org>, 2004, 2006, 2007, 2009, 2012.
+msgid ""
+msgstr ""
+"Project-Id-Version: fr\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2012-05-22 08:30+0200\n"
+"Last-Translator: Christian Perrier <bubulle@debian.org>\n"
+"Language-Team: French <debian-l10n-french@lists.debian.org>\n"
+"Language: fr\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+"debian.org>\n"
+"X-Generator: Lokalize 1.2\n"
+"Plural-Forms: Plural-Forms: nplurals=2; plural=n>1;\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr "Faut-il vraiment revenir  la version prcdente?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr "Un fichier /var/lib/mysql/debian-*.flag est prsent sur ce systme."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+"Cela indique qu'une version plus rcente du paquet mysql-server a t "
+"prcdemment installe."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr "Il n'est pas garanti que cette version puisse en utiliser les donnes."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid "Important note for NIS/YP users"
+msgstr "Note importante pour les utilisateurs NIS/YP"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+"L'utilisation de MySQL avec NIS/YP impose l'ajout d'un compte local "
+"mysql avec la commande:"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr ""
+"Vous devez galement vrifier le propritaire et les permissions du "
+"rpertoire /var/lib/mysql:"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr "Faut-il supprimer toutes les bases de donnes MySQL?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+"Le rpertoire /var/lib/mysql qui contient les bases de donnes de MySQL va "
+"tre supprim."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"Si vous prvoyez d'installer une version plus rcente de MySQL ou si un "
+"autre paquet mysql-server les utilise dj, vous devriez les conserver."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid "Start the MySQL server on boot?"
+msgstr "Faut-il lancer MySQL au dmarrage?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"MySQL peut tre lanc soit au dmarrage, soit en entrant la commande /etc/"
+"init.d/mysql start."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr "Nouveau mot de passe du superutilisateur de MySQL:"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"Il est trs fortement recommand d'tablir un mot de passe pour le compte "
+"d'administration de MySQL (root)."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "If this field is left blank, the password will not be changed."
+msgstr "Si ce champ est laiss vide, le mot de passe ne sera pas chang."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "Confirmation du mot de passe du superutilisateur de MySQL:"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr ""
+"Impossible de changer le mot de passe de l'utilisateur root de MySQL"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"Une erreur s'est produite lors du changement de mot de passe du compte "
+"d'administration. Un mot de passe existait peut-tre dj ou il n'a pas t "
+"possible de communiquer avec le serveur MySQL."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "You should check the account's password after the package installation."
+msgstr ""
+"Vous devriez vrifier le mot de passe de ce compte aprs l'installation du "
+"paquet."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+"Veuillez consulter le fichier /usr/share/doc/mysql-server-5.5/README.Debian "
+"pour plus d'informations."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr "Erreur de saisie du mot de passe"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr ""
+"Le mot de passe et sa confirmation ne sont pas identiques. Veuillez "
+"recommencer."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr "Abandon de la gestion de NDB"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+"La version 5.5 de MySQL ne gre plus les grappes NDB. Vous devriez utiliser "
+"le paquet mysql-cluster-server et supprimer toutes les lignes commenant par "
+"ndb des fichiers de configuration situs dans /etc/mysql."
+
+#~ msgid ""
+#~ "To use MySQL, the following entries for users and groups should be added "
+#~ "to the system:"
+#~ msgstr ""
+#~ "Pour pouvoir utiliser MySQL, les utilisateurs et les groupes suivants "
+#~ "doivent tre ajouts au systme:"
+
+#~ msgid ""
+#~ "Support MySQL connections from hosts running Debian \"sarge\" or older?"
+#~ msgstr ""
+#~ "Grer les connexions d'htes qui utilisent les versions Debian sarge "
+#~ "ou antrieures ?"
+
+#~ msgid ""
+#~ "In old versions of MySQL clients on Debian, passwords were not stored "
+#~ "securely. This has been improved since then, however clients (such as "
+#~ "PHP) from hosts running Debian 3.1 Sarge will not be able to connect to "
+#~ "recent accounts or accounts whose password have been changed."
+#~ msgstr ""
+#~ "La mthode de stockage des mots de passe n'tait pas trs sre dans les "
+#~ "version prcdentes de ce paquet. Cette mthode a t amliore mais les "
+#~ "modifications empchent la connexion avec de nouveaux comptes ou des "
+#~ "comptes dont le mot de passe a t modifi, pour les clients (p.ex. PHP) "
+#~ "depuis des htes qui utilisent Debian 3.1 sarge."
diff -uNr mysql-5.5.60.orig/debian/po/gl.po mysql-5.5.60/debian/po/gl.po
--- mysql-5.5.60.orig/debian/po/gl.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/gl.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,249 @@
+# Galician translation of mysql-dfsg-5.5's debconf templates
+# This file is distributed under the same license as the mysql-dfsg-5.5 package.
+# Jacobo Tarrio <jtarrio@debian.org>, 2007.
+#
+msgid ""
+msgstr ""
+"Project-Id-Version: mysql-dfsg-5.5\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2007-04-20 09:44+0200\n"
+"Last-Translator: Jacobo Tarrio <jtarrio@debian.org>\n"
+"Language-Team: Galician <proxecto@trasno.net>\n"
+"Language: gl\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr "Quere pasar a unha versin anterior?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr "Neste sistema hai un ficheiro chamado /var/lib/mysql/debian-*.flag."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+#, fuzzy
+#| msgid ""
+#| "Such file is an indication that a mysql-server package with a higher "
+#| "version has been installed earlier."
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+"Este ficheiro indica que antes se instalou un paquete mysql-server cunha "
+"versin superior."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+"Non se pode garantir que a versin que est a instalar poida empregar as "
+"bases de datos actuais."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid "Important note for NIS/YP users"
+msgstr "Nota importante para os usuarios de NIS/YP"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+#, fuzzy
+#| msgid ""
+#| "You should also check the permissions and the owner of the /var/lib/mysql "
+#| "directory:"
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr ""
+"Tamn debera comprobar os permisos e o propietario do directorio /var/lib/"
+"mysql:"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr "Eliminar tdalas bases de datos de MySQL?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+"Hase eliminar o directorio /var/lib/mysql, que contn as bases de datos de "
+"MySQL."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"Se est a eliminar o paquete MySQL para instalar despois unha versin mis "
+"recente ou se xa hai un paquete mysql-server diferente a empregalo, debera "
+"conservar os datos."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid "Start the MySQL server on boot?"
+msgstr "Iniciar o servidor MySQL co ordenador?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"Pdese iniciar automaticamente o servidor MySQL ao iniciar o ordenador, ou "
+"manualmente coa orde \"/etc/init.d/mysql start\"."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr "Novo contrasinal para o usuario \"root\" de MySQL:"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"Anda que non  obrigatorio, recomndase encarecidamente que estableza un "
+"contrasinal para o usuario administrativo \"root\" de MySQL."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+#, fuzzy
+#| msgid "If that field is left blank, the password will not be changed."
+msgid "If this field is left blank, the password will not be changed."
+msgstr "Se deixa o campo en branco, non se ha cambiar o contrasinal."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+#, fuzzy
+#| msgid "New password for the MySQL \"root\" user:"
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "Novo contrasinal para o usuario \"root\" de MySQL:"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr "Non se puido establecer o contrasinal do usuario \"root\" de MySQL"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"Houbo un erro ao establecer o contrasinal do usuario administrativo de "
+"MySQL. Puido ocorrer porque o usuario xa tea un contrasinal ou debido a un "
+"problema de comunicacins co servidor MySQL."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+#, fuzzy
+#| msgid ""
+#| "You should check the account's password after tha package installation."
+msgid "You should check the account's password after the package installation."
+msgstr "Debera comprobar o contrasinal da conta trala instalacin do paquete."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+#, fuzzy
+#| msgid ""
+#| "Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for "
+#| "more information."
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+"Consulte o ficheiro /usr/share/doc/mysql-server-5.5/README.Debian para mis "
+"informacin."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+
+#~ msgid ""
+#~ "To use MySQL, the following entries for users and groups should be added "
+#~ "to the system:"
+#~ msgstr ""
+#~ "Para empregar MySQL deberan engadirse ao sistema as seguintes entradas "
+#~ "de usuarios e grupos:"
+
+#~ msgid ""
+#~ "Support MySQL connections from hosts running Debian \"sarge\" or older?"
+#~ msgstr ""
+#~ "Soportar as conexins a MySQL de mquinas que empreguen Debian \"sarge\" "
+#~ "ou anterior?"
+
+#~ msgid ""
+#~ "In old versions of MySQL clients on Debian, passwords were not stored "
+#~ "securely. This has been improved since then, however clients (such as "
+#~ "PHP) from hosts running Debian 3.1 Sarge will not be able to connect to "
+#~ "recent accounts or accounts whose password have been changed."
+#~ msgstr ""
+#~ "Nas versins antigas dos clientes MySQL de Debian, os contrasinais non se "
+#~ "armacenaban de xeito seguro. Isto mellorouse desde aquela; nembargantes, "
+#~ "os clientes (tales coma PHP) das mquinas que executen Debian 3.1 Sarge "
+#~ "non se han poder conectar a contas recentes ou a contas nas que se "
+#~ "cambiara o contrasinal."
diff -uNr mysql-5.5.60.orig/debian/po/it.po mysql-5.5.60/debian/po/it.po
--- mysql-5.5.60.orig/debian/po/it.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/it.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,223 @@
+# Italian (it) translation of debconf templates for mysql-dfsg-5.5
+# Copyright (C) 2009 Software in the Public Interest
+# This file is distributed under the same license as the mysql-dfsg-5.5 package.
+# Luca Monducci <luca.mo@tiscali.it>, 2006 - 2009.
+# 
+msgid ""
+msgstr ""
+"Project-Id-Version: mysql-dfsg-5.5 5.5.37 italian debconf templates\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2009-08-08 11:03+0200\n"
+"Last-Translator: Luca Monducci <luca.mo@tiscali.it>\n"
+"Language-Team: Italian <debian-l10n-italian@lists.debian.org>\n"
+"Language: it\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr "Procedere realmente con l'abbassamento di versione?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr ""
+"Su questo sistema esiste un file con nome /var/lib/mysql/debian-*.flag."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+"Quel file indica che in precedenza  stata installata una versione superiore "
+"del pacchetto mysql-server."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+"Non  garantito che la versione che si sta installando sia in grado di usare "
+"i database presenti."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid "Important note for NIS/YP users"
+msgstr "Nota importante per gli utenti NIS/YP"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+"Per usare MySQL con NIS/YP  necessario aggiungere al sistema locale un "
+"account utente per mysql con:"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr ""
+"Inoltre si devono verificare i permessi e la propriet della directory /var/"
+"lib/mysql:"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr "Eliminare tutti i database MySQL?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+"La directory /var/lib/mysql contenente i database di MySQL sta per essere "
+"eliminata."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"Se si rimuove il pacchetto MySQL per poi installare una versione pi recente "
+"oppure se sono gi in uso da un altro pacchetto mysql-server, i dati non "
+"devono essere eliminati."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid "Start the MySQL server on boot?"
+msgstr "Lanciare il server MySQL all'avvio?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"Il server MySQL pu essere lanciato automaticamente all'avvio del sistema "
+"oppure manualmente con il comando /etc/init.d/mysql start."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr "Nuova password per l'utente root di MySQL:"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"Sebbene non sia obbligatoria, si raccomanda d'impostare una password per "
+"l'utente d'amministrazione root di MySQL."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "If this field is left blank, the password will not be changed."
+msgstr "Se questo campo  lasciato vuoto, la password non viene cambiata."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "Ripetere la password per l'utente root di MySQL:"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr "Impossibile impostare la password per l'utente root di MySQL"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"Si  verificato un errore durante l'impostazione della password per l'utente "
+"d'amministrazione di MySQL. Questo pu essere accaduto perch l'utente ha "
+"gi una password oppure a causa di un problema di connessione con il server "
+"MySQL."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "You should check the account's password after the package installation."
+msgstr ""
+"Al termine dell'installazione si deve verificare la password dell'account."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+#, fuzzy
+#| msgid ""
+#| "Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for "
+#| "more information."
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+"Per maggiori informazioni si consulti il file /usr/share/doc/mysql-"
+"server-5.5/README.Debian."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr "Errore di inserimento della password"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr "Le due password inserite sono diverse. Riprovare."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr " in uso un cluster NDB"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+#, fuzzy
+#| msgid ""
+#| "MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the "
+#| "new mysql-cluster package and remove all lines starting with \"ndb\" from "
+#| "all config files below /etc/mysql/."
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+"MySQL-5.5 non fornisce pi il supporto per i cluster NDB. Si dovrebbe "
+"migrare al nuovo pacchetto mysql-cluster e rimuovere tutte le righe che "
+"iniziano per \"ndb\" da tutti i file di configurazione sotto /etc/mysql/."
diff -uNr mysql-5.5.60.orig/debian/po/ja.po mysql-5.5.60/debian/po/ja.po
--- mysql-5.5.60.orig/debian/po/ja.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/ja.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,229 @@
+#
+#    Translators, if you are not familiar with the PO format, gettext
+#    documentation is worth reading, especially sections dedicated to
+#    this format, e.g. by running:
+#         info -n '(gettext)PO Files'
+#         info -n '(gettext)Header Entry'
+#
+#    Some information specific to po-debconf are available at
+#            /usr/share/doc/po-debconf/README-trans
+#         or http://www.debian.org/intl/l10n/po-debconf/README-trans
+#
+#    Developers do not need to manually edit POT or PO files.
+#
+#
+msgid ""
+msgstr ""
+"Project-Id-Version: mysql-dfsg-5.5 5.5.37-1\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2009-09-01 08:25+0900\n"
+"Last-Translator: Hideki Yamane (Debian-JP) <henrich@debian.or.jp>\n"
+"Language-Team: Japanese <debian-japanese@lists.debian.org>\n"
+"Language: ja\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr "?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr ""
+"  /var/lib/mysql/debian-*.flag "
+""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+" mysql-server "
+""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+""
+""
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid "Important note for NIS/YP users"
+msgstr "NIS/YP "
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+"NIS/YP  MySQL  mysql "
+""
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr "/var/lib/mysql "
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr " MySQL ?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+"MySQL  /var/lib/mysql "
+""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+" MySQL "
+" mysql-server "
+""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid "Start the MySQL server on boot?"
+msgstr "MySQL ?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"MySQL  '/etc/"
+"init.d/mysql start' "
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr "MySQL  \"root\" :"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"MySQL  \"root\" "
+""
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "If this field is left blank, the password will not be changed."
+msgstr ""
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "MySQL  \"root\" :"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr "MySQL  \"root\" "
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"MySQL "
+"MySQL "
+""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "You should check the account's password after the package installation."
+msgstr ""
+""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+#, fuzzy
+#| msgid ""
+#| "Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for "
+#| "more information."
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+" /usr/share/doc/mysql-server-5.5/README.Debian "
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr "NDB "
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+#, fuzzy
+#| msgid ""
+#| "MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the "
+#| "new mysql-cluster package and remove all lines starting with \"ndb\" from "
+#| "all config files below /etc/mysql/."
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+"MySQL-5.5  NDB  mysql-"
+"cluster /etc/mysql ndb"
+""
diff -uNr mysql-5.5.60.orig/debian/po/nb.po mysql-5.5.60/debian/po/nb.po
--- mysql-5.5.60.orig/debian/po/nb.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/nb.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,297 @@
+# translation of mysql_nb.po to Norwegian Bokml
+# Copyright (C) YEAR THE PACKAGE'S COPYRIGHT HOLDER
+# This file is distributed under the same license as the PACKAGE package.
+#
+# Bjrn Steensrud <bjornst@powertech.no>, 2007.
+msgid ""
+msgstr ""
+"Project-Id-Version: mysql_nb\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2007-02-18 12:13+0100\n"
+"Last-Translator: Bjrn Steensrud <bjornst@powertech.no>\n"
+"Language-Team: Norwegian Bokml <i18n-nb@lister.ping.uio.no>\n"
+"Language: \n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+"X-Generator: KBabel 1.11.2\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+#, fuzzy
+#| msgid "Do you really want to downgrade?"
+msgid "Really proceed with downgrade?"
+msgstr "Er du sikker p at du vil nedgradere?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+#, fuzzy
+#| msgid ""
+#| "WARNING: The file /var/lib/mysql/debian-*.flag exists. This indicates "
+#| "that a mysql-server package with a higher version has been installed "
+#| "before. It can not be guaranteed that this version can use its data."
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+"ADVARSEL: Fila /var/lib/mysql/debian-*.flag finnes. Dette viser at en mysql-"
+"server-pakke med et hyere versjonsnummer har vrt installert fr. Det kan "
+"ikke garanteres at denne versjonen kan bruke data fra den hyere versjonen."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+#, fuzzy
+#| msgid "Important note for NIS/YP users!"
+msgid "Important note for NIS/YP users"
+msgstr "Viktig merknad for NIS/YP-brukere!"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+#, fuzzy
+#| msgid ""
+#| "The script is about to remove the data directory /var/lib/mysql. If it is "
+#| "planned to just install a higher MySQL version or if a different mysql-"
+#| "server package is already using it, the data should be kept."
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"Dette skriptet skal til  fjerne data-mappa /var/lib/mysql. Denne mappa br "
+"beholdes hvis det bare skal installeres en hyere MySQL-versjon, eller hvis "
+"en annen mysql-server-pakke allerede bruker den."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+#, fuzzy
+#| msgid "Should MySQL start on boot?"
+msgid "Start the MySQL server on boot?"
+msgstr "Skal MySQL startes ved maskinoppstart?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+#, fuzzy
+#| msgid ""
+#| "The MySQL can start automatically on boot time or only if you manually "
+#| "type '/etc/init.d/mysql start'."
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"MySQL kan startes automatisk nr maskinen starter, eller bare hvis du "
+"skriver /etc/init.d/mysql start."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+#, fuzzy
+#| msgid "New password for MySQL \"root\" user:"
+msgid "New password for the MySQL \"root\" user:"
+msgstr "Nytt passord for MySQLs root-bruker:"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+#, fuzzy
+#| msgid ""
+#| "It is highly recommended that you set a password for the MySQL "
+#| "administrative \"root\" user."
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"Det anbefales sterkt at du oppgir et passord for den administrative root-"
+"brukeren i MySQl."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "If this field is left blank, the password will not be changed."
+msgstr ""
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+#, fuzzy
+#| msgid "New password for MySQL \"root\" user:"
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "Nytt passord for MySQLs root-bruker:"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+#, fuzzy
+#| msgid "Unable to set password for MySQL \"root\" user"
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr "Klarer ikke angi passord for MySQLs root-bruker"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+#, fuzzy
+#| msgid ""
+#| "It seems an error occurred while setting the password for the MySQL "
+#| "administrative user.  This may have happened because the user already has "
+#| "a password, or because there was a problem communicating with the MySQL "
+#| "server."
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"Det ser ut til at det oppsto en feil mens det ble satt et passord for MySQLs "
+"administrative bruker. Dette kan vre fordi brukeren allerede har et "
+"passord, eller fordi det var et kommunikasjonsproblem med MySQL-tjeneren."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "You should check the account's password after the package installation."
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+
+#~ msgid ""
+#~ "Support MySQL connections from hosts running Debian \"sarge\" or older?"
+#~ msgstr ""
+#~ "Skal MySQL-tilkoblinger stttes fra vertsmaskiner som kjrer Debian "
+#~ "sarge eller eldre?"
+
+#, fuzzy
+#~| msgid ""
+#~| "The way passwords were stored was not very secure. This has been "
+#~| "improved with the drawback that clients (e.g. PHP) from hosts running "
+#~| "Debian 3.1 Sarge will not be able to connect to account which are new or "
+#~| "whose password have been changed. See /usr/share/doc/mysql-server-5.5/"
+#~| "README.Debian."
+#~ msgid ""
+#~ "In old versions of MySQL clients on Debian, passwords were not stored "
+#~ "securely. This has been improved since then, however clients (such as "
+#~ "PHP) from hosts running Debian 3.1 Sarge will not be able to connect to "
+#~ "recent accounts or accounts whose password have been changed."
+#~ msgstr ""
+#~ "Passord ble tidligere lagret p en lite sikker mte. Dette er n "
+#~ "forbedret, med den ulempen at klienter (f.eks. PHP) fra verter som kjrer "
+#~ "Debian 3.1 Sarge ikke vil kunne koble til en konto som er ny eller har "
+#~ "ftt endret passordet. Se /usr/share/doc/mysql-server-5.5/README.Debian."
+
+#~ msgid ""
+#~ "To use mysql you must install an equivalent user and group to the "
+#~ "following and ensure yourself that /var/lib/mysql has the right "
+#~ "permissions (the uid/gid may be different)."
+#~ msgstr ""
+#~ "For  bruke MySQL m du installere en bruker og gruppe tilsvarende den "
+#~ "nedenfor og se til at /var/lib/mysql har riktige rettigheter (uid/gid kan "
+#~ "vre forskjellig)."
+
+#~ msgid ""
+#~ "/etc/passwd:      mysql:x:100:101:MySQL Server:/var/lib/mysql:/bin/false"
+#~ msgstr ""
+#~ "/etc/passwd:      mysql:x:100:101:MySQL Server:/var/lib/mysql:/bin/false"
+
+#~ msgid "/etc/group:       mysql:x:101:"
+#~ msgstr "/etc/group:       mysql:x:101:"
+
+#~ msgid "/var/lib/mysql:   drwxr-xr-x   mysql    mysql"
+#~ msgstr "/var/lib/mysql:   drwxr-xr-x   mysql    mysql"
+
+#~ msgid "Remove the databases used by all MySQL versions?"
+#~ msgstr "Skal databasene brukt av alle MySQL-versjoner fjernes?"
+
+#~ msgid ""
+#~ "If you do not provide a password no changes will be made to the account."
+#~ msgstr ""
+#~ "Hvis du ikke oppgir et passord blir det ikke gjort noen endringer med "
+#~ "kontoen."
+
+#~ msgid ""
+#~ "When installation finishes, you should verify that the account is "
+#~ "properly protected with a password (see README.Debian for more "
+#~ "information)."
+#~ msgstr ""
+#~ "Nr installasjonen er ferdig br det sjekkes at kontoen er ordentlig "
+#~ "beskyttet med et passord (mer informasjon finnes i README.Debian)."
diff -uNr mysql-5.5.60.orig/debian/po/nl.po mysql-5.5.60/debian/po/nl.po
--- mysql-5.5.60.orig/debian/po/nl.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/nl.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,219 @@
+# Dutch mysql-dfsg-5.5 po-debconf translation,
+# Copyright (C) 2006 THE PACKAGE'S COPYRIGHT HOLDER
+#
+# Vincent Zweije <zweije@xs4all.nl>, 2006.
+# Eric Spreen <erispre@gmail.com, 2010.
+#
+msgid ""
+msgstr ""
+"Project-Id-Version: mysql-5.5 5.5.23-2\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2012-05-23 10:26+0200\n"
+"Last-Translator: Jeroen Schot <schot@a-eskwadraat.nl>\n"
+"Language-Team: Debian l10n Dutch <debian-l10n-dutch@lists.debian.org>\n"
+"Language: nl\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr "Wilt u echt een oude versie herstellen?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr ""
+"Er bestaat een bestand genaamd /var/lib/mysql/debian-*.flag op dit systeem."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+"Zulk een bestand geeft aan dat er eerder een pakket mysql-server met een "
+"hogere versie is genstalleerd."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+"Er is geen garantie dat de versie die u op dit moment installeert de huidige "
+"databases kan gebruiken."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid "Important note for NIS/YP users"
+msgstr "Belangrijke opmerking voor gebruikers van NIS/YP"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+"Het gebruik van MySQL onder NIS/YP vereist dat een MySQL gebruikersaccount "
+"wordt toegevoegd aan het lokale systeem met:"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr ""
+"U dient ook de permissies en eigenaren van de map /var/lib/mysql te "
+"controleren:"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr "Wilt u alle MySQL-databases verwijderen?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+"De map /var/lib/mysql die de MySQL-databases bevat staat op het punt om "
+"verwijderd te worden."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"Als u het MySQL-pakket verwijdert om later een meer recente versie te "
+"installeren of als een ander mysql-server pakket het al gebruikt, zou de "
+"data behouden moeten worden."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid "Start the MySQL server on boot?"
+msgstr "Moet MySQL starten als de computer start?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"De MySQL-server kan automatisch worden gestart bij het starten van de "
+"computer of slechts wanneer u '/etc/init.d/mysql start' handmatig uitvoert."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr "Nieuw wachtwoord voor de MySQL \"root\"-gebruiker:"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"Hoewel niet verplicht, wordt het sterk aangeraden een wachtwoord in te "
+"stellen voor de administratieve MySQL \"root\"-gebruiker."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "If this field is left blank, the password will not be changed."
+msgstr ""
+"Als dit veld leeg wordt gelaten, zal het wachtwoord niet worden veranderd."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "Herhaal het wachtwoord voor de MySQL \"root\"-gebruiker:"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr "Kan het wachtwoord voor de MySQL \"root\"-gebruiker niet instellen"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"Er is een fout opgetreden bij het instellen van het wachtwoord voor de MySQL "
+"administratieve gebruiker. Dat kan komen doordat de gebruiker al een "
+"wachtwoord heeft, of omdat er een probleem was bij het communiceren met de "
+"MySQL-server."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "You should check the account's password after the package installation."
+msgstr ""
+"U zou het wachtwoord van het account moeten controleren nadat het pakket is "
+"genstalleerd."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+"Leest u het bestand /usr/share/doc/mysql-server-5.5/README.Debian voor meer "
+"informatie."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr "Fout bij invoer wachtwoord"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr ""
+"De twee wachtwoorden die u hebt ingevoerd zijn niet gelijk. Probeert u het "
+"opnieuw."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr "De NDB-cluster lijkt in gebruik te zijn"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+"MySQL-5.5 biedt niet langer ondersteuning voor NDB Cluster. Migreer naar het "
+"nieuwe pakket mysql-cluster en verwijder alle regels die beginnen met \"ndb"
+"\" van alle configuratiebestanden onder /etc/mysql/."
diff -uNr mysql-5.5.60.orig/debian/po/pt.po mysql-5.5.60/debian/po/pt.po
--- mysql-5.5.60.orig/debian/po/pt.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/pt.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,296 @@
+# Portuguese translation for mysql-dfsg-5.5's debconf messages
+# Copyright (C) 2006 Miguel Figueiredo <elmig@debianpt.org>
+# This file is distributed under the same license as the mysql-dfsg-5.5 package.
+# Miguel Figueiredo <elmig@debianpt.org>, 2012
+#
+msgid ""
+msgstr ""
+"Project-Id-Version: mysql-dfsg-5.5\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2012-05-28 22:40+0100\n"
+"Last-Translator: Miguel Figueiredo <elmig@debianpt.org>\n"
+"Language-Team: Portuguese <traduz@debianpt.org>\n"
+"Language: pt\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr "Deseja mesmo fazer downgrade?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr ""
+"Existe, neste sistema, um ficheiro chamado /var/lib/mysql/debian-*.flag."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+"A existncia de tal ficheiro  um indicador que anteriormente foi instalado "
+"um pacote mysql-server com um nmero de verso superior."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+"No existe nenhuma garantia que a verso que est actualmente a instalar "
+"seja capaz de utilizar as bases de dados actuais."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid "Important note for NIS/YP users"
+msgstr "Nota importante para utilizadores de NIS/YP"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+"Utilizar MySQL com NIS/YP necessita que seja adicionada uma conta de "
+"utilizador de mysql ao sistema local com:"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr ""
+"Deve tambm verificar as permisses e o dono do directrio /var/lib/mysql:"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr "Remover todas as bases de dados MySQL?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+"O directrio /var/lib/mysql que contm as bases de dados MySQL est prestes "
+"a ser removido."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"Se est a remover o pacote MySQL de modo a posteriormente instalar uma "
+"verso mais recente ou se um pacote mysql-server j est os est a utilizar, "
+"os dados devem ser mantidos."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid "Start the MySQL server on boot?"
+msgstr "Iniciar o servidor MySQL no arranque?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"O MySQL pode ser automaticamente lanado no arranque ou manualmente atravs "
+"do comando '/etc/init.d/mysql start'."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr "Nova palavra-passe para o utilizador \"root\" do MySQL:"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"Embora no seja obrigatrio,  fortemente recomendado que defina uma palavra-"
+"passe para o utilizador administrativo \"root\" do MySQL."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "If this field is left blank, the password will not be changed."
+msgstr ""
+"Se este campo for deixado em branco, a palavra-passe no ir ser alterada."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "Repita a palavra-passe para o utilizador \"root\" de MySQL:"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr ""
+"No foi possvel definir a palavra-passe para o utilizador \"root\" do MySQL"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"Ocorreu um erro enquanto era definida a palavra-passe para o utilizador "
+"administrativo do MySQL. Isto pode ter acontecido porque a conta j tem uma "
+"palavra-passe, ou porque ocorreu um problema ao comunicao com o servidor "
+"MySQL."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "You should check the account's password after the package installation."
+msgstr ""
+"Voc deve verificar a palavra-passe da conta aps a instalao do pacote."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+"Para mais informaes, por favor leia o ficheiro /usr/share/doc/mysql-"
+"server-5.5/README.Debian."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr "Erro de entrada da palavra-passe"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr ""
+"As duas palavras-passe que introduziu no so as mesmas. Por favor tente "
+"novamente."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr "NDB Cluster parece estar a ser utilizado"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+"MySQL-5.5 j no disponibiliza suporte para NDB Cluster. Por favor migre "
+"para o novo pacote mysql-cluster-server e remova todas as linhas que comecem "
+"por \"ndb\" em todos os ficheiros de configurao em /etc/mysql/."
+
+#~ msgid ""
+#~ "To use MySQL, the following entries for users and groups should be added "
+#~ "to the system:"
+#~ msgstr ""
+#~ "Para utilizar o MySQL, tm de ser acrescentadas as seguintes entradas "
+#~ "para os utilizadores e grupos:"
+
+#~ msgid "Cannot upgrade if ISAM tables are present!"
+#~ msgstr "No  possvel actualizar se estiverem presentes tabelas ISAM!"
+
+#~ msgid ""
+#~ "Recent versions of MySQL can no longer use the old ISAM table format and "
+#~ "it is necessary to convert your tables to e.g. MyISAM before upgrading by "
+#~ "using \"mysql_convert_table_format\" or \"ALTER TABLE x ENGINE=MyISAM\". "
+#~ "The installation of mysql-server-5.5 will now abort. In case your old "
+#~ "mysql-server-4.1 gets removed nevertheless just reinstall it to convert "
+#~ "those tables."
+#~ msgstr ""
+#~ "As verses recentes de MySQL j no podem utilizar o antigo formato de "
+#~ "tabelas ISAM e  por isso necessrio converter as suas tabelas pra e.g. "
+#~ "MyISAM antes da actualizao, utilizando \"mysql_convert_table_format\" "
+#~ "ou \"ALTER TABLE x ENGINE=MyISAM\". A instalao de mysql-server-5.5 ir "
+#~ "agora ser cancelada. Se o seu antigo mysql-server-4.1 for removido apenas "
+#~ "reinstale para converter essas tabelas."
+
+#~ msgid ""
+#~ "Support MySQL connections from hosts running Debian \"sarge\" or older?"
+#~ msgstr ""
+#~ "Suportar ligaes MySQL de mquinas que corram Debian \"sarge\" ou mais "
+#~ "antigos?"
+
+#~ msgid ""
+#~ "In old versions of MySQL clients on Debian, passwords were not stored "
+#~ "securely. This has been improved since then, however clients (such as "
+#~ "PHP) from hosts running Debian 3.1 Sarge will not be able to connect to "
+#~ "recent accounts or accounts whose password have been changed."
+#~ msgstr ""
+#~ "Nas verses antigas de clientes de MySQL em Debian, as palavras-passe no "
+#~ "eram guardadas de forma segura. Isto foi melhorado desde a, no entanto "
+#~ "os clientes (como o PHP) de mquinas que corram Debian 3.1 Sarge no iro "
+#~ "conseguir ligar-se a contas novas ou cuja palavra-passe foi alterada."
+
+#~ msgid ""
+#~ "To use mysql you must install an equivalent user and group to the "
+#~ "following and ensure yourself that /var/lib/mysql has the right "
+#~ "permissions (the uid/gid may be different)."
+#~ msgstr ""
+#~ "Para utilizar mysql e instalar um utilizador e grupo equivalentes para o "
+#~ "seguinte e assegurar-se que /var/lib/mysql tm as permisses correctas (o "
+#~ "uid/gid podem ser diferentes)."
+
+#~ msgid ""
+#~ "/etc/passwd:      mysql:x:100:101:MySQL Server:/var/lib/mysql:/bin/false"
+#~ msgstr ""
+#~ "/etc/passwd:      mysql:x:100:101:MySQL Server:/var/lib/mysql:/bin/false"
+
+#~ msgid "/etc/group:       mysql:x:101:"
+#~ msgstr "/etc/group:       mysql:x:101:"
+
+#~ msgid "/var/lib/mysql:   drwxr-xr-x   mysql    mysql"
+#~ msgstr "/var/lib/mysql:   drwxr-xr-x   mysql    mysql"
+
+#~ msgid "Remove the databases used by all MySQL versions?"
+#~ msgstr "Remover as bases de dados utilizadas por todas as verses de MySQL?"
+
+#~ msgid ""
+#~ "If you do not provide a password no changes will be made to the account."
+#~ msgstr ""
+#~ "Se no disponibilizar uma password no sero feitas alteraes nesta "
+#~ "conta."
+
+#~ msgid ""
+#~ "When installation finishes, you should verify that the account is "
+#~ "properly protected with a password (see README.Debian for more "
+#~ "information)."
+#~ msgstr ""
+#~ "Quando terminar a instalao, deve verificar se a conta est devidamente "
+#~ "protegida com uma password (para mais informaes veja README.Debian)."
diff -uNr mysql-5.5.60.orig/debian/po/pt_BR.po mysql-5.5.60/debian/po/pt_BR.po
--- mysql-5.5.60.orig/debian/po/pt_BR.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/pt_BR.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,443 @@
+# Brazilian Portuguese (pt_BR) debconf template translation for
+# Debian's mysql-dfsg source package.
+# Debian-BR Project <debian-l10n-portuguese@lists.debian.org>
+# Andr Lus Lopes, <andrelop@debian.org> , 2004
+# Andr Lus Lopes, <andrelop@debian.org> , 2006
+# Andr Lus Lopes, <andrelop@debian.org> , 2007
+#
+msgid ""
+msgstr ""
+"Project-Id-Version: mysql-dfsg-5.5\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2007-04-21 15:59-0300\n"
+"Last-Translator: Andr Lus Lopes <andrelop@debian.org>\n"
+"Language-Team: Debian-BR Project <debian-l10n-portuguese@lists.debian.org>\n"
+"Language: \n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+"pt_BR utf-8\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr "Realmente proceder com o rebaixamento de verso?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr "Um arquivo de nome /var/lib/mysql/debian-*.flag existe no sistema."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+#, fuzzy
+#| msgid ""
+#| "Such file is an indication that a mysql-server package with a higher "
+#| "version has been installed earlier."
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+"A presena de um arquivo como este  uma indicao de que um pacote mysql-"
+"server com um nmero de verso mais alto j foi instalado anteriormente."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+"No h garantias de que a verso que voc est instalando no momento "
+"conseguir utilizar as bases de dados existentes."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid "Important note for NIS/YP users"
+msgstr "Aviso importante para usurios NIS/YP"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+#, fuzzy
+#| msgid ""
+#| "You should also check the permissions and the owner of the /var/lib/mysql "
+#| "directory:"
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr ""
+"Voc dever tambm checar as permisses e o dono do diretrio /var/lib/mysql:"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr "Remover todas as bases de dados do MySQL?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+"O diretrio /var/lib/mysql, o qual contm as bases de dados do MySQL, est "
+"prestes a ser removido."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"Caso voc esteja removendo o pacote MySQL para posteriormente instalar uma "
+"verso mais recente ou, caso uma verso diferente do pacote mysql-server "
+"esteja sendo utilizada, os dados devero ser mantidos."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid "Start the MySQL server on boot?"
+msgstr "Iniciar o servidor MySQL junto a inicializao da mquina?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"O servidor MySQL pode ser iniciado automaticamente junto a inicializao da "
+"mquina ou manualmente com o comando '/etc/init.d/mysql start'."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr "Nova senha para o usurio \"root\" do MySQL:"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"Apesar de no ser mandatrio,  altamente recomendado que voc defina uma "
+"senha para o usurio administrativo \"root\" do MySQL."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+#, fuzzy
+#| msgid "If that field is left blank, the password will not be changed."
+msgid "If this field is left blank, the password will not be changed."
+msgstr "Caso este campo seja deixado em branco, a senha no sera mudada."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+#, fuzzy
+#| msgid "New password for the MySQL \"root\" user:"
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "Nova senha para o usurio \"root\" do MySQL:"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr "Impossvel definir senha para o usurio \"root\" do MySQL"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"Um erro ocorreu durante a definio da senha para o usurio administrativo "
+"do MySQL. Isso pode ter acontecido devido a esse usurio j possuir uma "
+"senha definida ou devido a ocorrncia de um problema de comunicao com o "
+"servidor MySQL."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+#, fuzzy
+#| msgid ""
+#| "You should check the account's password after tha package installation."
+msgid "You should check the account's password after the package installation."
+msgstr "Voc dever checar a senha dessa conta aps a instalao deste pacote."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+#, fuzzy
+#| msgid ""
+#| "Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for "
+#| "more information."
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+"Por favor, leia o arquivo /usr/share/doc/mysql-server-5.5/README.Debian para "
+"maiores informaes."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+
+#~ msgid ""
+#~ "To use MySQL, the following entries for users and groups should be added "
+#~ "to the system:"
+#~ msgstr ""
+#~ "Para utilizar o MySQL, as seguintes entradas para usurios e grupos devem "
+#~ "ser adicionadas ao sistema:"
+
+#~ msgid ""
+#~ "Support MySQL connections from hosts running Debian \"sarge\" or older?"
+#~ msgstr ""
+#~ "Suportar conexes MySQL originadas de hosts executando o Debian \"sarge\" "
+#~ "ou mais antigos ?"
+
+#~ msgid ""
+#~ "In old versions of MySQL clients on Debian, passwords were not stored "
+#~ "securely. This has been improved since then, however clients (such as "
+#~ "PHP) from hosts running Debian 3.1 Sarge will not be able to connect to "
+#~ "recent accounts or accounts whose password have been changed."
+#~ msgstr ""
+#~ "Em verses antigas dos clientes MySQL no Debian, as senhas no eram "
+#~ "armazenadas de forma segura. Isto foi corrigido desde ento, porm, "
+#~ "clientes (como o PHP) em hosts executando o Debian 3.1 Sarge no sero "
+#~ "capazes de conectar em contas recentes ou contas as quais as senhas "
+#~ "tenham sido modificadas."
+
+#~ msgid ""
+#~ "To use mysql you must install an equivalent user and group to the "
+#~ "following and ensure yourself that /var/lib/mysql has the right "
+#~ "permissions (the uid/gid may be different)."
+#~ msgstr ""
+#~ "Para utilizar o MySQL, voc deve instalar um usurio e um grupo "
+#~ "equivalentes ao usurio e grupo a seguir para se certificar de que o "
+#~ "diretrio /var/lib/mysql possua as permisses correctas (o uid/gid podem "
+#~ "ser diferentes)."
+
+#~ msgid ""
+#~ "/etc/passwd:      mysql:x:100:101:MySQL Server:/var/lib/mysql:/bin/false"
+#~ msgstr ""
+#~ "/etc/passwd:      mysql:x:100:101:MySQL Server:/var/lib/mysql:/bin/false"
+
+#~ msgid "/etc/group:       mysql:x:101:"
+#~ msgstr "/etc/group:       mysql:x:101:"
+
+#~ msgid "/var/lib/mysql:   drwxr-xr-x   mysql    mysql"
+#~ msgstr "/var/lib/mysql:   drwxr-xr-x   mysql    mysql"
+
+#~ msgid "Remove the databases used by all MySQL versions?"
+#~ msgstr "Remover as bases de dados utilizadas por todas as verses do MySQL?"
+
+#~ msgid ""
+#~ "If you do not provide a password no changes will be made to the account."
+#~ msgstr ""
+#~ "Caso voc no fornea uma senha, nenhuma mudana ser feita na conta."
+
+#~ msgid ""
+#~ "When installation finishes, you should verify that the account is "
+#~ "properly protected with a password (see README.Debian for more "
+#~ "information)."
+#~ msgstr ""
+#~ "Quando a instalao finalizar, voc dever verificar se a conta est "
+#~ "apropriadamente protegida com uma senha (consulte o arquivo README.Debian "
+#~ "para maiores informaes)."
+
+#~ msgid "internal"
+#~ msgstr "interno"
+
+#~ msgid "Only internally used."
+#~ msgstr "Somente utilizado internamente."
+
+#, fuzzy
+#~ msgid "Update Hints"
+#~ msgstr "Dicas de atualizao"
+
+#, fuzzy
+#~ msgid ""
+#~ "Rarely, e.g. on new major versions, the privilege system is improved. To "
+#~ "make use of it mysql_fix_privilege_tables must be executed manually. The "
+#~ "script is not supposed to give any user more rights that he had before,"
+#~ msgstr ""
+#~ "Raramente, por exemplo, em novas verses maiores, o sistema de "
+#~ "privilgios  melhorado. Para fazer uso disso, o script "
+#~ "mysql_fix_privilege_tables deve ser executado manualmente. O script no "
+#~ "atribuir a nenhum usurio mais direitos do que os mesmos j possuam "
+#~ "anteriormente."
+
+#~ msgid "Please also read http://www.mysql.com/doc/en/Upgrade.html"
+#~ msgstr "Por favor, leia http://www.mysql.com/doc/en/Upgrade.html"
+
+#, fuzzy
+#~ msgid "Install Hints"
+#~ msgstr "Dicas de instalao"
+
+#, fuzzy
+#~ msgid ""
+#~ "MySQL will only install if you have a non-numeric hostname that is "
+#~ "resolvable via the /etc/hosts file. E.g. if the \"hostname\" command "
+#~ "returns \"myhostname\" then there must be a line like \"10.0.0.1 "
+#~ "myhostname\"."
+#~ msgstr ""
+#~ "O MySQL ser instalado somente caso voc possua um nome de host NO "
+#~ "NUMRICO que possa ser resolvido atravs do arquivo /etc/hosts, ou seja, "
+#~ "caso o comando \"hostname\" retorne \"myhostname\", uma linha como "
+#~ "\"10.0.0.1 myhostname\" dever existir no arquivo /etc/hosts."
+
+#~ msgid ""
+#~ "A new mysql user \"debian-sys-maint\" will be created. This mysql account "
+#~ "is used in the start/stop and cron scripts. Don't delete."
+#~ msgstr ""
+#~ "Um novo usurio MySQL de nome \"debian-sys-maint\" ser criado. Essa "
+#~ "conta MySQL  utilizada pelos scripts de inicializao/parada e pelos "
+#~ "scripts cron. No remova esse usurio."
+
+#, fuzzy
+#~ msgid ""
+#~ "Please remember to set a PASSWORD for the MySQL root user! If you use a /"
+#~ "root/.my.cnf, always write the \"user\" and the \"password\" lines in "
+#~ "there, never only the password!"
+#~ msgstr ""
+#~ "Por favor, lembre-se de definir uma SENHA para o usurio root do MySQL ! "
+#~ "Caso voc utilize um arquivo /root/.my.cnf, sempre inclua as linhas \"user"
+#~ "\" e \"password\" nesse arquivo, nunca somente a senha ! Consulte o "
+#~ "arquivo /usr/share/doc/mysql-server/README.Debian para mais informaes."
+
+#~ msgid ""
+#~ "Should I remove all databases below /var/lib/mysql as you are purging the "
+#~ "mysql-server package?"
+#~ msgstr ""
+#~ "Todas as base de dados sob o diretrio /var/lib/mysql devem ser removidas "
+#~ "quando voc remover o pacote pacote mysql-server ?"
+
+#~ msgid ""
+#~ "Networking is disabled by default for security reasons. You can enable it "
+#~ "by commenting out the skip-networking option in /etc/mysql/my.cnf."
+#~ msgstr ""
+#~ "O suporte ao funcionamento em rede est desativado por padro por "
+#~ "questes de segurana. Voc poder ativ-lo comentando a opo 'skip-"
+#~ "networking' no arquivo /etc/mysql/my.cnf."
+
+#~ msgid "security and update notice"
+#~ msgstr "aviso de segurana e actualizao"
+
+#~ msgid ""
+#~ "Should I remove everything below /var/lib/mysql when you purge the mysql-"
+#~ "server package with the \"dpkg --purge mysql-server\" command (i.e. "
+#~ "remove everything including the configuration) somewhen? (default is not)"
+#~ msgstr ""
+#~ "Devo remover tudo abaixo de /var/lib/mysql quando fizer o purge do pacote "
+#~ "mysql-server com o comando \"dpkg --purge mysql-server\" (ou seja, "
+#~ "remover tudo inclundo a configurao)? (o padro  no remover)"
+
+#~ msgid "Make MySQL reachable via network?"
+#~ msgstr "Fazer com que o MySQL seja acessvel via rede?"
+
+#~ msgid ""
+#~ "Should MySQL listen on a network reachable TCP port? This is not "
+#~ "necessary for use on a single computer and could be a security problem."
+#~ msgstr ""
+#~ "O MySQL deve aguardar ligaes numa porta TCP acessvel via rede? Isto "
+#~ "no  necessrio para uso num nico computador e pode ser um problema de "
+#~ "segurana."
+
+#~ msgid "Enable chroot mode?"
+#~ msgstr "Activar o modo chroot?"
+
+#~ msgid ""
+#~ "MySQL is able to jail itself into the /var/lib/mysql_jail directory so "
+#~ "that users cannot modify any files outside this directory. This improves "
+#~ "resistence against crackers, too, as they are not able to modify system "
+#~ "files."
+#~ msgstr ""
+#~ "O MySQL  capaz de se prender no diretrio /var/lib/mysql_jail, assim os "
+#~ "utilizadores no podero modificar ficheiros fora deste directrio. Isto "
+#~ "aumenta tambm a resistncia contra crackers, pois eles no podero "
+#~ "modificar arquivos de sistema."
+
+#~ msgid "Please run mysql_fix_privilege_tables !"
+#~ msgstr "Por favor execute mysql_fix_privilege_tables !"
+
+#~ msgid ""
+#~ "I will ensure secure permissions of /var/lib/mysql by replacing GIDs "
+#~ "other than root and mysql with mysql."
+#~ msgstr ""
+#~ "Permisses seguras para o diretrio /var/lib/mysql sero asseguradas "
+#~ "substitundo GIDs diferentes de root e mysql por mysql."
+
+#~ msgid ""
+#~ "Instructions how to enable SSL support are in /usr/share/doc/mysql-server/"
+#~ msgstr ""
+#~ "Instrues sobre como activar o suporte de SSL esto disponveis no "
+#~ "directrio /usr/share/doc/mysql-server/."
+
+#, fuzzy
+#~ msgid "mysql_fix_privileges_tables should be executed"
+#~ msgstr "mysql_fix_privileges_tables ser executado"
+
+#, fuzzy
+#~ msgid ""
+#~ "The latest MySQL versions have an enhanced, more fine grained, privilege "
+#~ "system. To make use of it, some new fields must be added to the tables "
+#~ "in  the \"mysql\" database. This will not happen automatically."
+#~ msgstr ""
+#~ "As ltimas verses do MySQL possuem um sistema de privilgios melhorado e "
+#~ "mais refinado. Para utiliz-lo, alguns novos campos devem ser adicionados "
+#~ "as tabelas na base de dados \"mysql\". Isto  feito pelo script "
+#~ "mysql_fix_privileges_tables durante esta actualizao independente do "
+#~ "servidor estar a correr ou no !"
+
+#~ msgid ""
+#~ "This script is not supposed to give any user more rights that he had "
+#~ "before, if you encounter such a case, please contact me."
+#~ msgstr ""
+#~ "Este script no dever fornecer mais direitos a um utilizador alm dos "
+#~ "quais ele j possua anteriormente. SE encontrar um caso desses, por favor "
+#~ "entre em contacto com o mantainer deste pacote Debian."
diff -uNr mysql-5.5.60.orig/debian/po/ro.po mysql-5.5.60/debian/po/ro.po
--- mysql-5.5.60.orig/debian/po/ro.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/ro.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,319 @@
+# Romanian translation of mysql-dfsg.
+# Copyright (C) 2006 THE mysql-dfsg'S COPYRIGHT HOLDER
+# This file is distributed under the same license as the mysql-dfsg package.
+#
+# Stan Ioan-Eugen <stan.ieugen@gmail.com>, 2006.
+msgid ""
+msgstr ""
+"Project-Id-Version: po-debconf://mysql-dfsg\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2006-12-20 21:27+0200\n"
+"Last-Translator: stan ioan-eugen <stan.ieugen@gmail.com>\n"
+"Language-Team: romanian <debian-l10n-romanian@lists.debian.org>\n"
+"Language: \n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+"X-Generator: KBabel 1.11.4\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+#, fuzzy
+#| msgid "Do you really want to downgrade?"
+msgid "Really proceed with downgrade?"
+msgstr "Suntei sigur c dorii s instalai o versiune mai veche?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+#, fuzzy
+#| msgid ""
+#| "WARNING: The file /var/lib/mysql/debian-*.flag exists. This indicates "
+#| "that a mysql-server package with a higher version has been installed "
+#| "before. It can not be guaranteed that this version can use its data."
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+"AVERTISMENT: Fiierul /var/lib/mysql/debian-*.flag exist. Acest lucru "
+"indic faptul c anterior a fost instalat o versiune nou a pachetului "
+"mysql-server. Nu se poate garanta c versiunea instalat acum poate folosi "
+"datele versiunii instalate anterior."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+#, fuzzy
+#| msgid "Important note for NIS/YP users!"
+msgid "Important note for NIS/YP users"
+msgstr "Not important pentru utilizatorii NIS/YP!"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+#, fuzzy
+#| msgid ""
+#| "The script is about to remove the data directory /var/lib/mysql. If it is "
+#| "planned to just install a higher MySQL version or if a different mysql-"
+#| "server package is already using it, the data should be kept."
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"Scriptul urmeaz s tearg directorul de date /var/lib/mysql. Dac plnuii "
+"doar s instalai o versiune nou MySQL sau datele sunt folosite de ctre un "
+"alt pachet mysql-server, atunci ar trebui pstrai datele."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+#, fuzzy
+#| msgid "Should MySQL start on boot?"
+msgid "Start the MySQL server on boot?"
+msgstr "Dorii ca MySQL s porneasc la initializarea sistemului?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+#, fuzzy
+#| msgid ""
+#| "The MySQL can start automatically on boot time or only if you manually "
+#| "type '/etc/init.d/mysql start'."
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"MySQL poate porni automat la iniializarea sistemului sau doar dac rulai "
+"comanda /etc/init.d/mysql start."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+#, fuzzy
+#| msgid "New password for MySQL \"root\" user:"
+msgid "New password for the MySQL \"root\" user:"
+msgstr "Noua parol pentru utilizatorul root al MySQL:"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+#, fuzzy
+#| msgid ""
+#| "It is highly recommended that you set a password for the MySQL "
+#| "administrative \"root\" user."
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"Este recomandat s stabilii o parol pentru utilizatorul administrativ "
+"root al MySQL."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "If this field is left blank, the password will not be changed."
+msgstr ""
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+#, fuzzy
+#| msgid "New password for MySQL \"root\" user:"
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "Noua parol pentru utilizatorul root al MySQL:"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+#, fuzzy
+#| msgid "Unable to set password for MySQL \"root\" user"
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr "Nu s-a putut stabili parola pentru utilizatorul root al MySQL"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+#, fuzzy
+#| msgid ""
+#| "It seems an error occurred while setting the password for the MySQL "
+#| "administrative user.  This may have happened because the user already has "
+#| "a password, or because there was a problem communicating with the MySQL "
+#| "server."
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"Se pare c a intervenit o eroare n stabilirea parolei pentru utilizatorul "
+"administrativ al MySQL. Acest lucru se poate ntmpla dac utilizatorul are "
+"deja o parol, sau a existat o problem n comunicarea cu serverul MySQL."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "You should check the account's password after the package installation."
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+
+#~ msgid "Cannot upgrade if ISAM tables are present!"
+#~ msgstr "Nu se poate face actualizarea dac sunt prezente tabele ISAM!"
+
+#~ msgid ""
+#~ "Recent versions of MySQL can no longer use the old ISAM table format and "
+#~ "it is necessary to convert your tables to e.g. MyISAM before upgrading by "
+#~ "using \"mysql_convert_table_format\" or \"ALTER TABLE x ENGINE=MyISAM\". "
+#~ "The installation of mysql-server-5.5 will now abort. In case your old "
+#~ "mysql-server-4.1 gets removed nevertheless just reinstall it to convert "
+#~ "those tables."
+#~ msgstr ""
+#~ "Versiunile recente MySQL nu mai pot folosi vechiul format de tabele ISAM "
+#~ "ieste necesar s convertii tabelele dumneavoastr de ex. la formatul "
+#~ "MyISAM nainte de a face actualizarea folosind comanda "
+#~ "mysql_convert_table_format sau ALTER TABLE x ENGINE=MyISAM. "
+#~ "Instalarea mysql-server-5.5 va eua. n caz c tergeiversiunea "
+#~ "anterioar mysql-server-4.1 va trebui reinstalat pentru a converti "
+#~ "tabelele."
+
+#~ msgid ""
+#~ "Support MySQL connections from hosts running Debian \"sarge\" or older?"
+#~ msgstr ""
+#~ "Suportai conexiuni MySQL de la staii ce ruleaz sistemul Debian sarge "
+#~ "sau mai vechi?"
+
+#, fuzzy
+#~| msgid ""
+#~| "The way passwords were stored was not very secure. This has been "
+#~| "improved with the drawback that clients (e.g. PHP) from hosts running "
+#~| "Debian 3.1 Sarge will not be able to connect to account which are new or "
+#~| "whose password have been changed. See /usr/share/doc/mysql-server-5.5/"
+#~| "README.Debian."
+#~ msgid ""
+#~ "In old versions of MySQL clients on Debian, passwords were not stored "
+#~ "securely. This has been improved since then, however clients (such as "
+#~ "PHP) from hosts running Debian 3.1 Sarge will not be able to connect to "
+#~ "recent accounts or accounts whose password have been changed."
+#~ msgstr ""
+#~ "Modul n care erau pstrate parolele nu era foarte sigur. Acest lucru a "
+#~ "fost mbuntitcu dezajantajul c clienii (de ex. PHP) de pe staii ce "
+#~ "ruleaz sistemul Debian 3.1 Sargenu se vor putea conecta la conturi noi "
+#~ "sau ale cror parole au fost schimbate. Citii /usr/share/doc/mysql-"
+#~ "server-5.5/README.Debian."
+
+#~ msgid ""
+#~ "To use mysql you must install an equivalent user and group to the "
+#~ "following and ensure yourself that /var/lib/mysql has the right "
+#~ "permissions (the uid/gid may be different)."
+#~ msgstr ""
+#~ "Pentru a folosi mysql trebuie s adugai un utilizator i grup "
+#~ "echivalent i s v asigurai c /var/lib/mysql are permisiunile "
+#~ "stabilite corect (uid/gid pot aveavalori diferite)."
+
+#~ msgid ""
+#~ "/etc/passwd:      mysql:x:100:101:MySQL Server:/var/lib/mysql:/bin/false"
+#~ msgstr ""
+#~ "/etc/passwd:\tmysql:x:100:101:MySQL Server:/var/lib/mysql:/bin/false"
+
+#~ msgid "/etc/group:       mysql:x:101:"
+#~ msgstr "/etc/group:\tmysql:x:101:"
+
+#~ msgid "/var/lib/mysql:   drwxr-xr-x   mysql    mysql"
+#~ msgstr "/var/lib/mysql:\tdrwxr-xr-x\tmysql\tmysql"
+
+#~ msgid "Remove the databases used by all MySQL versions?"
+#~ msgstr "Dorii s tergei bazele de date folosite de toate versiune MySQL?"
+
+#~ msgid ""
+#~ "If you do not provide a password no changes will be made to the account."
+#~ msgstr ""
+#~ "Dac nu introducei nici o parol, nici o schimbare nu va fi luat n "
+#~ "considerare."
+
+#~ msgid ""
+#~ "When installation finishes, you should verify that the account is "
+#~ "properly protected with a password (see README.Debian for more "
+#~ "information)."
+#~ msgstr ""
+#~ "Dup finalizarea instalrii, ar trebui s verificai dac contul este "
+#~ "protejat cu o parol (citii fiierul README.Debian pentru informaii "
+#~ "suplimentare)."
diff -uNr mysql-5.5.60.orig/debian/po/ru.po mysql-5.5.60/debian/po/ru.po
--- mysql-5.5.60.orig/debian/po/ru.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/ru.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,220 @@
+# translation of ru.po to Russian
+# Russian messages:
+#    Translators, if you are not familiar with the PO format, gettext
+#    documentation is worth reading, especially sections dedicated to
+#    this format, e.g. by running:
+#         info -n '(gettext)PO Files'
+#         info -n '(gettext)Header Entry'#
+#    Some information specific to po-debconf are available at
+#            /usr/share/doc/po-debconf/README-trans
+#         or http://www.debian.org/intl/l10n/po-debconf/README-trans#
+#    Developers do not need to manually edit POT or PO files.
+#
+# Ilgiz Kalmetev <translator@ilgiz.pp.ru>, 2003.
+# Yuriy Talakan' <yt@amur.elektra.ru>, 2005, 2006.
+# Yuriy Talakan' <yt@drsk.ru>, 2007.
+# Yuri Kozlov <yuray@komyakino.ru>, 2009, 2012.
+msgid ""
+msgstr ""
+"Project-Id-Version: mysql-dfsg-5.5 5.5.23-2\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2012-05-23 21:14+0400\n"
+"Last-Translator: Yuri Kozlov <yuray@komyakino.ru>\n"
+"Language-Team: Russian <debian-l10n-russian@lists.debian.org>\n"
+"Language: ru\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+"X-Generator: Lokalize 1.2\n"
+"Plural-Forms:  nplurals=3; plural=(n%10==1 && n%100!=11 ? 0 : n%10>=2 && n"
+"%10<=4 && (n%100<10 || n%100>=20) ? 1 : 2);\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr "    ?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr "    /var/lib/mysql/debian-*.flag."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+" ,       mysql-server   "
+"."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+" ,  ,   ,   "
+"    ."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid "Important note for NIS/YP users"
+msgstr "    NIS/YP"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+" MySQL  NIS/YP     mysql  "
+"  :"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr "       /var/lib/mysql:"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr "    MySQL?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+"    /var/lib/mysql,    MySQL."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"    MySQL      MySQL,  "
+"   mysql-server,   ,    "
+"."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid "Start the MySQL server on boot?"
+msgstr " MySQL   ?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+" MySQL         "
+"  '/etc/init.d/mysql start'."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr "   MySQL  root:"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"  ,       "
+"  MySQL root."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "If this field is left blank, the password will not be changed."
+msgstr "   ,     ."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "    MySQL  root:"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr "   MySQL  root"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"     MySQL   "
+".   ,       ,  "
+"-     MySQL."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "You should check the account's password after the package installation."
+msgstr "      ."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr " .   /usr/share/doc/mysql-server-5.5/README.Debian."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr "  "
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr "    .  ."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr "NDB Cluster  "
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+"MySQL-5.5    NDB Cluster.     "
+"mysql-cluster-server    ,   ndb,   "
+"    /etc/mysql/."
diff -uNr mysql-5.5.60.orig/debian/po/sk.po mysql-5.5.60/debian/po/sk.po
--- mysql-5.5.60.orig/debian/po/sk.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/sk.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,213 @@
+# Slovak translations for mysql-5.1 package
+# Slovensk preklady pre balk mysql-5.1.
+# Copyright (C) 2011 THE mysql-5.1'S COPYRIGHT HOLDER
+# This file is distributed under the same license as the mysql-5.1 package.
+# Slavko <linux@slavino.sk>, 2011, 2012.
+#
+msgid ""
+msgstr ""
+"Project-Id-Version: mysql-5.1 5.1.49-3\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2012-08-12 14:25+0200\n"
+"Last-Translator: Slavko <linux@slavino.sk>\n"
+"Language-Team: slovenina <debian-l10n-slovak@lists.debian.org>\n"
+"Language: sk\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+"Plural-Forms: nplurals=3; plural=(n==1) ? 0 : (n>=2 && n<=4) ? 1 : 2;\n"
+"X-POFile-SpellExtra: YP NDB lib start mysql-cluster-server MySQL share\n"
+"X-POFile-SpellExtra: init mysql-server etc flag MySQL-5 usr mysql README\n"
+"X-POFile-SpellExtra: NIS mysql-server-5 debian- ndb Cluster\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr "Naozaj pokraova v znen verzie?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr "Sbor s menom /var/lib/mysql/debian-*.flag u v systme existuje."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+"Takto sbor udva, e u bol predtm naintalovan balk mysql-server s "
+"vyou verziou."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+"Neexistuje iadna zruka, e aktulne intalovan verzia doke pracova s "
+"existujcimi databzami."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid "Important note for NIS/YP users"
+msgstr "Dleit poznmka pre pouvateov NIS/YP"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+"Pouvanie MySQL pod NIS/YP vyaduje aby bol pouvatesk et mysql "
+"pridan do loklneho systmu pomocou:"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr ""
+"Mali by ste tie skontrolova vlastnctvo a prva k adresru /var/lib/mysql:"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr "Odstrni vetky databzy MySQL?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+"Adresr /var/lib/mysql, ktor obsahuje databzy MySQL, bude odstrnen."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"Ak odstraujete balk MySQL kvli neskorej intalcii najnovej verzie "
+"alebo ak ich pouva aj in balk mysql-server, mali by ste daje ponecha."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid "Start the MySQL server on boot?"
+msgstr "Spa MySQL server pri tarte systmu?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"MySQL server me by automaticky span pri tarte systmu alebo manulne "
+"prkazom /etc/init.d/mysql start."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr "Nov heslo MySQL pouvatea root:"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"Hoci to nie je vyslovene nutn, je silne odporan nastavi heslo "
+"sprvcovskho MySQL tu \"root\"."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "If this field is left blank, the password will not be changed."
+msgstr "Ak toto pole ponechte przdne, heslo nebude zmenen."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "Zopakujte heslo MySQL pouvatea root:"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr "Nemono nastavi heslo MySQL pouvatea root"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"Pri nastavovan hesla sprvcu MySQL nastala chyba. Toto me nasta, ak u "
+"et m nastaven heslo alebo kvli problmom pri komunikcii s MySQL "
+"serverom."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "You should check the account's password after the package installation."
+msgstr "Po intalcii balka by ste mali skontrolova heslo tu."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+"Pretajte si prosm, alie podrobnost v sbore /usr/share/doc/mysql-"
+"server-5.5/README.Debian."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr "Chyba pri zadvan hesla"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr "Hesl, ktor ste zadali sa nezhoduj. Skste prosm znova."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr "Vyzer to, e pouvate NDB Cluster"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+"MySQL-5.5 u neposkytuje podporu NDB Cluster. Pouite prosm nov balk "
+"mysql-cluster-server a zo vetkch konfiguranch sborov v /etc/mysql/ "
+"odstrte vetky riadky, ktor zanaj na ndb."
diff -uNr mysql-5.5.60.orig/debian/po/sv.po mysql-5.5.60/debian/po/sv.po
--- mysql-5.5.60.orig/debian/po/sv.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/sv.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,220 @@
+# Translation of mysql-5.5 debconf template to Swedish
+# Copyright (C) 2009, 2012 Martin Bagge <brother@bsnet.se>
+# This file is distributed under the same license as the mysql-5.5 package.
+# 
+# Andreas Henriksson <andreas@fatal.se>, 2007
+# Martin Bagge <brother@bsnet.se>, 2009, 2012
+msgid ""
+msgstr ""
+"Project-Id-Version: mysql-dfsg-5.5 5.0.21-3\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2012-05-30 00:29+0100\n"
+"Last-Translator: Martin Bagge / brother <brother@bsnet.se>\n"
+"Language-Team: Swedish <debian-l10n-swedish@lists.debian.org>\n"
+"Language: sv\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=utf-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+"X-Poedit-Language: Swedish\n"
+"X-Poedit-Country: Sweden\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr "Vill du verkligen genomfra nedgraderingen?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr "En fil med namnet /var/lib/mysql/debian-*.flag hittades i systemet."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+"En sdan fil r en indikation p att paketet mysql-server med ett hgre "
+"versionsnummer har installerats tidigare."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+"Det finns ingen garanti fr att den version som du hller p att installera "
+"kommer att kunna anvnda de aktuella databaserna."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid "Important note for NIS/YP users"
+msgstr "Viktig information fr NIS/YP-anvndare"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+"Fr att kunna anvnda MySQL under NIS/YP mste ett anvndarkonto fr MySQL "
+"lggas till i systemet."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr ""
+"Du br ocks kontrollera rttigheterna och garen av katalogen /var/lib/"
+"mysql."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr "Ta bort alla MySQL-databaser?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+"Katalogen /var/lib/mysql som innehller MySQL-databaser kommer att tas bort."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"Om avinstallationen av MySQL-paketet grs fr att senare kunna installera en "
+"nyare version eller om en annan MySQL-server redan anvnder filerna ska de "
+"inte raderas."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid "Start the MySQL server on boot?"
+msgstr "Ska MySQL startas vid systemets uppstart?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"MySQL-servern kan startas vid systemets uppstart eller manuellt med "
+"kommandot \"/etc/init.d/mysql start\"."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr "Nytt lsenord fr MySQLs \"root\"-anvndare:"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"Det r inte obligatoriskt men starkt rekommenderat att du stter ett "
+"lsenord fr MySQLs administrativa \"root\"-anvndare."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "If this field is left blank, the password will not be changed."
+msgstr "Om detta flt lmnas tom kommer lsenordet inte att ndras."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "Repetera lsenordet fr MySQLs \"root\"-anvndare:"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr "Kunde inte stta lsenord fr MySQLs \"root\"-anvndare"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"Ett fel uppstod nr det skulle sttas ett lsenord fr MySQLs administrativa "
+"anvndare (\"root\"). Detta kan ha skett fr att anvndaren redan har ett "
+"lsenord satt, eller p grund av problem med att kommunicera med MySQL-"
+"servern."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "You should check the account's password after the package installation."
+msgstr "Du br kontrollera kontots lsenord efter installationen av paketet."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+"Ls filen /usr/share/doc/mysql-server-5.5/README.Debian fr mer information."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr "Fel vid inmatning av lsenord"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr "De tv lsenorden du angav stmde inte verrens. Prova igen."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr "NDB-kluster anvnds inte"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+"Stdet fr NDB-kluster har tagits bort i MySQL-5.5. Migrera till det nya "
+"paketet mysql-cluster-server  och ta bort alla rader som inleds med \"ndb\" "
+"frn alla instlllningsfiler i /etc/mysql/."
+
+#~ msgid ""
+#~ "To use MySQL, the following entries for users and groups should be added "
+#~ "to the system:"
+#~ msgstr ""
+#~ "Fr att anvnda MySQL mste fljande anvndare och grupper lggas till i "
+#~ "systemet:"
diff -uNr mysql-5.5.60.orig/debian/po/templates.pot mysql-5.5.60/debian/po/templates.pot
--- mysql-5.5.60.orig/debian/po/templates.pot	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/templates.pot	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,187 @@
+# SOME DESCRIPTIVE TITLE.
+# Copyright (C) YEAR THE PACKAGE'S COPYRIGHT HOLDER
+# This file is distributed under the same license as the PACKAGE package.
+# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR.
+#
+#, fuzzy
+msgid ""
+msgstr ""
+"Project-Id-Version: PACKAGE VERSION\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
+"Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
+"Language-Team: LANGUAGE <LL@li.org>\n"
+"Language: \n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=CHARSET\n"
+"Content-Transfer-Encoding: 8bit\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid "Important note for NIS/YP users"
+msgstr ""
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid "Start the MySQL server on boot?"
+msgstr ""
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr ""
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "If this field is left blank, the password will not be changed."
+msgstr ""
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "You should check the account's password after the package installation."
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr ""
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
diff -uNr mysql-5.5.60.orig/debian/po/tr.po mysql-5.5.60/debian/po/tr.po
--- mysql-5.5.60.orig/debian/po/tr.po	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/po/tr.po	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,358 @@
+# Turkish translation of mysql-server.
+# This file is distributed under the same license as the mysql-server package.
+# Grkan Aslan <gurkan@iaslan.com>, 2004
+# Atila KO <akoc@artielektronik.com.tr>, 2012.
+#
+msgid ""
+msgstr ""
+"Project-Id-Version: mysql-5.1\n"
+"Report-Msgid-Bugs-To: mysql-5.5@packages.debian.org\n"
+"POT-Creation-Date: 2011-11-08 11:42-0800\n"
+"PO-Revision-Date: 2012-09-17 11:40+0200\n"
+"Last-Translator: Atila KO <akoc@artielektronik.com.tr>\n"
+"Language-Team: Turkish <debian-l10n-turkish@lists.debian.org>\n"
+"Language: tr\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=utf-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "Really proceed with downgrade?"
+msgstr "Srm drme ilemine gerekten balansn m?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid "A file named /var/lib/mysql/debian-*.flag exists on this system."
+msgstr "Bu sistemde /var/lib/mysql/debian-*.flag adl bir dosya bulunmaktadr."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"Such a file is an indication that a mysql-server package with a higher "
+"version has been installed previously."
+msgstr ""
+"Byle bir dosyann varl daha yksek srmde bir mysql-server paketinin "
+"nceden kurulu olduunu gsterir."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:2001
+msgid ""
+"There is no guarantee that the version you're currently installing will be "
+"able to use the current databases."
+msgstr ""
+"Kurmakta olduunuz srmn var olan veritabanlarn kullanabileceinin "
+"garantisi yoktur."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid "Important note for NIS/YP users"
+msgstr "NIS/YP kullanclar iin nemli not"
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"Using MySQL under NIS/YP requires a mysql user account to be added on the "
+"local system with:"
+msgstr ""
+"MySQL'in NIS/YP ile kullanlmas iin yerel sisteme bir mysql kullanc "
+"hesabnn eklenmesi gereklidir."
+
+#. Type: note
+#. Description
+#: ../mysql-server-5.5.templates:3001
+msgid ""
+"You should also check the permissions and ownership of the /var/lib/mysql "
+"directory:"
+msgstr ""
+"/var/lib/mysql dizininin sahiplik ayarlarn ve izin haklarn da gzden "
+"geirmelisiniz."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid "Remove all MySQL databases?"
+msgstr "Tm MySQL veritabanlar kaldrlsn m?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"The /var/lib/mysql directory which contains the MySQL databases is about to "
+"be removed."
+msgstr ""
+"MySQL veritabanlarn barndran /var/lib/mysql dizini kaldrlmak zere"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:4001
+msgid ""
+"If you're removing the MySQL package in order to later install a more recent "
+"version or if a different mysql-server package is already using it, the data "
+"should be kept."
+msgstr ""
+"Eer MySQL paketini daha sonra gncel bir srmn kurmak zere "
+"kaldryorsanz ya da veritabanlarnza baka bir mysql-server paketi ile "
+"eriiyorsanz, veritabanlarnz tutmalsnz."
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid "Start the MySQL server on boot?"
+msgstr "MySQL sunucusu al srasnda balatlsn m?"
+
+#. Type: boolean
+#. Description
+#: ../mysql-server-5.5.templates:5001
+msgid ""
+"The MySQL server can be launched automatically at boot time or manually with "
+"the '/etc/init.d/mysql start' command."
+msgstr ""
+"MySQL sunucusu al srasnda kendiliinden ya da '/etc/init.d/mysql "
+"start' komutu altrlarak elle balatlabilir."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "New password for the MySQL \"root\" user:"
+msgstr "MySQL \"root\" kullancs iin yeni parola:"
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid ""
+"While not mandatory, it is highly recommended that you set a password for "
+"the MySQL administrative \"root\" user."
+msgstr ""
+"Zorunlu olmasa da MySQL ynetimsel \"root\" kullancs iin bir parola "
+"oluturulmas kuvvetle nerilir."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:6001
+msgid "If this field is left blank, the password will not be changed."
+msgstr "Bu alann bo braklmas durumunda parola deitirilmeyecektir."
+
+#. Type: password
+#. Description
+#: ../mysql-server-5.5.templates:7001
+msgid "Repeat password for the MySQL \"root\" user:"
+msgstr "MySQL \"root\" kullancsnn parolasn yineleyin:"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "Unable to set password for the MySQL \"root\" user"
+msgstr "MySQL \"root\" kullancs iin parola oluturulamad"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"An error occurred while setting the password for the MySQL administrative "
+"user. This may have happened because the account already has a password, or "
+"because of a communication problem with the MySQL server."
+msgstr ""
+"MySQL ynetimsel kullancs iin parola oluturulurken bir hata olutu. Bu "
+"hataya ilgili hesabn zaten bir parolas olmas ya da MySQL sunucusu ile "
+"yaanan iletiim sorunlar neden olmu olabilir."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid "You should check the account's password after the package installation."
+msgstr "Paketin kurulumundan sonra ilgili hesabn parolasn denetlemelisiniz."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:8001
+msgid ""
+"Please read the /usr/share/doc/mysql-server-5.5/README.Debian file for more "
+"information."
+msgstr ""
+"Daha fazla bilgi iin ltfen /usr/share/doc/mysql-server-5.5/README.Debian "
+"dosyasn inceleyiniz."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "Password input error"
+msgstr "Parola giri hatas"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:9001
+msgid "The two passwords you entered were not the same. Please try again."
+msgstr "Girdiiniz parolalar elemiyor, ltfen tekrar deneyiniz."
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid "NDB Cluster seems to be in use"
+msgstr "NDB Kmesi kullanlyor gibi grnyor"
+
+#. Type: error
+#. Description
+#: ../mysql-server-5.5.templates:10001
+msgid ""
+"MySQL-5.5 no longer provides NDB Cluster support. Please migrate to the new "
+"mysql-cluster-server package and remove all lines starting with \"ndb\" from "
+"all config files below /etc/mysql/."
+msgstr ""
+"MySQL-5.5 artk NDB Kmesi destei vermemektedir. Ltfen yeni mysql-cluster "
+"paketine geiniz ve /etc/mysql/ dizinindeki tm yaplandrma dosyalarndan "
+"\"ndb\" ile balayan satrlar kaldrnz."
+
+#~ msgid ""
+#~ "To use mysql you must install an equivalent user and group to the "
+#~ "following and ensure yourself that /var/lib/mysql has the right "
+#~ "permissions (the uid/gid may be different)."
+#~ msgstr ""
+#~ "Mysql'i kullanmak iin aadakiyle edeer bir kullanc ve grup "
+#~ "tanmlamal, ve /var/lib/mysql izinlerinin uygun ekilde ayarlandndan "
+#~ "emin olmalsnz (uid/gid farkl olabilir)."
+
+#~ msgid ""
+#~ "/etc/passwd:      mysql:x:100:101:MySQL Server:/var/lib/mysql:/bin/false"
+#~ msgstr ""
+#~ "/etc/passwd:      mysql:x:100:101:MySQL Server:/var/lib/mysql:/bin/false"
+
+#~ msgid "/etc/group:       mysql:x:101:"
+#~ msgstr "/etc/group:       mysql:x:101:"
+
+#~ msgid "/var/lib/mysql:   drwxr-xr-x   mysql    mysql"
+#~ msgstr "/var/lib/mysql:   drwxr-xr-x   mysql    mysql"
+
+#, fuzzy
+#~ msgid "Please also read http://www.mysql.com/doc/en/Upgrade.html"
+#~ msgstr "Ltfen http://www.mysql.com/doc/en/Upgrade.html belgesini okuyun"
+
+#, fuzzy
+#~ msgid ""
+#~ "MySQL will only install if you have a non-numeric hostname that is "
+#~ "resolvable via the /etc/hosts file. E.g. if the \"hostname\" command "
+#~ "returns \"myhostname\" then there must be a line like \"10.0.0.1 "
+#~ "myhostname\"."
+#~ msgstr ""
+#~ "MySQL sadece /etc/hosts dosyas yoluyla zlebilir NUMERK OLMAYAN bir "
+#~ "makine adna sahipseniz kurulacaktr. rnein, eer \"hostname\" komutu "
+#~ "\"makinem\" ismini dndryorsa, bu dosya iinde \"10.0.0.1 makinem\" "
+#~ "gibi bir satr olmaldr."
+
+#, fuzzy
+#~ msgid ""
+#~ "A new mysql user \"debian-sys-maint\" will be created. This mysql account "
+#~ "is used in the start/stop and cron scripts. Don't delete."
+#~ msgstr ""
+#~ "Yeni mysql kullancs \"debian-sys-maint\" yaratlacak. Bu hesap, "
+#~ "balang betiklerinde ve cron iinde kullanlyor. Bu hesab silmeyin."
+
+#, fuzzy
+#~ msgid ""
+#~ "Please remember to set a PASSWORD for the MySQL root user! If you use a /"
+#~ "root/.my.cnf, always write the \"user\" and the \"password\" lines in "
+#~ "there, never only the password!"
+#~ msgstr ""
+#~ "Ltfen MySQL root kullancs iin bir PAROLA girmeyi unutmayn! Eer /"
+#~ "root/.my.cnf kullanyorsanz, \"user\" ve \"password\" satrlarn her "
+#~ "zaman buraya ekleyin, sadece parolay deil! Daha fazla bilgi iin /usr/"
+#~ "share/doc/mysql-server/README.Debian dosyasn okuyun."
+
+#, fuzzy
+#~ msgid ""
+#~ "Should I remove all databases below /var/lib/mysql as you are purging the "
+#~ "mysql-server package?"
+#~ msgstr ""
+#~ "mysql-server paketi kaldrldktan sonra btn veritabanlar silinsin mi?"
+
+#~ msgid ""
+#~ "Networking is disabled by default for security reasons. You can enable it "
+#~ "by commenting out the skip-networking option in /etc/mysql/my.cnf."
+#~ msgstr ""
+#~ "A, ntanml olarak gvenlik gerekeleriyle devre d brakld. Bu "
+#~ "zellii /etc/mysql/my.cnf dosyas iindeki \"skip-networking\" "
+#~ "seeneini kaldrarak etkinletirebilirsiniz."
+
+#~ msgid "security and update notice"
+#~ msgstr "gvenlik ve gncelleme duyurusu"
+
+#~ msgid ""
+#~ "Should I remove everything below /var/lib/mysql when you purge the mysql-"
+#~ "server package with the \"dpkg --purge mysql-server\" command (i.e. "
+#~ "remove everything including the configuration) somewhen? (default is not)"
+#~ msgstr ""
+#~ "mysql-server paketini temizlemek iin \"dpkg --purge mysql-server\" "
+#~ "komutunu kullandnzda (yani yaplandrma dahil hereyi silmek) /var/"
+#~ "lib/mysql altndaki hereyi sileyim mi? (ntanml cevap hayr'dr)."
+
+#~ msgid "Please run mysql_fix_privilege_tables !"
+#~ msgstr "Ltfen mysql_fix_privilege_tables komutunu altrn!"
+
+#~ msgid ""
+#~ "I will ensure secure permissions of /var/lib/mysql by replacing GIDs "
+#~ "other than root and mysql with mysql."
+#~ msgstr ""
+#~ "/var/lib/mysql'in izinlerinin gvenli olmasn salamak amacyla, buna "
+#~ "ait GID'leri root ve mysql'den farkl olacak ekilde deitireceim."
+
+#~ msgid ""
+#~ "Instructions how to enable SSL support are in /usr/share/doc/mysql-server/"
+#~ msgstr ""
+#~ "SSL desteini nasl etkinletirebileceinize ilikin talimatlar /usr/"
+#~ "share/doc/mysql-server/ iinde."
+
+#~ msgid "mysql_fix_privileges_tables will be executed"
+#~ msgstr "mysql_fix_privileges_tables altrlacak"
+
+#~ msgid ""
+#~ "The latest MySQL versions have an enhanced, more fine grained, privilege "
+#~ "system. To make use of it, some new fields must be added to the tables "
+#~ "in  the \"mysql\" database. This is done by the "
+#~ "mysql_fix_privilege_tables script during this upgrade regardless of if "
+#~ "the server is currently running or not!"
+#~ msgstr ""
+#~ "En son MySQL srmleri zenginletirilmi, daha ayrntlandrlm bir "
+#~ "ayrcalk (privilege) sistemine sahiptir. Yeni sistemi kullanmak iin, "
+#~ "\"mysql\" veritabanndaki tablolara baz yeni alanlar eklenmelidir. Bu "
+#~ "ilem, sunucunun alp almamasna bal olmakszn "
+#~ "mysql_fix_privilege_tables betii tarafndan bu ykseltme srasnda "
+#~ "yaplr."
+
+#~ msgid ""
+#~ "This script is not supposed to give any user more rights that he had "
+#~ "before, if you encounter such a case, please contact me."
+#~ msgstr ""
+#~ "Bu betiin hi bir kullancya ncekinden daha fazla hak kazandrmad "
+#~ "varsaylyor. Eer bunun aksinde bir durumla karlarsanz, ltfen "
+#~ "benimle balantya gein."
+
+#~ msgid "Make MySQL reachable via network?"
+#~ msgstr "MySQL network zerinden ulalabilir olsun mu?"
+
+#~ msgid ""
+#~ "Should MySQL listen on a network reachable TCP port? This is not "
+#~ "necessary for use on a single computer and could be a security problem."
+#~ msgstr ""
+#~ "MySQL a zerinde ulalabilen bir TCP portunu dinlesin mi? Tek olan bir "
+#~ "bilgisayar iin bu ayar gerekli deildir ve bir gvenlik sorunu "
+#~ "oluturabilir."
+
+#~ msgid "Enable chroot mode?"
+#~ msgstr "chroot kipi etkinletirilsin mi?"
+
+#~ msgid ""
+#~ "MySQL is able to jail itself into the /var/lib/mysql_jail directory so "
+#~ "that users cannot modify any files outside this directory. This improves "
+#~ "resistence against crackers, too, as they are not able to modify system "
+#~ "files."
+#~ msgstr ""
+#~ "MySQL kendini /var/lib/mysql_jail dizinine hapsederek kullanclarn bu "
+#~ "dizin dndaki hi bir dosyay deitirmemesini salayabilir. Bu "
+#~ "dzenleme, sistem dosyalarn deitirmelerini engelleyeceinden, "
+#~ "cracker'lara kar dayankll arttrr."
diff -uNr mysql-5.5.60.orig/debian/rules mysql-5.5.60/debian/rules
--- mysql-5.5.60.orig/debian/rules	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/rules	2018-12-02 00:04:28.940650910 +0800
@@ -0,0 +1,255 @@
+#!/usr/bin/make -f
+
+export DH_VERBOSE=1
+export DEB_BUILD_HARDENING=1
+
+PACKAGE:=mysql-5.5
+
+TMP:=$(CURDIR)/debian/tmp/
+
+ARCH := $(shell dpkg-architecture -qDEB_BUILD_ARCH)
+ARCH_OS := $(shell dpkg-architecture -qDEB_BUILD_ARCH_OS)
+DEB_BUILD_GNU_TYPE ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)
+DEB_HOST_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
+DEBVERSION := $(shell dpkg-parsechangelog | awk '/^Version: / { print $$2 }' | sed 's/^.*-//' )
+
+ifneq (,$(filter $(ARCH), i386 kfreebsd-i386 hurd-i386))
+    TAOCRYPT_OPT="-DTAOCRYPT_DISABLE_X86ASM"
+endif
+
+export MYSQL_BUILD_CC=$(DEB_HOST_GNU_TYPE)-gcc
+export MYSQL_BUILD_CXX=$(DEB_HOST_GNU_TYPE)-g++
+
+DEB_SOURCE_PACKAGE ?= $(strip $(shell egrep '^Source: ' debian/control | cut -f 2 -d ':'))
+DEB_VERSION ?= $(shell dpkg-parsechangelog | egrep '^Version:' | cut -f 2 -d ' ')
+DEB_NOEPOCH_VERSION ?= $(shell echo $(DEB_VERSION) | cut -d: -f2-)
+DEB_UPSTREAM_VERSION ?= $(shell echo $(DEB_NOEPOCH_VERSION) | sed 's/-[^-]*$$//')
+DEB_UPSTREAM_VERSION_MAJOR_MINOR := $(shell echo $(DEB_UPSTREAM_VERSION) | sed -r -n 's/^([0-9]+\.[0-9]+).*/\1/p')
+DEB_HOST_MULTIARCH ?= $(shell dpkg-architecture -qDEB_HOST_MULTIARCH)
+
+EXPORTED_SOURCE_TARBALL := debian/mysql-source-5.5.tar.gz
+
+DISTRIBUTION := $(shell lsb_release -i -s)
+
+# Parallel build support as adviced
+# at https://www.debian.org/doc/debian-policy/ch-source.html#s-debianrules-options
+ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
+    NUMJOBS = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
+    # Placeholder code to implement max cpu count value checking
+    # if [$(NUMJOBS) > $(shell if [ -f /proc/cpuinfo ] ; then grep -c processor.* /proc/cpuinfo ; else echo 1 ; fi)]
+    #  then NUMJOBS = 0
+    # fi
+    MAKEFLAGS += -j $(NUMJOBS)
+endif
+
+# Add support for verbose builds
+MAKEFLAGS += VERBOSE=1
+
+MAKE_TEST_TARGET:=test-force
+ifneq ($(findstring fulltest,$(DEB_BUILD_OPTIONS)),)
+# make test-bt is the testsuite run by the MySQL build team 
+# before a release, but it is long
+    MAKE_TEST_TARGET:=test-bt
+endif
+ifeq ($(ARCH_OS),hurd)
+# Tests not fully working under Hurd
+# See http://bugs.mysql.com/bug.php?id=64685
+    MAKE_TEST_TARGET:=test
+endif
+
+USE_ASSEMBLER:=--enable-assembler 
+
+ifneq (,$(filter $(ARCH), amd64 i386))
+    TESTSUITE_FAIL_CMD:=exit 1
+else
+    TESTSUITE_FAIL_CMD:=true
+endif
+
+BUILDDIR := builddir
+BUILDDIR_PIC := builddir-pic
+builddir = $(if $(findstring -pic,$@),$(BUILDDIR_PIC),$(BUILDDIR))
+
+# This causes seg11 crashes if LDAP is used for groups in /etc/nsswitch.conf
+# so it is disabled by default although, according to MySQL, it brings >10%
+# performance gain if enabled. See #299382.
+ifeq ($(STATIC_MYSQLD), 1)
+    USE_STATIC_MYSQLD:=--with-mysqld-ldflags=-all-static
+endif
+	
+# See http://blogs.innodb.com/wp/2010/04/innodb-performance-aio-linux/
+# Also #659565
+ifneq (,$(findstring linux-gnu,$(DEB_HOST_GNU_TYPE)))
+    USE_LINUX_NATIVE_AIO:=-DLINUX_NATIVE_AIO=ON
+endif
+
+override_dh_auto_clean: 
+	@echo "RULES.$@"
+	dh_testdir 
+	dh_testroot
+	[ ! -d mysql-test/var ] || rm -rf mysql-test/var
+	rm -rf $(BUILDDIR) $(BUILDDIR_PIC)
+	debconf-updatepo
+	rm -f $(EXPORTED_SOURCE_TARBALL)
+
+override_dh_prep: 
+
+override_dh_auto_configure: configure-stamp configure-pic-stamp
+
+configure-pic-stamp: FORCE_FPIC_CFLAGS=-fPIC
+configure-pic-stamp: FORCE_FPIC=-DWITH_PIC=On
+
+configure-stamp configure-pic-stamp:
+	@echo "RULES.$@"
+	dh_testdir
+	( test -d $(builddir) || mkdir $(builddir) ) && cd $(builddir) && \
+	sh -c  'PATH=$${MYSQL_BUILD_PATH:-"/bin:/usr/bin"} \
+	    	CC=$${MYSQL_BUILD_CC:-gcc} \
+		CFLAGS=$${MYSQL_BUILD_CFLAGS:-"-O2 -DBIG_JOINS=1 ${FORCE_FPIC_CFLAGS} -fno-strict-aliasing ${TAOCRYPT_OPT}"} \
+	    	CXX=$${MYSQL_BUILD_CXX:-g++} \
+	    	CXXFLAGS=$${MYSQL_BUILD_CXXFLAGS:-"-O3 -DBIG_JOINS=1 -felide-constructors -fno-exceptions -fno-rtti ${FORCE_FPIC_CFLAGS} -fno-strict-aliasing ${TAOCRYPT_OPT}"} \
+	    cmake -DCMAKE_INSTALL_PREFIX=/usr \
+		-DCMAKE_VERBOSE_MAKEFILE=ON \
+		$(FORCE_FPIC) \
+		-DMYSQL_UNIX_ADDR=/var/run/mysqld/mysqld.sock \
+	       	-DMYSQL_USER=mysql \
+		-DCMAKE_BUILD_TYPE=RelWithDebInfo \
+		-DWITH_LIBWRAP=ON \
+		-DWITH_READLINE=OFF \
+		-DWITH_LIBEDIT=OFF \
+		$(USE_STATIC_MYSQLD) \
+		-$(MAKEFLAGS) \
+		$(USE_LINUX_NATIVE_AIO) \
+		-DWITH_SSL=bundled \
+		-DWITH_ZLIB=system \
+	    -DCOMPILATION_COMMENT="($(DISTRIBUTION))" \
+	    -DMYSQL_SERVER_SUFFIX="-$(DEBVERSION)" \
+	    -DSYSTEM_TYPE="debian-linux-gnu" \
+	    -DINSTALL_LAYOUT=RPM \
+	    -DINSTALL_LIBDIR=lib/$(DEB_HOST_MULTIARCH) \
+	    -DINSTALL_PLUGINDIR=lib/mysql/plugin \
+        -DWITH_EMBEDDED_SERVER=ON \
+        -DHAVE_EMBEDDED_PRIVILEGE_CONTROL=ON \
+	    -DWITH_ARCHIVE_STORAGE_ENGINE=ON \
+	    -DWITH_BLACKHOLE_STORAGE_ENGINE=ON \
+	    -DWITH_FEDERATED_STORAGE_ENGINE=ON \
+		-DWITH_EXTRA_CHARSETS=all ..'
+	touch $@
+
+
+override_dh_auto_build: build-stamp build-pic-stamp
+
+build-stamp:
+	@echo "RULES.$@"
+	[ -f $(EXPORTED_SOURCE_TARBALL) ] || tar -zcf $(EXPORTED_SOURCE_TARBALL) \
+	--exclude=debian . \
+	--transform="s,^\./,mysql-5.5/,"
+	cd $(builddir) && $(MAKE)
+	touch $@
+
+build-pic-stamp:
+	@echo "RULES.$@"
+	cd $(builddir) && $(MAKE) -C scripts
+	cd $(builddir) && $(MAKE) -C libmysqld
+	touch $@
+
+override_dh_auto_test:
+	@echo "RULES.$@"
+ifeq ($(findstring nocheck,$(DEB_BUILD_OPTIONS)),)
+	cp unittest/unit.pl $(builddir)/unittest/
+	cp -r mysql-test/* $(builddir)/mysql-test/
+	cp -r sql/share/* $(builddir)/sql/share/
+	cp -r scripts/*sql $(builddir)/scripts/
+	cd $(builddir) && $(MAKE)
+endif
+
+override_dh_auto_install: auto_install-stamp
+
+auto_install-stamp:
+	@echo "RULES.$@"
+	dh_testdir
+	dh_testroot
+	dh_prep
+	# some self written manpages which hopefully
+	# gets overwritten sooner or later with upstreams
+	mkdir -p $(TMP)/usr/share/man/man1/
+	mkdir -p $(TMP)/usr/share/man/man8/
+	cp debian/additions/*.1 $(TMP)/usr/share/man/man1/
+	mkdir -p $(TMP)/etc/mysql/conf.d/
+	touch $(TMP)/etc/mysql/conf.d/.keepme
+	cp debian/additions/mysqld_safe_syslog.cnf $(TMP)/etc/mysql/conf.d/
+	# make install (trailing slash needed for innobase)
+	cd $(builddir) && $(MAKE) install DESTDIR=$(TMP)/
+	# After installing, remove rpath to make lintian happy.
+	set +e; \
+	find ./debian/tmp/ -type f -print0 \
+		| xargs -0 --no-run-if-empty chrpath -k 2>/dev/null \
+		| fgrep RPATH= \
+		| cut -d: -f 1 \
+		| xargs --no-run-if-empty chrpath -d; \
+	set -e
+	# libmysqlclient_r is now a symlink to libmysqlclient. But it is
+	# created wrong by the cmake build system and points at
+	# libmysqlclient.so instead of the corresponding versioned lib.
+	for i in `ls $(TMP)/usr/lib/$(DEB_HOST_MULTIARCH)/libmysqlclient.so*` ; do \
+		rlib=`basename $$i | sed -e 's/libmysqlclient\./libmysqlclient_r./'` ;\
+		ln -sf `basename $$i` $(TMP)/usr/lib/$(DEB_HOST_MULTIARCH)/$$rlib ;\
+	done
+	# install libmysqld built with -FPIC
+	install -d -m 0755 -o root -g root $(TMP)/usr/lib/mysql
+	install -m 0644 -o root -g root $(BUILDDIR_PIC)/libmysqld/libmysqld.a $(TMP)/usr/lib/mysql/libmysqld_pic.a
+	# mysql_config won't report the -fPIC, so give libmysqld-pic users a way to get their flags
+	install -m 0755 -o root -g root $(BUILDDIR_PIC)/scripts/mysql_config $(TMP)/usr/bin/mysql_config_pic
+	# mysql-client
+	install -m 0755 debian/additions/mysqlreport $(TMP)/usr/bin/
+	install -m 0755 debian/additions/innotop/innotop $(TMP)/usr/bin/
+	install -m 0644 debian/additions/innotop/innotop.1 $(TMP)/usr/share/man/man1/
+	# mysql-server
+	mkdir -p $(TMP)/usr/share/doc/mysql-server-5.5/examples
+	mv $(TMP)/usr/share/mysql/*cnf 	    $(TMP)/usr/share/doc/mysql-server-5.5/examples/
+	rm -vf $(TMP)/usr/share/mysql/mi_test_all* \
+	       $(TMP)/usr/share/mysql/mysql-log-rotate \
+	       $(TMP)/usr/share/mysql/mysql.server \
+	       $(TMP)/usr/share/mysql/binary-configure
+	nm -n $(BUILDDIR)/sql/mysqld |gzip -9 > $(TMP)/usr/share/doc/mysql-server-5.5/mysqld.sym.gz
+	install -m 0755 debian/additions/echo_stderr $(TMP)/usr/share/mysql/
+	install -m 0755 debian/additions/debian-start $(TMP)/etc/mysql/
+	install -m 0755 debian/additions/debian-start.inc.sh $(TMP)/usr/share/mysql/
+
+	# install AppArmor profile
+	install -D -m 644 debian/apparmor-profile $(TMP)/etc/apparmor.d/usr.sbin.mysqld
+
+	touch $@
+
+override_dh_install:
+	dh_movefiles
+	dh_install
+
+override_dh_installchangelogs:
+	dh_installchangelogs Docs/ChangeLog
+
+override_dh_installlogrotate-arch:
+	dh_installlogrotate --name mysql-server
+	dh_apparmor -pmysql-server-5.5 --profile-name=usr.sbin.mysqld
+
+# Start mysql in runlevel 19 before 20 where apache, proftpd etc gets
+# started which might depend on a running database server.
+override_dh_installinit-arch:
+	dh_installinit --name=mysql -- defaults 19 21
+
+override_dh_installcron-arch:
+	dh_installcron --name mysql-server
+
+override_dh_makeshlibs-arch:
+	dh_makeshlibs -plibmysqlclient18 -V'libmysqlclient18 (>= 5.5.24+dfsg-1)'
+
+override_dh_builddeb:
+	dh_builddeb -- -Zxz
+
+binary:	binary-indep binary-arch
+
+get-orig-source:
+	uscan --force-download --verbose --download-current-version
+
+%:
+	dh $@ --parallel
+
diff -uNr mysql-5.5.60.orig/debian/source/format mysql-5.5.60/debian/source/format
--- mysql-5.5.60.orig/debian/source/format	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/source/format	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1 @@
+3.0 (quilt)
diff -uNr mysql-5.5.60.orig/debian/source.lintian-overrides mysql-5.5.60/debian/source.lintian-overrides
--- mysql-5.5.60.orig/debian/source.lintian-overrides	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/source.lintian-overrides	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,7 @@
+# The mysql-server-5.5.postrm script handles 
+# what debhelper normally would.
+# This is apparently related to #526464.
+maintainer-script-lacks-debhelper-token debian/mysql-server-5.5.postrm
+# Probably best to keep the debhelper version low in
+# case someone needs to backport
+package-needs-versioned-debhelper-build-depends 9
diff -uNr mysql-5.5.60.orig/debian/tests/build mysql-5.5.60/debian/tests/build
--- mysql-5.5.60.orig/debian/tests/build	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/tests/build	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,35 @@
+#!/bin/sh
+# autopkgtest check: Build and run a program against libmysqlclient, to verify that the
+# headers and pkg-config file are installed correctly
+# (C) 2012 Canonical Ltd.
+# Author: Daniel Kessel <d.kessel@gmx.de>
+
+echo "test 'build' starting"
+set -e
+
+WORKDIR=$(mktemp -d)
+trap "rm -rf $WORKDIR" 0 INT QUIT ABRT PIPE TERM
+cd $WORKDIR
+
+cat <<EOF > libmysqltest.c
+#include <stdio.h>
+#include <mysql.h>
+
+int main()
+{
+    if (mysql_library_init(0, NULL, NULL)) {
+        fprintf(stderr, "failed to initialize mysql client library\n");
+	return 1;
+    }
+
+    mysql_library_end();
+    return 0;
+}
+EOF
+
+echo "building..."
+gcc -o libmysqltest libmysqltest.c `/usr/bin/mysql_config --cflags --libs` -Wall -Werror
+echo "build: OK"
+[ -x libmysqltest ]
+./libmysqltest
+echo "run: OK"
diff -uNr mysql-5.5.60.orig/debian/tests/control mysql-5.5.60/debian/tests/control
--- mysql-5.5.60.orig/debian/tests/control	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/tests/control	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,5 @@
+Tests: build
+Depends: libmysqlclient-dev, build-essential
+
+Tests: upstream
+Depends: mysql-testsuite
diff -uNr mysql-5.5.60.orig/debian/tests/upstream mysql-5.5.60/debian/tests/upstream
--- mysql-5.5.60.orig/debian/tests/upstream	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/tests/upstream	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,25 @@
+#!/bin/sh
+# autopkgtest check: Build and run the upstream test suite.
+# (C) 2012 Canonical Ltd.
+# Author: Daniel Kessel <d.kessel@gmx.de>
+
+# running the mysql testsuite as described in:
+# https://bugs.launchpad.net/ubuntu/+source/mysql-5.5/+bug/959683
+
+echo "running test 'testsuite'"
+set -e
+
+WORKDIR=$(mktemp -d)
+trap "rm -rf $WORKDIR" 0 INT QUIT ABRT PIPE TERM
+cd $WORKDIR
+
+mkdir var
+mkdir tmp
+
+echo "using vardir: $WORKDIR/var"
+echo "using tmpdir: $WORKDIR/tmp"
+
+cd /usr/lib/mysql-testsuite
+echo "starting mysql-test-tun.pl..."
+./mysql-test-run.pl --force --vardir=$WORKDIR/var --tmpdir=$WORKDIR/tmp --comment=normal --timer --skip-ndbcluster --report-features 2>&1
+echo "run: OK"
diff -uNr mysql-5.5.60.orig/debian/watch mysql-5.5.60/debian/watch
--- mysql-5.5.60.orig/debian/watch	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/debian/watch	2018-04-19 04:23:37.000000000 +0800
@@ -0,0 +1,6 @@
+# See debian/README.source for more information about the DFSG repacking here.
+version=3
+opts=dversionmangle=s/\+dfsg\d*$// \
+    http://mysql.linux.cz/Downloads/MySQL-5.5/mysql-([\d\.]+).tar.gz
+opts=dversionmangle=s/\+dfsg\d*$// \
+    http://ftp.gwdg.de/pub/misc/mysql/Downloads/MySQL-5.5/mysql-([\d\.]+).tar.gz
diff -uNr mysql-5.5.60.orig/extra/yassl/taocrypt/src/integer.cpp mysql-5.5.60/extra/yassl/taocrypt/src/integer.cpp
--- mysql-5.5.60.orig/extra/yassl/taocrypt/src/integer.cpp	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/extra/yassl/taocrypt/src/integer.cpp	2018-12-02 00:06:23.417892303 +0800
@@ -193,7 +193,7 @@
                 "a" (a), "rm" (b) : "cc");
 
         #elif defined(__mips64)
-            __asm__("dmultu %2,%3" : "=h" (r.halfs_.high), "=l" (r.halfs_.low)
+            __asm__("dmultu %2,%3" : "=d" (r.halfs_.high), "=lc" (r.halfs_.low)
                 : "r" (a), "r" (b));
 
         #elif defined(_M_IX86)
diff -uNr mysql-5.5.60.orig/extra/yassl/taocrypt/src/integer.cpp.orig mysql-5.5.60/extra/yassl/taocrypt/src/integer.cpp.orig
--- mysql-5.5.60.orig/extra/yassl/taocrypt/src/integer.cpp.orig	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/extra/yassl/taocrypt/src/integer.cpp.orig	2018-02-26 21:02:31.000000000 +0800
@@ -0,0 +1,3903 @@
+/*
+   Copyright (c) 2000, 2014, Oracle and/or its affiliates. All rights reserved.
+
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; version 2 of the License.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program; see the file COPYING. If not, write to the
+   Free Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston,
+   MA  02110-1301  USA.
+*/
+
+
+
+/* based on Wei Dai's integer.cpp from CryptoPP */
+
+#include "runtime.hpp"
+#include "integer.hpp"
+#include "modarith.hpp"
+#include "asn.hpp"
+
+
+
+#ifdef __DECCXX
+    #include <c_asm.h>  // for asm overflow assembly
+#endif
+
+#if defined(_M_X64) || defined(_M_IA64)
+    #include <intrin.h> 
+#pragma intrinsic(_umul128)
+#endif
+
+
+#ifdef __GNUC__
+    #include <signal.h>
+    #include <setjmp.h>
+#endif
+
+
+#ifdef SSE2_INTRINSICS_AVAILABLE
+    #ifdef __GNUC__
+        #include <xmmintrin.h>
+        #ifdef TAOCRYPT_MEMALIGN_AVAILABLE
+            #include <malloc.h>
+        #else
+            #include <stdlib.h>
+        #endif
+    #else
+        #include <emmintrin.h>
+    #endif
+#elif defined(_MSC_VER) && defined(_M_IX86)
+/*    #pragma message("You do not seem to have the Visual C++ Processor Pack ")
+    #pragma message("installed, so use of SSE2 intrinsics will be disabled.")
+*/
+#elif defined(__GNUC__) && defined(__i386__)
+/*   #warning You do not have GCC 3.3 or later, or did not specify the -msse2 \
+             compiler option. Use of SSE2 intrinsics will be disabled.
+*/
+#endif
+
+
+namespace TaoCrypt {
+
+
+#ifdef SSE2_INTRINSICS_AVAILABLE
+
+template <class T>
+CPP_TYPENAME AlignedAllocator<T>::pointer AlignedAllocator<T>::allocate(
+                                           size_type n, const void *)
+{
+    if (n > this->max_size())
+        return 0;
+    if (n == 0)
+        return 0;
+    if (n >= 4)
+    {
+        void* p;
+    #ifdef TAOCRYPT_MM_MALLOC_AVAILABLE
+        p = _mm_malloc(sizeof(T)*n, 16);
+    #elif defined(TAOCRYPT_MEMALIGN_AVAILABLE)
+        p = memalign(16, sizeof(T)*n);
+    #elif defined(TAOCRYPT_MALLOC_ALIGNMENT_IS_16)
+        p = malloc(sizeof(T)*n);
+    #else
+        p = (byte *)malloc(sizeof(T)*n + 8);
+        // assume malloc alignment is at least 8
+    #endif
+
+    #ifdef TAOCRYPT_NO_ALIGNED_ALLOC
+        m_pBlock = p;
+        if (!IsAlignedOn(p, 16))
+        {
+            p = (byte *)p + 8;
+        }
+    #endif
+
+        return (T*)p;
+    }
+    return NEW_TC T[n];
+}
+
+
+template <class T>
+void AlignedAllocator<T>::deallocate(void* p, size_type n)
+{
+    memset(p, 0, n*sizeof(T));
+    if (n >= 4)
+    {
+        #ifdef TAOCRYPT_MM_MALLOC_AVAILABLE
+            _mm_free(p);
+        #elif defined(TAOCRYPT_NO_ALIGNED_ALLOC)
+            free(m_pBlock);
+            m_pBlock = 0;
+        #else
+            free(p);
+        #endif
+    }
+    else
+        tcArrayDelete((T *)p);
+}
+
+#endif  // SSE2
+
+
+// ********  start of integer needs
+
+// start 5.2.1 adds DWord and Word ********
+
+// ********************************************************
+
+class DWord {
+public:
+DWord() {}
+
+#ifdef TAOCRYPT_NATIVE_DWORD_AVAILABLE
+    explicit DWord(word low)
+    {
+        whole_ = low;
+    }
+#else
+    explicit DWord(word low)
+    {
+        halfs_.low = low;
+        halfs_.high = 0;
+    }
+#endif
+
+    DWord(word low, word high)
+    {
+        halfs_.low = low;
+        halfs_.high = high;
+    }
+
+    static DWord Multiply(word a, word b)
+    {
+        DWord r;
+
+        #ifdef TAOCRYPT_NATIVE_DWORD_AVAILABLE
+            r.whole_ = (dword)a * b;
+
+        #elif defined(_M_X64) || defined(_M_IA64)
+            r.halfs_.low = _umul128(a, b, &r.halfs_.high);
+
+        #elif defined(__alpha__)
+            r.halfs_.low = a*b;
+            #ifdef __GNUC__
+                __asm__("umulh %1,%2,%0" : "=r" (r.halfs_.high)
+                    : "r" (a), "r" (b));
+            #elif defined(__DECCXX)
+                r.halfs_.high = asm("umulh %a0, %a1, %v0", a, b);
+            #else
+                #error unknown alpha compiler
+            #endif
+
+        #elif defined(__ia64__)
+            r.halfs_.low = a*b;
+            __asm__("xmpy.hu %0=%1,%2" : "=f" (r.halfs_.high)
+                : "f" (a), "f" (b));
+
+        #elif defined(_ARCH_PPC64)
+            r.halfs_.low = a*b;
+            __asm__("mulhdu %0,%1,%2" : "=r" (r.halfs_.high)
+                : "r" (a), "r" (b) : "cc");
+
+        #elif defined(__x86_64__)
+            __asm__("mulq %3" : "=d" (r.halfs_.high), "=a" (r.halfs_.low) :
+                "a" (a), "rm" (b) : "cc");
+
+        #elif defined(__mips64)
+            __asm__("dmultu %2,%3" : "=h" (r.halfs_.high), "=l" (r.halfs_.low)
+                : "r" (a), "r" (b));
+
+        #elif defined(_M_IX86)
+            // for testing
+            word64 t = (word64)a * b;
+            r.halfs_.high = ((word32 *)(&t))[1];
+            r.halfs_.low = (word32)t;
+        #else
+            #error can not implement DWord
+        #endif
+
+        return r;
+    }
+
+    static DWord MultiplyAndAdd(word a, word b, word c)
+    {
+        DWord r = Multiply(a, b);
+        return r += c;
+    }
+
+    DWord & operator+=(word a)
+    {
+        #ifdef TAOCRYPT_NATIVE_DWORD_AVAILABLE
+            whole_ = whole_ + a;
+        #else
+            halfs_.low += a;
+            halfs_.high += (halfs_.low < a);
+        #endif
+        return *this;
+    }
+
+    DWord operator+(word a)
+    {
+        DWord r;
+        #ifdef TAOCRYPT_NATIVE_DWORD_AVAILABLE
+            r.whole_ = whole_ + a;
+        #else
+            r.halfs_.low = halfs_.low + a;
+            r.halfs_.high = halfs_.high + (r.halfs_.low < a);
+        #endif
+        return r;
+    }
+
+    DWord operator-(DWord a)
+    {
+        DWord r;
+        #ifdef TAOCRYPT_NATIVE_DWORD_AVAILABLE
+            r.whole_ = whole_ - a.whole_;
+        #else
+            r.halfs_.low = halfs_.low - a.halfs_.low;
+            r.halfs_.high = halfs_.high - a.halfs_.high -
+                             (r.halfs_.low > halfs_.low);
+        #endif
+        return r;
+    }
+
+    DWord operator-(word a)
+    {
+        DWord r;
+        #ifdef TAOCRYPT_NATIVE_DWORD_AVAILABLE
+            r.whole_ = whole_ - a;
+        #else
+            r.halfs_.low = halfs_.low - a;
+            r.halfs_.high = halfs_.high - (r.halfs_.low > halfs_.low);
+        #endif
+        return r;
+    }
+
+    // returns quotient, which must fit in a word
+    word operator/(word divisor);
+
+    word operator%(word a);
+
+    bool operator!() const
+    {
+    #ifdef TAOCRYPT_NATIVE_DWORD_AVAILABLE
+        return !whole_;
+    #else
+        return !halfs_.high && !halfs_.low;
+    #endif
+    }
+
+    word GetLowHalf() const {return halfs_.low;}
+    word GetHighHalf() const {return halfs_.high;}
+    word GetHighHalfAsBorrow() const {return 0-halfs_.high;}
+
+private:
+    union
+    {
+    #ifdef TAOCRYPT_NATIVE_DWORD_AVAILABLE
+        dword whole_;
+    #endif
+        struct
+        {
+        #ifdef LITTLE_ENDIAN_ORDER
+            word low;
+            word high;
+        #else
+            word high;
+            word low;
+        #endif
+        } halfs_;
+    };
+};
+
+
+class Word {
+public:
+    Word() {}
+
+    Word(word value)
+    {
+        whole_ = value;
+    }
+
+    Word(hword low, hword high)
+    {
+        whole_ = low | (word(high) << (WORD_BITS/2));
+    }
+
+    static Word Multiply(hword a, hword b)
+    {
+        Word r;
+        r.whole_ = (word)a * b;
+        return r;
+    }
+
+    Word operator-(Word a)
+    {
+        Word r;
+        r.whole_ = whole_ - a.whole_;
+        return r;
+    }
+
+    Word operator-(hword a)
+    {
+        Word r;
+        r.whole_ = whole_ - a;
+        return r;
+    }
+
+    // returns quotient, which must fit in a word
+    hword operator/(hword divisor)
+    {
+        return hword(whole_ / divisor);
+    }
+
+    bool operator!() const
+    {
+        return !whole_;
+    }
+
+    word GetWhole() const {return whole_;}
+    hword GetLowHalf() const {return hword(whole_);}
+    hword GetHighHalf() const {return hword(whole_>>(WORD_BITS/2));}
+    hword GetHighHalfAsBorrow() const {return 0-hword(whole_>>(WORD_BITS/2));}
+
+private:
+    word whole_;
+};
+
+
+// dummy is VC60 compiler bug workaround
+// do a 3 word by 2 word divide, returns quotient and leaves remainder in A
+template <class S, class D>
+S DivideThreeWordsByTwo(S* A, S B0, S B1, D* dummy_VC6_WorkAround = 0)
+{
+    // estimate the quotient: do a 2 S by 1 S divide
+    S Q;
+    if (S(B1+1) == 0)
+        Q = A[2];
+    else
+        Q = D(A[1], A[2]) / S(B1+1);
+
+    // now subtract Q*B from A
+    D p = D::Multiply(B0, Q);
+    D u = (D) A[0] - p.GetLowHalf();
+    A[0] = u.GetLowHalf();
+    u = (D) A[1] - p.GetHighHalf() - u.GetHighHalfAsBorrow() - 
+            D::Multiply(B1, Q);
+    A[1] = u.GetLowHalf();
+    A[2] += u.GetHighHalf();
+
+    // Q <= actual quotient, so fix it
+    while (A[2] || A[1] > B1 || (A[1]==B1 && A[0]>=B0))
+    {
+        u = (D) A[0] - B0;
+        A[0] = u.GetLowHalf();
+        u = (D) A[1] - B1 - u.GetHighHalfAsBorrow();
+        A[1] = u.GetLowHalf();
+        A[2] += u.GetHighHalf();
+        Q++;
+    }
+
+    return Q;
+}
+
+
+// do a 4 word by 2 word divide, returns 2 word quotient in Q0 and Q1
+template <class S, class D>
+inline D DivideFourWordsByTwo(S *T, const D &Al, const D &Ah, const D &B)
+{
+    if (!B) // if divisor is 0, we assume divisor==2**(2*WORD_BITS)
+        return D(Ah.GetLowHalf(), Ah.GetHighHalf());
+    else
+    {
+        S Q[2];
+        T[0] = Al.GetLowHalf();
+        T[1] = Al.GetHighHalf(); 
+        T[2] = Ah.GetLowHalf();
+        T[3] = Ah.GetHighHalf();
+        Q[1] = DivideThreeWordsByTwo<S, D>(T+1, B.GetLowHalf(),
+                                                B.GetHighHalf());
+        Q[0] = DivideThreeWordsByTwo<S, D>(T, B.GetLowHalf(), B.GetHighHalf());
+        return D(Q[0], Q[1]);
+    }
+}
+
+
+// returns quotient, which must fit in a word
+inline word DWord::operator/(word a)
+{
+    #ifdef TAOCRYPT_NATIVE_DWORD_AVAILABLE
+        return word(whole_ / a);
+    #else
+        hword r[4];
+        return DivideFourWordsByTwo<hword, Word>(r, halfs_.low,
+                                                    halfs_.high, a).GetWhole();
+    #endif
+}
+
+inline word DWord::operator%(word a)
+{
+    #ifdef TAOCRYPT_NATIVE_DWORD_AVAILABLE
+        return word(whole_ % a);
+    #else
+        if (a < (word(1) << (WORD_BITS/2)))
+        {
+            hword h = hword(a);
+            word r = halfs_.high % h;
+            r = ((halfs_.low >> (WORD_BITS/2)) + (r << (WORD_BITS/2))) % h;
+            return hword((hword(halfs_.low) + (r << (WORD_BITS/2))) % h);
+        }
+        else
+        {
+            hword r[4];
+            DivideFourWordsByTwo<hword, Word>(r, halfs_.low, halfs_.high, a);
+            return Word(r[0], r[1]).GetWhole();
+        }
+    #endif
+}
+
+
+
+// end 5.2.1 DWord and Word adds
+
+
+
+
+
+static const unsigned int RoundupSizeTable[] = {2, 2, 2, 4, 4, 8, 8, 8, 8};
+
+static inline unsigned int RoundupSize(unsigned int n)
+{
+    if (n<=8)
+        return RoundupSizeTable[n];
+    else if (n<=16)
+        return 16;
+    else if (n<=32)
+        return 32;
+    else if (n<=64)
+        return 64;
+    else return 1U << BitPrecision(n-1);
+}
+
+
+static int Compare(const word *A, const word *B, unsigned int N)
+{
+    while (N--)
+        if (A[N] > B[N])
+            return 1;
+        else if (A[N] < B[N])
+            return -1;
+
+    return 0;
+}
+
+static word Increment(word *A, unsigned int N, word B=1)
+{
+    word t = A[0];
+    A[0] = t+B;
+    if (A[0] >= t)
+        return 0;
+    for (unsigned i=1; i<N; i++)
+        if (++A[i])
+            return 0;
+    return 1;
+}
+
+static word Decrement(word *A, unsigned int N, word B=1)
+{
+    word t = A[0];
+    A[0] = t-B;
+    if (A[0] <= t)
+        return 0;
+    for (unsigned i=1; i<N; i++)
+        if (A[i]--)
+            return 0;
+    return 1;
+}
+
+static void TwosComplement(word *A, unsigned int N)
+{
+    Decrement(A, N);
+    for (unsigned i=0; i<N; i++)
+        A[i] = ~A[i];
+}
+
+
+static word LinearMultiply(word *C, const word *A, word B, unsigned int N)
+{
+    word carry=0;
+    for(unsigned i=0; i<N; i++)
+    {
+        DWord p = DWord::MultiplyAndAdd(A[i], B, carry);
+        C[i] = p.GetLowHalf();
+        carry = p.GetHighHalf();
+    }
+    return carry;
+}
+
+
+static word AtomicInverseModPower2(word A)
+{
+    word R=A%8;
+
+    for (unsigned i=3; i<WORD_BITS; i*=2)
+        R = R*(2-R*A);
+
+    return R;
+}
+
+
+// ********************************************************
+
+class Portable
+{
+public:
+    static word TAOCRYPT_CDECL Add(word *C, const word *A, const word *B,
+                                   unsigned int N);
+    static word TAOCRYPT_CDECL Subtract(word *C, const word *A, const word*B,
+                                        unsigned int N);
+    static void TAOCRYPT_CDECL Multiply2(word *C, const word *A, const word *B);
+    static word TAOCRYPT_CDECL Multiply2Add(word *C,
+                                            const word *A, const word *B);
+    static void TAOCRYPT_CDECL Multiply4(word *C, const word *A, const word *B);
+    static void TAOCRYPT_CDECL Multiply8(word *C, const word *A, const word *B);
+    static unsigned int TAOCRYPT_CDECL MultiplyRecursionLimit() {return 8;}
+
+    static void TAOCRYPT_CDECL Multiply2Bottom(word *C, const word *A,
+                                               const word *B);
+    static void TAOCRYPT_CDECL Multiply4Bottom(word *C, const word *A,
+                                               const word *B);
+    static void TAOCRYPT_CDECL Multiply8Bottom(word *C, const word *A,
+                                               const word *B);
+    static unsigned int TAOCRYPT_CDECL MultiplyBottomRecursionLimit(){return 8;}
+
+    static void TAOCRYPT_CDECL Square2(word *R, const word *A);
+    static void TAOCRYPT_CDECL Square4(word *R, const word *A);
+    static unsigned int TAOCRYPT_CDECL SquareRecursionLimit() {return 4;}
+};
+
+word Portable::Add(word *C, const word *A, const word *B, unsigned int N)
+{
+    DWord u(0, 0);
+    for (unsigned int i = 0; i < N; i+=2)
+    {
+        u = DWord(A[i]) + B[i] + u.GetHighHalf();
+        C[i] = u.GetLowHalf();
+        u = DWord(A[i+1]) + B[i+1] + u.GetHighHalf();
+        C[i+1] = u.GetLowHalf();
+    }
+    return u.GetHighHalf();
+}
+
+word Portable::Subtract(word *C, const word *A, const word *B, unsigned int N)
+{
+    DWord u(0, 0);
+    for (unsigned int i = 0; i < N; i+=2)
+    {
+        u = (DWord) A[i] - B[i] - u.GetHighHalfAsBorrow();
+        C[i] = u.GetLowHalf();
+        u = (DWord) A[i+1] - B[i+1] - u.GetHighHalfAsBorrow();
+        C[i+1] = u.GetLowHalf();
+    }
+    return 0-u.GetHighHalf();
+}
+
+void Portable::Multiply2(word *C, const word *A, const word *B)
+{
+/*
+    word s;
+    dword d;
+
+    if (A1 >= A0)
+        if (B0 >= B1)
+        {
+            s = 0;
+            d = (dword)(A1-A0)*(B0-B1);
+        }
+        else
+        {
+            s = (A1-A0);
+            d = (dword)s*(word)(B0-B1);
+        }
+    else
+        if (B0 > B1)
+        {
+            s = (B0-B1);
+            d = (word)(A1-A0)*(dword)s;
+        }
+        else
+        {
+            s = 0;
+            d = (dword)(A0-A1)*(B1-B0);
+        }
+*/
+    // this segment is the branchless equivalent of above
+    word D[4] = {A[1]-A[0], A[0]-A[1], B[0]-B[1], B[1]-B[0]};
+    unsigned int ai = A[1] < A[0];
+    unsigned int bi = B[0] < B[1];
+    unsigned int di = ai & bi;
+    DWord d = DWord::Multiply(D[di], D[di+2]);
+    D[1] = D[3] = 0;
+    unsigned int si = ai + !bi;
+    word s = D[si];
+
+    DWord A0B0 = DWord::Multiply(A[0], B[0]);
+    C[0] = A0B0.GetLowHalf();
+
+    DWord A1B1 = DWord::Multiply(A[1], B[1]);
+    DWord t = (DWord) A0B0.GetHighHalf() + A0B0.GetLowHalf() + d.GetLowHalf()
+                       + A1B1.GetLowHalf();
+    C[1] = t.GetLowHalf();
+
+    t = A1B1 + t.GetHighHalf() + A0B0.GetHighHalf() + d.GetHighHalf()
+             + A1B1.GetHighHalf() - s;
+    C[2] = t.GetLowHalf();
+    C[3] = t.GetHighHalf();
+}
+
+void Portable::Multiply2Bottom(word *C, const word *A, const word *B)
+{
+    DWord t = DWord::Multiply(A[0], B[0]);
+    C[0] = t.GetLowHalf();
+    C[1] = t.GetHighHalf() + A[0]*B[1] + A[1]*B[0];
+}
+
+word Portable::Multiply2Add(word *C, const word *A, const word *B)
+{
+    word D[4] = {A[1]-A[0], A[0]-A[1], B[0]-B[1], B[1]-B[0]};
+    unsigned int ai = A[1] < A[0];
+    unsigned int bi = B[0] < B[1];
+    unsigned int di = ai & bi;
+    DWord d = DWord::Multiply(D[di], D[di+2]);
+    D[1] = D[3] = 0;
+    unsigned int si = ai + !bi;
+    word s = D[si];
+
+    DWord A0B0 = DWord::Multiply(A[0], B[0]);
+    DWord t = A0B0 + C[0];
+    C[0] = t.GetLowHalf();
+
+    DWord A1B1 = DWord::Multiply(A[1], B[1]);
+    t = (DWord) t.GetHighHalf() + A0B0.GetLowHalf() + d.GetLowHalf() +
+        A1B1.GetLowHalf() + C[1];
+    C[1] = t.GetLowHalf();
+
+    t = (DWord) t.GetHighHalf() + A1B1.GetLowHalf() + A0B0.GetHighHalf() +
+        d.GetHighHalf() + A1B1.GetHighHalf() - s + C[2];
+    C[2] = t.GetLowHalf();
+
+    t = (DWord) t.GetHighHalf() + A1B1.GetHighHalf() + C[3];
+    C[3] = t.GetLowHalf();
+    return t.GetHighHalf();
+}
+
+
+#define MulAcc(x, y)                                \
+    p = DWord::MultiplyAndAdd(A[x], B[y], c);       \
+    c = p.GetLowHalf();                             \
+    p = (DWord) d + p.GetHighHalf();                \
+    d = p.GetLowHalf();                             \
+    e += p.GetHighHalf();
+
+#define SaveMulAcc(s, x, y)                         \
+    R[s] = c;                                       \
+    p = DWord::MultiplyAndAdd(A[x], B[y], d);       \
+    c = p.GetLowHalf();                             \
+    p = (DWord) e + p.GetHighHalf();                \
+    d = p.GetLowHalf();                             \
+    e = p.GetHighHalf();
+
+#define SquAcc(x, y)                                \
+    q = DWord::Multiply(A[x], A[y]);                \
+    p = q + c;                                      \
+    c = p.GetLowHalf();                             \
+    p = (DWord) d + p.GetHighHalf();                \
+    d = p.GetLowHalf();                             \
+    e += p.GetHighHalf();                           \
+    p = q + c;                                      \
+    c = p.GetLowHalf();                             \
+    p = (DWord) d + p.GetHighHalf();                \
+    d = p.GetLowHalf();                             \
+    e += p.GetHighHalf();
+
+#define SaveSquAcc(s, x, y)                         \
+    R[s] = c;                                       \
+    q = DWord::Multiply(A[x], A[y]);                \
+    p = q + d;                                      \
+    c = p.GetLowHalf();                             \
+    p = (DWord) e + p.GetHighHalf();                \
+    d = p.GetLowHalf();                             \
+    e = p.GetHighHalf();                            \
+    p = q + c;                                      \
+    c = p.GetLowHalf();                             \
+    p = (DWord) d + p.GetHighHalf();                \
+    d = p.GetLowHalf();                             \
+    e += p.GetHighHalf();
+
+
+void Portable::Multiply4(word *R, const word *A, const word *B)
+{
+    DWord p;
+    word c, d, e;
+
+    p = DWord::Multiply(A[0], B[0]);
+    R[0] = p.GetLowHalf();
+    c = p.GetHighHalf();
+    d = e = 0;
+
+    MulAcc(0, 1);
+    MulAcc(1, 0);
+
+    SaveMulAcc(1, 2, 0);
+    MulAcc(1, 1);
+    MulAcc(0, 2);
+
+    SaveMulAcc(2, 0, 3);
+    MulAcc(1, 2);
+    MulAcc(2, 1);
+    MulAcc(3, 0);
+
+    SaveMulAcc(3, 3, 1);
+    MulAcc(2, 2);
+    MulAcc(1, 3);
+
+    SaveMulAcc(4, 2, 3);
+    MulAcc(3, 2);
+
+    R[5] = c;
+    p = DWord::MultiplyAndAdd(A[3], B[3], d);
+    R[6] = p.GetLowHalf();
+    R[7] = e + p.GetHighHalf();
+}
+
+void Portable::Square2(word *R, const word *A)
+{
+    DWord p, q;
+    word c, d, e;
+
+    p = DWord::Multiply(A[0], A[0]);
+    R[0] = p.GetLowHalf();
+    c = p.GetHighHalf();
+    d = e = 0;
+
+    SquAcc(0, 1);
+
+    R[1] = c;
+    p = DWord::MultiplyAndAdd(A[1], A[1], d);
+    R[2] = p.GetLowHalf();
+    R[3] = e + p.GetHighHalf();
+}
+
+void Portable::Square4(word *R, const word *A)
+{
+#ifdef _MSC_VER
+    // VC60 workaround: MSVC 6.0 has an optimization bug that makes
+    // (dword)A*B where either A or B has been cast to a dword before
+    // very expensive. Revisit this function when this
+    // bug is fixed.
+    Multiply4(R, A, A);
+#else
+    const word *B = A;
+    DWord p, q;
+    word c, d, e;
+
+    p = DWord::Multiply(A[0], A[0]);
+    R[0] = p.GetLowHalf();
+    c = p.GetHighHalf();
+    d = e = 0;
+
+    SquAcc(0, 1);
+
+    SaveSquAcc(1, 2, 0);
+    MulAcc(1, 1);
+
+    SaveSquAcc(2, 0, 3);
+    SquAcc(1, 2);
+
+    SaveSquAcc(3, 3, 1);
+    MulAcc(2, 2);
+
+    SaveSquAcc(4, 2, 3);
+
+    R[5] = c;
+    p = DWord::MultiplyAndAdd(A[3], A[3], d);
+    R[6] = p.GetLowHalf();
+    R[7] = e + p.GetHighHalf();
+#endif
+}
+
+void Portable::Multiply8(word *R, const word *A, const word *B)
+{
+    DWord p;
+    word c, d, e;
+
+    p = DWord::Multiply(A[0], B[0]);
+    R[0] = p.GetLowHalf();
+    c = p.GetHighHalf();
+    d = e = 0;
+
+    MulAcc(0, 1);
+    MulAcc(1, 0);
+
+    SaveMulAcc(1, 2, 0);
+    MulAcc(1, 1);
+    MulAcc(0, 2);
+
+    SaveMulAcc(2, 0, 3);
+    MulAcc(1, 2);
+    MulAcc(2, 1);
+    MulAcc(3, 0);
+
+    SaveMulAcc(3, 0, 4);
+    MulAcc(1, 3);
+    MulAcc(2, 2);
+    MulAcc(3, 1);
+    MulAcc(4, 0);
+
+    SaveMulAcc(4, 0, 5);
+    MulAcc(1, 4);
+    MulAcc(2, 3);
+    MulAcc(3, 2);
+    MulAcc(4, 1);
+    MulAcc(5, 0);
+
+    SaveMulAcc(5, 0, 6);
+    MulAcc(1, 5);
+    MulAcc(2, 4);
+    MulAcc(3, 3);
+    MulAcc(4, 2);
+    MulAcc(5, 1);
+    MulAcc(6, 0);
+
+    SaveMulAcc(6, 0, 7);
+    MulAcc(1, 6);
+    MulAcc(2, 5);
+    MulAcc(3, 4);
+    MulAcc(4, 3);
+    MulAcc(5, 2);
+    MulAcc(6, 1);
+    MulAcc(7, 0);
+
+    SaveMulAcc(7, 1, 7);
+    MulAcc(2, 6);
+    MulAcc(3, 5);
+    MulAcc(4, 4);
+    MulAcc(5, 3);
+    MulAcc(6, 2);
+    MulAcc(7, 1);
+
+    SaveMulAcc(8, 2, 7);
+    MulAcc(3, 6);
+    MulAcc(4, 5);
+    MulAcc(5, 4);
+    MulAcc(6, 3);
+    MulAcc(7, 2);
+
+    SaveMulAcc(9, 3, 7);
+    MulAcc(4, 6);
+    MulAcc(5, 5);
+    MulAcc(6, 4);
+    MulAcc(7, 3);
+
+    SaveMulAcc(10, 4, 7);
+    MulAcc(5, 6);
+    MulAcc(6, 5);
+    MulAcc(7, 4);
+
+    SaveMulAcc(11, 5, 7);
+    MulAcc(6, 6);
+    MulAcc(7, 5);
+
+    SaveMulAcc(12, 6, 7);
+    MulAcc(7, 6);
+
+    R[13] = c;
+    p = DWord::MultiplyAndAdd(A[7], B[7], d);
+    R[14] = p.GetLowHalf();
+    R[15] = e + p.GetHighHalf();
+}
+
+void Portable::Multiply4Bottom(word *R, const word *A, const word *B)
+{
+    DWord p;
+    word c, d, e;
+
+    p = DWord::Multiply(A[0], B[0]);
+    R[0] = p.GetLowHalf();
+    c = p.GetHighHalf();
+    d = e = 0;
+
+    MulAcc(0, 1);
+    MulAcc(1, 0);
+
+    SaveMulAcc(1, 2, 0);
+    MulAcc(1, 1);
+    MulAcc(0, 2);
+
+    R[2] = c;
+    R[3] = d + A[0] * B[3] + A[1] * B[2] + A[2] * B[1] + A[3] * B[0];
+}
+
+void Portable::Multiply8Bottom(word *R, const word *A, const word *B)
+{
+    DWord p;
+    word c, d, e;
+
+    p = DWord::Multiply(A[0], B[0]);
+    R[0] = p.GetLowHalf();
+    c = p.GetHighHalf();
+    d = e = 0;
+
+    MulAcc(0, 1);
+    MulAcc(1, 0);
+
+    SaveMulAcc(1, 2, 0);
+    MulAcc(1, 1);
+    MulAcc(0, 2);
+
+    SaveMulAcc(2, 0, 3);
+    MulAcc(1, 2);
+    MulAcc(2, 1);
+    MulAcc(3, 0);
+
+    SaveMulAcc(3, 0, 4);
+    MulAcc(1, 3);
+    MulAcc(2, 2);
+    MulAcc(3, 1);
+    MulAcc(4, 0);
+
+    SaveMulAcc(4, 0, 5);
+    MulAcc(1, 4);
+    MulAcc(2, 3);
+    MulAcc(3, 2);
+    MulAcc(4, 1);
+    MulAcc(5, 0);
+
+    SaveMulAcc(5, 0, 6);
+    MulAcc(1, 5);
+    MulAcc(2, 4);
+    MulAcc(3, 3);
+    MulAcc(4, 2);
+    MulAcc(5, 1);
+    MulAcc(6, 0);
+
+    R[6] = c;
+    R[7] = d + A[0] * B[7] + A[1] * B[6] + A[2] * B[5] + A[3] * B[4] +
+               A[4] * B[3] + A[5] * B[2] + A[6] * B[1] + A[7] * B[0];
+}
+
+
+#undef MulAcc
+#undef SaveMulAcc
+#undef SquAcc
+#undef SaveSquAcc
+
+// optimized
+
+#ifdef TAOCRYPT_X86ASM_AVAILABLE
+
+// ************** x86 feature detection ***************
+
+
+#ifdef SSE2_INTRINSICS_AVAILABLE
+
+#ifndef _MSC_VER
+    static jmp_buf s_env;
+    static void SigIllHandler(int)
+    {
+        longjmp(s_env, 1);
+    }
+#endif
+
+static bool HasSSE2()
+{
+    if (!IsPentium())
+        return false;
+
+    word32 cpuid[4];
+    CpuId(1, cpuid);
+    if ((cpuid[3] & (1 << 26)) == 0)
+        return false;
+
+#ifdef _MSC_VER
+    __try
+    {
+        __asm xorpd xmm0, xmm0        // executing SSE2 instruction
+    }
+    __except (1)
+    {
+        return false;
+    }
+    return true;
+#else
+    typedef void (*SigHandler)(int);
+
+    SigHandler oldHandler = signal(SIGILL, SigIllHandler);
+    if (oldHandler == SIG_ERR)
+        return false;
+
+    bool result = true;
+    if (setjmp(s_env))
+        result = false;
+    else
+        __asm __volatile ("xorpd %xmm0, %xmm0");
+
+    signal(SIGILL, oldHandler);
+    return result;
+#endif
+}
+#endif // SSE2_INTRINSICS_AVAILABLE
+
+
+static bool IsP4()
+{
+    if (!IsPentium())
+        return false;
+
+    word32 cpuid[4];
+
+    CpuId(1, cpuid);
+    return ((cpuid[0] >> 8) & 0xf) == 0xf;
+}
+
+// ************** Pentium/P4 optimizations ***************
+
+class PentiumOptimized : public Portable
+{
+public:
+    static word TAOCRYPT_CDECL Add(word *C, const word *A, const word *B,
+                                   unsigned int N);
+    static word TAOCRYPT_CDECL Subtract(word *C, const word *A, const word *B,
+                                        unsigned int N);
+    static void TAOCRYPT_CDECL Multiply4(word *C, const word *A,
+                                         const word *B);
+    static void TAOCRYPT_CDECL Multiply8(word *C, const word *A,
+                                         const word *B);
+    static void TAOCRYPT_CDECL Multiply8Bottom(word *C, const word *A,
+                                               const word *B);
+};
+
+class P4Optimized
+{
+public:
+    static word TAOCRYPT_CDECL Add(word *C, const word *A, const word *B,
+                                   unsigned int N);
+    static word TAOCRYPT_CDECL Subtract(word *C, const word *A, const word *B,
+                                        unsigned int N);
+#ifdef SSE2_INTRINSICS_AVAILABLE
+    static void TAOCRYPT_CDECL Multiply4(word *C, const word *A,
+                                         const word *B);
+    static void TAOCRYPT_CDECL Multiply8(word *C, const word *A,
+                                         const word *B);
+    static void TAOCRYPT_CDECL Multiply8Bottom(word *C, const word *A,
+                                               const word *B);
+#endif
+};
+
+typedef word (TAOCRYPT_CDECL * PAddSub)(word *C, const word *A, const word *B,
+                                        unsigned int N);
+typedef void (TAOCRYPT_CDECL * PMul)(word *C, const word *A, const word *B);
+
+static PAddSub s_pAdd, s_pSub;
+#ifdef SSE2_INTRINSICS_AVAILABLE
+static PMul s_pMul4, s_pMul8, s_pMul8B;
+#endif
+
+static void SetPentiumFunctionPointers()
+{
+    if (!IsPentium())
+    {   
+        s_pAdd = &Portable::Add;
+        s_pSub = &Portable::Subtract;
+    }
+    else if (IsP4())
+    {
+        s_pAdd = &P4Optimized::Add;
+        s_pSub = &P4Optimized::Subtract;
+    }
+    else
+    {
+        s_pAdd = &PentiumOptimized::Add;
+        s_pSub = &PentiumOptimized::Subtract;
+    }
+
+#ifdef SSE2_INTRINSICS_AVAILABLE
+    if (!IsPentium()) 
+    {
+        s_pMul4 = &Portable::Multiply4;
+        s_pMul8 = &Portable::Multiply8;
+        s_pMul8B = &Portable::Multiply8Bottom;
+    }
+    else if (HasSSE2())
+    {
+        s_pMul4 = &P4Optimized::Multiply4;
+        s_pMul8 = &P4Optimized::Multiply8;
+        s_pMul8B = &P4Optimized::Multiply8Bottom;
+    }
+    else
+    {
+        s_pMul4 = &PentiumOptimized::Multiply4;
+        s_pMul8 = &PentiumOptimized::Multiply8;
+        s_pMul8B = &PentiumOptimized::Multiply8Bottom;
+    }
+#endif
+}
+
+static const char s_RunAtStartupSetPentiumFunctionPointers =
+    (SetPentiumFunctionPointers(), 0);
+
+
+class LowLevel : public PentiumOptimized
+{
+public:
+    inline static word Add(word *C, const word *A, const word *B,
+                           unsigned int N)
+        {return s_pAdd(C, A, B, N);}
+    inline static word Subtract(word *C, const word *A, const word *B,
+                                unsigned int N)
+        {return s_pSub(C, A, B, N);}
+    inline static void Square4(word *R, const word *A)
+        {Multiply4(R, A, A);}
+#ifdef SSE2_INTRINSICS_AVAILABLE
+    inline static void Multiply4(word *C, const word *A, const word *B)
+        {s_pMul4(C, A, B);}
+    inline static void Multiply8(word *C, const word *A, const word *B)
+        {s_pMul8(C, A, B);}
+    inline static void Multiply8Bottom(word *C, const word *A, const word *B)
+        {s_pMul8B(C, A, B);}
+#endif
+};
+
+// use some tricks to share assembly code between MSVC and GCC
+#ifdef _MSC_VER
+    #define TAOCRYPT_NAKED __declspec(naked)
+    #define AS1(x) __asm x
+    #define AS2(x, y) __asm x, y
+    #define AddPrologue \
+        __asm	push ebp \
+        __asm	push ebx \
+        __asm	push esi \
+        __asm	push edi \
+        __asm	mov		ecx, [esp+20] \
+        __asm	mov		edx, [esp+24] \
+        __asm	mov		ebx, [esp+28] \
+        __asm	mov		esi, [esp+32]
+    #define AddEpilogue \
+        __asm	pop edi \
+        __asm	pop esi \
+        __asm	pop ebx \
+        __asm	pop ebp \
+        __asm	ret
+    #define MulPrologue \
+        __asm	push ebp \
+        __asm	push ebx \
+        __asm	push esi \
+        __asm	push edi \
+        __asm	mov ecx, [esp+28] \
+        __asm	mov esi, [esp+24] \
+        __asm	push [esp+20]
+    #define MulEpilogue \
+        __asm	add esp, 4 \
+        __asm	pop edi \
+        __asm	pop esi \
+        __asm	pop ebx \
+        __asm	pop ebp \
+        __asm	ret
+#else
+    #define TAOCRYPT_NAKED
+    #define AS1(x) #x ";"
+    #define AS2(x, y) #x ", " #y ";"
+    #define AddPrologue \
+        __asm__ __volatile__ \
+        ( \
+            "push %%ebx;"	/* save this manually, in case of -fPIC */ \
+            "mov %2, %%ebx;" \
+            ".intel_syntax noprefix;" \
+            "push ebp;"
+    #define AddEpilogue \
+            "pop ebp;" \
+            ".att_syntax prefix;" \
+            "pop %%ebx;" \
+                    : \
+                    : "c" (C), "d" (A), "m" (B), "S" (N) \
+                    : "%edi", "memory", "cc" \
+        );
+    #define MulPrologue \
+        __asm__ __volatile__ \
+        ( \
+            "push %%ebx;"	/* save this manually, in case of -fPIC */ \
+            "push %%ebp;" \
+            "push %0;" \
+            ".intel_syntax noprefix;"
+    #define MulEpilogue \
+            "add esp, 4;" \
+            "pop ebp;" \
+            "pop ebx;" \
+            ".att_syntax prefix;" \
+            : \
+            : "rm" (Z), "S" (X), "c" (Y) \
+            : "%eax", "%edx", "%edi", "memory", "cc" \
+        );
+#endif
+
+TAOCRYPT_NAKED word PentiumOptimized::Add(word *C, const word *A,
+                                          const word *B, unsigned int N)
+{
+    AddPrologue
+
+    // now: ebx = B, ecx = C, edx = A, esi = N
+    AS2(    sub ecx, edx)           // hold the distance between C & A so we
+                                    // can add this to A to get C
+    AS2(    xor eax, eax)           // clear eax
+
+    AS2(    sub eax, esi)           // eax is a negative index from end of B
+    AS2(    lea ebx, [ebx+4*esi])   // ebx is end of B
+
+    AS2(    sar eax, 1)             // unit of eax is now dwords; this also
+                                    // clears the carry flag
+    AS1(    jz  loopendAdd)         // if no dwords then nothing to do
+
+    AS1(loopstartAdd:)
+    AS2(    mov    esi,[edx])           // load lower word of A
+    AS2(    mov    ebp,[edx+4])         // load higher word of A
+
+    AS2(    mov    edi,[ebx+8*eax])     // load lower word of B
+    AS2(    lea    edx,[edx+8])         // advance A and C
+
+    AS2(    adc    esi,edi)             // add lower words
+    AS2(    mov    edi,[ebx+8*eax+4])   // load higher word of B
+
+    AS2(    adc    ebp,edi)             // add higher words
+    AS1(    inc    eax)                 // advance B
+
+    AS2(    mov    [edx+ecx-8],esi)     // store lower word result
+    AS2(    mov    [edx+ecx-4],ebp)     // store higher word result
+
+    AS1(    jnz    loopstartAdd)   // loop until eax overflows and becomes zero
+
+    AS1(loopendAdd:)
+    AS2(    adc eax, 0)     // store carry into eax (return result register)
+
+    AddEpilogue
+}
+
+TAOCRYPT_NAKED word PentiumOptimized::Subtract(word *C, const word *A,
+                                               const word *B, unsigned int N)
+{
+    AddPrologue
+
+    // now: ebx = B, ecx = C, edx = A, esi = N
+    AS2(    sub ecx, edx)           // hold the distance between C & A so we
+                                    // can add this to A to get C
+    AS2(    xor eax, eax)           // clear eax
+
+    AS2(    sub eax, esi)           // eax is a negative index from end of B
+    AS2(    lea ebx, [ebx+4*esi])   // ebx is end of B
+
+    AS2(    sar eax, 1)             // unit of eax is now dwords; this also
+                                    // clears the carry flag
+    AS1(    jz  loopendSub)         // if no dwords then nothing to do
+
+    AS1(loopstartSub:)
+    AS2(    mov    esi,[edx])           // load lower word of A
+    AS2(    mov    ebp,[edx+4])         // load higher word of A
+
+    AS2(    mov    edi,[ebx+8*eax])     // load lower word of B
+    AS2(    lea    edx,[edx+8])         // advance A and C
+
+    AS2(    sbb    esi,edi)             // subtract lower words
+    AS2(    mov    edi,[ebx+8*eax+4])   // load higher word of B
+
+    AS2(    sbb    ebp,edi)             // subtract higher words
+    AS1(    inc    eax)                 // advance B
+
+    AS2(    mov    [edx+ecx-8],esi)     // store lower word result
+    AS2(    mov    [edx+ecx-4],ebp)     // store higher word result
+
+    AS1(    jnz    loopstartSub)   // loop until eax overflows and becomes zero
+
+    AS1(loopendSub:)
+    AS2(    adc eax, 0)     // store carry into eax (return result register)
+
+    AddEpilogue
+}
+
+// On Pentium 4, the adc and sbb instructions are very expensive, so avoid them.
+
+TAOCRYPT_NAKED word P4Optimized::Add(word *C, const word *A, const word *B,
+                                     unsigned int N)
+{
+    AddPrologue
+
+    // now: ebx = B, ecx = C, edx = A, esi = N
+    AS2(    xor     eax, eax)
+    AS1(    neg     esi)
+    AS1(    jz      loopendAddP4)       // if no dwords then nothing to do
+
+    AS2(    mov     edi, [edx])
+    AS2(    mov     ebp, [ebx])
+    AS1(    jmp     carry1AddP4)
+
+    AS1(loopstartAddP4:)
+    AS2(    mov     edi, [edx+8])
+    AS2(    add     ecx, 8)
+    AS2(    add     edx, 8)
+    AS2(    mov     ebp, [ebx])
+    AS2(    add     edi, eax)
+    AS1(    jc      carry1AddP4)
+    AS2(    xor     eax, eax)
+
+    AS1(carry1AddP4:)
+    AS2(    add     edi, ebp)
+    AS2(    mov     ebp, 1)
+    AS2(    mov     [ecx], edi)
+    AS2(    mov     edi, [edx+4])
+    AS2(    cmovc   eax, ebp)
+    AS2(    mov     ebp, [ebx+4])
+    AS2(    add     ebx, 8)
+    AS2(    add     edi, eax)
+    AS1(    jc      carry2AddP4)
+    AS2(    xor     eax, eax)
+
+    AS1(carry2AddP4:)
+    AS2(    add     edi, ebp)
+    AS2(    mov     ebp, 1)
+    AS2(    cmovc   eax, ebp)
+    AS2(    mov     [ecx+4], edi)
+    AS2(    add     esi, 2)
+    AS1(    jnz     loopstartAddP4)
+
+    AS1(loopendAddP4:)
+
+    AddEpilogue
+}
+
+TAOCRYPT_NAKED word P4Optimized::Subtract(word *C, const word *A,
+                                          const word *B, unsigned int N)
+{
+    AddPrologue
+
+    // now: ebx = B, ecx = C, edx = A, esi = N
+    AS2(    xor     eax, eax)
+    AS1(    neg     esi)
+    AS1(    jz      loopendSubP4)       // if no dwords then nothing to do
+
+    AS2(    mov     edi, [edx])
+    AS2(    mov     ebp, [ebx])
+    AS1(    jmp     carry1SubP4)
+
+    AS1(loopstartSubP4:)
+    AS2(    mov     edi, [edx+8])
+    AS2(    add     edx, 8)
+    AS2(    add     ecx, 8)
+    AS2(    mov     ebp, [ebx])
+    AS2(    sub     edi, eax)
+    AS1(    jc      carry1SubP4)
+    AS2(    xor     eax, eax)
+
+    AS1(carry1SubP4:)
+    AS2(    sub     edi, ebp)
+    AS2(    mov     ebp, 1)
+    AS2(    mov     [ecx], edi)
+    AS2(    mov     edi, [edx+4])
+    AS2(    cmovc   eax, ebp)
+    AS2(    mov     ebp, [ebx+4])
+    AS2(    add     ebx, 8)
+    AS2(    sub     edi, eax)
+    AS1(    jc      carry2SubP4)
+    AS2(    xor     eax, eax)
+
+    AS1(carry2SubP4:)
+    AS2(    sub     edi, ebp)
+    AS2(    mov     ebp, 1)
+    AS2(    cmovc   eax, ebp)
+    AS2(    mov     [ecx+4], edi)
+    AS2(    add     esi, 2)
+    AS1(    jnz     loopstartSubP4)
+
+    AS1(loopendSubP4:)
+
+    AddEpilogue
+}
+
+// multiply assembly code originally contributed by Leonard Janke
+
+#define MulStartup \
+    AS2(xor ebp, ebp) \
+    AS2(xor edi, edi) \
+    AS2(xor ebx, ebx) 
+
+#define MulShiftCarry \
+    AS2(mov ebp, edx) \
+    AS2(mov edi, ebx) \
+    AS2(xor ebx, ebx)
+
+#define MulAccumulateBottom(i,j) \
+    AS2(mov eax, [ecx+4*j]) \
+    AS2(imul eax, dword ptr [esi+4*i]) \
+    AS2(add ebp, eax)
+
+#define MulAccumulate(i,j) \
+    AS2(mov eax, [ecx+4*j]) \
+    AS1(mul dword ptr [esi+4*i]) \
+    AS2(add ebp, eax) \
+    AS2(adc edi, edx) \
+    AS2(adc bl, bh)
+
+#define MulStoreDigit(i)  \
+    AS2(mov edx, edi) \
+    AS2(mov edi, [esp]) \
+    AS2(mov [edi+4*i], ebp)
+
+#define MulLastDiagonal(digits) \
+    AS2(mov eax, [ecx+4*(digits-1)]) \
+    AS1(mul dword ptr [esi+4*(digits-1)]) \
+    AS2(add ebp, eax) \
+    AS2(adc edx, edi) \
+    AS2(mov edi, [esp]) \
+    AS2(mov [edi+4*(2*digits-2)], ebp) \
+    AS2(mov [edi+4*(2*digits-1)], edx)
+
+TAOCRYPT_NAKED void PentiumOptimized::Multiply4(word* Z, const word* X,
+                                                const word* Y)
+{
+    MulPrologue
+    // now: [esp] = Z, esi = X, ecx = Y
+    MulStartup
+    MulAccumulate(0,0)
+    MulStoreDigit(0)
+    MulShiftCarry
+
+    MulAccumulate(1,0)
+    MulAccumulate(0,1)
+    MulStoreDigit(1)
+    MulShiftCarry
+
+    MulAccumulate(2,0)
+    MulAccumulate(1,1)
+    MulAccumulate(0,2)
+    MulStoreDigit(2)
+    MulShiftCarry
+
+    MulAccumulate(3,0)
+    MulAccumulate(2,1)
+    MulAccumulate(1,2)
+    MulAccumulate(0,3)
+    MulStoreDigit(3)
+    MulShiftCarry
+
+    MulAccumulate(3,1)
+    MulAccumulate(2,2)
+    MulAccumulate(1,3)
+    MulStoreDigit(4)
+    MulShiftCarry
+
+    MulAccumulate(3,2)
+    MulAccumulate(2,3)
+    MulStoreDigit(5)
+    MulShiftCarry
+
+    MulLastDiagonal(4)
+    MulEpilogue
+}
+
+TAOCRYPT_NAKED void PentiumOptimized::Multiply8(word* Z, const word* X,
+                                                const word* Y)
+{
+    MulPrologue
+    // now: [esp] = Z, esi = X, ecx = Y
+    MulStartup
+    MulAccumulate(0,0)
+    MulStoreDigit(0)
+    MulShiftCarry
+
+    MulAccumulate(1,0)
+    MulAccumulate(0,1)
+    MulStoreDigit(1)
+    MulShiftCarry
+
+    MulAccumulate(2,0)
+    MulAccumulate(1,1)
+    MulAccumulate(0,2)
+    MulStoreDigit(2)
+    MulShiftCarry
+
+    MulAccumulate(3,0)
+    MulAccumulate(2,1)
+    MulAccumulate(1,2)
+    MulAccumulate(0,3)
+    MulStoreDigit(3)
+    MulShiftCarry
+
+    MulAccumulate(4,0)
+    MulAccumulate(3,1)
+    MulAccumulate(2,2)
+    MulAccumulate(1,3)
+    MulAccumulate(0,4)
+    MulStoreDigit(4)
+    MulShiftCarry
+
+    MulAccumulate(5,0)
+    MulAccumulate(4,1)
+    MulAccumulate(3,2)
+    MulAccumulate(2,3)
+    MulAccumulate(1,4)
+    MulAccumulate(0,5)
+    MulStoreDigit(5)
+    MulShiftCarry
+
+    MulAccumulate(6,0)
+    MulAccumulate(5,1)
+    MulAccumulate(4,2)
+    MulAccumulate(3,3)
+    MulAccumulate(2,4)
+    MulAccumulate(1,5)
+    MulAccumulate(0,6)
+    MulStoreDigit(6)
+    MulShiftCarry
+
+    MulAccumulate(7,0)
+    MulAccumulate(6,1)
+    MulAccumulate(5,2)
+    MulAccumulate(4,3)
+    MulAccumulate(3,4)
+    MulAccumulate(2,5)
+    MulAccumulate(1,6)
+    MulAccumulate(0,7)
+    MulStoreDigit(7)
+    MulShiftCarry
+
+    MulAccumulate(7,1)
+    MulAccumulate(6,2)
+    MulAccumulate(5,3)
+    MulAccumulate(4,4)
+    MulAccumulate(3,5)
+    MulAccumulate(2,6)
+    MulAccumulate(1,7)
+    MulStoreDigit(8)
+    MulShiftCarry
+
+    MulAccumulate(7,2)
+    MulAccumulate(6,3)
+    MulAccumulate(5,4)
+    MulAccumulate(4,5)
+    MulAccumulate(3,6)
+    MulAccumulate(2,7)
+    MulStoreDigit(9)
+    MulShiftCarry
+
+    MulAccumulate(7,3)
+    MulAccumulate(6,4)
+    MulAccumulate(5,5)
+    MulAccumulate(4,6)
+    MulAccumulate(3,7)
+    MulStoreDigit(10)
+    MulShiftCarry
+
+    MulAccumulate(7,4)
+    MulAccumulate(6,5)
+    MulAccumulate(5,6)
+    MulAccumulate(4,7)
+    MulStoreDigit(11)
+    MulShiftCarry
+
+    MulAccumulate(7,5)
+    MulAccumulate(6,6)
+    MulAccumulate(5,7)
+    MulStoreDigit(12)
+    MulShiftCarry
+
+    MulAccumulate(7,6)
+    MulAccumulate(6,7)
+    MulStoreDigit(13)
+    MulShiftCarry
+
+    MulLastDiagonal(8)
+    MulEpilogue
+}
+
+TAOCRYPT_NAKED void PentiumOptimized::Multiply8Bottom(word* Z, const word* X,
+                                                      const word* Y)
+{
+    MulPrologue
+    // now: [esp] = Z, esi = X, ecx = Y
+    MulStartup
+    MulAccumulate(0,0)
+    MulStoreDigit(0)
+    MulShiftCarry
+
+    MulAccumulate(1,0)
+    MulAccumulate(0,1)
+    MulStoreDigit(1)
+    MulShiftCarry
+
+    MulAccumulate(2,0)
+    MulAccumulate(1,1)
+    MulAccumulate(0,2)
+    MulStoreDigit(2)
+    MulShiftCarry
+
+    MulAccumulate(3,0)
+    MulAccumulate(2,1)
+    MulAccumulate(1,2)
+    MulAccumulate(0,3)
+    MulStoreDigit(3)
+    MulShiftCarry
+
+    MulAccumulate(4,0)
+    MulAccumulate(3,1)
+    MulAccumulate(2,2)
+    MulAccumulate(1,3)
+    MulAccumulate(0,4)
+    MulStoreDigit(4)
+    MulShiftCarry
+
+    MulAccumulate(5,0)
+    MulAccumulate(4,1)
+    MulAccumulate(3,2)
+    MulAccumulate(2,3)
+    MulAccumulate(1,4)
+    MulAccumulate(0,5)
+    MulStoreDigit(5)
+    MulShiftCarry
+
+    MulAccumulate(6,0)
+    MulAccumulate(5,1)
+    MulAccumulate(4,2)
+    MulAccumulate(3,3)
+    MulAccumulate(2,4)
+    MulAccumulate(1,5)
+    MulAccumulate(0,6)
+    MulStoreDigit(6)
+    MulShiftCarry
+
+    MulAccumulateBottom(7,0)
+    MulAccumulateBottom(6,1)
+    MulAccumulateBottom(5,2)
+    MulAccumulateBottom(4,3)
+    MulAccumulateBottom(3,4)
+    MulAccumulateBottom(2,5)
+    MulAccumulateBottom(1,6)
+    MulAccumulateBottom(0,7)
+    MulStoreDigit(7)
+    MulEpilogue
+}
+
+#undef AS1
+#undef AS2
+
+#else	// not x86 - no processor specific code at this layer
+
+typedef Portable LowLevel;
+
+#endif
+
+#ifdef SSE2_INTRINSICS_AVAILABLE
+
+#ifdef __GNUC__
+#define TAOCRYPT_FASTCALL
+#else
+#define TAOCRYPT_FASTCALL __fastcall
+#endif
+
+static void TAOCRYPT_FASTCALL P4_Mul(__m128i *C, const __m128i *A,
+                                     const __m128i *B)
+{
+    __m128i a3210 = _mm_load_si128(A);
+    __m128i b3210 = _mm_load_si128(B);
+
+    __m128i sum;
+
+    __m128i z = _mm_setzero_si128();
+    __m128i a2b2_a0b0 = _mm_mul_epu32(a3210, b3210);
+    C[0] = a2b2_a0b0;
+
+    __m128i a3120 = _mm_shuffle_epi32(a3210, _MM_SHUFFLE(3, 1, 2, 0));
+    __m128i b3021 = _mm_shuffle_epi32(b3210, _MM_SHUFFLE(3, 0, 2, 1));
+    __m128i a1b0_a0b1 = _mm_mul_epu32(a3120, b3021);
+    __m128i a1b0 = _mm_unpackhi_epi32(a1b0_a0b1, z);
+    __m128i a0b1 = _mm_unpacklo_epi32(a1b0_a0b1, z);
+    C[1] = _mm_add_epi64(a1b0, a0b1);
+
+    __m128i a31 = _mm_srli_epi64(a3210, 32);
+    __m128i b31 = _mm_srli_epi64(b3210, 32);
+    __m128i a3b3_a1b1 = _mm_mul_epu32(a31, b31);
+    C[6] = a3b3_a1b1;
+
+    __m128i a1b1 = _mm_unpacklo_epi32(a3b3_a1b1, z);
+    __m128i b3012 = _mm_shuffle_epi32(b3210, _MM_SHUFFLE(3, 0, 1, 2));
+    __m128i a2b0_a0b2 = _mm_mul_epu32(a3210, b3012);
+    __m128i a0b2 = _mm_unpacklo_epi32(a2b0_a0b2, z);
+    __m128i a2b0 = _mm_unpackhi_epi32(a2b0_a0b2, z);
+    sum = _mm_add_epi64(a1b1, a0b2);
+    C[2] = _mm_add_epi64(sum, a2b0);
+
+    __m128i a2301 = _mm_shuffle_epi32(a3210, _MM_SHUFFLE(2, 3, 0, 1));
+    __m128i b2103 = _mm_shuffle_epi32(b3210, _MM_SHUFFLE(2, 1, 0, 3));
+    __m128i a3b0_a1b2 = _mm_mul_epu32(a2301, b3012);
+    __m128i a2b1_a0b3 = _mm_mul_epu32(a3210, b2103);
+    __m128i a3b0 = _mm_unpackhi_epi32(a3b0_a1b2, z);
+    __m128i a1b2 = _mm_unpacklo_epi32(a3b0_a1b2, z);
+    __m128i a2b1 = _mm_unpackhi_epi32(a2b1_a0b3, z);
+    __m128i a0b3 = _mm_unpacklo_epi32(a2b1_a0b3, z);
+    __m128i sum1 = _mm_add_epi64(a3b0, a1b2);
+    sum = _mm_add_epi64(a2b1, a0b3);
+    C[3] = _mm_add_epi64(sum, sum1);
+
+    __m128i	a3b1_a1b3 = _mm_mul_epu32(a2301, b2103);
+    __m128i a2b2 = _mm_unpackhi_epi32(a2b2_a0b0, z);
+    __m128i a3b1 = _mm_unpackhi_epi32(a3b1_a1b3, z);
+    __m128i a1b3 = _mm_unpacklo_epi32(a3b1_a1b3, z);
+    sum = _mm_add_epi64(a2b2, a3b1);
+    C[4] = _mm_add_epi64(sum, a1b3);
+
+    __m128i a1302 = _mm_shuffle_epi32(a3210, _MM_SHUFFLE(1, 3, 0, 2));
+    __m128i b1203 = _mm_shuffle_epi32(b3210, _MM_SHUFFLE(1, 2, 0, 3));
+    __m128i a3b2_a2b3 = _mm_mul_epu32(a1302, b1203);
+    __m128i a3b2 = _mm_unpackhi_epi32(a3b2_a2b3, z);
+    __m128i a2b3 = _mm_unpacklo_epi32(a3b2_a2b3, z);
+    C[5] = _mm_add_epi64(a3b2, a2b3);
+}
+
+void P4Optimized::Multiply4(word *C, const word *A, const word *B)
+{
+    __m128i temp[7];
+    const word *w = (word *)temp;
+    const __m64 *mw = (__m64 *)w;
+
+    P4_Mul(temp, (__m128i *)A, (__m128i *)B);
+
+    C[0] = w[0];
+
+    __m64 s1, s2;
+
+    __m64 w1 = _mm_cvtsi32_si64(w[1]);
+    __m64 w4 = mw[2];
+    __m64 w6 = mw[3];
+    __m64 w8 = mw[4];
+    __m64 w10 = mw[5];
+    __m64 w12 = mw[6];
+    __m64 w14 = mw[7];
+    __m64 w16 = mw[8];
+    __m64 w18 = mw[9];
+    __m64 w20 = mw[10];
+    __m64 w22 = mw[11];
+    __m64 w26 = _mm_cvtsi32_si64(w[26]);
+
+    s1 = _mm_add_si64(w1, w4);
+    C[1] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s2 = _mm_add_si64(w6, w8);
+    s1 = _mm_add_si64(s1, s2);
+    C[2] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s2 = _mm_add_si64(w10, w12);
+    s1 = _mm_add_si64(s1, s2);
+    C[3] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s2 = _mm_add_si64(w14, w16);
+    s1 = _mm_add_si64(s1, s2);
+    C[4] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s2 = _mm_add_si64(w18, w20);
+    s1 = _mm_add_si64(s1, s2);
+    C[5] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s2 = _mm_add_si64(w22, w26);
+    s1 = _mm_add_si64(s1, s2);
+    C[6] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    C[7] = _mm_cvtsi64_si32(s1) + w[27];
+    _mm_empty();
+}
+
+void P4Optimized::Multiply8(word *C, const word *A, const word *B)
+{
+    __m128i temp[28];
+    const word *w = (word *)temp;
+    const __m64 *mw = (__m64 *)w;
+    const word *x = (word *)temp+7*4;
+    const __m64 *mx = (__m64 *)x;
+    const word *y = (word *)temp+7*4*2;
+    const __m64 *my = (__m64 *)y;
+    const word *z = (word *)temp+7*4*3;
+    const __m64 *mz = (__m64 *)z;
+
+    P4_Mul(temp, (__m128i *)A, (__m128i *)B);
+
+    P4_Mul(temp+7, (__m128i *)A+1, (__m128i *)B);
+
+    P4_Mul(temp+14, (__m128i *)A, (__m128i *)B+1);
+
+    P4_Mul(temp+21, (__m128i *)A+1, (__m128i *)B+1);
+
+    C[0] = w[0];
+
+    __m64 s1, s2, s3, s4;
+
+    __m64 w1 = _mm_cvtsi32_si64(w[1]);
+    __m64 w4 = mw[2];
+    __m64 w6 = mw[3];
+    __m64 w8 = mw[4];
+    __m64 w10 = mw[5];
+    __m64 w12 = mw[6];
+    __m64 w14 = mw[7];
+    __m64 w16 = mw[8];
+    __m64 w18 = mw[9];
+    __m64 w20 = mw[10];
+    __m64 w22 = mw[11];
+    __m64 w26 = _mm_cvtsi32_si64(w[26]);
+    __m64 w27 = _mm_cvtsi32_si64(w[27]);
+
+    __m64 x0 = _mm_cvtsi32_si64(x[0]);
+    __m64 x1 = _mm_cvtsi32_si64(x[1]);
+    __m64 x4 = mx[2];
+    __m64 x6 = mx[3];
+    __m64 x8 = mx[4];
+    __m64 x10 = mx[5];
+    __m64 x12 = mx[6];
+    __m64 x14 = mx[7];
+    __m64 x16 = mx[8];
+    __m64 x18 = mx[9];
+    __m64 x20 = mx[10];
+    __m64 x22 = mx[11];
+    __m64 x26 = _mm_cvtsi32_si64(x[26]);
+    __m64 x27 = _mm_cvtsi32_si64(x[27]);
+
+    __m64 y0 = _mm_cvtsi32_si64(y[0]);
+    __m64 y1 = _mm_cvtsi32_si64(y[1]);
+    __m64 y4 = my[2];
+    __m64 y6 = my[3];
+    __m64 y8 = my[4];
+    __m64 y10 = my[5];
+    __m64 y12 = my[6];
+    __m64 y14 = my[7];
+    __m64 y16 = my[8];
+    __m64 y18 = my[9];
+    __m64 y20 = my[10];
+    __m64 y22 = my[11];
+    __m64 y26 = _mm_cvtsi32_si64(y[26]);
+    __m64 y27 = _mm_cvtsi32_si64(y[27]);
+
+    __m64 z0 = _mm_cvtsi32_si64(z[0]);
+    __m64 z1 = _mm_cvtsi32_si64(z[1]);
+    __m64 z4 = mz[2];
+    __m64 z6 = mz[3];
+    __m64 z8 = mz[4];
+    __m64 z10 = mz[5];
+    __m64 z12 = mz[6];
+    __m64 z14 = mz[7];
+    __m64 z16 = mz[8];
+    __m64 z18 = mz[9];
+    __m64 z20 = mz[10];
+    __m64 z22 = mz[11];
+    __m64 z26 = _mm_cvtsi32_si64(z[26]);
+
+    s1 = _mm_add_si64(w1, w4);
+    C[1] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s2 = _mm_add_si64(w6, w8);
+    s1 = _mm_add_si64(s1, s2);
+    C[2] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s2 = _mm_add_si64(w10, w12);
+    s1 = _mm_add_si64(s1, s2);
+    C[3] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s3 = _mm_add_si64(x0, y0);
+    s2 = _mm_add_si64(w14, w16);
+    s1 = _mm_add_si64(s1, s3);
+    s1 = _mm_add_si64(s1, s2);
+    C[4] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s3 = _mm_add_si64(x1, y1);
+    s4 = _mm_add_si64(x4, y4);
+    s1 = _mm_add_si64(s1, w18);
+    s3 = _mm_add_si64(s3, s4);
+    s1 = _mm_add_si64(s1, w20);
+    s1 = _mm_add_si64(s1, s3);
+    C[5] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s3 = _mm_add_si64(x6, y6);
+    s4 = _mm_add_si64(x8, y8);
+    s1 = _mm_add_si64(s1, w22);
+    s3 = _mm_add_si64(s3, s4);
+    s1 = _mm_add_si64(s1, w26);
+    s1 = _mm_add_si64(s1, s3);
+    C[6] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s3 = _mm_add_si64(x10, y10);
+    s4 = _mm_add_si64(x12, y12);
+    s1 = _mm_add_si64(s1, w27);
+    s3 = _mm_add_si64(s3, s4);
+    s1 = _mm_add_si64(s1, s3);
+    C[7] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s3 = _mm_add_si64(x14, y14);
+    s4 = _mm_add_si64(x16, y16);
+    s1 = _mm_add_si64(s1, z0);
+    s3 = _mm_add_si64(s3, s4);
+    s1 = _mm_add_si64(s1, s3);
+    C[8] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s3 = _mm_add_si64(x18, y18);
+    s4 = _mm_add_si64(x20, y20);
+    s1 = _mm_add_si64(s1, z1);
+    s3 = _mm_add_si64(s3, s4);
+    s1 = _mm_add_si64(s1, z4);
+    s1 = _mm_add_si64(s1, s3);
+    C[9] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s3 = _mm_add_si64(x22, y22);
+    s4 = _mm_add_si64(x26, y26);
+    s1 = _mm_add_si64(s1, z6);
+    s3 = _mm_add_si64(s3, s4);
+    s1 = _mm_add_si64(s1, z8);
+    s1 = _mm_add_si64(s1, s3);
+    C[10] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s3 = _mm_add_si64(x27, y27);
+    s1 = _mm_add_si64(s1, z10);
+    s1 = _mm_add_si64(s1, z12);
+    s1 = _mm_add_si64(s1, s3);
+    C[11] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s3 = _mm_add_si64(z14, z16);
+    s1 = _mm_add_si64(s1, s3);
+    C[12] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s3 = _mm_add_si64(z18, z20);
+    s1 = _mm_add_si64(s1, s3);
+    C[13] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s3 = _mm_add_si64(z22, z26);
+    s1 = _mm_add_si64(s1, s3);
+    C[14] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    C[15] = z[27] + _mm_cvtsi64_si32(s1);
+    _mm_empty();
+}
+
+void P4Optimized::Multiply8Bottom(word *C, const word *A, const word *B)
+{
+    __m128i temp[21];
+    const word *w = (word *)temp;
+    const __m64 *mw = (__m64 *)w;
+    const word *x = (word *)temp+7*4;
+    const __m64 *mx = (__m64 *)x;
+    const word *y = (word *)temp+7*4*2;
+    const __m64 *my = (__m64 *)y;
+
+    P4_Mul(temp, (__m128i *)A, (__m128i *)B);
+
+    P4_Mul(temp+7, (__m128i *)A+1, (__m128i *)B);
+
+    P4_Mul(temp+14, (__m128i *)A, (__m128i *)B+1);
+
+    C[0] = w[0];
+
+    __m64 s1, s2, s3, s4;
+
+    __m64 w1 = _mm_cvtsi32_si64(w[1]);
+    __m64 w4 = mw[2];
+    __m64 w6 = mw[3];
+    __m64 w8 = mw[4];
+    __m64 w10 = mw[5];
+    __m64 w12 = mw[6];
+    __m64 w14 = mw[7];
+    __m64 w16 = mw[8];
+    __m64 w18 = mw[9];
+    __m64 w20 = mw[10];
+    __m64 w22 = mw[11];
+    __m64 w26 = _mm_cvtsi32_si64(w[26]);
+
+    __m64 x0 = _mm_cvtsi32_si64(x[0]);
+    __m64 x1 = _mm_cvtsi32_si64(x[1]);
+    __m64 x4 = mx[2];
+    __m64 x6 = mx[3];
+    __m64 x8 = mx[4];
+
+    __m64 y0 = _mm_cvtsi32_si64(y[0]);
+    __m64 y1 = _mm_cvtsi32_si64(y[1]);
+    __m64 y4 = my[2];
+    __m64 y6 = my[3];
+    __m64 y8 = my[4];
+
+    s1 = _mm_add_si64(w1, w4);
+    C[1] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s2 = _mm_add_si64(w6, w8);
+    s1 = _mm_add_si64(s1, s2);
+    C[2] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s2 = _mm_add_si64(w10, w12);
+    s1 = _mm_add_si64(s1, s2);
+    C[3] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s3 = _mm_add_si64(x0, y0);
+    s2 = _mm_add_si64(w14, w16);
+    s1 = _mm_add_si64(s1, s3);
+    s1 = _mm_add_si64(s1, s2);
+    C[4] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s3 = _mm_add_si64(x1, y1);
+    s4 = _mm_add_si64(x4, y4);
+    s1 = _mm_add_si64(s1, w18);
+    s3 = _mm_add_si64(s3, s4);
+    s1 = _mm_add_si64(s1, w20);
+    s1 = _mm_add_si64(s1, s3);
+    C[5] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    s3 = _mm_add_si64(x6, y6);
+    s4 = _mm_add_si64(x8, y8);
+    s1 = _mm_add_si64(s1, w22);
+    s3 = _mm_add_si64(s3, s4);
+    s1 = _mm_add_si64(s1, w26);
+    s1 = _mm_add_si64(s1, s3);
+    C[6] = _mm_cvtsi64_si32(s1);
+    s1 = _mm_srli_si64(s1, 32);
+
+    C[7] = _mm_cvtsi64_si32(s1) + w[27] + x[10] + y[10] + x[12] + y[12];
+    _mm_empty();
+}
+
+#endif	// #ifdef SSE2_INTRINSICS_AVAILABLE
+
+// end optimized
+
+// ********************************************************
+
+#define A0      A
+#define A1      (A+N2)
+#define B0      B
+#define B1      (B+N2)
+
+#define T0      T
+#define T1      (T+N2)
+#define T2      (T+N)
+#define T3      (T+N+N2)
+
+#define R0      R
+#define R1      (R+N2)
+#define R2      (R+N)
+#define R3      (R+N+N2)
+
+//VC60 workaround: compiler bug triggered without the extra dummy parameters
+
+// R[2*N] - result = A*B
+// T[2*N] - temporary work space
+// A[N] --- multiplier
+// B[N] --- multiplicant
+
+
+void RecursiveMultiply(word *R, word *T, const word *A, const word *B,
+                       unsigned int N)
+{
+    if (LowLevel::MultiplyRecursionLimit() >= 8 && N==8)
+        LowLevel::Multiply8(R, A, B);
+    else if (LowLevel::MultiplyRecursionLimit() >= 4 && N==4)
+        LowLevel::Multiply4(R, A, B);
+    else if (N==2)
+        LowLevel::Multiply2(R, A, B);
+    else
+    {
+        const unsigned int N2 = N/2;
+        int carry;
+
+        int aComp = Compare(A0, A1, N2);
+        int bComp = Compare(B0, B1, N2);
+
+        switch (2*aComp + aComp + bComp)
+        {
+        case -4:
+            LowLevel::Subtract(R0, A1, A0, N2);
+            LowLevel::Subtract(R1, B0, B1, N2);
+            RecursiveMultiply(T0, T2, R0, R1, N2);
+            LowLevel::Subtract(T1, T1, R0, N2);
+            carry = -1;
+            break;
+        case -2:
+            LowLevel::Subtract(R0, A1, A0, N2);
+            LowLevel::Subtract(R1, B0, B1, N2);
+            RecursiveMultiply(T0, T2, R0, R1, N2);
+            carry = 0;
+            break;
+        case 2:
+            LowLevel::Subtract(R0, A0, A1, N2);
+            LowLevel::Subtract(R1, B1, B0, N2);
+            RecursiveMultiply(T0, T2, R0, R1, N2);
+            carry = 0;
+            break;
+        case 4:
+            LowLevel::Subtract(R0, A1, A0, N2);
+            LowLevel::Subtract(R1, B0, B1, N2);
+            RecursiveMultiply(T0, T2, R0, R1, N2);
+            LowLevel::Subtract(T1, T1, R1, N2);
+            carry = -1;
+            break;
+        default:
+            SetWords(T0, 0, N);
+            carry = 0;
+        }
+
+        RecursiveMultiply(R0, T2, A0, B0, N2);
+        RecursiveMultiply(R2, T2, A1, B1, N2);
+
+        // now T[01] holds (A1-A0)*(B0-B1),R[01] holds A0*B0, R[23] holds A1*B1
+
+        carry += LowLevel::Add(T0, T0, R0, N);
+        carry += LowLevel::Add(T0, T0, R2, N);
+        carry += LowLevel::Add(R1, R1, T0, N);
+
+        Increment(R3, N2, carry);
+    }
+}
+
+
+void RecursiveSquare(word *R, word *T, const word *A, unsigned int N)                     
+{
+    if (LowLevel::SquareRecursionLimit() >= 4 && N==4)
+        LowLevel::Square4(R, A);
+    else if (N==2)
+        LowLevel::Square2(R, A);
+    else
+    {
+        const unsigned int N2 = N/2;
+
+        RecursiveSquare(R0, T2, A0, N2);
+        RecursiveSquare(R2, T2, A1, N2);
+        RecursiveMultiply(T0, T2, A0, A1, N2);
+
+        word carry = LowLevel::Add(R1, R1, T0, N);
+        carry += LowLevel::Add(R1, R1, T0, N);
+        Increment(R3, N2, carry);
+    }
+}
+
+
+// R[N] - bottom half of A*B
+// T[N] - temporary work space
+// A[N] - multiplier
+// B[N] - multiplicant
+
+
+void RecursiveMultiplyBottom(word *R, word *T, const word *A, const word *B,
+                             unsigned int N)
+{
+    if (LowLevel::MultiplyBottomRecursionLimit() >= 8 && N==8)
+        LowLevel::Multiply8Bottom(R, A, B);
+    else if (LowLevel::MultiplyBottomRecursionLimit() >= 4 && N==4)
+        LowLevel::Multiply4Bottom(R, A, B);
+    else if (N==2)
+        LowLevel::Multiply2Bottom(R, A, B);
+    else
+    {
+        const unsigned int N2 = N/2;
+
+        RecursiveMultiply(R, T, A0, B0, N2);
+        RecursiveMultiplyBottom(T0, T1, A1, B0, N2);
+        LowLevel::Add(R1, R1, T0, N2);
+        RecursiveMultiplyBottom(T0, T1, A0, B1, N2);
+        LowLevel::Add(R1, R1, T0, N2);
+    }
+}
+
+
+void RecursiveMultiplyTop(word *R, word *T, const word *L, const word *A,
+                          const word *B, unsigned int N)
+{
+    if (N==4)
+    {
+        LowLevel::Multiply4(T, A, B);
+        memcpy(R, T+4, 4*WORD_SIZE);
+    }
+    else if (N==2)
+    {
+        LowLevel::Multiply2(T, A, B);
+        memcpy(R, T+2, 2*WORD_SIZE);
+    }
+    else
+    {
+        const unsigned int N2 = N/2;
+        int carry;
+
+        int aComp = Compare(A0, A1, N2);
+        int bComp = Compare(B0, B1, N2);
+
+        switch (2*aComp + aComp + bComp)
+        {
+        case -4:
+            LowLevel::Subtract(R0, A1, A0, N2);
+            LowLevel::Subtract(R1, B0, B1, N2);
+            RecursiveMultiply(T0, T2, R0, R1, N2);
+            LowLevel::Subtract(T1, T1, R0, N2);
+            carry = -1;
+            break;
+        case -2:
+            LowLevel::Subtract(R0, A1, A0, N2);
+            LowLevel::Subtract(R1, B0, B1, N2);
+            RecursiveMultiply(T0, T2, R0, R1, N2);
+            carry = 0;
+            break;
+        case 2:
+            LowLevel::Subtract(R0, A0, A1, N2);
+            LowLevel::Subtract(R1, B1, B0, N2);
+            RecursiveMultiply(T0, T2, R0, R1, N2);
+            carry = 0;
+            break;
+        case 4:
+            LowLevel::Subtract(R0, A1, A0, N2);
+            LowLevel::Subtract(R1, B0, B1, N2);
+            RecursiveMultiply(T0, T2, R0, R1, N2);
+            LowLevel::Subtract(T1, T1, R1, N2);
+            carry = -1;
+            break;
+        default:
+            SetWords(T0, 0, N);
+            carry = 0;
+        }
+
+        RecursiveMultiply(T2, R0, A1, B1, N2);
+
+        // now T[01] holds (A1-A0)*(B0-B1), T[23] holds A1*B1
+
+        word c2 = LowLevel::Subtract(R0, L+N2, L, N2);
+        c2 += LowLevel::Subtract(R0, R0, T0, N2);
+        word t = (Compare(R0, T2, N2) == -1);
+
+        carry += t;
+        carry += Increment(R0, N2, c2+t);
+        carry += LowLevel::Add(R0, R0, T1, N2);
+        carry += LowLevel::Add(R0, R0, T3, N2);
+
+        CopyWords(R1, T3, N2);
+        Increment(R1, N2, carry);
+    }
+}
+
+
+inline word Add(word *C, const word *A, const word *B, unsigned int N)
+{
+    return LowLevel::Add(C, A, B, N);
+}
+
+inline word Subtract(word *C, const word *A, const word *B, unsigned int N)
+{
+    return LowLevel::Subtract(C, A, B, N);
+}
+
+inline void Multiply(word *R, word *T, const word *A, const word *B,
+                     unsigned int N)
+{
+    RecursiveMultiply(R, T, A, B, N);
+}
+
+inline void Square(word *R, word *T, const word *A, unsigned int N)
+{
+    RecursiveSquare(R, T, A, N);
+}
+
+
+void AsymmetricMultiply(word *R, word *T, const word *A, unsigned int NA,
+                        const word *B, unsigned int NB)
+{
+    if (NA == NB)
+    {
+        if (A == B)
+            Square(R, T, A, NA);
+        else
+            Multiply(R, T, A, B, NA);
+
+        return;
+    }
+
+    if (NA > NB)
+    {
+        STL::swap(A, B);
+        STL::swap(NA, NB);
+    }
+
+    if (NA==2 && !A[1])
+    {
+        switch (A[0])
+        {
+        case 0:
+            SetWords(R, 0, NB+2);
+            return;
+        case 1:
+            CopyWords(R, B, NB);
+            R[NB] = R[NB+1] = 0;
+            return;
+        default:
+            R[NB] = LinearMultiply(R, B, A[0], NB);
+            R[NB+1] = 0;
+            return;
+        }
+    }
+
+    Multiply(R, T, A, B, NA);
+    CopyWords(T+2*NA, R+NA, NA);
+
+    unsigned i;
+
+    for (i=2*NA; i<NB; i+=2*NA)
+        Multiply(T+NA+i, T, A, B+i, NA);
+    for (i=NA; i<NB; i+=2*NA)
+        Multiply(R+i, T, A, B+i, NA);
+
+    if (Add(R+NA, R+NA, T+2*NA, NB-NA))
+        Increment(R+NB, NA);
+}
+
+
+void PositiveMultiply(Integer& product, const Integer& a, const Integer& b)
+{
+    unsigned int aSize = RoundupSize(a.WordCount());
+    unsigned int bSize = RoundupSize(b.WordCount());
+
+    product.reg_.CleanNew(RoundupSize(aSize + bSize));
+    product.sign_ = Integer::POSITIVE;
+
+    AlignedWordBlock workspace(aSize + bSize);
+    AsymmetricMultiply(product.reg_.get_buffer(), workspace.get_buffer(),
+                       a.reg_.get_buffer(), aSize, b.reg_.get_buffer(), bSize);
+}
+
+void Multiply(Integer &product, const Integer &a, const Integer &b)
+{
+    PositiveMultiply(product, a, b);
+
+    if (a.NotNegative() != b.NotNegative())
+        product.Negate();
+}
+
+
+static inline unsigned int EvenWordCount(const word *X, unsigned int N)
+{
+    while (N && X[N-2]==0 && X[N-1]==0)
+        N-=2;
+    return N;
+}
+
+
+unsigned int AlmostInverse(word *R, word *T, const word *A, unsigned int NA,
+                           const word *M, unsigned int N)
+{
+    word *b = T;
+    word *c = T+N;
+    word *f = T+2*N;
+    word *g = T+3*N;
+    unsigned int bcLen=2, fgLen=EvenWordCount(M, N);
+    unsigned int k=0, s=0;
+
+    SetWords(T, 0, 3*N);
+    b[0]=1;
+    CopyWords(f, A, NA);
+    CopyWords(g, M, N);
+
+    while (1)
+    {
+        word t=f[0];
+        while (!t)
+        {
+            if (EvenWordCount(f, fgLen)==0)
+            {
+                SetWords(R, 0, N);
+                return 0;
+            }
+
+            ShiftWordsRightByWords(f, fgLen, 1);
+            if (c[bcLen-1]) bcLen+=2;
+            ShiftWordsLeftByWords(c, bcLen, 1);
+            k+=WORD_BITS;
+            t=f[0];
+        }
+
+        unsigned int i=0;
+        while (t%2 == 0)
+        {
+            t>>=1;
+            i++;
+        }
+        k+=i;
+
+        if (t==1 && f[1]==0 && EvenWordCount(f, fgLen)==2)
+        {
+            if (s%2==0)
+                CopyWords(R, b, N);
+            else
+                Subtract(R, M, b, N);
+            return k;
+        }
+
+        ShiftWordsRightByBits(f, fgLen, i);
+        t=ShiftWordsLeftByBits(c, bcLen, i);
+        if (t)
+        {
+            c[bcLen] = t;
+            bcLen+=2;
+        }
+
+        if (f[fgLen-2]==0 && g[fgLen-2]==0 && f[fgLen-1]==0 && g[fgLen-1]==0)
+            fgLen-=2;
+
+        if (Compare(f, g, fgLen)==-1)
+        {
+            STL::swap(f, g);
+            STL::swap(b, c);
+            s++;
+        }
+
+        Subtract(f, f, g, fgLen);
+
+        if (Add(b, b, c, bcLen))
+        {
+            b[bcLen] = 1;
+            bcLen+=2;
+        }
+    }
+}
+
+// R[N] - result = A/(2^k) mod M
+// A[N] - input
+// M[N] - modulus
+
+void DivideByPower2Mod(word *R, const word *A, unsigned int k, const word *M,
+                       unsigned int N)
+{
+    CopyWords(R, A, N);
+
+    while (k--)
+    {
+        if (R[0]%2==0)
+            ShiftWordsRightByBits(R, N, 1);
+        else
+        {
+            word carry = Add(R, R, M, N);
+            ShiftWordsRightByBits(R, N, 1);
+            R[N-1] += carry<<(WORD_BITS-1);
+        }
+    }
+}
+
+// R[N] - result = A*(2^k) mod M
+// A[N] - input
+// M[N] - modulus
+
+void MultiplyByPower2Mod(word *R, const word *A, unsigned int k, const word *M,
+                         unsigned int N)
+{
+    CopyWords(R, A, N);
+
+    while (k--)
+        if (ShiftWordsLeftByBits(R, N, 1) || Compare(R, M, N)>=0)
+            Subtract(R, R, M, N);
+}
+
+
+// ********** end of integer needs
+
+
+Integer::Integer()
+    : reg_(2), sign_(POSITIVE)
+{
+    reg_[0] = reg_[1] = 0;
+}
+
+
+Integer::Integer(const Integer& t)
+    : reg_(RoundupSize(t.WordCount())), sign_(t.sign_)
+{
+    CopyWords(reg_.get_buffer(), t.reg_.get_buffer(), reg_.size());
+}
+
+
+Integer::Integer(signed long value)
+    : reg_(2)
+{
+    if (value >= 0)
+        sign_ = POSITIVE;
+    else
+    {
+        sign_ = NEGATIVE;
+        value = -value;
+    }
+    reg_[0] = word(value);
+    reg_[1] = word(SafeRightShift<WORD_BITS, unsigned long>(value));
+}
+
+
+Integer::Integer(Sign s, word high, word low)
+    : reg_(2), sign_(s)
+{
+    reg_[0] = low;
+    reg_[1] = high;
+}
+
+
+Integer::Integer(word value, unsigned int length)
+    : reg_(RoundupSize(length)), sign_(POSITIVE)
+{
+    reg_[0] = value;
+    SetWords(reg_ + 1, 0, reg_.size() - 1);
+}
+
+
+Integer::Integer(const byte *encodedInteger, unsigned int byteCount,
+                 Signedness s)
+{
+    Decode(encodedInteger, byteCount, s);
+}
+
+class BadBER {};
+
+// BER Decode Source
+Integer::Integer(Source& source)
+    : reg_(2), sign_(POSITIVE)
+{
+    Decode(source);
+}
+
+void Integer::Decode(Source& source)
+{
+    byte b = source.next();
+    if (b != INTEGER) {
+        source.SetError(INTEGER_E);
+        return;
+    }
+
+    word32 length = GetLength(source);
+    if (length == 0 || source.GetError().What()) return;
+
+    if ( (b = source.next()) == 0x00)
+        length--;
+    else
+        source.prev();
+
+    if (source.IsLeft(length) == false) return;
+ 
+    unsigned int words = (length + WORD_SIZE - 1) / WORD_SIZE;
+    words = RoundupSize(words);
+    if (words > reg_.size()) reg_.CleanNew(words);
+
+    for (int j = length; j > 0; j--) {
+        b = source.next();
+        reg_ [(j-1) / WORD_SIZE] |= (word)b << ((j-1) % WORD_SIZE) * 8;
+    }
+}
+
+
+void Integer::Decode(const byte* input, unsigned int inputLen, Signedness s)
+{
+    unsigned int idx(0);
+    byte b = 0; 
+    if (inputLen>0)
+        b = input[idx];   // peek
+    sign_  = ((s==SIGNED) && (b & 0x80)) ? NEGATIVE : POSITIVE;
+
+    while (inputLen>0 && (sign_==POSITIVE ? b==0 : b==0xff))
+    {
+        idx++;   // skip
+        if (--inputLen>0)
+            b = input[idx];  // peek
+    }
+
+    reg_.CleanNew(RoundupSize(BytesToWords(inputLen)));
+
+    for (unsigned int i=inputLen; i > 0; i--)
+    {
+        b = input[idx++];
+        reg_[(i-1)/WORD_SIZE] |= (word)b << ((i-1)%WORD_SIZE)*8;
+    }
+
+    if (sign_ == NEGATIVE)
+    {
+        for (unsigned i=inputLen; i<reg_.size()*WORD_SIZE; i++)
+            reg_[i/WORD_SIZE] |= (word)0xff << (i%WORD_SIZE)*8;
+        TwosComplement(reg_.get_buffer(), reg_.size());
+    }
+}
+
+
+unsigned int Integer::Encode(byte* output, unsigned int outputLen,
+                       Signedness signedness) const
+{
+    unsigned int idx(0);
+    if (signedness == UNSIGNED || NotNegative())
+    {
+        for (unsigned int i=outputLen; i > 0; i--)
+            output[idx++] = GetByte(i-1);
+    }
+    else
+    {
+        // take two's complement of *this
+        Integer temp = Integer::Power2(8*max(ByteCount(), outputLen)) + *this;
+        for (unsigned i=0; i<outputLen; i++)
+            output[idx++] = temp.GetByte(outputLen-i-1);
+    }
+    return outputLen;
+}
+
+
+static Integer* zero = 0;
+
+const Integer &Integer::Zero()
+{
+    if (!zero)
+        zero = NEW_TC Integer;
+    return *zero;
+}
+
+
+static Integer* one = 0;
+
+const Integer &Integer::One()
+{
+    if (!one)
+        one = NEW_TC Integer(1,2);
+    return *one;
+}
+
+
+// Clean up static singleton holders, not a leak, but helpful to have gone
+// when checking for leaks
+void CleanUp()
+{
+    tcDelete(one);
+    tcDelete(zero);
+
+    // In case user calls more than once, prevent seg fault
+    one  = 0;
+    zero = 0;
+}
+
+Integer::Integer(RandomNumberGenerator& rng, const Integer& min,
+                 const Integer& max)
+{
+    Randomize(rng, min, max);
+}
+
+
+void Integer::Randomize(RandomNumberGenerator& rng, unsigned int nbits)
+{
+    const unsigned int nbytes = nbits/8 + 1;
+    ByteBlock buf(nbytes);
+    rng.GenerateBlock(buf.get_buffer(), nbytes);
+    if (nbytes)
+        buf[0] = (byte)Crop(buf[0], nbits % 8);
+    Decode(buf.get_buffer(), nbytes, UNSIGNED);
+}
+
+void Integer::Randomize(RandomNumberGenerator& rng, const Integer& min,
+                        const Integer& max)
+{
+    Integer range = max - min;
+    const unsigned int nbits = range.BitCount();
+
+    do
+    {
+        Randomize(rng, nbits);
+    }
+    while (*this > range);
+
+    *this += min;
+}
+
+
+Integer Integer::Power2(unsigned int e)
+{
+    Integer r((word)0, BitsToWords(e + 1));
+    r.SetBit(e);
+    return r;
+}
+
+
+void Integer::SetBit(unsigned int n, bool value)
+{
+    if (value)
+    {
+        reg_.CleanGrow(RoundupSize(BitsToWords(n + 1)));
+        reg_[n / WORD_BITS] |= (word(1) << (n % WORD_BITS));
+    }
+    else
+    {
+        if (n / WORD_BITS < reg_.size())
+            reg_[n / WORD_BITS] &= ~(word(1) << (n % WORD_BITS));
+    }
+}
+
+
+void Integer::SetByte(unsigned int n, byte value)
+{
+    reg_.CleanGrow(RoundupSize(BytesToWords(n+1)));
+    reg_[n/WORD_SIZE] &= ~(word(0xff) << 8*(n%WORD_SIZE));
+    reg_[n/WORD_SIZE] |= (word(value) << 8*(n%WORD_SIZE));
+}
+
+
+void Integer::Negate()
+{
+    if (!!(*this))	// don't flip sign if *this==0
+        sign_ = Sign(1 - sign_);
+}
+
+
+bool Integer::operator!() const
+{
+    return IsNegative() ? false : (reg_[0]==0 && WordCount()==0);
+}
+
+
+Integer& Integer::operator=(const Integer& t)
+{
+    if (this != &t)
+    {
+        reg_.New(RoundupSize(t.WordCount()));
+        CopyWords(reg_.get_buffer(), t.reg_.get_buffer(), reg_.size());
+        sign_ = t.sign_;
+    }
+    return *this;
+}
+
+
+Integer& Integer::operator+=(const Integer& t)
+{
+    reg_.CleanGrow(t.reg_.size());
+    if (NotNegative())
+    {
+        if (t.NotNegative())
+            PositiveAdd(*this, *this, t);
+        else
+            PositiveSubtract(*this, *this, t);
+    }
+    else
+    {
+        if (t.NotNegative())
+            PositiveSubtract(*this, t, *this);
+        else
+        {
+            PositiveAdd(*this, *this, t);
+            sign_ = Integer::NEGATIVE;
+        }
+    }
+    return *this;
+}
+
+
+Integer Integer::operator-() const
+{
+    Integer result(*this);
+    result.Negate();
+    return result;
+}
+
+
+Integer& Integer::operator-=(const Integer& t)
+{
+    reg_.CleanGrow(t.reg_.size());
+    if (NotNegative())
+    {
+        if (t.NotNegative())
+            PositiveSubtract(*this, *this, t);
+        else
+            PositiveAdd(*this, *this, t);
+    }
+    else
+    {
+        if (t.NotNegative())
+        {
+            PositiveAdd(*this, *this, t);
+            sign_ = Integer::NEGATIVE;
+        }
+        else
+            PositiveSubtract(*this, t, *this);
+    }
+    return *this;
+}
+
+
+Integer& Integer::operator++()
+{
+    if (NotNegative())
+    {
+        if (Increment(reg_.get_buffer(), reg_.size()))
+        {
+            reg_.CleanGrow(2*reg_.size());
+            reg_[reg_.size()/2]=1;
+        }
+    }
+    else
+    {
+        word borrow = Decrement(reg_.get_buffer(), reg_.size());
+        (void)borrow;           // shut up compiler
+        if (WordCount()==0)
+            *this = Zero();
+    }
+    return *this;
+}
+
+Integer& Integer::operator--()
+{
+    if (IsNegative())
+    {
+        if (Increment(reg_.get_buffer(), reg_.size()))
+        {
+            reg_.CleanGrow(2*reg_.size());
+            reg_[reg_.size()/2]=1;
+        }
+    }
+    else
+    {
+        if (Decrement(reg_.get_buffer(), reg_.size()))
+            *this = -One();
+    }
+    return *this;
+}
+
+
+Integer& Integer::operator<<=(unsigned int n)
+{
+    const unsigned int wordCount = WordCount();
+    const unsigned int shiftWords = n / WORD_BITS;
+    const unsigned int shiftBits = n % WORD_BITS;
+
+    reg_.CleanGrow(RoundupSize(wordCount+BitsToWords(n)));
+    ShiftWordsLeftByWords(reg_.get_buffer(), wordCount + shiftWords,
+                          shiftWords);
+    ShiftWordsLeftByBits(reg_+shiftWords, wordCount+BitsToWords(shiftBits),
+                         shiftBits);
+    return *this;
+}
+
+Integer& Integer::operator>>=(unsigned int n)
+{
+    const unsigned int wordCount = WordCount();
+    const unsigned int shiftWords = n / WORD_BITS;
+    const unsigned int shiftBits = n % WORD_BITS;
+
+    ShiftWordsRightByWords(reg_.get_buffer(), wordCount, shiftWords);
+    if (wordCount > shiftWords)
+        ShiftWordsRightByBits(reg_.get_buffer(), wordCount-shiftWords,
+                              shiftBits);
+    if (IsNegative() && WordCount()==0)   // avoid -0
+        *this = Zero();
+    return *this;
+}
+
+
+void PositiveAdd(Integer& sum, const Integer& a, const Integer& b)
+{
+    word carry;
+    if (a.reg_.size() == b.reg_.size())
+        carry = Add(sum.reg_.get_buffer(), a.reg_.get_buffer(),
+                    b.reg_.get_buffer(), a.reg_.size());
+    else if (a.reg_.size() > b.reg_.size())
+    {
+        carry = Add(sum.reg_.get_buffer(), a.reg_.get_buffer(),
+                    b.reg_.get_buffer(), b.reg_.size());
+        CopyWords(sum.reg_+b.reg_.size(), a.reg_+b.reg_.size(),
+                  a.reg_.size()-b.reg_.size());
+        carry = Increment(sum.reg_+b.reg_.size(), a.reg_.size()-b.reg_.size(),
+                          carry);
+    }
+    else
+    {
+        carry = Add(sum.reg_.get_buffer(), a.reg_.get_buffer(),
+                    b.reg_.get_buffer(), a.reg_.size());
+        CopyWords(sum.reg_+a.reg_.size(), b.reg_+a.reg_.size(),
+                  b.reg_.size()-a.reg_.size());
+        carry = Increment(sum.reg_+a.reg_.size(), b.reg_.size()-a.reg_.size(),
+                          carry);
+    }
+
+    if (carry)
+    {
+        sum.reg_.CleanGrow(2*sum.reg_.size());
+        sum.reg_[sum.reg_.size()/2] = 1;
+    }
+    sum.sign_ = Integer::POSITIVE;
+}
+
+void PositiveSubtract(Integer &diff, const Integer &a, const Integer& b)
+{
+    unsigned aSize = a.WordCount();
+    aSize += aSize%2;
+    unsigned bSize = b.WordCount();
+    bSize += bSize%2;
+
+    if (aSize == bSize)
+    {
+        if (Compare(a.reg_.get_buffer(), b.reg_.get_buffer(), aSize) >= 0)
+        {
+            Subtract(diff.reg_.get_buffer(), a.reg_.get_buffer(),
+                     b.reg_.get_buffer(), aSize);
+            diff.sign_ = Integer::POSITIVE;
+        }
+        else
+        {
+            Subtract(diff.reg_.get_buffer(), b.reg_.get_buffer(),
+                     a.reg_.get_buffer(), aSize);
+            diff.sign_ = Integer::NEGATIVE;
+        }
+    }
+    else if (aSize > bSize)
+    {
+        word borrow = Subtract(diff.reg_.get_buffer(), a.reg_.get_buffer(),
+                               b.reg_.get_buffer(), bSize);
+        CopyWords(diff.reg_+bSize, a.reg_+bSize, aSize-bSize);
+        borrow = Decrement(diff.reg_+bSize, aSize-bSize, borrow);
+        diff.sign_ = Integer::POSITIVE;
+    }
+    else
+    {
+        word borrow = Subtract(diff.reg_.get_buffer(), b.reg_.get_buffer(),
+                               a.reg_.get_buffer(), aSize);
+        CopyWords(diff.reg_+aSize, b.reg_+aSize, bSize-aSize);
+        borrow = Decrement(diff.reg_+aSize, bSize-aSize, borrow);
+        diff.sign_ = Integer::NEGATIVE;
+    }
+}
+
+
+unsigned int Integer::MinEncodedSize(Signedness signedness) const
+{
+    unsigned int outputLen = max(1U, ByteCount());
+    if (signedness == UNSIGNED)
+        return outputLen;
+    if (NotNegative() && (GetByte(outputLen-1) & 0x80))
+        outputLen++;
+    if (IsNegative() && *this < -Power2(outputLen*8-1))
+        outputLen++;
+    return outputLen;
+}
+
+
+int Integer::Compare(const Integer& t) const
+{
+    if (NotNegative())
+    {
+        if (t.NotNegative())
+            return PositiveCompare(t);
+        else
+            return 1;
+    }
+    else
+    {
+        if (t.NotNegative())
+            return -1;
+        else
+            return -PositiveCompare(t);
+    }
+}
+
+
+int Integer::PositiveCompare(const Integer& t) const
+{
+    unsigned size = WordCount(), tSize = t.WordCount();
+
+    if (size == tSize)
+        return TaoCrypt::Compare(reg_.get_buffer(), t.reg_.get_buffer(), size);
+    else
+        return size > tSize ? 1 : -1;
+}
+
+
+bool Integer::GetBit(unsigned int n) const
+{
+    if (n/WORD_BITS >= reg_.size())
+        return 0;
+    else
+        return bool((reg_[n/WORD_BITS] >> (n % WORD_BITS)) & 1);
+}
+
+
+unsigned long Integer::GetBits(unsigned int i, unsigned int n) const
+{
+    unsigned long v = 0;
+    for (unsigned int j=0; j<n; j++)
+        v |= GetBit(i+j) << j;
+    return v;
+}
+
+
+byte Integer::GetByte(unsigned int n) const
+{
+    if (n/WORD_SIZE >= reg_.size())
+        return 0;
+    else
+        return byte(reg_[n/WORD_SIZE] >> ((n%WORD_SIZE)*8));
+}
+
+
+unsigned int Integer::BitCount() const
+{
+    unsigned wordCount = WordCount();
+    if (wordCount)
+        return (wordCount-1)*WORD_BITS + BitPrecision(reg_[wordCount-1]);
+    else
+        return 0;
+}
+
+
+unsigned int Integer::ByteCount() const
+{
+    unsigned wordCount = WordCount();
+    if (wordCount)
+        return (wordCount-1)*WORD_SIZE + BytePrecision(reg_[wordCount-1]);
+    else
+        return 0;
+}
+
+
+unsigned int Integer::WordCount() const
+{
+    return CountWords(reg_.get_buffer(), reg_.size());
+}
+
+
+bool Integer::IsConvertableToLong() const
+{
+    if (ByteCount() > sizeof(long))
+        return false;
+
+    unsigned long value = reg_[0];
+    value += SafeLeftShift<WORD_BITS, unsigned long>(reg_[1]);
+
+    if (sign_ == POSITIVE)
+        return (signed long)value >= 0;
+    else
+        return -(signed long)value < 0;
+}
+
+
+signed long Integer::ConvertToLong() const
+{
+    unsigned long value = reg_[0];
+    value += SafeLeftShift<WORD_BITS, unsigned long>(reg_[1]);
+    return sign_ == POSITIVE ? value : -(signed long)value;
+}
+
+
+void Integer::Swap(Integer& a)
+{
+    reg_.Swap(a.reg_);
+    STL::swap(sign_, a.sign_);
+}
+
+
+Integer Integer::Plus(const Integer& b) const
+{
+    Integer sum((word)0, max(reg_.size(), b.reg_.size()));
+    if (NotNegative())
+    {
+        if (b.NotNegative())
+            PositiveAdd(sum, *this, b);
+        else
+            PositiveSubtract(sum, *this, b);
+    }
+    else
+    {
+        if (b.NotNegative())
+            PositiveSubtract(sum, b, *this);
+        else
+        {
+            PositiveAdd(sum, *this, b);
+            sum.sign_ = Integer::NEGATIVE;
+        }
+    }
+    return sum;
+}
+
+
+Integer Integer::Minus(const Integer& b) const
+{
+    Integer diff((word)0, max(reg_.size(), b.reg_.size()));
+    if (NotNegative())
+    {
+        if (b.NotNegative())
+            PositiveSubtract(diff, *this, b);
+        else
+            PositiveAdd(diff, *this, b);
+    }
+    else
+    {
+        if (b.NotNegative())
+        {
+            PositiveAdd(diff, *this, b);
+            diff.sign_ = Integer::NEGATIVE;
+        }
+        else
+            PositiveSubtract(diff, b, *this);
+    }
+    return diff;
+}
+
+
+Integer Integer::Times(const Integer &b) const
+{
+    Integer product;
+    Multiply(product, *this, b);
+    return product;
+}
+
+
+#undef A0
+#undef A1
+#undef B0
+#undef B1
+
+#undef T0
+#undef T1
+#undef T2
+#undef T3
+
+#undef R0
+#undef R1
+#undef R2
+#undef R3
+
+
+static inline void AtomicDivide(word *Q, const word *A, const word *B)
+{
+    word T[4];
+    DWord q = DivideFourWordsByTwo<word, DWord>(T, DWord(A[0], A[1]),
+                                         DWord(A[2], A[3]), DWord(B[0], B[1]));
+    Q[0] = q.GetLowHalf();
+    Q[1] = q.GetHighHalf();
+
+#ifndef NDEBUG
+    if (B[0] || B[1])
+    {
+        // multiply quotient and divisor and add remainder, make sure it 
+        // equals dividend
+        word P[4];
+        Portable::Multiply2(P, Q, B);
+        Add(P, P, T, 4);
+    }
+#endif
+}
+
+
+// for use by Divide(), corrects the underestimated quotient {Q1,Q0}
+static void CorrectQuotientEstimate(word *R, word *T, word *Q, const word *B,
+                                    unsigned int N)
+{
+    if (Q[1])
+    {
+        T[N] = T[N+1] = 0;
+        unsigned i;
+        for (i=0; i<N; i+=4)
+            LowLevel::Multiply2(T+i, Q, B+i);
+        for (i=2; i<N; i+=4)
+            if (LowLevel::Multiply2Add(T+i, Q, B+i))
+                T[i+5] += (++T[i+4]==0);
+    }
+    else
+    {
+        T[N] = LinearMultiply(T, B, Q[0], N);
+        T[N+1] = 0;
+    }
+
+    word borrow = Subtract(R, R, T, N+2);
+    (void)borrow;       // shut up compiler
+
+    while (R[N] || Compare(R, B, N) >= 0)
+    {
+        R[N] -= Subtract(R, R, B, N);
+        Q[1] += (++Q[0]==0);
+    }
+}
+
+// R[NB] -------- remainder = A%B
+// Q[NA-NB+2] --- quotient	= A/B
+// T[NA+2*NB+4] - temp work space
+// A[NA] -------- dividend
+// B[NB] -------- divisor
+
+
+void Divide(word* R, word* Q, word* T, const word* A, unsigned int NA,
+            const word* B, unsigned int NB)
+{
+    // set up temporary work space
+    word *const TA=T;
+    word *const TB=T+NA+2;
+    word *const TP=T+NA+2+NB;
+
+    // copy B into TB and normalize it so that TB has highest bit set to 1
+    unsigned shiftWords = (B[NB-1]==0);
+    TB[0] = TB[NB-1] = 0;
+    CopyWords(TB+shiftWords, B, NB-shiftWords);
+    unsigned shiftBits = WORD_BITS - BitPrecision(TB[NB-1]);
+    ShiftWordsLeftByBits(TB, NB, shiftBits);
+
+    // copy A into TA and normalize it
+    TA[0] = TA[NA] = TA[NA+1] = 0;
+    CopyWords(TA+shiftWords, A, NA);
+    ShiftWordsLeftByBits(TA, NA+2, shiftBits);
+
+    if (TA[NA+1]==0 && TA[NA] <= 1)
+    {
+        Q[NA-NB+1] = Q[NA-NB] = 0;
+        while (TA[NA] || Compare(TA+NA-NB, TB, NB) >= 0)
+        {
+            TA[NA] -= Subtract(TA+NA-NB, TA+NA-NB, TB, NB);
+            ++Q[NA-NB];
+        }
+    }
+    else
+    {
+        NA+=2;
+    }
+
+    word BT[2];
+    BT[0] = TB[NB-2] + 1;
+    BT[1] = TB[NB-1] + (BT[0]==0);
+
+    // start reducing TA mod TB, 2 words at a time
+    for (unsigned i=NA-2; i>=NB; i-=2)
+    {
+        AtomicDivide(Q+i-NB, TA+i-2, BT);
+        CorrectQuotientEstimate(TA+i-NB, TP, Q+i-NB, TB, NB);
+    }
+
+    // copy TA into R, and denormalize it
+    CopyWords(R, TA+shiftWords, NB);
+    ShiftWordsRightByBits(R, NB, shiftBits);
+}
+
+
+void PositiveDivide(Integer& remainder, Integer& quotient,
+                   const Integer& a, const Integer& b)
+{
+    unsigned aSize = a.WordCount();
+    unsigned bSize = b.WordCount();
+
+    if (a.PositiveCompare(b) == -1)
+    {
+        remainder = a;
+        remainder.sign_ = Integer::POSITIVE;
+        quotient = Integer::Zero();
+        return;
+    }
+
+    aSize += aSize%2;	// round up to next even number
+    bSize += bSize%2;
+
+    remainder.reg_.CleanNew(RoundupSize(bSize));
+    remainder.sign_ = Integer::POSITIVE;
+    quotient.reg_.CleanNew(RoundupSize(aSize-bSize+2));
+    quotient.sign_ = Integer::POSITIVE;
+
+    AlignedWordBlock T(aSize+2*bSize+4);
+    Divide(remainder.reg_.get_buffer(), quotient.reg_.get_buffer(),
+           T.get_buffer(), a.reg_.get_buffer(), aSize, b.reg_.get_buffer(),
+           bSize);
+}
+
+void Integer::Divide(Integer &remainder, Integer &quotient,
+                     const Integer &dividend, const Integer &divisor)
+{
+    PositiveDivide(remainder, quotient, dividend, divisor);
+
+    if (dividend.IsNegative())
+    {
+        quotient.Negate();
+        if (remainder.NotZero())
+        {
+            --quotient;
+            remainder = divisor.AbsoluteValue() - remainder;
+        }
+    }
+
+    if (divisor.IsNegative())
+        quotient.Negate();
+}
+
+void Integer::DivideByPowerOf2(Integer &r, Integer &q, const Integer &a,
+                               unsigned int n)
+{
+    q = a;
+    q >>= n;
+
+    const unsigned int wordCount = BitsToWords(n);
+    if (wordCount <= a.WordCount())
+    {
+        r.reg_.resize(RoundupSize(wordCount));
+        CopyWords(r.reg_.get_buffer(), a.reg_.get_buffer(), wordCount);
+        SetWords(r.reg_+wordCount, 0, r.reg_.size()-wordCount);
+        if (n % WORD_BITS != 0)
+          r.reg_[wordCount-1] %= (word(1) << (n % WORD_BITS));
+    }
+    else
+    {
+        r.reg_.resize(RoundupSize(a.WordCount()));
+        CopyWords(r.reg_.get_buffer(), a.reg_.get_buffer(), r.reg_.size());
+    }
+    r.sign_ = POSITIVE;
+
+    if (a.IsNegative() && r.NotZero())
+    {
+        --q;
+        r = Power2(n) - r;
+    }
+}
+
+Integer Integer::DividedBy(const Integer &b) const
+{
+    Integer remainder, quotient;
+    Integer::Divide(remainder, quotient, *this, b);
+    return quotient;
+}
+
+Integer Integer::Modulo(const Integer &b) const
+{
+    Integer remainder, quotient;
+    Integer::Divide(remainder, quotient, *this, b);
+    return remainder;
+}
+
+void Integer::Divide(word &remainder, Integer &quotient,
+                     const Integer &dividend, word divisor)
+{
+    if ((divisor & (divisor-1)) == 0)	// divisor is a power of 2
+    {
+        quotient = dividend >> (BitPrecision(divisor)-1);
+        remainder = dividend.reg_[0] & (divisor-1);
+        return;
+    }
+
+    unsigned int i = dividend.WordCount();
+    quotient.reg_.CleanNew(RoundupSize(i));
+    remainder = 0;
+    while (i--)
+    {
+        quotient.reg_[i] = DWord(dividend.reg_[i], remainder) / divisor;
+        remainder = DWord(dividend.reg_[i], remainder) % divisor;
+    }
+
+    if (dividend.NotNegative())
+        quotient.sign_ = POSITIVE;
+    else
+    {
+        quotient.sign_ = NEGATIVE;
+        if (remainder)
+        {
+            --quotient;
+            remainder = divisor - remainder;
+        }
+    }
+}
+
+Integer Integer::DividedBy(word b) const
+{
+    word remainder;
+    Integer quotient;
+    Integer::Divide(remainder, quotient, *this, b);
+    return quotient;
+}
+
+word Integer::Modulo(word divisor) const
+{
+    word remainder;
+
+    if ((divisor & (divisor-1)) == 0)	// divisor is a power of 2
+        remainder = reg_[0] & (divisor-1);
+    else
+    {
+        unsigned int i = WordCount();
+
+        if (divisor <= 5)
+        {
+            DWord sum(0, 0);
+            while (i--)
+                sum += reg_[i];
+            remainder = sum % divisor;
+        }
+        else
+        {
+            remainder = 0;
+            while (i--)
+                remainder = DWord(reg_[i], remainder) % divisor;
+        }
+    }
+
+    if (IsNegative() && remainder)
+        remainder = divisor - remainder;
+
+    return remainder;
+}
+
+
+Integer Integer::AbsoluteValue() const
+{
+    Integer result(*this);
+    result.sign_ = POSITIVE;
+    return result;
+}
+
+
+Integer Integer::SquareRoot() const
+{
+    if (!IsPositive())
+        return Zero();
+
+    // overestimate square root
+    Integer x, y = Power2((BitCount()+1)/2);
+
+    do
+    {
+        x = y;
+        y = (x + *this/x) >> 1;
+    } while (y<x);
+
+    return x;
+}
+
+bool Integer::IsSquare() const
+{
+    Integer r = SquareRoot();
+    return *this == r.Squared();
+}
+
+bool Integer::IsUnit() const
+{
+    return (WordCount() == 1) && (reg_[0] == 1);
+}
+
+Integer Integer::MultiplicativeInverse() const
+{
+    return IsUnit() ? *this : Zero();
+}
+
+Integer a_times_b_mod_c(const Integer &x, const Integer& y, const Integer& m)
+{
+    return x*y%m;
+}
+
+Integer a_exp_b_mod_c(const Integer &x, const Integer& e, const Integer& m)
+{
+    ModularArithmetic mr(m);
+    return mr.Exponentiate(x, e);
+}
+
+Integer Integer::Gcd(const Integer &a, const Integer &b)
+{
+    return EuclideanDomainOf().Gcd(a, b);
+}
+
+Integer Integer::InverseMod(const Integer &m) const
+{
+    if (IsNegative() || *this>=m)
+        return (*this%m).InverseMod(m);
+
+    if (m.IsEven())
+    {
+        if (!m || IsEven())
+            return Zero();	// no inverse
+        if (*this == One())
+            return One();
+
+        Integer u = m.InverseMod(*this);
+        return !u ? Zero() : (m*(*this-u)+1)/(*this);
+    }
+
+    AlignedWordBlock T(m.reg_.size() * 4);
+    Integer r((word)0, m.reg_.size());
+    unsigned k = AlmostInverse(r.reg_.get_buffer(), T.get_buffer(),
+                               reg_.get_buffer(), reg_.size(),
+                               m.reg_.get_buffer(), m.reg_.size());
+    DivideByPower2Mod(r.reg_.get_buffer(), r.reg_.get_buffer(), k,
+                      m.reg_.get_buffer(), m.reg_.size());
+    return r;
+}
+
+word Integer::InverseMod(const word mod) const
+{
+    word g0 = mod, g1 = *this % mod;
+    word v0 = 0, v1 = 1;
+    word y;
+
+    while (g1)
+    {
+        if (g1 == 1)
+            return v1;
+        y = g0 / g1;
+        g0 = g0 % g1;
+        v0 += y * v1;
+
+        if (!g0)
+            break;
+        if (g0 == 1)
+            return mod-v0;
+        y = g1 / g0;
+        g1 = g1 % g0;
+        v1 += y * v0;
+    }
+    return 0;
+}
+
+// ********* ModArith stuff
+
+const Integer& ModularArithmetic::Half(const Integer &a) const
+{
+    if (a.reg_.size()==modulus.reg_.size())
+    {
+        TaoCrypt::DivideByPower2Mod(result.reg_.begin(), a.reg_.begin(), 1,
+                                    modulus.reg_.begin(), a.reg_.size());
+        return result;
+    }
+    else
+        return result1 = (a.IsEven() ? (a >> 1) : ((a+modulus) >> 1));
+}
+
+const Integer& ModularArithmetic::Add(const Integer &a, const Integer &b) const
+{
+    if (a.reg_.size()==modulus.reg_.size() && 
+        b.reg_.size()==modulus.reg_.size())
+    {
+        if (TaoCrypt::Add(result.reg_.begin(), a.reg_.begin(), b.reg_.begin(),
+                          a.reg_.size())
+            || Compare(result.reg_.get_buffer(), modulus.reg_.get_buffer(),
+                       a.reg_.size()) >= 0)
+        {
+            TaoCrypt::Subtract(result.reg_.begin(), result.reg_.begin(),
+                               modulus.reg_.begin(), a.reg_.size());
+        }
+        return result;
+    }
+    else
+    {
+        result1 = a+b;
+        if (result1 >= modulus)
+            result1 -= modulus;
+        return result1;
+    }
+}
+
+Integer& ModularArithmetic::Accumulate(Integer &a, const Integer &b) const
+{
+    if (a.reg_.size()==modulus.reg_.size() && 
+        b.reg_.size()==modulus.reg_.size())
+    {
+        if (TaoCrypt::Add(a.reg_.get_buffer(), a.reg_.get_buffer(),
+                          b.reg_.get_buffer(), a.reg_.size())
+            || Compare(a.reg_.get_buffer(), modulus.reg_.get_buffer(),
+                       a.reg_.size()) >= 0)
+        {
+            TaoCrypt::Subtract(a.reg_.get_buffer(), a.reg_.get_buffer(),
+                               modulus.reg_.get_buffer(), a.reg_.size());
+        }
+    }
+    else
+    {
+        a+=b;
+        if (a>=modulus)
+            a-=modulus;
+    }
+
+    return a;
+}
+
+const Integer& ModularArithmetic::Subtract(const Integer &a,
+                                           const Integer &b) const
+{
+    if (a.reg_.size()==modulus.reg_.size() && 
+        b.reg_.size()==modulus.reg_.size())
+    {
+        if (TaoCrypt::Subtract(result.reg_.begin(), a.reg_.begin(),
+                               b.reg_.begin(), a.reg_.size()))
+            TaoCrypt::Add(result.reg_.begin(), result.reg_.begin(),
+                          modulus.reg_.begin(), a.reg_.size());
+        return result;
+    }
+    else
+    {
+        result1 = a-b;
+        if (result1.IsNegative())
+            result1 += modulus;
+        return result1;
+    }
+}
+
+Integer& ModularArithmetic::Reduce(Integer &a, const Integer &b) const
+{
+    if (a.reg_.size()==modulus.reg_.size() && 
+        b.reg_.size()==modulus.reg_.size())
+    {
+        if (TaoCrypt::Subtract(a.reg_.get_buffer(), a.reg_.get_buffer(),
+                               b.reg_.get_buffer(), a.reg_.size()))
+            TaoCrypt::Add(a.reg_.get_buffer(), a.reg_.get_buffer(),
+                          modulus.reg_.get_buffer(), a.reg_.size());
+    }
+    else
+    {
+        a-=b;
+        if (a.IsNegative())
+            a+=modulus;
+    }
+
+    return a;
+}
+
+const Integer& ModularArithmetic::Inverse(const Integer &a) const
+{
+    if (!a)
+        return a;
+
+    CopyWords(result.reg_.begin(), modulus.reg_.begin(), modulus.reg_.size());
+    if (TaoCrypt::Subtract(result.reg_.begin(), result.reg_.begin(),
+                           a.reg_.begin(), a.reg_.size()))
+        Decrement(result.reg_.begin()+a.reg_.size(), 1,
+                  modulus.reg_.size()-a.reg_.size());
+
+    return result;
+}
+
+Integer ModularArithmetic::CascadeExponentiate(const Integer &x,
+                  const Integer &e1, const Integer &y, const Integer &e2) const
+{
+    if (modulus.IsOdd())
+    {
+        MontgomeryRepresentation dr(modulus);
+        return dr.ConvertOut(dr.CascadeExponentiate(dr.ConvertIn(x), e1,
+                                                    dr.ConvertIn(y), e2));
+    }
+    else
+        return AbstractRing::CascadeExponentiate(x, e1, y, e2);
+}
+
+void ModularArithmetic::SimultaneousExponentiate(Integer *results,
+        const Integer &base, const Integer *exponents,
+        unsigned int exponentsCount) const
+{
+    if (modulus.IsOdd())
+    {
+        MontgomeryRepresentation dr(modulus);
+        dr.SimultaneousExponentiate(results, dr.ConvertIn(base), exponents,
+                                    exponentsCount);
+        for (unsigned int i=0; i<exponentsCount; i++)
+            results[i] = dr.ConvertOut(results[i]);
+    }
+    else
+        AbstractRing::SimultaneousExponentiate(results, base,
+                                                    exponents, exponentsCount);
+}
+
+
+// ********************************************************
+
+#define A0      A
+#define A1      (A+N2)
+#define B0      B
+#define B1      (B+N2)
+
+#define T0      T
+#define T1      (T+N2)
+#define T2      (T+N)
+#define T3      (T+N+N2)
+
+#define R0      R
+#define R1      (R+N2)
+#define R2      (R+N)
+#define R3      (R+N+N2)
+
+
+inline void MultiplyBottom(word *R, word *T, const word *A, const word *B,
+                           unsigned int N)
+{
+    RecursiveMultiplyBottom(R, T, A, B, N);
+}
+
+inline void MultiplyTop(word *R, word *T, const word *L, const word *A,
+                        const word *B, unsigned int N)
+{
+    RecursiveMultiplyTop(R, T, L, A, B, N);
+}
+
+
+// R[N] --- result = X/(2**(WORD_BITS*N)) mod M
+// T[3*N] - temporary work space
+// X[2*N] - number to be reduced
+// M[N] --- modulus
+// U[N] --- multiplicative inverse of M mod 2**(WORD_BITS*N)
+
+void MontgomeryReduce(word *R, word *T, const word *X, const word *M,
+                      const word *U, unsigned int N)
+{
+    MultiplyBottom(R, T, X, U, N);
+    MultiplyTop(T, T+N, X, R, M, N);
+    word borrow = Subtract(T, X+N, T, N);
+    // defend against timing attack by doing this Add even when not needed
+    word carry = Add(T+N, T, M, N);
+    (void)carry;            // shut up compiler
+    CopyWords(R, T + (borrow ? N : 0), N);
+}
+
+// R[N] ----- result = A inverse mod 2**(WORD_BITS*N)
+// T[3*N/2] - temporary work space
+// A[N] ----- an odd number as input
+
+void RecursiveInverseModPower2(word *R, word *T, const word *A, unsigned int N)
+{
+    if (N==2)
+    {
+        T[0] = AtomicInverseModPower2(A[0]);
+        T[1] = 0;
+        LowLevel::Multiply2Bottom(T+2, T, A);
+        TwosComplement(T+2, 2);
+        Increment(T+2, 2, 2);
+        LowLevel::Multiply2Bottom(R, T, T+2);
+    }
+    else
+    {
+        const unsigned int N2 = N/2;
+        RecursiveInverseModPower2(R0, T0, A0, N2);
+        T0[0] = 1;
+        SetWords(T0+1, 0, N2-1);
+        MultiplyTop(R1, T1, T0, R0, A0, N2);
+        MultiplyBottom(T0, T1, R0, A1, N2);
+        Add(T0, R1, T0, N2);
+        TwosComplement(T0, N2);
+        MultiplyBottom(R1, T1, R0, T0, N2);
+    }
+}
+
+
+#undef A0
+#undef A1
+#undef B0
+#undef B1
+
+#undef T0
+#undef T1
+#undef T2
+#undef T3
+
+#undef R0
+#undef R1
+#undef R2
+#undef R3
+
+
+// modulus must be odd
+MontgomeryRepresentation::MontgomeryRepresentation(const Integer &m)
+    : ModularArithmetic(m),
+      u((word)0, modulus.reg_.size()),
+      workspace(5*modulus.reg_.size())
+{
+    RecursiveInverseModPower2(u.reg_.get_buffer(), workspace.get_buffer(),
+                              modulus.reg_.get_buffer(), modulus.reg_.size());
+}
+
+const Integer& MontgomeryRepresentation::Multiply(const Integer &a,
+                                                  const Integer &b) const
+{
+    word *const T = workspace.begin();
+    word *const R = result.reg_.begin();
+    const unsigned int N = modulus.reg_.size();
+
+    AsymmetricMultiply(T, T+2*N, a.reg_.get_buffer(), a.reg_.size(),
+                       b.reg_.get_buffer(), b.reg_.size());
+    SetWords(T+a.reg_.size()+b.reg_.size(),0, 2*N-a.reg_.size()-b.reg_.size());
+    MontgomeryReduce(R, T+2*N, T, modulus.reg_.get_buffer(),
+                     u.reg_.get_buffer(), N);
+    return result;
+}
+
+const Integer& MontgomeryRepresentation::Square(const Integer &a) const
+{
+    word *const T = workspace.begin();
+    word *const R = result.reg_.begin();
+    const unsigned int N = modulus.reg_.size();
+
+    TaoCrypt::Square(T, T+2*N, a.reg_.get_buffer(), a.reg_.size());
+    SetWords(T+2*a.reg_.size(), 0, 2*N-2*a.reg_.size());
+    MontgomeryReduce(R, T+2*N, T, modulus.reg_.get_buffer(),
+                     u.reg_.get_buffer(), N);
+    return result;
+}
+
+Integer MontgomeryRepresentation::ConvertOut(const Integer &a) const
+{
+    word *const T = workspace.begin();
+    word *const R = result.reg_.begin();
+    const unsigned int N = modulus.reg_.size();
+
+    CopyWords(T, a.reg_.get_buffer(), a.reg_.size());
+    SetWords(T+a.reg_.size(), 0, 2*N-a.reg_.size());
+    MontgomeryReduce(R, T+2*N, T, modulus.reg_.get_buffer(),
+                     u.reg_.get_buffer(), N);
+    return result;
+}
+
+const Integer& MontgomeryRepresentation::MultiplicativeInverse(
+                                                        const Integer &a) const
+{
+//  return (EuclideanMultiplicativeInverse(a, modulus)<<
+//      (2*WORD_BITS*modulus.reg_.size()))%modulus;
+    word *const T = workspace.begin();
+    word *const R = result.reg_.begin();
+    const unsigned int N = modulus.reg_.size();
+
+    CopyWords(T, a.reg_.get_buffer(), a.reg_.size());
+    SetWords(T+a.reg_.size(), 0, 2*N-a.reg_.size());
+    MontgomeryReduce(R, T+2*N, T, modulus.reg_.get_buffer(),
+                     u.reg_.get_buffer(), N);
+    unsigned k = AlmostInverse(R, T, R, N, modulus.reg_.get_buffer(), N);
+
+//  cout << "k=" << k << " N*32=" << 32*N << endl;
+
+    if (k>N*WORD_BITS)
+        DivideByPower2Mod(R, R, k-N*WORD_BITS, modulus.reg_.get_buffer(), N);
+    else
+        MultiplyByPower2Mod(R, R, N*WORD_BITS-k, modulus.reg_.get_buffer(), N);
+
+    return result;
+}
+
+
+//  mod Root stuff
+Integer ModularRoot(const Integer &a, const Integer &dp, const Integer &dq,
+                    const Integer &p, const Integer &q, const Integer &u)
+{
+    Integer p2 = ModularExponentiation((a % p), dp, p);
+    Integer q2 = ModularExponentiation((a % q), dq, q);
+    return CRT(p2, p, q2, q, u);
+}
+
+Integer CRT(const Integer &xp, const Integer &p, const Integer &xq,
+            const Integer &q, const Integer &u)
+{
+    // isn't operator overloading great?
+    return p * (u * (xq-xp) % q) + xp;
+}
+
+
+#ifdef HAVE_EXPLICIT_TEMPLATE_INSTANTIATION
+#ifndef TAOCRYPT_NATIVE_DWORD_AVAILABLE
+template hword DivideThreeWordsByTwo<hword, Word>(hword*, hword, hword, Word*);
+#endif
+template word DivideThreeWordsByTwo<word, DWord>(word*, word, word, DWord*);
+#ifdef SSE2_INTRINSICS_AVAILABLE
+template class AlignedAllocator<word>;
+#endif
+#endif
+
+
+} // namespace
+
diff -uNr mysql-5.5.60.orig/libmysql/CMakeLists.txt mysql-5.5.60/libmysql/CMakeLists.txt
--- mysql-5.5.60.orig/libmysql/CMakeLists.txt	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/libmysql/CMakeLists.txt	2018-12-02 00:06:23.409892220 +0800
@@ -136,6 +136,8 @@
 
 )
 
+CONFIGURE_FILE(libmysql.ver.in ${CMAKE_BINARY_DIR}/libmysql/libmysql.ver)
+
 SET(CLIENT_SOURCES
   get_password.c 
   libmysql.c
@@ -225,7 +227,7 @@
         SET(libmysql_link_flags)
       ENDIF()
       SET_TARGET_PROPERTIES(libmysql PROPERTIES LINK_FLAGS 
-        "${libmysql_link_flags} ${LINK_FLAG_NO_UNDEFINED}")
+        "${libmysql_link_flags} ${LINK_FLAG_NO_UNDEFINED} -Wl,--version-script=libmysql.ver")
     ENDIF() 
     # clean direct output needs to be set several targets have the same name
     #(mysqlclient in this case)
diff -uNr mysql-5.5.60.orig/libmysql/CMakeLists.txt.orig mysql-5.5.60/libmysql/CMakeLists.txt.orig
--- mysql-5.5.60.orig/libmysql/CMakeLists.txt.orig	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/libmysql/CMakeLists.txt.orig	2018-02-26 21:02:31.000000000 +0800
@@ -0,0 +1,262 @@
+# Copyright (c) 2006, 2014, Oracle and/or its affiliates. All rights reserved.
+# 
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; version 2 of the License.
+# 
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+# 
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
+
+INCLUDE_DIRECTORIES(
+  ${CMAKE_SOURCE_DIR}/include
+  ${CMAKE_SOURCE_DIR}/libmysql
+  ${CMAKE_SOURCE_DIR}/regex
+  ${CMAKE_SOURCE_DIR}/sql
+  ${CMAKE_SOURCE_DIR}/strings
+  ${SSL_INCLUDE_DIRS}
+  ${SSL_INTERNAL_INCLUDE_DIRS}
+  ${ZLIB_INCLUDE_DIR})
+ADD_DEFINITIONS(${SSL_DEFINES})
+
+SET(CLIENT_API_FUNCTIONS
+get_tty_password
+handle_options
+load_defaults
+mysql_thread_end
+mysql_thread_init
+myodbc_remove_escape
+mysql_affected_rows
+mysql_autocommit
+mysql_stmt_bind_param
+mysql_stmt_bind_result
+mysql_change_user
+mysql_character_set_name
+mysql_close
+mysql_commit
+mysql_data_seek
+mysql_debug
+mysql_dump_debug_info
+mysql_eof
+mysql_errno
+mysql_error
+mysql_escape_string
+mysql_hex_string
+mysql_stmt_execute
+mysql_stmt_fetch
+mysql_stmt_fetch_column
+mysql_fetch_field
+mysql_fetch_field_direct
+mysql_fetch_fields
+mysql_fetch_lengths
+mysql_fetch_row
+mysql_field_count
+mysql_field_seek
+mysql_field_tell
+mysql_free_result
+mysql_get_client_info
+mysql_get_host_info
+mysql_get_proto_info
+mysql_get_server_info
+mysql_get_client_version
+mysql_get_ssl_cipher
+mysql_info
+mysql_init
+mysql_insert_id
+mysql_kill
+mysql_set_server_option
+mysql_list_dbs
+mysql_list_fields
+mysql_list_processes
+mysql_list_tables
+mysql_more_results
+mysql_next_result
+mysql_num_fields
+mysql_num_rows
+mysql_options
+mysql_stmt_param_count
+mysql_stmt_param_metadata
+mysql_ping
+mysql_stmt_result_metadata
+mysql_query
+mysql_read_query_result
+mysql_real_connect
+mysql_real_escape_string
+mysql_real_query
+mysql_refresh
+mysql_rollback
+mysql_row_seek
+mysql_row_tell
+mysql_select_db
+mysql_stmt_send_long_data
+mysql_send_query
+mysql_shutdown
+mysql_ssl_set
+mysql_stat
+mysql_stmt_affected_rows
+mysql_stmt_close
+mysql_stmt_reset
+mysql_stmt_data_seek
+mysql_stmt_errno
+mysql_stmt_error
+mysql_stmt_free_result
+mysql_stmt_num_rows
+mysql_stmt_row_seek
+mysql_stmt_row_tell
+mysql_stmt_store_result
+mysql_store_result
+mysql_thread_id
+mysql_thread_safe
+mysql_use_result
+mysql_warning_count
+mysql_stmt_sqlstate
+mysql_sqlstate
+mysql_get_server_version
+mysql_stmt_prepare
+mysql_stmt_init
+mysql_stmt_insert_id
+mysql_stmt_attr_get
+mysql_stmt_attr_set
+mysql_stmt_field_count
+mysql_set_local_infile_default
+mysql_set_local_infile_handler
+mysql_embedded
+mysql_server_init
+mysql_server_end
+mysql_set_character_set
+mysql_get_character_set_info
+mysql_stmt_next_result
+
+CACHE INTERNAL "Functions exported by client API"
+
+)
+
+SET(CLIENT_SOURCES
+  get_password.c 
+  libmysql.c
+  errmsg.c
+  ../sql-common/client.c 
+  ../sql-common/my_time.c 
+  ../sql-common/client_plugin.c 
+  ../sql/net_serv.cc
+  ../sql-common/pack.c 
+  ../sql/password.c
+)
+ADD_CONVENIENCE_LIBRARY(clientlib ${CLIENT_SOURCES})
+DTRACE_INSTRUMENT(clientlib)
+ADD_DEPENDENCIES(clientlib GenError)
+
+SET(LIBS clientlib dbug strings vio mysys ${ZLIB_LIBRARY} ${SSL_LIBRARIES} ${LIBDL})
+
+#
+# On Windows platform client library includes the client-side 
+# Windows Native Authentication plugin.
+#
+IF(WIN32)
+  ADD_DEFINITIONS(-DAUTHENTICATION_WIN)
+  ADD_SUBDIRECTORY(authentication_win)
+  LIST(APPEND LIBS auth_win_client)
+ENDIF()
+
+# Merge several convenience libraries into one big mysqlclient
+# and link them together into shared library.
+MERGE_LIBRARIES(mysqlclient STATIC ${LIBS} COMPONENT Development)
+
+# Visual Studio users need debug  static library for debug projects
+IF(MSVC)
+ INSTALL_DEBUG_TARGET(mysqlclient DESTINATION ${INSTALL_LIBDIR}/debug)
+ INSTALL_DEBUG_TARGET(clientlib DESTINATION ${INSTALL_LIBDIR}/debug)
+ENDIF()
+
+MACRO(GET_TARGET_NAME target out_name)
+  GET_TARGET_PROPERTY(location ${target} LOCATION)
+  GET_FILENAME_COMPONENT(name ${location} NAME)
+  SET(${out_name} ${name})
+ENDMACRO()
+
+IF(UNIX)
+  MACRO(GET_VERSIONED_LIBNAME LIBNAME EXTENSION VERSION OUTNAME)
+    SET(DOT_VERSION ".${VERSION}")
+    IF(DOT_VERSION STREQUAL ".") 
+      SET(DOT_VERSION "")
+    ENDIF()
+    IF(APPLE)
+      SET(${OUTNAME} ${LIBNAME}${DOT_VERSION}${EXTENSION})
+    ELSE()
+      SET(${OUTNAME} ${LIBNAME}${EXTENSION}${DOT_VERSION})
+    ENDIF() 
+  ENDMACRO()
+ENDIF()
+
+IF(UNIX)
+  GET_TARGET_NAME(mysqlclient lib_name)
+  INSTALL_SYMLINK(mysqlclient
+    ${lib_name} ${CMAKE_STATIC_LIBRARY_PREFIX}mysqlclient_r.a
+    ${INSTALL_LIBDIR} Development)
+ENDIF()
+
+IF(NOT DISABLE_SHARED)
+  MERGE_LIBRARIES(libmysql SHARED ${LIBS}
+    EXPORTS ${CLIENT_API_FUNCTIONS}
+    COMPONENT SharedLibraries)
+  IF(UNIX)
+    # libtool compatability
+    IF(CMAKE_SYSTEM_NAME MATCHES "FreeBSD" OR APPLE)
+      SET(OS_SHARED_LIB_VERSION "${SHARED_LIB_MAJOR_VERSION}")
+    ELSEIF(CMAKE_SYSTEM_NAME MATCHES "HP-UX")
+      SET(OS_SHARED_LIB_VERSION "${SHARED_LIB_MAJOR_VERSION}.0")
+    ELSE()
+      SET(OS_SHARED_LIB_VERSION
+        "${SHARED_LIB_MAJOR_VERSION}.${SHARED_LIB_MINOR_VERSION}.0")
+    ENDIF()
+    # Name of shared library is mysqlclient on Unix
+    SET_TARGET_PROPERTIES(libmysql PROPERTIES 
+      OUTPUT_NAME mysqlclient 
+      VERSION "${OS_SHARED_LIB_VERSION}" 
+      SOVERSION "${SHARED_LIB_MAJOR_VERSION}")
+    IF(LINK_FLAG_NO_UNDEFINED)
+      GET_TARGET_PROPERTY(libmysql_link_flags libmysql LINK_FLAGS)
+      IF(NOT libmysql_link_flag)
+        SET(libmysql_link_flags)
+      ENDIF()
+      SET_TARGET_PROPERTIES(libmysql PROPERTIES LINK_FLAGS 
+        "${libmysql_link_flags} ${LINK_FLAG_NO_UNDEFINED}")
+    ENDIF() 
+    # clean direct output needs to be set several targets have the same name
+    #(mysqlclient in this case)
+    SET_TARGET_PROPERTIES(mysqlclient PROPERTIES CLEAN_DIRECT_OUTPUT 1)
+    SET_TARGET_PROPERTIES(libmysql PROPERTIES CLEAN_DIRECT_OUTPUT 1)
+
+    # Install links to libmysqlclient.so (client_r)
+    GET_VERSIONED_LIBNAME(
+      "${CMAKE_SHARED_LIBRARY_PREFIX}mysqlclient_r"
+      "${CMAKE_SHARED_LIBRARY_SUFFIX}"
+      ""
+      linkname)
+    GET_TARGET_NAME(libmysql lib_name)
+    GET_FILENAME_COMPONENT(lib_name_we ${lib_name} NAME_WE)
+    INSTALL_SYMLINK(libmysql
+      ${lib_name} ${linkname}
+      ${INSTALL_LIBDIR} SharedLibraries)
+    SET(OS_SHARED_LIB_SYMLINKS
+      "${SHARED_LIB_MAJOR_VERSION}" "${OS_SHARED_LIB_VERSION}")
+    LIST(REMOVE_DUPLICATES OS_SHARED_LIB_SYMLINKS)
+    FOREACH(ver ${OS_SHARED_LIB_SYMLINKS})
+      GET_VERSIONED_LIBNAME(
+        "${CMAKE_SHARED_LIBRARY_PREFIX}mysqlclient_r"
+        "${CMAKE_SHARED_LIBRARY_SUFFIX}"
+        "${ver}"
+        linkname)
+      GET_VERSIONED_LIBNAME(
+        ${lib_name_we} "${CMAKE_SHARED_LIBRARY_SUFFIX}" "${ver}" lib_name_ver)
+      INSTALL_SYMLINK(libmysql
+        ${lib_name_ver} ${linkname}
+        ${INSTALL_LIBDIR} SharedLibraries)
+    ENDFOREACH()
+  ENDIF()
+ENDIF()
diff -uNr mysql-5.5.60.orig/libmysql/errmsg.c mysql-5.5.60/libmysql/errmsg.c
--- mysql-5.5.60.orig/libmysql/errmsg.c	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/libmysql/errmsg.c	2018-12-02 00:06:23.381891932 +0800
@@ -81,7 +81,7 @@
   "Attempt to read a row while there is no result set associated with the statement",
   "This feature is not implemented yet",
   "Lost connection to MySQL server at '%s', system error: %d",
-  "Statement closed indirectly because of a preceeding %s() call",
+  "Statement closed indirectly because of a preceding %s() call",
   "The number of columns in the result set differs from the number of bound buffers. You must reset the statement, rebind the result set columns, and execute the statement again",
   "This handle is already connected. Use a separate handle for each connection.",
   "Authentication plugin '%s' cannot be loaded: %s",
diff -uNr mysql-5.5.60.orig/mysql-test/extra/rpl_tests/rpl_ddl.test mysql-5.5.60/mysql-test/extra/rpl_tests/rpl_ddl.test
--- mysql-5.5.60.orig/mysql-test/extra/rpl_tests/rpl_ddl.test	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/mysql-test/extra/rpl_tests/rpl_ddl.test	2018-12-02 00:06:23.381891932 +0800
@@ -98,8 +98,8 @@
 #       --> less switching of AUTOCOMMIT mode on master side.
 #
 #    4. Never use a test object, which was direct or indirect affected by a
-#       preceeding test sequence again.
-#       If one preceeding test sequence hits a (sometimes not visible,
+#       preceding test sequence again.
+#       If one preceding test sequence hits a (sometimes not visible,
 #       because the sql error code of the statement might be 0) bug
 #       and these rules are ignored, a following test sequence might earn ugly
 #       effects like failing 'sync_slave_with_master', crashes of the slave or
diff -uNr mysql-5.5.60.orig/mysql-test/extra/rpl_tests/rpl_row_basic.test mysql-5.5.60/mysql-test/extra/rpl_tests/rpl_row_basic.test
--- mysql-5.5.60.orig/mysql-test/extra/rpl_tests/rpl_row_basic.test	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/mysql-test/extra/rpl_tests/rpl_row_basic.test	2018-12-02 00:06:23.389892015 +0800
@@ -221,7 +221,7 @@
 SELECT * FROM t7 ORDER BY C1;
 
 # since bug#31552/31609 idempotency is not default any longer. In order
-# the preceeding test INSERT INTO t7 to pass the mode is switched
+# the preceding test INSERT INTO t7 to pass the mode is switched
 # temprorarily
 set @@global.slave_exec_mode= 'IDEMPOTENT';
 
@@ -260,7 +260,7 @@
 SELECT * FROM t8 ORDER BY a;
 
 # since bug#31552/31609 idempotency is not default any longer. In order
-# the preceeding test INSERT INTO t8 to pass the mode is switched
+# the preceding test INSERT INTO t8 to pass the mode is switched
 # temprorarily
 set @@global.slave_exec_mode= 'IDEMPOTENT';
 
diff -uNr mysql-5.5.60.orig/mysql-test/include/mysqld--help.inc mysql-5.5.60/mysql-test/include/mysqld--help.inc
--- mysql-5.5.60.orig/mysql-test/include/mysqld--help.inc	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/mysql-test/include/mysqld--help.inc	2018-12-02 00:06:23.401892138 +0800
@@ -48,7 +48,11 @@
     s/\b4294967295\b/18446744073709551615/;
     s/\b2146435072\b/9223372036853727232/;
     s/\b196608\b/262144/;
-    foreach $var (@env) { s/$ENV{$var}/$var/ }
+    foreach $var (@env) {
+	my $re = $ENV{$var};
+	$re =~ s/\+/\\\+/g;
+	s/$re/$var/
+    }
     next if /use --skip-(use-)?symbolic-links to disable/; # for valgrind, again
     next if $skip;
     print;
diff -uNr mysql-5.5.60.orig/mysql-test/include/mysqld--help.inc.orig mysql-5.5.60/mysql-test/include/mysqld--help.inc.orig
--- mysql-5.5.60.orig/mysql-test/include/mysqld--help.inc.orig	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/mysql-test/include/mysqld--help.inc.orig	2018-02-26 21:02:31.000000000 +0800
@@ -0,0 +1,58 @@
+#
+# mysqld --help
+#
+--source include/not_embedded.inc
+
+#
+# force lower-case-table-names=1 (linux/macosx have different defaults)
+# force symbolic-links=0 (valgrind build has a different default)
+#
+
+exec $MYSQLD_BOOTSTRAP_CMD --symbolic-links=0 --lower-case-table-names=1 --help --verbose > $MYSQL_TMP_DIR/mysqld--help.txt 2>&1;
+
+# The inline perl code below will copy $MYSQL_TMP_DIR/mysqld--help.txt
+# to output, but filter away some variable stuff (e.g. paths).
+
+perl;
+  # Variables which we don't want to display in the result file since
+  # their paths may vary:
+  @skipvars=qw/basedir open-files-limit general-log-file log plugin-dir
+               log-slow-queries pid-file slow-query-log-file
+			   datadir slave-load-tmpdir tmpdir socket
+			   secure-file-priv/;
+
+  # Plugins which may or may not be there:
+  @plugins=qw/innodb ndb archive blackhole federated partition ndbcluster debug temp-pool ssl des-key-file
+              thread-concurrency super-large-pages mutex-deadlock-detector null-audit/;
+
+  # And substitute the content some environment variables with their
+  # names:
+  @env=qw/MYSQLTEST_VARDIR MYSQL_TEST_DIR MYSQL_CHARSETSDIR MYSQL_SHAREDIR/;
+
+  $re1=join('|', @skipvars, @plugins);
+  $re2=join('|', @plugins);
+  $skip=0;
+  open(F, '<', "$ENV{MYSQL_TMP_DIR}/mysqld--help.txt") or die;
+  while (<F>) {
+    next if 1../The following groups are read/;
+    # formatting, skip line consisting entirely of dashes and blanks
+    next if /^[\- ]+\s?$/;
+    next if /Value \(after reading options\)/; # skip table header
+    next if /^($re1) /;
+    next if /^($re2)-/;
+    $skip=0 if /^  -/;
+    $skip=1 if / --($re2)\b/;
+    y!\\!/!;
+    s/[ ]+/ /; # squeeze spaces to remove table formatting
+    # fixes for 32-bit
+    s/\b4294967295\b/18446744073709551615/;
+    s/\b2146435072\b/9223372036853727232/;
+    s/\b196608\b/262144/;
+    foreach $var (@env) { s/$ENV{$var}/$var/ }
+    next if /use --skip-(use-)?symbolic-links to disable/; # for valgrind, again
+    next if $skip;
+    print;
+  }
+  close F;
+EOF
+
diff -uNr mysql-5.5.60.orig/mysql-test/include/mysqlhotcopy.inc mysql-5.5.60/mysql-test/include/mysqlhotcopy.inc
--- mysql-5.5.60.orig/mysql-test/include/mysqlhotcopy.inc	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/mysql-test/include/mysqlhotcopy.inc	2018-12-02 00:06:23.437892509 +0800
@@ -107,7 +107,7 @@
 --replace_result $MYSQLD_DATADIR MYSQLD_DATADIR
 --list_files $MYSQLD_DATADIR/hotcopy_save
 --replace_result $MASTER_MYSOCK MASTER_MYSOCK
---error 9,11,2304
+--error 9,11,2304,255
 --exec $MYSQLHOTCOPY --quiet -S $MASTER_MYSOCK -u root hotcopy_test hotcopy_save
 --replace_result $MASTER_MYSOCK MASTER_MYSOCK
 --exec $MYSQLHOTCOPY --quiet --allowold -S $MASTER_MYSOCK -u root hotcopy_test hotcopy_save
diff -uNr mysql-5.5.60.orig/mysql-test/include/wait_until_count_sessions.inc mysql-5.5.60/mysql-test/include/wait_until_count_sessions.inc
--- mysql-5.5.60.orig/mysql-test/include/wait_until_count_sessions.inc	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/mysql-test/include/wait_until_count_sessions.inc	2018-12-02 00:06:23.389892015 +0800
@@ -10,7 +10,7 @@
 #    1. We wait for $current_sessions <= $count_sessions because in the use case
 #       with count_sessions.inc before and wait_until_count_sessions.inc after
 #       the core of the test it could happen that the disconnects of sessions
-#       belonging to the preceeding test are not finished.
+#       belonging to the preceding test are not finished.
 #       sessions at test begin($count_sessions) =  m + n
 #       sessions of the previous test which will be soon disconnected = n (n >= 0)
 #       sessions at test end ($current sessions, assuming the test disconnects
diff -uNr mysql-5.5.60.orig/mysql-test/lib/My/Platform.pm mysql-5.5.60/mysql-test/lib/My/Platform.pm
--- mysql-5.5.60.orig/mysql-test/lib/My/Platform.pm	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/mysql-test/lib/My/Platform.pm	2018-12-02 00:06:23.373891850 +0800
@@ -110,6 +110,11 @@
   # This may not be true, but we can't test for it on AIX due to Perl bug
   # See Bug #45771
   return 0 if ($^O eq 'aix');
+  # Similarly the path length is hidden.
+  # See Debian bug #651002
+  return 0 if ($^O eq 'gnu');
+  # See Debian bug #670722 - failing on kFreeBSD even after setting short path
+  return 0 if length $path < 40;
 
   require IO::Socket::UNIX;
 
diff -uNr mysql-5.5.60.orig/mysql-test/lib/mtr_cases.pm mysql-5.5.60/mysql-test/lib/mtr_cases.pm
--- mysql-5.5.60.orig/mysql-test/lib/mtr_cases.pm	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/mysql-test/lib/mtr_cases.pm	2018-12-02 00:06:23.373891850 +0800
@@ -329,7 +329,8 @@
     else
     {
       $suitedir= my_find_dir($::basedir,
-			     ["share/mysql-test/suite",
+			     ["lib/mysql-testsuite/suite",
+			      "share/mysql-test/suite",
 			      "mysql-test/suite",
 			      "internal/mysql-test/suite",
 			      "mysql-test",
diff -uNr mysql-5.5.60.orig/mysql-test/lib/mtr_cases.pm.orig mysql-5.5.60/mysql-test/lib/mtr_cases.pm.orig
--- mysql-5.5.60.orig/mysql-test/lib/mtr_cases.pm.orig	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/mysql-test/lib/mtr_cases.pm.orig	2018-02-26 21:02:31.000000000 +0800
@@ -0,0 +1,1304 @@
+# -*- cperl -*-
+# Copyright (c) 2005, 2017, Oracle and/or its affiliates. All rights reserved.
+# 
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; version 2 of the License.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
+
+# This is a library file used by the Perl version of mysql-test-run,
+# and is part of the translation of the Bourne shell script with the
+# same name.
+
+package mtr_cases;
+use strict;
+
+use base qw(Exporter);
+our @EXPORT= qw(collect_option collect_test_cases);
+
+use mtr_report;
+use mtr_match;
+
+# Options used for the collect phase
+our $start_from;
+our $print_testcases;
+our $skip_rpl;
+our $do_test;
+our $skip_test;
+our $skip_combinations;
+our $binlog_format;
+our $enable_disabled;
+our $default_storage_engine;
+our $opt_with_ndbcluster_only;
+our $defaults_file;
+our $defaults_extra_file;
+our $quick_collect;
+# Set to 1 if you want the tests to override
+# default storage engine settings, and use MyISAM
+# as default.  (temporary option used in connection
+# with the change of default storage engine to InnoDB)
+our $default_myisam= 1;
+ 
+
+sub collect_option {
+  my ($opt, $value)= @_;
+
+  # Evaluate $opt as string to use "Getopt::Long::Callback legacy API"
+  my $opt_name = "$opt";
+
+  # Convert - to _ in option name
+  $opt_name =~ s/-/_/g;
+  no strict 'refs';
+  ${$opt_name}= $value;
+}
+
+use File::Basename;
+use File::Spec::Functions qw / splitdir /;
+use IO::File();
+use My::Config;
+use My::Platform;
+use My::Test;
+use My::Find;
+
+require "mtr_misc.pl";
+
+# Precompiled regex's for tests to do or skip
+my $do_test_reg;
+my $skip_test_reg;
+
+# Related to adding InnoDB plugin combinations
+my $lib_innodb_plugin;
+my $do_innodb_plugin;
+
+# If "Quick collect", set to 1 once a test to run has been found.
+my $some_test_found;
+
+sub init_pattern {
+  my ($from, $what)= @_;
+  return undef unless defined $from;
+  if ( $from =~ /^[a-z0-9\.]*$/ ) {
+    # Does not contain any regex (except . that we allow as
+    # separator betwen suite and testname), make the pattern match
+    # beginning of string
+    $from= "^$from";
+    mtr_verbose("$what='$from'");
+  }
+  # Check that pattern is a valid regex
+  eval { "" =~/$from/; 1 } or
+    mtr_error("Invalid regex '$from' passed to $what\nPerl says: $@");
+  return $from;
+}
+
+
+##############################################################################
+#
+#  Collect information about test cases to be run
+#
+##############################################################################
+
+sub collect_test_cases ($$$$) {
+  my $opt_reorder= shift; # True if we're reordering tests
+  my $suites= shift; # Semicolon separated list of test suites
+  my $opt_cases= shift;
+  my $opt_skip_test_list= shift;
+  my $cases= []; # Array of hash(one hash for each testcase)
+
+  # Unit tests off by default also if using --do-test or --start-from
+  $::opt_ctest= 0 if $::opt_ctest == -1 && ($do_test || $start_from);
+
+  $do_test_reg= init_pattern($do_test, "--do-test");
+  $skip_test_reg= init_pattern($skip_test, "--skip-test");
+
+  $lib_innodb_plugin=
+    my_find_file($::basedir,
+		 ["storage/innodb_plugin", "storage/innodb_plugin/.libs",
+		  "lib/mysql/plugin", "lib/plugin"],
+		 ["ha_innodb_plugin.dll", "ha_innodb_plugin.so",
+		  "ha_innodb_plugin.sl"],
+		 NOT_REQUIRED);
+  $do_innodb_plugin= ($::mysql_version_id >= 50100 &&
+		      !(IS_WINDOWS && $::opt_embedded_server) &&
+		      $lib_innodb_plugin);
+
+  # If not reordering, we also shouldn't group by suites, unless
+  # no test cases were named.
+  # This also effects some logic in the loop following this.
+  if ($opt_reorder or !@$opt_cases)
+  {
+    foreach my $suite (split(",", $suites))
+    {
+      push(@$cases, collect_one_suite($suite, $opt_cases, $opt_skip_test_list));
+      last if $some_test_found;
+      push(@$cases, collect_one_suite("i_".$suite, $opt_cases, $opt_skip_test_list));
+    }
+  }
+
+  if ( @$opt_cases )
+  {
+    # A list of tests was specified on the command line.
+    # Among those, the tests which are not already collected will be
+    # collected and stored temporarily in an array of hashes pointed
+    # by the below reference. This array is eventually appeneded to
+    # the one having all collected test cases.
+    my $cmdline_cases;
+
+    # Check that the tests specified was found
+    # in at least one suite
+    foreach my $test_name_spec ( @$opt_cases )
+    {
+      my $found= 0;
+      my ($sname, $tname, $extension)= split_testname($test_name_spec);
+      foreach my $test ( @$cases )
+      {
+	last unless $opt_reorder;
+	# test->{name} is always in suite.name format
+	if ( $test->{name} =~ /^$sname.*\.$tname$/ )
+	{
+	  $found= 1;
+	  last;
+	}
+      }
+      if ( not $found )
+      {
+        if ( $sname )
+        {
+	  # If suite was part of name, find it there, may come with combinations
+	  my @this_case = collect_one_suite($sname, [ $tname ]);
+
+          # If a test is specified multiple times on the command line, all
+          # instances of the test need to be picked. Hence, such tests are
+          # stored in the temporary array instead of adding them to $cases
+          # directly so that repeated tests are not run only once
+	  if (@this_case)
+          {
+	    push (@$cmdline_cases, @this_case);
+	  }
+	  else
+	  {
+	    mtr_error("Could not find '$tname' in '$sname' suite");
+          }
+        }
+        else
+        {
+          if ( !$opt_reorder )
+          {
+            # If --no-reorder is passed and if suite was not part of name,
+            # search in all the suites
+            foreach my $suite (split(",", $suites))
+            {
+              my @this_case = collect_one_suite($suite, [ $tname ]);
+              if ( @this_case )
+              {
+                push (@$cmdline_cases, @this_case);
+                $found= 1;
+              }
+              @this_case= collect_one_suite("i_".$suite, [ $tname ]);
+              if ( @this_case )
+              {
+                push (@$cmdline_cases, @this_case);
+                $found= 1;
+              }
+            }
+          }
+          if ( !$found )
+          {
+            mtr_error("Could not find '$tname' in '$suites' suite(s)");
+          }
+        }
+      }
+    }
+    # Add test cases collected in the temporary array to the one
+    # containing all previously collected test cases
+    push (@$cases, @$cmdline_cases) if $cmdline_cases;
+  }
+
+  if ( $opt_reorder && !$quick_collect)
+  {
+    # Reorder the test cases in an order that will make them faster to run
+    # Make a mapping of test name to a string that represents how that test
+    # should be sorted among the other tests.  Put the most important criterion
+    # first, then a sub-criterion, then sub-sub-criterion, etc.
+    foreach my $tinfo (@$cases)
+    {
+      my @criteria = ();
+
+      #
+      # Append the criteria for sorting, in order of importance.
+      #
+      push(@criteria, "ndb=" . ($tinfo->{'ndb_test'} ? "A" : "B"));
+      push(@criteria, $tinfo->{template_path});
+      # Group test with equal options together.
+      # Ending with "~" makes empty sort later than filled
+      my $opts= $tinfo->{'master_opt'} ? $tinfo->{'master_opt'} : [];
+      push(@criteria, join("!", sort @{$opts}) . "~");
+      # Add slave opts if any
+      if ($tinfo->{'slave_opt'})
+      {
+	push(@criteria, join("!", sort @{$tinfo->{'slave_opt'}}));
+      }
+      # This sorts tests with force-restart *before* identical tests
+      push(@criteria, $tinfo->{force_restart} ? "force-restart" : "no-restart");
+
+      $tinfo->{criteria}= join(" ", @criteria);
+    }
+
+    @$cases = sort {$a->{criteria} cmp $b->{criteria}; } @$cases;
+
+    # For debugging the sort-order
+    # foreach my $tinfo (@$cases)
+    # {
+    #   my $tname= $tinfo->{name} . ' ' . $tinfo->{combination};
+    #   my $crit= $tinfo->{criteria};
+    #   print("$tname\n\t$crit\n");
+    # }
+  }
+
+  if (defined $print_testcases){
+    print_testcases(@$cases);
+    exit(1);
+  }
+
+  return $cases;
+
+}
+
+
+# Returns (suitename, testname, extension)
+sub split_testname {
+  my ($test_name)= @_;
+
+  # If .test file name is used, get rid of directory part
+  $test_name= basename($test_name) if $test_name =~ /\.test$/;
+
+  # Now split name on .'s
+  my @parts= split(/\./, $test_name);
+
+  if (@parts == 1){
+    # Only testname given, ex: alias
+    return (undef , $parts[0], undef);
+  } elsif (@parts == 2) {
+    # Either testname.test or suite.testname given
+    # Ex. main.alias or alias.test
+
+    if ($parts[1] eq "test")
+    {
+      return (undef , $parts[0], $parts[1]);
+    }
+    else
+    {
+      return ($parts[0], $parts[1], undef);
+    }
+
+  } elsif (@parts == 3) {
+    # Fully specified suitename.testname.test
+    # ex main.alias.test
+    return ( $parts[0], $parts[1], $parts[2]);
+  }
+
+  mtr_error("Illegal format of test name: $test_name");
+}
+
+
+sub collect_one_suite($)
+{
+  my $suite= shift;  # Test suite name
+  my $opt_cases= shift;
+  my $opt_skip_test_list= shift;
+  my @cases; # Array of hash
+
+  mtr_verbose("Collecting: $suite");
+
+  my $suitedir= "$::glob_mysql_test_dir"; # Default
+  if ( $suite ne "main" )
+  {
+    # Allow suite to be path to "some dir" if $suite has at least
+    # one directory part
+    if ( -d $suite and splitdir($suite) > 1 ){
+      $suitedir= $suite;
+      mtr_report(" - from '$suitedir'");
+
+    }
+    else
+    {
+      $suitedir= my_find_dir($::basedir,
+			     ["share/mysql-test/suite",
+			      "mysql-test/suite",
+			      "internal/mysql-test/suite",
+			      "mysql-test",
+			      # Look in storage engine specific suite dirs
+			      "storage/*/mtr",
+			      # Look in plugin specific suite dir
+			      "plugin/$suite/tests",
+			      "internal/plugin/$suite/tests",
+			     ],
+			     [$suite, "mtr"], ($suite =~ /^i_/));
+      return unless $suitedir;
+    }
+    mtr_verbose("suitedir: $suitedir");
+  }
+
+  my $testdir= "$suitedir/t";
+  my $resdir=  "$suitedir/r";
+
+  # Check if t/ exists
+  if (-d $testdir){
+    # t/ exists
+
+    if ( -d $resdir )
+    {
+      # r/exists
+    }
+    else
+    {
+      # No r/, use t/ as result dir
+      $resdir= $testdir;
+    }
+
+  }
+  else {
+    # No t/ dir => there can' be any r/ dir
+    mtr_error("Can't have r/ dir without t/") if -d $resdir;
+
+    # No t/ or r/ => use suitedir
+    $resdir= $testdir= $suitedir;
+  }
+
+  mtr_verbose("testdir: $testdir");
+  mtr_verbose("resdir: $resdir");
+
+  # ----------------------------------------------------------------------
+  # Build a hash of disabled testcases for this suite
+  # ----------------------------------------------------------------------
+  my %disabled;
+  my @disabled_collection= @{$opt_skip_test_list} if $opt_skip_test_list;
+  unshift (@disabled_collection, "$testdir/disabled.def");
+  for my $skip (@disabled_collection)
+    {
+      if ( open(DISABLED, $skip ) )
+	{
+	  # $^O on Windows considered not generic enough
+	  my $plat= (IS_WINDOWS) ? 'windows' : $^O;
+
+	  while ( <DISABLED> )
+	    {
+	      chomp;
+	      #diasble the test case if platform matches
+	      if ( /\@/ )
+		{
+		  if ( /\@$plat/ )
+		    {
+		      /^\s*(\S+)\s*\@$plat.*:\s*(.*?)\s*$/ ;
+		      $disabled{$1}= $2 if not exists $disabled{$1};
+		    }
+		  elsif ( /\@!(\S*)/ )
+		    {
+		      if ( $1 ne $plat)
+			{
+			  /^\s*(\S+)\s*\@!.*:\s*(.*?)\s*$/ ;
+			  $disabled{$1}= $2 if not exists $disabled{$1};
+			}
+		    }
+		}
+	      elsif ( /^\s*(\S+)\s*:\s*(.*?)\s*$/ )
+		{
+		  chomp;
+		  if ( /^\s*(\S+)\s*:\s*(.*?)\s*$/ )
+		    {
+		      $disabled{$1}= $2 if not exists $disabled{$1};
+		    }
+		}
+	    }
+	  close DISABLED;
+	}
+    }
+
+  # Read suite.opt file
+  my $suite_opt_file=  "$testdir/suite.opt";
+  my $suite_opts= [];
+  if ( -f $suite_opt_file )
+  {
+    $suite_opts= opts_from_file($suite_opt_file);
+  }
+
+  if ( @$opt_cases )
+  {
+    # Collect in specified order
+    foreach my $test_name_spec ( @$opt_cases )
+    {
+      my ($sname, $tname, $extension)= split_testname($test_name_spec);
+
+      # The test name parts have now been defined
+      #print "  suite_name: $sname\n";
+      #print "  tname:      $tname\n";
+      #print "  extension:  $extension\n";
+
+      # Check cirrect suite if suitename is defined
+      next if (defined $sname and $suite ne $sname);
+
+      if ( defined $extension )
+      {
+	my $full_name= "$testdir/$tname.$extension";
+	# Extension was specified, check if the test exists
+        if ( ! -f $full_name)
+        {
+	  # This is only an error if suite was specified, otherwise it
+	  # could exist in another suite
+          mtr_error("Test '$full_name' was not found in suite '$sname'")
+	    if $sname;
+
+	  next;
+        }
+      }
+      else
+      {
+	# No extension was specified, use default
+	$extension= "test";
+	my $full_name= "$testdir/$tname.$extension";
+
+	# Test not found here, could exist in other suite
+	next if ( ! -f $full_name );
+      }
+
+      push(@cases,
+	   collect_one_test_case($suitedir,
+				 $testdir,
+				 $resdir,
+				 $suite,
+				 $tname,
+				 "$tname.$extension",
+				 \%disabled,
+				 $suite_opts));
+    }
+  }
+  else
+  {
+    opendir(TESTDIR, $testdir) or mtr_error("Can't open dir \"$testdir\": $!");
+
+    foreach my $elem ( sort readdir(TESTDIR) )
+    {
+      my $tname= mtr_match_extension($elem, 'test');
+
+      next unless defined $tname;
+
+      # Skip tests that does not match the --do-test= filter
+      next if ($do_test_reg and not $tname =~ /$do_test_reg/o);
+
+      push(@cases,
+	   collect_one_test_case($suitedir,
+				 $testdir,
+				 $resdir,
+				 $suite,
+				 $tname,
+				 $elem,
+				 \%disabled,
+				 $suite_opts));
+    }
+    closedir TESTDIR;
+  }
+
+  #  Return empty list if no testcases found
+  return if (@cases == 0);
+
+  # ----------------------------------------------------------------------
+  # Read combinations for this suite and build testcases x combinations
+  # if any combinations exists
+  # ----------------------------------------------------------------------
+  if ( ! $skip_combinations && ! $quick_collect )
+  {
+    my @combinations;
+    my $combination_file= "$suitedir/combinations";
+    #print "combination_file: $combination_file\n";
+    if (@::opt_combinations)
+    {
+      # take the combination from command-line
+      mtr_verbose("Take the combination from command line");
+      foreach my $combination (@::opt_combinations) {
+	my $comb= {};
+	$comb->{name}= $combination;
+	push(@{$comb->{comb_opt}}, $combination);
+	push(@combinations, $comb);
+      }
+    }
+    elsif (-f $combination_file )
+    {
+      # Read combinations file in my.cnf format
+      mtr_verbose("Read combinations file");
+      my $config= My::Config->new($combination_file);
+      foreach my $group ($config->groups()) {
+	my $comb= {};
+	$comb->{name}= $group->name();
+        foreach my $option ( $group->options() ) {
+	  push(@{$comb->{comb_opt}}, $option->option());
+	}
+	push(@combinations, $comb);
+      }
+    }
+
+    if (@combinations)
+    {
+      print " - adding combinations for $suite\n";
+      #print_testcases(@cases);
+
+      my @new_cases;
+      foreach my $comb (@combinations)
+      {
+	foreach my $test (@cases)
+	{
+
+	  next if ( $test->{'skip'} );
+
+	  # Skip this combination if the values it provides
+	  # already are set in master_opt or slave_opt
+	  if (My::Options::is_set($test->{master_opt}, $comb->{comb_opt}) &&
+	      My::Options::is_set($test->{slave_opt}, $comb->{comb_opt}) ){
+	    next;
+	  }
+
+	  # Copy test options
+	  my $new_test= My::Test->new();
+	  while (my ($key, $value) = each(%$test)) {
+	    if (ref $value eq "ARRAY") {
+	      push(@{$new_test->{$key}}, @$value);
+	    } else {
+	      $new_test->{$key}= $value;
+	    }
+	  }
+
+	  # Append the combination options to master_opt and slave_opt
+	  push(@{$new_test->{master_opt}}, @{$comb->{comb_opt}});
+	  push(@{$new_test->{slave_opt}}, @{$comb->{comb_opt}});
+
+	  # Add combination name short name
+	  $new_test->{combination}= $comb->{name};
+
+	  # Add the new test to new test cases list
+	  push(@new_cases, $new_test);
+	}
+      }
+
+      # Add the plain test if it was not already added
+      # as part of a combination
+      my %added;
+      foreach my $new_test (@new_cases){
+	$added{$new_test->{name}}= 1;
+      }
+      foreach my $test (@cases){
+	push(@new_cases, $test) unless $added{$test->{name}};
+      }
+
+
+      #print_testcases(@new_cases);
+      @cases= @new_cases;
+      #print_testcases(@cases);
+    }
+  }
+
+  optimize_cases(\@cases);
+  #print_testcases(@cases);
+
+  return @cases;
+}
+
+
+
+#
+# Loop through all test cases
+# - optimize which test to run by skipping unnecessary ones
+# - update settings if necessary
+#
+sub optimize_cases {
+  my ($cases)= @_;
+
+  foreach my $tinfo ( @$cases )
+  {
+    # Skip processing if already marked as skipped
+    next if $tinfo->{skip};
+
+    # =======================================================
+    # If a special binlog format was selected with
+    # --mysqld=--binlog-format=x, skip all test that does not
+    # support it
+    # =======================================================
+    #print "binlog_format: $binlog_format\n";
+    if (defined $binlog_format )
+    {
+      # =======================================================
+      # Fixed --binlog-format=x specified on command line
+      # =======================================================
+      if ( defined $tinfo->{'binlog_formats'} )
+      {
+	#print "binlog_formats: ". join(", ", @{$tinfo->{binlog_formats}})."\n";
+
+	# The test supports different binlog formats
+	# check if the selected one is ok
+	my $supported=
+	  grep { $_ eq $binlog_format } @{$tinfo->{'binlog_formats'}};
+	if ( !$supported )
+	{
+	  $tinfo->{'skip'}= 1;
+	  $tinfo->{'comment'}=
+	    "Doesn't support --binlog-format='$binlog_format'";
+	}
+      }
+    }
+    else
+    {
+      # =======================================================
+      # Use dynamic switching of binlog format
+      # =======================================================
+
+      # Get binlog-format used by this test from master_opt
+      my $test_binlog_format;
+      foreach my $opt ( @{$tinfo->{master_opt}} ) {
+	$test_binlog_format=
+	  mtr_match_prefix($opt, "--binlog-format=") || $test_binlog_format;
+      }
+
+      if (defined $test_binlog_format and
+	  defined $tinfo->{binlog_formats} )
+      {
+	my $supported=
+	  grep { $_ eq $test_binlog_format } @{$tinfo->{'binlog_formats'}};
+	if ( !$supported )
+	{
+	  $tinfo->{'skip'}= 1;
+	  $tinfo->{'comment'}=
+	    "Doesn't support --binlog-format='$test_binlog_format'";
+	  next;
+	}
+      }
+    }
+
+    # =======================================================
+    # Check that engine selected by
+    # --default-storage-engine=<engine> is supported
+    # =======================================================
+    my %builtin_engines = ('myisam' => 1, 'memory' => 1, 'csv' => 1);
+
+    foreach my $opt ( @{$tinfo->{master_opt}} ) {
+      my $default_engine=
+	mtr_match_prefix($opt, "--default-storage-engine=");
+
+      # Allow use of uppercase, convert to all lower case
+      $default_engine =~ tr/A-Z/a-z/;
+
+      if (defined $default_engine){
+
+	#print " $tinfo->{name}\n";
+	#print " - The test asked to use '$default_engine'\n";
+
+	#my $engine_value= $::mysqld_variables{$default_engine};
+	#print " - The mysqld_variables says '$engine_value'\n";
+
+	if ( ! exists $::mysqld_variables{$default_engine} and
+	     ! exists $builtin_engines{$default_engine} )
+	{
+	  $tinfo->{'skip'}= 1;
+	  $tinfo->{'comment'}=
+	    "'$default_engine' not supported";
+	}
+
+	$tinfo->{'ndb_test'}= 1
+	  if ( $default_engine =~ /^ndb/i );
+	$tinfo->{'innodb_test'}= 1
+	  if ( $default_engine =~ /^innodb/i );
+      }
+    }
+
+    if ($quick_collect && ! $tinfo->{'skip'})
+    {
+      $some_test_found= 1;
+      return;
+    }
+  }
+}
+
+
+#
+# Read options from the given opt file and append them as an array
+# to $tinfo->{$opt_name}
+#
+sub process_opts_file {
+  my ($tinfo, $opt_file, $opt_name)= @_;
+
+  if ( -f $opt_file )
+  {
+    my $opts= opts_from_file($opt_file);
+
+    foreach my $opt ( @$opts )
+    {
+      my $value;
+
+      # The opt file is used both to send special options to the mysqld
+      # as well as pass special test case specific options to this
+      # script
+
+      $value= mtr_match_prefix($opt, "--timezone=");
+      if ( defined $value )
+      {
+	$tinfo->{'timezone'}= $value;
+	next;
+      }
+
+      $value= mtr_match_prefix($opt, "--result-file=");
+      if ( defined $value )
+      {
+	# Specifies the file mysqltest should compare
+	# output against
+	$tinfo->{'result_file'}= "r/$value.result";
+	next;
+      }
+
+      $value= mtr_match_prefix($opt, "--config-file-template=");
+      if ( defined $value)
+      {
+	# Specifies the configuration file to use for this test
+	$tinfo->{'template_path'}= dirname($tinfo->{path})."/$value";
+	next;
+      }
+
+      # If we set default time zone, remove the one we have
+      $value= mtr_match_prefix($opt, "--default-time-zone=");
+      if ( defined $value )
+      {
+	# Set timezone for this test case to something different
+	$tinfo->{'timezone'}= "GMT-8";
+	# Fallthrough, add the --default-time-zone option
+      }
+
+      # The --restart option forces a restart even if no special
+      # option is set. If the options are the same as next testcase
+      # there is no need to restart after the testcase
+      # has completed
+      if ( $opt eq "--force-restart" )
+      {
+	$tinfo->{'force_restart'}= 1;
+	next;
+      }
+
+      $value= mtr_match_prefix($opt, "--testcase-timeout=");
+      if ( defined $value ) {
+	# Overrides test case timeout for this test
+	$tinfo->{'case-timeout'}= $value;
+	next;
+      }
+
+      # Ok, this was a real option, add it
+      push(@{$tinfo->{$opt_name}}, $opt);
+    }
+  }
+}
+
+##############################################################################
+#
+#  Collect information about a single test case
+#
+##############################################################################
+
+sub collect_one_test_case {
+  my $suitedir=   shift;
+  my $testdir=    shift;
+  my $resdir=     shift;
+  my $suitename=  shift;
+  my $tname=      shift;
+  my $filename=   shift;
+  my $disabled=   shift;
+  my $suite_opts= shift;
+
+  #print "collect_one_test_case\n";
+  #print " suitedir: $suitedir\n";
+  #print " testdir: $testdir\n";
+  #print " resdir: $resdir\n";
+  #print " suitename: $suitename\n";
+  #print " tname: $tname\n";
+  #print " filename: $filename\n";
+
+  # ----------------------------------------------------------------------
+  # Check --start-from
+  # ----------------------------------------------------------------------
+  if ( $start_from )
+  {
+    # start_from can be specified as [suite.].testname_prefix
+    my ($suite, $test, $ext)= split_testname($start_from);
+
+    if ( $suite and $suitename lt $suite){
+      return; # Skip silently
+    }
+    if ( $tname lt $test ){
+      return; # Skip silently
+    }
+  }
+
+  # ----------------------------------------------------------------------
+  # Set defaults
+  # ----------------------------------------------------------------------
+  my $tinfo= My::Test->new
+    (
+     name          => "$suitename.$tname",
+     shortname     => $tname,
+     path          => "$testdir/$filename",
+
+    );
+
+  my $result_file= "$resdir/$tname.result";
+  if (-f $result_file) {
+    # Allow nonexistsing result file
+    # in that case .test must issue "exit" otherwise test
+    # should fail by default
+    $tinfo->{result_file}= $result_file;
+  }
+  else {
+    # No .result file exist
+    # Remember the path  where it should be
+    # saved in case of --record
+    $tinfo->{record_file}= $result_file;
+  }
+
+  # ----------------------------------------------------------------------
+  # Skip some tests but include in list, just mark them as skipped
+  # ----------------------------------------------------------------------
+  if ( $skip_test_reg and $tname =~ /$skip_test_reg/o )
+  {
+    $tinfo->{'skip'}= 1;
+    return $tinfo;
+  }
+
+  # ----------------------------------------------------------------------
+  # Check for disabled tests
+  # ----------------------------------------------------------------------
+  my $marked_as_disabled= 0;
+  if ( $disabled->{$tname} or $disabled->{"$suitename.$tname"} )
+  {
+    # Test was marked as disabled in suites disabled.def file
+    $marked_as_disabled= 1;
+    # Test name may have been disabled with or without suite name part
+    $tinfo->{'comment'}= $disabled->{$tname} || 
+                         $disabled->{"$suitename.$tname"};
+  }
+
+  my $disabled_file= "$testdir/$tname.disabled";
+  if ( -f $disabled_file )
+  {
+    $marked_as_disabled= 1;
+    $tinfo->{'comment'}= mtr_fromfile($disabled_file);
+  }
+
+  if ( $marked_as_disabled )
+  {
+    if ( $enable_disabled )
+    {
+      # User has selected to run all disabled tests
+      mtr_report(" - $tinfo->{name} wil be run although it's been disabled\n",
+		 "  due to '$tinfo->{comment}'");
+    }
+    else
+    {
+      $tinfo->{'skip'}= 1;
+      $tinfo->{'disable'}= 1;   # Sub type of 'skip'
+      return $tinfo;
+    }
+  }
+
+  # ----------------------------------------------------------------------
+  # Append suite extra options to both master and slave
+  # ----------------------------------------------------------------------
+  push(@{$tinfo->{'master_opt'}}, @$suite_opts);
+  push(@{$tinfo->{'slave_opt'}}, @$suite_opts);
+
+  #-----------------------------------------------------------------------
+  # Check for test specific config file
+  #-----------------------------------------------------------------------
+  my $test_cnf_file= "$testdir/$tname.cnf";
+  if ( -f $test_cnf_file) {
+    # Specifies the configuration file to use for this test
+    $tinfo->{'template_path'}= $test_cnf_file;
+  }
+
+  # ----------------------------------------------------------------------
+  # Check for test specific config file
+  # ----------------------------------------------------------------------
+  my $test_cnf_file= "$testdir/$tname.cnf";
+  if ( -f $test_cnf_file ) {
+    # Specifies the configuration file to use for this test
+    $tinfo->{'template_path'}= $test_cnf_file;
+  }
+
+  # ----------------------------------------------------------------------
+  # master sh
+  # ----------------------------------------------------------------------
+  my $master_sh= "$testdir/$tname-master.sh";
+  if ( -f $master_sh )
+  {
+    if ( IS_WIN32PERL )
+    {
+      $tinfo->{'skip'}= 1;
+      $tinfo->{'comment'}= "No tests with sh scripts on Windows";
+      return $tinfo;
+    }
+    else
+    {
+      $tinfo->{'master_sh'}= $master_sh;
+    }
+  }
+
+  # ----------------------------------------------------------------------
+  # slave sh
+  # ----------------------------------------------------------------------
+  my $slave_sh= "$testdir/$tname-slave.sh";
+  if ( -f $slave_sh )
+  {
+    if ( IS_WIN32PERL )
+    {
+      $tinfo->{'skip'}= 1;
+      $tinfo->{'comment'}= "No tests with sh scripts on Windows";
+      return $tinfo;
+    }
+    else
+    {
+      $tinfo->{'slave_sh'}= $slave_sh;
+    }
+  }
+
+  # ----------------------------------------------------------------------
+  # <tname>.slave-mi
+  # ----------------------------------------------------------------------
+  mtr_error("$tname: slave-mi not supported anymore")
+    if ( -f "$testdir/$tname.slave-mi");
+
+
+  tags_from_test_file($tinfo,"$testdir/${tname}.test");
+
+  if ( defined $default_storage_engine )
+  {
+    # Different default engine is used
+    # tag test to require that engine
+    $tinfo->{'ndb_test'}= 1
+      if ( $default_storage_engine =~ /^ndb/i );
+
+    $tinfo->{'innodb_test'}= 1
+      if ( $default_storage_engine =~ /^innodb/i );
+
+  }
+
+  if ( $tinfo->{'big_test'} and ! $::opt_big_test )
+  {
+    $tinfo->{'skip'}= 1;
+    $tinfo->{'comment'}= "Test needs 'big-test' option";
+    return $tinfo
+  }
+
+  if ( $tinfo->{'need_debug'} && ! $::debug_compiled_binaries )
+  {
+    $tinfo->{'skip'}= 1;
+    $tinfo->{'comment'}= "Test needs debug binaries";
+    return $tinfo
+  }
+
+  if ( $tinfo->{'ndb_test'} )
+  {
+    # This is a NDB test
+    if ( $::ndbcluster_enabled == 0)
+    {
+      # ndbcluster is disabled
+      $tinfo->{'skip'}= 1;
+      $tinfo->{'comment'}= "ndbcluster disabled";
+      return $tinfo;
+    }
+  }
+  else
+  {
+    # This is not a ndb test
+    if ( $opt_with_ndbcluster_only )
+    {
+      # Only the ndb test should be run, all other should be skipped
+      $tinfo->{'skip'}= 1;
+      $tinfo->{'comment'}= "Only ndbcluster tests";
+      return $tinfo;
+    }
+  }
+
+  if ($tinfo->{'federated_test'})
+  {
+    # This is a test that needs federated, enable it
+    push(@{$tinfo->{'master_opt'}}, "--loose-federated");
+    push(@{$tinfo->{'slave_opt'}}, "--loose-federated");
+  }
+
+  if ( $tinfo->{'innodb_test'} )
+  {
+    # This is a test that needs innodb
+    if ( $::mysqld_variables{'innodb'} eq "OFF" ||
+         ! exists $::mysqld_variables{'innodb'} )
+    {
+      # innodb is not supported, skip it
+      $tinfo->{'skip'}= 1;
+      # This comment is checked for running with innodb plugin (see above),
+      # please keep that in mind if changing the text.
+      $tinfo->{'comment'}= "No innodb support";
+      # But continue processing if we may run it with innodb plugin
+      return $tinfo unless $do_innodb_plugin;
+    }
+  }
+  elsif ($default_myisam)
+  {
+    # This is a temporary fix to allow non-innodb tests to run even if
+    # the default storage engine is innodb.
+    push(@{$tinfo->{'master_opt'}}, "--default-storage-engine=MyISAM");
+    push(@{$tinfo->{'slave_opt'}}, "--default-storage-engine=MyISAM");
+  }
+
+  if ( $tinfo->{'need_binlog'} )
+  {
+    if (grep(/^--skip-log-bin/,  @::opt_extra_mysqld_opt) )
+    {
+      $tinfo->{'skip'}= 1;
+      $tinfo->{'comment'}= "Test needs binlog";
+      return $tinfo;
+    }
+  }
+  else
+  {
+    # Test does not need binlog, add --skip-binlog to
+    # the options used when starting
+    push(@{$tinfo->{'master_opt'}}, "--loose-skip-log-bin");
+    push(@{$tinfo->{'slave_opt'}}, "--loose-skip-log-bin");
+  }
+
+  if ( $tinfo->{'rpl_test'} )
+  {
+    if ( $skip_rpl )
+    {
+      $tinfo->{'skip'}= 1;
+      $tinfo->{'comment'}= "No replication tests(--skip-rpl)";
+      return $tinfo;
+    }
+  }
+
+  if ( $::opt_embedded_server )
+  {
+    if ( $tinfo->{'not_embedded'} )
+    {
+      $tinfo->{'skip'}= 1;
+      $tinfo->{'comment'}= "Not run for embedded server";
+      return $tinfo;
+    }
+  }
+
+  if ( $tinfo->{'need_ssl'} )
+  {
+    # This is a test that needs ssl
+    if ( ! $::opt_ssl_supported ) {
+      # SSL is not supported, skip it
+      $tinfo->{'skip'}= 1;
+      $tinfo->{'comment'}= "No SSL support";
+      return $tinfo;
+    }
+  }
+
+  # ----------------------------------------------------------------------
+  # Find config file to use if not already selected in <testname>.opt file
+  # ----------------------------------------------------------------------
+  if (defined $defaults_file) {
+    # Using same config file for all tests
+    $tinfo->{template_path}= $defaults_file;
+  }
+  elsif (! $tinfo->{template_path} )
+  {
+    my $config= "$suitedir/my.cnf";
+    if (! -f $config )
+    {
+      # assume default.cnf will be used
+      $config= "include/default_my.cnf";
+
+      # Suite has no config, autodetect which one to use
+      if ( $tinfo->{rpl_test} ){
+	$config= "suite/rpl/my.cnf";
+	if ( $tinfo->{ndb_test} ){
+	  $config= "suite/rpl_ndb/my.cnf";
+	}
+      }
+      elsif ( $tinfo->{ndb_test} ){
+	$config= "suite/ndb/my.cnf";
+      }
+    }
+    $tinfo->{template_path}= $config;
+  }
+
+  # Set extra config file to use
+  if (defined $defaults_extra_file) {
+    $tinfo->{extra_template_path}= $defaults_extra_file;
+  }
+
+  # ----------------------------------------------------------------------
+  # Append mysqld extra options to both master and slave
+  # ----------------------------------------------------------------------
+  push(@{$tinfo->{'master_opt'}}, @::opt_extra_mysqld_opt);
+  push(@{$tinfo->{'slave_opt'}}, @::opt_extra_mysqld_opt);
+
+  # ----------------------------------------------------------------------
+  # Add master opts, extra options only for master
+  # ----------------------------------------------------------------------
+  process_opts_file($tinfo, "$testdir/$tname-master.opt", 'master_opt');
+
+  # ----------------------------------------------------------------------
+  # Add slave opts, list of extra option only for slave
+  # ----------------------------------------------------------------------
+  process_opts_file($tinfo, "$testdir/$tname-slave.opt", 'slave_opt');
+
+  return $tinfo;
+}
+
+
+# List of tags in the .test files that if found should set
+# the specified value in "tinfo"
+my @tags=
+(
+ ["include/have_binlog_format_row.inc", "binlog_formats", ["row"]],
+ ["include/have_binlog_format_statement.inc", "binlog_formats", ["statement"]],
+ ["include/have_binlog_format_mixed.inc", "binlog_formats", ["mixed"]],
+ ["include/have_binlog_format_mixed_or_row.inc",
+  "binlog_formats", ["mixed", "row"]],
+ ["include/have_binlog_format_mixed_or_statement.inc",
+  "binlog_formats", ["mixed", "statement"]],
+ ["include/have_binlog_format_row_or_statement.inc",
+  "binlog_formats", ["row", "statement"]],
+
+ ["include/have_log_bin.inc", "need_binlog", 1],
+
+ ["include/have_innodb.inc", "innodb_test", 1],
+ ["include/big_test.inc", "big_test", 1],
+ ["include/have_debug.inc", "need_debug", 1],
+ ["include/have_ndb.inc", "ndb_test", 1],
+ ["include/have_multi_ndb.inc", "ndb_test", 1],
+ ["include/master-slave.inc", "rpl_test", 1],
+ ["include/ndb_master-slave.inc", "rpl_test", 1],
+ ["include/ndb_master-slave.inc", "ndb_test", 1],
+ ["federated.inc", "federated_test", 1],
+ ["include/not_embedded.inc", "not_embedded", 1],
+ ["include/have_ssl.inc", "need_ssl", 1],
+);
+
+
+sub tags_from_test_file {
+  my $tinfo= shift;
+  my $file= shift;
+  #mtr_verbose("$file");
+  my $F= IO::File->new($file) or mtr_error("can't open file \"$file\": $!");
+
+  while ( my $line= <$F> )
+  {
+
+    # Skip line if it start's with #
+    next if ( $line =~ /^#/ );
+
+    # Match this line against tag in "tags" array
+    foreach my $tag (@tags)
+    {
+      if ( index($line, $tag->[0]) >= 0 )
+      {
+	# Tag matched, assign value to "tinfo"
+	$tinfo->{"$tag->[1]"}= $tag->[2];
+      }
+    }
+
+    # If test sources another file, open it as well
+    if ( $line =~ /^\-\-([[:space:]]*)source(.*)$/ or
+	 $line =~ /^([[:space:]]*)source(.*);$/ )
+    {
+      my $value= $2;
+      $value =~ s/^\s+//;  # Remove leading space
+      $value =~ s/[[:space:]]+$//;  # Remove ending space
+
+      # Sourced file may exist relative to test or
+      # in global location
+      foreach my $sourced_file (dirname($file). "/$value",
+				"$::glob_mysql_test_dir/$value")
+      {
+	if ( -f $sourced_file )
+	{
+	  # Only source the file if it exists, we may get
+	  # false positives in the regexes above if someone
+	  # writes "source nnnn;" in a test case(such as mysqltest.test)
+	  tags_from_test_file($tinfo, $sourced_file);
+	  last;
+	}
+      }
+    }
+
+  }
+}
+
+sub unspace {
+  my $string= shift;
+  my $quote=  shift;
+  $string =~ s/[ \t]/\x11/g;
+  return "$quote$string$quote";
+}
+
+
+sub opts_from_file ($) {
+  my $file=  shift;
+
+  open(FILE,"<",$file) or mtr_error("can't open file \"$file\": $!");
+  my @args;
+  while ( <FILE> )
+  {
+    chomp;
+
+    #    --init_connect=set @a='a\\0c'
+    s/^\s+//;                           # Remove leading space
+    s/\s+$//;                           # Remove ending space
+
+    # This is strange, but we need to fill whitespace inside
+    # quotes with something, to remove later. We do this to
+    # be able to split on space. Else, we have trouble with
+    # options like
+    #
+    #   --someopt="--insideopt1 --insideopt2"
+    #
+    # But still with this, we are not 100% sure it is right,
+    # we need a shell to do it right.
+
+    s/\'([^\'\"]*)\'/unspace($1,"\x0a")/ge;
+    s/\"([^\'\"]*)\"/unspace($1,"\x0b")/ge;
+    s/\'([^\'\"]*)\'/unspace($1,"\x0a")/ge;
+    s/\"([^\'\"]*)\"/unspace($1,"\x0b")/ge;
+
+    foreach my $arg (split(/[ \t]+/))
+    {
+      $arg =~ tr/\x11\x0a\x0b/ \'\"/;     # Put back real chars
+      # The outermost quotes has to go
+      $arg =~ s/^([^\'\"]*)\'(.*)\'([^\'\"]*)$/$1$2$3/
+        or $arg =~ s/^([^\'\"]*)\"(.*)\"([^\'\"]*)$/$1$2$3/;
+      $arg =~ s/\\\\/\\/g;
+
+      # Do not pass empty string since my_getopt is not capable to handle it.
+      if (length($arg)) {
+	push(@args, $arg);
+      }
+    }
+  }
+  close FILE;
+  return \@args;
+}
+
+sub print_testcases {
+  my (@cases)= @_;
+
+  print "=" x 60, "\n";
+  foreach my $test (@cases){
+    $test->print_test();
+  }
+  print "=" x 60, "\n";
+}
+
+
+1;
diff -uNr mysql-5.5.60.orig/mysql-test/mysql-test-run.pl mysql-5.5.60/mysql-test/mysql-test-run.pl
--- mysql-5.5.60.orig/mysql-test/mysql-test-run.pl	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/mysql-test/mysql-test-run.pl	2018-12-02 00:06:23.433892468 +0800
@@ -3392,6 +3392,10 @@
     mtr_appendfile_to_file("$sql_dir/mysql_system_tables_data.sql",
 			   $bootstrap_sql_file);
 
+    mtr_tofile($bootstrap_sql_file, "-- Debian removed the default privileges on the 'test' database\n");
+    mtr_tofile($bootstrap_sql_file, "INSERT INTO mysql.db VALUES ('%','test','','Y','Y','Y','Y','Y','Y','N','Y','Y','Y','Y','Y','Y','Y','Y','N','N','Y','Y');\n");
+    mtr_tofile($bootstrap_sql_file, "INSERT INTO mysql.db VALUES ('%','test\\_%','','Y','Y','Y','Y','Y','Y','N','Y','Y','Y','Y','Y','Y','Y','Y','N','N','Y','Y');\n");
+
     # Add test data for timezone - this is just a subset, on a real
     # system these tables will be populated either by mysql_tzinfo_to_sql
     # or by downloading the timezone table package from our website
diff -uNr mysql-5.5.60.orig/mysql-test/mysql-test-run.pl.orig mysql-5.5.60/mysql-test/mysql-test-run.pl.orig
--- mysql-5.5.60.orig/mysql-test/mysql-test-run.pl.orig	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/mysql-test/mysql-test-run.pl.orig	2018-02-26 21:02:31.000000000 +0800
@@ -0,0 +1,6387 @@
+#!/usr/bin/perl
+# -*- cperl -*-
+
+# Copyright (c) 2004, 2018, Oracle and/or its affiliates. All rights reserved.
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; version 2 of the License.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
+
+#
+##############################################################################
+#
+#  mysql-test-run.pl
+#
+#  Tool used for executing a suite of .test files
+#
+#  See the "MySQL Test framework manual" for more information
+#  http://dev.mysql.com/doc/mysqltest/en/index.html
+#
+#
+##############################################################################
+
+use strict;
+use warnings;
+
+BEGIN {
+  # Check that mysql-test-run.pl is started from mysql-test/
+  unless ( -f "mysql-test-run.pl" )
+  {
+    print "**** ERROR **** ",
+      "You must start mysql-test-run from the mysql-test/ directory\n";
+    exit(1);
+  }
+  # Check that lib exist
+  unless ( -d "lib/" )
+  {
+    print "**** ERROR **** ",
+      "Could not find the lib/ directory \n";
+    exit(1);
+  }
+}
+
+BEGIN {
+  # Check backward compatibility support
+  # By setting the environment variable MTR_VERSION
+  # it's possible to use a previous version of
+  # mysql-test-run.pl
+  my $version= $ENV{MTR_VERSION} || 2;
+  if ( $version == 1 )
+  {
+    print "=======================================================\n";
+    print "  WARNING: Using mysql-test-run.pl version 1!  \n";
+    print "=======================================================\n";
+    # Should use exec() here on *nix but this appears not to work on Windows
+    exit(system($^X, "lib/v1/mysql-test-run.pl", @ARGV) >> 8);
+  }
+  elsif ( $version == 2 )
+  {
+    # This is the current version, just continue
+    ;
+  }
+  else
+  {
+    print "ERROR: Version $version of mysql-test-run does not exist!\n";
+    exit(1);
+  }
+}
+
+use lib "lib";
+
+use Cwd;
+use Getopt::Long;
+use My::File::Path; # Patched version of File::Path
+use File::Basename;
+use File::Copy;
+use File::Find;
+use File::Temp qw/tempdir/;
+use File::Spec::Functions qw/splitdir/;
+use My::Platform;
+use My::SafeProcess;
+use My::ConfigFactory;
+use My::Options;
+use My::Find;
+use My::SysInfo;
+use My::CoreDump;
+use mtr_cases;
+use mtr_report;
+use mtr_match;
+use mtr_unique;
+use mtr_results;
+use IO::Socket::INET;
+use IO::Select;
+
+require "lib/mtr_process.pl";
+require "lib/mtr_io.pl";
+require "lib/mtr_gcov.pl";
+require "lib/mtr_gprof.pl";
+require "lib/mtr_misc.pl";
+
+$SIG{INT}= sub { mtr_error("Got ^C signal"); };
+
+our $mysql_version_id;
+my $mysql_version_extra;
+our $glob_mysql_test_dir;
+our $basedir;
+our $bindir;
+
+our $path_charsetsdir;
+our $path_client_bindir;
+our $path_client_libdir;
+our $path_language;
+
+our $path_current_testlog;
+our $path_testlog;
+
+our $default_vardir;
+our $opt_vardir;                # Path to use for var/ dir
+my $path_vardir_trace;          # unix formatted opt_vardir for trace files
+my $opt_tmpdir;                 # Path to use for tmp/ dir
+my $opt_tmpdir_pid;
+
+my $opt_start;
+my $opt_start_dirty;
+my $opt_start_exit;
+my $start_only;
+
+my $auth_plugin;                # the path to the authentication test plugin
+
+END {
+  if ( defined $opt_tmpdir_pid and $opt_tmpdir_pid == $$ )
+  {
+    if (!$opt_start_exit)
+    {
+      # Remove the tempdir this process has created
+      mtr_verbose("Removing tmpdir $opt_tmpdir");
+      rmtree($opt_tmpdir);
+    }
+    else
+    {
+      mtr_warning("tmpdir $opt_tmpdir should be removed after the server has finished");
+    }
+  }
+}
+
+sub env_or_val($$) { defined $ENV{$_[0]} ? $ENV{$_[0]} : $_[1] }
+
+my $path_config_file;           # The generated config file, var/my.cnf
+
+# Visual Studio produces executables in different sub-directories based on the
+# configuration used to build them.  To make life easier, an environment
+# variable or command-line option may be specified to control which set of
+# executables will be used by the test suite.
+our $opt_vs_config = $ENV{'MTR_VS_CONFIG'};
+
+# If you add a new suite, please check TEST_DIRS in Makefile.am.
+#
+my $DEFAULT_SUITES= "main,sys_vars,binlog,federated,rpl,innodb,innodb_zip,perfschema";
+my $opt_suites;
+
+our $opt_verbose= 0;  # Verbose output, enable with --verbose
+our $exe_mysql;
+our $exe_mysql_plugin;
+our $exe_mysqladmin;
+our $exe_mysqltest;
+our $exe_libtool;
+our $exe_mysql_embedded;
+
+our $opt_big_test= 0;
+
+our @opt_combinations;
+
+our @opt_extra_mysqld_opt;
+our @opt_mysqld_envs;
+
+my $opt_stress;
+
+my $opt_compress;
+my $opt_ssl;
+my $opt_skip_ssl;
+my @opt_skip_test_list;
+our $opt_ssl_supported;
+my $opt_ps_protocol;
+my $opt_sp_protocol;
+my $opt_cursor_protocol;
+my $opt_view_protocol;
+
+our $opt_debug;
+my $debug_d= "d";
+my $opt_debug_common;
+our $opt_debug_server;
+our @opt_cases;                  # The test cases names in argv
+our $opt_embedded_server;
+# -1 indicates use default, override with env.var.
+our $opt_ctest= env_or_val(MTR_UNIT_TESTS => -1);
+our $opt_ctest_report;
+# Unit test report stored here for delayed printing
+my $ctest_report;
+
+# Options used when connecting to an already running server
+my %opts_extern;
+sub using_extern { return (keys %opts_extern > 0);};
+
+our $opt_fast= 0;
+our $opt_force;
+our $opt_mem= $ENV{'MTR_MEM'};
+our $opt_clean_vardir= $ENV{'MTR_CLEAN_VARDIR'};
+
+our $opt_gcov;
+our $opt_gcov_exe= "gcov";
+our $opt_gcov_err= "mysql-test-gcov.err";
+our $opt_gcov_msg= "mysql-test-gcov.msg";
+
+our $opt_gprof;
+our %gprof_dirs;
+
+our $glob_debugger= 0;
+our $opt_gdb;
+our $opt_client_gdb;
+my $opt_boot_gdb;
+our $opt_dbx;
+our $opt_client_dbx;
+my $opt_boot_dbx;
+our $opt_ddd;
+our $opt_client_ddd;
+my $opt_boot_ddd;
+our $opt_manual_gdb;
+our $opt_manual_lldb;
+our $opt_manual_dbx;
+our $opt_manual_ddd;
+our $opt_manual_debug;
+our $opt_debugger;
+our $opt_client_debugger;
+
+my $config; # The currently running config
+my $current_config_name; # The currently running config file template
+
+our @opt_experimentals;
+our $experimental_test_cases= [];
+
+my $baseport;
+# $opt_build_thread may later be set from $opt_port_base
+my $opt_build_thread= $ENV{'MTR_BUILD_THREAD'} || "auto";
+my $opt_port_base= $ENV{'MTR_PORT_BASE'} || "auto";
+my $build_thread= 0;
+
+my $opt_record;
+my $opt_report_features;
+
+our $opt_resfile= $ENV{'MTR_RESULT_FILE'} || 0;
+
+my $opt_skip_core;
+
+our $opt_check_testcases= 1;
+my $opt_mark_progress;
+my $opt_max_connections;
+our $opt_report_times= 0;
+
+my $opt_sleep;
+
+my $opt_testcase_timeout= $ENV{MTR_TESTCASE_TIMEOUT} ||  15; # minutes
+my $opt_suite_timeout   = $ENV{MTR_SUITE_TIMEOUT}    || 300; # minutes
+my $opt_shutdown_timeout= $ENV{MTR_SHUTDOWN_TIMEOUT} ||  10; # seconds
+my $opt_start_timeout   = $ENV{MTR_START_TIMEOUT}    || 180; # seconds
+
+sub suite_timeout { return $opt_suite_timeout * 60; };
+
+my $opt_wait_all;
+my $opt_user_args;
+my $opt_repeat= 1;
+my $opt_retry= 3;
+my $opt_retry_failure= env_or_val(MTR_RETRY_FAILURE => 2);
+my $opt_reorder= 1;
+my $opt_force_restart= 0;
+
+my $opt_strace_client;
+my $opt_strace_server;
+
+our $opt_user = "root";
+
+our $opt_valgrind= 0;
+my $opt_valgrind_mysqld= 0;
+my $opt_valgrind_mysqltest= 0;
+my @default_valgrind_args= ("--show-reachable=yes");
+my @valgrind_args;
+my $opt_valgrind_path;
+my $valgrind_reports= 0;
+my $opt_callgrind;
+my %mysqld_logs;
+my $opt_debug_sync_timeout= 300; # Default timeout for WAIT_FOR actions.
+
+sub testcase_timeout ($) {
+  my ($tinfo)= @_;
+  if (exists $tinfo->{'case-timeout'}) {
+    # Return test specific timeout if *longer* that the general timeout
+    my $test_to= $tinfo->{'case-timeout'};
+    $test_to*= 10 if $opt_valgrind;
+    return $test_to * 60 if $test_to > $opt_testcase_timeout;
+  }
+  return $opt_testcase_timeout * 60;
+}
+
+sub check_timeout ($) { return testcase_timeout($_[0]) / 10; }
+
+our $opt_warnings= 1;
+
+our $ndbcluster_enabled= 0;
+my $opt_include_ndbcluster= 0;
+my $opt_skip_ndbcluster= 0;
+
+my $exe_ndbd;
+my $exe_ndbmtd;
+my $exe_ndb_mgmd;
+my $exe_ndb_waiter;
+my $exe_ndb_mgm;
+
+our $debug_compiled_binaries;
+
+our %mysqld_variables;
+
+my $source_dist= 0;
+
+my $opt_max_save_core= env_or_val(MTR_MAX_SAVE_CORE => 5);
+my $opt_max_save_datadir= env_or_val(MTR_MAX_SAVE_DATADIR => 20);
+my $opt_max_test_fail= env_or_val(MTR_MAX_TEST_FAIL => 10);
+
+my $opt_parallel= $ENV{MTR_PARALLEL} || 1;
+
+select(STDOUT);
+$| = 1; # Automatically flush STDOUT
+
+main();
+
+
+sub main {
+  # Default, verbosity on
+  report_option('verbose', 0);
+
+  # This is needed for test log evaluation in "gen-build-status-page"
+  # in all cases where the calling tool does not log the commands
+  # directly before it executes them, like "make test-force-pl" in RPM builds.
+  mtr_report("Logging: $0 ", join(" ", @ARGV));
+
+  command_line_setup();
+
+  # --help will not reach here, so now it's safe to assume we have binaries
+  My::SafeProcess::find_bin();
+
+  if ( $opt_gcov ) {
+    gcov_prepare($basedir);
+  }
+
+  if (!$opt_suites) {
+    $opt_suites= $DEFAULT_SUITES;
+  }
+  mtr_report("Using suites: $opt_suites") unless @opt_cases;
+
+  init_timers();
+
+  mtr_report("Collecting tests...");
+  my $tests= collect_test_cases($opt_reorder, $opt_suites, \@opt_cases, \@opt_skip_test_list);
+  mark_time_used('collect');
+
+  if ( $opt_report_features ) {
+    # Put "report features" as the first test to run
+    my $tinfo = My::Test->new
+      (
+       name           => 'report_features',
+       # No result_file => Prints result
+       path           => 'include/report-features.test',
+       template_path  => "include/default_my.cnf",
+       master_opt     => [],
+       slave_opt      => [],
+      );
+    unshift(@$tests, $tinfo);
+  }
+
+  initialize_servers();
+
+  #######################################################################
+  my $num_tests= @$tests;
+  if ( $opt_parallel eq "auto" ) {
+    # Try to find a suitable value for number of workers
+    my $sys_info= My::SysInfo->new();
+
+    $opt_parallel= $sys_info->num_cpus();
+    for my $limit (2000, 1500, 1000, 500){
+      $opt_parallel-- if ($sys_info->min_bogomips() < $limit);
+    }
+    my $max_par= $ENV{MTR_MAX_PARALLEL} || 8;
+    $opt_parallel= $max_par if ($opt_parallel > $max_par);
+    $opt_parallel= $num_tests if ($opt_parallel > $num_tests);
+    $opt_parallel= 1 if (IS_WINDOWS and $sys_info->isvm());
+    $opt_parallel= 1 if ($opt_parallel < 1);
+    mtr_report("Using parallel: $opt_parallel");
+  }
+  $ENV{MTR_PARALLEL} = $opt_parallel;
+
+  if ($opt_parallel > 1 && ($opt_start_exit || $opt_stress)) {
+    mtr_warning("Parallel cannot be used with --start-and-exit or --stress\n" .
+               "Setting parallel to 1");
+    $opt_parallel= 1;
+  }
+
+  # Create server socket on any free port
+  my $server = new IO::Socket::INET
+    (
+     LocalAddr => 'localhost',
+     Proto => 'tcp',
+     Listen => $opt_parallel,
+    );
+  mtr_error("Could not create testcase server port: $!") unless $server;
+  my $server_port = $server->sockport();
+
+  if ($opt_resfile) {
+    resfile_init("$opt_vardir/mtr-results.txt");
+    print_global_resfile();
+  }
+
+  # --------------------------------------------------------------------------
+  # Read definitions from include/plugin.defs
+  #
+  read_plugin_defs("include/plugin.defs");
+
+  # Also read from any plugin local or suite specific plugin.defs
+  for (glob "$basedir/plugin/*/tests/mtr/plugin.defs".
+            " $basedir/internal/plugin/*/tests/mtr/plugin.defs".
+            " suite/*/plugin.defs") {
+    read_plugin_defs($_);
+  }
+
+  # Simplify reference to semisync plugins
+  $ENV{'SEMISYNC_PLUGIN_OPT'}= $ENV{'SEMISYNC_MASTER_PLUGIN_OPT'};
+
+  # Create child processes
+  my %children;
+  for my $child_num (1..$opt_parallel){
+    my $child_pid= My::SafeProcess::Base::_safe_fork();
+    if ($child_pid == 0){
+      $server= undef; # Close the server port in child
+      $tests= {}; # Don't need the tests list in child
+
+      # Use subdir of var and tmp unless only one worker
+      if ($opt_parallel > 1) {
+	set_vardir("$opt_vardir/$child_num");
+	$opt_tmpdir= "$opt_tmpdir/$child_num";
+      }
+
+      init_timers();
+      run_worker($server_port, $child_num);
+      exit(1);
+    }
+
+    $children{$child_pid}= 1;
+  }
+  #######################################################################
+
+  mtr_report();
+  mtr_print_thick_line();
+  mtr_print_header($opt_parallel > 1);
+
+  mark_time_used('init');
+
+  my $completed= run_test_server($server, $tests, $opt_parallel);
+
+  exit(0) if $opt_start_exit;
+
+  # Send Ctrl-C to any children still running
+  kill("INT", keys(%children));
+
+  if (!IS_WINDOWS) { 
+    # Wait for children to exit
+    foreach my $pid (keys %children)
+    {
+      my $ret_pid= waitpid($pid, 0);
+      if ($ret_pid != $pid){
+        mtr_report("Unknown process $ret_pid exited");
+      }
+      else {
+        delete $children{$ret_pid};
+      }
+    }
+  }
+
+  if ( not $completed ) {
+    mtr_error("Test suite aborted");
+  }
+
+  if ( @$completed != $num_tests){
+
+    if ($opt_force){
+      # All test should have been run, print any that are still in $tests
+      #foreach my $test ( @$tests ){
+      #  $test->print_test();
+      #}
+    }
+
+    # Not all tests completed, failure
+    mtr_report();
+    mtr_report("Only ", int(@$completed), " of $num_tests completed.");
+    mtr_error("Not all tests completed");
+  }
+
+  mark_time_used('init');
+
+  push @$completed, run_ctest() if $opt_ctest;
+
+  if ($opt_valgrind) {
+    # Create minimalistic "test" for the reporting
+    my $tinfo = My::Test->new
+      (
+       name           => 'valgrind_report',
+      );
+    # Set dummy worker id to align report with normal tests
+    $tinfo->{worker} = 0 if $opt_parallel > 1;
+    if ($valgrind_reports) {
+      $tinfo->{result}= 'MTR_RES_FAILED';
+      $tinfo->{comment}= "Valgrind reported failures at shutdown, see above";
+      $tinfo->{failures}= 1;
+    } else {
+      $tinfo->{result}= 'MTR_RES_PASSED';
+    }
+    mtr_report_test($tinfo);
+    push @$completed, $tinfo;
+  }
+
+  mtr_print_line();
+
+  if ( $opt_gcov ) {
+    gcov_collect($bindir, $opt_gcov_exe,
+		 $opt_gcov_msg, $opt_gcov_err);
+  }
+
+  if ($ctest_report) {
+    print "$ctest_report\n";
+    mtr_print_line();
+  }
+
+  print_total_times($opt_parallel) if $opt_report_times;
+
+  mtr_report_stats("Completed", $completed);
+
+  remove_vardir_subs() if $opt_clean_vardir;
+
+  exit(0);
+}
+
+
+sub run_test_server ($$$) {
+  my ($server, $tests, $childs) = @_;
+
+  my $num_saved_cores= 0;  # Number of core files saved in vardir/log/ so far.
+  my $num_saved_datadir= 0;  # Number of datadirs saved in vardir/log/ so far.
+  my $num_failed_test= 0; # Number of tests failed so far
+
+  # Scheduler variables
+  my $max_ndb= $ENV{MTR_MAX_NDB} || $childs / 2;
+  $max_ndb = $childs if $max_ndb > $childs;
+  $max_ndb = 1 if $max_ndb < 1;
+  my $num_ndb_tests= 0;
+
+  my $completed= [];
+  my %running;
+  my $result;
+  my $exe_mysqld= find_mysqld($basedir) || ""; # Used as hint to CoreDump
+
+  my $suite_timeout= start_timer(suite_timeout());
+
+  my $s= IO::Select->new();
+  $s->add($server);
+  while (1) {
+    mark_time_used('admin');
+    my @ready = $s->can_read(1); # Wake up once every second
+    mark_time_idle();
+    foreach my $sock (@ready) {
+      if ($sock == $server) {
+	# New client connected
+	my $child= $sock->accept();
+	mtr_verbose("Client connected");
+	$s->add($child);
+	print $child "HELLO\n";
+      }
+      else {
+	my $line= <$sock>;
+	if (!defined $line) {
+	  # Client disconnected
+	  mtr_verbose("Child closed socket");
+	  $s->remove($sock);
+	  if (--$childs == 0){
+	    return $completed;
+	  }
+	  next;
+	}
+	chomp($line);
+
+	if ($line eq 'TESTRESULT'){
+	  $result= My::Test::read_test($sock);
+	  # $result->print_test();
+
+	  # Report test status
+	  mtr_report_test($result);
+
+	  if ( $result->is_failed() ) {
+
+	    # Save the workers "savedir" in var/log
+	    my $worker_savedir= $result->{savedir};
+	    my $worker_savename= basename($worker_savedir);
+	    my $savedir= "$opt_vardir/log/$worker_savename";
+
+	    if ($opt_max_save_datadir > 0 &&
+		$num_saved_datadir >= $opt_max_save_datadir)
+	    {
+	      mtr_report(" - skipping '$worker_savedir/'");
+	      rmtree($worker_savedir);
+	    }
+	    else {
+	      mtr_report(" - saving '$worker_savedir/' to '$savedir/'");
+	      rename($worker_savedir, $savedir);
+	      # Move any core files from e.g. mysqltest
+	      foreach my $coref (glob("core*"), glob("*.dmp"))
+	      {
+		mtr_report(" - found '$coref', moving it to '$savedir'");
+                move($coref, $savedir);
+              }
+	      if ($opt_max_save_core > 0) {
+		# Limit number of core files saved
+		find({ no_chdir => 1,
+		       wanted => sub {
+			 my $core_file= $File::Find::name;
+			 my $core_name= basename($core_file);
+
+			 # Name beginning with core, not ending in .gz
+			 if (($core_name =~ /^core/ and $core_name !~ /\.gz$/)
+			     or (IS_WINDOWS and $core_name =~ /\.dmp$/)){
+                                                       # Ending with .dmp
+			   mtr_report(" - found '$core_name'",
+				      "($num_saved_cores/$opt_max_save_core)");
+
+			   My::CoreDump->show($core_file, $exe_mysqld, $opt_parallel);
+
+			   if ($num_saved_cores >= $opt_max_save_core) {
+			     mtr_report(" - deleting it, already saved",
+					"$opt_max_save_core");
+			     unlink("$core_file");
+			   } else {
+			     mtr_compress_file($core_file) unless @opt_cases;
+			   }
+			   ++$num_saved_cores;
+			 }
+		       }
+		     },
+		     $savedir);
+	      }
+	    }
+	    resfile_print_test();
+	    $num_saved_datadir++;
+	    $num_failed_test++ unless ($result->{retries} ||
+                                       $result->{exp_fail});
+
+	    if ( !$opt_force ) {
+	      # Test has failed, force is off
+	      push(@$completed, $result);
+	      return $completed unless $result->{'dont_kill_server'};
+	      # Prevent kill of server, to get valgrind report
+	      print $sock "BYE\n";
+	      next;
+	    }
+	    elsif ($opt_max_test_fail > 0 and
+		   $num_failed_test >= $opt_max_test_fail) {
+	      push(@$completed, $result);
+	      mtr_report_stats("Too many failed", $completed, 1);
+	      mtr_report("Too many tests($num_failed_test) failed!",
+			 "Terminating...");
+	      return undef;
+	    }
+	  }
+
+	  resfile_print_test();
+	  # Retry test run after test failure
+	  my $retries= $result->{retries} || 2;
+	  my $test_has_failed= $result->{failures} || 0;
+	  if ($test_has_failed and $retries <= $opt_retry){
+	    # Test should be run one more time unless it has failed
+	    # too many times already
+	    my $tname= $result->{name};
+	    my $failures= $result->{failures};
+	    if ($opt_retry > 1 and $failures >= $opt_retry_failure){
+	      mtr_report("\nTest $tname has failed $failures times,",
+			 "no more retries!\n");
+	    }
+	    else {
+	      mtr_report("\nRetrying test $tname, ".
+			 "attempt($retries/$opt_retry)...\n");
+              #saving the log file as filename.failed in case of retry
+              if ( $result->is_failed() ) {
+                my $worker_logdir= $result->{savedir};
+                my $log_file_name=dirname($worker_logdir)."/".$result->{shortname}.".log";
+                rename $log_file_name,$log_file_name.".failed";
+              }
+	      delete($result->{result});
+	      $result->{retries}= $retries+1;
+	      $result->write_test($sock, 'TESTCASE');
+	      next;
+	    }
+	  }
+
+	  # Repeat test $opt_repeat number of times
+	  my $repeat= $result->{repeat} || 1;
+	  # Don't repeat if test was skipped
+	  if ($repeat < $opt_repeat && $result->{'result'} ne 'MTR_RES_SKIPPED')
+	  {
+	    $result->{retries}= 0;
+	    $result->{rep_failures}++ if $result->{failures};
+	    $result->{failures}= 0;
+	    delete($result->{result});
+	    $result->{repeat}= $repeat+1;
+	    $result->write_test($sock, 'TESTCASE');
+	    next;
+	  }
+
+	  # Remove from list of running
+	  mtr_error("'", $result->{name},"' is not known to be running")
+	    unless delete $running{$result->key()};
+
+	  # Update scheduler variables
+	  $num_ndb_tests-- if ($result->{ndb_test});
+
+	  # Save result in completed list
+	  push(@$completed, $result);
+
+	}
+	elsif ($line eq 'START'){
+	  ; # Send first test
+	}
+	elsif ($line =~ /^SPENT/) {
+	  add_total_times($line);
+	}
+	elsif ($line eq 'VALGREP' && $opt_valgrind) {
+	  $valgrind_reports= 1;
+	}
+	else {
+	  mtr_error("Unknown response: '$line' from client");
+	}
+
+	# Find next test to schedule
+	# - Try to use same configuration as worker used last time
+	# - Limit number of parallel ndb tests
+
+	my $next;
+	my $second_best;
+	for(my $i= 0; $i <= @$tests; $i++)
+	{
+	  my $t= $tests->[$i];
+
+	  last unless defined $t;
+
+	  if (run_testcase_check_skip_test($t)){
+	    # Move the test to completed list
+	    #mtr_report("skip - Moving test $i to completed");
+	    push(@$completed, splice(@$tests, $i, 1));
+
+	    # Since the test at pos $i was taken away, next
+	    # test will also be at $i -> redo
+	    redo;
+	  }
+
+	  # Limit number of parallell NDB tests
+	  if ($t->{ndb_test} and $num_ndb_tests >= $max_ndb){
+	    #mtr_report("Skipping, num ndb is already at max, $num_ndb_tests");
+	    next;
+	  }
+
+	  # Second best choice is the first that does not fulfill
+	  # any of the above conditions
+	  if (!defined $second_best){
+	    #mtr_report("Setting second_best to $i");
+	    $second_best= $i;
+	  }
+
+	  # Smart allocation of next test within this thread.
+
+	  if ($opt_reorder and $opt_parallel > 1 and defined $result)
+	  {
+	    my $wid= $result->{worker};
+	    # Reserved for other thread, try next
+	    next if (defined $t->{reserved} and $t->{reserved} != $wid);
+	    if (! defined $t->{reserved})
+	    {
+	      # Force-restart not relevant when comparing *next* test
+	      $t->{criteria} =~ s/force-restart$/no-restart/;
+	      my $criteria= $t->{criteria};
+	      # Reserve similar tests for this worker, but not too many
+	      my $maxres= (@$tests - $i) / $opt_parallel + 1;
+	      for (my $j= $i+1; $j <= $i + $maxres; $j++)
+	      {
+		my $tt= $tests->[$j];
+		last unless defined $tt;
+		last if $tt->{criteria} ne $criteria;
+		$tt->{reserved}= $wid;
+	      }
+	    }
+	  }
+
+	  # At this point we have found next suitable test
+	  $next= splice(@$tests, $i, 1);
+	  last;
+	}
+
+	# Use second best choice if no other test has been found
+	if (!$next and defined $second_best){
+	  #mtr_report("Take second best choice $second_best");
+	  mtr_error("Internal error, second best too large($second_best)")
+	    if $second_best >  $#$tests;
+	  $next= splice(@$tests, $second_best, 1);
+	  delete $next->{reserved};
+	}
+
+	if ($next) {
+	  # We don't need this any more
+	  delete $next->{criteria};
+	  $next->write_test($sock, 'TESTCASE');
+	  $running{$next->key()}= $next;
+	  $num_ndb_tests++ if ($next->{ndb_test});
+	}
+	else {
+	  # No more test, tell child to exit
+	  #mtr_report("Saying BYE to child");
+	  print $sock "BYE\n";
+	}
+      }
+    }
+
+    # ----------------------------------------------------
+    # Check if test suite timer expired
+    # ----------------------------------------------------
+    if ( has_expired($suite_timeout) )
+    {
+      mtr_report_stats("Timeout", $completed, 1);
+      mtr_report("Test suite timeout! Terminating...");
+      return undef;
+    }
+  }
+}
+
+
+sub run_worker ($) {
+  my ($server_port, $thread_num)= @_;
+
+  $SIG{INT}= sub { exit(1); };
+
+  # Connect to server
+  my $server = new IO::Socket::INET
+    (
+     PeerAddr => 'localhost',
+     PeerPort => $server_port,
+     Proto    => 'tcp'
+    );
+  mtr_error("Could not connect to server at port $server_port: $!")
+    unless $server;
+
+  # --------------------------------------------------------------------------
+  # Set worker name
+  # --------------------------------------------------------------------------
+  report_option('name',"worker[$thread_num]");
+
+  # --------------------------------------------------------------------------
+  # Set different ports per thread
+  # --------------------------------------------------------------------------
+  set_build_thread_ports($thread_num);
+
+  # --------------------------------------------------------------------------
+  # Turn off verbosity in workers, unless explicitly specified
+  # --------------------------------------------------------------------------
+  report_option('verbose', undef) if ($opt_verbose == 0);
+
+  environment_setup();
+
+  # Read hello from server which it will send when shared
+  # resources have been setup
+  my $hello= <$server>;
+
+  setup_vardir();
+  check_running_as_root();
+
+  if ( using_extern() ) {
+    create_config_file_for_extern(%opts_extern);
+  }
+
+  # Ask server for first test
+  print $server "START\n";
+
+  mark_time_used('init');
+
+  while (my $line= <$server>){
+    chomp($line);
+    if ($line eq 'TESTCASE'){
+      my $test= My::Test::read_test($server);
+      #$test->print_test();
+
+      # Clear comment and logfile, to avoid
+      # reusing them from previous test
+      delete($test->{'comment'});
+      delete($test->{'logfile'});
+
+      # A sanity check. Should this happen often we need to look at it.
+      if (defined $test->{reserved} && $test->{reserved} != $thread_num) {
+	my $tres= $test->{reserved};
+	mtr_warning("Test reserved for w$tres picked up by w$thread_num");
+      }
+      $test->{worker} = $thread_num if $opt_parallel > 1;
+
+      run_testcase($test);
+      #$test->{result}= 'MTR_RES_PASSED';
+      # Send it back, now with results set
+      #$test->print_test();
+      $test->write_test($server, 'TESTRESULT');
+      mark_time_used('restart');
+    }
+    elsif ($line eq 'BYE'){
+      mtr_report("Server said BYE");
+      stop_all_servers($opt_shutdown_timeout);
+      mark_time_used('restart');
+      my $valgrind_reports= 0;
+      if ($opt_valgrind_mysqld) {
+        $valgrind_reports= valgrind_exit_reports();
+	print $server "VALGREP\n" if $valgrind_reports;
+      }
+      if ( $opt_gprof ) {
+	gprof_collect (find_mysqld($basedir), keys %gprof_dirs);
+      }
+      mark_time_used('admin');
+      print_times_used($server, $thread_num);
+      exit($valgrind_reports);
+    }
+    else {
+      mtr_error("Could not understand server, '$line'");
+    }
+  }
+
+  stop_all_servers();
+
+  exit(1);
+}
+
+
+sub ignore_option {
+  my ($opt, $value)= @_;
+  mtr_report("Ignoring option '$opt'");
+}
+
+
+
+# Setup any paths that are $opt_vardir related
+sub set_vardir {
+  my ($vardir)= @_;
+
+  $opt_vardir= $vardir;
+
+  $path_vardir_trace= $opt_vardir;
+  # Chop off any "c:", DBUG likes a unix path ex: c:/src/... => /src/...
+  $path_vardir_trace=~ s/^\w://;
+
+  # Location of my.cnf that all clients use
+  $path_config_file= "$opt_vardir/my.cnf";
+
+  $path_testlog=         "$opt_vardir/log/mysqltest.log";
+  $path_current_testlog= "$opt_vardir/log/current_test";
+
+}
+
+
+sub print_global_resfile {
+  resfile_global("start_time", isotime $^T);
+  resfile_global("user_id", $<);
+  resfile_global("embedded-server", $opt_embedded_server ? 1 : 0);
+  resfile_global("ps-protocol", $opt_ps_protocol ? 1 : 0);
+  resfile_global("sp-protocol", $opt_sp_protocol ? 1 : 0);
+  resfile_global("view-protocol", $opt_view_protocol ? 1 : 0);
+  resfile_global("cursor-protocol", $opt_cursor_protocol ? 1 : 0);
+  resfile_global("ssl", $opt_ssl ? 1 : 0);
+  resfile_global("compress", $opt_compress ? 1 : 0);
+  resfile_global("parallel", $opt_parallel);
+  resfile_global("check-testcases", $opt_check_testcases ? 1 : 0);
+  resfile_global("mysqld", \@opt_extra_mysqld_opt);
+  resfile_global("debug", $opt_debug ? 1 : 0);
+  resfile_global("gcov", $opt_gcov ? 1 : 0);
+  resfile_global("gprof", $opt_gprof ? 1 : 0);
+  resfile_global("valgrind", $opt_valgrind ? 1 : 0);
+  resfile_global("callgrind", $opt_callgrind ? 1 : 0);
+  resfile_global("mem", $opt_mem ? 1 : 0);
+  resfile_global("tmpdir", $opt_tmpdir);
+  resfile_global("vardir", $opt_vardir);
+  resfile_global("fast", $opt_fast ? 1 : 0);
+  resfile_global("force-restart", $opt_force_restart ? 1 : 0);
+  resfile_global("reorder", $opt_reorder ? 1 : 0);
+  resfile_global("sleep", $opt_sleep);
+  resfile_global("repeat", $opt_repeat);
+  resfile_global("user", $opt_user);
+  resfile_global("testcase-timeout", $opt_testcase_timeout);
+  resfile_global("suite-timeout", $opt_suite_timeout);
+  resfile_global("shutdown-timeout", $opt_shutdown_timeout ? 1 : 0);
+  resfile_global("warnings", $opt_warnings ? 1 : 0);
+  resfile_global("max-connections", $opt_max_connections);
+#  resfile_global("default-myisam", $opt_default_myisam ? 1 : 0);
+  resfile_global("product", "MySQL");
+  # Somewhat hacky code to convert numeric version back to dot notation
+  my $v1= int($mysql_version_id / 10000);
+  my $v2= int(($mysql_version_id % 10000)/100);
+  my $v3= $mysql_version_id % 100;
+  resfile_global("version", "$v1.$v2.$v3");
+}
+
+
+
+sub command_line_setup {
+  my $opt_comment;
+  my $opt_usage;
+  my $opt_list_options;
+
+  # Read the command line options
+  # Note: Keep list in sync with usage at end of this file
+  Getopt::Long::Configure("pass_through");
+  my %options=(
+             # Control what engine/variation to run
+             'embedded-server'          => \$opt_embedded_server,
+             'ps-protocol'              => \$opt_ps_protocol,
+             'sp-protocol'              => \$opt_sp_protocol,
+             'view-protocol'            => \$opt_view_protocol,
+             'cursor-protocol'          => \$opt_cursor_protocol,
+             'ssl|with-openssl'         => \$opt_ssl,
+             'skip-ssl'                 => \$opt_skip_ssl,
+             'compress'                 => \$opt_compress,
+             'vs-config=s'              => \$opt_vs_config,
+
+	     # Max number of parallel threads to use
+	     'parallel=s'               => \$opt_parallel,
+
+             # Config file to use as template for all tests
+	     'defaults-file=s'          => \&collect_option,
+	     # Extra config file to append to all generated configs
+	     'defaults-extra-file=s'    => \&collect_option,
+
+             # Control what test suites or cases to run
+             'force'                    => \$opt_force,
+             'with-ndbcluster-only'     => \&collect_option,
+             'ndb|include-ndbcluster'   => \$opt_include_ndbcluster,
+             'skip-ndbcluster|skip-ndb' => \$opt_skip_ndbcluster,
+             'suite|suites=s'           => \$opt_suites,
+             'skip-rpl'                 => \&collect_option,
+             'skip-test=s'              => \&collect_option,
+             'do-test=s'                => \&collect_option,
+             'start-from=s'             => \&collect_option,
+             'big-test'                 => \$opt_big_test,
+	     'combination=s'            => \@opt_combinations,
+             'skip-combinations'        => \&collect_option,
+             'experimental=s'           => \@opt_experimentals,
+	     # skip-im is deprecated and silently ignored
+	     'skip-im'                  => \&ignore_option,
+
+             # Specify ports
+	     'build-thread|mtr-build-thread=i' => \$opt_build_thread,
+	     'port-base|mtr-port-base=i'       => \$opt_port_base,
+
+             # Test case authoring
+             'record'                   => \$opt_record,
+             'check-testcases!'         => \$opt_check_testcases,
+             'mark-progress'            => \$opt_mark_progress,
+
+             # Extra options used when starting mysqld
+             'mysqld=s'                 => \@opt_extra_mysqld_opt,
+             'mysqld-env=s'             => \@opt_mysqld_envs,
+
+             # Run test on running server
+             'extern=s'                  => \%opts_extern, # Append to hash
+
+             # Debugging
+             'debug'                    => \$opt_debug,
+             'debug-common'             => \$opt_debug_common,
+             'debug-server'             => \$opt_debug_server,
+             'gdb'                      => \$opt_gdb,
+             'client-gdb'               => \$opt_client_gdb,
+             'manual-gdb'               => \$opt_manual_gdb,
+             'manual-lldb'              => \$opt_manual_lldb,
+	     'boot-gdb'                 => \$opt_boot_gdb,
+             'manual-debug'             => \$opt_manual_debug,
+             'ddd'                      => \$opt_ddd,
+             'client-ddd'               => \$opt_client_ddd,
+             'manual-ddd'               => \$opt_manual_ddd,
+	     'boot-ddd'                 => \$opt_boot_ddd,
+             'dbx'                      => \$opt_dbx,
+	     'client-dbx'               => \$opt_client_dbx,
+	     'manual-dbx'               => \$opt_manual_dbx,
+	     'debugger=s'               => \$opt_debugger,
+	     'boot-dbx'                 => \$opt_boot_dbx,
+	     'client-debugger=s'        => \$opt_client_debugger,
+             'strace-server'            => \$opt_strace_server,
+             'strace-client'            => \$opt_strace_client,
+             'max-save-core=i'          => \$opt_max_save_core,
+             'max-save-datadir=i'       => \$opt_max_save_datadir,
+             'max-test-fail=i'          => \$opt_max_test_fail,
+
+             # Coverage, profiling etc
+             'gcov'                     => \$opt_gcov,
+             'gprof'                    => \$opt_gprof,
+             'valgrind|valgrind-all'    => \$opt_valgrind,
+             'valgrind-mysqltest'       => \$opt_valgrind_mysqltest,
+             'valgrind-mysqld'          => \$opt_valgrind_mysqld,
+             'valgrind-options=s'       => sub {
+	       my ($opt, $value)= @_;
+	       # Deprecated option unless it's what we know pushbuild uses
+	       if ($value eq "--gen-suppressions=all --show-reachable=yes") {
+		 push(@valgrind_args, $_) for (split(' ', $value));
+		 return;
+	       }
+	       die("--valgrind-options=s is deprecated. Use ",
+		   "--valgrind-option=s, to be specified several",
+		   " times if necessary");
+	     },
+             'valgrind-option=s'        => \@valgrind_args,
+             'valgrind-path=s'          => \$opt_valgrind_path,
+	     'callgrind'                => \$opt_callgrind,
+	     'debug-sync-timeout=i'     => \$opt_debug_sync_timeout,
+
+	     # Directories
+             'tmpdir=s'                 => \$opt_tmpdir,
+             'vardir=s'                 => \$opt_vardir,
+             'mem'                      => \$opt_mem,
+	     'clean-vardir'             => \$opt_clean_vardir,
+             'client-bindir=s'          => \$path_client_bindir,
+             'client-libdir=s'          => \$path_client_libdir,
+
+             # Misc
+             'report-features'          => \$opt_report_features,
+             'comment=s'                => \$opt_comment,
+             'fast'                     => \$opt_fast,
+	     'force-restart'            => \$opt_force_restart,
+             'reorder!'                 => \$opt_reorder,
+             'enable-disabled'          => \&collect_option,
+             'verbose+'                 => \$opt_verbose,
+             'verbose-restart'          => \&report_option,
+             'sleep=i'                  => \$opt_sleep,
+             'start-dirty'              => \$opt_start_dirty,
+             'start-and-exit'           => \$opt_start_exit,
+             'start'                    => \$opt_start,
+	     'user-args'                => \$opt_user_args,
+             'wait-all'                 => \$opt_wait_all,
+	     'print-testcases'          => \&collect_option,
+	     'repeat=i'                 => \$opt_repeat,
+	     'retry=i'                  => \$opt_retry,
+	     'retry-failure=i'          => \$opt_retry_failure,
+             'timer!'                   => \&report_option,
+             'user=s'                   => \$opt_user,
+             'testcase-timeout=i'       => \$opt_testcase_timeout,
+             'suite-timeout=i'          => \$opt_suite_timeout,
+             'shutdown-timeout=i'       => \$opt_shutdown_timeout,
+             'warnings!'                => \$opt_warnings,
+	     'timestamp'                => \&report_option,
+	     'timediff'                 => \&report_option,
+	     'max-connections=i'        => \$opt_max_connections,
+	     'default-myisam!'          => \&collect_option,
+	     'report-times'             => \$opt_report_times,
+	     'result-file'              => \$opt_resfile,
+	     'unit-tests!'              => \$opt_ctest,
+	     'unit-tests-report!'	=> \$opt_ctest_report,
+	     'stress=s'                 => \$opt_stress,
+
+             'help|h'                   => \$opt_usage,
+	     # list-options is internal, not listed in help
+	     'list-options'             => \$opt_list_options,
+             'skip-test-list=s'         => \@opt_skip_test_list
+           );
+
+  GetOptions(%options) or usage("Can't read options");
+
+  usage("") if $opt_usage;
+  list_options(\%options) if $opt_list_options;
+
+  # --------------------------------------------------------------------------
+  # Setup verbosity
+  # --------------------------------------------------------------------------
+  if ($opt_verbose != 0){
+    report_option('verbose', $opt_verbose);
+  }
+
+  if ( -d "../sql" )
+  {
+    $source_dist=  1;
+  }
+
+  # Find the absolute path to the test directory
+  $glob_mysql_test_dir= cwd();
+  if ($glob_mysql_test_dir =~ / /)
+  {
+    die("Working directory \"$glob_mysql_test_dir\" contains space\n".
+	"Bailing out, cannot function properly with space in path");
+  }
+  if (IS_CYGWIN)
+  {
+    # Use mixed path format i.e c:/path/to/
+    $glob_mysql_test_dir= mixed_path($glob_mysql_test_dir);
+  }
+
+  # In most cases, the base directory we find everything relative to,
+  # is the parent directory of the "mysql-test" directory. For source
+  # distributions, TAR binary distributions and some other packages.
+  $basedir= dirname($glob_mysql_test_dir);
+
+  # In the RPM case, binaries and libraries are installed in the
+  # default system locations, instead of having our own private base
+  # directory. And we install "/usr/share/mysql-test". Moving up one
+  # more directory relative to "mysql-test" gives us a usable base
+  # directory for RPM installs.
+  if ( ! $source_dist and ! -d "$basedir/bin" )
+  {
+    $basedir= dirname($basedir);
+  }
+  
+  # Respect MTR_BINDIR variable, which is typically set in to the 
+  # build directory in out-of-source builds.
+  $bindir=$ENV{MTR_BINDIR}||$basedir;
+  
+  # Look for the client binaries directory
+  if ($path_client_bindir)
+  {
+    # --client-bindir=path set on command line, check that the path exists
+    $path_client_bindir= mtr_path_exists($path_client_bindir);
+  }
+  else
+  {
+    $path_client_bindir= mtr_path_exists("$bindir/client_release",
+					 "$bindir/client_debug",
+					 vs_config_dirs('client', ''),
+					 "$bindir/client",
+					 "$bindir/bin");
+  }
+
+  # Look for language files and charsetsdir, use same share
+  $path_language=   mtr_path_exists("$bindir/share/mysql",
+                                    "$bindir/sql/share",
+                                    "$bindir/share");
+  my $path_share= $path_language;
+  $path_charsetsdir =   mtr_path_exists("$basedir/share/mysql/charsets",
+                                    "$basedir/sql/share/charsets",
+                                    "$basedir/share/charsets");
+
+  ($auth_plugin)= find_plugin("auth_test_plugin", "plugin/auth");
+
+  # --debug[-common] implies we run debug server
+  $opt_debug_server= 1 if $opt_debug || $opt_debug_common;
+
+  if (using_extern())
+  {
+    # Connect to the running mysqld and find out what it supports
+    collect_mysqld_features_from_running_server();
+  }
+  else
+  {
+    # Run the mysqld to find out what features are available
+    collect_mysqld_features();
+  }
+
+  if ( $opt_comment )
+  {
+    mtr_report();
+    mtr_print_thick_line('#');
+    mtr_report("# $opt_comment");
+    mtr_print_thick_line('#');
+  }
+
+  if ( @opt_experimentals )
+  {
+    # $^O on Windows considered not generic enough
+    my $plat= (IS_WINDOWS) ? 'windows' : $^O;
+
+    # read the list of experimental test cases from the files specified on
+    # the command line
+    $experimental_test_cases = [];
+    foreach my $exp_file (@opt_experimentals)
+    {
+      open(FILE, "<", $exp_file)
+	or mtr_error("Can't read experimental file: $exp_file");
+      mtr_report("Using experimental file: $exp_file");
+      while(<FILE>) {
+	chomp;
+	# remove comments (# foo) at the beginning of the line, or after a 
+	# blank at the end of the line
+	s/(\s+|^)#.*$//;
+	# If @ platform specifier given, use this entry only if it contains
+	# @<platform> or @!<xxx> where xxx != platform
+	if (/\@.*/)
+	{
+	  next if (/\@!$plat/);
+	  next unless (/\@$plat/ or /\@!/);
+	  # Then remove @ and everything after it
+	  s/\@.*$//;
+	}
+	# remove whitespace
+	s/^\s+//;
+	s/\s+$//;
+	# if nothing left, don't need to remember this line
+	if ( $_ eq "" ) {
+	  next;
+	}
+	# remember what is left as the name of another test case that should be
+	# treated as experimental
+	print " - $_\n";
+	push @$experimental_test_cases, $_;
+      }
+      close FILE;
+    }
+  }
+
+  foreach my $arg ( @ARGV )
+  {
+    if ( $arg =~ /^--skip-/ )
+    {
+      push(@opt_extra_mysqld_opt, $arg);
+    }
+    elsif ( $arg =~ /^--$/ )
+    {
+      # It is an effect of setting 'pass_through' in option processing
+      # that the lone '--' separating options from arguments survives,
+      # simply ignore it.
+    }
+    elsif ( $arg =~ /^-/ )
+    {
+      usage("Invalid option \"$arg\"");
+    }
+    else
+    {
+      push(@opt_cases, $arg);
+    }
+  }
+
+  # --------------------------------------------------------------------------
+  # Find out type of logging that are being used
+  # --------------------------------------------------------------------------
+  foreach my $arg ( @opt_extra_mysqld_opt )
+  {
+    if ( $arg =~ /binlog[-_]format=(\S+)/ )
+    {
+      # Save this for collect phase
+      collect_option('binlog-format', $1);
+      mtr_report("Using binlog format '$1'");
+    }
+  }
+
+
+  # --------------------------------------------------------------------------
+  # Find out default storage engine being used(if any)
+  # --------------------------------------------------------------------------
+  foreach my $arg ( @opt_extra_mysqld_opt )
+  {
+    if ( $arg =~ /default-storage-engine=(\S+)/ )
+    {
+      # Save this for collect phase
+      collect_option('default-storage-engine', $1);
+      mtr_report("Using default engine '$1'")
+    }
+  }
+
+  if (IS_WINDOWS and defined $opt_mem) {
+    mtr_report("--mem not supported on Windows, ignored");
+    $opt_mem= undef;
+  }
+
+  if ($opt_port_base ne "auto")
+  {
+    if (my $rem= $opt_port_base % 10)
+    {
+      mtr_warning ("Port base $opt_port_base rounded down to multiple of 10");
+      $opt_port_base-= $rem;
+    }
+    $opt_build_thread= $opt_port_base / 10 - 1000;
+  }
+
+  # --------------------------------------------------------------------------
+  # Check if we should speed up tests by trying to run on tmpfs
+  # --------------------------------------------------------------------------
+  if ( defined $opt_mem)
+  {
+    mtr_error("Can't use --mem and --vardir at the same time ")
+      if $opt_vardir;
+    mtr_error("Can't use --mem and --tmpdir at the same time ")
+      if $opt_tmpdir;
+
+    # Search through list of locations that are known
+    # to be "fast disks" to find a suitable location
+    # Use --mem=<dir> as first location to look.
+    my @tmpfs_locations= ($opt_mem, "/dev/shm", "/tmp");
+
+    foreach my $fs (@tmpfs_locations)
+    {
+      if ( -d $fs )
+      {
+	my $template= "var_${opt_build_thread}_XXXX";
+	$opt_mem= tempdir( $template, DIR => $fs, CLEANUP => 0);
+	last;
+      }
+    }
+  }
+
+  # --------------------------------------------------------------------------
+  # Set the "var/" directory, the base for everything else
+  # --------------------------------------------------------------------------
+  if(defined $ENV{MTR_BINDIR})
+  {
+    $default_vardir= "$ENV{MTR_BINDIR}/mysql-test/var";
+  }
+  else
+  {
+    $default_vardir= "$glob_mysql_test_dir/var";
+  }
+  if ( ! $opt_vardir )
+  {
+    $opt_vardir= $default_vardir;
+  }
+
+  # We make the path absolute, as the server will do a chdir() before usage
+  unless ( $opt_vardir =~ m,^/, or
+           (IS_WINDOWS and $opt_vardir =~ m,^[a-z]:[/\\],i) )
+  {
+    # Make absolute path, relative test dir
+    $opt_vardir= "$glob_mysql_test_dir/$opt_vardir";
+  }
+
+  set_vardir($opt_vardir);
+
+  # --------------------------------------------------------------------------
+  # Set the "tmp" directory
+  # --------------------------------------------------------------------------
+  if ( ! $opt_tmpdir )
+  {
+    $opt_tmpdir=       "$opt_vardir/tmp" unless $opt_tmpdir;
+
+    if (check_socket_path_length("$opt_tmpdir/mysql_testsocket.sock"))
+    {
+      mtr_report("Too long tmpdir path '$opt_tmpdir'",
+		 " creating a shorter one...");
+
+      # Create temporary directory in standard location for temporary files
+      $opt_tmpdir= tempdir( TMPDIR => 1, CLEANUP => 0 );
+      mtr_report(" - using tmpdir: '$opt_tmpdir'\n");
+
+      # Remember pid that created dir so it's removed by correct process
+      $opt_tmpdir_pid= $$;
+    }
+  }
+  $opt_tmpdir =~ s,/+$,,;       # Remove ending slash if any
+
+  # --------------------------------------------------------------------------
+  # fast option
+  # --------------------------------------------------------------------------
+  if ($opt_fast){
+    $opt_shutdown_timeout= 0; # Kill processes instead of nice shutdown
+  }
+
+  # --------------------------------------------------------------------------
+  # Check parallel value
+  # --------------------------------------------------------------------------
+  if ($opt_parallel ne "auto" && $opt_parallel < 1)
+  {
+    mtr_error("0 or negative parallel value makes no sense, use 'auto' or positive number");
+  }
+
+  # --------------------------------------------------------------------------
+  # Record flag
+  # --------------------------------------------------------------------------
+  if ( $opt_record and ! @opt_cases )
+  {
+    mtr_error("Will not run in record mode without a specific test case");
+  }
+
+  if ( $opt_record ) {
+    # Use only one worker with --record
+    $opt_parallel= 1;
+  }
+
+  # --------------------------------------------------------------------------
+  # Embedded server flag
+  # --------------------------------------------------------------------------
+  if ( $opt_embedded_server )
+  {
+    if ( IS_WINDOWS )
+    {
+      # Add the location for libmysqld.dll to the path.
+      my $separator= ";";
+      my $lib_mysqld=
+        mtr_path_exists("$bindir/lib", vs_config_dirs('libmysqld',''));
+      if ( IS_CYGWIN )
+      {
+	$lib_mysqld= posix_path($lib_mysqld);
+	$separator= ":";
+      }
+      $ENV{'PATH'}= "$ENV{'PATH'}".$separator.$lib_mysqld;
+    }
+    $opt_skip_ssl= 1;              # Turn off use of SSL
+
+    # Turn off use of bin log
+    push(@opt_extra_mysqld_opt, "--skip-log-bin");
+
+    if ( using_extern() )
+    {
+      mtr_error("Can't use --extern with --embedded-server");
+    }
+
+
+    if ($opt_gdb)
+    {
+      mtr_warning("Silently converting --gdb to --client-gdb in embedded mode");
+      $opt_client_gdb= $opt_gdb;
+      $opt_gdb= undef;
+    }
+
+    if ($opt_ddd)
+    {
+      mtr_warning("Silently converting --ddd to --client-ddd in embedded mode");
+      $opt_client_ddd= $opt_ddd;
+      $opt_ddd= undef;
+    }
+
+    if ($opt_dbx) {
+      mtr_warning("Silently converting --dbx to --client-dbx in embedded mode");
+      $opt_client_dbx= $opt_dbx;
+      $opt_dbx= undef;
+    }
+
+    if ($opt_debugger)
+    {
+      mtr_warning("Silently converting --debugger to --client-debugger in embedded mode");
+      $opt_client_debugger= $opt_debugger;
+      $opt_debugger= undef;
+    }
+
+    if ( $opt_gdb || $opt_ddd || $opt_manual_gdb || $opt_manual_lldb || 
+         $opt_manual_ddd || $opt_manual_debug || $opt_debugger || $opt_dbx || 
+         $opt_manual_dbx)
+    {
+      mtr_error("You need to use the client debug options for the",
+		"embedded server. Ex: --client-gdb");
+    }
+  }
+
+  # --------------------------------------------------------------------------
+  # Big test flags
+  # --------------------------------------------------------------------------
+   if ( $opt_big_test )
+   {
+     $ENV{'BIG_TEST'}= 1;
+   }
+
+  # --------------------------------------------------------------------------
+  # Gcov flag
+  # --------------------------------------------------------------------------
+  if ( ($opt_gcov or $opt_gprof) and ! $source_dist )
+  {
+    mtr_error("Coverage test needs the source - please use source dist");
+  }
+
+  # --------------------------------------------------------------------------
+  # Check debug related options
+  # --------------------------------------------------------------------------
+  if ( $opt_gdb || $opt_client_gdb || $opt_ddd || $opt_client_ddd || 
+       $opt_manual_gdb || $opt_manual_lldb || $opt_manual_ddd || 
+       $opt_manual_debug || $opt_dbx || $opt_client_dbx || $opt_manual_dbx || 
+       $opt_debugger || $opt_client_debugger )
+  {
+    # Indicate that we are using debugger
+    $glob_debugger= 1;
+    if ( using_extern() )
+    {
+      mtr_error("Can't use --extern when using debugger");
+    }
+    # Set one week timeout (check-testcase timeout will be 1/10th)
+    $opt_testcase_timeout= 7 * 24 * 60;
+    $opt_suite_timeout= 7 * 24 * 60;
+    # One day to shutdown
+    $opt_shutdown_timeout= 24 * 60;
+    # One day for PID file creation (this is given in seconds not minutes)
+    $opt_start_timeout= 24 * 60 * 60;
+  }
+
+  # --------------------------------------------------------------------------
+  # Modified behavior with --start options
+  # --------------------------------------------------------------------------
+  if ($opt_start or $opt_start_dirty or $opt_start_exit) {
+    collect_option ('quick-collect', 1);
+    $start_only= 1;
+  }
+
+  # --------------------------------------------------------------------------
+  # Check use of user-args
+  # --------------------------------------------------------------------------
+
+  if ($opt_user_args) {
+    mtr_error("--user-args only valid with --start options")
+      unless $start_only;
+    mtr_error("--user-args cannot be combined with named suites or tests")
+      if $opt_suites || @opt_cases;
+  }
+
+  # --------------------------------------------------------------------------
+  # Set default values for opt_ctest (--unit-tests)
+  # --------------------------------------------------------------------------
+
+  if ($opt_ctest == -1) {
+    if (defined $opt_ctest_report && $opt_ctest_report) {
+      # Turn on --unit-tests by default if --unit-tests-report is used
+      $opt_ctest= 1;
+    } elsif ($opt_suites || @opt_cases) {
+      # Don't run ctest if tests or suites named
+      $opt_ctest= 0;
+    } elsif (defined $ENV{PB2WORKDIR}) {
+      # Override: disable if running in the PB test environment
+      $opt_ctest= 0;
+    }
+  }
+
+  # --------------------------------------------------------------------------
+  # Check use of wait-all
+  # --------------------------------------------------------------------------
+
+  if ($opt_wait_all && ! $start_only)
+  {
+    mtr_error("--wait-all can only be used with --start options");
+  }
+
+  # --------------------------------------------------------------------------
+  # Gather stress-test options and modify behavior
+  # --------------------------------------------------------------------------
+
+  if ($opt_stress)
+  {
+    $opt_stress=~ s/,/ /g;
+    $opt_user_args= 1;
+    mtr_error("--stress cannot be combined with named ordinary suites or tests")
+      if $opt_suites || @opt_cases;
+    $opt_suites="stress";
+    @opt_cases= ("wrapper");
+    $ENV{MST_OPTIONS}= $opt_stress;
+    $opt_ctest= 0;
+  }
+
+  # --------------------------------------------------------------------------
+  # Check timeout arguments
+  # --------------------------------------------------------------------------
+
+  mtr_error("Invalid value '$opt_testcase_timeout' supplied ".
+	    "for option --testcase-timeout")
+    if ($opt_testcase_timeout <= 0);
+  mtr_error("Invalid value '$opt_suite_timeout' supplied ".
+	    "for option --testsuite-timeout")
+    if ($opt_suite_timeout <= 0);
+
+  # --------------------------------------------------------------------------
+  # Check valgrind arguments
+  # --------------------------------------------------------------------------
+  if ( $opt_valgrind or $opt_valgrind_path or @valgrind_args)
+  {
+    mtr_report("Turning on valgrind for all executables");
+    $opt_valgrind= 1;
+    $opt_valgrind_mysqld= 1;
+    $opt_valgrind_mysqltest= 1;
+
+    # Increase the timeouts when running with valgrind
+    $opt_testcase_timeout*= 10;
+    $opt_suite_timeout*= 6;
+    $opt_start_timeout*= 10;
+
+  }
+  elsif ( $opt_valgrind_mysqld )
+  {
+    mtr_report("Turning on valgrind for mysqld(s) only");
+    $opt_valgrind= 1;
+  }
+  elsif ( $opt_valgrind_mysqltest )
+  {
+    mtr_report("Turning on valgrind for mysqltest and mysql_client_test only");
+    $opt_valgrind= 1;
+  }
+
+  if ( $opt_callgrind )
+  {
+    mtr_report("Turning on valgrind with callgrind for mysqld(s)");
+    $opt_valgrind= 1;
+    $opt_valgrind_mysqld= 1;
+
+    # Set special valgrind options unless options passed on command line
+    push(@valgrind_args, "--trace-children=yes")
+      unless @valgrind_args;
+  }
+
+  if ( $opt_valgrind )
+  {
+    # Set valgrind_options to default unless already defined
+    push(@valgrind_args, @default_valgrind_args)
+      unless @valgrind_args;
+
+    # Don't add --quiet; you will loose the summary reports.
+
+    mtr_report("Running valgrind with options \"",
+	       join(" ", @valgrind_args), "\"");
+  }
+
+  if ($opt_debug_common)
+  {
+    $opt_debug= 1;
+    $debug_d= "d,query,info,error,enter,exit";
+  }
+
+  if ( $opt_strace_server && ($^O ne "linux") )
+  {
+    $opt_strace_server=0;
+    mtr_warning("Strace only supported in Linux ");
+  }
+
+  if ( $opt_strace_client && ($^O ne "linux") )
+  {
+    $opt_strace_client=0;
+    mtr_warning("Strace only supported in Linux ");
+  }
+
+
+  mtr_report("Checking supported features...");
+
+  check_ndbcluster_support(\%mysqld_variables);
+  check_ssl_support(\%mysqld_variables);
+  check_debug_support(\%mysqld_variables);
+
+  executable_setup();
+
+}
+
+
+#
+# To make it easier for different devs to work on the same host,
+# an environment variable can be used to control all ports. A small
+# number is to be used, 0 - 16 or similar.
+#
+# Note the MASTER_MYPORT has to be set the same in all 4.x and 5.x
+# versions of this script, else a 4.0 test run might conflict with a
+# 5.1 test run, even if different MTR_BUILD_THREAD is used. This means
+# all port numbers might not be used in this version of the script.
+#
+# Also note the limitation of ports we are allowed to hand out. This
+# differs between operating systems and configuration, see
+# http://www.ncftp.com/ncftpd/doc/misc/ephemeral_ports.html
+# But a fairly safe range seems to be 5001 - 32767
+#
+sub set_build_thread_ports($) {
+  my $thread= shift || 0;
+
+  if ( lc($opt_build_thread) eq 'auto' ) {
+    my $found_free = 0;
+    $build_thread = 300;	# Start attempts from here
+    while (! $found_free)
+    {
+      $build_thread= mtr_get_unique_id($build_thread, 349);
+      if ( !defined $build_thread ) {
+        mtr_error("Could not get a unique build thread id");
+      }
+      $found_free= check_ports_free($build_thread);
+      # If not free, release and try from next number
+      if (! $found_free) {
+        mtr_release_unique_id();
+        $build_thread++;
+      }
+    }
+  }
+  else
+  {
+    $build_thread = $opt_build_thread + $thread - 1;
+    if (! check_ports_free($build_thread)) {
+      # Some port was not free(which one has already been printed)
+      mtr_error("Some port(s) was not free")
+    }
+  }
+  $ENV{MTR_BUILD_THREAD}= $build_thread;
+
+  # Calculate baseport
+  $baseport= $build_thread * 10 + 10000;
+  if ( $baseport < 5001 or $baseport + 9 >= 32767 )
+  {
+    mtr_error("MTR_BUILD_THREAD number results in a port",
+              "outside 5001 - 32767",
+              "($baseport - $baseport + 9)");
+  }
+
+  mtr_report("Using MTR_BUILD_THREAD $build_thread,",
+	     "with reserved ports $baseport..".($baseport+9));
+
+}
+
+
+sub collect_mysqld_features {
+  my $found_variable_list_start= 0;
+  my $use_tmpdir;
+  if ( defined $opt_tmpdir and -d $opt_tmpdir){
+    # Create the tempdir in $opt_tmpdir
+    $use_tmpdir= $opt_tmpdir;
+  }
+  my $tmpdir= tempdir(CLEANUP => 0, # Directory removed by this function
+		      DIR => $use_tmpdir);
+
+  #
+  # Execute "mysqld --no-defaults --help --verbose" to get a
+  # list of all features and settings
+  #
+  # --no-defaults and --skip-grant-tables are to avoid loading
+  # system-wide configs and plugins
+  #
+  # --datadir must exist, mysqld will chdir into it
+  #
+  my $args;
+  mtr_init_args(\$args);
+  mtr_add_arg($args, "--no-defaults");
+  mtr_add_arg($args, "--datadir=%s", mixed_path($tmpdir));
+  mtr_add_arg($args, "--secure-file-priv=\"\"");
+  mtr_add_arg($args, "--lc-messages-dir=%s", $path_language);
+  mtr_add_arg($args, "--skip-grant-tables");
+  mtr_add_arg($args, "--verbose");
+  mtr_add_arg($args, "--help");
+
+  # Need --user=root if running as *nix root user
+  if (!IS_WINDOWS and $> == 0)
+  {
+    mtr_add_arg($args, "--user=root");
+  }
+
+  my $exe_mysqld= find_mysqld($basedir);
+  my $cmd= join(" ", $exe_mysqld, @$args);
+  my $list= `$cmd`;
+
+  foreach my $line (split('\n', $list))
+  {
+    # First look for version
+    if ( !$mysql_version_id )
+    {
+      # Look for version
+      my $exe_name= basename($exe_mysqld);
+      mtr_verbose("exe_name: $exe_name");
+      if ( $line =~ /^\S*$exe_name\s\sVer\s([0-9]*)\.([0-9]*)\.([0-9]*)([^\s]*)/ )
+      {
+	#print "Major: $1 Minor: $2 Build: $3\n";
+	$mysql_version_id= $1*10000 + $2*100 + $3;
+	#print "mysql_version_id: $mysql_version_id\n";
+	mtr_report("MySQL Version $1.$2.$3");
+	$mysql_version_extra= $4;
+      }
+    }
+    else
+    {
+      if (!$found_variable_list_start)
+      {
+	# Look for start of variables list
+	if ( $line =~ /[\-]+\s[\-]+/ )
+	{
+	  $found_variable_list_start= 1;
+	}
+      }
+      else
+      {
+	# Put variables into hash
+	if ( $line =~ /^([\S]+)[ \t]+(.*?)\r?$/ )
+	{
+	  # print "$1=\"$2\"\n";
+	  $mysqld_variables{$1}= $2;
+	}
+	else
+	{
+	  # The variable list is ended with a blank line
+	  if ( $line =~ /^[\s]*$/ )
+	  {
+	    last;
+	  }
+	  else
+	  {
+	    # Send out a warning, we should fix the variables that has no
+	    # space between variable name and it's value
+	    # or should it be fixed width column parsing? It does not
+	    # look like that in function my_print_variables in my_getopt.c
+	    mtr_warning("Could not parse variable list line : $line");
+	  }
+	}
+      }
+    }
+  }
+  rmtree($tmpdir);
+  mtr_error("Could not find version of MySQL") unless $mysql_version_id;
+  mtr_error("Could not find variabes list") unless $found_variable_list_start;
+
+}
+
+
+
+sub collect_mysqld_features_from_running_server ()
+{
+  my $mysql= mtr_exe_exists("$path_client_bindir/mysql");
+
+  my $args;
+  mtr_init_args(\$args);
+
+  mtr_add_arg($args, "--no-defaults");
+  mtr_add_arg($args, "--user=%s", $opt_user);
+
+  while (my ($option, $value)= each( %opts_extern )) {
+    mtr_add_arg($args, "--$option=$value");
+  }
+
+  mtr_add_arg($args, "--silent"); # Tab separated output
+  mtr_add_arg($args, "-e '%s'", "use mysql; SHOW VARIABLES");
+  my $cmd= "$mysql " . join(' ', @$args);
+  mtr_verbose("cmd: $cmd");
+
+  my $list = `$cmd` or
+    mtr_error("Could not connect to extern server using command: '$cmd'");
+  foreach my $line (split('\n', $list ))
+  {
+    # Put variables into hash
+    if ( $line =~ /^([\S]+)[ \t]+(.*?)\r?$/ )
+    {
+      # print "$1=\"$2\"\n";
+      $mysqld_variables{$1}= $2;
+    }
+  }
+
+  # "Convert" innodb flag
+  $mysqld_variables{'innodb'}= "ON"
+    if ($mysqld_variables{'have_innodb'} eq "YES");
+
+  # Parse version
+  my $version_str= $mysqld_variables{'version'};
+  if ( $version_str =~ /^([0-9]*)\.([0-9]*)\.([0-9]*)([^\s]*)/ )
+  {
+    #print "Major: $1 Minor: $2 Build: $3\n";
+    $mysql_version_id= $1*10000 + $2*100 + $3;
+    #print "mysql_version_id: $mysql_version_id\n";
+    mtr_report("MySQL Version $1.$2.$3");
+    $mysql_version_extra= $4;
+  }
+  mtr_error("Could not find version of MySQL") unless $mysql_version_id;
+}
+
+sub find_mysqld {
+
+  my ($mysqld_basedir)= $ENV{MTR_BINDIR}|| @_;
+
+  my @mysqld_names= ("mysqld", "mysqld-max-nt", "mysqld-max",
+		     "mysqld-nt");
+
+  if ( $opt_debug_server ){
+    # Put mysqld-debug first in the list of binaries to look for
+    mtr_verbose("Adding mysqld-debug first in list of binaries to look for");
+    unshift(@mysqld_names, "mysqld-debug");
+  }
+
+  return my_find_bin($mysqld_basedir,
+		     ["sql", "libexec", "sbin", "bin"],
+		     [@mysqld_names]);
+}
+
+
+sub executable_setup () {
+
+  #
+  # Check if libtool is available in this distribution/clone
+  # we need it when valgrinding or debugging non installed binary
+  # Otherwise valgrind will valgrind the libtool wrapper or bash
+  # and gdb will not find the real executable to debug
+  #
+  if ( -x "../libtool")
+  {
+    $exe_libtool= "../libtool";
+    if ($opt_valgrind or $glob_debugger)
+    {
+      mtr_report("Using \"$exe_libtool\" when running valgrind or debugger");
+    }
+  }
+
+  # Look for the client binaries
+  $exe_mysqladmin=     mtr_exe_exists("$path_client_bindir/mysqladmin");
+  $exe_mysql=          mtr_exe_exists("$path_client_bindir/mysql");
+  $exe_mysql_plugin=   mtr_exe_exists("$path_client_bindir/mysql_plugin");
+
+  $exe_mysql_embedded= mtr_exe_maybe_exists("$basedir/libmysqld/examples/mysql_embedded");
+
+  if ( $ndbcluster_enabled )
+  {
+    # Look for single threaded NDB
+    $exe_ndbd=
+      my_find_bin($bindir,
+		  ["storage/ndb/src/kernel", "libexec", "sbin", "bin"],
+		  "ndbd");
+
+    # Look for multi threaded NDB
+    $exe_ndbmtd=
+      my_find_bin($bindir,
+		  ["storage/ndb/src/kernel", "libexec", "sbin", "bin"],
+		  "ndbmtd", NOT_REQUIRED);
+    if ($exe_ndbmtd)
+    {
+      my $mtr_ndbmtd = $ENV{MTR_NDBMTD};
+      if ($mtr_ndbmtd)
+      {
+	mtr_report(" - multi threaded ndbd found, will be used always");
+	$exe_ndbd = $exe_ndbmtd;
+      }
+      else
+      {
+	mtr_report(" - multi threaded ndbd found, will be ".
+		   "used \"round robin\"");
+      }
+    }
+
+    $exe_ndb_mgmd=
+      my_find_bin($bindir,
+		  ["storage/ndb/src/mgmsrv", "libexec", "sbin", "bin"],
+		  "ndb_mgmd");
+
+    $exe_ndb_mgm=
+      my_find_bin($bindir,
+                  ["storage/ndb/src/mgmclient", "bin"],
+                  "ndb_mgm");
+
+    $exe_ndb_waiter=
+      my_find_bin($bindir,
+		  ["storage/ndb/tools/", "bin"],
+		  "ndb_waiter");
+
+  }
+
+  # Look for mysqltest executable
+  if ( $opt_embedded_server )
+  {
+    $exe_mysqltest=
+      mtr_exe_exists(vs_config_dirs('libmysqld/examples','mysqltest_embedded'),
+                     "$basedir/libmysqld/examples/mysqltest_embedded",
+                     "$path_client_bindir/mysqltest_embedded");
+  }
+  else
+  {
+    if ( defined $ENV{'MYSQL_TEST'} )
+    {
+      $exe_mysqltest=$ENV{'MYSQL_TEST'};
+      print "===========================================================\n";
+      print "WARNING:The mysqltest binary is fetched from $exe_mysqltest\n";
+      print "===========================================================\n";
+    }
+    else
+    {
+      $exe_mysqltest= mtr_exe_exists("$path_client_bindir/mysqltest");
+    }
+  }
+
+}
+
+
+sub client_debug_arg($$) {
+  my ($args, $client_name)= @_;
+
+  # Workaround for Bug #50627: drop any debug opt
+  return if $client_name =~ /^mysqlbinlog/;
+
+  if ( $opt_debug ) {
+    mtr_add_arg($args,
+		"--loose-debug=$debug_d:t:A,%s/log/%s.trace",
+		$path_vardir_trace, $client_name)
+  }
+}
+
+
+sub client_arguments ($;$) {
+ my $client_name= shift;
+  my $group_suffix= shift;
+  my $client_exe= mtr_exe_exists("$path_client_bindir/$client_name");
+
+  my $args;
+  mtr_init_args(\$args);
+  mtr_add_arg($args, "--defaults-file=%s", $path_config_file);
+  if (defined($group_suffix)) {
+    mtr_add_arg($args, "--defaults-group-suffix=%s", $group_suffix);
+    client_debug_arg($args, "$client_name-$group_suffix");
+  }
+  else
+  {
+    client_debug_arg($args, $client_name);
+  }
+  return mtr_args2str($client_exe, @$args);
+}
+
+
+sub mysqlslap_arguments () {
+  my $exe= mtr_exe_maybe_exists("$path_client_bindir/mysqlslap");
+  if ( $exe eq "" ) {
+    # mysqlap was not found
+
+    if (defined $mysql_version_id and $mysql_version_id >= 50100 ) {
+      mtr_error("Could not find the mysqlslap binary");
+    }
+    return ""; # Don't care about mysqlslap
+  }
+
+  my $args;
+  mtr_init_args(\$args);
+  mtr_add_arg($args, "--defaults-file=%s", $path_config_file);
+  client_debug_arg($args, "mysqlslap");
+  return mtr_args2str($exe, @$args);
+}
+
+
+sub mysqldump_arguments ($) {
+  my($group_suffix) = @_;
+  my $exe= mtr_exe_exists("$path_client_bindir/mysqldump");
+
+  my $args;
+  mtr_init_args(\$args);
+  mtr_add_arg($args, "--defaults-file=%s", $path_config_file);
+  mtr_add_arg($args, "--defaults-group-suffix=%s", $group_suffix);
+  client_debug_arg($args, "mysqldump-$group_suffix");
+  return mtr_args2str($exe, @$args);
+}
+
+
+sub mysql_client_test_arguments(){
+  my $exe;
+  # mysql_client_test executable may _not_ exist
+  if ( $opt_embedded_server ) {
+    $exe= mtr_exe_maybe_exists(
+            vs_config_dirs('libmysqld/examples','mysql_client_test_embedded'),
+	      "$basedir/libmysqld/examples/mysql_client_test_embedded",
+		"$basedir/bin/mysql_client_test_embedded");
+  } else {
+    $exe= mtr_exe_maybe_exists(vs_config_dirs('tests', 'mysql_client_test'),
+			       "$basedir/tests/mysql_client_test",
+			       "$basedir/bin/mysql_client_test");
+  }
+
+  my $args;
+  mtr_init_args(\$args);
+  if ( $opt_valgrind_mysqltest ) {
+    valgrind_arguments($args, \$exe);
+  }
+  mtr_add_arg($args, "--defaults-file=%s", $path_config_file);
+  mtr_add_arg($args, "--testcase");
+  mtr_add_arg($args, "--vardir=$opt_vardir");
+  client_debug_arg($args,"mysql_client_test");
+
+  return mtr_args2str($exe, @$args);
+}
+
+
+#
+# Set environment to be used by childs of this process for
+# things that are constant during the whole lifetime of mysql-test-run
+#
+
+sub find_plugin($$)
+{
+  my ($plugin, $location)  = @_;
+  my $plugin_filename;
+
+  if (IS_WINDOWS)
+  {
+     $plugin_filename = $plugin.".dll"; 
+  }
+  else 
+  {
+     $plugin_filename = $plugin.".so";
+  }
+
+  my $lib_plugin=
+    mtr_file_exists(vs_config_dirs($location,$plugin_filename),
+                    "$basedir/lib/plugin/".$plugin_filename,
+                    "$basedir/lib64/plugin/".$plugin_filename,
+                    "$basedir/$location/.libs/".$plugin_filename,
+                    "$basedir/lib/mysql/plugin/".$plugin_filename,
+                    "$basedir/lib64/mysql/plugin/".$plugin_filename,
+                    );
+  return $lib_plugin;
+}
+
+#
+# Read plugin defintions file
+#
+
+sub read_plugin_defs($)
+{
+  my ($defs_file)= @_;
+  my $running_debug= 0;
+
+  open(PLUGDEF, '<', $defs_file)
+    or mtr_error("Can't read plugin defintions file $defs_file");
+
+  # Need to check if we will be running mysqld-debug
+  if ($opt_debug_server) {
+    $running_debug= 1 if find_mysqld($basedir) =~ /mysqld-debug/;
+  }
+
+  while (<PLUGDEF>) {
+    next if /^#/;
+    my ($plug_file, $plug_loc, $plug_var, $plug_names)= split;
+    # Allow empty lines
+    next unless $plug_file;
+    mtr_error("Lines in $defs_file must have 3 or 4 items") unless $plug_var;
+
+    # If running debug server, plugins will be in 'debug' subdirectory
+    $plug_file= "debug/$plug_file" if $running_debug;
+
+    my ($plugin)= find_plugin($plug_file, $plug_loc);
+
+    # Set env. variables that tests may use, set to empty if plugin
+    # listed in def. file but not found.
+
+    if ($plugin) {
+      $ENV{$plug_var}= basename($plugin);
+      $ENV{$plug_var.'_DIR'}= dirname($plugin);
+      $ENV{$plug_var.'_OPT'}= "--plugin-dir=".dirname($plugin);
+      if ($plug_names) {
+	my $lib_name= basename($plugin);
+	my $load_var= "--plugin_load=";
+	my $semi= '';
+	foreach my $plug_name (split (',', $plug_names)) {
+	  $load_var .= $semi . "$plug_name=$lib_name";
+	  $semi= ';';
+	}
+	$ENV{$plug_var.'_LOAD'}= $load_var;
+      }
+    } else {
+      $ENV{$plug_var}= "";
+      $ENV{$plug_var.'_DIR'}= "";
+      $ENV{$plug_var.'_OPT'}= "";
+      $ENV{$plug_var.'_LOAD'}= "" if $plug_names;
+    }
+  }
+  close PLUGDEF;
+}
+
+sub environment_setup {
+
+  umask(022);
+
+  my @ld_library_paths;
+
+  if ($path_client_libdir)
+  {
+    # Use the --client-libdir passed on commandline
+    push(@ld_library_paths, "$path_client_libdir");
+  }
+  else
+  {
+    # Setup LD_LIBRARY_PATH so the libraries from this distro/clone
+    # are used in favor of the system installed ones
+    if ( $source_dist )
+    {
+      push(@ld_library_paths, "$basedir/libmysql/.libs/",
+	   "$basedir/libmysql_r/.libs/",
+	   "$basedir/zlib/.libs/");
+    }
+    else
+    {
+      push(@ld_library_paths, "$basedir/lib", "$basedir/lib/mysql");
+    }
+  }
+
+  # --------------------------------------------------------------------------
+  # Add the path where libndbclient can be found
+  # --------------------------------------------------------------------------
+  if ( $ndbcluster_enabled )
+  {
+    push(@ld_library_paths,  "$basedir/storage/ndb/src/.libs");
+  }
+
+  # Plugin settings should no longer be added here, instead
+  # place definitions in include/plugin.defs.
+  # See comment in that file for details.
+  # --------------------------------------------------------------------------
+  # Valgrind need to be run with debug libraries otherwise it's almost
+  # impossible to add correct supressions, that means if "/usr/lib/debug"
+  # is available, it should be added to
+  # LD_LIBRARY_PATH
+  #
+  # But pthread is broken in libc6-dbg on Debian <= 3.1 (see Debian
+  # bug 399035, http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=399035),
+  # so don't change LD_LIBRARY_PATH on that platform.
+  # --------------------------------------------------------------------------
+  my $debug_libraries_path= "/usr/lib/debug";
+  my $deb_version;
+  if (  $opt_valgrind and -d $debug_libraries_path and
+        (! -e '/etc/debian_version' or
+	 ($deb_version=
+	    mtr_grab_file('/etc/debian_version')) !~ /^[0-9]+\.[0-9]$/ or
+         $deb_version > 3.1 ) )
+  {
+    push(@ld_library_paths, $debug_libraries_path);
+  }
+
+  $ENV{'LD_LIBRARY_PATH'}= join(":", @ld_library_paths,
+				$ENV{'LD_LIBRARY_PATH'} ?
+				split(':', $ENV{'LD_LIBRARY_PATH'}) : ());
+  mtr_debug("LD_LIBRARY_PATH: $ENV{'LD_LIBRARY_PATH'}");
+
+  $ENV{'DYLD_LIBRARY_PATH'}= join(":", @ld_library_paths,
+				  $ENV{'DYLD_LIBRARY_PATH'} ?
+				  split(':', $ENV{'DYLD_LIBRARY_PATH'}) : ());
+  mtr_debug("DYLD_LIBRARY_PATH: $ENV{'DYLD_LIBRARY_PATH'}");
+
+  # The environment variable used for shared libs on AIX
+  $ENV{'SHLIB_PATH'}= join(":", @ld_library_paths,
+                           $ENV{'SHLIB_PATH'} ?
+                           split(':', $ENV{'SHLIB_PATH'}) : ());
+  mtr_debug("SHLIB_PATH: $ENV{'SHLIB_PATH'}");
+
+  # The environment variable used for shared libs on hp-ux
+  $ENV{'LIBPATH'}= join(":", @ld_library_paths,
+                        $ENV{'LIBPATH'} ?
+                        split(':', $ENV{'LIBPATH'}) : ());
+  mtr_debug("LIBPATH: $ENV{'LIBPATH'}");
+
+  $ENV{'UMASK'}=              "0660"; # The octal *string*
+  $ENV{'UMASK_DIR'}=          "0770"; # The octal *string*
+
+  #
+  # MySQL tests can produce output in various character sets
+  # (especially, ctype_xxx.test). To avoid confusing Perl
+  # with output which is incompatible with the current locale
+  # settings, we reset the current values of LC_ALL and LC_CTYPE to "C".
+  # For details, please see
+  # Bug#27636 tests fails if LC_* variables set to *_*.UTF-8
+  #
+  $ENV{'LC_ALL'}=             "C";
+  $ENV{'LC_CTYPE'}=           "C";
+
+  $ENV{'LC_COLLATE'}=         "C";
+  $ENV{'USE_RUNNING_SERVER'}= using_extern();
+  $ENV{'MYSQL_TEST_DIR'}=     $glob_mysql_test_dir;
+  $ENV{'DEFAULT_MASTER_PORT'}= $mysqld_variables{'port'};
+  $ENV{'MYSQL_TMP_DIR'}=      $opt_tmpdir;
+  $ENV{'MYSQLTEST_VARDIR'}=   $opt_vardir;
+  $ENV{'MYSQL_TEST_DIR_ABS'}= getcwd();
+  $ENV{'MYSQL_BINDIR'}=       "$bindir";
+  $ENV{'MYSQL_SHAREDIR'}=     $path_language;
+  $ENV{'MYSQL_CHARSETSDIR'}=  $path_charsetsdir;
+  
+  if (IS_WINDOWS)
+  {
+    $ENV{'SECURE_LOAD_PATH'}= $glob_mysql_test_dir."\\std_data";
+  }
+  else
+  {
+    $ENV{'SECURE_LOAD_PATH'}= $glob_mysql_test_dir."/std_data";
+  }
+    
+
+  # ----------------------------------------------------
+  # Setup env for NDB
+  # ----------------------------------------------------
+  if ( $ndbcluster_enabled )
+  {
+    $ENV{'NDB_MGM'}=
+      my_find_bin($bindir,
+		  ["storage/ndb/src/mgmclient", "bin"],
+		  "ndb_mgm");
+
+    $ENV{'NDB_TOOLS_DIR'}=
+      my_find_dir($bindir,
+		  ["storage/ndb/tools", "bin"]);
+
+    $ENV{'NDB_EXAMPLES_DIR'}=
+      my_find_dir($basedir,
+		  ["storage/ndb/ndbapi-examples", "bin"]);
+
+    $ENV{'NDB_EXAMPLES_BINARY'}=
+      my_find_bin($bindir,
+		  ["storage/ndb/ndbapi-examples/ndbapi_simple", "bin"],
+		  "ndbapi_simple", NOT_REQUIRED);
+
+    my $path_ndb_testrun_log= "$opt_vardir/log/ndb_testrun.log";
+    $ENV{'NDB_TOOLS_OUTPUT'}=         $path_ndb_testrun_log;
+    $ENV{'NDB_EXAMPLES_OUTPUT'}=      $path_ndb_testrun_log;
+  }
+
+  # ----------------------------------------------------
+  # mysql clients
+  # ----------------------------------------------------
+  $ENV{'MYSQL_CHECK'}=              client_arguments("mysqlcheck");
+  $ENV{'MYSQL_DUMP'}=               mysqldump_arguments(".1");
+  $ENV{'MYSQL_DUMP_SLAVE'}=         mysqldump_arguments(".2");
+  $ENV{'MYSQL_SLAP'}=               mysqlslap_arguments();
+  $ENV{'MYSQL_IMPORT'}=             client_arguments("mysqlimport");
+  $ENV{'MYSQL_SHOW'}=               client_arguments("mysqlshow");
+  $ENV{'MYSQL_BINLOG'}=             client_arguments("mysqlbinlog");
+  $ENV{'MYSQL'}=                    client_arguments("mysql");
+  $ENV{'MYSQL_SLAVE'}=              client_arguments("mysql", ".2");
+  $ENV{'MYSQL_UPGRADE'}=            client_arguments("mysql_upgrade");
+  $ENV{'MYSQLADMIN'}=               native_path($exe_mysqladmin);
+  $ENV{'MYSQL_CLIENT_TEST'}=        mysql_client_test_arguments();
+  $ENV{'EXE_MYSQL'}=                $exe_mysql;
+  $ENV{'MYSQL_PLUGIN'}=             $exe_mysql_plugin;
+  $ENV{'MYSQL_EMBEDDED'}=           $exe_mysql_embedded;
+
+  my $exe_mysqld= find_mysqld($basedir);
+  $ENV{'MYSQLD'}= $exe_mysqld;
+  my $extra_opts= join (" ", @opt_extra_mysqld_opt);
+  $ENV{'MYSQLD_CMD'}= "$exe_mysqld --defaults-group-suffix=.1 ".
+    "--defaults-file=$path_config_file $extra_opts";
+
+  # ----------------------------------------------------
+  # bug25714 executable may _not_ exist in
+  # some versions, test using it should be skipped
+  # ----------------------------------------------------
+  my $exe_bug25714=
+      mtr_exe_maybe_exists(vs_config_dirs('tests', 'bug25714'),
+                           "$basedir/tests/bug25714");
+  $ENV{'MYSQL_BUG25714'}=  native_path($exe_bug25714);
+
+  # ----------------------------------------------------
+  # mysql_fix_privilege_tables.sql
+  # ----------------------------------------------------
+  my $file_mysql_fix_privilege_tables=
+    mtr_file_exists("$basedir/scripts/mysql_fix_privilege_tables.sql",
+		    "$basedir/share/mysql_fix_privilege_tables.sql",
+		    "$basedir/share/mysql/mysql_fix_privilege_tables.sql");
+  $ENV{'MYSQL_FIX_PRIVILEGE_TABLES'}=  $file_mysql_fix_privilege_tables;
+
+  # ----------------------------------------------------
+  # my_print_defaults
+  # ----------------------------------------------------
+  my $exe_my_print_defaults=
+    mtr_exe_exists(vs_config_dirs('extra', 'my_print_defaults'),
+		   "$path_client_bindir/my_print_defaults",
+		   "$basedir/extra/my_print_defaults");
+  $ENV{'MYSQL_MY_PRINT_DEFAULTS'}= native_path($exe_my_print_defaults);
+
+  # ----------------------------------------------------
+  # Setup env so childs can execute myisampack and myisamchk
+  # ----------------------------------------------------
+  $ENV{'MYISAMCHK'}= native_path(mtr_exe_exists(
+                       vs_config_dirs('storage/myisam', 'myisamchk'),
+                       vs_config_dirs('myisam', 'myisamchk'),
+                       "$path_client_bindir/myisamchk",
+                       "$basedir/storage/myisam/myisamchk",
+                       "$basedir/myisam/myisamchk"));
+  $ENV{'MYISAMPACK'}= native_path(mtr_exe_exists(
+                        vs_config_dirs('storage/myisam', 'myisampack'),
+                        vs_config_dirs('myisam', 'myisampack'),
+                        "$path_client_bindir/myisampack",
+                        "$basedir/storage/myisam/myisampack",
+                        "$basedir/myisam/myisampack"));
+
+  # ----------------------------------------------------
+  # mysqlaccess
+  # ----------------------------------------------------
+  my $mysqlaccess=
+    mtr_pl_maybe_exists("$bindir/scripts/mysqlaccess") ||
+    mtr_pl_maybe_exists("$path_client_bindir/mysqlaccess");
+  if ($mysqlaccess)
+  {
+    $ENV{'MYSQLACCESS'}= $mysqlaccess;
+  }
+
+  # ----------------------------------------------------
+  # mysqlhotcopy
+  # ----------------------------------------------------
+  my $mysqlhotcopy=
+    mtr_pl_maybe_exists("$bindir/scripts/mysqlhotcopy") ||
+    mtr_pl_maybe_exists("$path_client_bindir/mysqlhotcopy");
+  if ($mysqlhotcopy)
+  {
+    $ENV{'MYSQLHOTCOPY'}= $mysqlhotcopy;
+  }
+
+  # ----------------------------------------------------
+  # perror
+  # ----------------------------------------------------
+  my $exe_perror= mtr_exe_exists(vs_config_dirs('extra', 'perror'),
+				 "$basedir/extra/perror",
+				 "$path_client_bindir/perror");
+  $ENV{'MY_PERROR'}= native_path($exe_perror);
+
+  # ----------------------------------------------------
+  # replace
+  # ----------------------------------------------------
+  my $exe_replace= mtr_exe_exists(vs_config_dirs('extra', 'replace'),
+                                 "$basedir/extra/replace",
+                                 "$path_client_bindir/replace");
+  $ENV{'REPLACE'}= native_path($exe_replace);
+
+  # Create an environment variable to make it possible
+  # to detect that valgrind is being used from test cases
+  $ENV{'VALGRIND_TEST'}= $opt_valgrind;
+
+  # Add dir of this perl to aid mysqltest in finding perl
+  my $perldir= dirname($^X);
+  my $pathsep= ":";
+  $pathsep= ";" if IS_WINDOWS && ! IS_CYGWIN;
+  $ENV{'PATH'}= "$ENV{'PATH'}".$pathsep.$perldir;
+}
+
+
+sub remove_vardir_subs() {
+  foreach my $sdir ( glob("$opt_vardir/*") ) {
+    mtr_verbose("Removing subdir $sdir");
+    rmtree($sdir);
+  }
+}
+
+#
+# Remove var and any directories in var/ created by previous
+# tests
+#
+sub remove_stale_vardir () {
+
+  mtr_report("Removing old var directory...");
+
+  # Safety!
+  mtr_error("No, don't remove the vardir when running with --extern")
+    if using_extern();
+
+  mtr_verbose("opt_vardir: $opt_vardir");
+  if ( $opt_vardir eq $default_vardir )
+  {
+    #
+    # Running with "var" in mysql-test dir
+    #
+    if ( -l $opt_vardir)
+    {
+      # var is a symlink
+
+      if ( $opt_mem )
+      {
+	# Remove the directory which the link points at
+	mtr_verbose("Removing " . readlink($opt_vardir));
+	rmtree(readlink($opt_vardir));
+
+	# Remove the "var" symlink
+	mtr_verbose("unlink($opt_vardir)");
+	unlink($opt_vardir);
+      }
+      else
+      {
+	# Some users creates a soft link in mysql-test/var to another area
+	# - allow it, but remove all files in it
+
+	mtr_report(" - WARNING: Using the 'mysql-test/var' symlink");
+
+	# Make sure the directory where it points exist
+	mtr_error("The destination for symlink $opt_vardir does not exist")
+	  if ! -d readlink($opt_vardir);
+
+	remove_vardir_subs();
+      }
+    }
+    else
+    {
+      # Remove the entire "var" dir
+      mtr_verbose("Removing $opt_vardir/");
+      rmtree("$opt_vardir/");
+    }
+
+    if ( $opt_mem )
+    {
+      # A symlink from var/ to $opt_mem will be set up
+      # remove the $opt_mem dir to assure the symlink
+      # won't point at an old directory
+      mtr_verbose("Removing $opt_mem");
+      rmtree($opt_mem);
+    }
+
+  }
+  else
+  {
+    #
+    # Running with "var" in some other place
+    #
+
+    # Remove the var/ dir in mysql-test dir if any
+    # this could be an old symlink that shouldn't be there
+    mtr_verbose("Removing $default_vardir");
+    rmtree($default_vardir);
+
+    # Remove the "var" dir
+    mtr_verbose("Removing $opt_vardir/");
+    rmtree("$opt_vardir/");
+  }
+  # Remove the "tmp" dir
+  mtr_verbose("Removing $opt_tmpdir/");
+  rmtree("$opt_tmpdir/");
+}
+
+
+
+#
+# Create var and the directories needed in var
+#
+sub setup_vardir() {
+  mtr_report("Creating var directory '$opt_vardir'...");
+
+  if ( $opt_vardir eq $default_vardir )
+  {
+    #
+    # Running with "var" in mysql-test dir
+    #
+    if ( -l $opt_vardir )
+    {
+      #  it's a symlink
+
+      # Make sure the directory where it points exist
+      mtr_error("The destination for symlink $opt_vardir does not exist")
+	if ! -d readlink($opt_vardir);
+    }
+    elsif ( $opt_mem )
+    {
+      # Runinng with "var" as a link to some "memory" location, normally tmpfs
+      mtr_verbose("Creating $opt_mem");
+      mkpath($opt_mem);
+
+      mtr_report(" - symlinking 'var' to '$opt_mem'");
+      symlink($opt_mem, $opt_vardir);
+    }
+  }
+
+  if ( ! -d $opt_vardir )
+  {
+    mtr_verbose("Creating $opt_vardir");
+    mkpath($opt_vardir);
+  }
+
+  # Ensure a proper error message if vardir couldn't be created
+  unless ( -d $opt_vardir and -w $opt_vardir )
+  {
+    mtr_error("Writable 'var' directory is needed, use the " .
+	      "'--vardir=<path>' option");
+  }
+
+  mkpath("$opt_vardir/log");
+  mkpath("$opt_vardir/run");
+
+  # Create var/tmp and tmp - they might be different
+  mkpath("$opt_vardir/tmp");
+  mkpath($opt_tmpdir) if ($opt_tmpdir ne "$opt_vardir/tmp");
+
+  # On some operating systems, there is a limit to the length of a
+  # UNIX domain socket's path far below PATH_MAX.
+  # Don't allow that to happen
+  if (check_socket_path_length("$opt_tmpdir/testsocket.sock")){
+    mtr_error("Socket path '$opt_tmpdir' too long, it would be ",
+	      "truncated and thus not possible to use for connection to ",
+	      "MySQL Server. Set a shorter with --tmpdir=<path> option");
+  }
+
+  # copy all files from std_data into var/std_data
+  # and make them world readable
+  copytree("$glob_mysql_test_dir/std_data", "$opt_vardir/std_data", "0022");
+
+  # Remove old log files
+  foreach my $name (glob("r/*.progress r/*.log r/*.warnings"))
+  {
+    unlink($name);
+  }
+}
+
+
+#
+# Check if running as root
+# i.e a file can be read regardless what mode we set it to
+#
+sub  check_running_as_root () {
+  my $test_file= "$opt_vardir/test_running_as_root.txt";
+  mtr_tofile($test_file, "MySQL");
+  chmod(oct("0000"), $test_file);
+
+  my $result="";
+  if (open(FILE,"<",$test_file))
+  {
+    $result= join('', <FILE>);
+    close FILE;
+  }
+
+  # Some filesystems( for example CIFS) allows reading a file
+  # although mode was set to 0000, but in that case a stat on
+  # the file will not return 0000
+  my $file_mode= (stat($test_file))[2] & 07777;
+
+  mtr_verbose("result: $result, file_mode: $file_mode");
+  if ($result eq "MySQL" && $file_mode == 0)
+  {
+    mtr_warning("running this script as _root_ will cause some " .
+                "tests to be skipped");
+    $ENV{'MYSQL_TEST_ROOT'}= "YES";
+  }
+
+  chmod(oct("0755"), $test_file);
+  unlink($test_file);
+}
+
+
+sub check_ssl_support ($) {
+  my $mysqld_variables= shift;
+
+  if ($opt_skip_ssl)
+  {
+    mtr_report(" - skipping SSL");
+    $opt_ssl_supported= 0;
+    $opt_ssl= 0;
+    return;
+  }
+
+  if ( ! $mysqld_variables->{'ssl'} )
+  {
+    if ( $opt_ssl)
+    {
+      mtr_error("Couldn't find support for SSL");
+      return;
+    }
+    mtr_report(" - skipping SSL, mysqld not compiled with SSL");
+    $opt_ssl_supported= 0;
+    $opt_ssl= 0;
+    return;
+  }
+  mtr_report(" - SSL connections supported");
+  $opt_ssl_supported= 1;
+}
+
+
+sub check_debug_support ($) {
+  my $mysqld_variables= shift;
+
+  if ( ! $mysqld_variables->{'debug'} )
+  {
+    #mtr_report(" - binaries are not debug compiled");
+    $debug_compiled_binaries= 0;
+
+    if ( $opt_debug_server )
+    {
+      mtr_error("Can't use --debug[-server], binary does not support it");
+    }
+    return;
+  }
+  mtr_report(" - binaries are debug compiled");
+  $debug_compiled_binaries= 1;
+}
+
+
+#
+# Helper function to handle configuration-based subdirectories which Visual
+# Studio uses for storing binaries.  If opt_vs_config is set, this returns
+# a path based on that setting; if not, it returns paths for the default
+# /release/ and /debug/ subdirectories.
+#
+# $exe can be undefined, if the directory itself will be used
+#
+sub vs_config_dirs ($$) {
+  my ($path_part, $exe) = @_;
+
+  $exe = "" if not defined $exe;
+  if ($opt_vs_config)
+  {
+    return ("$bindir/$path_part/$opt_vs_config/$exe");
+  }
+
+  return ("$bindir/$path_part/Release/$exe",
+          "$bindir/$path_part/RelWithDebinfo/$exe",
+          "$bindir/$path_part/Debug/$exe",
+          "$bindir/$path_part/$exe");
+}
+
+
+sub check_ndbcluster_support ($) {
+  my $mysqld_variables= shift;
+
+  my $ndbcluster_supported = 0;
+  if ($mysqld_variables{'ndb-connectstring'})
+  {
+    $ndbcluster_supported = 1;
+  }
+
+  if ($opt_skip_ndbcluster && $opt_include_ndbcluster)
+  {
+    # User is ambivalent. Theoretically the arg which was
+    # given last on command line should win, but that order is
+    # unknown at this time.
+    mtr_error("Ambigous command, both --include-ndbcluster " .
+	      " and --skip-ndbcluster was specified");
+  }
+
+  # Check if this is MySQL Cluster, ie. mysql version string ends
+  # with -ndb-Y.Y.Y[-status]
+  if ( defined $mysql_version_extra &&
+       $mysql_version_extra =~ /-ndb-([0-9]*)\.([0-9]*)\.([0-9]*)/ )
+  {
+    # MySQL Cluster tree
+    mtr_report(" - MySQL Cluster detected");
+
+    if ($opt_skip_ndbcluster)
+    {
+      mtr_report(" - skipping ndbcluster(--skip-ndbcluster)");
+      return;
+    }
+
+    if (!$ndbcluster_supported)
+    {
+      # MySQL Cluster tree, but mysqld was not compiled with
+      # ndbcluster -> fail unless --skip-ndbcluster was used
+      mtr_error("This is MySQL Cluster but mysqld does not " .
+		"support ndbcluster. Use --skip-ndbcluster to " .
+		"force mtr to run without it.");
+    }
+
+    # mysqld was compiled with ndbcluster -> auto enable
+  }
+  else
+  {
+    # Not a MySQL Cluster tree
+    if (!$ndbcluster_supported)
+    {
+      if ($opt_include_ndbcluster)
+      {
+	mtr_error("Could not detect ndbcluster support ".
+		  "requested with --include-ndbcluster");
+      }
+
+      # Silently skip, mysqld was compiled without ndbcluster
+      # which is the default case
+      return;
+    }
+
+    if ($opt_skip_ndbcluster)
+    {
+      # Compiled with ndbcluster but ndbcluster skipped
+      mtr_report(" - skipping ndbcluster(--skip-ndbcluster)");
+      return;
+    }
+
+
+    # Not a MySQL Cluster tree, enable ndbcluster
+    # if --include-ndbcluster was used
+    if ($opt_include_ndbcluster)
+    {
+      # enable ndbcluster
+    }
+    else
+    {
+      mtr_report(" - skipping ndbcluster(disabled by default)");
+      return;
+    }
+  }
+
+  mtr_report(" - enabling ndbcluster");
+  $ndbcluster_enabled= 1;
+  # Add MySQL Cluster test suites
+  $DEFAULT_SUITES.=",ndb,ndb_binlog,rpl_ndb,ndb_rpl,ndb_memcache";
+  return;
+}
+
+
+sub ndbcluster_wait_started($$){
+  my $cluster= shift;
+  my $ndb_waiter_extra_opt= shift;
+  my $path_waitlog= join('/', $opt_vardir, $cluster->name(), "ndb_waiter.log");
+
+  my $args;
+  mtr_init_args(\$args);
+  mtr_add_arg($args, "--defaults-file=%s", $path_config_file);
+  mtr_add_arg($args, "--defaults-group-suffix=%s", $cluster->suffix());
+  mtr_add_arg($args, "--timeout=%d", $opt_start_timeout);
+
+  if ($ndb_waiter_extra_opt)
+  {
+    mtr_add_arg($args, "$ndb_waiter_extra_opt");
+  }
+
+  # Start the ndb_waiter which will connect to the ndb_mgmd
+  # and poll it for state of the ndbd's, will return when
+  # all nodes in the cluster is started
+
+  my $res= My::SafeProcess->run
+    (
+     name          => "ndb_waiter ".$cluster->name(),
+     path          => $exe_ndb_waiter,
+     args          => \$args,
+     output        => $path_waitlog,
+     error         => $path_waitlog,
+     append        => 1,
+    );
+
+  # Check that ndb_mgmd(s) are still alive
+  foreach my $ndb_mgmd ( in_cluster($cluster, ndb_mgmds()) )
+  {
+    my $proc= $ndb_mgmd->{proc};
+    if ( ! $proc->wait_one(0) )
+    {
+      mtr_warning("$proc died");
+      return 2;
+    }
+  }
+
+  # Check that all started ndbd(s) are still alive
+  foreach my $ndbd ( in_cluster($cluster, ndbds()) )
+  {
+    my $proc= $ndbd->{proc};
+    next unless defined $proc;
+    if ( ! $proc->wait_one(0) )
+    {
+      mtr_warning("$proc died");
+      return 3;
+    }
+  }
+
+  if ($res)
+  {
+    mtr_verbose("ndbcluster_wait_started failed");
+    return 1;
+  }
+  return 0;
+}
+
+
+sub ndb_mgmd_wait_started($) {
+  my ($cluster)= @_;
+
+  my $retries= 100;
+  while ($retries)
+  {
+    my $result= ndbcluster_wait_started($cluster, "--no-contact");
+    if ($result == 0)
+    {
+      # ndb_mgmd is started
+      mtr_verbose("ndb_mgmd is started");
+      return 0;
+    }
+    elsif ($result > 1)
+    {
+      mtr_warning("Cluster process failed while waiting for start");
+      return $result;
+    }
+
+    mtr_milli_sleep(100);
+    $retries--;
+  }
+
+  return 1;
+}
+
+sub ndb_mgmd_stop{
+  my $ndb_mgmd= shift or die "usage: ndb_mgmd_stop(<ndb_mgmd>)";
+
+  my $host=$ndb_mgmd->value('HostName');
+  my $port=$ndb_mgmd->value('PortNumber');
+  mtr_verbose("Stopping cluster '$host:$port'");
+
+  my $args;
+  mtr_init_args(\$args);
+  mtr_add_arg($args, "--ndb-connectstring=%s:%s", $host,$port);
+  mtr_add_arg($args, "-e");
+  mtr_add_arg($args, "shutdown");
+
+  My::SafeProcess->run
+    (
+     name          => "ndb_mgm shutdown $host:$port",
+     path          => $exe_ndb_mgm,
+     args          => \$args,
+     output         => "/dev/null",
+    );
+}
+
+sub ndb_mgmd_start ($$) {
+  my ($cluster, $ndb_mgmd)= @_;
+
+  mtr_verbose("ndb_mgmd_start");
+
+  my $dir= $ndb_mgmd->value("DataDir");
+  mkpath($dir) unless -d $dir;
+
+  my $args;
+  mtr_init_args(\$args);
+  mtr_add_arg($args, "--defaults-file=%s", $path_config_file);
+  mtr_add_arg($args, "--defaults-group-suffix=%s", $cluster->suffix());
+  mtr_add_arg($args, "--mycnf");
+  mtr_add_arg($args, "--nodaemon");
+
+  my $path_ndb_mgmd_log= "$dir/ndb_mgmd.log";
+
+  $ndb_mgmd->{'proc'}= My::SafeProcess->new
+    (
+     name          => $ndb_mgmd->after('cluster_config.'),
+     path          => $exe_ndb_mgmd,
+     args          => \$args,
+     output        => $path_ndb_mgmd_log,
+     error         => $path_ndb_mgmd_log,
+     append        => 1,
+     verbose       => $opt_verbose,
+     shutdown      => sub { ndb_mgmd_stop($ndb_mgmd) },
+    );
+  mtr_verbose("Started $ndb_mgmd->{proc}");
+
+  # FIXME Should not be needed
+  # Unfortunately the cluster nodes will fail to start
+  # if ndb_mgmd has not started properly
+  if (ndb_mgmd_wait_started($cluster))
+  {
+    mtr_warning("Failed to wait for start of ndb_mgmd");
+    return 1;
+  }
+
+  return 0;
+}
+
+sub ndbd_stop {
+  # Intentionally left empty, ndbd nodes will be shutdown
+  # by sending "shutdown" to ndb_mgmd
+}
+
+my $exe_ndbmtd_counter= 0;
+
+sub ndbd_start {
+  my ($cluster, $ndbd)= @_;
+
+  mtr_verbose("ndbd_start");
+
+  my $dir= $ndbd->value("DataDir");
+  mkpath($dir) unless -d $dir;
+
+  my $args;
+  mtr_init_args(\$args);
+  mtr_add_arg($args, "--defaults-file=%s", $path_config_file);
+  mtr_add_arg($args, "--defaults-group-suffix=%s", $cluster->suffix());
+  mtr_add_arg($args, "--nodaemon");
+
+# > 5.0 { 'character-sets-dir' => \&fix_charset_dir },
+
+  my $exe= $exe_ndbd;
+  if ($exe_ndbmtd and ($exe_ndbmtd_counter++ % 2) == 0)
+  {
+    # Use ndbmtd every other time
+    $exe= $exe_ndbmtd;
+  }
+
+  my $path_ndbd_log= "$dir/ndbd.log";
+  my $proc= My::SafeProcess->new
+    (
+     name          => $ndbd->after('cluster_config.'),
+     path          => $exe,
+     args          => \$args,
+     output        => $path_ndbd_log,
+     error         => $path_ndbd_log,
+     append        => 1,
+     verbose       => $opt_verbose,
+     shutdown      => sub { ndbd_stop($ndbd) },
+    );
+  mtr_verbose("Started $proc");
+
+  $ndbd->{proc}= $proc;
+
+  return;
+}
+
+
+sub ndbcluster_start ($) {
+  my $cluster= shift;
+
+  mtr_verbose("ndbcluster_start '".$cluster->name()."'");
+
+  foreach my $ndb_mgmd ( in_cluster($cluster, ndb_mgmds()) )
+  {
+    next if started($ndb_mgmd);
+    ndb_mgmd_start($cluster, $ndb_mgmd);
+  }
+
+  foreach my $ndbd ( in_cluster($cluster, ndbds()) )
+  {
+    next if started($ndbd);
+    ndbd_start($cluster, $ndbd);
+  }
+
+  return 0;
+}
+
+
+sub create_config_file_for_extern {
+  my %opts=
+    (
+     socket     => '/tmp/mysqld.sock',
+     port       => 3306,
+     user       => $opt_user,
+     password   => '',
+     @_
+    );
+
+  mtr_report("Creating my.cnf file for extern server...");
+  my $F= IO::File->new($path_config_file, "w")
+    or mtr_error("Can't write to $path_config_file: $!");
+
+  print $F "[client]\n";
+  while (my ($option, $value)= each( %opts )) {
+    print $F "$option= $value\n";
+    mtr_report(" $option= $value");
+  }
+
+  print $F <<EOF
+
+# binlog reads from [client] and [mysqlbinlog]
+[mysqlbinlog]
+character-sets-dir= $path_charsetsdir
+local-load= $opt_tmpdir
+
+EOF
+;
+
+  $F= undef; # Close file
+}
+
+
+#
+# Kill processes left from previous runs, normally
+# there should be none so make sure to warn
+# if there is one
+#
+sub kill_leftovers ($) {
+  my $rundir= shift;
+  return unless ( -d $rundir );
+
+  mtr_report("Checking leftover processes...");
+
+  # Scan the "run" directory for process id's to kill
+  opendir(RUNDIR, $rundir)
+    or mtr_error("kill_leftovers, can't open dir \"$rundir\": $!");
+  while ( my $elem= readdir(RUNDIR) )
+  {
+    # Only read pid from files that end with .pid
+    if ( $elem =~ /.*[.]pid$/ )
+    {
+      my $pidfile= "$rundir/$elem";
+      next unless -f $pidfile;
+      my $pid= mtr_fromfile($pidfile);
+      unlink($pidfile);
+      unless ($pid=~ /^(\d+)/){
+	# The pid was not a valid number
+	mtr_warning("Got invalid pid '$pid' from '$elem'");
+	next;
+      }
+      mtr_report(" - found old pid $pid in '$elem', killing it...");
+
+      my $ret= kill("KILL", $pid);
+      if ($ret == 0) {
+	mtr_report("   process did not exist!");
+	next;
+      }
+
+      my $check_counter= 100;
+      while ($ret > 0 and $check_counter--) {
+	mtr_milli_sleep(100);
+	$ret= kill(0, $pid);
+      }
+      mtr_report($check_counter ? "   ok!" : "   failed!");
+    }
+    else
+    {
+      mtr_warning("Found non pid file '$elem' in '$rundir'")
+	if -f "$rundir/$elem";
+    }
+  }
+  closedir(RUNDIR);
+}
+
+#
+# Check that all the ports that are going to
+# be used are free
+#
+sub check_ports_free ($)
+{
+  my $bthread= shift;
+  my $portbase = $bthread * 10 + 10000;
+  for ($portbase..$portbase+9){
+    if (mtr_ping_port($_)){
+      mtr_report(" - 'localhost:$_' was not free");
+      return 0; # One port was not free
+    }
+  }
+
+  return 1; # All ports free
+}
+
+
+sub initialize_servers {
+
+  if ( using_extern() )
+  {
+    # Running against an already started server, if the specified
+    # vardir does not already exist it should be created
+    if ( ! -d $opt_vardir )
+    {
+      setup_vardir();
+    }
+    else
+    {
+      mtr_verbose("No need to create '$opt_vardir' it already exists");
+    }
+  }
+  else
+  {
+    # Kill leftovers from previous run
+    # using any pidfiles found in var/run
+    kill_leftovers("$opt_vardir/run");
+
+    if ( ! $opt_start_dirty )
+    {
+      remove_stale_vardir();
+      setup_vardir();
+
+      mysql_install_db(default_mysqld(), "$opt_vardir/install.db");
+    }
+  }
+}
+
+
+#
+# Remove all newline characters expect after semicolon
+#
+sub sql_to_bootstrap {
+  my ($sql) = @_;
+  my @lines= split(/\n/, $sql);
+  my $result= "\n";
+  my $delimiter= ';';
+
+  foreach my $line (@lines) {
+
+    # Change current delimiter if line starts with "delimiter"
+    if ( $line =~ /^delimiter (.*)/ ) {
+      my $new= $1;
+      # Remove old delimiter from end of new
+      $new=~ s/\Q$delimiter\E$//;
+      $delimiter = $new;
+      mtr_debug("changed delimiter to $delimiter");
+      # No need to add the delimiter to result
+      next;
+    }
+
+    # Add newline if line ends with $delimiter
+    # and convert the current delimiter to semicolon
+    if ( $line =~ /\Q$delimiter\E$/ ){
+      $line =~ s/\Q$delimiter\E$/;/;
+      $result.= "$line\n";
+      mtr_debug("Added default delimiter");
+      next;
+    }
+
+    # Remove comments starting with --
+    if ( $line =~ /^\s*--/ ) {
+      mtr_debug("Discarded $line");
+      next;
+    }
+
+    # Replace @HOSTNAME with localhost
+    $line=~ s/\'\@HOSTNAME\@\'/localhost/;
+
+    # Default, just add the line without newline
+    # but with a space as separator
+    $result.= "$line ";
+
+  }
+  return $result;
+}
+
+
+sub default_mysqld {
+  # Generate new config file from template
+  my $config= My::ConfigFactory->new_config
+    ( {
+       basedir         => $basedir,
+       testdir         => $glob_mysql_test_dir,
+       template_path   => "include/default_my.cnf",
+       vardir          => $opt_vardir,
+       tmpdir          => $opt_tmpdir,
+       baseport        => 0,
+       user            => $opt_user,
+       password        => '',
+      }
+    );
+
+  my $mysqld= $config->group('mysqld.1')
+    or mtr_error("Couldn't find mysqld.1 in default config");
+  return $mysqld;
+}
+
+
+sub mysql_install_db {
+  my ($mysqld, $datadir)= @_;
+
+  my $install_datadir= $datadir || $mysqld->value('datadir');
+  my $install_basedir= $mysqld->value('basedir');
+  my $install_lang= $mysqld->value('lc-messages-dir');
+  my $install_chsdir= $mysqld->value('character-sets-dir');
+
+  mtr_report("Installing system database...");
+
+  my $args;
+  mtr_init_args(\$args);
+  mtr_add_arg($args, "--no-defaults");
+  mtr_add_arg($args, "--bootstrap");
+  mtr_add_arg($args, "--basedir=%s", $install_basedir);
+  mtr_add_arg($args, "--datadir=%s", $install_datadir);
+  mtr_add_arg($args, "--loose-skip-falcon");
+  mtr_add_arg($args, "--loose-skip-ndbcluster");
+  mtr_add_arg($args, "--tmpdir=%s", "$opt_vardir/tmp/");
+  mtr_add_arg($args, "--secure-file-priv=%s", "$opt_vardir");
+  mtr_add_arg($args, "--core-file");
+
+  if ( $opt_debug )
+  {
+    mtr_add_arg($args, "--debug=$debug_d:t:i:A,%s/log/bootstrap.trace",
+		$path_vardir_trace);
+  }
+
+  mtr_add_arg($args, "--lc-messages-dir=%s", $install_lang);
+  mtr_add_arg($args, "--character-sets-dir=%s", $install_chsdir);
+
+  # On some old linux kernels, aio on tmpfs is not supported
+  # Remove this if/when Bug #58421 fixes this in the server
+  if ($^O eq "linux" && $opt_mem) {
+    mtr_add_arg($args, "--loose-skip-innodb-use-native-aio");
+  }
+
+  # InnoDB arguments that affect file location and sizes may
+  # need to be given to the bootstrap process as well as the
+  # server process.
+  foreach my $extra_opt ( @opt_extra_mysqld_opt ) {
+    if ($extra_opt =~ /--innodb/) {
+      mtr_add_arg($args, $extra_opt);
+    }
+  }
+
+  # If DISABLE_GRANT_OPTIONS is defined when the server is compiled (e.g.,
+  # configure --disable-grant-options), mysqld will not recognize the
+  # --bootstrap or --skip-grant-tables options.  The user can set
+  # MYSQLD_BOOTSTRAP to the full path to a mysqld which does accept
+  # --bootstrap, to accommodate this.
+  my $exe_mysqld_bootstrap =
+    $ENV{'MYSQLD_BOOTSTRAP'} || find_mysqld($install_basedir);
+
+  # ----------------------------------------------------------------------
+  # export MYSQLD_BOOTSTRAP_CMD variable containing <path>/mysqld <args>
+  # ----------------------------------------------------------------------
+  $ENV{'MYSQLD_BOOTSTRAP_CMD'}= "$exe_mysqld_bootstrap " . join(" ", @$args);
+
+
+
+  # ----------------------------------------------------------------------
+  # Create the bootstrap.sql file
+  # ----------------------------------------------------------------------
+  my $bootstrap_sql_file= "$opt_vardir/tmp/bootstrap.sql";
+
+  if ($opt_boot_gdb) {
+    gdb_arguments(\$args, \$exe_mysqld_bootstrap, $mysqld->name(),
+		  $bootstrap_sql_file);
+  }
+  if ($opt_boot_dbx) {
+    dbx_arguments(\$args, \$exe_mysqld_bootstrap, $mysqld->name(),
+		  $bootstrap_sql_file);
+  }
+  if ($opt_boot_ddd) {
+    ddd_arguments(\$args, \$exe_mysqld_bootstrap, $mysqld->name(),
+		  $bootstrap_sql_file);
+  }
+
+  my $path_sql= my_find_file($install_basedir,
+			     ["mysql", "sql/share", "share/mysql",
+			      "share", "scripts"],
+			     "mysql_system_tables.sql",
+			     NOT_REQUIRED);
+
+  if (-f $path_sql )
+  {
+    my $sql_dir= dirname($path_sql);
+    # Use the mysql database for system tables
+    mtr_tofile($bootstrap_sql_file, "use mysql\n");
+
+    # Add the offical mysql system tables
+    # for a production system
+    mtr_appendfile_to_file("$sql_dir/mysql_system_tables.sql",
+			   $bootstrap_sql_file);
+
+    # Add the mysql system tables initial data
+    # for a production system
+    mtr_appendfile_to_file("$sql_dir/mysql_system_tables_data.sql",
+			   $bootstrap_sql_file);
+
+    # Add test data for timezone - this is just a subset, on a real
+    # system these tables will be populated either by mysql_tzinfo_to_sql
+    # or by downloading the timezone table package from our website
+    mtr_appendfile_to_file("$sql_dir/mysql_test_data_timezone.sql",
+			   $bootstrap_sql_file);
+
+    # Fill help tables, just an empty file when running from bk repo
+    # but will be replaced by a real fill_help_tables.sql when
+    # building the source dist
+    mtr_appendfile_to_file("$sql_dir/fill_help_tables.sql",
+			   $bootstrap_sql_file);
+
+  }
+  else
+  {
+    # Install db from init_db.sql that exist in early 5.1 and 5.0
+    # versions of MySQL
+    my $init_file= "$install_basedir/mysql-test/lib/init_db.sql";
+    mtr_report(" - from '$init_file'");
+    my $text= mtr_grab_file($init_file) or
+      mtr_error("Can't open '$init_file': $!");
+
+    mtr_tofile($bootstrap_sql_file,
+	       sql_to_bootstrap($text));
+  }
+
+  # Remove anonymous users
+  mtr_tofile($bootstrap_sql_file,
+	     "DELETE FROM mysql.user where user= '';\n");
+
+  # Create mtr database
+  mtr_tofile($bootstrap_sql_file,
+	     "CREATE DATABASE mtr;\n");
+
+  # Add help tables and data for warning detection and supression
+  mtr_tofile($bootstrap_sql_file,
+             sql_to_bootstrap(mtr_grab_file("include/mtr_warnings.sql")));
+
+  # Add procedures for checking server is restored after testcase
+  mtr_tofile($bootstrap_sql_file,
+             sql_to_bootstrap(mtr_grab_file("include/mtr_check.sql")));
+
+  # Log bootstrap command
+  my $path_bootstrap_log= "$opt_vardir/log/bootstrap.log";
+  mtr_tofile($path_bootstrap_log,
+	     "$exe_mysqld_bootstrap " . join(" ", @$args) . "\n");
+
+  # Create directories mysql and test
+  mkpath("$install_datadir/mysql");
+  mkpath("$install_datadir/test");
+
+  if ( My::SafeProcess->run
+       (
+	name          => "bootstrap",
+	path          => $exe_mysqld_bootstrap,
+	args          => \$args,
+	input         => $bootstrap_sql_file,
+	output        => $path_bootstrap_log,
+	error         => $path_bootstrap_log,
+	append        => 1,
+	verbose       => $opt_verbose,
+       ) != 0)
+  {
+    mtr_error("Error executing mysqld --bootstrap\n" .
+              "Could not install system database from $bootstrap_sql_file\n" .
+	      "see $path_bootstrap_log for errors");
+  }
+}
+
+
+sub run_testcase_check_skip_test($)
+{
+  my ($tinfo)= @_;
+
+  # ----------------------------------------------------------------------
+  # If marked to skip, just print out and return.
+  # Note that a test case not marked as 'skip' can still be
+  # skipped later, because of the test case itself in cooperation
+  # with the mysqltest program tells us so.
+  # ----------------------------------------------------------------------
+
+  if ( $tinfo->{'skip'} )
+  {
+    mtr_report_test_skipped($tinfo) unless $start_only;
+    return 1;
+  }
+
+  return 0;
+}
+
+
+sub run_query {
+  my ($tinfo, $mysqld, $query)= @_;
+
+  my $args;
+  mtr_init_args(\$args);
+  mtr_add_arg($args, "--defaults-file=%s", $path_config_file);
+  mtr_add_arg($args, "--defaults-group-suffix=%s", $mysqld->after('mysqld'));
+
+  mtr_add_arg($args, "-e %s", $query);
+
+  my $res= My::SafeProcess->run
+    (
+     name          => "run_query -> ".$mysqld->name(),
+     path          => $exe_mysql,
+     args          => \$args,
+     output        => '/dev/null',
+     error         => '/dev/null'
+    );
+
+  return $res
+}
+
+
+sub do_before_run_mysqltest($)
+{
+  my $tinfo= shift;
+
+  # Remove old files produced by mysqltest
+  my $base_file= mtr_match_extension($tinfo->{result_file},
+				     "result"); # Trim extension
+  if (defined $base_file ){
+    unlink("$base_file.reject");
+    unlink("$base_file.progress");
+    unlink("$base_file.log");
+    unlink("$base_file.warnings");
+  }
+
+  if ( $mysql_version_id < 50000 ) {
+    # Set environment variable NDB_STATUS_OK to 1
+    # if script decided to run mysqltest cluster _is_ installed ok
+    $ENV{'NDB_STATUS_OK'} = "1";
+  } elsif ( $mysql_version_id < 50100 ) {
+    # Set environment variable NDB_STATUS_OK to YES
+    # if script decided to run mysqltest cluster _is_ installed ok
+    $ENV{'NDB_STATUS_OK'} = "YES";
+  }
+}
+
+
+#
+# Check all server for sideffects
+#
+# RETURN VALUE
+#  0 ok
+#  1 Check failed
+#  >1 Fatal errro
+
+sub check_testcase($$)
+{
+  my ($tinfo, $mode)= @_;
+  my $tname= $tinfo->{name};
+
+  # Start the mysqltest processes in parallel to save time
+  # also makes it possible to wait for any process to exit during the check
+  my %started;
+  foreach my $mysqld ( mysqlds() )
+  {
+    # Skip if server has been restarted with additional options
+    if ( defined $mysqld->{'proc'} && ! exists $mysqld->{'restart_opts'} )
+    {
+      my $proc= start_check_testcase($tinfo, $mode, $mysqld);
+      $started{$proc->pid()}= $proc;
+    }
+  }
+
+  # Return immediately if no check proceess was started
+  return 0 unless ( keys %started );
+
+  my $timeout= start_timer(check_timeout($tinfo));
+
+  while (1){
+    my $result;
+    my $proc= My::SafeProcess->wait_any_timeout($timeout);
+    mtr_report("Got $proc");
+
+    if ( delete $started{$proc->pid()} ) {
+
+      my $err_file= $proc->user_data();
+      my $base_file= mtr_match_extension($err_file, "err"); # Trim extension
+
+      # One check testcase process returned
+      my $res= $proc->exit_status();
+
+      if ( $res == 0){
+	# Check completed without problem
+
+	# Remove the .err file the check generated
+	unlink($err_file);
+
+	# Remove the .result file the check generated
+	if ( $mode eq 'after' ){
+	  unlink("$base_file.result");
+	}
+
+	if ( keys(%started) == 0){
+	  # All checks completed
+	  mark_time_used('check');
+	  return 0;
+	}
+	# Wait for next process to exit
+	next;
+      }
+      else
+      {
+	if ( $mode eq "after" and $res == 1 )
+	{
+	  # Test failed, grab the report mysqltest has created
+	  my $report= mtr_grab_file($err_file);
+	  $tinfo->{check}.=
+	    "\nMTR's internal check of the test case '$tname' failed.
+This means that the test case does not preserve the state that existed
+before the test case was executed.  Most likely the test case did not
+do a proper clean-up. It could also be caused by the previous test run
+by this thread, if the server wasn't restarted.
+This is the diff of the states of the servers before and after the
+test case was executed:\n";
+	  $tinfo->{check}.= $report;
+
+	  # Check failed, mark the test case with that info
+	  $tinfo->{'check_testcase_failed'}= 1;
+	  $result= 1;
+	}
+	elsif ( $res )
+	{
+	  my $report= mtr_grab_file($err_file);
+	  $tinfo->{comment}.=
+	    "Could not execute 'check-testcase' $mode ".
+	      "testcase '$tname' (res: $res):\n";
+	  $tinfo->{comment}.= $report;
+
+	  $result= 2;
+	}
+
+	# Remove the .result file the check generated
+	unlink("$base_file.result");
+
+      }
+    }
+    elsif ( $proc->{timeout} ) {
+      $tinfo->{comment}.= "Timeout for 'check-testcase' expired after "
+	.check_timeout($tinfo)." seconds";
+      $result= 4;
+    }
+    else {
+      # Unknown process returned, most likley a crash, abort everything
+      $tinfo->{comment}=
+	"The server $proc crashed while running ".
+	"'check testcase $mode test'".
+	get_log_from_proc($proc, $tinfo->{name});
+      $result= 3;
+    }
+
+    # Kill any check processes still running
+    map($_->kill(), values(%started));
+
+    mtr_warning("Check-testcase failed, this could also be caused by the" .
+		" previous test run by this worker thread")
+      if $result > 1 && $mode eq "before";
+    mark_time_used('check');
+
+    return $result;
+  }
+
+  mtr_error("INTERNAL_ERROR: check_testcase");
+}
+
+
+# Start run mysqltest on one server
+#
+# RETURN VALUE
+#  0 OK
+#  1 Check failed
+#
+sub start_run_one ($$) {
+  my ($mysqld, $run)= @_;
+
+  my $name= "$run-".$mysqld->name();
+
+  my $args;
+  mtr_init_args(\$args);
+
+  mtr_add_arg($args, "--defaults-file=%s", $path_config_file);
+  mtr_add_arg($args, "--defaults-group-suffix=%s", $mysqld->after('mysqld'));
+
+  mtr_add_arg($args, "--silent");
+  mtr_add_arg($args, "--test-file=%s", "include/$run.test");
+
+  my $errfile= "$opt_vardir/tmp/$name.err";
+  my $proc= My::SafeProcess->new
+    (
+     name          => $name,
+     path          => $exe_mysqltest,
+     error         => $errfile,
+     output        => $errfile,
+     args          => \$args,
+     user_data     => $errfile,
+     verbose       => $opt_verbose,
+    );
+  mtr_verbose("Started $proc");
+  return $proc;
+}
+
+
+#
+# Run script on all servers, collect results
+#
+# RETURN VALUE
+#  0 ok
+#  1 Failure
+
+sub run_on_all($$)
+{
+  my ($tinfo, $run)= @_;
+
+  # Start the mysqltest processes in parallel to save time
+  # also makes it possible to wait for any process to exit during the check
+  # and to have a timeout process
+  my %started;
+  foreach my $mysqld ( mysqlds() )
+  {
+    if ( defined $mysqld->{'proc'} )
+    {
+      my $proc= start_run_one($mysqld, $run);
+      $started{$proc->pid()}= $proc;
+    }
+  }
+
+  # Return immediately if no check proceess was started
+  return 0 unless ( keys %started );
+
+  my $timeout= start_timer(check_timeout($tinfo));
+
+  while (1){
+    my $result;
+    my $proc= My::SafeProcess->wait_any_timeout($timeout);
+    mtr_report("Got $proc");
+
+    if ( delete $started{$proc->pid()} ) {
+
+      # One mysqltest process returned
+      my $err_file= $proc->user_data();
+      my $res= $proc->exit_status();
+
+      # Append the report from .err file
+      $tinfo->{comment}.= " == $err_file ==\n";
+      $tinfo->{comment}.= mtr_grab_file($err_file);
+      $tinfo->{comment}.= "\n";
+
+      # Remove the .err file
+      unlink($err_file);
+
+      if ( keys(%started) == 0){
+	# All completed
+	return 0;
+      }
+
+      # Wait for next process to exit
+      next;
+    }
+    elsif ($proc->{timeout}) {
+      $tinfo->{comment}.= "Timeout for '$run' expired after "
+	.check_timeout($tinfo)." seconds";
+    }
+    else {
+      # Unknown process returned, most likley a crash, abort everything
+      $tinfo->{comment}.=
+	"The server $proc crashed while running '$run'".
+	get_log_from_proc($proc, $tinfo->{name});
+    }
+
+    # Kill any check processes still running
+    map($_->kill(), values(%started));
+
+    return 1;
+  }
+  mtr_error("INTERNAL_ERROR: run_on_all");
+}
+
+
+sub mark_log {
+  my ($log, $tinfo)= @_;
+  my $log_msg= "CURRENT_TEST: $tinfo->{name}\n";
+  mtr_tofile($log, $log_msg);
+}
+
+
+sub find_testcase_skipped_reason($)
+{
+  my ($tinfo)= @_;
+
+  # Set default message
+  $tinfo->{'comment'}= "Detected by testcase(no log file)";
+
+  # Open the test log file
+  my $F= IO::File->new($path_current_testlog)
+    or return;
+  my $reason;
+
+  while ( my $line= <$F> )
+  {
+    # Look for "reason: <reason for skipping test>"
+    if ( $line =~ /reason: (.*)/ )
+    {
+      $reason= $1;
+    }
+  }
+
+  if ( ! $reason )
+  {
+    mtr_warning("Could not find reason for skipping test in $path_current_testlog");
+    $reason= "Detected by testcase(reason unknown) ";
+  }
+  $tinfo->{'comment'}= $reason;
+}
+
+
+sub find_analyze_request
+{
+  # Open the test log file
+  my $F= IO::File->new($path_current_testlog)
+    or return;
+  my $analyze;
+
+  while ( my $line= <$F> )
+  {
+    # Look for "reason: <reason for skipping test>"
+    if ( $line =~ /analyze: (.*)/ )
+    {
+      $analyze= $1;
+    }
+  }
+
+  return $analyze;
+}
+
+
+# The test can leave a file in var/tmp/ to signal
+# that all servers should be restarted
+sub restart_forced_by_test($)
+{
+  my $file = shift;
+  my $restart = 0;
+  foreach my $mysqld ( mysqlds() )
+  {
+    my $datadir = $mysqld->value('datadir');
+    my $force_restart_file = "$datadir/mtr/$file";
+    if ( -f $force_restart_file )
+    {
+      mtr_verbose("Restart of servers forced by test");
+      $restart = 1;
+      last;
+    }
+  }
+  return $restart;
+}
+
+
+# Return timezone value of tinfo or default value
+sub timezone {
+  my ($tinfo)= @_;
+  return $tinfo->{timezone} || "GMT-3";
+}
+
+
+# Storage for changed environment variables
+my %old_env;
+
+sub resfile_report_test ($) {
+  my $tinfo=  shift;
+
+  resfile_new_test();
+
+  resfile_test_info("name", $tinfo->{name});
+  resfile_test_info("variation", $tinfo->{combination})
+    if $tinfo->{combination};
+  resfile_test_info("start_time", isotime time);
+}
+
+
+#
+# Run a single test case
+#
+# RETURN VALUE
+#  0 OK
+#  > 0 failure
+#
+
+sub run_testcase ($) {
+  my $tinfo=  shift;
+  my $print_freq=20;
+
+  mtr_verbose("Running test:", $tinfo->{name});
+  resfile_report_test($tinfo) if $opt_resfile;
+
+  # Allow only alpanumerics pluss _ - + . in combination names,
+  # or anything beginning with -- (the latter comes from --combination)
+  my $combination= $tinfo->{combination};
+  if ($combination && $combination !~ /^\w[-\w\.\+]+$/
+                   && $combination !~ /^--/)
+  {
+    mtr_error("Combination '$combination' contains illegal characters");
+  }
+  # -------------------------------------------------------
+  # Init variables that can change between each test case
+  # -------------------------------------------------------
+  my $timezone= timezone($tinfo);
+  $ENV{'TZ'}= $timezone;
+  mtr_verbose("Setting timezone: $timezone");
+
+  if ( ! using_extern() )
+  {
+    my @restart= servers_need_restart($tinfo);
+    if ( @restart != 0) {
+      stop_servers($tinfo, @restart );
+    }
+
+    if ( started(all_servers()) == 0 )
+    {
+
+      # Remove old datadirs
+      clean_datadir() unless $opt_start_dirty;
+
+      # Restore old ENV
+      while (my ($option, $value)= each( %old_env )) {
+	if (defined $value){
+	  mtr_verbose("Restoring $option to $value");
+	  $ENV{$option}= $value;
+
+	} else {
+	  mtr_verbose("Removing $option");
+	  delete($ENV{$option});
+	}
+      }
+      %old_env= ();
+
+      mtr_verbose("Generating my.cnf from '$tinfo->{template_path}'");
+
+      # Generate new config file from template
+      $config= My::ConfigFactory->new_config
+	( {
+	   basedir         => $basedir,
+	   testdir         => $glob_mysql_test_dir,
+	   template_path   => $tinfo->{template_path},
+	   extra_template_path => $tinfo->{extra_template_path},
+	   vardir          => $opt_vardir,
+	   tmpdir          => $opt_tmpdir,
+	   baseport        => $baseport,
+	   #hosts          => [ 'host1', 'host2' ],
+	   user            => $opt_user,
+	   password        => '',
+	   ssl             => $opt_ssl_supported,
+	   embedded        => $opt_embedded_server,
+	  }
+	);
+
+      # Write the new my.cnf
+      $config->save($path_config_file);
+
+      # Remember current config so a restart can occur when a test need
+      # to use a different one
+      $current_config_name= $tinfo->{template_path};
+
+      #
+      # Set variables in the ENV section
+      #
+      foreach my $option ($config->options_in_group("ENV"))
+      {
+	# Save old value to restore it before next time
+	$old_env{$option->name()}= $ENV{$option->name()};
+
+	mtr_verbose($option->name(), "=",$option->value());
+	$ENV{$option->name()}= $option->value();
+      }
+    }
+
+    # Write start of testcase to log
+    mark_log($path_current_testlog, $tinfo);
+
+    if (start_servers($tinfo))
+    {
+      report_failure_and_restart($tinfo);
+      return 1;
+    }
+  }
+  mark_time_used('restart');
+
+  # --------------------------------------------------------------------
+  # If --start or --start-dirty given, stop here to let user manually
+  # run tests
+  # If --wait-all is also given, do the same, but don't die if one
+  # server exits
+  # ----------------------------------------------------------------------
+
+  if ( $start_only )
+  {
+    mtr_print("\nStarted", started(all_servers()));
+    mtr_print("Using config for test", $tinfo->{name});
+    mtr_print("Port and socket path for server(s):");
+    foreach my $mysqld ( mysqlds() )
+    {
+      mtr_print ($mysqld->name() . "  " . $mysqld->value('port') .
+	      "  " . $mysqld->value('socket'));
+    }
+    if ( $opt_start_exit )
+    {
+      mtr_print("Server(s) started, not waiting for them to finish");
+      if (IS_WINDOWS)
+      {
+	POSIX::_exit(0);	# exit hangs here in ActiveState Perl
+      }
+      else
+      {
+	exit(0);
+      }
+    }
+    mtr_print("Waiting for server(s) to exit...");
+    if ( $opt_wait_all ) {
+      My::SafeProcess->wait_all();
+      mtr_print( "All servers exited" );
+      exit(1);
+    }
+    else {
+      my $proc= My::SafeProcess->wait_any();
+      if ( grep($proc eq $_, started(all_servers())) )
+      {
+        mtr_print("Server $proc died");
+        exit(1);
+      }
+      mtr_print("Unknown process $proc died");
+      exit(1);
+    }
+  }
+
+  my $test_timeout= start_timer(testcase_timeout($tinfo));
+
+  do_before_run_mysqltest($tinfo);
+
+  mark_time_used('admin');
+
+  if ( $opt_check_testcases and check_testcase($tinfo, "before") ){
+    # Failed to record state of server or server crashed
+    report_failure_and_restart($tinfo);
+
+    return 1;
+  }
+
+  my $test= start_mysqltest($tinfo);
+  # Set only when we have to keep waiting after expectedly died server
+  my $keep_waiting_proc = 0;
+  my $print_timeout= start_timer($print_freq * 60);
+
+  while (1)
+  {
+    my $proc;
+    if ($keep_waiting_proc)
+    {
+      # Any other process exited?
+      $proc = My::SafeProcess->check_any();
+      if ($proc)
+      {
+	mtr_verbose ("Found exited process $proc");
+      }
+      else
+      {
+	$proc = $keep_waiting_proc;
+	# Also check if timer has expired, if so cancel waiting
+	if ( has_expired($test_timeout) )
+	{
+	  $keep_waiting_proc = 0;
+	}
+      }
+    }
+    if (! $keep_waiting_proc)
+    {
+      if($test_timeout > $print_timeout)
+      {
+         $proc= My::SafeProcess->wait_any_timeout($print_timeout);
+         if ( $proc->{timeout} )
+         {
+            #print out that the test is still on
+            mtr_print("Test still running: $tinfo->{name}");
+            #reset the timer
+            $print_timeout= start_timer($print_freq * 60);
+            next;
+         }
+      }
+      else
+      {
+         $proc= My::SafeProcess->wait_any_timeout($test_timeout);
+      }
+    }
+
+    # Will be restored if we need to keep waiting
+    $keep_waiting_proc = 0;
+
+    unless ( defined $proc )
+    {
+      mtr_error("wait_any failed");
+    }
+    mtr_verbose("Got $proc");
+
+    mark_time_used('test');
+    # ----------------------------------------------------
+    # Was it the test program that exited
+    # ----------------------------------------------------
+    if ($proc eq $test)
+    {
+      my $res= $test->exit_status();
+
+      if ($res == 0 and $opt_warnings and check_warnings($tinfo) )
+      {
+	# Test case suceeded, but it has produced unexpected
+	# warnings, continue in $res == 1
+	$res= 1;
+	resfile_output($tinfo->{'warnings'}) if $opt_resfile;
+      }
+
+      if ( $res == 0 )
+      {
+	my $check_res;
+	if ( restart_forced_by_test('force_restart') )
+	{
+	  stop_all_servers($opt_shutdown_timeout);
+	}
+	elsif ( $opt_check_testcases and
+	     $check_res= check_testcase($tinfo, "after"))
+	{
+	  if ($check_res == 1) {
+	    # Test case had sideeffects, not fatal error, just continue
+	    stop_all_servers($opt_shutdown_timeout);
+	    mtr_report("Resuming tests...\n");
+	    resfile_output($tinfo->{'check'}) if $opt_resfile;
+	  }
+	  else {
+	    # Test case check failed fatally, probably a server crashed
+	    report_failure_and_restart($tinfo);
+	    return 1;
+	  }
+	}
+	mtr_report_test_passed($tinfo);
+      }
+      elsif ( $res == 62 )
+      {
+	# Testcase itself tell us to skip this one
+	$tinfo->{skip_detected_by_test}= 1;
+	# Try to get reason from test log file
+	find_testcase_skipped_reason($tinfo);
+	mtr_report_test_skipped($tinfo);
+	# Restart if skipped due to missing perl, it may have had side effects
+	if ( restart_forced_by_test('force_restart_if_skipped') ||
+             $tinfo->{'comment'} =~ /^perl not found/ )
+	{
+	  stop_all_servers($opt_shutdown_timeout);
+	}
+      }
+      elsif ( $res == 65 )
+      {
+	# Testprogram killed by signal
+	$tinfo->{comment}=
+	  "testprogram crashed(returned code $res)";
+	report_failure_and_restart($tinfo);
+      }
+      elsif ( $res == 1 )
+      {
+	# Check if the test tool requests that
+	# an analyze script should be run
+	my $analyze= find_analyze_request();
+	if ($analyze){
+	  run_on_all($tinfo, "analyze-$analyze");
+	}
+
+	# Wait a bit and see if a server died, if so report that instead
+	mtr_milli_sleep(100);
+	my $srvproc= My::SafeProcess::check_any();
+	if ($srvproc && grep($srvproc eq $_, started(all_servers()))) {
+	  $proc= $srvproc;
+	  goto SRVDIED;
+	}
+
+	# Test case failure reported by mysqltest
+	report_failure_and_restart($tinfo);
+      }
+      else
+      {
+	# mysqltest failed, probably crashed
+	$tinfo->{comment}=
+	  "mysqltest failed with unexpected return code $res\n";
+	report_failure_and_restart($tinfo);
+      }
+
+      # Save info from this testcase run to mysqltest.log
+      if( -f $path_current_testlog)
+      {
+	if ($opt_resfile && $res && $res != 62) {
+	  resfile_output_file($path_current_testlog);
+	}
+	mtr_appendfile_to_file($path_current_testlog, $path_testlog);
+	unlink($path_current_testlog);
+      }
+
+      return ($res == 62) ? 0 : $res;
+
+    }
+
+    # ----------------------------------------------------
+    # Check if it was an expected crash
+    # ----------------------------------------------------
+    my $check_crash = check_expected_crash_and_restart($proc);
+    if ($check_crash)
+    {
+      # Keep waiting if it returned 2, if 1 don't wait or stop waiting.
+      $keep_waiting_proc = 0 if $check_crash == 1;
+      $keep_waiting_proc = $proc if $check_crash == 2;
+      next;
+    }
+
+  SRVDIED:
+    # ----------------------------------------------------
+    # Stop the test case timer
+    # ----------------------------------------------------
+    $test_timeout= 0;
+
+    # ----------------------------------------------------
+    # Check if it was a server that died
+    # ----------------------------------------------------
+    if ( grep($proc eq $_, started(all_servers())) )
+    {
+      # Server failed, probably crashed
+      $tinfo->{comment}=
+	"Server $proc failed during test run" .
+	get_log_from_proc($proc, $tinfo->{name});
+
+      # ----------------------------------------------------
+      # It's not mysqltest that has exited, kill it
+      # ----------------------------------------------------
+      $test->kill();
+
+      report_failure_and_restart($tinfo);
+      return 1;
+    }
+
+    # Try to dump core for mysqltest and all servers
+    foreach my $proc ($test, started(all_servers())) 
+    {
+      mtr_print("Trying to dump core for $proc");
+      if ($proc->dump_core())
+      {
+	$proc->wait_one(20);
+      }
+    }
+
+    # ----------------------------------------------------
+    # It's not mysqltest that has exited, kill it
+    # ----------------------------------------------------
+    $test->kill();
+
+    # ----------------------------------------------------
+    # Check if testcase timer expired
+    # ----------------------------------------------------
+    if ( $proc->{timeout} )
+    {
+      my $log_file_name= $opt_vardir."/log/".$tinfo->{shortname}.".log";
+      $tinfo->{comment}=
+        "Test case timeout after ".testcase_timeout($tinfo).
+	  " seconds\n\n";
+      # Add 20 last executed commands from test case log file
+      if  (-e $log_file_name)
+      {
+        $tinfo->{comment}.=
+	   "== $log_file_name == \n".
+	     mtr_lastlinesfromfile($log_file_name, 20)."\n";
+      }
+      $tinfo->{'timeout'}= testcase_timeout($tinfo); # Mark as timeout
+      run_on_all($tinfo, 'analyze-timeout');
+
+      report_failure_and_restart($tinfo);
+      return 1;
+    }
+
+    mtr_error("Unhandled process $proc exited");
+  }
+  mtr_error("Should never come here");
+}
+
+
+# Extract server log from after the last occurrence of named test
+# Return as an array of lines
+#
+
+sub extract_server_log ($$) {
+  my ($error_log, $tname) = @_;
+
+  # Open the servers .err log file and read all lines
+  # belonging to current tets into @lines
+  my $Ferr = IO::File->new($error_log)
+    or mtr_error("Could not open file '$error_log' for reading: $!");
+
+  my @lines;
+  my $found_test= 0;		# Set once we've found the log of this test
+  while ( my $line = <$Ferr> )
+  {
+    if ($found_test)
+    {
+      # If test wasn't last after all, discard what we found, test again.
+      if ( $line =~ /^CURRENT_TEST:/)
+      {
+	@lines= ();
+	$found_test= $line =~ /^CURRENT_TEST: $tname/;
+      }
+      else
+      {
+	push(@lines, $line);
+	if (scalar(@lines) > 1000000) {
+	  $Ferr = undef;
+	  mtr_warning("Too much log from test, bailing out from extracting");
+	  return ();
+	}
+      }
+    }
+    else
+    {
+      # Search for beginning of test, until found
+      $found_test= 1 if ($line =~ /^CURRENT_TEST: $tname/);
+    }
+  }
+  $Ferr = undef; # Close error log file
+
+  return @lines;
+}
+
+# Get log from server identified from its $proc object, from named test
+# Return as a single string
+#
+
+sub get_log_from_proc ($$) {
+  my ($proc, $name)= @_;
+  my $srv_log= "";
+
+  foreach my $mysqld (mysqlds()) {
+    if ($mysqld->{proc} eq $proc) {
+      my @srv_lines= extract_server_log($mysqld->value('#log-error'), $name);
+      $srv_log= "\nServer log from this test:\n" .
+	"----------SERVER LOG START-----------\n". join ("", @srv_lines) .
+	"----------SERVER LOG END-------------\n";
+      last;
+    }
+  }
+  return $srv_log;
+}
+
+# Perform a rough examination of the servers
+# error log and write all lines that look
+# suspicious into $error_log.warnings
+#
+sub extract_warning_lines ($$) {
+  my ($error_log, $tname) = @_;
+
+  my @lines= extract_server_log($error_log, $tname);
+
+# Write all suspicious lines to $error_log.warnings file
+  my $warning_log = "$error_log.warnings";
+  my $Fwarn = IO::File->new($warning_log, "w")
+    or die("Could not open file '$warning_log' for writing: $!");
+  print $Fwarn "Suspicious lines from $error_log\n";
+
+  my @patterns =
+    (
+     qr/^Warning:|mysqld: Warning|\[Warning\]/,
+     qr/^Error:|\[ERROR\]/,
+     qr/^==\d+==\s+\S/, # valgrind errors
+     qr/InnoDB: Warning|InnoDB: Error/,
+     qr/^safe_mutex:|allocated at line/,
+     qr/missing DBUG_RETURN/,
+     qr/Attempting backtrace/,
+     qr/Assertion .* failed/,
+    );
+  my $skip_valgrind= 0;
+
+  my $last_pat= "";
+  my $num_rep= 0;
+
+  foreach my $line ( @lines )
+  {
+    if ($opt_valgrind_mysqld) {
+      # Skip valgrind summary from tests where server has been restarted
+      # Should this contain memory leaks, the final report will find it
+      # Use a generic pattern for summaries
+      $skip_valgrind= 1 if $line =~ /^==\d+== [A-Z ]+ SUMMARY:/;
+      $skip_valgrind= 0 unless $line =~ /^==\d+==/;
+      next if $skip_valgrind;
+    }
+    foreach my $pat ( @patterns )
+    {
+      if ( $line =~ /$pat/ )
+      {
+	# Remove initial timestamp and look for consecutive identical lines
+	my $line_pat= $line;
+	$line_pat =~ s/^[0-9:\-\+\.TZ ]*//;
+	if ($line_pat eq $last_pat) {
+	  $num_rep++;
+	} else {
+	  # Previous line had been repeated, report that first
+	  if ($num_rep) {
+	    print $Fwarn ".... repeated $num_rep times: $last_pat";
+	    $num_rep= 0;
+	  }
+	  $last_pat= $line_pat;
+	  print $Fwarn $line;
+	}
+	last;
+      }
+    }
+  }
+  # Catch the case of last warning being repeated
+  if ($num_rep) {
+    print $Fwarn ".... repeated $num_rep times: $last_pat";
+  }
+
+  $Fwarn = undef; # Close file
+
+}
+
+
+# Run include/check-warnings.test
+#
+# RETURN VALUE
+#  0 OK
+#  1 Check failed
+#
+sub start_check_warnings ($$) {
+  my $tinfo=    shift;
+  my $mysqld=   shift;
+
+  my $name= "warnings-".$mysqld->name();
+
+  my $log_error= $mysqld->value('#log-error');
+  # To be communicated to the test
+  $ENV{MTR_LOG_ERROR}= $log_error;
+  extract_warning_lines($log_error, $tinfo->{name});
+
+  my $args;
+  mtr_init_args(\$args);
+
+  mtr_add_arg($args, "--defaults-file=%s", $path_config_file);
+  mtr_add_arg($args, "--defaults-group-suffix=%s", $mysqld->after('mysqld'));
+  mtr_add_arg($args, "--test-file=%s", "include/check-warnings.test");
+
+  if ( $opt_embedded_server )
+  {
+
+    # Get the args needed for the embedded server
+    # and append them to args prefixed
+    # with --sever-arg=
+
+    my $mysqld=  $config->group('embedded')
+      or mtr_error("Could not get [embedded] section");
+
+    my $mysqld_args;
+    mtr_init_args(\$mysqld_args);
+    my $extra_opts= get_extra_opts($mysqld, $tinfo);
+    mysqld_arguments($mysqld_args, $mysqld, $extra_opts);
+    mtr_add_arg($args, "--server-arg=%s", $_) for @$mysqld_args;
+  }
+
+  my $errfile= "$opt_vardir/tmp/$name.err";
+  my $proc= My::SafeProcess->new
+    (
+     name          => $name,
+     path          => $exe_mysqltest,
+     error         => $errfile,
+     output        => $errfile,
+     args          => \$args,
+     user_data     => $errfile,
+     verbose       => $opt_verbose,
+    );
+  mtr_verbose("Started $proc");
+  return $proc;
+}
+
+
+#
+# Loop through our list of processes and check the error log
+# for unexepcted errors and warnings
+#
+sub check_warnings ($) {
+  my ($tinfo)= @_;
+  my $res= 0;
+
+  my $tname= $tinfo->{name};
+
+  # Clear previous warnings
+  delete($tinfo->{warnings});
+
+  # Start the mysqltest processes in parallel to save time
+  # also makes it possible to wait for any process to exit during the check
+  my %started;
+  foreach my $mysqld ( mysqlds() )
+  {
+    if ( defined $mysqld->{'proc'} )
+    {
+      my $proc= start_check_warnings($tinfo, $mysqld);
+      $started{$proc->pid()}= $proc;
+    }
+  }
+
+  # Return immediately if no check proceess was started
+  return 0 unless ( keys %started );
+
+  my $timeout= start_timer(check_timeout($tinfo));
+
+  while (1){
+    my $result= 0;
+    my $proc= My::SafeProcess->wait_any_timeout($timeout);
+    mtr_report("Got $proc");
+
+    if ( delete $started{$proc->pid()} ) {
+      # One check warning process returned
+      my $res= $proc->exit_status();
+      my $err_file= $proc->user_data();
+
+      if ( $res == 0 or $res == 62 ){
+
+	if ( $res == 0 ) {
+	  # Check completed with problem
+	  my $report= mtr_grab_file($err_file);
+	  # Log to var/log/warnings file
+	  mtr_tofile("$opt_vardir/log/warnings",
+		     $tname."\n".$report);
+
+	  $tinfo->{'warnings'}.= $report;
+	  $result= 1;
+	}
+
+	if ( $res == 62 ) {
+	  # Test case was ok and called "skip"
+	  # Remove the .err file the check generated
+	  unlink($err_file);
+	}
+
+	if ( keys(%started) == 0){
+	  # All checks completed
+	  mark_time_used('ch-warn');
+	  return $result;
+	}
+	# Wait for next process to exit
+	next;
+      }
+      else
+      {
+	my $report= mtr_grab_file($err_file);
+	$tinfo->{comment}.=
+	  "Could not execute 'check-warnings' for ".
+	    "testcase '$tname' (res: $res):\n";
+	$tinfo->{comment}.= $report;
+
+	$result= 2;
+      }
+    }
+    elsif ( $proc->{timeout} ) {
+      $tinfo->{comment}.= "Timeout for 'check warnings' expired after "
+	.check_timeout($tinfo)." seconds";
+      $result= 4;
+    }
+    else {
+      # Unknown process returned, most likley a crash, abort everything
+      $tinfo->{comment}=
+	"The server $proc crashed while running 'check warnings'".
+	get_log_from_proc($proc, $tinfo->{name});
+      $result= 3;
+    }
+
+    # Kill any check processes still running
+    map($_->kill(), values(%started));
+
+    mark_time_used('ch-warn');
+    return $result;
+  }
+
+  mtr_error("INTERNAL_ERROR: check_warnings");
+}
+
+
+#
+# Loop through our list of processes and look for and entry
+# with the provided pid, if found check for the file indicating
+# expected crash and restart it.
+#
+sub check_expected_crash_and_restart {
+  my ($proc)= @_;
+
+  foreach my $mysqld ( mysqlds() )
+  {
+    next unless ( $mysqld->{proc} and $mysqld->{proc} eq $proc );
+
+    # Check if crash expected by looking at the .expect file
+    # in var/tmp
+    my $expect_file= "$opt_vardir/tmp/".$mysqld->name().".expect";
+    if ( -f $expect_file )
+    {
+      mtr_verbose("Crash was expected, file '$expect_file' exists");
+
+      for (my $waits = 0;  $waits < 50;  mtr_milli_sleep(100), $waits++)
+      {
+	# Race condition seen on Windows: try again until file not empty
+	next if -z $expect_file;
+	# If last line in expect file starts with "wait"
+	# sleep a little and try again, thus allowing the
+	# test script to control when the server should start
+	# up again. Keep trying for up to 5s at a time.
+	my $last_line= mtr_lastlinesfromfile($expect_file, 1);
+	if ($last_line =~ /^wait/ )
+	{
+	  mtr_verbose("Test says wait before restart") if $waits == 0;
+	  next;
+	}
+
+	# Ignore any partial or unknown command
+	next unless $last_line =~ /^restart/;
+	# If last line begins "restart:", the rest of the line is read as
+        # extra command line options to add to the restarted mysqld.
+        # Anything other than 'wait' or 'restart:' (with a colon) will
+        # result in a restart with original mysqld options.
+	if ($last_line =~ /restart:(.+)/) {
+	  my @rest_opt= split(' ', $1);
+	  $mysqld->{'restart_opts'}= \@rest_opt;
+	} else {
+	  delete $mysqld->{'restart_opts'};
+	}
+	unlink($expect_file);
+
+	# Start server with same settings as last time
+	mysqld_start($mysqld, $mysqld->{'started_opts'});
+
+	return 1;
+      }
+      # Loop ran through: we should keep waiting after a re-check
+      return 2;
+    }
+  }
+
+  # Not an expected crash
+  return 0;
+}
+
+
+# Remove all files and subdirectories of a directory
+sub clean_dir {
+  my ($dir)= @_;
+  mtr_verbose("clean_dir: $dir");
+  finddepth(
+	  { no_chdir => 1,
+	    wanted => sub {
+	      if (-d $_){
+		# A dir
+		if ($_ eq $dir){
+		  # The dir to clean
+		  return;
+		} else {
+		  mtr_verbose("rmdir: '$_'");
+		  rmdir($_) or mtr_warning("rmdir($_) failed: $!");
+		}
+	      } else {
+		# Hopefully a file
+		mtr_verbose("unlink: '$_'");
+		unlink($_) or mtr_warning("unlink($_) failed: $!");
+	      }
+	    }
+	  },
+	    $dir);
+}
+
+
+sub clean_datadir {
+
+  mtr_verbose("Cleaning datadirs...");
+
+  if (started(all_servers()) != 0){
+    mtr_error("Trying to clean datadir before all servers stopped");
+  }
+
+  foreach my $cluster ( clusters() )
+  {
+    my $cluster_dir= "$opt_vardir/".$cluster->{name};
+    mtr_verbose(" - removing '$cluster_dir'");
+    rmtree($cluster_dir);
+
+  }
+
+  foreach my $mysqld ( mysqlds() )
+  {
+    my $mysqld_dir= dirname($mysqld->value('datadir'));
+    if (-d $mysqld_dir ) {
+      mtr_verbose(" - removing '$mysqld_dir'");
+      rmtree($mysqld_dir);
+    }
+  }
+
+  # Remove all files in tmp and var/tmp
+  clean_dir("$opt_vardir/tmp");
+  if ($opt_tmpdir ne "$opt_vardir/tmp"){
+    clean_dir($opt_tmpdir);
+  }
+}
+
+
+#
+# Save datadir before it's removed
+#
+sub save_datadir_after_failure($$) {
+  my ($dir, $savedir)= @_;
+
+  mtr_report(" - saving '$dir'");
+  my $dir_name= basename($dir);
+  rename("$dir", "$savedir/$dir_name");
+}
+
+
+sub remove_ndbfs_from_ndbd_datadir {
+  my ($ndbd_datadir)= @_;
+  # Remove the ndb_*_fs directory from ndbd.X/ dir
+  foreach my $ndbfs_dir ( glob("$ndbd_datadir/ndb_*_fs") )
+  {
+    next unless -d $ndbfs_dir; # Skip if not a directory
+    rmtree($ndbfs_dir);
+  }
+}
+
+
+sub after_failure ($) {
+  my ($tinfo)= @_;
+
+  mtr_report("Saving datadirs...");
+
+  my $save_dir= "$opt_vardir/log/";
+  $save_dir.= $tinfo->{name};
+  # Add combination name if any
+  $save_dir.= "-$tinfo->{combination}"
+    if defined $tinfo->{combination};
+
+  # Save savedir  path for server
+  $tinfo->{savedir}= $save_dir;
+
+  mkpath($save_dir) if ! -d $save_dir;
+
+  # Save the used my.cnf file
+  copy($path_config_file, $save_dir);
+
+  # Copy the tmp dir
+  copytree("$opt_vardir/tmp/", "$save_dir/tmp/");
+
+  if ( clusters() ) {
+    foreach my $cluster ( clusters() ) {
+      my $cluster_dir= "$opt_vardir/".$cluster->{name};
+
+      # Remove the fileystem of each ndbd
+      foreach my $ndbd ( in_cluster($cluster, ndbds()) )
+      {
+        my $ndbd_datadir= $ndbd->value("DataDir");
+        remove_ndbfs_from_ndbd_datadir($ndbd_datadir);
+      }
+
+      save_datadir_after_failure($cluster_dir, $save_dir);
+    }
+  }
+  else {
+    foreach my $mysqld ( mysqlds() ) {
+      my $data_dir= $mysqld->value('datadir');
+      save_datadir_after_failure(dirname($data_dir), $save_dir);
+    }
+  }
+}
+
+
+sub report_failure_and_restart ($) {
+  my $tinfo= shift;
+
+  if ($opt_valgrind_mysqld && ($tinfo->{'warnings'} || $tinfo->{'timeout'})) {
+    # In these cases we may want valgrind report from normal termination
+    $tinfo->{'dont_kill_server'}= 1;
+  }
+  # Shotdown properly if not to be killed (for valgrind)
+  stop_all_servers($tinfo->{'dont_kill_server'} ? $opt_shutdown_timeout : 0);
+
+  $tinfo->{'result'}= 'MTR_RES_FAILED';
+
+  my $test_failures= $tinfo->{'failures'} || 0;
+  $tinfo->{'failures'}=  $test_failures + 1;
+
+
+  if ( $tinfo->{comment} )
+  {
+    # The test failure has been detected by mysql-test-run.pl
+    # when starting the servers or due to other error, the reason for
+    # failing the test is saved in "comment"
+    ;
+  }
+
+  if ( !defined $tinfo->{logfile} )
+  {
+    my $logfile= $path_current_testlog;
+    if ( defined $logfile )
+    {
+      if ( -f $logfile )
+      {
+	# Test failure was detected by test tool and its report
+	# about what failed has been saved to file. Save the report
+	# in tinfo
+	$tinfo->{logfile}= mtr_fromfile($logfile);
+	# If no newlines in the test log:
+	# (it will contain the CURRENT_TEST written by mtr, so is not empty)
+	if ($tinfo->{logfile} !~ /\n/)
+	{
+	  # Show how far it got before suddenly failing
+	  $tinfo->{comment}.= "mysqltest failed but provided no output\n";
+	  my $log_file_name= $opt_vardir."/log/".$tinfo->{shortname}.".log";
+	  if (-e $log_file_name) {
+	    $tinfo->{comment}.=
+	      "The result from queries just before the failure was:".
+	      "\n< snip >\n".
+	      mtr_lastlinesfromfile($log_file_name, 20)."\n";
+	  }
+	}
+      }
+      else
+      {
+	# The test tool report didn't exist, display an
+	# error message
+	$tinfo->{logfile}= "Could not open test tool report '$logfile'";
+      }
+    }
+  }
+
+  after_failure($tinfo);
+
+  mtr_report_test($tinfo);
+
+}
+
+
+sub run_sh_script {
+  my ($script)= @_;
+
+  return 0 unless defined $script;
+
+  mtr_verbose("Running '$script'");
+  my $ret= system("/bin/sh $script") >> 8;
+  return $ret;
+}
+
+
+sub mysqld_stop {
+  my $mysqld= shift or die "usage: mysqld_stop(<mysqld>)";
+
+  my $args;
+  mtr_init_args(\$args);
+
+  mtr_add_arg($args, "--no-defaults");
+  mtr_add_arg($args, "--character-sets-dir=%s", $mysqld->value('character-sets-dir'));
+  mtr_add_arg($args, "--user=%s", $opt_user);
+  mtr_add_arg($args, "--password=");
+  mtr_add_arg($args, "--port=%d", $mysqld->value('port'));
+  mtr_add_arg($args, "--host=%s", $mysqld->value('#host'));
+  mtr_add_arg($args, "--connect_timeout=20");
+  mtr_add_arg($args, "--protocol=tcp");
+
+  mtr_add_arg($args, "shutdown");
+
+  My::SafeProcess->run
+    (
+     name          => "mysqladmin shutdown ".$mysqld->name(),
+     path          => $exe_mysqladmin,
+     args          => \$args,
+     error         => "/dev/null",
+
+    );
+}
+
+
+sub mysqld_arguments ($$$) {
+  my $args=              shift;
+  my $mysqld=            shift;
+  my $extra_opts=        shift;
+
+  my @defaults = grep(/^--defaults-file=/, @$extra_opts);
+  if (@defaults > 0) {
+    mtr_add_arg($args, pop(@defaults))
+  }
+  else {
+    mtr_add_arg($args, "--defaults-file=%s",  $path_config_file);
+  }
+
+  # When mysqld is run by a root user(euid is 0), it will fail
+  # to start unless we specify what user to run as, see BUG#30630
+  my $euid= $>;
+  if (!IS_WINDOWS and $euid == 0 and
+      (grep(/^--user/, @$extra_opts)) == 0) {
+    mtr_add_arg($args, "--user=root");
+  }
+
+  if ( $opt_valgrind_mysqld )
+  {
+    if ( $mysql_version_id < 50100 )
+    {
+      mtr_add_arg($args, "--skip-bdb");
+    }
+  }
+
+  # On some old linux kernels, aio on tmpfs is not supported
+  # Remove this if/when Bug #58421 fixes this in the server
+  if ($^O eq "linux" && $opt_mem)
+  {
+    mtr_add_arg($args, "--loose-skip-innodb-use-native-aio");
+  }
+
+  if ( $mysql_version_id >= 50106 && !$opt_user_args)
+  {
+    # Turn on logging to file
+    mtr_add_arg($args, "--log-output=file");
+  }
+
+  # Check if "extra_opt" contains skip-log-bin
+  my $skip_binlog= grep(/^(--|--loose-)skip-log-bin/, @$extra_opts);
+
+  # Indicate to mysqld it will be debugged in debugger
+  if ( $glob_debugger )
+  {
+    mtr_add_arg($args, "--gdb");
+  }
+
+  my $found_skip_core= 0;
+  foreach my $arg ( @$extra_opts )
+  {
+    # Skip --defaults-file option since it's handled above.
+    next if $arg =~ /^--defaults-file/;
+
+    # Allow --skip-core-file to be set in <testname>-[master|slave].opt file
+    if ($arg eq "--skip-core-file")
+    {
+      $found_skip_core= 1;
+    }
+    elsif ($skip_binlog and mtr_match_prefix($arg, "--binlog-format"))
+    {
+      ; # Dont add --binlog-format when running without binlog
+    }
+    elsif ($arg eq "--loose-skip-log-bin" and
+           $mysqld->option("log-slave-updates"))
+    {
+      ; # Dont add --skip-log-bin when mysqld have --log-slave-updates in config
+    }
+    elsif ($arg eq "")
+    {
+      # We can get an empty argument when  we set environment variables to ""
+      # (e.g plugin not found). Just skip it.
+    }
+    else
+    {
+      mtr_add_arg($args, "%s", $arg);
+    }
+  }
+  $opt_skip_core = $found_skip_core;
+  if ( !$found_skip_core && !$opt_user_args )
+  {
+    mtr_add_arg($args, "%s", "--core-file");
+  }
+
+  # Enable the debug sync facility, set default wait timeout.
+  # Facility stays disabled if timeout value is zero.
+  mtr_add_arg($args, "--loose-debug-sync-timeout=%s",
+              $opt_debug_sync_timeout) unless $opt_user_args;
+
+  return $args;
+}
+
+
+
+sub mysqld_start ($$) {
+  my $mysqld=            shift;
+  my $extra_opts=        shift;
+
+  mtr_verbose(My::Options::toStr("mysqld_start", @$extra_opts));
+
+  my $exe= find_mysqld($mysqld->value('basedir'));
+  my $wait_for_pid_file= 1;
+
+  mtr_error("Internal error: mysqld should never be started for embedded")
+    if $opt_embedded_server;
+
+  my $args;
+  mtr_init_args(\$args);
+# implementation for strace-server
+  if ( $opt_strace_server )
+  {
+    strace_server_arguments($args, \$exe, $mysqld->name());
+  }
+
+
+  if ( $opt_valgrind_mysqld )
+  {
+    valgrind_arguments($args, \$exe);
+  }
+
+  mtr_add_arg($args, "--defaults-group-suffix=%s", $mysqld->after('mysqld'));
+
+  # Add any additional options from an in-test restart
+  my @all_opts= @$extra_opts;
+  if (exists $mysqld->{'restart_opts'}) {
+    push (@all_opts, @{$mysqld->{'restart_opts'}});
+    mtr_verbose(My::Options::toStr("mysqld_start restart",
+				   @{$mysqld->{'restart_opts'}}));
+  }
+  mysqld_arguments($args,$mysqld,\@all_opts);
+
+  if ( $opt_debug )
+  {
+    mtr_add_arg($args, "--debug=$debug_d:t:i:A,%s/log/%s.trace",
+		$path_vardir_trace, $mysqld->name());
+  }
+
+  if (IS_WINDOWS)
+  {
+    # Trick the server to send output to stderr, with --console
+    mtr_add_arg($args, "--console");
+  }
+
+  if ( $opt_gdb || $opt_manual_gdb )
+  {
+    gdb_arguments(\$args, \$exe, $mysqld->name());
+  }
+  elsif ( $opt_manual_lldb )
+  {
+    lldb_arguments(\$args, \$exe, $mysqld->name());
+  }
+  elsif ( $opt_ddd || $opt_manual_ddd )
+  {
+    ddd_arguments(\$args, \$exe, $mysqld->name());
+  }
+  if ( $opt_dbx || $opt_manual_dbx ) {
+    dbx_arguments(\$args, \$exe, $mysqld->name());
+  }
+  elsif ( $opt_debugger )
+  {
+    debugger_arguments(\$args, \$exe, $mysqld->name());
+  }
+  elsif ( $opt_manual_debug )
+  {
+     print "\nStart " .$mysqld->name()." in your debugger\n" .
+           "dir: $glob_mysql_test_dir\n" .
+           "exe: $exe\n" .
+	   "args:  " . join(" ", @$args)  . "\n\n" .
+	   "Waiting ....\n";
+
+     # Indicate the exe should not be started
+    $exe= undef;
+  }
+  else
+  {
+    # Default to not wait until pid file has been created
+    $wait_for_pid_file= 0;
+  }
+
+  # Remove the old pidfile if any
+  unlink($mysqld->value('pid-file'));
+
+  my $output= $mysqld->value('#log-error');
+  # Remember this log file for valgrind error report search
+  $mysqld_logs{$output}= 1 if $opt_valgrind;
+  # Remember data dir for gmon.out files if using gprof
+  $gprof_dirs{$mysqld->value('datadir')}= 1 if $opt_gprof;
+
+  if ( defined $exe )
+  {
+    $mysqld->{'proc'}= My::SafeProcess->new
+      (
+       name          => $mysqld->name(),
+       path          => $exe,
+       args          => \$args,
+       output        => $output,
+       error         => $output,
+       append        => 1,
+       verbose       => $opt_verbose,
+       nocore        => $opt_skip_core,
+       host          => undef,
+       shutdown      => sub { mysqld_stop($mysqld) },
+       envs          => \@opt_mysqld_envs,
+      );
+    mtr_verbose("Started $mysqld->{proc}");
+  }
+
+  if ( $wait_for_pid_file &&
+       !sleep_until_file_created($mysqld->value('pid-file'),
+				 $opt_start_timeout,
+				 $mysqld->{'proc'}))
+  {
+    my $mname= $mysqld->name();
+    mtr_error("Failed to start mysqld $mname with command $exe");
+  }
+
+  # Remember options used when starting
+  $mysqld->{'started_opts'}= $extra_opts;
+
+  return;
+}
+
+
+sub stop_all_servers () {
+  my $shutdown_timeout = $_[0] or 0;
+
+  mtr_verbose("Stopping all servers...");
+
+  # Kill all started servers
+  My::SafeProcess::shutdown($shutdown_timeout,
+			    started(all_servers()));
+
+  # Remove pidfiles
+  foreach my $server ( all_servers() )
+  {
+    my $pid_file= $server->if_exist('pid-file');
+    unlink($pid_file) if defined $pid_file;
+  }
+
+  # Mark servers as stopped
+  map($_->{proc}= undef, all_servers());
+
+}
+
+
+# Find out if server should be restarted for this test
+sub server_need_restart {
+  my ($tinfo, $server)= @_;
+
+  if ( using_extern() )
+  {
+    mtr_verbose_restart($server, "no restart for --extern server");
+    return 0;
+  }
+
+  if ( $tinfo->{'force_restart'} ) {
+    mtr_verbose_restart($server, "forced in .opt file");
+    return 1;
+  }
+
+  if ( $opt_force_restart ) {
+    mtr_verbose_restart($server, "forced restart turned on");
+    return 1;
+  }
+
+  if ( $tinfo->{template_path} ne $current_config_name)
+  {
+    mtr_verbose_restart($server, "using different config file");
+    return 1;
+  }
+
+  if ( $tinfo->{'master_sh'}  || $tinfo->{'slave_sh'} )
+  {
+    mtr_verbose_restart($server, "sh script to run");
+    return 1;
+  }
+
+  if ( ! started($server) )
+  {
+    mtr_verbose_restart($server, "not started");
+    return 1;
+  }
+
+  my $started_tinfo= $server->{'started_tinfo'};
+  if ( defined $started_tinfo )
+  {
+
+    # Check if timezone of  test that server was started
+    # with differs from timezone of next test
+    if ( timezone($started_tinfo) ne timezone($tinfo) )
+    {
+      mtr_verbose_restart($server, "different timezone");
+      return 1;
+    }
+  }
+
+  my $is_mysqld= grep ($server eq $_, mysqlds());
+  if ($is_mysqld)
+  {
+
+    # Check that running process was started with same options
+    # as the current test requires
+    my $extra_opts= get_extra_opts($server, $tinfo);
+    my $started_opts= $server->{'started_opts'};
+
+    # Also, always restart if server had been restarted with additional
+    # options within test.
+    if (!My::Options::same($started_opts, $extra_opts) ||
+        exists $server->{'restart_opts'})
+    {
+      my $use_dynamic_option_switch= 0;
+      if (!$use_dynamic_option_switch)
+      {
+	mtr_verbose_restart($server, "running with different options '" .
+			    join(" ", @{$extra_opts}) . "' != '" .
+			    join(" ", @{$started_opts}) . "'" );
+	return 1;
+      }
+
+      mtr_verbose(My::Options::toStr("started_opts", @$started_opts));
+      mtr_verbose(My::Options::toStr("extra_opts", @$extra_opts));
+
+      # Get diff and check if dynamic switch is possible
+      my @diff_opts= My::Options::diff($started_opts, $extra_opts);
+      mtr_verbose(My::Options::toStr("diff_opts", @diff_opts));
+
+      my $query= My::Options::toSQL(@diff_opts);
+      mtr_verbose("Attempting dynamic switch '$query'");
+      if (run_query($tinfo, $server, $query)){
+	mtr_verbose("Restart: running with different options '" .
+		    join(" ", @{$extra_opts}) . "' != '" .
+		    join(" ", @{$started_opts}) . "'" );
+	return 1;
+      }
+
+      # Remember the dynamically set options
+      $server->{'started_opts'}= $extra_opts;
+    }
+  }
+
+  # Default, no restart
+  return 0;
+}
+
+
+sub servers_need_restart($) {
+  my ($tinfo)= @_;
+  return grep { server_need_restart($tinfo, $_); } all_servers();
+}
+
+
+
+#
+# Return list of specific servers
+#  - there is no servers in an empty config
+#
+sub _like   { return $config ? $config->like($_[0]) : (); }
+sub mysqlds { return _like('mysqld.'); }
+sub ndbds   { return _like('cluster_config.ndbd.');}
+sub ndb_mgmds { return _like('cluster_config.ndb_mgmd.'); }
+sub clusters  { return _like('mysql_cluster.'); }
+sub all_servers { return ( mysqlds(), ndb_mgmds(), ndbds() ); }
+
+
+#
+# Filter a list of servers and return only those that are part
+# of the specified cluster
+#
+sub in_cluster {
+  my ($cluster)= shift;
+  # Return only processes for a specific cluster
+  return grep { $_->suffix() eq $cluster->suffix() } @_;
+}
+
+
+
+#
+# Filter a list of servers and return the SafeProcess
+# for only those that are started or stopped
+#
+sub started { return grep(defined $_, map($_->{proc}, @_));  }
+sub stopped { return grep(!defined $_, map($_->{proc}, @_)); }
+
+
+sub envsubst {
+  my $string= shift;
+
+  if ( ! defined $ENV{$string} )
+  {
+    mtr_error(".opt file references '$string' which is not set");
+  }
+
+  return $ENV{$string};
+}
+
+
+sub get_extra_opts {
+  # No extra options if --user-args
+  return \@opt_extra_mysqld_opt if $opt_user_args;
+
+  my ($mysqld, $tinfo)= @_;
+
+  my $opts=
+    $mysqld->option("#!use-slave-opt") ?
+      $tinfo->{slave_opt} : $tinfo->{master_opt};
+
+  # Expand environment variables
+  foreach my $opt ( @$opts )
+  {
+    $opt =~ s/\$\{(\w+)\}/envsubst($1)/ge;
+    $opt =~ s/\$(\w+)/envsubst($1)/ge;
+  }
+  return $opts;
+}
+
+
+sub stop_servers($$) {
+  my ($tinfo, @servers)= @_;
+
+  # Remember if we restarted for this test case (count restarts)
+  $tinfo->{'restarted'}= 1;
+
+  if ( join('|', @servers) eq join('|', all_servers()) )
+  {
+    # All servers are going down, use some kind of order to
+    # avoid too many warnings in the log files
+
+   mtr_report("Restarting all servers");
+
+    #  mysqld processes
+    My::SafeProcess::shutdown( $opt_shutdown_timeout, started(mysqlds()) );
+
+    # cluster processes
+    My::SafeProcess::shutdown( $opt_shutdown_timeout,
+			       started(ndbds(), ndb_mgmds()) );
+  }
+  else
+  {
+    mtr_report("Restarting ", started(@servers));
+
+     # Stop only some servers
+    My::SafeProcess::shutdown( $opt_shutdown_timeout,
+			       started(@servers) );
+  }
+
+  foreach my $server (@servers)
+  {
+    # Mark server as stopped
+    $server->{proc}= undef;
+
+    # Forget history
+    delete $server->{'started_tinfo'};
+    delete $server->{'started_opts'};
+    delete $server->{'started_cnf'};
+  }
+}
+
+
+#
+# start_servers
+#
+# Start servers not already started
+#
+# RETURN
+#  0 OK
+#  1 Start failed
+#
+sub start_servers($) {
+  my ($tinfo)= @_;
+
+  # Make sure the safe_process also exits from now on
+  # Could not be done before, as we don't want this for the bootstrap
+  if ($opt_start_exit) {
+    My::SafeProcess->start_exit();
+  }
+
+  # Start clusters
+  foreach my $cluster ( clusters() )
+  {
+    ndbcluster_start($cluster);
+  }
+
+  # Start mysqlds
+  foreach my $mysqld ( mysqlds() )
+  {
+    if ( $mysqld->{proc} )
+    {
+      # Already started
+
+      # Write start of testcase to log file
+      mark_log($mysqld->value('#log-error'), $tinfo);
+
+      next;
+    }
+
+    my $datadir= $mysqld->value('datadir');
+    if ($opt_start_dirty)
+    {
+      # Don't delete anything if starting dirty
+      ;
+    }
+    else
+    {
+
+      my @options= ('log-bin', 'relay-log');
+      foreach my $option_name ( @options )  {
+	next unless $mysqld->option($option_name);
+
+	my $file_name= $mysqld->value($option_name);
+	next unless
+	  defined $file_name and
+	    -e $file_name;
+
+	mtr_debug(" -removing '$file_name'");
+	unlink($file_name) or die ("unable to remove file '$file_name'");
+      }
+
+      if (-d $datadir ) {
+	mtr_verbose(" - removing '$datadir'");
+	rmtree($datadir);
+      }
+    }
+
+    my $mysqld_basedir= $mysqld->value('basedir');
+    if ( $basedir eq $mysqld_basedir )
+    {
+      if (!$opt_start_dirty)	# If dirty, keep possibly grown system db
+      {
+        # Copy datadir from installed system db
+        my $path= ($opt_parallel == 1) ? "$opt_vardir" : "$opt_vardir/..";
+        my $install_db= "$path/install.db";
+        copytree($install_db, $datadir) if -d $install_db;
+        mtr_error("Failed to copy system db to '$datadir'")
+          unless -d $datadir;
+      }
+    }
+    else
+    {
+      mysql_install_db($mysqld); # For versional testing
+
+      mtr_error("Failed to install system db to '$datadir'")
+	unless -d $datadir;
+
+    }
+
+    # Create the servers tmpdir
+    my $tmpdir= $mysqld->value('tmpdir');
+    mkpath($tmpdir) unless -d $tmpdir;
+
+    # Write start of testcase to log file
+    mark_log($mysqld->value('#log-error'), $tinfo);
+
+    # Run <tname>-master.sh
+    if ($mysqld->option('#!run-master-sh') and
+       run_sh_script($tinfo->{master_sh}) )
+    {
+      $tinfo->{'comment'}= "Failed to execute '$tinfo->{master_sh}'";
+      return 1;
+    }
+
+    # Run <tname>-slave.sh
+    if ($mysqld->option('#!run-slave-sh') and
+	run_sh_script($tinfo->{slave_sh}))
+    {
+      $tinfo->{'comment'}= "Failed to execute '$tinfo->{slave_sh}'";
+      return 1;
+    }
+
+    if (!$opt_embedded_server)
+    {
+      my $extra_opts= get_extra_opts($mysqld, $tinfo);
+      mysqld_start($mysqld,$extra_opts);
+
+      # Save this test case information, so next can examine it
+      $mysqld->{'started_tinfo'}= $tinfo;
+    }
+
+  }
+
+  # Wait for clusters to start
+  foreach my $cluster ( clusters() )
+  {
+    if (ndbcluster_wait_started($cluster, ""))
+    {
+      # failed to start
+      $tinfo->{'comment'}= "Start of '".$cluster->name()."' cluster failed";
+      return 1;
+    }
+  }
+
+  # Wait for mysqlds to start
+  foreach my $mysqld ( mysqlds() )
+  {
+    next if !started($mysqld);
+
+    if (sleep_until_file_created($mysqld->value('pid-file'),
+				 $opt_start_timeout,
+				 $mysqld->{'proc'}) == 0) {
+      $tinfo->{comment}=
+	"Failed to start ".$mysqld->name();
+
+      my $logfile= $mysqld->value('#log-error');
+      if ( defined $logfile and -f $logfile )
+      {
+        my @srv_lines= extract_server_log($logfile, $tinfo->{name});
+	$tinfo->{logfile}= "Server log is:\n" . join ("", @srv_lines);
+      }
+      else
+      {
+	$tinfo->{logfile}= "Could not open server logfile: '$logfile'";
+      }
+      return 1;
+    }
+  }
+  return 0;
+}
+
+
+#
+# Run include/check-testcase.test
+# Before a testcase, run in record mode and save result file to var/tmp
+# After testcase, run and compare with the recorded file, they should be equal!
+#
+# RETURN VALUE
+#  The newly started process
+#
+sub start_check_testcase ($$$) {
+  my $tinfo=    shift;
+  my $mode=     shift;
+  my $mysqld=   shift;
+
+  my $name= "check-".$mysqld->name();
+  # Replace dots in name with underscore to avoid that mysqltest
+  # misinterpret's what the filename extension is :(
+  $name=~ s/\./_/g;
+
+  my $args;
+  mtr_init_args(\$args);
+
+  mtr_add_arg($args, "--defaults-file=%s", $path_config_file);
+  mtr_add_arg($args, "--defaults-group-suffix=%s", $mysqld->after('mysqld'));
+  mtr_add_arg($args, "--result-file=%s", "$opt_vardir/tmp/$name.result");
+  mtr_add_arg($args, "--test-file=%s", "include/check-testcase.test");
+  mtr_add_arg($args, "--verbose");
+
+  if ( $mode eq "before" )
+  {
+    mtr_add_arg($args, "--record");
+  }
+  my $errfile= "$opt_vardir/tmp/$name.err";
+  my $proc= My::SafeProcess->new
+    (
+     name          => $name,
+     path          => $exe_mysqltest,
+     error         => $errfile,
+     output        => $errfile,
+     args          => \$args,
+     user_data     => $errfile,
+     verbose       => $opt_verbose,
+    );
+
+  mtr_report("Started $proc");
+  return $proc;
+}
+
+
+sub run_mysqltest ($) {
+  my $proc= start_mysqltest(@_);
+  $proc->wait();
+}
+
+
+sub start_mysqltest ($) {
+  my ($tinfo)= @_;
+  my $exe= $exe_mysqltest;
+  my $args;
+
+  mark_time_used('admin');
+
+  mtr_init_args(\$args);
+
+  if ( $opt_strace_client )
+  {
+    $exe=  "strace";
+    mtr_add_arg($args, "-o");
+    mtr_add_arg($args, "%s/log/mysqltest.strace", $opt_vardir);
+    mtr_add_arg($args, "$exe_mysqltest");
+  }
+
+  mtr_add_arg($args, "--defaults-file=%s", $path_config_file);
+  mtr_add_arg($args, "--silent");
+  mtr_add_arg($args, "--tmpdir=%s", $opt_tmpdir);
+  mtr_add_arg($args, "--character-sets-dir=%s", $path_charsetsdir);
+  mtr_add_arg($args, "--logdir=%s/log", $opt_vardir);
+  if ($auth_plugin)
+  {
+    mtr_add_arg($args, "--plugin_dir=%s", dirname($auth_plugin));
+  }
+
+  # Log line number and time  for each line in .test file
+  mtr_add_arg($args, "--mark-progress")
+    if $opt_mark_progress;
+
+  mtr_add_arg($args, "--database=test");
+
+  if ( $opt_ps_protocol )
+  {
+    mtr_add_arg($args, "--ps-protocol");
+  }
+
+  if ( $opt_sp_protocol )
+  {
+    mtr_add_arg($args, "--sp-protocol");
+  }
+
+  if ( $opt_view_protocol )
+  {
+    mtr_add_arg($args, "--view-protocol");
+  }
+
+  if ( $opt_cursor_protocol )
+  {
+    mtr_add_arg($args, "--cursor-protocol");
+  }
+
+
+  mtr_add_arg($args, "--timer-file=%s/log/timer", $opt_vardir);
+
+  if ( $opt_compress )
+  {
+    mtr_add_arg($args, "--compress");
+  }
+
+  if ( $opt_sleep )
+  {
+    mtr_add_arg($args, "--sleep=%d", $opt_sleep);
+  }
+
+  if ( $opt_ssl )
+  {
+    # Turn on SSL for _all_ test cases if option --ssl was used
+    mtr_add_arg($args, "--ssl");
+  }
+
+  if ( $opt_max_connections ) {
+    mtr_add_arg($args, "--max-connections=%d", $opt_max_connections);
+  }
+
+  if ( $opt_embedded_server )
+  {
+
+    # Get the args needed for the embedded server
+    # and append them to args prefixed
+    # with --sever-arg=
+
+    my $mysqld=  $config->group('embedded')
+      or mtr_error("Could not get [embedded] section");
+
+    my $mysqld_args;
+    mtr_init_args(\$mysqld_args);
+    my $extra_opts= get_extra_opts($mysqld, $tinfo);
+    mysqld_arguments($mysqld_args, $mysqld, $extra_opts);
+    mtr_add_arg($args, "--server-arg=%s", $_) for @$mysqld_args;
+
+    if (IS_WINDOWS)
+    {
+      # Trick the server to send output to stderr, with --console
+      mtr_add_arg($args, "--server-arg=--console");
+    }
+  }
+
+  # ----------------------------------------------------------------------
+  # export MYSQL_TEST variable containing <path>/mysqltest <args>
+  # ----------------------------------------------------------------------
+  $ENV{'MYSQL_TEST'}= mtr_args2str($exe_mysqltest, @$args);
+
+  # ----------------------------------------------------------------------
+  # Add arguments that should not go into the MYSQL_TEST env var
+  # ----------------------------------------------------------------------
+  if ( $opt_valgrind_mysqltest )
+  {
+    # Prefix the Valgrind options to the argument list.
+    # We do this here, since we do not want to Valgrind the nested invocations
+    # of mysqltest; that would mess up the stderr output causing test failure.
+    my @args_saved = @$args;
+    mtr_init_args(\$args);
+    valgrind_arguments($args, \$exe);
+    mtr_add_arg($args, "%s", $_) for @args_saved;
+  }
+
+  mtr_add_arg($args, "--test-file=%s", $tinfo->{'path'});
+
+  # Number of lines of resut to include in failure report
+  mtr_add_arg($args, "--tail-lines=20");
+
+  if ( defined $tinfo->{'result_file'} ) {
+    mtr_add_arg($args, "--result-file=%s", $tinfo->{'result_file'});
+  }
+
+  client_debug_arg($args, "mysqltest");
+
+  if ( $opt_record )
+  {
+    mtr_add_arg($args, "--record");
+
+    # When recording to a non existing result file
+    # the name of that file is in "record_file"
+    if ( defined $tinfo->{'record_file'} ) {
+      mtr_add_arg($args, "--result-file=%s", $tinfo->{record_file});
+    }
+  }
+
+  if ( $opt_client_gdb )
+  {
+    gdb_arguments(\$args, \$exe, "client");
+  }
+  elsif ( $opt_client_ddd )
+  {
+    ddd_arguments(\$args, \$exe, "client");
+  }
+  if ( $opt_client_dbx ) {
+    dbx_arguments(\$args, \$exe, "client");
+  }
+  elsif ( $opt_client_debugger )
+  {
+    debugger_arguments(\$args, \$exe, "client");
+  }
+
+  my $proc= My::SafeProcess->new
+    (
+     name          => "mysqltest",
+     path          => $exe,
+     args          => \$args,
+     append        => 1,
+     error         => $path_current_testlog,
+     verbose       => $opt_verbose,
+    );
+  mtr_verbose("Started $proc");
+  return $proc;
+}
+
+sub create_debug_statement {
+  my $args= shift;
+  my $input= shift;
+
+  # Put $args into a single string
+  my $str= join(" ", @$$args);
+  my $runline= $input ? "run $str < $input" : "run $str";
+
+  # add quotes to escape ; in plugin_load option
+  my $pos1 = index($runline, "--plugin_load=");
+  if ( $pos1 != -1 ) {
+    my $pos2 = index($runline, " ",$pos1);
+    substr($runline,$pos1+14,0) = "\"";
+    substr($runline,$pos2+1,0) = "\"";
+  }
+
+  return $runline;
+}
+
+#
+# Modify the exe and args so that program is run in gdb in xterm
+#
+sub gdb_arguments {
+  my $args= shift;
+  my $exe=  shift;
+  my $type= shift;
+  my $input= shift;
+
+  my $gdb_init_file= "$opt_vardir/tmp/gdbinit.$type";
+
+  # Remove the old gdbinit file
+  unlink($gdb_init_file);
+
+  my $runline=create_debug_statement($args,$input);
+
+  # write init file for mysqld or client
+  mtr_tofile($gdb_init_file,
+	     "break main\n" .
+	     $runline);
+
+  if ( $opt_manual_gdb )
+  {
+     print "\nTo start gdb for $type, type in another window:\n";
+     print "gdb -cd $glob_mysql_test_dir -x $gdb_init_file $$exe\n";
+
+     # Indicate the exe should not be started
+     $$exe= undef;
+     return;
+  }
+
+  $$args= [];
+  mtr_add_arg($$args, "-title");
+  mtr_add_arg($$args, "$type");
+  mtr_add_arg($$args, "-e");
+
+  if ( $exe_libtool )
+  {
+    mtr_add_arg($$args, $exe_libtool);
+    mtr_add_arg($$args, "--mode=execute");
+  }
+
+  mtr_add_arg($$args, "gdb");
+  mtr_add_arg($$args, "-x");
+  mtr_add_arg($$args, "$gdb_init_file");
+  mtr_add_arg($$args, "$$exe");
+
+  $$exe= "xterm";
+}
+
+ #
+# Modify the exe and args so that program is run in lldb
+#
+sub lldb_arguments {
+  my $args= shift;
+  my $exe= shift;
+  my $type= shift;
+  my $input= shift;
+
+  my $lldb_init_file= "$opt_vardir/tmp/lldbinit.$type";
+  unlink($lldb_init_file);
+
+  my $runline=create_debug_statement($args,$input);
+
+  # write init file for mysqld or client
+  mtr_tofile($lldb_init_file,
+	     "b main\n" .
+	     $runline);
+
+    print "\nTo start lldb for $type, type in another window:\n";
+    print "cd $glob_mysql_test_dir && lldb -s $lldb_init_file $$exe\n";
+
+    # Indicate the exe should not be started
+    $$exe= undef;
+    return;
+}
+
+#
+# Modify the exe and args so that program is run in ddd
+#
+sub ddd_arguments {
+  my $args= shift;
+  my $exe=  shift;
+  my $type= shift;
+  my $input= shift;
+
+  my $gdb_init_file= "$opt_vardir/tmp/gdbinit.$type";
+
+  # Remove the old gdbinit file
+  unlink($gdb_init_file);
+
+  my $runline=create_debug_statement($args,$input);
+
+  # write init file for mysqld or client
+  mtr_tofile($gdb_init_file,
+	     "file $$exe\n" .
+	     "break main\n" .
+	     $runline);
+
+  if ( $opt_manual_ddd )
+  {
+     print "\nTo start ddd for $type, type in another window:\n";
+     print "ddd -cd $glob_mysql_test_dir -x $gdb_init_file $$exe\n";
+
+     # Indicate the exe should not be started
+     $$exe= undef;
+     return;
+  }
+
+  my $save_exe= $$exe;
+  $$args= [];
+  if ( $exe_libtool )
+  {
+    $$exe= $exe_libtool;
+    mtr_add_arg($$args, "--mode=execute");
+    mtr_add_arg($$args, "ddd");
+  }
+  else
+  {
+    $$exe= "ddd";
+  }
+  mtr_add_arg($$args, "--command=$gdb_init_file");
+  mtr_add_arg($$args, "$save_exe");
+}
+
+
+#
+# Modify the exe and args so that program is run in dbx in xterm
+#
+sub dbx_arguments {
+  my $args= shift;
+  my $exe=  shift;
+  my $type= shift;
+  my $input= shift;
+
+  # Put $args into a single string
+  my $str= join " ", @$$args;
+  my $runline= $input ? "run $str < $input" : "run $str";
+
+  if ( $opt_manual_dbx ) {
+    print "\nTo start dbx for $type, type in another window:\n";
+    print "cd $glob_mysql_test_dir; dbx -c \"stop in main; " .
+          "$runline\" $$exe\n";
+
+    # Indicate the exe should not be started
+    $$exe= undef;
+    return;
+  }
+
+  $$args= [];
+  mtr_add_arg($$args, "-title");
+  mtr_add_arg($$args, "$type");
+  mtr_add_arg($$args, "-e");
+
+  if ( $exe_libtool ) {
+    mtr_add_arg($$args, $exe_libtool);
+    mtr_add_arg($$args, "--mode=execute");
+  }
+
+  mtr_add_arg($$args, "dbx");
+  mtr_add_arg($$args, "-c");
+  mtr_add_arg($$args, "stop in main; $runline");
+  mtr_add_arg($$args, "$$exe");
+
+  $$exe= "xterm";
+}
+
+
+#
+# Modify the exe and args so that program is run in the selected debugger
+#
+sub debugger_arguments {
+  my $args= shift;
+  my $exe=  shift;
+  my $debugger= $opt_debugger || $opt_client_debugger;
+
+  if ( $debugger =~ /vcexpress|vc|devenv/ )
+  {
+    # vc[express] /debugexe exe arg1 .. argn
+
+    # Add name of the exe and /debugexe before args
+    unshift(@$$args, "$$exe");
+    unshift(@$$args, "/debugexe");
+
+    # Set exe to debuggername
+    $$exe= $debugger;
+
+  }
+  elsif ( $debugger =~ /windbg/ )
+  {
+    # windbg exe arg1 .. argn
+
+    # Add name of the exe before args
+    unshift(@$$args, "$$exe");
+
+    # Set exe to debuggername
+    $$exe= $debugger;
+
+  }
+  else
+  {
+    mtr_error("Unknown argument \"$debugger\" passed to --debugger");
+  }
+}
+
+#
+# Modify the exe and args so that program is run in strace 
+#
+sub strace_server_arguments {
+  my $args= shift;
+  my $exe=  shift;
+  my $type= shift;
+
+  mtr_add_arg($args, "-o");
+  mtr_add_arg($args, "%s/log/%s.strace", $opt_vardir, $type);
+  mtr_add_arg($args, $$exe);
+  $$exe= "strace";
+}
+
+#
+# Modify the exe and args so that program is run in valgrind
+#
+sub valgrind_arguments {
+  my $args= shift;
+  my $exe=  shift;
+
+  if ( $opt_callgrind)
+  {
+    mtr_add_arg($args, "--tool=callgrind");
+    mtr_add_arg($args, "--base=$opt_vardir/log");
+  }
+  else
+  {
+    mtr_add_arg($args, "--tool=memcheck"); # From >= 2.1.2 needs this option
+    mtr_add_arg($args, "--leak-check=yes");
+    mtr_add_arg($args, "--num-callers=16");
+    mtr_add_arg($args, "--suppressions=%s/valgrind.supp", $glob_mysql_test_dir)
+      if -f "$glob_mysql_test_dir/valgrind.supp";
+  }
+
+  # Add valgrind options, can be overriden by user
+  mtr_add_arg($args, '%s', $_) for (@valgrind_args);
+
+  mtr_add_arg($args, $$exe);
+
+  $$exe= $opt_valgrind_path || "valgrind";
+
+  if ($exe_libtool)
+  {
+    # Add "libtool --mode-execute" before the test to execute
+    # if running in valgrind(to avoid valgrinding bash)
+    unshift(@$args, "--mode=execute", $$exe);
+    $$exe= $exe_libtool;
+  }
+}
+
+#
+# Search server logs for valgrind reports printed at mysqld termination
+#
+
+sub valgrind_exit_reports() {
+  my $found_err= 0;
+
+  foreach my $log_file (keys %mysqld_logs)
+  {
+    my @culprits= ();
+    my $valgrind_rep= "";
+    my $found_report= 0;
+    my $err_in_report= 0;
+
+    my $LOGF = IO::File->new($log_file)
+      or mtr_error("Could not open file '$log_file' for reading: $!");
+
+    while ( my $line = <$LOGF> )
+    {
+      if ($line =~ /^CURRENT_TEST: (.+)$/)
+      {
+        my $testname= $1;
+        # If we have a report, report it if needed and start new list of tests
+        if ($found_report)
+        {
+          if ($err_in_report)
+          {
+            mtr_print ("Valgrind report from $log_file after tests:\n",
+                        @culprits);
+            mtr_print_line();
+            print ("$valgrind_rep\n");
+            $found_err= 1;
+            $err_in_report= 0;
+          }
+          # Make ready to collect new report
+          @culprits= ();
+          $found_report= 0;
+          $valgrind_rep= "";
+        }
+        push (@culprits, $testname);
+        next;
+      }
+      # This line marks the start of a valgrind report
+      $found_report= 1 if $line =~ /^==\d+== .* SUMMARY:/;
+
+      if ($found_report) {
+        $line=~ s/^==\d+== //;
+        $valgrind_rep .= $line;
+        $err_in_report= 1 if $line =~ /ERROR SUMMARY: [1-9]/;
+        $err_in_report= 1 if $line =~ /definitely lost: [1-9]/;
+        $err_in_report= 1 if $line =~ /possibly lost: [1-9]/;
+      }
+    }
+
+    $LOGF= undef;
+
+    if ($err_in_report) {
+      mtr_print ("Valgrind report from $log_file after tests:\n", @culprits);
+      mtr_print_line();
+      print ("$valgrind_rep\n");
+      $found_err= 1;
+    }
+  }
+
+  return $found_err;
+}
+
+sub run_ctest() {
+  my $olddir= getcwd();
+  chdir ($bindir) or die ("Could not chdir to $bindir");
+  my $tinfo;
+  my $no_ctest= (IS_WINDOWS) ? 256 : -1;
+  my $ctest_vs= "";
+
+  # Just ignore if not configured/built to run ctest
+  if (! -f "CTestTestfile.cmake") {
+    chdir($olddir);
+    return;
+  }
+
+  # Add vs-config option if needed
+  $ctest_vs= "-C $opt_vs_config" if $opt_vs_config;
+
+  # Also silently ignore if we don't have ctest and didn't insist
+  # Special override: also ignore in Pushbuild, some platforms may not have it
+  # Now, run ctest and collect output
+  my $ctest_out= `ctest $ctest_vs 2>&1`;
+  if ($? == $no_ctest && ($opt_ctest == -1 || defined $ENV{PB2WORKDIR})) {
+    chdir($olddir);
+    return;
+  }
+
+  # Create minimalistic "test" for the reporting
+  $tinfo = My::Test->new
+    (
+     name           => 'unit_tests',
+    );
+  # Set dummy worker id to align report with normal tests
+  $tinfo->{worker} = 0 if $opt_parallel > 1;
+
+  my $ctfail= 0;		# Did ctest fail?
+  if ($?) {
+    $ctfail= 1;
+    $tinfo->{result}= 'MTR_RES_FAILED';
+    $tinfo->{comment}= "ctest failed with exit code $?, see result below";
+    $ctest_out= "" unless $ctest_out;
+  }
+  my $ctfile= "$opt_vardir/ctest.log";
+  my $ctres= 0;			# Did ctest produce report summary?
+
+  open (CTEST, " > $ctfile") or die ("Could not open output file $ctfile");
+
+  $ctest_report .= $ctest_out if $opt_ctest_report;
+
+  # Put ctest output in log file, while analyzing results
+  for (split ('\n', $ctest_out)) {
+    print CTEST "$_\n";
+    if (/tests passed/) {
+      $ctres= 1;
+      $ctest_report .= "\nUnit tests: $_\n";
+    }
+    if ( /FAILED/ or /\(Failed\)/ ) {
+      $ctfail= 1;
+      $ctest_report .= "  $_\n";
+    }
+  }
+  close CTEST;
+
+  # Set needed 'attributes' for test reporting
+  $tinfo->{comment}.= "\nctest did not pruduce report summary" if ! $ctres;
+  $tinfo->{result}= ($ctres && !$ctfail)
+    ? 'MTR_RES_PASSED' : 'MTR_RES_FAILED';
+  $ctest_report .= "Report from unit tests in $ctfile";
+  $tinfo->{failures}= ($tinfo->{result} eq 'MTR_RES_FAILED');
+
+  mark_time_used('test');
+  mtr_report_test($tinfo);
+  chdir($olddir);
+  return $tinfo;
+}
+
+#
+# Usage
+#
+sub usage ($) {
+  my ($message)= @_;
+
+  if ( $message )
+  {
+    print STDERR "$message\n";
+  }
+
+  print <<HERE;
+
+$0 [ OPTIONS ] [ TESTCASE ]
+
+Options to control what engine/variation to run
+
+  embedded-server       Use the embedded server, i.e. no mysqld daemons
+  ps-protocol           Use the binary protocol between client and server
+  cursor-protocol       Use the cursor protocol between client and server
+                        (implies --ps-protocol)
+  view-protocol         Create a view to execute all non updating queries
+  sp-protocol           Create a stored procedure to execute all queries
+  compress              Use the compressed protocol between client and server
+  ssl                   Use ssl protocol between client and server
+  skip-ssl              Dont start server with support for ssl connections
+  vs-config             Visual Studio configuration used to create executables
+                        (default: MTR_VS_CONFIG environment variable)
+
+  defaults-file=<config template> Use fixed config template for all
+                        tests
+  defaults-extra-file=<config template> Extra config template to add to
+                        all generated configs
+  combination=<opt>     Use at least twice to run tests with specified 
+                        options to mysqld
+  skip-combinations     Ignore combination file (or options)
+
+Options to control directories to use
+  tmpdir=DIR            The directory where temporary files are stored
+                        (default: ./var/tmp).
+  vardir=DIR            The directory where files generated from the test run
+                        is stored (default: ./var). Specifying a ramdisk or
+                        tmpfs will speed up tests.
+  mem                   Run testsuite in "memory" using tmpfs or ramdisk
+                        Attempts to find a suitable location
+                        using a builtin list of standard locations
+                        for tmpfs (/dev/shm)
+                        The option can also be set using environment
+                        variable MTR_MEM=[DIR]
+  clean-vardir          Clean vardir if tests were successful and if
+                        running in "memory". Otherwise this option is ignored
+  client-bindir=PATH    Path to the directory where client binaries are located
+  client-libdir=PATH    Path to the directory where client libraries are located
+
+
+Options to control what test suites or cases to run
+
+  force                 Continue to run the suite after failure
+  with-ndbcluster-only  Run only tests that include "ndb" in the filename
+  skip-ndb[cluster]     Skip all tests that need cluster. Default.
+  include-ndb[cluster]  Enable all tests that need cluster
+  do-test=PREFIX or REGEX
+                        Run test cases which name are prefixed with PREFIX
+                        or fulfills REGEX
+  skip-test=PREFIX or REGEX
+                        Skip test cases which name are prefixed with PREFIX
+                        or fulfills REGEX
+  start-from=PREFIX     Run test cases starting test prefixed with PREFIX where
+                        prefix may be suite.testname or just testname
+  suite[s]=NAME1,..,NAMEN
+                        Collect tests in suites from the comma separated
+                        list of suite names.
+                        The default is: "$DEFAULT_SUITES"
+  skip-rpl              Skip the replication test cases.
+  big-test              Also run tests marked as "big"
+  enable-disabled       Run also tests marked as disabled
+  print-testcases       Don't run the tests but print details about all the
+                        selected tests, in the order they would be run.
+  skip-test-list=FILE   Skip the tests listed in FILE. Each line in the file
+                        is an entry and should be formatted as: 
+                        <TESTNAME> : <COMMENT>
+
+Options that specify ports
+
+  mtr-port-base=#       Base for port numbers, ports from this number to
+  port-base=#           number+9 are reserved. Should be divisible by 10;
+                        if not it will be rounded down. May be set with
+                        environment variable MTR_PORT_BASE. If this value is
+                        set and is not "auto", it overrides build-thread.
+  mtr-build-thread=#    Specify unique number to calculate port number(s) from.
+  build-thread=#        Can be set in environment variable MTR_BUILD_THREAD.
+                        Set  MTR_BUILD_THREAD="auto" to automatically aquire
+                        a build thread id that is unique to current host
+
+Options for test case authoring
+
+  record TESTNAME       (Re)genereate the result file for TESTNAME
+  check-testcases       Check testcases for sideeffects
+  mark-progress         Log line number and elapsed time to <testname>.progress
+
+Options that pass on options (these may be repeated)
+
+  mysqld=ARGS           Specify additional arguments to "mysqld"
+  mysqld-env=VAR=VAL    Specify additional environment settings for "mysqld"
+
+Options to run test on running server
+
+  extern option=value   Run only the tests against an already started server
+                        the options to use for connection to the extern server
+                        must be specified using name-value pair notation
+                        For example:
+                         ./$0 --extern socket=/tmp/mysqld.sock
+
+Options for debugging the product
+
+  boot-dbx              Start bootstrap server in dbx
+  boot-ddd              Start bootstrap server in ddd
+  boot-gdb              Start bootstrap server in gdb
+  client-dbx            Start mysqltest client in dbx
+  client-ddd            Start mysqltest client in ddd
+  client-debugger=NAME  Start mysqltest in the selected debugger
+  client-gdb            Start mysqltest client in gdb
+  dbx                   Start the mysqld(s) in dbx
+  ddd                   Start the mysqld(s) in ddd
+  debug                 Dump trace output for all servers and client programs
+  debug-common          Same as debug, but sets 'd' debug flags to
+                        "query,info,error,enter,exit"
+  debug-server          Use debug version of server, but without turning on
+                        tracing
+  debugger=NAME         Start mysqld in the selected debugger
+  gdb                   Start the mysqld(s) in gdb
+  manual-debug          Let user manually start mysqld in debugger, before
+                        running test(s)
+  manual-gdb            Let user manually start mysqld in gdb, before running
+                        test(s)
+  manual-ddd            Let user manually start mysqld in ddd, before running
+                        test(s)
+  manual-dbx            Let user manually start mysqld in dbx, before running
+                        test(s)
+  manual-lldb           Let user manually start mysqld in lldb, before running 
+                        test(s)
+  strace-client         Create strace output for mysqltest client, 
+  strace-server         Create strace output for mysqltest server, 
+  max-save-core         Limit the number of core files saved (to avoid filling
+                        up disks for heavily crashing server). Defaults to
+                        $opt_max_save_core, set to 0 for no limit. Set
+                        it's default with MTR_MAX_SAVE_CORE
+  max-save-datadir      Limit the number of datadir saved (to avoid filling
+                        up disks for heavily crashing server). Defaults to
+                        $opt_max_save_datadir, set to 0 for no limit. Set
+                        it's default with MTR_MAX_SAVE_DATDIR
+  max-test-fail         Limit the number of test failurs before aborting
+                        the current test run. Defaults to
+                        $opt_max_test_fail, set to 0 for no limit. Set
+                        it's default with MTR_MAX_TEST_FAIL
+
+Options for valgrind
+
+  valgrind              Run the "mysqltest" and "mysqld" executables using
+                        valgrind with default options
+  valgrind-all          Synonym for --valgrind
+  valgrind-mysqltest    Run the "mysqltest" and "mysql_client_test" executable
+                        with valgrind
+  valgrind-mysqld       Run the "mysqld" executable with valgrind
+  valgrind-options=ARGS Deprecated, use --valgrind-option
+  valgrind-option=ARGS  Option to give valgrind, replaces default option(s),
+                        can be specified more then once
+  valgrind-path=<EXE>   Path to the valgrind executable
+  callgrind             Instruct valgrind to use callgrind
+
+Misc options
+  user=USER             User for connecting to mysqld(default: $opt_user)
+  comment=STR           Write STR to the output
+  timer                 Show test case execution time.
+  verbose               More verbose output(use multiple times for even more)
+  verbose-restart       Write when and why servers are restarted
+  start                 Only initialize and start the servers, using the
+                        startup settings for the first specified test case
+                        Example:
+                         $0 --start alias &
+  start-and-exit        Same as --start, but mysql-test-run terminates and
+                        leaves just the server running
+  start-dirty           Only start the servers (without initialization) for
+                        the first specified test case
+  user-args             In combination with start* and no test name, drops
+                        arguments to mysqld except those speficied with
+                        --mysqld (if any)
+  wait-all              If --start or --start-dirty option is used, wait for all
+                        servers to exit before finishing the process
+  fast                  Run as fast as possible, dont't wait for servers
+                        to shutdown etc.
+  force-restart         Always restart servers between tests
+  parallel=N            Run tests in N parallel threads (default=1)
+                        Use parallel=auto for auto-setting of N
+  repeat=N              Run each test N number of times
+  retry=N               Retry tests that fail N times, limit number of failures
+                        to $opt_retry_failure
+  retry-failure=N       Limit number of retries for a failed test
+  reorder               Reorder tests to get fewer server restarts
+  help                  Get this help text
+
+  testcase-timeout=MINUTES Max test case run time (default $opt_testcase_timeout)
+  suite-timeout=MINUTES Max test suite run time (default $opt_suite_timeout)
+  shutdown-timeout=SECONDS Max number of seconds to wait for server shutdown
+                        before killing servers (default $opt_shutdown_timeout)
+  warnings              Scan the log files for warnings. Use --nowarnings
+                        to turn off.
+
+  sleep=SECONDS         Passed to mysqltest, will be used as fixed sleep time
+  debug-sync-timeout=NUM Set default timeout for WAIT_FOR debug sync
+                        actions. Disable facility with NUM=0.
+  gcov                  Collect coverage information after the test.
+                        The result is a gcov file per source and header file.
+  gprof                 Collect profiling information using gprof.
+  experimental=<file>   Refer to list of tests considered experimental;
+                        failures will be marked exp-fail instead of fail.
+  report-features       First run a "test" that reports mysql features
+  timestamp             Print timestamp before each test report line
+  timediff              With --timestamp, also print time passed since
+                        *previous* test started
+  max-connections=N     Max number of open connection to server in mysqltest
+  default-myisam        Set default storage engine to MyISAM for non-innodb
+                        tests. This is needed after switching default storage
+                        engine to InnoDB.
+  report-times          Report how much time has been spent on different
+                        phases of test execution.
+  nounit-tests          Do not run unit tests. Normally run if configured
+                        and if not running named tests/suites
+  unit-tests            Run unit tests even if they would otherwise not be run
+  unit-tests-report     Include report of every test included in unit tests.
+  stress=ARGS           Run stress test, providing options to
+                        mysql-stress-test.pl. Options are separated by comma.
+
+Some options that control enabling a feature for normal test runs,
+can be turned off by prepending 'no' to the option, e.g. --notimer.
+This applies to reorder, timer, check-testcases and warnings.
+
+HERE
+  exit(1);
+
+}
+
+sub list_options ($) {
+  my $hash= shift;
+
+  for (keys %$hash) {
+    s/([:=].*|[+!])$//;
+    s/\|/\n--/g;
+    print "--$_\n" unless /list-options/;
+  }
+
+  exit(1);
+}
+
diff -uNr mysql-5.5.60.orig/mysql-test/suite/funcs_1/views/func_view.inc mysql-5.5.60/mysql-test/suite/funcs_1/views/func_view.inc
--- mysql-5.5.60.orig/mysql-test/suite/funcs_1/views/func_view.inc	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/mysql-test/suite/funcs_1/views/func_view.inc	2018-12-02 00:06:23.389892015 +0800
@@ -282,7 +282,7 @@
 #               other interesting value
 #     numbers   -> 0
 #     strings, blobs, binaries -> not full length of used data type, "exotic"
-#                                 characters and preceeding and trailing spaces
+#                                 characters and preceding and trailing spaces
 #     FIXME enum, set ??
 INSERT INTO t1_values SET
        my_char_30 = ' ---@*$-- ',
diff -uNr mysql-5.5.60.orig/mysql-test/suite/funcs_1/views/views_master.inc mysql-5.5.60/mysql-test/suite/funcs_1/views/views_master.inc
--- mysql-5.5.60.orig/mysql-test/suite/funcs_1/views/views_master.inc	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/mysql-test/suite/funcs_1/views/views_master.inc	2018-12-02 00:06:23.389892015 +0800
@@ -545,7 +545,7 @@
 #                   view names are accepted, at creation time, alteration time,
 #                   and drop time.
 ###############################################################################
-# Note(mleich): non-qualified view name means a view name without preceeding
+# Note(mleich): non-qualified view name means a view name without preceding
 #               database name
 --disable_warnings
 DROP VIEW  IF EXISTS v1 ;
diff -uNr mysql-5.5.60.orig/mysql-test/suite/rpl/t/disabled.def mysql-5.5.60/mysql-test/suite/rpl/t/disabled.def
--- mysql-5.5.60.orig/mysql-test/suite/rpl/t/disabled.def	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/mysql-test/suite/rpl/t/disabled.def	2018-12-02 00:06:23.373891850 +0800
@@ -13,3 +13,4 @@
 rpl_row_create_table      : Bug#11759274 2010-02-27 andrei failed different way than earlier with bug#45576
 rpl_spec_variables        : BUG#11755836 2009-10-27 jasonh rpl_spec_variables fails on PB2 hpux
 rpl_get_master_version_and_clock : Bug#11766137 Jan 05 2011 joro Valgrind warnings rpl_get_master_version_and_clock
++rpl_heartbeat_basic : Fails intermittently on AMD64 buildds http://pad.lv/894146
diff -uNr mysql-5.5.60.orig/mysql-test/suite/rpl/t/rpl_ddl.test mysql-5.5.60/mysql-test/suite/rpl/t/rpl_ddl.test
--- mysql-5.5.60.orig/mysql-test/suite/rpl/t/rpl_ddl.test	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/mysql-test/suite/rpl/t/rpl_ddl.test	2018-12-02 00:06:23.389892015 +0800
@@ -13,10 +13,10 @@
 #         sequences start.
 #
 #      2. Never use a test object, which was direct or indirect affected by a
-#         preceeding test sequence again.
+#         preceding test sequence again.
 #         Except table d1.t1 where ONLY DML is allowed.
 #
-#         If one preceeding test sequence hits a (sometimes not good visible,
+#         If one preceding test sequence hits a (sometimes not good visible,
 #         because the sql error code of the statement might be 0) bug
 #         and these rules are ignored, a following test sequence might earn ugly
 #         effects like failing 'sync_slave_with_master', crashes of the slave or
diff -uNr mysql-5.5.60.orig/mysql-test/suite/rpl/t/rpl_row_basic_11bugs.test mysql-5.5.60/mysql-test/suite/rpl/t/rpl_row_basic_11bugs.test
--- mysql-5.5.60.orig/mysql-test/suite/rpl/t/rpl_row_basic_11bugs.test	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/mysql-test/suite/rpl/t/rpl_row_basic_11bugs.test	2018-12-02 00:06:23.389892015 +0800
@@ -239,7 +239,7 @@
 UPDATE t1 SET a = 5, b = 'slave' WHERE a = 1;
 SELECT * FROM t1 ORDER BY a;
 # since bug#31552/31609 idempotency is not default any longer. In
-# order for the preceeding test UPDATE t1 to pass, the mode is switched
+# order for the preceding test UPDATE t1 to pass, the mode is switched
 # temprorarily
 set @@global.slave_exec_mode= 'IDEMPOTENT';
 --echo **** On Master ****
diff -uNr mysql-5.5.60.orig/mysql-test/suite/sys_vars/t/character_sets_dir_basic.test mysql-5.5.60/mysql-test/suite/sys_vars/t/character_sets_dir_basic.test
--- mysql-5.5.60.orig/mysql-test/suite/sys_vars/t/character_sets_dir_basic.test	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/mysql-test/suite/sys_vars/t/character_sets_dir_basic.test	2018-12-02 00:06:23.401892138 +0800
@@ -7,6 +7,7 @@
 # TODO: fix with a proper comparison in mysqltest
 let $rcd= `SELECT REPLACE('$MYSQL_CHARSETSDIR', '\\\\\', '.')`;
 let $rcd= `SELECT REPLACE('$rcd', '/', '.')`;
+let $rcd= `SELECT REPLACE('$rcd', '+', '.')`;
 let $regex_charsetdir= `SELECT '/$rcd[\\\\\/\\\\\]/MYSQL_CHARSETSDIR/'`;
 
 --replace_regex $regex_charsetdir
diff -uNr mysql-5.5.60.orig/mysql-test/t/disabled.def mysql-5.5.60/mysql-test/t/disabled.def
--- mysql-5.5.60.orig/mysql-test/t/disabled.def	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/mysql-test/t/disabled.def	2018-12-02 00:06:23.361891727 +0800
@@ -14,3 +14,8 @@
 sum_distinct-big         : Bug#11764126 2010-11-15 mattiasj was not tested
 archive-big              : Bug#11817185 2011-03-10 Anitha Disabled since this leads to timeout on Solaris Sparc
 mysql_embedded           : Bug#12561297 2011-05-14 Anitha Dependent on PB2 changes - eventum#41836
+partition_rename_longfilename : Fails when building with sbuild and schroots
+file_contents            : Fails without bzr revision id
+mysqlslap		 : n/a	2012-04-29 Failed once on kfreebsd
+mysqlhotcopy_isam	 : n/a  2012-04-29 Olaf van der Spek reported this failure
+mysqlhotcopy_archive	 : n/a  2012-04-29 Olaf van der Spek reported this failure
diff -uNr mysql-5.5.60.orig/scripts/mysql_install_db.sh mysql-5.5.60/scripts/mysql_install_db.sh
--- mysql-5.5.60.orig/scripts/mysql_install_db.sh	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/scripts/mysql_install_db.sh	2018-12-02 00:06:23.421892344 +0800
@@ -356,7 +356,7 @@
 fi
 
 # Create database directories
-for dir in $ldata $ldata/mysql $ldata/test
+for dir in $ldata $ldata/mysql
 do
   if test ! -d $dir
   then
diff -uNr mysql-5.5.60.orig/scripts/mysql_system_tables_data.sql mysql-5.5.60/scripts/mysql_system_tables_data.sql
--- mysql-5.5.60.orig/scripts/mysql_system_tables_data.sql	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/scripts/mysql_system_tables_data.sql	2018-12-02 00:06:23.421892344 +0800
@@ -30,8 +30,6 @@
 -- Fill "db" table with default grants for anyone to
 -- access database 'test' and 'test_%' if "db" table didn't exist
 CREATE TEMPORARY TABLE tmp_db LIKE db;
-INSERT INTO tmp_db VALUES ('%','test','','Y','Y','Y','Y','Y','Y','N','Y','Y','Y','Y','Y','Y','Y','Y','N','N','Y','Y');
-INSERT INTO tmp_db VALUES ('%','test\_%','','Y','Y','Y','Y','Y','Y','N','Y','Y','Y','Y','Y','Y','Y','Y','N','N','Y','Y');
 INSERT INTO db SELECT * FROM tmp_db WHERE @had_db_table=0;
 DROP TABLE tmp_db;
 
@@ -43,8 +41,6 @@
 REPLACE INTO tmp_user SELECT @current_hostname,'root','','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'','' FROM dual WHERE @current_hostname != 'localhost';
 REPLACE INTO tmp_user VALUES ('127.0.0.1','root','','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'','');
 REPLACE INTO tmp_user VALUES ('::1','root','','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'','');
-INSERT INTO tmp_user (host,user) VALUES ('localhost','');
-INSERT INTO tmp_user (host,user) SELECT @current_hostname,'' FROM dual WHERE @current_hostname != 'localhost';
 INSERT INTO user SELECT * FROM tmp_user WHERE @had_user_table=0;
 DROP TABLE tmp_user;
 
diff -uNr mysql-5.5.60.orig/scripts/mysqld_safe.sh mysql-5.5.60/scripts/mysqld_safe.sh
--- mysql-5.5.60.orig/scripts/mysqld_safe.sh	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/scripts/mysqld_safe.sh	2018-12-02 00:06:23.357891685 +0800
@@ -31,8 +31,6 @@
 syslog_tag_mysqld=mysqld
 syslog_tag_mysqld_safe=mysqld_safe
 
-trap '' 1 2 3 15			# we shouldn't let anyone kill us
-
 # MySQL-specific environment variable. First off, it's not really a umask,
 # it's the desired mode. Second, it follows umask(2), not umask(3) in that
 # octal needs to be explicit. Our shell might be a proper sh without printf,
@@ -170,7 +168,7 @@
       # sed buffers output (only GNU sed supports a -u (unbuffered) option)
       # which means that messages may not get sent to syslog until the
       # mysqld process quits.
-      cmd="$cmd 2>&1 | logger -t '$syslog_tag_mysqld' -p daemon.error"
+      cmd="$cmd 2>&1 | logger -t '$syslog_tag_mysqld' -p daemon.error & wait"
       ;;
     *)
       echo "Internal program error (non-fatal):" \
@@ -819,6 +817,13 @@
 fi
 
 #
+# From now on, we catch signals to do a proper shutdown of mysqld
+# when signalled to do so.
+#
+trap '/usr/bin/mysqladmin --defaults-extra-file=/etc/mysql/debian.cnf refresh & wait' 1 # HUP
+trap '/usr/bin/mysqladmin --defaults-extra-file=/etc/mysql/debian.cnf shutdown' 2 3 15 # INT QUIT and TERM
+
+#
 # Uncomment the following lines if you want all tables to be automatically
 # checked and repaired during startup. You should add sensible key_buffer
 # and sort_buffer values to my.cnf to improve check performance or require
diff -uNr mysql-5.5.60.orig/scripts/mysqld_safe.sh.orig mysql-5.5.60/scripts/mysqld_safe.sh.orig
--- mysql-5.5.60.orig/scripts/mysqld_safe.sh.orig	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/scripts/mysqld_safe.sh.orig	2018-02-26 21:02:31.000000000 +0800
@@ -0,0 +1,970 @@
+#!@SHELL_PATH@
+# Copyright Abandoned 1996 TCX DataKonsult AB & Monty Program KB & Detron HB
+# This file is public domain and comes with NO WARRANTY of any kind
+#
+# Script to start the MySQL daemon and restart it if it dies unexpectedly
+#
+# This should be executed in the MySQL base directory if you are using a
+# binary installation that is not installed in its compile-time default
+# location
+#
+# mysql.server works by first doing a cd to the base directory and from there
+# executing mysqld_safe
+
+# Initialize script globals
+KILL_MYSQLD=1;
+MYSQLD=
+niceness=0
+mysqld_ld_preload=
+mysqld_ld_library_path=
+
+# Initial logging status: error log is not open, and not using syslog
+logging=init
+want_syslog=0
+syslog_tag=
+user='@MYSQLD_USER@'
+pid_file=
+pid_file_append=
+err_log=
+err_log_append=
+
+syslog_tag_mysqld=mysqld
+syslog_tag_mysqld_safe=mysqld_safe
+
+trap '' 1 2 3 15			# we shouldn't let anyone kill us
+
+# MySQL-specific environment variable. First off, it's not really a umask,
+# it's the desired mode. Second, it follows umask(2), not umask(3) in that
+# octal needs to be explicit. Our shell might be a proper sh without printf,
+# multiple-base arithmetic, and binary arithmetic, so this will get ugly.
+# We reject decimal values to keep things at least half-sane.
+umask 007                               # fallback
+UMASK="${UMASK-0640}"
+fmode=`echo "$UMASK" | sed -e 's/[^0246]//g'`
+octalp=`echo "$fmode"|cut -c1`
+fmlen=`echo "$fmode"|wc -c|sed -e 's/ //g'`
+if [ "x$octalp" != "x0" -o "x$UMASK" != "x$fmode" -o "x$fmlen" != "x5" ]
+then
+  fmode=0640
+  echo "UMASK must be a 3-digit mode with an additional leading 0 to indicate octal." >&2
+  echo "The first digit will be corrected to 6, the others may be 0, 2, 4, or 6." >&2
+fi
+fmode=`echo "$fmode"|cut -c3-4`
+fmode="6$fmode"
+if [ "x$UMASK" != "x0$fmode" ]
+then
+  echo "UMASK corrected from $UMASK to 0$fmode ..."
+fi
+
+defaults=
+case "$1" in
+    --no-defaults|--defaults-file=*|--defaults-extra-file=*)
+      defaults="$1"; shift
+      ;;
+esac
+
+usage () {
+        cat <<EOF
+Usage: $0 [OPTIONS]
+ The following options may be given as the first argument:
+  --no-defaults              Don't read the system defaults file
+  --defaults-file=FILE       Use the specified defaults file
+  --defaults-extra-file=FILE Also use defaults from the specified file
+
+ Other options:
+  --ledir=DIRECTORY          Look for mysqld in the specified directory
+  --open-files-limit=LIMIT   Limit the number of open files
+  --core-file-size=LIMIT     Limit core files to the specified size
+  --timezone=TZ              Set the system timezone
+  --malloc-lib=LIB           Preload shared library LIB if available
+  --mysqld=FILE              Use the specified file as mysqld
+  --mysqld-version=VERSION   Use "mysqld-VERSION" as mysqld
+  --nice=NICE                Set the scheduling priority of mysqld
+  --plugin-dir=DIR           Plugins are under DIR or DIR/VERSION, if
+                             VERSION is given
+  --skip-kill-mysqld         Don't try to kill stray mysqld processes
+  --syslog                   Log messages to syslog with 'logger'
+  --skip-syslog              Log messages to error log (default)
+  --syslog-tag=TAG           Pass -t "mysqld-TAG" to 'logger'
+
+All other options are passed to the mysqld program.
+
+EOF
+        exit 1
+}
+
+my_which ()
+{
+  save_ifs="${IFS-UNSET}"
+  IFS=:
+  ret=0
+  for file
+  do
+    for dir in $PATH
+    do
+      if [ -f "$dir/$file" ]
+      then
+        echo "$dir/$file"
+        continue 2
+      fi
+    done
+
+	ret=1  #signal an error
+	break
+  done
+
+  if [ "$save_ifs" = UNSET ]
+  then
+    unset IFS
+  else
+    IFS="$save_ifs"
+  fi
+  return $ret  # Success
+}
+
+log_generic () {
+  priority="$1"
+  shift
+
+  msg="`date +'%y%m%d %H:%M:%S'` mysqld_safe $*"
+  echo "$msg"
+  case $logging in
+    init) ;;  # Just echo the message, don't save it anywhere
+    file)
+      if [ -w / -o "$USER" = "root" ]; then
+        true
+      else
+        echo "$msg" >> "$err_log"
+      fi
+      ;;
+    syslog) logger -t "$syslog_tag_mysqld_safe" -p "$priority" "$*" ;;
+    *)
+      echo "Internal program error (non-fatal):" \
+           " unknown logging method '$logging'" >&2
+      ;;
+  esac
+}
+
+log_error () {
+  log_generic daemon.error "$@" >&2
+}
+
+log_notice () {
+  log_generic daemon.notice "$@"
+}
+
+eval_log_error () {
+  cmd="$1"
+  case $logging in
+    file)
+      if [ -w / -o "$USER" = "root" ]; then
+        cmd="$cmd > /dev/null 2>&1"
+      else
+        cmd="$cmd >> "`shell_quote_string "$err_log"`" 2>&1"
+      fi
+      ;;
+    syslog)
+      # mysqld often prefixes its messages with a timestamp, which is
+      # redundant when logging to syslog (which adds its own timestamp)
+      # However, we don't strip the timestamp with sed here, because
+      # sed buffers output (only GNU sed supports a -u (unbuffered) option)
+      # which means that messages may not get sent to syslog until the
+      # mysqld process quits.
+      cmd="$cmd 2>&1 | logger -t '$syslog_tag_mysqld' -p daemon.error"
+      ;;
+    *)
+      echo "Internal program error (non-fatal):" \
+           " unknown logging method '$logging'" >&2
+      ;;
+  esac
+
+  #echo "Running mysqld: [$cmd]"
+  eval "$cmd"
+}
+
+shell_quote_string() {
+  # This sed command makes sure that any special chars are quoted,
+  # so the arg gets passed exactly to the server.
+  echo "$1" | sed -e 's,\([^a-zA-Z0-9/_.=-]\),\\\1,g'
+}
+
+parse_arguments() {
+  # We only need to pass arguments through to the server if we don't
+  # handle them here.  So, we collect unrecognized options (passed on
+  # the command line) into the args variable.
+  pick_args=
+  if test "$1" = PICK-ARGS-FROM-ARGV
+  then
+    pick_args=1
+    shift
+  fi
+
+  for arg do
+    # the parameter after "=", or the whole $arg if no match
+    val=`echo "$arg" | sed -e 's;^--[^=]*=;;'`
+    # what's before "=", or the whole $arg if no match
+    optname=`echo "$arg" | sed -e 's/^\(--[^=]*\)=.*$/\1/'`
+    # replace "_" by "-" ; mysqld_safe must accept "_" like mysqld does.
+    optname_subst=`echo "$optname" | sed 's/_/-/g'`
+    arg=`echo $arg | sed "s/^$optname/$optname_subst/"`
+    case "$arg" in
+      # these get passed explicitly to mysqld
+      --basedir=*) MY_BASEDIR_VERSION="$val" ;;
+      --datadir=*)
+        case $val in
+          /) DATADIR=$val ;;
+          *) DATADIR="`echo $val | sed 's;/*$;;'`" ;;
+        esac
+        ;;
+      --pid-file=*) pid_file="$val" ;;
+      --plugin-dir=*) PLUGIN_DIR="$val" ;;
+      --user=*) user="$val"; SET_USER=1 ;;
+
+      # these might have been set in a [mysqld_safe] section of my.cnf
+      # they are added to mysqld command line to override settings from my.cnf
+      --log-error=*) err_log="$val" ;;
+      --port=*) mysql_tcp_port="$val" ;;
+      --socket=*) mysql_unix_port="$val" ;;
+
+      # mysqld_safe-specific options - must be set in my.cnf ([mysqld_safe])!
+      --core-file-size=*) core_file_size="$val" ;;
+      --ledir=*)
+        if [ -z "$pick_args" ]; then
+          log_error "--ledir option can only be used as command line option, found in config file"
+          exit 1
+        fi
+        ledir="$val"
+        ;;
+      --malloc-lib=*) set_malloc_lib "$val" ;;
+      --mysqld=*)
+        if [ -z "$pick_args" ]; then
+          log_error "--mysqld option can only be used as command line option, found in config file"
+          exit 1
+        fi
+        MYSQLD="$val" ;;
+      --mysqld-version=*)
+        if [ -z "$pick_args" ]; then
+          log_error "--mysqld-version option can only be used as command line option, found in config file"
+          exit 1
+        fi
+        if test -n "$val"
+        then
+          MYSQLD="mysqld-$val"
+          PLUGIN_VARIANT="/$val"
+        else
+          MYSQLD="mysqld"
+        fi
+        ;;
+      --nice=*) niceness="$val" ;;
+      --open-files-limit=*) open_files="$val" ;;
+      --open_files_limit=*) open_files="$val" ;;
+      --skip-kill-mysqld*) KILL_MYSQLD=0 ;;
+      --syslog) want_syslog=1 ;;
+      --skip-syslog) want_syslog=0 ;;
+      --syslog-tag=*) syslog_tag="$val" ;;
+      --timezone=*) TZ="$val"; export TZ; ;;
+
+      --help) usage ;;
+
+      *)
+        if test -n "$pick_args"
+        then
+          append_arg_to_args "$arg"
+        fi
+        ;;
+    esac
+  done
+}
+
+
+# Add a single shared library to the list of libraries which will be added to
+# LD_PRELOAD for mysqld
+#
+# Since LD_PRELOAD is a space-separated value (for historical reasons), if a
+# shared lib's path contains spaces, that path will be prepended to
+# LD_LIBRARY_PATH and stripped from the lib value.
+add_mysqld_ld_preload() {
+  lib_to_add="$1"
+  log_notice "Adding '$lib_to_add' to LD_PRELOAD for mysqld"
+
+  case "$lib_to_add" in
+    *' '*)
+      # Must strip path from lib, and add it to LD_LIBRARY_PATH
+      lib_file=`basename "$lib_to_add"`
+      case "$lib_file" in
+        *' '*)
+          # The lib file itself has a space in its name, and can't
+          # be used in LD_PRELOAD
+          log_error "library name '$lib_to_add' contains spaces and can not be used with LD_PRELOAD"
+          exit 1
+          ;;
+      esac
+      lib_path=`dirname "$lib_to_add"`
+      lib_to_add="$lib_file"
+      [ -n "$mysqld_ld_library_path" ] && mysqld_ld_library_path="$mysqld_ld_library_path:"
+      mysqld_ld_library_path="$mysqld_ld_library_path$lib_path"
+      ;;
+  esac
+
+  # LD_PRELOAD is a space-separated
+  [ -n "$mysqld_ld_preload" ] && mysqld_ld_preload="$mysqld_ld_preload "
+  mysqld_ld_preload="${mysqld_ld_preload}$lib_to_add"
+}
+
+
+# Returns LD_PRELOAD (and LD_LIBRARY_PATH, if needed) text, quoted to be
+# suitable for use in the eval that calls mysqld.
+#
+# All values in mysqld_ld_preload are prepended to LD_PRELOAD.
+mysqld_ld_preload_text() {
+  text=
+
+  if [ -n "$mysqld_ld_preload" ]; then
+    new_text="$mysqld_ld_preload"
+    [ -n "$LD_PRELOAD" ] && new_text="$new_text $LD_PRELOAD"
+    text="${text}LD_PRELOAD="`shell_quote_string "$new_text"`' '
+  fi
+
+  if [ -n "$mysqld_ld_library_path" ]; then
+    new_text="$mysqld_ld_library_path"
+    [ -n "$LD_LIBRARY_PATH" ] && new_text="$new_text:$LD_LIBRARY_PATH"
+    text="${text}LD_LIBRARY_PATH="`shell_quote_string "$new_text"`' '
+  fi
+
+  echo "$text"
+}
+
+# set_malloc_lib LIB
+# - If LIB is empty, do nothing and return
+# - If LIB is 'tcmalloc', look for tcmalloc shared library in $malloc_dirs.
+#   tcmalloc is part of the Google perftools project.
+# - If LIB is an absolute path, assume it is a malloc shared library
+#
+# Put LIB in mysqld_ld_preload, which will be added to LD_PRELOAD when
+# running mysqld.  See ld.so for details.
+set_malloc_lib() {
+  # This list is kept intentionally simple.
+  malloc_dirs="/usr/lib /usr/lib64 /usr/lib/i386-linux-gnu /usr/lib/x86_64-linux-gnu"
+  malloc_lib="$1"
+
+  if [ "$malloc_lib" = tcmalloc ]; then
+    malloc_lib=
+    for libdir in `echo $malloc_dirs`; do
+      for flavor in _minimal '' _and_profiler _debug; do
+        tmp="$libdir/libtcmalloc$flavor.so"
+        #log_notice "DEBUG: Checking for malloc lib '$tmp'"
+        [ -r "$tmp" ] || continue
+        malloc_lib="$tmp"
+        break 2
+      done
+    done
+
+    if [ -z "$malloc_lib" ]; then
+      log_error "no shared library for --malloc-lib=tcmalloc found in $malloc_dirs"
+      exit 1
+    fi
+  fi
+
+  # Allow --malloc-lib='' to override other settings
+  [ -z  "$malloc_lib" ] && return
+
+  case "$malloc_lib" in
+    /*)
+      if [ ! -r "$malloc_lib" ]; then
+        log_error "--malloc-lib can not be read and will not be used"
+        exit 1
+      fi
+
+      # Restrict to a the list in $malloc_dirs above
+      case "`dirname "$malloc_lib"`" in
+        /usr/lib) ;;
+        /usr/lib64) ;;
+        /usr/lib/i386-linux-gnu) ;;
+        /usr/lib/x86_64-linux-gnu) ;;
+        *)
+          log_error "--malloc-lib must be located in one of the directories: $malloc_dirs"
+          exit 1
+          ;;
+      esac
+      ;;
+    *)
+      log_error "--malloc-lib must be an absolute path or 'tcmalloc'; " \
+        "ignoring value '$malloc_lib'"
+      exit 1
+      ;;
+  esac
+
+  add_mysqld_ld_preload "$malloc_lib"
+}
+
+find_basedir_from_cmdline () {
+  for arg in "$@"; do
+    case $arg in
+      --basedir=*)
+        MY_BASEDIR_VERSION="`echo "$arg" | sed -e 's;^--[^=]*=;;'`"
+        # Convert to full path
+        cd "$MY_BASEDIR_VERSION"
+        if [ $? -ne 0 ] ; then
+          log_error "--basedir set to '$MY_BASEDIR_VERSION', however could not access directory"
+          exit 1
+        fi
+        MY_BASEDIR_VERSION="`pwd`"
+        ;;
+    esac
+  done
+}
+
+#
+# First, try to find BASEDIR and ledir (where mysqld is)
+#
+
+oldpwd="`pwd`"
+
+# Args not parsed yet, check if --basedir was given on command line
+find_basedir_from_cmdline "$@"
+
+# --basedir is already overridden on command line
+if test -n "$MY_BASEDIR_VERSION" -a -d "$MY_BASEDIR_VERSION" ; then
+  # Search for mysqld and set ledir
+  for dir in @INSTALL_SBINDIR@ libexec sbin bin ; do
+    if test -x "$MY_BASEDIR_VERSION/$dir/mysqld" ; then
+      ledir="$MY_BASEDIR_VERSION/$dir"
+      break
+    fi
+  done
+
+else
+  # Basedir should be parent dir of bindir, unless some non-standard
+  # layout is used
+
+  cd "`dirname $0`"
+  if [ -h "$0" ] ; then
+    realpath="`ls -l  "$0" | awk '{print $NF}'`"
+    cd "`dirname "$realpath"`"
+  fi
+  cd ..
+  MY_PWD="`pwd`"
+
+  # Search for mysqld and set ledir and BASEDIR
+  for dir in @INSTALL_SBINDIR@ libexec sbin bin ; do
+    if test -x "$MY_PWD/$dir/mysqld" ; then
+      MY_BASEDIR_VERSION="$MY_PWD"
+      ledir="$MY_BASEDIR_VERSION/$dir"
+      break
+    fi
+  done
+
+  # If we still didn't find anything, use the compiled-in defaults
+  if test -z "$MY_BASEDIR_VERSION" ; then
+    MY_BASEDIR_VERSION='@prefix@'
+    ledir='@libexecdir@'
+  fi
+fi
+
+#
+# Second, try to find the data directory
+#
+
+# Try where the binary installs put it
+if test -d $MY_BASEDIR_VERSION/data/mysql
+then
+  DATADIR=$MY_BASEDIR_VERSION/data
+  if test -z "$defaults" -a -r "$DATADIR/my.cnf"
+  then
+    defaults="--defaults-extra-file=$DATADIR/my.cnf"
+  fi
+# Or just give up and use our compiled-in default
+else
+  DATADIR=@localstatedir@
+fi
+
+if test -z "$MYSQL_HOME"
+then 
+  if test -r "$MY_BASEDIR_VERSION/my.cnf" && test -r "$DATADIR/my.cnf"
+  then
+    log_error "WARNING: Found two instances of my.cnf -
+$MY_BASEDIR_VERSION/my.cnf and
+$DATADIR/my.cnf
+IGNORING $DATADIR/my.cnf"
+
+    MYSQL_HOME=$MY_BASEDIR_VERSION
+  elif test -r "$DATADIR/my.cnf"
+  then
+    log_error "WARNING: Found $DATADIR/my.cnf
+The data directory is a deprecated location for my.cnf, please move it to
+$MY_BASEDIR_VERSION/my.cnf"
+    MYSQL_HOME=$DATADIR
+  else
+    MYSQL_HOME=$MY_BASEDIR_VERSION
+  fi
+fi
+export MYSQL_HOME
+
+
+# Get first arguments from the my.cnf file, groups [mysqld] and [mysqld_safe]
+# and then merge with the command line arguments
+if test -x "$MY_BASEDIR_VERSION/bin/my_print_defaults" ; then
+  print_defaults="$MY_BASEDIR_VERSION/bin/my_print_defaults"
+elif test -x "@bindir@/my_print_defaults" ; then
+  print_defaults="@bindir@/my_print_defaults"
+else
+  print_defaults="my_print_defaults"
+fi
+
+append_arg_to_args () {
+  args="$args "`shell_quote_string "$1"`
+}
+
+args=
+
+cd "$oldpwd"
+
+SET_USER=2
+parse_arguments `$print_defaults $defaults --loose-verbose mysqld server`
+if test $SET_USER -eq 2
+then
+  SET_USER=0
+fi
+
+parse_arguments `$print_defaults $defaults --loose-verbose mysqld_safe safe_mysqld`
+parse_arguments PICK-ARGS-FROM-ARGV "$@"
+
+
+#
+# Try to find the plugin directory
+#
+
+# Use user-supplied argument
+if [ -n "${PLUGIN_DIR}" ]; then
+  plugin_dir="${PLUGIN_DIR}"
+else
+  # Try to find plugin dir relative to basedir
+  for dir in lib64/mysql/plugin lib64/plugin lib/mysql/plugin lib/plugin
+  do
+    if [ -d "${MY_BASEDIR_VERSION}/${dir}" ]; then
+      plugin_dir="${MY_BASEDIR_VERSION}/${dir}"
+      break
+    fi
+  done
+  # Give up and use compiled-in default
+  if [ -z "${plugin_dir}" ]; then
+    plugin_dir='@pkgplugindir@'
+  fi
+fi
+plugin_dir="${plugin_dir}${PLUGIN_VARIANT}"
+
+# Determine what logging facility to use
+
+# Ensure that 'logger' exists, if it's requested
+if [ $want_syslog -eq 1 ]
+then
+  my_which logger > /dev/null 2>&1
+  if [ $? -ne 0 ]
+  then
+    log_error "--syslog requested, but no 'logger' program found.  Please ensure that 'logger' is in your PATH, or do not specify the --syslog option to mysqld_safe."
+    exit 1
+  fi
+fi
+
+if [ -n "$err_log" -o $want_syslog -eq 0 ]
+then
+  if [ -n "$err_log" ]
+  then
+    # mysqld adds ".err" if there is no extension on the --log-error
+    # argument; must match that here, or mysqld_safe will write to a
+    # different log file than mysqld
+
+    # mysqld does not add ".err" to "--log-error=foo."; it considers a
+    # trailing "." as an extension
+    
+    if expr "$err_log" : '.*\.[^/]*$' > /dev/null
+    then
+        :
+    else
+      err_log="$err_log".err
+    fi
+
+    err_log_append="$err_log"
+    case "$err_log" in
+      /* ) ;;
+      * ) err_log="$DATADIR/$err_log" ;;
+    esac
+  else
+    err_log=$DATADIR/`@HOSTNAME@`.err
+    err_log_append=`@HOSTNAME@`.err
+  fi
+
+  append_arg_to_args "--log-error=$err_log_append"
+
+  if [ $want_syslog -eq 1 ]
+  then
+    # User explicitly asked for syslog, so warn that it isn't used
+    log_error "Can't log to error log and syslog at the same time.  Remove all --log-error configuration options for --syslog to take effect."
+  fi
+
+  # Log to err_log file
+  logging=file
+else
+  if [ -n "$syslog_tag" ]
+  then
+    # Sanitize the syslog tag
+    syslog_tag=`echo "$syslog_tag" | sed -e 's/[^a-zA-Z0-9_-]/_/g'`
+    syslog_tag_mysqld_safe="${syslog_tag_mysqld_safe}-$syslog_tag"
+    syslog_tag_mysqld="${syslog_tag_mysqld}-$syslog_tag"
+  fi
+  log_notice "Logging to syslog."
+  logging=syslog
+fi
+
+logdir=`dirname "$err_log"`
+# Change the err log to the right user, if possible and it is in use
+if [ $logging = "file" -o $logging = "both" ]; then
+  if [ ! -e "$err_log" -a ! -h "$err_log" ]; then
+    if test -w / -o "$USER" = "root"; then
+      case $logdir in
+        /var/log)
+          (
+            umask 0137
+            set -o noclobber
+            > "$err_log" && chown $user "$err_log"
+          ) ;;
+        *) ;;
+      esac
+    else
+      (
+        umask 0137
+        set -o noclobber
+        > "$err_log"
+      )
+    fi
+  fi
+
+  if [ -f "$err_log" -o -p "$err_log" ]; then        # Log to err_log file
+    log_notice "Logging to '$err_log'."
+  elif [ "x$user" = "xroot" ]; then # running as root, mysqld can create log file; continue
+    echo "Logging to '$err_log'." >&2
+  else
+    case $logdir in
+      # We can't create $err_log, however mysqld can; continue
+      /tmp|/var/tmp|/var/log/mysql|$DATADIR)
+        echo "Logging to '$err_log'." >&2
+        ;;
+      # We can't create $err_log and don't know if mysqld can; error out
+      *)
+        log_error "error: log-error set to '$err_log', however file don't exists. Create writable for user '$user'."
+        exit 1
+        ;;
+    esac
+  fi
+fi
+
+USER_OPTION=""
+if test -w / -o "$USER" = "root"
+then
+  if test "$user" != "root" -o $SET_USER = 1
+  then
+    USER_OPTION="--user=$user"
+  fi
+  if test -n "$open_files"
+  then
+    ulimit -n $open_files
+  fi
+fi
+
+if test -n "$open_files"
+then
+  append_arg_to_args "--open-files-limit=$open_files"
+fi
+
+safe_mysql_unix_port=${mysql_unix_port:-${MYSQL_UNIX_PORT:-@MYSQL_UNIX_ADDR@}}
+# Check that directory for $safe_mysql_unix_port exists
+mysql_unix_port_dir=`dirname $safe_mysql_unix_port`
+if [ ! -d $mysql_unix_port_dir ]
+then
+  log_error "Directory '$mysql_unix_port_dir' for UNIX socket file don't exists."
+  exit 1
+fi
+
+# If the user doesn't specify a binary, we assume name "mysqld"
+if test -z "$MYSQLD"
+then
+  MYSQLD=mysqld
+fi
+
+if test ! -x "$ledir/$MYSQLD"
+then
+  log_error "The file $ledir/$MYSQLD
+does not exist or is not executable. Please cd to the mysql installation
+directory and restart this script from there as follows:
+./bin/mysqld_safe&
+See http://dev.mysql.com/doc/mysql/en/mysqld-safe.html for more information"
+  exit 1
+fi
+
+if test -z "$pid_file"
+then
+  pid_file="$DATADIR/`@HOSTNAME@`.pid"
+  pid_file_append="`@HOSTNAME@`.pid"
+else
+  pid_file_append="$pid_file"
+  case "$pid_file" in
+    /* ) ;;
+    * )  pid_file="$DATADIR/$pid_file" ;;
+  esac
+fi
+append_arg_to_args "--pid-file=$pid_file_append"
+
+if test -n "$mysql_unix_port"
+then
+  append_arg_to_args "--socket=$mysql_unix_port"
+fi
+if test -n "$mysql_tcp_port"
+then
+  append_arg_to_args "--port=$mysql_tcp_port"
+fi
+
+if test $niceness -eq 0
+then
+  NOHUP_NICENESS="nohup"
+else
+  NOHUP_NICENESS="nohup nice -$niceness"
+fi
+
+# Using nice with no args to get the niceness level is GNU-specific.
+# This check could be extended for other operating systems (e.g.,
+# BSD could use "nohup sh -c 'ps -o nice -p $$' | tail -1").
+# But, it also seems that GNU nohup is the only one which messes
+# with the priority, so this is okay.
+if nohup nice > /dev/null 2>&1
+then
+    normal_niceness=`nice`
+    nohup_niceness=`nohup nice 2>/dev/null`
+
+    numeric_nice_values=1
+    for val in $normal_niceness $nohup_niceness
+    do
+        case "$val" in
+            -[0-9] | -[0-9][0-9] | -[0-9][0-9][0-9] | \
+             [0-9] |  [0-9][0-9] |  [0-9][0-9][0-9] )
+                ;;
+            * )
+                numeric_nice_values=0 ;;
+        esac
+    done
+
+    if test $numeric_nice_values -eq 1
+    then
+        nice_value_diff=`expr $nohup_niceness - $normal_niceness`
+        if test $? -eq 0 && test $nice_value_diff -gt 0 && \
+            nice --$nice_value_diff echo testing > /dev/null 2>&1
+        then
+            # nohup increases the priority (bad), and we are permitted
+            # to lower the priority with respect to the value the user
+            # might have been given
+            niceness=`expr $niceness - $nice_value_diff`
+            NOHUP_NICENESS="nice -$niceness nohup"
+        fi
+    fi
+else
+    if nohup echo testing > /dev/null 2>&1
+    then
+        :
+    else
+        # nohup doesn't work on this system
+        NOHUP_NICENESS=""
+    fi
+fi
+
+# Try to set the core file size (even if we aren't root) because many systems
+# don't specify a hard limit on core file size.
+if test -n "$core_file_size"
+then
+  ulimit -c $core_file_size
+fi
+
+#
+# If there exists an old pid file, check if the daemon is already running
+# Note: The switches to 'ps' may depend on your operating system
+if test -f "$pid_file"
+then
+  PID=`cat "$pid_file"`
+  if @CHECK_PID@
+  then
+    if @FIND_PROC@
+    then    # The pid contains a mysqld process
+      log_error "A mysqld process already exists"
+      exit 1
+    fi
+  fi
+  if [ ! -h "$pid_file" ]; then
+      rm -f "$pid_file"
+      if test -f "$pid_file"; then
+        log_error "Fatal error: Can't remove the pid file:
+$pid_file.
+Please remove the file manually and start $0 again;
+mysqld daemon not started"
+        exit 1
+      fi
+  fi
+  if [ ! -h "$safe_mysql_unix_port" ]; then
+      rm -f "$safe_mysql_unix_port"
+      if test -f "$safe_mysql_unix_port"; then
+        log_error "Fatal error: Can't remove the socket file:
+$safe_mysql_unix_port.
+Please remove the file manually and start $0 again;
+mysqld daemon not started"
+        exit 1
+      fi
+  fi
+fi
+
+#
+# Uncomment the following lines if you want all tables to be automatically
+# checked and repaired during startup. You should add sensible key_buffer
+# and sort_buffer values to my.cnf to improve check performance or require
+# less disk space.
+# Alternatively, you can start mysqld with the "myisam-recover" option. See
+# the manual for details.
+#
+# echo "Checking tables in $DATADIR"
+# $MY_BASEDIR_VERSION/bin/myisamchk --silent --force --fast --medium-check $DATADIR/*/*.MYI
+# $MY_BASEDIR_VERSION/bin/isamchk --silent --force $DATADIR/*/*.ISM
+
+# Does this work on all systems?
+#if type ulimit | grep "shell builtin" > /dev/null
+#then
+#  ulimit -n 256 > /dev/null 2>&1		# Fix for BSD and FreeBSD systems
+#fi
+
+cmd="`mysqld_ld_preload_text`$NOHUP_NICENESS"
+
+for i in  "$ledir/$MYSQLD" "$defaults" "--basedir=$MY_BASEDIR_VERSION" \
+  "--datadir=$DATADIR" "--plugin-dir=$plugin_dir" "$USER_OPTION"
+do
+  cmd="$cmd "`shell_quote_string "$i"`
+done
+cmd="$cmd $args"
+# Avoid 'nohup: ignoring input' warning
+test -n "$NOHUP_NICENESS" && cmd="$cmd < /dev/null"
+
+log_notice "Starting $MYSQLD daemon with databases from $DATADIR"
+
+# variable to track the current number of "fast" (a.k.a. subsecond) restarts
+fast_restart=0
+# maximum number of restarts before trottling kicks in
+max_fast_restarts=5
+# flag whether a usable sleep command exists
+have_sleep=1
+
+while true
+do
+  start_time=`date +%M%S`
+
+  eval_log_error "$cmd"
+
+  # hypothetical: log was renamed but not
+  # flushed yet. we'd recreate it with
+  # wrong owner next time we log, so set
+  # it up correctly while we can!
+
+  if [ $want_syslog -eq 0 -a ! -f "$err_log" -a ! -h "$err_log" ]; then
+    if test -w / -o "$USER" = "root"; then
+      logdir=`dirname "$err_log"`
+      case $logdir in
+        /var/log)
+          (
+            umask 0137
+            set -o noclobber
+            > "$err_log" && chown $user "$err_log"
+          ) ;;
+        *) ;;
+      esac
+    else
+      (
+        umask 0137
+        set -o noclobber
+        > "$err_log"
+      )
+    fi
+  fi
+
+  end_time=`date +%M%S`
+
+  if test ! -f "$pid_file"		# This is removed if normal shutdown
+  then
+    break
+  else                                  # self's mysqld crashed or other's mysqld running
+    PID=`cat "$pid_file"`
+    if @CHECK_PID@
+    then                                # true when above pid belongs to a running mysqld process
+      log_error "A mysqld process with pid=$PID is already running. Aborting!!"
+      exit 1
+    fi
+  fi
+
+
+  # sanity check if time reading is sane and there's sleep
+  if test $end_time -gt 0 -a $have_sleep -gt 0
+  then
+    # throttle down the fast restarts
+    if test $end_time -eq $start_time
+    then
+      fast_restart=`expr $fast_restart + 1`
+      if test $fast_restart -ge $max_fast_restarts
+      then
+        log_notice "The server is respawning too fast. Sleeping for 1 second."
+        sleep 1
+        sleep_state=$?
+        if test $sleep_state -gt 0
+        then
+          log_notice "The server is respawning too fast and no working sleep command. Turning off trottling."
+          have_sleep=0
+        fi
+
+        fast_restart=0
+      fi
+    else
+      fast_restart=0
+    fi
+  fi
+
+  if @TARGET_LINUX@ && test $KILL_MYSQLD -eq 1
+  then
+    # Test if one process was hanging.
+    # This is only a fix for Linux (running as base 3 mysqld processes)
+    # but should work for the rest of the servers.
+    # The only thing is ps x => redhat 5 gives warnings when using ps -x.
+    # kill -9 is used or the process won't react on the kill.
+    numofproces=`ps xaww | grep -v "grep" | grep "$ledir/$MYSQLD\>" | grep -c "pid-file=$pid_file"`
+
+    log_notice "Number of processes running now: $numofproces"
+    I=1
+    while test "$I" -le "$numofproces"
+    do 
+      PROC=`ps xaww | grep "$ledir/$MYSQLD\>" | grep -v "grep" | grep "pid-file=$pid_file" | sed -n '$p'` 
+
+      for T in $PROC
+      do
+        break
+      done
+      #    echo "TEST $I - $T **"
+      if kill -9 $T
+      then
+        log_error "$MYSQLD process hanging, pid $T - killed"
+      else
+        break
+      fi
+      I=`expr $I + 1`
+    done
+  fi
+  if [ ! -h "$pid_file" ]; then
+    rm -f "$pid_file"
+  fi
+  if [ ! -h "$safe_mysql_unix_port" ]; then
+   rm -f "$safe_mysql_unix_port"
+  fi
+  log_notice "mysqld restarted"
+done
+
+log_notice "mysqld from pid file $pid_file ended"
+
diff -uNr mysql-5.5.60.orig/sql/log_event.cc mysql-5.5.60/sql/log_event.cc
--- mysql-5.5.60.orig/sql/log_event.cc	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/sql/log_event.cc	2018-12-02 00:06:23.397892097 +0800
@@ -3356,7 +3356,7 @@
     if ((error= rows_event_stmt_cleanup(const_cast<Relay_log_info*>(rli), thd)))
     {
       const_cast<Relay_log_info*>(rli)->report(ERROR_LEVEL, error,
-                  "Error in cleaning up after an event preceeding the commit; "
+                  "Error in cleaning up after an event preceding the commit; "
                   "the group log file/position: %s %s",
                   const_cast<Relay_log_info*>(rli)->group_master_log_name,
                   llstr(const_cast<Relay_log_info*>(rli)->group_master_log_pos,
diff -uNr mysql-5.5.60.orig/sql/log_event.cc.orig mysql-5.5.60/sql/log_event.cc.orig
--- mysql-5.5.60.orig/sql/log_event.cc.orig	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/sql/log_event.cc.orig	2018-02-26 21:02:31.000000000 +0800
@@ -0,0 +1,10645 @@
+/*
+   Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.
+
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; version 2 of the License.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program; if not, write to the Free Software
+   Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301  USA */
+
+
+#ifdef MYSQL_CLIENT
+
+#include "sql_priv.h"
+#include "mysqld_error.h"
+
+#else
+
+#ifdef USE_PRAGMA_IMPLEMENTATION
+#pragma implementation				// gcc: Class implementation
+#endif
+
+#include "sql_priv.h"
+#include "unireg.h"
+#include "my_global.h" // REQUIRED by log_event.h > m_string.h > my_bitmap.h
+#include "log_event.h"
+#include "sql_base.h"                           // close_thread_tables
+#include "sql_cache.h"                       // QUERY_CACHE_FLAGS_SIZE
+#include "sql_locale.h" // MY_LOCALE, my_locale_by_number, my_locale_en_US
+#include "key.h"        // key_copy
+#include "lock.h"       // mysql_unlock_tables
+#include "sql_parse.h"  // mysql_test_parse_for_slave
+#include "tztime.h"     // struct Time_zone
+#include "sql_load.h"   // mysql_load
+#include "sql_db.h"     // load_db_opt_by_name
+#include "slave.h"
+#include "rpl_rli.h"
+#include "rpl_mi.h"
+#include "rpl_filter.h"
+#include "rpl_record.h"
+#include "transaction.h"
+#include <my_dir.h>
+#include "sql_show.h"    // append_identifier
+
+#endif /* MYSQL_CLIENT */
+
+#include <base64.h>
+#include <my_bitmap.h>
+#include "rpl_utility.h"
+
+#define log_cs	&my_charset_latin1
+
+#define FLAGSTR(V,F) ((V)&(F)?#F" ":"")
+
+
+/*
+  Size of buffer for printing a double in format %.<PREC>g
+
+  optional '-' + optional zero + '.'  + PREC digits + 'e' + sign +
+  exponent digits + '\0'
+*/
+#define FMT_G_BUFSIZE(PREC) (3 + (PREC) + 5 + 1)
+
+/*
+  Explicit instantiation to unsigned int of template available_buffer
+  function.
+*/
+template unsigned int available_buffer<unsigned int>(const char*,
+                                                     const char*,
+                                                     unsigned int);
+
+/*
+  Explicit instantiation to unsigned int of template valid_buffer_range
+  function.
+*/
+template bool valid_buffer_range<unsigned int>(unsigned int,
+                                               const char*,
+                                               const char*,
+                                               unsigned int);
+
+#if !defined(MYSQL_CLIENT) && defined(HAVE_REPLICATION)
+static int rows_event_stmt_cleanup(Relay_log_info const *rli, THD* thd);
+
+static const char *HA_ERR(int i)
+{
+  /* 
+    This function should only be called in case of an error
+    was detected 
+   */
+  DBUG_ASSERT(i != 0);
+  switch (i) {
+  case HA_ERR_KEY_NOT_FOUND: return "HA_ERR_KEY_NOT_FOUND";
+  case HA_ERR_FOUND_DUPP_KEY: return "HA_ERR_FOUND_DUPP_KEY";
+  case HA_ERR_RECORD_CHANGED: return "HA_ERR_RECORD_CHANGED";
+  case HA_ERR_WRONG_INDEX: return "HA_ERR_WRONG_INDEX";
+  case HA_ERR_CRASHED: return "HA_ERR_CRASHED";
+  case HA_ERR_WRONG_IN_RECORD: return "HA_ERR_WRONG_IN_RECORD";
+  case HA_ERR_OUT_OF_MEM: return "HA_ERR_OUT_OF_MEM";
+  case HA_ERR_NOT_A_TABLE: return "HA_ERR_NOT_A_TABLE";
+  case HA_ERR_WRONG_COMMAND: return "HA_ERR_WRONG_COMMAND";
+  case HA_ERR_OLD_FILE: return "HA_ERR_OLD_FILE";
+  case HA_ERR_NO_ACTIVE_RECORD: return "HA_ERR_NO_ACTIVE_RECORD";
+  case HA_ERR_RECORD_DELETED: return "HA_ERR_RECORD_DELETED";
+  case HA_ERR_RECORD_FILE_FULL: return "HA_ERR_RECORD_FILE_FULL";
+  case HA_ERR_INDEX_FILE_FULL: return "HA_ERR_INDEX_FILE_FULL";
+  case HA_ERR_END_OF_FILE: return "HA_ERR_END_OF_FILE";
+  case HA_ERR_UNSUPPORTED: return "HA_ERR_UNSUPPORTED";
+  case HA_ERR_TO_BIG_ROW: return "HA_ERR_TO_BIG_ROW";
+  case HA_WRONG_CREATE_OPTION: return "HA_WRONG_CREATE_OPTION";
+  case HA_ERR_FOUND_DUPP_UNIQUE: return "HA_ERR_FOUND_DUPP_UNIQUE";
+  case HA_ERR_UNKNOWN_CHARSET: return "HA_ERR_UNKNOWN_CHARSET";
+  case HA_ERR_WRONG_MRG_TABLE_DEF: return "HA_ERR_WRONG_MRG_TABLE_DEF";
+  case HA_ERR_CRASHED_ON_REPAIR: return "HA_ERR_CRASHED_ON_REPAIR";
+  case HA_ERR_CRASHED_ON_USAGE: return "HA_ERR_CRASHED_ON_USAGE";
+  case HA_ERR_LOCK_WAIT_TIMEOUT: return "HA_ERR_LOCK_WAIT_TIMEOUT";
+  case HA_ERR_LOCK_TABLE_FULL: return "HA_ERR_LOCK_TABLE_FULL";
+  case HA_ERR_READ_ONLY_TRANSACTION: return "HA_ERR_READ_ONLY_TRANSACTION";
+  case HA_ERR_LOCK_DEADLOCK: return "HA_ERR_LOCK_DEADLOCK";
+  case HA_ERR_CANNOT_ADD_FOREIGN: return "HA_ERR_CANNOT_ADD_FOREIGN";
+  case HA_ERR_NO_REFERENCED_ROW: return "HA_ERR_NO_REFERENCED_ROW";
+  case HA_ERR_ROW_IS_REFERENCED: return "HA_ERR_ROW_IS_REFERENCED";
+  case HA_ERR_NO_SAVEPOINT: return "HA_ERR_NO_SAVEPOINT";
+  case HA_ERR_NON_UNIQUE_BLOCK_SIZE: return "HA_ERR_NON_UNIQUE_BLOCK_SIZE";
+  case HA_ERR_NO_SUCH_TABLE: return "HA_ERR_NO_SUCH_TABLE";
+  case HA_ERR_TABLE_EXIST: return "HA_ERR_TABLE_EXIST";
+  case HA_ERR_NO_CONNECTION: return "HA_ERR_NO_CONNECTION";
+  case HA_ERR_NULL_IN_SPATIAL: return "HA_ERR_NULL_IN_SPATIAL";
+  case HA_ERR_TABLE_DEF_CHANGED: return "HA_ERR_TABLE_DEF_CHANGED";
+  case HA_ERR_NO_PARTITION_FOUND: return "HA_ERR_NO_PARTITION_FOUND";
+  case HA_ERR_RBR_LOGGING_FAILED: return "HA_ERR_RBR_LOGGING_FAILED";
+  case HA_ERR_DROP_INDEX_FK: return "HA_ERR_DROP_INDEX_FK";
+  case HA_ERR_FOREIGN_DUPLICATE_KEY: return "HA_ERR_FOREIGN_DUPLICATE_KEY";
+  case HA_ERR_TABLE_NEEDS_UPGRADE: return "HA_ERR_TABLE_NEEDS_UPGRADE";
+  case HA_ERR_TABLE_READONLY: return "HA_ERR_TABLE_READONLY";
+  case HA_ERR_AUTOINC_READ_FAILED: return "HA_ERR_AUTOINC_READ_FAILED";
+  case HA_ERR_AUTOINC_ERANGE: return "HA_ERR_AUTOINC_ERANGE";
+  case HA_ERR_GENERIC: return "HA_ERR_GENERIC";
+  case HA_ERR_RECORD_IS_THE_SAME: return "HA_ERR_RECORD_IS_THE_SAME";
+  case HA_ERR_LOGGING_IMPOSSIBLE: return "HA_ERR_LOGGING_IMPOSSIBLE";
+  case HA_ERR_CORRUPT_EVENT: return "HA_ERR_CORRUPT_EVENT";
+  case HA_ERR_ROWS_EVENT_APPLY : return "HA_ERR_ROWS_EVENT_APPLY";
+  }
+  return "No Error!";
+}
+
+/**
+   Error reporting facility for Rows_log_event::do_apply_event
+
+   @param level     error, warning or info
+   @param ha_error  HA_ERR_ code
+   @param rli       pointer to the active Relay_log_info instance
+   @param thd       pointer to the slave thread's thd
+   @param table     pointer to the event's table object
+   @param type      the type of the event
+   @param log_name  the master binlog file name
+   @param pos       the master binlog file pos (the next after the event)
+
+*/
+static void inline slave_rows_error_report(enum loglevel level, int ha_error,
+                                           Relay_log_info const *rli, THD *thd,
+                                           TABLE *table, const char * type,
+                                           const char *log_name, ulong pos)
+{
+  const char *handler_error= (ha_error ? HA_ERR(ha_error) : NULL);
+  char buff[MAX_SLAVE_ERRMSG], *slider;
+  const char *buff_end= buff + sizeof(buff);
+  uint len;
+  List_iterator_fast<MYSQL_ERROR> it(thd->warning_info->warn_list());
+  MYSQL_ERROR *err;
+  buff[0]= 0;
+
+  for (err= it++, slider= buff; err && slider < buff_end - 1;
+       slider += len, err= it++)
+  {
+    len= my_snprintf(slider, buff_end - slider,
+                     " %s, Error_code: %d;", err->get_message_text(),
+                     err->get_sql_errno());
+  }
+
+  if (ha_error != 0)
+    rli->report(level, thd->is_error() ? thd->stmt_da->sql_errno() : 0,
+                "Could not execute %s event on table %s.%s;"
+                "%s handler error %s; "
+                "the event's master log %s, end_log_pos %lu",
+                type, table->s->db.str, table->s->table_name.str,
+                buff, handler_error == NULL ? "<unknown>" : handler_error,
+                log_name, pos);
+  else
+    rli->report(level, thd->is_error() ? thd->stmt_da->sql_errno() : 0,
+                "Could not execute %s event on table %s.%s;"
+                "%s the event's master log %s, end_log_pos %lu",
+                type, table->s->db.str, table->s->table_name.str,
+                buff, log_name, pos);
+}
+#endif
+
+/*
+  Cache that will automatically be written to a dedicated file on
+  destruction.
+
+  DESCRIPTION
+
+ */
+class Write_on_release_cache
+{
+public:
+  enum flag
+  {
+    FLUSH_F
+  };
+
+  typedef unsigned short flag_set;
+
+  /*
+    Constructor.
+
+    SYNOPSIS
+      Write_on_release_cache
+      cache  Pointer to cache to use
+      file   File to write cache to upon destruction
+      flags  Flags for the cache
+
+    DESCRIPTION
+
+      Class used to guarantee copy of cache to file before exiting the
+      current block.  On successful copy of the cache, the cache will
+      be reinited as a WRITE_CACHE.
+
+      Currently, a pointer to the cache is provided in the
+      constructor, but it would be possible to create a subclass
+      holding the IO_CACHE itself.
+   */
+  Write_on_release_cache(IO_CACHE *cache, FILE *file, flag_set flags = 0)
+    : m_cache(cache), m_file(file), m_flags(flags)
+  {
+    reinit_io_cache(m_cache, WRITE_CACHE, 0L, FALSE, TRUE);
+  }
+
+  ~Write_on_release_cache()
+  {
+    copy_event_cache_to_file_and_reinit(m_cache, m_file);
+    if (m_flags | FLUSH_F)
+      fflush(m_file);
+  }
+
+  /*
+    Return a pointer to the internal IO_CACHE.
+
+    SYNOPSIS
+      operator&()
+
+    DESCRIPTION
+
+      Function to return a pointer to the internal cache, so that the
+      object can be treated as a IO_CACHE and used with the my_b_*
+      IO_CACHE functions
+
+    RETURN VALUE
+      A pointer to the internal IO_CACHE.
+   */
+  IO_CACHE *operator&()
+  {
+    return m_cache;
+  }
+
+private:
+  // Hidden, to prevent usage.
+  Write_on_release_cache(Write_on_release_cache const&);
+
+  IO_CACHE *m_cache;
+  FILE *m_file;
+  flag_set m_flags;
+};
+
+#ifndef DBUG_OFF
+uint debug_not_change_ts_if_art_event= 1; // bug#29309 simulation
+#endif
+
+/*
+  pretty_print_str()
+*/
+
+#ifdef MYSQL_CLIENT
+static void pretty_print_str(IO_CACHE* cache, const char* str, int len)
+{
+  const char* end = str + len;
+  my_b_printf(cache, "\'");
+  while (str < end)
+  {
+    char c;
+    switch ((c=*str++)) {
+    case '\n': my_b_printf(cache, "\\n"); break;
+    case '\r': my_b_printf(cache, "\\r"); break;
+    case '\\': my_b_printf(cache, "\\\\"); break;
+    case '\b': my_b_printf(cache, "\\b"); break;
+    case '\t': my_b_printf(cache, "\\t"); break;
+    case '\'': my_b_printf(cache, "\\'"); break;
+    case 0   : my_b_printf(cache, "\\0"); break;
+    default:
+      my_b_printf(cache, "%c", c);
+      break;
+    }
+  }
+  my_b_printf(cache, "\'");
+}
+#endif /* MYSQL_CLIENT */
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+
+static void clear_all_errors(THD *thd, Relay_log_info *rli)
+{
+  thd->is_slave_error = 0;
+  thd->clear_error();
+  rli->clear_error();
+}
+
+inline int idempotent_error_code(int err_code)
+{
+  int ret= 0;
+
+  switch (err_code)
+  {
+    case 0:
+      ret= 1;
+    break;
+    /*
+      The following list of "idempotent" errors
+      means that an error from the list might happen
+      because of idempotent (more than once)
+      applying of a binlog file.
+      Notice, that binlog has a  ddl operation its
+      second applying may cause
+
+      case HA_ERR_TABLE_DEF_CHANGED:
+      case HA_ERR_CANNOT_ADD_FOREIGN:
+
+      which are not included into to the list.
+
+      Note that HA_ERR_RECORD_DELETED is not in the list since
+      do_exec_row() should not return that error code.
+    */
+    case HA_ERR_RECORD_CHANGED:
+    case HA_ERR_KEY_NOT_FOUND:
+    case HA_ERR_END_OF_FILE:
+    case HA_ERR_FOUND_DUPP_KEY:
+    case HA_ERR_FOUND_DUPP_UNIQUE:
+    case HA_ERR_FOREIGN_DUPLICATE_KEY:
+    case HA_ERR_NO_REFERENCED_ROW:
+    case HA_ERR_ROW_IS_REFERENCED:
+      ret= 1;
+    break;
+    default:
+      ret= 0;
+    break;
+  }
+  return (ret);
+}
+
+/**
+  Ignore error code specified on command line.
+*/
+
+inline int ignored_error_code(int err_code)
+{
+#ifdef HAVE_NDB_BINLOG
+  /*
+    The following error codes are hard-coded and will always be ignored.
+  */
+  switch (err_code)
+  {
+  case ER_DB_CREATE_EXISTS:
+  case ER_DB_DROP_EXISTS:
+    return 1;
+  default:
+    /* Nothing to do */
+    break;
+  }
+#endif
+  return ((err_code == ER_SLAVE_IGNORED_TABLE) ||
+          (use_slave_mask && bitmap_is_set(&slave_error_mask, err_code)));
+}
+
+/*
+  This function converts an engine's error to a server error.
+   
+  If the thread does not have an error already reported, it tries to 
+  define it by calling the engine's method print_error. However, if a 
+  mapping is not found, it uses the ER_UNKNOWN_ERROR and prints out a 
+  warning message.
+*/ 
+int convert_handler_error(int error, THD* thd, TABLE *table)
+{
+  uint actual_error= (thd->is_error() ? thd->stmt_da->sql_errno() :
+                           0);
+
+  if (actual_error == 0)
+  {
+    table->file->print_error(error, MYF(0));
+    actual_error= (thd->is_error() ? thd->stmt_da->sql_errno() :
+                        ER_UNKNOWN_ERROR);
+    if (actual_error == ER_UNKNOWN_ERROR)
+      if (global_system_variables.log_warnings)
+        sql_print_warning("Unknown error detected %d in handler", error);
+  }
+
+  return (actual_error);
+}
+
+inline bool concurrency_error_code(int error)
+{
+  switch (error)
+  {
+  case ER_LOCK_WAIT_TIMEOUT:
+  case ER_LOCK_DEADLOCK:
+  case ER_XA_RBDEADLOCK:
+    return TRUE;
+  default: 
+    return (FALSE);
+  }
+}
+
+inline bool unexpected_error_code(int unexpected_error)
+{
+  switch (unexpected_error) 
+  {
+  case ER_NET_READ_ERROR:
+  case ER_NET_ERROR_ON_WRITE:
+  case ER_QUERY_INTERRUPTED:
+  case ER_SERVER_SHUTDOWN:
+  case ER_NEW_ABORTING_CONNECTION:
+    return(TRUE);
+  default:
+    return(FALSE);
+  }
+}
+
+/*
+  pretty_print_str()
+*/
+
+static char *pretty_print_str(char *packet, const char *str, int len)
+{
+  const char *end= str + len;
+  char *pos= packet;
+  *pos++= '\'';
+  while (str < end)
+  {
+    char c;
+    switch ((c=*str++)) {
+    case '\n': *pos++= '\\'; *pos++= 'n'; break;
+    case '\r': *pos++= '\\'; *pos++= 'r'; break;
+    case '\\': *pos++= '\\'; *pos++= '\\'; break;
+    case '\b': *pos++= '\\'; *pos++= 'b'; break;
+    case '\t': *pos++= '\\'; *pos++= 't'; break;
+    case '\'': *pos++= '\\'; *pos++= '\''; break;
+    case 0   : *pos++= '\\'; *pos++= '0'; break;
+    default:
+      *pos++= c;
+      break;
+    }
+  }
+  *pos++= '\'';
+  return pos;
+}
+#endif /* !MYSQL_CLIENT */
+
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+
+/**
+  Creates a temporary name for load data infile:.
+
+  @param buf		      Store new filename here
+  @param file_id	      File_id (part of file name)
+  @param event_server_id     Event_id (part of file name)
+  @param ext		      Extension for file name
+
+  @return
+    Pointer to start of extension
+*/
+
+static char *slave_load_file_stem(char *buf, uint file_id,
+                                  int event_server_id, const char *ext)
+{
+  char *res;
+  fn_format(buf,PREFIX_SQL_LOAD,slave_load_tmpdir, "", MY_UNPACK_FILENAME);
+  to_unix_path(buf);
+
+  buf = strend(buf);
+  buf = int10_to_str(::server_id, buf, 10);
+  *buf++ = '-';
+  buf = int10_to_str(event_server_id, buf, 10);
+  *buf++ = '-';
+  res= int10_to_str(file_id, buf, 10);
+  strmov(res, ext);                             // Add extension last
+  return res;                                   // Pointer to extension
+}
+#endif
+
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+
+/**
+  Delete all temporary files used for SQL_LOAD.
+*/
+
+static void cleanup_load_tmpdir()
+{
+  MY_DIR *dirp;
+  FILEINFO *file;
+  uint i;
+  char fname[FN_REFLEN], prefbuf[31], *p;
+
+  if (!(dirp=my_dir(slave_load_tmpdir,MYF(0))))
+    return;
+
+  /* 
+     When we are deleting temporary files, we should only remove
+     the files associated with the server id of our server.
+     We don't use event_server_id here because since we've disabled
+     direct binlogging of Create_file/Append_file/Exec_load events
+     we cannot meet Start_log event in the middle of events from one 
+     LOAD DATA.
+  */
+  p= strmake(prefbuf, STRING_WITH_LEN(PREFIX_SQL_LOAD));
+  p= int10_to_str(::server_id, p, 10);
+  *(p++)= '-';
+  *p= 0;
+
+  for (i=0 ; i < (uint)dirp->number_off_files; i++)
+  {
+    file=dirp->dir_entry+i;
+    if (is_prefix(file->name, prefbuf))
+    {
+      fn_format(fname,file->name,slave_load_tmpdir,"",MY_UNPACK_FILENAME);
+      mysql_file_delete(key_file_misc, fname, MYF(0));
+    }
+  }
+
+  my_dirend(dirp);
+}
+#endif
+
+
+/*
+  write_str()
+*/
+
+static bool write_str(IO_CACHE *file, const char *str, uint length)
+{
+  uchar tmp[1];
+  tmp[0]= (uchar) length;
+  return (my_b_safe_write(file, tmp, sizeof(tmp)) ||
+	  my_b_safe_write(file, (uchar*) str, length));
+}
+
+
+/*
+  read_str()
+*/
+
+static inline int read_str(const char **buf, const char *buf_end,
+                           const char **str, uint8 *len)
+{
+  if (*buf + ((uint) (uchar) **buf) >= buf_end)
+    return 1;
+  *len= (uint8) **buf;
+  *str= (*buf)+1;
+  (*buf)+= (uint) *len+1;
+  return 0;
+}
+
+
+/**
+  Transforms a string into "" or its expression in 0x... form.
+*/
+
+char *str_to_hex(char *to, const char *from, uint len)
+{
+  if (len)
+  {
+    *to++= '0';
+    *to++= 'x';
+    to= octet2hex(to, from, len);
+  }
+  else
+    to= strmov(to, "\"\"");
+  return to;                               // pointer to end 0 of 'to'
+}
+
+#ifndef MYSQL_CLIENT
+
+/**
+  Append a version of the 'from' string suitable for use in a query to
+  the 'to' string.  To generate a correct escaping, the character set
+  information in 'csinfo' is used.
+*/
+
+int
+append_query_string(THD *thd, CHARSET_INFO *csinfo,
+                    String const *from, String *to)
+{
+  char *beg, *ptr;
+  uint32 const orig_len= to->length();
+  if (to->reserve(orig_len + from->length()*2+3))
+    return 1;
+
+  beg= to->c_ptr_quick() + to->length();
+  ptr= beg;
+  if (csinfo->escape_with_backslash_is_dangerous)
+    ptr= str_to_hex(ptr, from->ptr(), from->length());
+  else
+  {
+    *ptr++= '\'';
+    if (!(thd->variables.sql_mode & MODE_NO_BACKSLASH_ESCAPES))
+    {
+      ptr+= escape_string_for_mysql(csinfo, ptr, 0,
+                                    from->ptr(), from->length());
+    }
+    else
+    {
+      const char *frm_str= from->ptr();
+
+      for (; frm_str < (from->ptr() + from->length()); frm_str++)
+      {
+        /* Using '' way to represent "'" */
+        if (*frm_str == '\'')
+          *ptr++= *frm_str;
+
+        *ptr++= *frm_str;
+      }
+    }
+
+    *ptr++= '\'';
+  }
+  to->length(orig_len + ptr - beg);
+  return 0;
+}
+#endif
+
+
+/**
+  Prints a "session_var=value" string. Used by mysqlbinlog to print some SET
+  commands just before it prints a query.
+*/
+
+#ifdef MYSQL_CLIENT
+
+static void print_set_option(IO_CACHE* file, uint32 bits_changed,
+                             uint32 option, uint32 flags, const char* name,
+                             bool* need_comma)
+{
+  if (bits_changed & option)
+  {
+    if (*need_comma)
+      my_b_printf(file,", ");
+    my_b_printf(file,"%s=%d", name, test(flags & option));
+    *need_comma= 1;
+  }
+}
+#endif
+
+/**************************************************************************
+	Log_event methods (= the parent class of all events)
+**************************************************************************/
+
+/**
+  @return
+  returns the human readable name of the event's type
+*/
+
+const char* Log_event::get_type_str(Log_event_type type)
+{
+  switch(type) {
+  case START_EVENT_V3:  return "Start_v3";
+  case STOP_EVENT:   return "Stop";
+  case QUERY_EVENT:  return "Query";
+  case ROTATE_EVENT: return "Rotate";
+  case INTVAR_EVENT: return "Intvar";
+  case LOAD_EVENT:   return "Load";
+  case NEW_LOAD_EVENT:   return "New_load";
+  case SLAVE_EVENT:  return "Slave";
+  case CREATE_FILE_EVENT: return "Create_file";
+  case APPEND_BLOCK_EVENT: return "Append_block";
+  case DELETE_FILE_EVENT: return "Delete_file";
+  case EXEC_LOAD_EVENT: return "Exec_load";
+  case RAND_EVENT: return "RAND";
+  case XID_EVENT: return "Xid";
+  case USER_VAR_EVENT: return "User var";
+  case FORMAT_DESCRIPTION_EVENT: return "Format_desc";
+  case TABLE_MAP_EVENT: return "Table_map";
+  case PRE_GA_WRITE_ROWS_EVENT: return "Write_rows_event_old";
+  case PRE_GA_UPDATE_ROWS_EVENT: return "Update_rows_event_old";
+  case PRE_GA_DELETE_ROWS_EVENT: return "Delete_rows_event_old";
+  case WRITE_ROWS_EVENT: return "Write_rows";
+  case UPDATE_ROWS_EVENT: return "Update_rows";
+  case DELETE_ROWS_EVENT: return "Delete_rows";
+  case BEGIN_LOAD_QUERY_EVENT: return "Begin_load_query";
+  case EXECUTE_LOAD_QUERY_EVENT: return "Execute_load_query";
+  case INCIDENT_EVENT: return "Incident";
+  default: return "Unknown";				/* impossible */
+  }
+}
+
+const char* Log_event::get_type_str()
+{
+  return get_type_str(get_type_code());
+}
+
+
+/*
+  Log_event::Log_event()
+*/
+
+#ifndef MYSQL_CLIENT
+Log_event::Log_event(THD* thd_arg, uint16 flags_arg, bool using_trans)
+  :log_pos(0), temp_buf(0), exec_time(0), flags(flags_arg),
+  cache_type(Log_event::EVENT_INVALID_CACHE), thd(thd_arg)
+{
+  server_id=	thd->server_id;
+  when=		thd->start_time;
+
+  if (using_trans)
+    cache_type= Log_event::EVENT_TRANSACTIONAL_CACHE;
+  else
+    cache_type= Log_event::EVENT_STMT_CACHE;
+}
+
+/**
+  This minimal constructor is for when you are not even sure that there
+  is a valid THD. For example in the server when we are shutting down or
+  flushing logs after receiving a SIGHUP (then we must write a Rotate to
+  the binlog but we have no THD, so we need this minimal constructor).
+*/
+
+Log_event::Log_event()
+  :temp_buf(0), exec_time(0), flags(0),
+  cache_type(Log_event::EVENT_INVALID_CACHE), thd(0)
+{
+  server_id=	::server_id;
+  /*
+    We can't call my_time() here as this would cause a call before
+    my_init() is called
+  */
+  when=		0;
+  log_pos=	0;
+}
+#endif /* !MYSQL_CLIENT */
+
+
+/*
+  Log_event::Log_event()
+*/
+
+Log_event::Log_event(const char* buf,
+                     const Format_description_log_event* description_event)
+  :temp_buf(0), cache_type(Log_event::EVENT_INVALID_CACHE)
+{
+#ifndef MYSQL_CLIENT
+  thd = 0;
+#endif
+  when = uint4korr(buf);
+  server_id = uint4korr(buf + SERVER_ID_OFFSET);
+  data_written= uint4korr(buf + EVENT_LEN_OFFSET);
+  if (description_event->binlog_version==1)
+  {
+    log_pos= 0;
+    flags= 0;
+    return;
+  }
+  /* 4.0 or newer */
+  log_pos= uint4korr(buf + LOG_POS_OFFSET);
+  /*
+    If the log is 4.0 (so here it can only be a 4.0 relay log read by
+    the SQL thread or a 4.0 master binlog read by the I/O thread),
+    log_pos is the beginning of the event: we transform it into the end
+    of the event, which is more useful.
+    But how do you know that the log is 4.0: you know it if
+    description_event is version 3 *and* you are not reading a
+    Format_desc (remember that mysqlbinlog starts by assuming that 5.0
+    logs are in 4.0 format, until it finds a Format_desc).
+  */
+  if (description_event->binlog_version==3 &&
+      buf[EVENT_TYPE_OFFSET]<FORMAT_DESCRIPTION_EVENT && log_pos)
+  {
+      /*
+        If log_pos=0, don't change it. log_pos==0 is a marker to mean
+        "don't change rli->group_master_log_pos" (see
+        inc_group_relay_log_pos()). As it is unreal log_pos, adding the
+        event len's is nonsense. For example, a fake Rotate event should
+        not have its log_pos (which is 0) changed or it will modify
+        Exec_master_log_pos in SHOW SLAVE STATUS, displaying a nonsense
+        value of (a non-zero offset which does not exist in the master's
+        binlog, so which will cause problems if the user uses this value
+        in CHANGE MASTER).
+      */
+    log_pos+= data_written; /* purecov: inspected */
+  }
+  DBUG_PRINT("info", ("log_pos: %lu", (ulong) log_pos));
+
+  flags= uint2korr(buf + FLAGS_OFFSET);
+  if ((buf[EVENT_TYPE_OFFSET] == FORMAT_DESCRIPTION_EVENT) ||
+      (buf[EVENT_TYPE_OFFSET] == ROTATE_EVENT))
+  {
+    /*
+      These events always have a header which stops here (i.e. their
+      header is FROZEN).
+    */
+    /*
+      Initialization to zero of all other Log_event members as they're
+      not specified. Currently there are no such members; in the future
+      there will be an event UID (but Format_description and Rotate
+      don't need this UID, as they are not propagated through
+      --log-slave-updates (remember the UID is used to not play a query
+      twice when you have two masters which are slaves of a 3rd master).
+      Then we are done.
+    */
+    return;
+  }
+  /* otherwise, go on with reading the header from buf (nothing now) */
+}
+
+#ifndef MYSQL_CLIENT
+#ifdef HAVE_REPLICATION
+
+int Log_event::do_update_pos(Relay_log_info *rli)
+{
+  /*
+    rli is null when (as far as I (Guilhem) know) the caller is
+    Load_log_event::do_apply_event *and* that one is called from
+    Execute_load_log_event::do_apply_event.  In this case, we don't
+    do anything here ; Execute_load_log_event::do_apply_event will
+    call Log_event::do_apply_event again later with the proper rli.
+    Strictly speaking, if we were sure that rli is null only in the
+    case discussed above, 'if (rli)' is useless here.  But as we are
+    not 100% sure, keep it for now.
+
+    Matz: I don't think we will need this check with this refactoring.
+  */
+  if (rli)
+  {
+    /*
+      bug#29309 simulation: resetting the flag to force
+      wrong behaviour of artificial event to update
+      rli->last_master_timestamp for only one time -
+      the first FLUSH LOGS in the test.
+    */
+    DBUG_EXECUTE_IF("let_first_flush_log_change_timestamp",
+                    if (debug_not_change_ts_if_art_event == 1
+                        && is_artificial_event())
+                    {
+                      debug_not_change_ts_if_art_event= 0;
+                    });
+#ifndef DBUG_OFF
+    rli->stmt_done(log_pos, 
+                   is_artificial_event() &&
+                   debug_not_change_ts_if_art_event > 0 ? 0 : when);
+#else
+    rli->stmt_done(log_pos, is_artificial_event()? 0 : when);
+#endif
+    DBUG_EXECUTE_IF("let_first_flush_log_change_timestamp",
+                    if (debug_not_change_ts_if_art_event == 0)
+                    {
+                      debug_not_change_ts_if_art_event= 2;
+                    });
+  }
+  return 0;                                   // Cannot fail currently
+}
+
+
+Log_event::enum_skip_reason
+Log_event::do_shall_skip(Relay_log_info *rli)
+{
+  DBUG_PRINT("info", ("ev->server_id=%lu, ::server_id=%lu,"
+                      " rli->replicate_same_server_id=%d,"
+                      " rli->slave_skip_counter=%d",
+                      (ulong) server_id, (ulong) ::server_id,
+                      rli->replicate_same_server_id,
+                      rli->slave_skip_counter));
+  if ((server_id == ::server_id && !rli->replicate_same_server_id) ||
+      (rli->slave_skip_counter == 1 && rli->is_in_group()))
+    return EVENT_SKIP_IGNORE;
+  else if (rli->slave_skip_counter > 0)
+    return EVENT_SKIP_COUNT;
+  else
+    return EVENT_SKIP_NOT;
+}
+
+
+/*
+  Log_event::pack_info()
+*/
+
+void Log_event::pack_info(Protocol *protocol)
+{
+  protocol->store("", &my_charset_bin);
+}
+
+
+/**
+  Only called by SHOW BINLOG EVENTS
+*/
+int Log_event::net_send(Protocol *protocol, const char* log_name, my_off_t pos)
+{
+  const char *p= strrchr(log_name, FN_LIBCHAR);
+  const char *event_type;
+  if (p)
+    log_name = p + 1;
+
+  protocol->prepare_for_resend();
+  protocol->store(log_name, &my_charset_bin);
+  protocol->store((ulonglong) pos);
+  event_type = get_type_str();
+  protocol->store(event_type, strlen(event_type), &my_charset_bin);
+  protocol->store((uint32) server_id);
+  protocol->store((ulonglong) log_pos);
+  pack_info(protocol);
+  return protocol->write();
+}
+#endif /* HAVE_REPLICATION */
+
+
+/**
+  init_show_field_list() prepares the column names and types for the
+  output of SHOW BINLOG EVENTS; it is used only by SHOW BINLOG
+  EVENTS.
+*/
+
+void Log_event::init_show_field_list(List<Item>* field_list)
+{
+  field_list->push_back(new Item_empty_string("Log_name", 20));
+  field_list->push_back(new Item_return_int("Pos", MY_INT32_NUM_DECIMAL_DIGITS,
+					    MYSQL_TYPE_LONGLONG));
+  field_list->push_back(new Item_empty_string("Event_type", 20));
+  field_list->push_back(new Item_return_int("Server_id", 10,
+					    MYSQL_TYPE_LONG));
+  field_list->push_back(new Item_return_int("End_log_pos",
+                                            MY_INT32_NUM_DECIMAL_DIGITS,
+					    MYSQL_TYPE_LONGLONG));
+  field_list->push_back(new Item_empty_string("Info", 20));
+}
+
+
+/*
+  Log_event::write()
+*/
+
+bool Log_event::write_header(IO_CACHE* file, ulong event_data_length)
+{
+  uchar header[LOG_EVENT_HEADER_LEN];
+  ulong now;
+  DBUG_ENTER("Log_event::write_header");
+
+  /* Store number of bytes that will be written by this event */
+  data_written= event_data_length + sizeof(header);
+
+  /*
+    log_pos != 0 if this is relay-log event. In this case we should not
+    change the position
+  */
+
+  if (is_artificial_event())
+  {
+    /*
+      Artificial events are automatically generated and do not exist
+      in master's binary log, so log_pos should be set to 0.
+    */
+    log_pos= 0;
+  }
+  else  if (!log_pos)
+  {
+    /*
+      Calculate position of end of event
+
+      Note that with a SEQ_READ_APPEND cache, my_b_tell() does not
+      work well.  So this will give slightly wrong positions for the
+      Format_desc/Rotate/Stop events which the slave writes to its
+      relay log. For example, the initial Format_desc will have
+      end_log_pos=91 instead of 95. Because after writing the first 4
+      bytes of the relay log, my_b_tell() still reports 0. Because
+      my_b_append() does not update the counter which my_b_tell()
+      later uses (one should probably use my_b_append_tell() to work
+      around this).  To get right positions even when writing to the
+      relay log, we use the (new) my_b_safe_tell().
+
+      Note that this raises a question on the correctness of all these
+      DBUG_ASSERT(my_b_tell()=rli->event_relay_log_pos).
+
+      If in a transaction, the log_pos which we calculate below is not
+      very good (because then my_b_safe_tell() returns start position
+      of the BEGIN, so it's like the statement was at the BEGIN's
+      place), but it's not a very serious problem (as the slave, when
+      it is in a transaction, does not take those end_log_pos into
+      account (as it calls inc_event_relay_log_pos()). To be fixed
+      later, so that it looks less strange. But not bug.
+    */
+
+    log_pos= my_b_safe_tell(file)+data_written;
+  }
+
+  now= (ulong) get_time();                              // Query start time
+
+  /*
+    Header will be of size LOG_EVENT_HEADER_LEN for all events, except for
+    FORMAT_DESCRIPTION_EVENT and ROTATE_EVENT, where it will be
+    LOG_EVENT_MINIMAL_HEADER_LEN (remember these 2 have a frozen header,
+    because we read them before knowing the format).
+  */
+
+  int4store(header, now);              // timestamp
+  header[EVENT_TYPE_OFFSET]= get_type_code();
+  int4store(header+ SERVER_ID_OFFSET, server_id);
+  int4store(header+ EVENT_LEN_OFFSET, data_written);
+  int4store(header+ LOG_POS_OFFSET, log_pos);
+  int2store(header+ FLAGS_OFFSET, flags);
+
+  DBUG_RETURN(my_b_safe_write(file, header, sizeof(header)) != 0);
+}
+
+
+/**
+  This needn't be format-tolerant, because we only read
+  LOG_EVENT_MINIMAL_HEADER_LEN (we just want to read the event's length).
+*/
+
+int Log_event::read_log_event(IO_CACHE* file, String* packet,
+                              mysql_mutex_t* log_lock,
+                              const char *log_file_name_arg,
+                              bool* is_binlog_active)
+{
+  ulong data_len;
+  int result=0;
+  char buf[LOG_EVENT_MINIMAL_HEADER_LEN];
+  DBUG_ENTER("Log_event::read_log_event");
+
+  if (log_lock)
+    mysql_mutex_lock(log_lock);
+
+  if (log_file_name_arg)
+    *is_binlog_active= mysql_bin_log.is_active(log_file_name_arg);
+
+  if (my_b_read(file, (uchar*) buf, sizeof(buf)))
+  {
+    /*
+      If the read hits eof, we must report it as eof so the caller
+      will know it can go into cond_wait to be woken up on the next
+      update to the log.
+    */
+    DBUG_PRINT("error",("file->error: %d", file->error));
+    if (!file->error)
+      result= LOG_READ_EOF;
+    else
+      result= (file->error > 0 ? LOG_READ_TRUNC : LOG_READ_IO);
+    goto end;
+  }
+  data_len= uint4korr(buf + EVENT_LEN_OFFSET);
+  if (data_len < LOG_EVENT_MINIMAL_HEADER_LEN ||
+      data_len > current_thd->variables.max_allowed_packet)
+  {
+    DBUG_PRINT("error",("data_len: %ld", data_len));
+    result= ((data_len < LOG_EVENT_MINIMAL_HEADER_LEN) ? LOG_READ_BOGUS :
+	     LOG_READ_TOO_LARGE);
+    goto end;
+  }
+
+  /* Append the log event header to packet */
+  if (packet->append(buf, sizeof(buf)))
+  {
+    /* Failed to allocate packet */
+    result= LOG_READ_MEM;
+    goto end;
+  }
+  data_len-= LOG_EVENT_MINIMAL_HEADER_LEN;
+  if (data_len)
+  {
+    /* Append rest of event, read directly from file into packet */
+    if (packet->append(file, data_len))
+    {
+      /*
+        Fatal error occured when appending rest of the event
+        to packet, possible failures:
+	1. EOF occured when reading from file, it's really an error
+           as data_len is >=0 there's supposed to be more bytes available.
+           file->error will have been set to number of bytes left to read
+        2. Read was interrupted, file->error would normally be set to -1
+        3. Failed to allocate memory for packet, my_errno
+           will be ENOMEM(file->error shuold be 0, but since the
+           memory allocation occurs before the call to read it might
+           be uninitialized)
+      */
+      result= (my_errno == ENOMEM ? LOG_READ_MEM :
+               (file->error >= 0 ? LOG_READ_TRUNC: LOG_READ_IO));
+      /* Implicit goto end; */
+    }
+  }
+
+end:
+  if (log_lock)
+    mysql_mutex_unlock(log_lock);
+  DBUG_RETURN(result);
+}
+#endif /* !MYSQL_CLIENT */
+
+#ifndef MYSQL_CLIENT
+#define UNLOCK_MUTEX if (log_lock) mysql_mutex_unlock(log_lock);
+#define LOCK_MUTEX if (log_lock) mysql_mutex_lock(log_lock);
+#else
+#define UNLOCK_MUTEX
+#define LOCK_MUTEX
+#endif
+
+#ifndef MYSQL_CLIENT
+/**
+  @note
+    Allocates memory;  The caller is responsible for clean-up.
+*/
+Log_event* Log_event::read_log_event(IO_CACHE* file,
+                                     mysql_mutex_t* log_lock,
+                                     const Format_description_log_event
+                                     *description_event)
+#else
+Log_event* Log_event::read_log_event(IO_CACHE* file,
+                                     const Format_description_log_event
+                                     *description_event)
+#endif
+{
+  DBUG_ENTER("Log_event::read_log_event");
+  DBUG_ASSERT(description_event != 0);
+  char head[LOG_EVENT_MINIMAL_HEADER_LEN];
+  /*
+    First we only want to read at most LOG_EVENT_MINIMAL_HEADER_LEN, just to
+    check the event for sanity and to know its length; no need to really parse
+    it. We say "at most" because this could be a 3.23 master, which has header
+    of 13 bytes, whereas LOG_EVENT_MINIMAL_HEADER_LEN is 19 bytes (it's
+    "minimal" over the set {MySQL >=4.0}).
+  */
+  uint header_size= min(description_event->common_header_len,
+                        LOG_EVENT_MINIMAL_HEADER_LEN);
+
+  LOCK_MUTEX;
+  DBUG_PRINT("info", ("my_b_tell: %lu", (ulong) my_b_tell(file)));
+  if (my_b_read(file, (uchar *) head, header_size))
+  {
+    DBUG_PRINT("info", ("Log_event::read_log_event(IO_CACHE*,Format_desc*) \
+failed my_b_read"));
+    UNLOCK_MUTEX;
+    /*
+      No error here; it could be that we are at the file's end. However
+      if the next my_b_read() fails (below), it will be an error as we
+      were able to read the first bytes.
+    */
+    DBUG_RETURN(0);
+  }
+  uint data_len = uint4korr(head + EVENT_LEN_OFFSET);
+  char *buf= 0;
+  const char *error= 0;
+  Log_event *res=  0;
+#ifndef max_allowed_packet
+  THD *thd=current_thd;
+  uint max_allowed_packet= thd ? slave_max_allowed_packet:~(ulong)0;
+#endif
+
+  if (data_len > max_allowed_packet)
+  {
+    error = "Event too big";
+    goto err;
+  }
+
+  if (data_len < header_size)
+  {
+    error = "Event too small";
+    goto err;
+  }
+
+  // some events use the extra byte to null-terminate strings
+  if (!(buf = (char*) my_malloc(data_len+1, MYF(MY_WME))))
+  {
+    error = "Out of memory";
+    goto err;
+  }
+  buf[data_len] = 0;
+  memcpy(buf, head, header_size);
+  if (my_b_read(file, (uchar*) buf + header_size, data_len - header_size))
+  {
+    error = "read error";
+    goto err;
+  }
+  if ((res= read_log_event(buf, data_len, &error, description_event)))
+    res->register_temp_buf(buf);
+
+err:
+  UNLOCK_MUTEX;
+  if (!res)
+  {
+    DBUG_ASSERT(error != 0);
+    sql_print_error("Error in Log_event::read_log_event(): "
+                    "'%s', data_len: %d, event_type: %d",
+		    error,data_len,head[EVENT_TYPE_OFFSET]);
+    my_free(buf);
+    /*
+      The SQL slave thread will check if file->error<0 to know
+      if there was an I/O error. Even if there is no "low-level" I/O errors
+      with 'file', any of the high-level above errors is worrying
+      enough to stop the SQL thread now ; as we are skipping the current event,
+      going on with reading and successfully executing other events can
+      only corrupt the slave's databases. So stop.
+    */
+    file->error= -1;
+  }
+  DBUG_RETURN(res);
+}
+
+
+/**
+  Binlog format tolerance is in (buf, event_len, description_event)
+  constructors.
+*/
+
+Log_event* Log_event::read_log_event(const char* buf, uint event_len,
+				     const char **error,
+                                     const Format_description_log_event *description_event)
+{
+  Log_event* ev;
+  DBUG_ENTER("Log_event::read_log_event(char*,...)");
+  DBUG_ASSERT(description_event != 0);
+  DBUG_PRINT("info", ("binlog_version: %d", description_event->binlog_version));
+  DBUG_DUMP("data", (unsigned char*) buf, event_len);
+
+  /* Check the integrity */
+  if (event_len < EVENT_LEN_OFFSET ||
+      buf[EVENT_TYPE_OFFSET] >= ENUM_END_EVENT ||
+      (uint) event_len != uint4korr(buf+EVENT_LEN_OFFSET))
+  {
+    *error="Sanity check failed";		// Needed to free buffer
+    DBUG_RETURN(NULL); // general sanity check - will fail on a partial read
+  }
+
+  uint event_type= buf[EVENT_TYPE_OFFSET];
+  if (event_type > description_event->number_of_event_types &&
+      event_type != FORMAT_DESCRIPTION_EVENT)
+  {
+    /*
+      It is unsafe to use the description_event if its post_header_len
+      array does not include the event type.
+    */
+    DBUG_PRINT("error", ("event type %d found, but the current "
+                         "Format_description_log_event supports only %d event "
+                         "types", event_type,
+                         description_event->number_of_event_types));
+    ev= NULL;
+  }
+  else
+  {
+    /*
+      In some previuos versions (see comment in
+      Format_description_log_event::Format_description_log_event(char*,...)),
+      event types were assigned different id numbers than in the
+      present version. In order to replicate from such versions to the
+      present version, we must map those event type id's to our event
+      type id's.  The mapping is done with the event_type_permutation
+      array, which was set up when the Format_description_log_event
+      was read.
+    */
+    if (description_event->event_type_permutation)
+    {
+      int new_event_type= description_event->event_type_permutation[event_type];
+      DBUG_PRINT("info", ("converting event type %d to %d (%s)",
+                   event_type, new_event_type,
+                   get_type_str((Log_event_type)new_event_type)));
+      event_type= new_event_type;
+    }
+
+    switch(event_type) {
+    case QUERY_EVENT:
+      ev  = new Query_log_event(buf, event_len, description_event, QUERY_EVENT);
+      break;
+    case LOAD_EVENT:
+      ev = new Load_log_event(buf, event_len, description_event);
+      break;
+    case NEW_LOAD_EVENT:
+      ev = new Load_log_event(buf, event_len, description_event);
+      break;
+    case ROTATE_EVENT:
+      ev = new Rotate_log_event(buf, event_len, description_event);
+      break;
+#ifdef HAVE_REPLICATION
+    case SLAVE_EVENT: /* can never happen (unused event) */
+      ev = new Slave_log_event(buf, event_len, description_event);
+      break;
+#endif /* HAVE_REPLICATION */
+    case CREATE_FILE_EVENT:
+      ev = new Create_file_log_event(buf, event_len, description_event);
+      break;
+    case APPEND_BLOCK_EVENT:
+      ev = new Append_block_log_event(buf, event_len, description_event);
+      break;
+    case DELETE_FILE_EVENT:
+      ev = new Delete_file_log_event(buf, event_len, description_event);
+      break;
+    case EXEC_LOAD_EVENT:
+      ev = new Execute_load_log_event(buf, event_len, description_event);
+      break;
+    case START_EVENT_V3: /* this is sent only by MySQL <=4.x */
+      ev = new Start_log_event_v3(buf, event_len, description_event);
+      break;
+    case STOP_EVENT:
+      ev = new Stop_log_event(buf, description_event);
+      break;
+    case INTVAR_EVENT:
+      ev = new Intvar_log_event(buf, description_event);
+      break;
+    case XID_EVENT:
+      ev = new Xid_log_event(buf, description_event);
+      break;
+    case RAND_EVENT:
+      ev = new Rand_log_event(buf, description_event);
+      break;
+    case USER_VAR_EVENT:
+      ev = new User_var_log_event(buf, event_len, description_event);
+      break;
+    case FORMAT_DESCRIPTION_EVENT:
+      ev = new Format_description_log_event(buf, event_len, description_event);
+      break;
+#if defined(HAVE_REPLICATION) 
+    case PRE_GA_WRITE_ROWS_EVENT:
+      ev = new Write_rows_log_event_old(buf, event_len, description_event);
+      break;
+    case PRE_GA_UPDATE_ROWS_EVENT:
+      ev = new Update_rows_log_event_old(buf, event_len, description_event);
+      break;
+    case PRE_GA_DELETE_ROWS_EVENT:
+      ev = new Delete_rows_log_event_old(buf, event_len, description_event);
+      break;
+    case WRITE_ROWS_EVENT:
+      ev = new Write_rows_log_event(buf, event_len, description_event);
+      break;
+    case UPDATE_ROWS_EVENT:
+      ev = new Update_rows_log_event(buf, event_len, description_event);
+      break;
+    case DELETE_ROWS_EVENT:
+      ev = new Delete_rows_log_event(buf, event_len, description_event);
+      break;
+    case TABLE_MAP_EVENT:
+      ev = new Table_map_log_event(buf, event_len, description_event);
+      break;
+#endif
+    case BEGIN_LOAD_QUERY_EVENT:
+      ev = new Begin_load_query_log_event(buf, event_len, description_event);
+      break;
+    case EXECUTE_LOAD_QUERY_EVENT:
+      ev= new Execute_load_query_log_event(buf, event_len, description_event);
+      break;
+    case INCIDENT_EVENT:
+      ev = new Incident_log_event(buf, event_len, description_event);
+      break;
+    default:
+      DBUG_PRINT("error",("Unknown event code: %d",
+                          (int) buf[EVENT_TYPE_OFFSET]));
+      ev= NULL;
+      break;
+    }
+  }
+
+  DBUG_PRINT("read_event", ("%s(type_code: %d; event_len: %d)",
+                            ev ? ev->get_type_str() : "<unknown>",
+                            buf[EVENT_TYPE_OFFSET],
+                            event_len));
+  /*
+    is_valid() are small event-specific sanity tests which are
+    important; for example there are some my_malloc() in constructors
+    (e.g. Query_log_event::Query_log_event(char*...)); when these
+    my_malloc() fail we can't return an error out of the constructor
+    (because constructor is "void") ; so instead we leave the pointer we
+    wanted to allocate (e.g. 'query') to 0 and we test it in is_valid().
+    Same for Format_description_log_event, member 'post_header_len'.
+
+    SLAVE_EVENT is never used, so it should not be read ever.
+  */
+  if (!ev || !ev->is_valid() || (event_type == SLAVE_EVENT))
+  {
+    DBUG_PRINT("error",("Found invalid event in binary log"));
+
+    delete ev;
+#ifdef MYSQL_CLIENT
+    if (!force_opt) /* then mysqlbinlog dies */
+    {
+      *error= "Found invalid event in binary log";
+      DBUG_RETURN(0);
+    }
+    ev= new Unknown_log_event(buf, description_event);
+#else
+    *error= "Found invalid event in binary log";
+    DBUG_RETURN(0);
+#endif
+  }
+  DBUG_RETURN(ev);  
+}
+
+#ifdef MYSQL_CLIENT
+
+/*
+  Log_event::print_header()
+*/
+
+void Log_event::print_header(IO_CACHE* file,
+                             PRINT_EVENT_INFO* print_event_info,
+                             bool is_more __attribute__((unused)))
+{
+  char llbuff[22];
+  my_off_t hexdump_from= print_event_info->hexdump_from;
+  DBUG_ENTER("Log_event::print_header");
+
+  my_b_printf(file, "#");
+  print_timestamp(file);
+  my_b_printf(file, " server id %lu  end_log_pos %s ", (ulong) server_id,
+              llstr(log_pos,llbuff));
+
+  /* mysqlbinlog --hexdump */
+  if (print_event_info->hexdump_from)
+  {
+    my_b_printf(file, "\n");
+    uchar *ptr= (uchar*)temp_buf;
+    my_off_t size=
+      uint4korr(ptr + EVENT_LEN_OFFSET) - LOG_EVENT_MINIMAL_HEADER_LEN;
+    my_off_t i;
+
+    /* Header len * 4 >= header len * (2 chars + space + extra space) */
+    char *h, hex_string[LOG_EVENT_MINIMAL_HEADER_LEN*4]= {0};
+    char *c, char_string[16+1]= {0};
+
+    /* Pretty-print event common header if header is exactly 19 bytes */
+    if (print_event_info->common_header_len == LOG_EVENT_MINIMAL_HEADER_LEN)
+    {
+      char emit_buf[256];               // Enough for storing one line
+      my_b_printf(file, "# Position  Timestamp   Type   Master ID        "
+                  "Size      Master Pos    Flags \n");
+      size_t const bytes_written=
+        my_snprintf(emit_buf, sizeof(emit_buf),
+                    "# %8.8lx %02x %02x %02x %02x   %02x   "
+                    "%02x %02x %02x %02x   %02x %02x %02x %02x   "
+                    "%02x %02x %02x %02x   %02x %02x\n",
+                    (unsigned long) hexdump_from,
+                    ptr[0], ptr[1], ptr[2], ptr[3], ptr[4], ptr[5], ptr[6],
+                    ptr[7], ptr[8], ptr[9], ptr[10], ptr[11], ptr[12], ptr[13],
+                    ptr[14], ptr[15], ptr[16], ptr[17], ptr[18]);
+      DBUG_ASSERT(static_cast<size_t>(bytes_written) < sizeof(emit_buf));
+      my_b_write(file, (uchar*) emit_buf, bytes_written);
+      ptr += LOG_EVENT_MINIMAL_HEADER_LEN;
+      hexdump_from += LOG_EVENT_MINIMAL_HEADER_LEN;
+    }
+
+    /* Rest of event (without common header) */
+    for (i= 0, c= char_string, h=hex_string;
+	 i < size;
+	 i++, ptr++)
+    {
+      my_snprintf(h, 4, "%02x ", *ptr);
+      h += 3;
+
+      *c++= my_isalnum(&my_charset_bin, *ptr) ? *ptr : '.';
+
+      if (i % 16 == 15)
+      {
+        /*
+          my_b_printf() does not support full printf() formats, so we
+          have to do it this way.
+
+          TODO: Rewrite my_b_printf() to support full printf() syntax.
+         */
+        char emit_buf[256];
+        size_t const bytes_written=
+          my_snprintf(emit_buf, sizeof(emit_buf),
+                      "# %8.8lx %-48.48s |%16s|\n",
+                      (unsigned long) (hexdump_from + (i & 0xfffffff0)),
+                      hex_string, char_string);
+        DBUG_ASSERT(static_cast<size_t>(bytes_written) < sizeof(emit_buf));
+	my_b_write(file, (uchar*) emit_buf, bytes_written);
+	hex_string[0]= 0;
+	char_string[0]= 0;
+	c= char_string;
+	h= hex_string;
+      }
+      else if (i % 8 == 7) *h++ = ' ';
+    }
+    *c= '\0';
+
+    if (hex_string[0])
+    {
+      char emit_buf[256];
+      size_t const bytes_written=
+        my_snprintf(emit_buf, sizeof(emit_buf),
+                    "# %8.8lx %-48.48s |%s|\n",
+                    (unsigned long) (hexdump_from + (i & 0xfffffff0)),
+                    hex_string, char_string);
+      DBUG_ASSERT(static_cast<size_t>(bytes_written) < sizeof(emit_buf));
+      my_b_write(file, (uchar*) emit_buf, bytes_written);
+    }
+    /*
+      need a # to prefix the rest of printouts for example those of
+      Rows_log_event::print_helper().
+    */
+    my_b_write(file, reinterpret_cast<const uchar*>("# "), 2);
+  }
+  DBUG_VOID_RETURN;
+}
+
+
+/**
+  Prints a quoted string to io cache.
+  Control characters are displayed as hex sequence, e.g. \x00
+  
+  @param[in] file              IO cache
+  @param[in] prt               Pointer to string
+  @param[in] length            String length
+*/
+
+static void
+my_b_write_quoted(IO_CACHE *file, const uchar *ptr, uint length)
+{
+  const uchar *s;
+  my_b_printf(file, "'");
+  for (s= ptr; length > 0 ; s++, length--)
+  {
+    if (*s > 0x1F)
+      my_b_write(file, s, 1);
+    else
+    {
+      uchar hex[10];
+      size_t len= my_snprintf((char*) hex, sizeof(hex), "%s%02x", "\\x", *s);
+      my_b_write(file, hex, len);
+    }
+  }
+  my_b_printf(file, "'");
+}
+
+
+/**
+  Prints a bit string to io cache in format  b'1010'.
+  
+  @param[in] file              IO cache
+  @param[in] ptr               Pointer to string
+  @param[in] nbits             Number of bits
+*/
+static void
+my_b_write_bit(IO_CACHE *file, const uchar *ptr, uint nbits)
+{
+  uint bitnum, nbits8= ((nbits + 7) / 8) * 8, skip_bits= nbits8 - nbits;
+  my_b_printf(file, "b'");
+  for (bitnum= skip_bits ; bitnum < nbits8; bitnum++)
+  {
+    int is_set= (ptr[(bitnum) / 8] >> (7 - bitnum % 8))  & 0x01;
+    my_b_write(file, (const uchar*) (is_set ? "1" : "0"), 1);
+  }
+  my_b_printf(file, "'");
+}
+
+
+/**
+  Prints a packed string to io cache.
+  The string consists of length packed to 1 or 2 bytes,
+  followed by string data itself.
+  
+  @param[in] file              IO cache
+  @param[in] ptr               Pointer to string
+  @param[in] length            String size
+  
+  @retval   - number of bytes scanned.
+*/
+static size_t
+my_b_write_quoted_with_length(IO_CACHE *file, const uchar *ptr, uint length)
+{
+  if (length < 256)
+  {
+    length= *ptr;
+    my_b_write_quoted(file, ptr + 1, length);
+    return length + 1;
+  }
+  else
+  {
+    length= uint2korr(ptr);
+    my_b_write_quoted(file, ptr + 2, length);
+    return length + 2;
+  }
+}
+
+
+/**
+  Prints a 32-bit number in both signed and unsigned representation
+  
+  @param[in] file              IO cache
+  @param[in] sl                Signed number
+  @param[in] ul                Unsigned number
+*/
+static void
+my_b_write_sint32_and_uint32(IO_CACHE *file, int32 si, uint32 ui)
+{
+  my_b_printf(file, "%d", si);
+  if (si < 0)
+    my_b_printf(file, " (%u)", ui);
+}
+
+
+/**
+  Print a packed value of the given SQL type into IO cache
+  
+  @param[in] file              IO cache
+  @param[in] ptr               Pointer to string
+  @param[in] type              Column type
+  @param[in] meta              Column meta information
+  @param[out] typestr          SQL type string buffer (for verbose output)
+  @param[out] typestr_length   Size of typestr
+  
+  @retval   - number of bytes scanned from ptr.
+*/
+
+static size_t
+log_event_print_value(IO_CACHE *file, const uchar *ptr,
+                      uint type, uint meta,
+                      char *typestr, size_t typestr_length)
+{
+  uint32 length= 0;
+
+  if (type == MYSQL_TYPE_STRING)
+  {
+    if (meta >= 256)
+    {
+      uint byte0= meta >> 8;
+      uint byte1= meta & 0xFF;
+      
+      if ((byte0 & 0x30) != 0x30)
+      {
+        /* a long CHAR() field: see #37426 */
+        length= byte1 | (((byte0 & 0x30) ^ 0x30) << 4);
+        type= byte0 | 0x30;
+      }
+      else
+        length = meta & 0xFF;
+    }
+    else
+      length= meta;
+  }
+
+  switch (type) {
+  case MYSQL_TYPE_LONG:
+    {
+      int32 si= sint4korr(ptr);
+      uint32 ui= uint4korr(ptr);
+      my_b_write_sint32_and_uint32(file, si, ui);
+      my_snprintf(typestr, typestr_length, "INT");
+      return 4;
+    }
+
+  case MYSQL_TYPE_TINY:
+    {
+      my_b_write_sint32_and_uint32(file, (int) (signed char) *ptr,
+                                  (uint) (unsigned char) *ptr);
+      my_snprintf(typestr, typestr_length, "TINYINT");
+      return 1;
+    }
+
+  case MYSQL_TYPE_SHORT:
+    {
+      int32 si= (int32) sint2korr(ptr);
+      uint32 ui= (uint32) uint2korr(ptr);
+      my_b_write_sint32_and_uint32(file, si, ui);
+      my_snprintf(typestr, typestr_length, "SHORTINT");
+      return 2;
+    }
+  
+  case MYSQL_TYPE_INT24:
+    {
+      int32 si= sint3korr(ptr);
+      uint32 ui= uint3korr(ptr);
+      my_b_write_sint32_and_uint32(file, si, ui);
+      my_snprintf(typestr, typestr_length, "MEDIUMINT");
+      return 3;
+    }
+
+  case MYSQL_TYPE_LONGLONG:
+    {
+      char tmp[64];
+      longlong si= sint8korr(ptr);
+      longlong10_to_str(si, tmp, -10);
+      my_b_printf(file, "%s", tmp);
+      if (si < 0)
+      {
+        ulonglong ui= uint8korr(ptr);
+        longlong10_to_str((longlong) ui, tmp, 10);
+        my_b_printf(file, " (%s)", tmp);        
+      }
+      my_snprintf(typestr, typestr_length, "LONGINT");
+      return 8;
+    }
+
+  case MYSQL_TYPE_NEWDECIMAL:
+    {
+      uint precision= meta >> 8;
+      uint decimals= meta & 0xFF;
+      uint bin_size= my_decimal_get_binary_size(precision, decimals);
+      my_decimal dec;
+      binary2my_decimal(E_DEC_FATAL_ERROR, (uchar*) ptr, &dec,
+                        precision, decimals);
+      int i, end;
+      char buff[512], *pos;
+      pos= buff;
+      pos+= sprintf(buff, "%s", dec.sign() ? "-" : "");
+      end= ROUND_UP(dec.frac) + ROUND_UP(dec.intg)-1;
+      for (i=0; i < end; i++)
+        pos+= sprintf(pos, "%09d.", dec.buf[i]);
+      pos+= sprintf(pos, "%09d", dec.buf[i]);
+      my_b_printf(file, "%s", buff);
+      my_snprintf(typestr, typestr_length, "DECIMAL(%d,%d)",
+                  precision, decimals);
+      return bin_size;
+    }
+
+  case MYSQL_TYPE_FLOAT:
+    {
+      float fl;
+      float4get(fl, ptr);
+      char tmp[320];
+      sprintf(tmp, "%-20g", (double) fl);
+      my_b_printf(file, "%s", tmp); /* my_snprintf doesn't support %-20g */
+      my_snprintf(typestr, typestr_length, "FLOAT");
+      return 4;
+    }
+
+  case MYSQL_TYPE_DOUBLE:
+    {
+      double dbl;
+      float8get(dbl, ptr);
+      char tmp[320];
+      sprintf(tmp, "%-.20g", dbl); /* my_snprintf doesn't support %-20g */
+      my_b_printf(file, "%s", tmp);
+      strcpy(typestr, "DOUBLE");
+      return 8;
+    }
+  
+  case MYSQL_TYPE_BIT:
+    {
+      /* Meta-data: bit_len, bytes_in_rec, 2 bytes */
+      uint nbits= ((meta >> 8) * 8) + (meta & 0xFF);
+      length= (nbits + 7) / 8;
+      my_b_write_bit(file, ptr, nbits);
+      my_snprintf(typestr, typestr_length, "BIT(%d)", nbits);
+      return length;
+    }
+
+  case MYSQL_TYPE_TIMESTAMP:
+    {
+      uint32 i32= uint4korr(ptr);
+      my_b_printf(file, "%d", i32);
+      my_snprintf(typestr, typestr_length, "TIMESTAMP");
+      return 4;
+    }
+
+  case MYSQL_TYPE_DATETIME:
+    {
+      size_t d, t;
+      uint64 i64= uint8korr(ptr); /* YYYYMMDDhhmmss */
+      d= i64 / 1000000;
+      t= i64 % 1000000;
+      my_b_printf(file, "%04d-%02d-%02d %02d:%02d:%02d",
+                  d / 10000, (d % 10000) / 100, d % 100,
+                  t / 10000, (t % 10000) / 100, t % 100);
+      my_snprintf(typestr, typestr_length, "DATETIME");
+      return 8;
+    }
+
+  case MYSQL_TYPE_TIME:
+    {
+      uint32 i32= uint3korr(ptr);
+      my_b_printf(file, "'%02d:%02d:%02d'",
+                  i32 / 10000, (i32 % 10000) / 100, i32 % 100);
+      my_snprintf(typestr,  typestr_length, "TIME");
+      return 3;
+    }
+    
+  case MYSQL_TYPE_NEWDATE:
+    {
+      uint32 tmp= uint3korr(ptr);
+      int part;
+      char buf[11];
+      char *pos= &buf[10];  // start from '\0' to the beginning
+
+      /* Copied from field.cc */
+      *pos--=0;					// End NULL
+      part=(int) (tmp & 31);
+      *pos--= (char) ('0'+part%10);
+      *pos--= (char) ('0'+part/10);
+      *pos--= ':';
+      part=(int) (tmp >> 5 & 15);
+      *pos--= (char) ('0'+part%10);
+      *pos--= (char) ('0'+part/10);
+      *pos--= ':';
+      part=(int) (tmp >> 9);
+      *pos--= (char) ('0'+part%10); part/=10;
+      *pos--= (char) ('0'+part%10); part/=10;
+      *pos--= (char) ('0'+part%10); part/=10;
+      *pos=   (char) ('0'+part);
+      my_b_printf(file , "'%s'", buf);
+      my_snprintf(typestr, typestr_length, "DATE");
+      return 3;
+    }
+    
+  case MYSQL_TYPE_DATE:
+    {
+      uint i32= uint3korr(ptr);
+      my_b_printf(file , "'%04d:%02d:%02d'",
+                  (i32 / (16L * 32L)), (i32 / 32L % 16L), (i32 % 32L));
+      my_snprintf(typestr, typestr_length, "DATE");
+      return 3;
+    }
+  
+  case MYSQL_TYPE_YEAR:
+    {
+      uint32 i32= *ptr;
+      my_b_printf(file, "%04d", i32+ 1900);
+      my_snprintf(typestr, typestr_length, "YEAR");
+      return 1;
+    }
+  
+  case MYSQL_TYPE_ENUM:
+    switch (meta & 0xFF) {
+    case 1:
+      my_b_printf(file, "%d", (int) *ptr);
+      my_snprintf(typestr, typestr_length, "ENUM(1 byte)");
+      return 1;
+    case 2:
+      {
+        int32 i32= uint2korr(ptr);
+        my_b_printf(file, "%d", i32);
+        my_snprintf(typestr, typestr_length, "ENUM(2 bytes)");
+        return 2;
+      }
+    default:
+      my_b_printf(file, "!! Unknown ENUM packlen=%d", meta & 0xFF); 
+      return 0;
+    }
+    break;
+    
+  case MYSQL_TYPE_SET:
+    my_b_write_bit(file, ptr , (meta & 0xFF) * 8);
+    my_snprintf(typestr, typestr_length, "SET(%d bytes)", meta & 0xFF);
+    return meta & 0xFF;
+  
+  case MYSQL_TYPE_BLOB:
+    switch (meta) {
+    case 1:
+      length= *ptr;
+      my_b_write_quoted(file, ptr + 1, length);
+      my_snprintf(typestr, typestr_length, "TINYBLOB/TINYTEXT");
+      return length + 1;
+    case 2:
+      length= uint2korr(ptr);
+      my_b_write_quoted(file, ptr + 2, length);
+      my_snprintf(typestr, typestr_length, "BLOB/TEXT");
+      return length + 2;
+    case 3:
+      length= uint3korr(ptr);
+      my_b_write_quoted(file, ptr + 3, length);
+      my_snprintf(typestr, typestr_length, "MEDIUMBLOB/MEDIUMTEXT");
+      return length + 3;
+    case 4:
+      length= uint4korr(ptr);
+      my_b_write_quoted(file, ptr + 4, length);
+      my_snprintf(typestr, typestr_length, "LONGBLOB/LONGTEXT");
+      return length + 4;
+    default:
+      my_b_printf(file, "!! Unknown BLOB packlen=%d", length);
+      return 0;
+    }
+
+  case MYSQL_TYPE_VARCHAR:
+  case MYSQL_TYPE_VAR_STRING:
+    length= meta;
+    my_snprintf(typestr, typestr_length, "VARSTRING(%d)", length);
+    return my_b_write_quoted_with_length(file, ptr, length);
+
+  case MYSQL_TYPE_STRING:
+    my_snprintf(typestr, typestr_length, "STRING(%d)", length);
+    return my_b_write_quoted_with_length(file, ptr, length);
+
+  default:
+    {
+      char tmp[5];
+      my_snprintf(tmp, sizeof(tmp), "%04x", meta);
+      my_b_printf(file,
+                  "!! Don't know how to handle column type=%d meta=%d (%s)",
+                  type, meta, tmp);
+    }
+    break;
+  }
+  *typestr= 0;
+  return 0;
+}
+
+
+/**
+  Print a packed row into IO cache
+  
+  @param[in] file              IO cache
+  @param[in] td                Table definition
+  @param[in] print_event_into  Print parameters
+  @param[in] cols_bitmap       Column bitmaps.
+  @param[in] value             Pointer to packed row
+  @param[in] prefix            Row's SQL clause ("SET", "WHERE", etc)
+  
+  @retval   - number of bytes scanned.
+*/
+
+
+size_t
+Rows_log_event::print_verbose_one_row(IO_CACHE *file, table_def *td,
+                                      PRINT_EVENT_INFO *print_event_info,
+                                      MY_BITMAP *cols_bitmap,
+                                      const uchar *value, const uchar *prefix)
+{
+  const uchar *value0= value;
+  const uchar *null_bits= value;
+  uint null_bit_index= 0;
+  char typestr[64]= "";
+  
+  value+= (m_width + 7) / 8;
+  
+  my_b_printf(file, "%s", prefix);
+  
+  for (size_t i= 0; i < td->size(); i ++)
+  {
+    int is_null= (null_bits[null_bit_index / 8] 
+                  >> (null_bit_index % 8))  & 0x01;
+
+    if (bitmap_is_set(cols_bitmap, i) == 0)
+      continue;
+    
+    if (is_null)
+    {
+      my_b_printf(file, "###   @%d=NULL", i + 1);
+    }
+    else
+    {
+      my_b_printf(file, "###   @%d=", i + 1);
+      size_t fsize= td->calc_field_size((uint)i, (uchar*) value);
+      if (value + fsize > m_rows_end)
+      {
+        my_b_printf(file, "***Corrupted replication event was detected."
+                    " Not printing the value***\n");
+        value+= fsize;
+        return 0;
+      }
+      size_t size= log_event_print_value(file, value,
+                                         td->type(i), td->field_metadata(i),
+                                         typestr, sizeof(typestr));
+      if (!size)
+        return 0;
+
+      value+= size;
+    }
+
+    if (print_event_info->verbose > 1)
+    {
+      my_b_printf(file, " /* ");
+
+      if (typestr[0])
+        my_b_printf(file, "%s ", typestr);
+      else
+        my_b_printf(file, "type=%d ", td->type(i));
+      
+      my_b_printf(file, "meta=%d nullable=%d is_null=%d ",
+                  td->field_metadata(i),
+                  td->maybe_null(i), is_null);
+      my_b_printf(file, "*/");
+    }
+    
+    my_b_printf(file, "\n");
+    
+    null_bit_index++;
+  }
+  return value - value0;
+}
+
+
+/**
+  Print a row event into IO cache in human readable form (in SQL format)
+  
+  @param[in] file              IO cache
+  @param[in] print_event_into  Print parameters
+*/
+void Rows_log_event::print_verbose(IO_CACHE *file,
+                                   PRINT_EVENT_INFO *print_event_info)
+{
+  // Quoted length of the identifier can be twice the original length
+  char quoted_db[1 + NAME_LEN * 2 + 2];
+  char quoted_table[1 + NAME_LEN * 2 + 2];
+  int quoted_db_len, quoted_table_len;
+  Table_map_log_event *map;
+  table_def *td;
+  const char *sql_command, *sql_clause1, *sql_clause2;
+  Log_event_type type_code= get_type_code();
+  
+  switch (type_code) {
+  case WRITE_ROWS_EVENT:
+    sql_command= "INSERT INTO";
+    sql_clause1= "### SET\n";
+    sql_clause2= NULL;
+    break;
+  case DELETE_ROWS_EVENT:
+    sql_command= "DELETE FROM";
+    sql_clause1= "### WHERE\n";
+    sql_clause2= NULL;
+    break;
+  case UPDATE_ROWS_EVENT:
+    sql_command= "UPDATE";
+    sql_clause1= "### WHERE\n";
+    sql_clause2= "### SET\n";
+    break;
+  default:
+    sql_command= sql_clause1= sql_clause2= NULL;
+    DBUG_ASSERT(0); /* Not possible */
+  }
+  
+  if (!(map= print_event_info->m_table_map.get_table(m_table_id)) ||
+      !(td= map->create_table_def()))
+  {
+    my_b_printf(file, "### Row event for unknown table #%d", m_table_id);
+    return;
+  }
+
+  for (const uchar *value= m_rows_buf; value < m_rows_end; )
+  {
+    size_t length;
+#ifdef MYSQL_SERVER
+    quoted_db_len= my_strmov_quoted_identifier(this->thd, (char *) quoted_db,
+                                        map->get_db_name(), 0);
+    quoted_table_len= my_strmov_quoted_identifier(this->thd,
+                                                  (char *) quoted_table,
+                                                  map->get_table_name(), 0);
+#else
+    quoted_db_len= my_strmov_quoted_identifier((char *) quoted_db,
+                                               map->get_db_name());
+    quoted_table_len= my_strmov_quoted_identifier((char *) quoted_table,
+                                          map->get_table_name());
+#endif
+    quoted_db[quoted_db_len]= '\0';
+    quoted_table[quoted_table_len]= '\0';
+    my_b_printf(file, "### %s %s.%s\n",
+                      sql_command,
+                      quoted_db, quoted_table);
+    /* Print the first image */
+    if (!(length= print_verbose_one_row(file, td, print_event_info,
+                                  &m_cols, value,
+                                  (const uchar*) sql_clause1)))
+      goto end;
+    value+= length;
+
+    /* Print the second image (for UPDATE only) */
+    if (sql_clause2)
+    {
+      if (!(length= print_verbose_one_row(file, td, print_event_info,
+                                      &m_cols_ai, value,
+                                      (const uchar*) sql_clause2)))
+        goto end;
+      value+= length;
+    }
+  }
+
+end:
+  delete td;
+}
+
+#ifdef MYSQL_CLIENT
+void free_table_map_log_event(Table_map_log_event *event)
+{
+  delete event;
+}
+#endif
+
+void Log_event::print_base64(IO_CACHE* file,
+                             PRINT_EVENT_INFO* print_event_info,
+                             bool more)
+{
+  const uchar *ptr= (const uchar *)temp_buf;
+  uint32 size= uint4korr(ptr + EVENT_LEN_OFFSET);
+  DBUG_ENTER("Log_event::print_base64");
+
+  size_t const tmp_str_sz= base64_needed_encoded_length((int) size);
+  char *const tmp_str= (char *) my_malloc(tmp_str_sz, MYF(MY_WME));
+  if (!tmp_str) {
+    fprintf(stderr, "\nError: Out of memory. "
+            "Could not print correct binlog event.\n");
+    DBUG_VOID_RETURN;
+  }
+
+  if (base64_encode(ptr, (size_t) size, tmp_str))
+  {
+    DBUG_ASSERT(0);
+  }
+
+  if (print_event_info->base64_output_mode != BASE64_OUTPUT_DECODE_ROWS)
+  {
+    if (my_b_tell(file) == 0)
+      my_b_printf(file, "\nBINLOG '\n");
+
+    my_b_printf(file, "%s\n", tmp_str);
+
+    if (!more)
+      my_b_printf(file, "'%s\n", print_event_info->delimiter);
+  }
+  
+  if (print_event_info->verbose)
+  {
+    Rows_log_event *ev= NULL;
+    
+    if (ptr[4] == TABLE_MAP_EVENT)
+    {
+      Table_map_log_event *map; 
+      map= new Table_map_log_event((const char*) ptr, size, 
+                                   glob_description_event);
+      print_event_info->m_table_map.set_table(map->get_table_id(), map);
+    }
+    else if (ptr[4] == WRITE_ROWS_EVENT)
+    {
+      ev= new Write_rows_log_event((const char*) ptr, size,
+                                   glob_description_event);
+    }
+    else if (ptr[4] == DELETE_ROWS_EVENT)
+    {
+      ev= new Delete_rows_log_event((const char*) ptr, size,
+                                    glob_description_event);
+    }
+    else if (ptr[4] == UPDATE_ROWS_EVENT)
+    {
+      ev= new Update_rows_log_event((const char*) ptr, size,
+                                    glob_description_event);
+    }
+    
+    if (ev)
+    {
+      ev->print_verbose(file, print_event_info);
+      delete ev;
+    }
+  }
+    
+  my_free(tmp_str);
+  DBUG_VOID_RETURN;
+}
+
+
+/*
+  Log_event::print_timestamp()
+*/
+
+void Log_event::print_timestamp(IO_CACHE* file, time_t* ts)
+{
+  struct tm *res;
+  DBUG_ENTER("Log_event::print_timestamp");
+  if (!ts)
+    ts = &when;
+  struct tm tm_tmp;
+  localtime_r(ts,(res= &tm_tmp));
+  my_b_printf(file,"%02d%02d%02d %2d:%02d:%02d",
+              res->tm_year % 100,
+              res->tm_mon+1,
+              res->tm_mday,
+              res->tm_hour,
+              res->tm_min,
+              res->tm_sec);
+  DBUG_VOID_RETURN;
+}
+
+#endif /* MYSQL_CLIENT */
+
+
+#if !defined(MYSQL_CLIENT) && defined(HAVE_REPLICATION)
+inline Log_event::enum_skip_reason
+Log_event::continue_group(Relay_log_info *rli)
+{
+  if (rli->slave_skip_counter == 1)
+    return Log_event::EVENT_SKIP_IGNORE;
+  return Log_event::do_shall_skip(rli);
+}
+#endif
+
+/**************************************************************************
+	Query_log_event methods
+**************************************************************************/
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+
+/**
+  This (which is used only for SHOW BINLOG EVENTS) could be updated to
+  print SET @@session_var=. But this is not urgent, as SHOW BINLOG EVENTS is
+  only an information, it does not produce suitable queries to replay (for
+  example it does not print LOAD DATA INFILE).
+  @todo
+    show the catalog ??
+*/
+
+void Query_log_event::pack_info(Protocol *protocol)
+{
+  // TODO: show the catalog ??
+  String temp_buf;
+  // Add use `DB` to the string if required
+  if (!(flags & LOG_EVENT_SUPPRESS_USE_F)
+      && db && db_len)
+  {
+    temp_buf.append("use ");
+    append_identifier(this->thd, &temp_buf, db, db_len);
+    temp_buf.append("; ");
+  }
+  // Add the query to the string
+  if (query && q_len)
+    temp_buf.append(query);
+ // persist the buffer in protocol
+  protocol->store(temp_buf.ptr(), temp_buf.length(), &my_charset_bin);
+}
+#endif
+
+#ifndef MYSQL_CLIENT
+
+/**
+  Utility function for the next method (Query_log_event::write()) .
+*/
+static void write_str_with_code_and_len(uchar **dst, const char *src,
+                                        uint len, uint code)
+{
+  /*
+    only 1 byte to store the length of catalog, so it should not
+    surpass 255
+  */
+  DBUG_ASSERT(len <= 255);
+  DBUG_ASSERT(src);
+  *((*dst)++)= code;
+  *((*dst)++)= (uchar) len;
+  bmove(*dst, src, len);
+  (*dst)+= len;
+}
+
+
+/**
+  Query_log_event::write().
+
+  @note
+    In this event we have to modify the header to have the correct
+    EVENT_LEN_OFFSET as we don't yet know how many status variables we
+    will print!
+*/
+
+bool Query_log_event::write(IO_CACHE* file)
+{
+  uchar buf[QUERY_HEADER_LEN + MAX_SIZE_LOG_EVENT_STATUS];
+  uchar *start, *start_of_status;
+  ulong event_length;
+
+  if (!query)
+    return 1;                                   // Something wrong with event
+
+  /*
+    We want to store the thread id:
+    (- as an information for the user when he reads the binlog)
+    - if the query uses temporary table: for the slave SQL thread to know to
+    which master connection the temp table belongs.
+    Now imagine we (write()) are called by the slave SQL thread (we are
+    logging a query executed by this thread; the slave runs with
+    --log-slave-updates). Then this query will be logged with
+    thread_id=the_thread_id_of_the_SQL_thread. Imagine that 2 temp tables of
+    the same name were created simultaneously on the master (in the master
+    binlog you have
+    CREATE TEMPORARY TABLE t; (thread 1)
+    CREATE TEMPORARY TABLE t; (thread 2)
+    ...)
+    then in the slave's binlog there will be
+    CREATE TEMPORARY TABLE t; (thread_id_of_the_slave_SQL_thread)
+    CREATE TEMPORARY TABLE t; (thread_id_of_the_slave_SQL_thread)
+    which is bad (same thread id!).
+
+    To avoid this, we log the thread's thread id EXCEPT for the SQL
+    slave thread for which we log the original (master's) thread id.
+    Now this moves the bug: what happens if the thread id on the
+    master was 10 and when the slave replicates the query, a
+    connection number 10 is opened by a normal client on the slave,
+    and updates a temp table of the same name? We get a problem
+    again. To avoid this, in the handling of temp tables (sql_base.cc)
+    we use thread_id AND server_id.  TODO when this is merged into
+    4.1: in 4.1, slave_proxy_id has been renamed to pseudo_thread_id
+    and is a session variable: that's to make mysqlbinlog work with
+    temp tables. We probably need to introduce
+
+    SET PSEUDO_SERVER_ID
+    for mysqlbinlog in 4.1. mysqlbinlog would print:
+    SET PSEUDO_SERVER_ID=
+    SET PSEUDO_THREAD_ID=
+    for each query using temp tables.
+  */
+  int4store(buf + Q_THREAD_ID_OFFSET, slave_proxy_id);
+  int4store(buf + Q_EXEC_TIME_OFFSET, exec_time);
+  buf[Q_DB_LEN_OFFSET] = (char) db_len;
+  int2store(buf + Q_ERR_CODE_OFFSET, error_code);
+
+  /*
+    You MUST always write status vars in increasing order of code. This
+    guarantees that a slightly older slave will be able to parse those he
+    knows.
+  */
+  start_of_status= start= buf+QUERY_HEADER_LEN;
+  if (flags2_inited)
+  {
+    *start++= Q_FLAGS2_CODE;
+    int4store(start, flags2);
+    start+= 4;
+  }
+  if (sql_mode_inited)
+  {
+    *start++= Q_SQL_MODE_CODE;
+    int8store(start, (ulonglong)sql_mode);
+    start+= 8;
+  }
+  if (catalog_len) // i.e. this var is inited (false for 4.0 events)
+  {
+    write_str_with_code_and_len(&start,
+                                catalog, catalog_len, Q_CATALOG_NZ_CODE);
+    /*
+      In 5.0.x where x<4 masters we used to store the end zero here. This was
+      a waste of one byte so we don't do it in x>=4 masters. We change code to
+      Q_CATALOG_NZ_CODE, because re-using the old code would make x<4 slaves
+      of this x>=4 master segfault (expecting a zero when there is
+      none). Remaining compatibility problems are: the older slave will not
+      find the catalog; but it is will not crash, and it's not an issue
+      that it does not find the catalog as catalogs were not used in these
+      older MySQL versions (we store it in binlog and read it from relay log
+      but do nothing useful with it). What is an issue is that the older slave
+      will stop processing the Q_* blocks (and jumps to the db/query) as soon
+      as it sees unknown Q_CATALOG_NZ_CODE; so it will not be able to read
+      Q_AUTO_INCREMENT*, Q_CHARSET and so replication will fail silently in
+      various ways. Documented that you should not mix alpha/beta versions if
+      they are not exactly the same version, with example of 5.0.3->5.0.2 and
+      5.0.4->5.0.3. If replication is from older to new, the new will
+      recognize Q_CATALOG_CODE and have no problem.
+    */
+  }
+  if (auto_increment_increment != 1 || auto_increment_offset != 1)
+  {
+    *start++= Q_AUTO_INCREMENT;
+    int2store(start, auto_increment_increment);
+    int2store(start+2, auto_increment_offset);
+    start+= 4;
+  }
+  if (charset_inited)
+  {
+    *start++= Q_CHARSET_CODE;
+    memcpy(start, charset, 6);
+    start+= 6;
+  }
+  if (time_zone_len)
+  {
+    /* In the TZ sys table, column Name is of length 64 so this should be ok */
+    DBUG_ASSERT(time_zone_len <= MAX_TIME_ZONE_NAME_LENGTH);
+    write_str_with_code_and_len(&start,
+                                time_zone_str, time_zone_len, Q_TIME_ZONE_CODE);
+  }
+  if (lc_time_names_number)
+  {
+    DBUG_ASSERT(lc_time_names_number <= 0xFFFF);
+    *start++= Q_LC_TIME_NAMES_CODE;
+    int2store(start, lc_time_names_number);
+    start+= 2;
+  }
+  if (charset_database_number)
+  {
+    DBUG_ASSERT(charset_database_number <= 0xFFFF);
+    *start++= Q_CHARSET_DATABASE_CODE;
+    int2store(start, charset_database_number);
+    start+= 2;
+  }
+  if (table_map_for_update)
+  {
+    *start++= Q_TABLE_MAP_FOR_UPDATE_CODE;
+    int8store(start, table_map_for_update);
+    start+= 8;
+  }
+  if (master_data_written != 0)
+  {
+    /*
+      Q_MASTER_DATA_WRITTEN_CODE only exists in relay logs where the master
+      has binlog_version<4 and the slave has binlog_version=4. See comment
+      for master_data_written in log_event.h for details.
+    */
+    *start++= Q_MASTER_DATA_WRITTEN_CODE;
+    int4store(start, master_data_written);
+    start+= 4;
+  }
+
+  if (thd && thd->need_binlog_invoker())
+  {
+    LEX_STRING user;
+    LEX_STRING host;
+    memset(&user, 0, sizeof(user));
+    memset(&host, 0, sizeof(host));
+
+    if (thd->slave_thread && thd->has_invoker())
+    {
+      /* user will be null, if master is older than this patch */
+      user= thd->get_invoker_user();
+      host= thd->get_invoker_host();
+    }
+    else if (thd->security_ctx->priv_user)
+    {
+      Security_context *ctx= thd->security_ctx;
+
+      user.length= strlen(ctx->priv_user);
+      user.str= ctx->priv_user;
+      if (ctx->priv_host[0] != '\0')
+      {
+        host.str= ctx->priv_host;
+        host.length= strlen(ctx->priv_host);
+      }
+    }
+
+    if (user.length > 0)
+    {
+      *start++= Q_INVOKER;
+
+      /*
+        Store user length and user. The max length of use is 16, so 1 byte is
+        enough to store the user's length.
+       */
+      *start++= (uchar)user.length;
+      memcpy(start, user.str, user.length);
+      start+= user.length;
+
+      /*
+        Store host length and host. The max length of host is 60, so 1 byte is
+        enough to store the host's length.
+       */
+      *start++= (uchar)host.length;
+      memcpy(start, host.str, host.length);
+      start+= host.length;
+    }
+  }
+  /*
+    NOTE: When adding new status vars, please don't forget to update
+    the MAX_SIZE_LOG_EVENT_STATUS in log_event.h and update the function
+    code_name() in this file.
+   
+    Here there could be code like
+    if (command-line-option-which-says-"log_this_variable" && inited)
+    {
+    *start++= Q_THIS_VARIABLE_CODE;
+    int4store(start, this_variable);
+    start+= 4;
+    }
+  */
+  
+  /* Store length of status variables */
+  status_vars_len= (uint) (start-start_of_status);
+  DBUG_ASSERT(status_vars_len <= MAX_SIZE_LOG_EVENT_STATUS);
+  int2store(buf + Q_STATUS_VARS_LEN_OFFSET, status_vars_len);
+
+  /*
+    Calculate length of whole event
+    The "1" below is the \0 in the db's length
+  */
+  event_length= (uint) (start-buf) + get_post_header_size_for_derived() + db_len + 1 + q_len;
+
+  return (write_header(file, event_length) ||
+          my_b_safe_write(file, (uchar*) buf, QUERY_HEADER_LEN) ||
+          write_post_header_for_derived(file) ||
+          my_b_safe_write(file, (uchar*) start_of_status,
+                          (uint) (start-start_of_status)) ||
+          my_b_safe_write(file, (db) ? (uchar*) db : (uchar*)"", db_len + 1) ||
+          my_b_safe_write(file, (uchar*) query, q_len)) ? 1 : 0;
+}
+
+/**
+  The simplest constructor that could possibly work.  This is used for
+  creating static objects that have a special meaning and are invisible
+  to the log.  
+*/
+Query_log_event::Query_log_event()
+  :Log_event(), data_buf(0)
+{
+  memset(&user, 0, sizeof(user));
+  memset(&host, 0, sizeof(host));
+}
+
+
+/*
+  SYNOPSIS
+    Query_log_event::Query_log_event()
+      thd_arg           - thread handle
+      query_arg         - array of char representing the query
+      query_length      - size of the  `query_arg' array
+      using_trans       - there is a modified transactional table
+      suppress_use      - suppress the generation of 'USE' statements
+      errcode           - the error code of the query
+      
+  DESCRIPTION
+  Creates an event for binlogging
+  The value for `errcode' should be supplied by caller.
+*/
+Query_log_event::Query_log_event(THD* thd_arg, const char* query_arg,
+				 ulong query_length, bool using_trans,
+				 bool direct, bool suppress_use, int errcode)
+
+  :Log_event(thd_arg,
+             (thd_arg->thread_specific_used ? LOG_EVENT_THREAD_SPECIFIC_F :
+              0) |
+             (suppress_use ? LOG_EVENT_SUPPRESS_USE_F : 0),
+	     using_trans),
+   data_buf(0), query(query_arg), catalog(thd_arg->catalog),
+   db(thd_arg->db), q_len((uint32) query_length),
+   thread_id(thd_arg->thread_id),
+   /* save the original thread id; we already know the server id */
+   slave_proxy_id(thd_arg->variables.pseudo_thread_id),
+   flags2_inited(1), sql_mode_inited(1), charset_inited(1),
+   sql_mode(thd_arg->variables.sql_mode),
+   auto_increment_increment(thd_arg->variables.auto_increment_increment),
+   auto_increment_offset(thd_arg->variables.auto_increment_offset),
+   lc_time_names_number(thd_arg->variables.lc_time_names->number),
+   charset_database_number(0),
+   table_map_for_update((ulonglong)thd_arg->table_map_for_update),
+   master_data_written(0)
+{
+  time_t end_time;
+
+  memset(&user, 0, sizeof(user));
+  memset(&host, 0, sizeof(host));
+
+  error_code= errcode;
+
+  time(&end_time);
+  exec_time = (ulong) (end_time  - thd_arg->start_time);
+  /**
+    @todo this means that if we have no catalog, then it is replicated
+    as an existing catalog of length zero. is that safe? /sven
+  */
+  catalog_len = (catalog) ? (uint32) strlen(catalog) : 0;
+  /* status_vars_len is set just before writing the event */
+  db_len = (db) ? (uint32) strlen(db) : 0;
+  if (thd_arg->variables.collation_database != thd_arg->db_charset)
+    charset_database_number= thd_arg->variables.collation_database->number;
+  
+  /*
+    We only replicate over the bits of flags2 that we need: the rest
+    are masked out by "& OPTIONS_WRITTEN_TO_BINLOG".
+
+    We also force AUTOCOMMIT=1.  Rationale (cf. BUG#29288): After
+    fixing BUG#26395, we always write BEGIN and COMMIT around all
+    transactions (even single statements in autocommit mode).  This is
+    so that replication from non-transactional to transactional table
+    and error recovery from XA to non-XA table should work as
+    expected.  The BEGIN/COMMIT are added in log.cc. However, there is
+    one exception: MyISAM bypasses log.cc and writes directly to the
+    binlog.  So if autocommit is off, master has MyISAM, and slave has
+    a transactional engine, then the slave will just see one long
+    never-ending transaction.  The only way to bypass explicit
+    BEGIN/COMMIT in the binlog is by using a non-transactional table.
+    So setting AUTOCOMMIT=1 will make this work as expected.
+
+    Note: explicitly replicate AUTOCOMMIT=1 from master. We do not
+    assume AUTOCOMMIT=1 on slave; the slave still reads the state of
+    the autocommit flag as written by the master to the binlog. This
+    behavior may change after WL#4162 has been implemented.
+  */
+  flags2= (uint32) (thd_arg->variables.option_bits &
+                    (OPTIONS_WRITTEN_TO_BIN_LOG & ~OPTION_NOT_AUTOCOMMIT));
+  DBUG_ASSERT(thd_arg->variables.character_set_client->number < 256*256);
+  DBUG_ASSERT(thd_arg->variables.collation_connection->number < 256*256);
+  DBUG_ASSERT(thd_arg->variables.collation_server->number < 256*256);
+  DBUG_ASSERT(thd_arg->variables.character_set_client->mbminlen == 1);
+  int2store(charset, thd_arg->variables.character_set_client->number);
+  int2store(charset+2, thd_arg->variables.collation_connection->number);
+  int2store(charset+4, thd_arg->variables.collation_server->number);
+  if (thd_arg->time_zone_used)
+  {
+    /*
+      Note that our event becomes dependent on the Time_zone object
+      representing the time zone. Fortunately such objects are never deleted
+      or changed during mysqld's lifetime.
+    */
+    time_zone_len= thd_arg->variables.time_zone->get_name()->length();
+    time_zone_str= thd_arg->variables.time_zone->get_name()->ptr();
+  }
+  else
+    time_zone_len= 0;
+
+  LEX *lex= thd->lex;
+  /*
+    Defines that the statement will be written directly to the binary log
+    without being wrapped by a BEGIN...COMMIT. Otherwise, the statement
+    will be written to either the trx-cache or stmt-cache.
+
+    Note that a cache will not be used if the parameter direct is TRUE.
+  */
+  bool use_cache= FALSE;
+  /*
+    TRUE defines that the trx-cache must be used and by consequence the
+    use_cache is TRUE.
+
+    Note that a cache will not be used if the parameter direct is TRUE.
+  */
+  bool trx_cache= FALSE;
+  cache_type= Log_event::EVENT_INVALID_CACHE;
+
+  switch (lex->sql_command)
+  {
+    case SQLCOM_DROP_TABLE:
+      use_cache= (lex->drop_temporary && thd->in_multi_stmt_transaction_mode());
+    break;
+
+    case SQLCOM_CREATE_TABLE:
+      trx_cache= (lex->select_lex.item_list.elements &&
+                  thd->is_current_stmt_binlog_format_row());
+      use_cache= ((lex->create_info.options & HA_LEX_CREATE_TMP_TABLE) &&
+                   thd->in_multi_stmt_transaction_mode()) || trx_cache;
+      break;
+    case SQLCOM_SET_OPTION:
+      use_cache= trx_cache= (lex->autocommit ? FALSE : TRUE);
+      break;
+    case SQLCOM_RELEASE_SAVEPOINT:
+    case SQLCOM_ROLLBACK_TO_SAVEPOINT:
+    case SQLCOM_SAVEPOINT:
+      use_cache= trx_cache= TRUE;
+      break;
+    default:
+      use_cache= sqlcom_can_generate_row_events(thd);
+      break;
+  }
+
+  if (!use_cache || direct)
+  {
+    cache_type= Log_event::EVENT_NO_CACHE;
+  }
+  else if (using_trans || trx_cache ||
+           stmt_has_updated_trans_table(thd->transaction.stmt.ha_list) ||
+           thd->lex->is_mixed_stmt_unsafe(thd->in_multi_stmt_transaction_mode(),
+                                          thd->variables.binlog_direct_non_trans_update,
+                                          trans_has_updated_trans_table(thd),
+                                          thd->tx_isolation))
+    cache_type= Log_event::EVENT_TRANSACTIONAL_CACHE;
+  else
+    cache_type= Log_event::EVENT_STMT_CACHE;
+  DBUG_ASSERT(cache_type != Log_event::EVENT_INVALID_CACHE);
+  DBUG_PRINT("info",("Query_log_event has flags2: %lu  sql_mode: %lu",
+                     (ulong) flags2, sql_mode));
+}
+#endif /* MYSQL_CLIENT */
+
+
+/* 2 utility functions for the next method */
+
+/**
+   Read a string with length from memory.
+
+   This function reads the string-with-length stored at
+   <code>src</code> and extract the length into <code>*len</code> and
+   a pointer to the start of the string into <code>*dst</code>. The
+   string can then be copied using <code>memcpy()</code> with the
+   number of bytes given in <code>*len</code>.
+
+   @param src Pointer to variable holding a pointer to the memory to
+              read the string from.
+   @param dst Pointer to variable holding a pointer where the actual
+              string starts. Starting from this position, the string
+              can be copied using @c memcpy().
+   @param len Pointer to variable where the length will be stored.
+   @param end One-past-the-end of the memory where the string is
+              stored.
+
+   @return    Zero if the entire string can be copied successfully,
+              @c UINT_MAX if the length could not be read from memory
+              (that is, if <code>*src >= end</code>), otherwise the
+              number of bytes that are missing to read the full
+              string, which happends <code>*dst + *len >= end</code>.
+*/
+static int
+get_str_len_and_pointer(const Log_event::Byte **src,
+                        const char **dst,
+                        uint *len,
+                        const Log_event::Byte *end)
+{
+  if (*src >= end)
+    return -1;       // Will be UINT_MAX in two-complement arithmetics
+  uint length= **src;
+  if (length > 0)
+  {
+    if (*src + length >= end)
+      return *src + length - end + 1;       // Number of bytes missing
+    *dst= (char *)*src + 1;                    // Will be copied later
+  }
+  *len= length;
+  *src+= length + 1;
+  return 0;
+}
+
+static void copy_str_and_move(const char **src, 
+                              Log_event::Byte **dst, 
+                              uint len)
+{
+  memcpy(*dst, *src, len);
+  *src= (const char *)*dst;
+  (*dst)+= len;
+  *(*dst)++= 0;
+}
+
+
+#ifndef DBUG_OFF
+static char const *
+code_name(int code)
+{
+  static char buf[255];
+  switch (code) {
+  case Q_FLAGS2_CODE: return "Q_FLAGS2_CODE";
+  case Q_SQL_MODE_CODE: return "Q_SQL_MODE_CODE";
+  case Q_CATALOG_CODE: return "Q_CATALOG_CODE";
+  case Q_AUTO_INCREMENT: return "Q_AUTO_INCREMENT";
+  case Q_CHARSET_CODE: return "Q_CHARSET_CODE";
+  case Q_TIME_ZONE_CODE: return "Q_TIME_ZONE_CODE";
+  case Q_CATALOG_NZ_CODE: return "Q_CATALOG_NZ_CODE";
+  case Q_LC_TIME_NAMES_CODE: return "Q_LC_TIME_NAMES_CODE";
+  case Q_CHARSET_DATABASE_CODE: return "Q_CHARSET_DATABASE_CODE";
+  case Q_TABLE_MAP_FOR_UPDATE_CODE: return "Q_TABLE_MAP_FOR_UPDATE_CODE";
+  case Q_MASTER_DATA_WRITTEN_CODE: return "Q_MASTER_DATA_WRITTEN_CODE";
+  }
+  sprintf(buf, "CODE#%d", code);
+  return buf;
+}
+#endif
+
+/**
+   Macro to check that there is enough space to read from memory.
+
+   @param PTR Pointer to memory
+   @param END End of memory
+   @param CNT Number of bytes that should be read.
+ */
+#define CHECK_SPACE(PTR,END,CNT)                      \
+  do {                                                \
+    DBUG_PRINT("info", ("Read %s", code_name(pos[-1]))); \
+    DBUG_ASSERT((PTR) + (CNT) <= (END));              \
+    if ((PTR) + (CNT) > (END)) {                      \
+      DBUG_PRINT("info", ("query= 0"));               \
+      query= 0;                                       \
+      DBUG_VOID_RETURN;                               \
+    }                                                 \
+  } while (0)
+
+
+/**
+  This is used by the SQL slave thread to prepare the event before execution.
+*/
+Query_log_event::Query_log_event(const char* buf, uint event_len,
+                                 const Format_description_log_event
+                                 *description_event,
+                                 Log_event_type event_type)
+  :Log_event(buf, description_event), data_buf(0), query(NullS),
+   db(NullS), catalog_len(0), status_vars_len(0),
+   flags2_inited(0), sql_mode_inited(0), charset_inited(0),
+   auto_increment_increment(1), auto_increment_offset(1),
+   time_zone_len(0), lc_time_names_number(0), charset_database_number(0),
+   table_map_for_update(0), master_data_written(0)
+{
+  ulong data_len;
+  uint32 tmp;
+  uint8 common_header_len, post_header_len;
+  Log_event::Byte *start;
+  const Log_event::Byte *end;
+  bool catalog_nz= 1;
+  DBUG_ENTER("Query_log_event::Query_log_event(char*,...)");
+
+  memset(&user, 0, sizeof(user));
+  memset(&host, 0, sizeof(host));
+  common_header_len= description_event->common_header_len;
+  post_header_len= description_event->post_header_len[event_type-1];
+  DBUG_PRINT("info",("event_len: %u  common_header_len: %d  post_header_len: %d",
+                     event_len, common_header_len, post_header_len));
+  
+  /*
+    We test if the event's length is sensible, and if so we compute data_len.
+    We cannot rely on QUERY_HEADER_LEN here as it would not be format-tolerant.
+    We use QUERY_HEADER_MINIMAL_LEN which is the same for 3.23, 4.0 & 5.0.
+  */
+  if (event_len < (uint)(common_header_len + post_header_len))
+    DBUG_VOID_RETURN;				
+  data_len = event_len - (common_header_len + post_header_len);
+  buf+= common_header_len;
+  
+  slave_proxy_id= thread_id = uint4korr(buf + Q_THREAD_ID_OFFSET);
+  exec_time = uint4korr(buf + Q_EXEC_TIME_OFFSET);
+  db_len = (uchar)buf[Q_DB_LEN_OFFSET]; // TODO: add a check of all *_len vars
+  error_code = uint2korr(buf + Q_ERR_CODE_OFFSET);
+
+  /*
+    5.0 format starts here.
+    Depending on the format, we may or not have affected/warnings etc
+    The remnent post-header to be parsed has length:
+  */
+  tmp= post_header_len - QUERY_HEADER_MINIMAL_LEN; 
+  if (tmp)
+  {
+    status_vars_len= uint2korr(buf + Q_STATUS_VARS_LEN_OFFSET);
+    /*
+      Check if status variable length is corrupt and will lead to very
+      wrong data. We could be even more strict and require data_len to
+      be even bigger, but this will suffice to catch most corruption
+      errors that can lead to a crash.
+    */
+    if (status_vars_len > min(data_len, MAX_SIZE_LOG_EVENT_STATUS))
+    {
+      DBUG_PRINT("info", ("status_vars_len (%u) > data_len (%lu); query= 0",
+                          status_vars_len, data_len));
+      query= 0;
+      DBUG_VOID_RETURN;
+    }
+    data_len-= status_vars_len;
+    DBUG_PRINT("info", ("Query_log_event has status_vars_len: %u",
+                        (uint) status_vars_len));
+    tmp-= 2;
+  } 
+  else
+  {
+    /*
+      server version < 5.0 / binlog_version < 4 master's event is 
+      relay-logged with storing the original size of the event in
+      Q_MASTER_DATA_WRITTEN_CODE status variable.
+      The size is to be restored at reading Q_MASTER_DATA_WRITTEN_CODE-marked
+      event from the relay log.
+    */
+    DBUG_ASSERT(description_event->binlog_version < 4);
+    master_data_written= data_written;
+  }
+  /*
+    We have parsed everything we know in the post header for QUERY_EVENT,
+    the rest of post header is either comes from older version MySQL or
+    dedicated to derived events (e.g. Execute_load_query...)
+  */
+
+  /* variable-part: the status vars; only in MySQL 5.0  */
+  
+  start= (Log_event::Byte*) (buf+post_header_len);
+  end= (const Log_event::Byte*) (start+status_vars_len);
+  for (const Log_event::Byte* pos= start; pos < end;)
+  {
+    switch (*pos++) {
+    case Q_FLAGS2_CODE:
+      CHECK_SPACE(pos, end, 4);
+      flags2_inited= 1;
+      flags2= uint4korr(pos);
+      DBUG_PRINT("info",("In Query_log_event, read flags2: %lu", (ulong) flags2));
+      pos+= 4;
+      break;
+    case Q_SQL_MODE_CODE:
+    {
+#ifndef DBUG_OFF
+      char buff[22];
+#endif
+      CHECK_SPACE(pos, end, 8);
+      sql_mode_inited= 1;
+      sql_mode= (ulong) uint8korr(pos); // QQ: Fix when sql_mode is ulonglong
+      DBUG_PRINT("info",("In Query_log_event, read sql_mode: %s",
+			 llstr(sql_mode, buff)));
+      pos+= 8;
+      break;
+    }
+    case Q_CATALOG_NZ_CODE:
+      DBUG_PRINT("info", ("case Q_CATALOG_NZ_CODE; pos: 0x%lx; end: 0x%lx",
+                          (ulong) pos, (ulong) end));
+      if (get_str_len_and_pointer(&pos, &catalog, &catalog_len, end))
+      {
+        DBUG_PRINT("info", ("query= 0"));
+        query= 0;
+        DBUG_VOID_RETURN;
+      }
+      break;
+    case Q_AUTO_INCREMENT:
+      CHECK_SPACE(pos, end, 4);
+      auto_increment_increment= uint2korr(pos);
+      auto_increment_offset=    uint2korr(pos+2);
+      pos+= 4;
+      break;
+    case Q_CHARSET_CODE:
+    {
+      CHECK_SPACE(pos, end, 6);
+      charset_inited= 1;
+      memcpy(charset, pos, 6);
+      pos+= 6;
+      break;
+    }
+    case Q_TIME_ZONE_CODE:
+    {
+      if (get_str_len_and_pointer(&pos, &time_zone_str, &time_zone_len, end))
+      {
+        DBUG_PRINT("info", ("Q_TIME_ZONE_CODE: query= 0"));
+        query= 0;
+        DBUG_VOID_RETURN;
+      }
+      break;
+    }
+    case Q_CATALOG_CODE: /* for 5.0.x where 0<=x<=3 masters */
+      CHECK_SPACE(pos, end, 1);
+      if ((catalog_len= *pos))
+        catalog= (char*) pos+1;                           // Will be copied later
+      CHECK_SPACE(pos, end, catalog_len + 2);
+      pos+= catalog_len+2; // leap over end 0
+      catalog_nz= 0; // catalog has end 0 in event
+      break;
+    case Q_LC_TIME_NAMES_CODE:
+      CHECK_SPACE(pos, end, 2);
+      lc_time_names_number= uint2korr(pos);
+      pos+= 2;
+      break;
+    case Q_CHARSET_DATABASE_CODE:
+      CHECK_SPACE(pos, end, 2);
+      charset_database_number= uint2korr(pos);
+      pos+= 2;
+      break;
+    case Q_TABLE_MAP_FOR_UPDATE_CODE:
+      CHECK_SPACE(pos, end, 8);
+      table_map_for_update= uint8korr(pos);
+      pos+= 8;
+      break;
+    case Q_MASTER_DATA_WRITTEN_CODE:
+      CHECK_SPACE(pos, end, 4);
+      data_written= master_data_written= uint4korr(pos);
+      pos+= 4;
+      break;
+    case Q_INVOKER:
+    {
+      CHECK_SPACE(pos, end, 1);
+      user.length= *pos++;
+      CHECK_SPACE(pos, end, user.length);
+      user.str= (char *)pos;
+      pos+= user.length;
+
+      CHECK_SPACE(pos, end, 1);
+      host.length= *pos++;
+      CHECK_SPACE(pos, end, host.length);
+      host.str= (char *)pos;
+      pos+= host.length;
+    }
+    default:
+      /* That's why you must write status vars in growing order of code */
+      DBUG_PRINT("info",("Query_log_event has unknown status vars (first has\
+ code: %u), skipping the rest of them", (uint) *(pos-1)));
+      pos= (const uchar*) end;                         // Break loop
+    }
+  }
+
+  /**
+    Layout for the data buffer is as follows
+    +--------+-----------+------+------+---------+----+-------+
+    | catlog | time_zone | user | host | db name | \0 | Query |
+    +--------+-----------+------+------+---------+----+-------+
+
+    To support the query cache we append the following buffer to the above
+    +-------+----------------------------------------+-------+
+    |db len | uninitiatlized space of size of db len | FLAGS |
+    +-------+----------------------------------------+-------+
+
+    The area of buffer starting from Query field all the way to the end belongs
+    to the Query buffer and its structure is described in alloc_query() in
+    sql_parse.cc
+    */
+
+#if !defined(MYSQL_CLIENT) && defined(HAVE_QUERY_CACHE)
+  if (!(start= data_buf = (Log_event::Byte*) my_malloc(catalog_len + 1
+                                                    +  time_zone_len + 1
+                                                    +  user.length + 1
+                                                    +  host.length + 1
+                                                    +  data_len + 1
+                                                    +  sizeof(size_t)//for db_len
+                                                    +  db_len + 1
+                                                    +  QUERY_CACHE_FLAGS_SIZE,
+                                                       MYF(MY_WME))))
+#else
+  if (!(start= data_buf = (Log_event::Byte*) my_malloc(catalog_len + 1
+                                                    +  time_zone_len + 1
+                                                    +  user.length + 1
+                                                    +  host.length + 1
+                                                    +  data_len + 1,
+                                                       MYF(MY_WME))))
+#endif
+      DBUG_VOID_RETURN;
+  if (catalog_len)                                  // If catalog is given
+  {
+    /**
+      @todo we should clean up and do only copy_str_and_move; it
+      works for both cases.  Then we can remove the catalog_nz
+      flag. /sven
+    */
+    if (likely(catalog_nz)) // true except if event comes from 5.0.0|1|2|3.
+      copy_str_and_move(&catalog, &start, catalog_len);
+    else
+    {
+      memcpy(start, catalog, catalog_len+1); // copy end 0
+      catalog= (const char *)start;
+      start+= catalog_len+1;
+    }
+  }
+  if (time_zone_len)
+    copy_str_and_move(&time_zone_str, &start, time_zone_len);
+
+  if (user.length > 0)
+    copy_str_and_move((const char **)&(user.str), &start, user.length);
+  if (host.length > 0)
+    copy_str_and_move((const char **)&(host.str), &start, host.length);
+
+  /**
+    if time_zone_len or catalog_len are 0, then time_zone and catalog
+    are uninitialized at this point.  shouldn't they point to the
+    zero-length null-terminated strings we allocated space for in the
+    my_alloc call above? /sven
+  */
+
+  /* A 2nd variable part; this is common to all versions */ 
+  memcpy((char*) start, end, data_len);          // Copy db and query
+  start[data_len]= '\0';              // End query with \0 (For safetly)
+  db= (char *)start;
+  query= (char *)(start + db_len + 1);
+  q_len= data_len - db_len -1;
+
+  if (data_len && (data_len < db_len ||
+                   data_len < q_len ||
+                   data_len != (db_len + q_len + 1)))
+  {
+    q_len= 0;
+    query= NULL;
+    DBUG_VOID_RETURN;
+  }
+
+  unsigned int max_length;
+  max_length= (event_len - ((const char*)(end + db_len + 1) -
+                            (buf - common_header_len)));
+  if (q_len != max_length)
+  {
+    q_len= 0;
+    query= NULL;
+    DBUG_VOID_RETURN;
+  }
+  /**
+    Append the db length at the end of the buffer. This will be used by
+    Query_cache::send_result_to_client() in case the query cache is On.
+   */
+#if !defined(MYSQL_CLIENT) && defined(HAVE_QUERY_CACHE)
+  size_t db_length= (size_t)db_len;
+  memcpy(start + data_len + 1, &db_length, sizeof(size_t));
+#endif
+  DBUG_VOID_RETURN;
+}
+
+
+#ifdef MYSQL_CLIENT
+/**
+  Query_log_event::print().
+
+  @todo
+    print the catalog ??
+*/
+void Query_log_event::print_query_header(IO_CACHE* file,
+					 PRINT_EVENT_INFO* print_event_info)
+{
+  // TODO: print the catalog ??
+  char buff[40],*end;				// Enough for SET TIMESTAMP
+  char quoted_id[1+ 2*FN_REFLEN+ 2];
+  int quoted_len= 0;
+  bool different_db= 1;
+  uint32 tmp;
+
+  if (!print_event_info->short_form)
+  {
+    print_header(file, print_event_info, FALSE);
+    my_b_printf(file, "\t%s\tthread_id=%lu\texec_time=%lu\terror_code=%d\n",
+                get_type_str(), (ulong) thread_id, (ulong) exec_time,
+                error_code);
+  }
+
+  if ((flags & LOG_EVENT_SUPPRESS_USE_F))
+  {
+    if (!is_trans_keyword())
+      print_event_info->db[0]= '\0';
+  }
+  else if (db)
+  {
+#ifdef MYSQL_SERVER
+    quoted_len= my_strmov_quoted_identifier(this->thd, (char*)quoted_id, db, 0);
+#else
+    quoted_len= my_strmov_quoted_identifier((char*)quoted_id, db);
+#endif
+    quoted_id[quoted_len]= '\0';
+    different_db= memcmp(print_event_info->db, db, db_len + 1);
+    if (different_db)
+      memcpy(print_event_info->db, db, db_len + 1);
+    if (db[0] && different_db) 
+      my_b_printf(file, "use %s%s\n", quoted_id, print_event_info->delimiter);
+  }
+
+  end=int10_to_str((long) when, strmov(buff,"SET TIMESTAMP="),10);
+  end= strmov(end, print_event_info->delimiter);
+  *end++='\n';
+  my_b_write(file, (uchar*) buff, (uint) (end-buff));
+  if ((!print_event_info->thread_id_printed ||
+       ((flags & LOG_EVENT_THREAD_SPECIFIC_F) &&
+        thread_id != print_event_info->thread_id)))
+  {
+    // If --short-form, print deterministic value instead of pseudo_thread_id.
+    my_b_printf(file,"SET @@session.pseudo_thread_id=%lu%s\n",
+                short_form ? 999999999 : (ulong)thread_id,
+                print_event_info->delimiter);
+    print_event_info->thread_id= thread_id;
+    print_event_info->thread_id_printed= 1;
+  }
+
+  /*
+    If flags2_inited==0, this is an event from 3.23 or 4.0; nothing to
+    print (remember we don't produce mixed relay logs so there cannot be
+    5.0 events before that one so there is nothing to reset).
+  */
+  if (likely(flags2_inited)) /* likely as this will mainly read 5.0 logs */
+  {
+    /* tmp is a bitmask of bits which have changed. */
+    if (likely(print_event_info->flags2_inited)) 
+      /* All bits which have changed */
+      tmp= (print_event_info->flags2) ^ flags2;
+    else /* that's the first Query event we read */
+    {
+      print_event_info->flags2_inited= 1;
+      tmp= ~((uint32)0); /* all bits have changed */
+    }
+
+    if (unlikely(tmp)) /* some bits have changed */
+    {
+      bool need_comma= 0;
+      my_b_printf(file, "SET ");
+      print_set_option(file, tmp, OPTION_NO_FOREIGN_KEY_CHECKS, ~flags2,
+                       "@@session.foreign_key_checks", &need_comma);
+      print_set_option(file, tmp, OPTION_AUTO_IS_NULL, flags2,
+                       "@@session.sql_auto_is_null", &need_comma);
+      print_set_option(file, tmp, OPTION_RELAXED_UNIQUE_CHECKS, ~flags2,
+                       "@@session.unique_checks", &need_comma);
+      print_set_option(file, tmp, OPTION_NOT_AUTOCOMMIT, ~flags2,
+                       "@@session.autocommit", &need_comma);
+      my_b_printf(file,"%s\n", print_event_info->delimiter);
+      print_event_info->flags2= flags2;
+    }
+  }
+
+  /*
+    Now the session variables;
+    it's more efficient to pass SQL_MODE as a number instead of a
+    comma-separated list.
+    FOREIGN_KEY_CHECKS, SQL_AUTO_IS_NULL, UNIQUE_CHECKS are session-only
+    variables (they have no global version; they're not listed in
+    sql_class.h), The tests below work for pure binlogs or pure relay
+    logs. Won't work for mixed relay logs but we don't create mixed
+    relay logs (that is, there is no relay log with a format change
+    except within the 3 first events, which mysqlbinlog handles
+    gracefully). So this code should always be good.
+  */
+
+  if (likely(sql_mode_inited) &&
+      (unlikely(print_event_info->sql_mode != sql_mode ||
+                !print_event_info->sql_mode_inited)))
+  {
+    my_b_printf(file,"SET @@session.sql_mode=%lu%s\n",
+                (ulong)sql_mode, print_event_info->delimiter);
+    print_event_info->sql_mode= sql_mode;
+    print_event_info->sql_mode_inited= 1;
+  }
+  if (print_event_info->auto_increment_increment != auto_increment_increment ||
+      print_event_info->auto_increment_offset != auto_increment_offset)
+  {
+    my_b_printf(file,"SET @@session.auto_increment_increment=%lu, @@session.auto_increment_offset=%lu%s\n",
+                auto_increment_increment,auto_increment_offset,
+                print_event_info->delimiter);
+    print_event_info->auto_increment_increment= auto_increment_increment;
+    print_event_info->auto_increment_offset=    auto_increment_offset;
+  }
+
+  /* TODO: print the catalog when we feature SET CATALOG */
+
+  if (likely(charset_inited) &&
+      (unlikely(!print_event_info->charset_inited ||
+                memcmp(print_event_info->charset, charset, 6))))
+  {
+    CHARSET_INFO *cs_info= get_charset(uint2korr(charset), MYF(MY_WME));
+    if (cs_info)
+    {
+      /* for mysql client */
+      my_b_printf(file, "/*!\\C %s */%s\n",
+                  cs_info->csname, print_event_info->delimiter);
+    }
+    my_b_printf(file,"SET "
+                "@@session.character_set_client=%d,"
+                "@@session.collation_connection=%d,"
+                "@@session.collation_server=%d"
+                "%s\n",
+                uint2korr(charset),
+                uint2korr(charset+2),
+                uint2korr(charset+4),
+                print_event_info->delimiter);
+    memcpy(print_event_info->charset, charset, 6);
+    print_event_info->charset_inited= 1;
+  }
+  if (time_zone_len)
+  {
+    if (memcmp(print_event_info->time_zone_str,
+               time_zone_str, time_zone_len+1))
+    {
+      my_b_printf(file,"SET @@session.time_zone='%s'%s\n",
+                  time_zone_str, print_event_info->delimiter);
+      memcpy(print_event_info->time_zone_str, time_zone_str, time_zone_len+1);
+    }
+  }
+  if (lc_time_names_number != print_event_info->lc_time_names_number)
+  {
+    my_b_printf(file, "SET @@session.lc_time_names=%d%s\n",
+                lc_time_names_number, print_event_info->delimiter);
+    print_event_info->lc_time_names_number= lc_time_names_number;
+  }
+  if (charset_database_number != print_event_info->charset_database_number)
+  {
+    if (charset_database_number)
+      my_b_printf(file, "SET @@session.collation_database=%d%s\n",
+                  charset_database_number, print_event_info->delimiter);
+    else
+      my_b_printf(file, "SET @@session.collation_database=DEFAULT%s\n",
+                  print_event_info->delimiter);
+    print_event_info->charset_database_number= charset_database_number;
+  }
+}
+
+
+void Query_log_event::print(FILE* file, PRINT_EVENT_INFO* print_event_info)
+{
+  Write_on_release_cache cache(&print_event_info->head_cache, file);
+
+  /**
+    reduce the size of io cache so that the write function is called
+    for every call to my_b_write().
+   */
+  DBUG_EXECUTE_IF ("simulate_file_write_error",
+                   {(&cache)->write_pos= (&cache)->write_end- 500;});
+  print_query_header(&cache, print_event_info);
+  my_b_write(&cache, (uchar*) query, q_len);
+  my_b_printf(&cache, "\n%s\n", print_event_info->delimiter);
+}
+#endif /* MYSQL_CLIENT */
+
+
+/*
+  Query_log_event::do_apply_event()
+*/
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+
+int Query_log_event::do_apply_event(Relay_log_info const *rli)
+{
+  return do_apply_event(rli, query, q_len);
+}
+
+
+/**
+  @todo
+  Compare the values of "affected rows" around here. Something
+  like:
+  @code
+     if ((uint32) affected_in_event != (uint32) affected_on_slave)
+     {
+     sql_print_error("Slave: did not get the expected number of affected \
+     rows running query from master - expected %d, got %d (this numbers \
+     should have matched modulo 4294967296).", 0, ...);
+     thd->query_error = 1;
+     }
+  @endcode
+  We may also want an option to tell the slave to ignore "affected"
+  mismatch. This mismatch could be implemented with a new ER_ code, and
+  to ignore it you would use --slave-skip-errors...
+*/
+int Query_log_event::do_apply_event(Relay_log_info const *rli,
+                                      const char *query_arg, uint32 q_len_arg)
+{
+  LEX_STRING new_db;
+  int expected_error,actual_error= 0;
+  HA_CREATE_INFO db_options;
+
+  /*
+    Colleagues: please never free(thd->catalog) in MySQL. This would
+    lead to bugs as here thd->catalog is a part of an alloced block,
+    not an entire alloced block (see
+    Query_log_event::do_apply_event()). Same for thd->db.  Thank
+    you.
+  */
+  thd->catalog= catalog_len ? (char *) catalog : (char *)"";
+
+  size_t valid_len;
+  bool len_error;
+  bool is_invalid_db_name= validate_string(system_charset_info, db, db_len,
+                                           &valid_len, &len_error);
+
+  DBUG_PRINT("debug",("is_invalid_db_name= %s, valid_len=%zu, len_error=%s",
+                      is_invalid_db_name ? "true" : "false",
+                      valid_len,
+                      len_error ? "true" : "false"));
+
+  if (is_invalid_db_name || len_error)
+  {
+    rli->report(ERROR_LEVEL, ER_SLAVE_FATAL_ERROR,
+                ER_THD(thd, ER_SLAVE_FATAL_ERROR),
+                "Invalid database name in Query event.");
+    thd->is_slave_error= true;
+    goto end;
+  }
+
+  new_db.length= db_len;
+  new_db.str= (char *) rpl_filter->get_rewrite_db(db, &new_db.length);
+  thd->set_db(new_db.str, new_db.length);       /* allocates a copy of 'db' */
+
+  /*
+    Setting the character set and collation of the current database thd->db.
+   */
+  load_db_opt_by_name(thd, thd->db, &db_options);
+  if (db_options.default_table_charset)
+    thd->db_charset= db_options.default_table_charset;
+  thd->variables.auto_increment_increment= auto_increment_increment;
+  thd->variables.auto_increment_offset=    auto_increment_offset;
+
+  /*
+    InnoDB internally stores the master log position it has executed so far,
+    i.e. the position just after the COMMIT event.
+    When InnoDB will want to store, the positions in rli won't have
+    been updated yet, so group_master_log_* will point to old BEGIN
+    and event_master_log* will point to the beginning of current COMMIT.
+    But log_pos of the COMMIT Query event is what we want, i.e. the pos of the
+    END of the current log event (COMMIT). We save it in rli so that InnoDB can
+    access it.
+  */
+  const_cast<Relay_log_info*>(rli)->future_group_master_log_pos= log_pos;
+  DBUG_PRINT("info", ("log_pos: %lu", (ulong) log_pos));
+
+  clear_all_errors(thd, const_cast<Relay_log_info*>(rli));
+  if (strcmp("COMMIT", query) == 0 && rli->tables_to_lock)
+  {
+    /*
+      Cleaning-up the last statement context:
+      the terminal event of the current statement flagged with
+      STMT_END_F got filtered out in ndb circular replication.
+    */
+    int error;
+    char llbuff[22];
+    if ((error= rows_event_stmt_cleanup(const_cast<Relay_log_info*>(rli), thd)))
+    {
+      const_cast<Relay_log_info*>(rli)->report(ERROR_LEVEL, error,
+                  "Error in cleaning up after an event preceeding the commit; "
+                  "the group log file/position: %s %s",
+                  const_cast<Relay_log_info*>(rli)->group_master_log_name,
+                  llstr(const_cast<Relay_log_info*>(rli)->group_master_log_pos,
+                        llbuff));
+    }
+    /*
+      Executing a part of rli->stmt_done() logics that does not deal
+      with group position change. The part is redundant now but is 
+      future-change-proof addon, e.g if COMMIT handling will start checking
+      invariants like IN_STMT flag must be off at committing the transaction.
+    */
+    const_cast<Relay_log_info*>(rli)->inc_event_relay_log_pos();
+    const_cast<Relay_log_info*>(rli)->clear_flag(Relay_log_info::IN_STMT);
+  }
+  else
+  {
+    const_cast<Relay_log_info*>(rli)->slave_close_thread_tables(thd);
+  }
+
+  /*
+    Note:   We do not need to execute reset_one_shot_variables() if this
+            db_ok() test fails.
+    Reason: The db stored in binlog events is the same for SET and for
+            its companion query.  If the SET is ignored because of
+            db_ok(), the companion query will also be ignored, and if
+            the companion query is ignored in the db_ok() test of
+            ::do_apply_event(), then the companion SET also have so
+            we don't need to reset_one_shot_variables().
+  */
+  if (is_trans_keyword() || rpl_filter->db_ok(thd->db))
+  {
+    thd->set_time((time_t)when);
+    thd->set_query_and_id((char*)query_arg, q_len_arg,
+                          thd->charset(), next_query_id());
+    thd->variables.pseudo_thread_id= thread_id;		// for temp tables
+    DBUG_PRINT("query",("%s", thd->query()));
+
+    if (ignored_error_code((expected_error= error_code)) ||
+	!unexpected_error_code(expected_error))
+    {
+      if (flags2_inited)
+        /*
+          all bits of thd->variables.option_bits which are 1 in OPTIONS_WRITTEN_TO_BIN_LOG
+          must take their value from flags2.
+        */
+        thd->variables.option_bits= flags2|(thd->variables.option_bits & ~OPTIONS_WRITTEN_TO_BIN_LOG);
+      /*
+        else, we are in a 3.23/4.0 binlog; we previously received a
+        Rotate_log_event which reset thd->variables.option_bits and sql_mode etc, so
+        nothing to do.
+      */
+      /*
+        We do not replicate IGNORE_DIR_IN_CREATE. That is, if the master is a
+        slave which runs with SQL_MODE=IGNORE_DIR_IN_CREATE, this should not
+        force us to ignore the dir too. Imagine you are a ring of machines, and
+        one has a disk problem so that you temporarily need
+        IGNORE_DIR_IN_CREATE on this machine; you don't want it to propagate
+        elsewhere (you don't want all slaves to start ignoring the dirs).
+      */
+      if (sql_mode_inited)
+        thd->variables.sql_mode=
+          (ulong) ((thd->variables.sql_mode & MODE_NO_DIR_IN_CREATE) |
+                   (sql_mode & ~(ulong) MODE_NO_DIR_IN_CREATE));
+      if (charset_inited)
+      {
+        if (rli->cached_charset_compare(charset))
+        {
+          /* Verify that we support the charsets found in the event. */
+          if (!(thd->variables.character_set_client=
+                get_charset(uint2korr(charset), MYF(MY_WME))) ||
+              !(thd->variables.collation_connection=
+                get_charset(uint2korr(charset+2), MYF(MY_WME))) ||
+              !(thd->variables.collation_server=
+                get_charset(uint2korr(charset+4), MYF(MY_WME))))
+          {
+            /*
+              We updated the thd->variables with nonsensical values (0). Let's
+              set them to something safe (i.e. which avoids crash), and we'll
+              stop with EE_UNKNOWN_CHARSET in compare_errors (unless set to
+              ignore this error).
+            */
+            set_slave_thread_default_charset(thd, rli);
+            goto compare_errors;
+          }
+          thd->update_charset(); // for the charset change to take effect
+          /*
+            Reset thd->query_string.cs to the newly set value.
+            Note, there is a small flaw here. For a very short time frame
+            if the new charset is different from the old charset and
+            if another thread executes "SHOW PROCESSLIST" after
+            the above thd->set_query_and_id() and before this thd->set_query(),
+            and if the current query has some non-ASCII characters,
+            the another thread may see some '?' marks in the PROCESSLIST
+            result. This should be acceptable now. This is a reminder
+            to fix this if any refactoring happens here sometime.
+          */
+          thd->set_query((char*) query_arg, q_len_arg, thd->charset());
+        }
+      }
+      if (time_zone_len)
+      {
+        String tmp(time_zone_str, time_zone_len, &my_charset_bin);
+        if (!(thd->variables.time_zone= my_tz_find(thd, &tmp)))
+        {
+          my_error(ER_UNKNOWN_TIME_ZONE, MYF(0), tmp.c_ptr());
+          thd->variables.time_zone= global_system_variables.time_zone;
+          goto compare_errors;
+        }
+      }
+      if (lc_time_names_number)
+      {
+        if (!(thd->variables.lc_time_names=
+              my_locale_by_number(lc_time_names_number)))
+        {
+          my_printf_error(ER_UNKNOWN_ERROR,
+                      "Unknown locale: '%d'", MYF(0), lc_time_names_number);
+          thd->variables.lc_time_names= &my_locale_en_US;
+          goto compare_errors;
+        }
+      }
+      else
+        thd->variables.lc_time_names= &my_locale_en_US;
+      if (charset_database_number)
+      {
+        CHARSET_INFO *cs;
+        if (!(cs= get_charset(charset_database_number, MYF(0))))
+        {
+          char buf[20];
+          int10_to_str((int) charset_database_number, buf, -10);
+          my_error(ER_UNKNOWN_COLLATION, MYF(0), buf);
+          goto compare_errors;
+        }
+        thd->variables.collation_database= cs;
+      }
+      else
+        thd->variables.collation_database= thd->db_charset;
+
+      {
+        const CHARSET_INFO *cs= thd->charset();
+        /*
+          We cannot ask for parsing a statement using a character set
+          without state_maps (parser internal data).
+        */
+        if (!cs->state_map)
+        {
+          rli->report(ERROR_LEVEL, ER_SLAVE_FATAL_ERROR,
+                      ER_THD(thd, ER_SLAVE_FATAL_ERROR),
+                      "character_set cannot be parsed");
+          thd->is_slave_error= true;
+          goto end;
+        }
+      }
+
+      thd->table_map_for_update= (table_map)table_map_for_update;
+      thd->set_invoker(&user, &host);
+      /*
+        Flag if we need to rollback the statement transaction on
+        slave if it by chance succeeds.
+        If we expected a non-zero error code and get nothing and,
+        it is a concurrency issue or ignorable issue, effects
+        of the statement should be rolled back.
+      */
+      if (expected_error &&
+          (ignored_error_code(expected_error) ||
+           concurrency_error_code(expected_error)))
+      {
+        thd->variables.option_bits|= OPTION_MASTER_SQL_ERROR;
+      }
+      /* Execute the query (note that we bypass dispatch_command()) */
+      Parser_state parser_state;
+      if (!parser_state.init(thd, thd->query(), thd->query_length()))
+      {
+        mysql_parse(thd, thd->query(), thd->query_length(), &parser_state);
+        /* Finalize server status flags after executing a statement. */
+        thd->update_server_status();
+        log_slow_statement(thd);
+      }
+
+      thd->variables.option_bits&= ~OPTION_MASTER_SQL_ERROR;
+
+      /*
+        Resetting the enable_slow_log thd variable.
+
+        We need to reset it back to the opt_log_slow_slave_statements
+        value after the statement execution (and slow logging
+        is done). It might have changed if the statement was an
+        admin statement (in which case, down in mysql_parse execution
+        thd->enable_slow_log is set to the value of
+        opt_log_slow_admin_statements).
+      */
+      thd->enable_slow_log= opt_log_slow_slave_statements;
+    }
+    else
+    {
+      /*
+        The query got a really bad error on the master (thread killed etc),
+        which could be inconsistent. Parse it to test the table names: if the
+        replicate-*-do|ignore-table rules say "this query must be ignored" then
+        we exit gracefully; otherwise we warn about the bad error and tell DBA
+        to check/fix it.
+      */
+      if (mysql_test_parse_for_slave(thd, thd->query(), thd->query_length()))
+        clear_all_errors(thd, const_cast<Relay_log_info*>(rli)); /* Can ignore query */
+      else
+      {
+        rli->report(ERROR_LEVEL, expected_error, 
+                          "\
+Query partially completed on the master (error on master: %d) \
+and was aborted. There is a chance that your master is inconsistent at this \
+point. If you are sure that your master is ok, run this query manually on the \
+slave and then restart the slave with SET GLOBAL SQL_SLAVE_SKIP_COUNTER=1; \
+START SLAVE; . Query: '%s'", expected_error, thd->query());
+        thd->is_slave_error= 1;
+      }
+      goto end;
+    }
+
+    /* If the query was not ignored, it is printed to the general log */
+    if (!thd->is_error() || thd->stmt_da->sql_errno() != ER_SLAVE_IGNORED_TABLE)
+      general_log_write(thd, COM_QUERY, thd->query(), thd->query_length());
+
+compare_errors:
+    /*
+      In the slave thread, we may sometimes execute some DROP / * 40005
+      TEMPORARY * / TABLE that come from parts of binlogs (likely if we
+      use RESET SLAVE or CHANGE MASTER TO), while the temporary table
+      has already been dropped. To ignore such irrelevant "table does
+      not exist errors", we silently clear the error if TEMPORARY was used.
+    */
+    if (thd->lex->sql_command == SQLCOM_DROP_TABLE && thd->lex->drop_temporary &&
+        thd->is_error() && thd->stmt_da->sql_errno() == ER_BAD_TABLE_ERROR &&
+        !expected_error)
+      thd->stmt_da->reset_diagnostics_area();
+    /*
+      If we expected a non-zero error code, and we don't get the same error
+      code, and it should be ignored or is related to a concurrency issue.
+    */
+    actual_error= thd->is_error() ? thd->stmt_da->sql_errno() : 0;
+    DBUG_PRINT("info",("expected_error: %d  sql_errno: %d",
+                       expected_error, actual_error));
+
+    if ((expected_error && expected_error != actual_error &&
+         !concurrency_error_code(expected_error)) &&
+        !ignored_error_code(actual_error) &&
+        !ignored_error_code(expected_error))
+    {
+      rli->report(ERROR_LEVEL, 0,
+                      "\
+Query caused different errors on master and slave.     \
+Error on master: message (format)='%s' error code=%d ; \
+Error on slave: actual message='%s', error code=%d. \
+Default database: '%s'. Query: '%s'",
+                      ER_SAFE(expected_error),
+                      expected_error,
+                      actual_error ? thd->stmt_da->message() : "no error",
+                      actual_error,
+                      print_slave_db_safe(db), query_arg);
+      thd->is_slave_error= 1;
+    }
+    /*
+      If we get the same error code as expected and it is not a concurrency
+      issue, or should be ignored.
+    */
+    else if ((expected_error == actual_error &&
+              !concurrency_error_code(expected_error)) ||
+             ignored_error_code(actual_error))
+    {
+      DBUG_PRINT("info",("error ignored"));
+      clear_all_errors(thd, const_cast<Relay_log_info*>(rli));
+      thd->killed= THD::NOT_KILLED;
+    }
+    /*
+      Other cases: mostly we expected no error and get one.
+    */
+    else if (thd->is_slave_error || thd->is_fatal_error)
+    {
+      rli->report(ERROR_LEVEL, actual_error,
+                      "Error '%s' on query. Default database: '%s'. Query: '%s'",
+                      (actual_error ? thd->stmt_da->message() :
+                       "unexpected success or fatal error"),
+                      print_slave_db_safe(thd->db), query_arg);
+      thd->is_slave_error= 1;
+    }
+
+    /*
+      TODO: compare the values of "affected rows" around here. Something
+      like:
+      if ((uint32) affected_in_event != (uint32) affected_on_slave)
+      {
+      sql_print_error("Slave: did not get the expected number of affected \
+      rows running query from master - expected %d, got %d (this numbers \
+      should have matched modulo 4294967296).", 0, ...);
+      thd->is_slave_error = 1;
+      }
+      We may also want an option to tell the slave to ignore "affected"
+      mismatch. This mismatch could be implemented with a new ER_ code, and
+      to ignore it you would use --slave-skip-errors...
+
+      To do the comparison we need to know the value of "affected" which the
+      above mysql_parse() computed. And we need to know the value of
+      "affected" in the master's binlog. Both will be implemented later. The
+      important thing is that we now have the format ready to log the values
+      of "affected" in the binlog. So we can release 5.0.0 before effectively
+      logging "affected" and effectively comparing it.
+    */
+  } /* End of if (db_ok(... */
+
+  {
+    /**
+      The following failure injecion works in cooperation with tests
+      setting @@global.debug= 'd,stop_slave_middle_group'.
+      The sql thread receives the killed status and will proceed
+      to shutdown trying to finish incomplete events group.
+    */
+    DBUG_EXECUTE_IF("stop_slave_middle_group",
+                    if (strcmp("COMMIT", query) != 0 &&
+                        strcmp("BEGIN", query) != 0)
+                    {
+                      if (thd->transaction.all.modified_non_trans_table)
+                        const_cast<Relay_log_info*>(rli)->abort_slave= 1;
+                    };);
+  }
+
+end:
+  /*
+    Probably we have set thd->query, thd->db, thd->catalog to point to places
+    in the data_buf of this event. Now the event is going to be deleted
+    probably, so data_buf will be freed, so the thd->... listed above will be
+    pointers to freed memory.
+    So we must set them to 0, so that those bad pointers values are not later
+    used. Note that "cleanup" queries like automatic DROP TEMPORARY TABLE
+    don't suffer from these assignments to 0 as DROP TEMPORARY
+    TABLE uses the db.table syntax.
+  */
+  thd->catalog= 0;
+  thd->set_db(NULL, 0);                 /* will free the current database */
+  thd->reset_query();
+  DBUG_PRINT("info", ("end: query= 0"));
+  /*
+    As a disk space optimization, future masters will not log an event for
+    LAST_INSERT_ID() if that function returned 0 (and thus they will be able
+    to replace the THD::stmt_depends_on_first_successful_insert_id_in_prev_stmt
+    variable by (THD->first_successful_insert_id_in_prev_stmt > 0) ; with the
+    resetting below we are ready to support that.
+  */
+  thd->first_successful_insert_id_in_prev_stmt_for_binlog= 0;
+  thd->first_successful_insert_id_in_prev_stmt= 0;
+  thd->stmt_depends_on_first_successful_insert_id_in_prev_stmt= 0;
+  free_root(thd->mem_root,MYF(MY_KEEP_PREALLOC));
+  return thd->is_slave_error;
+}
+
+int Query_log_event::do_update_pos(Relay_log_info *rli)
+{
+  /*
+    Note that we will not increment group* positions if we are just
+    after a SET ONE_SHOT, because SET ONE_SHOT should not be separated
+    from its following updating query.
+  */
+  if (thd->one_shot_set)
+  {
+    rli->inc_event_relay_log_pos();
+    return 0;
+  }
+  else
+    return Log_event::do_update_pos(rli);
+}
+
+
+Log_event::enum_skip_reason
+Query_log_event::do_shall_skip(Relay_log_info *rli)
+{
+  DBUG_ENTER("Query_log_event::do_shall_skip");
+  DBUG_PRINT("debug", ("query: %s; q_len: %d", query, q_len));
+  DBUG_ASSERT(query && q_len > 0);
+
+  if (rli->slave_skip_counter > 0)
+  {
+    if (strcmp("BEGIN", query) == 0)
+    {
+      thd->variables.option_bits|= OPTION_BEGIN;
+      DBUG_RETURN(Log_event::continue_group(rli));
+    }
+
+    if (strcmp("COMMIT", query) == 0 || strcmp("ROLLBACK", query) == 0)
+    {
+      thd->variables.option_bits&= ~OPTION_BEGIN;
+      DBUG_RETURN(Log_event::EVENT_SKIP_COUNT);
+    }
+  }
+  DBUG_RETURN(Log_event::do_shall_skip(rli));
+}
+
+#endif
+
+
+/**************************************************************************
+	Start_log_event_v3 methods
+**************************************************************************/
+
+#ifndef MYSQL_CLIENT
+Start_log_event_v3::Start_log_event_v3()
+  :Log_event(), created(0), binlog_version(BINLOG_VERSION),
+   dont_set_created(0)
+{
+  memcpy(server_version, ::server_version, ST_SERVER_VER_LEN);
+}
+#endif
+
+/*
+  Start_log_event_v3::pack_info()
+*/
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+void Start_log_event_v3::pack_info(Protocol *protocol)
+{
+  char buf[12 + ST_SERVER_VER_LEN + 14 + 22], *pos;
+  pos= strmov(buf, "Server ver: ");
+  pos= strmov(pos, server_version);
+  pos= strmov(pos, ", Binlog ver: ");
+  pos= int10_to_str(binlog_version, pos, 10);
+  protocol->store(buf, (uint) (pos-buf), &my_charset_bin);
+}
+#endif
+
+
+/*
+  Start_log_event_v3::print()
+*/
+
+#ifdef MYSQL_CLIENT
+void Start_log_event_v3::print(FILE* file, PRINT_EVENT_INFO* print_event_info)
+{
+  DBUG_ENTER("Start_log_event_v3::print");
+
+  Write_on_release_cache cache(&print_event_info->head_cache, file,
+                               Write_on_release_cache::FLUSH_F);
+
+  if (!print_event_info->short_form)
+  {
+    print_header(&cache, print_event_info, FALSE);
+    my_b_printf(&cache, "\tStart: binlog v %d, server v %s created ",
+                binlog_version, server_version);
+    print_timestamp(&cache);
+    if (created)
+      my_b_printf(&cache," at startup");
+    my_b_printf(&cache, "\n");
+    if (flags & LOG_EVENT_BINLOG_IN_USE_F)
+      my_b_printf(&cache, "# Warning: this binlog is either in use or was not "
+                  "closed properly.\n");
+  }
+  if (!is_artificial_event() && created)
+  {
+#ifdef WHEN_WE_HAVE_THE_RESET_CONNECTION_SQL_COMMAND
+    /*
+      This is for mysqlbinlog: like in replication, we want to delete the stale
+      tmp files left by an unclean shutdown of mysqld (temporary tables)
+      and rollback unfinished transaction.
+      Probably this can be done with RESET CONNECTION (syntax to be defined).
+    */
+    my_b_printf(&cache,"RESET CONNECTION%s\n", print_event_info->delimiter);
+#else
+    my_b_printf(&cache,"ROLLBACK%s\n", print_event_info->delimiter);
+#endif
+  }
+  if (temp_buf &&
+      print_event_info->base64_output_mode != BASE64_OUTPUT_NEVER &&
+      !print_event_info->short_form)
+  {
+    if (print_event_info->base64_output_mode != BASE64_OUTPUT_DECODE_ROWS)
+      my_b_printf(&cache, "BINLOG '\n");
+    print_base64(&cache, print_event_info, FALSE);
+    print_event_info->printed_fd_event= TRUE;
+  }
+  DBUG_VOID_RETURN;
+}
+#endif /* MYSQL_CLIENT */
+
+/*
+  Start_log_event_v3::Start_log_event_v3()
+*/
+
+Start_log_event_v3::Start_log_event_v3(const char* buf, uint event_len,
+                                       const Format_description_log_event
+                                       *description_event)
+  :Log_event(buf, description_event), binlog_version(BINLOG_VERSION)
+{
+  if (event_len < (uint)description_event->common_header_len +
+      ST_COMMON_HEADER_LEN_OFFSET)
+  {
+    server_version[0]= 0;
+    return;
+  }
+  buf+= description_event->common_header_len;
+  binlog_version= uint2korr(buf+ST_BINLOG_VER_OFFSET);
+  memcpy(server_version, buf+ST_SERVER_VER_OFFSET,
+	 ST_SERVER_VER_LEN);
+  // prevent overrun if log is corrupted on disk
+  server_version[ST_SERVER_VER_LEN-1]= 0;
+  created= uint4korr(buf+ST_CREATED_OFFSET);
+  dont_set_created= 1;
+}
+
+
+/*
+  Start_log_event_v3::write()
+*/
+
+#ifndef MYSQL_CLIENT
+bool Start_log_event_v3::write(IO_CACHE* file)
+{
+  char buff[START_V3_HEADER_LEN];
+  int2store(buff + ST_BINLOG_VER_OFFSET,binlog_version);
+  memcpy(buff + ST_SERVER_VER_OFFSET,server_version,ST_SERVER_VER_LEN);
+  if (!dont_set_created)
+    created= when= get_time();
+  int4store(buff + ST_CREATED_OFFSET,created);
+  return (write_header(file, sizeof(buff)) ||
+          my_b_safe_write(file, (uchar*) buff, sizeof(buff)));
+}
+#endif
+
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+
+/**
+  Start_log_event_v3::do_apply_event() .
+  The master started
+
+    IMPLEMENTATION
+    - To handle the case where the master died without having time to write
+    DROP TEMPORARY TABLE, DO RELEASE_LOCK (prepared statements' deletion is
+    TODO), we clean up all temporary tables that we got, if we are sure we
+    can (see below).
+
+  @todo
+    - Remove all active user locks.
+    Guilhem 2003-06: this is true but not urgent: the worst it can cause is
+    the use of a bit of memory for a user lock which will not be used
+    anymore. If the user lock is later used, the old one will be released. In
+    other words, no deadlock problem.
+*/
+
+int Start_log_event_v3::do_apply_event(Relay_log_info const *rli)
+{
+  DBUG_ENTER("Start_log_event_v3::do_apply_event");
+  int error= 0;
+  switch (binlog_version)
+  {
+  case 3:
+  case 4:
+    /*
+      This can either be 4.x (then a Start_log_event_v3 is only at master
+      startup so we are sure the master has restarted and cleared his temp
+      tables; the event always has 'created'>0) or 5.0 (then we have to test
+      'created').
+    */
+    if (created)
+    {
+      error= close_temporary_tables(thd);
+      cleanup_load_tmpdir();
+    }
+    else
+    {
+      /*
+        Set all temporary tables thread references to the current thread
+        as they may point to the "old" SQL slave thread in case of its
+        restart.
+      */
+      TABLE *table;
+      for (table= thd->temporary_tables; table; table= table->next)
+        table->in_use= thd;
+    }
+    break;
+
+    /*
+       Now the older formats; in that case load_tmpdir is cleaned up by the I/O
+       thread.
+    */
+  case 1:
+    if (strncmp(rli->relay_log.description_event_for_exec->server_version,
+                "3.23.57",7) >= 0 && created)
+    {
+      /*
+        Can distinguish, based on the value of 'created': this event was
+        generated at master startup.
+      */
+      error= close_temporary_tables(thd);
+    }
+    /*
+      Otherwise, can't distinguish a Start_log_event generated at
+      master startup and one generated by master FLUSH LOGS, so cannot
+      be sure temp tables have to be dropped. So do nothing.
+    */
+    break;
+  default:
+    /*
+      This case is not expected. It can be either an event corruption or an
+      unsupported binary log version.
+    */
+    rli->report(ERROR_LEVEL, ER_SLAVE_FATAL_ERROR,
+                ER_THD(thd, ER_SLAVE_FATAL_ERROR),
+                "Binlog version not supported");
+    DBUG_RETURN(1);
+  }
+  DBUG_RETURN(error);
+}
+#endif /* defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT) */
+
+/***************************************************************************
+       Format_description_log_event methods
+****************************************************************************/
+
+/**
+  Format_description_log_event 1st ctor.
+
+    Ctor. Can be used to create the event to write to the binary log (when the
+    server starts or when FLUSH LOGS), or to create artificial events to parse
+    binlogs from MySQL 3.23 or 4.x.
+    When in a client, only the 2nd use is possible.
+
+  @param binlog_version         the binlog version for which we want to build
+                                an event. Can be 1 (=MySQL 3.23), 3 (=4.0.x
+                                x>=2 and 4.1) or 4 (MySQL 5.0). Note that the
+                                old 4.0 (binlog version 2) is not supported;
+                                it should not be used for replication with
+                                5.0.
+*/
+
+Format_description_log_event::
+Format_description_log_event(uint8 binlog_ver, const char* server_ver)
+  :Start_log_event_v3(), event_type_permutation(0)
+{
+  binlog_version= binlog_ver;
+  switch (binlog_ver) {
+  case 4: /* MySQL 5.0 */
+    memcpy(server_version, ::server_version, ST_SERVER_VER_LEN);
+    DBUG_EXECUTE_IF("pretend_version_50034_in_binlog",
+                    strmov(server_version, "5.0.34"););
+    common_header_len= LOG_EVENT_HEADER_LEN;
+    number_of_event_types= LOG_EVENT_TYPES;
+    /* we'll catch my_malloc() error in is_valid() */
+    post_header_len=(uint8*) my_malloc(number_of_event_types*sizeof(uint8),
+                                       MYF(0));
+
+    /*
+      This long list of assignments is not beautiful, but I see no way to
+      make it nicer, as the right members are #defines, not array members, so
+      it's impossible to write a loop.
+    */
+    if (post_header_len)
+    {
+#ifndef DBUG_OFF
+      // Allows us to sanity-check that all events initialized their
+      // events (see the end of this 'if' block).
+      memset(post_header_len, 255, number_of_event_types*sizeof(uint8));
+#endif
+
+      /* Note: all event types must explicitly fill in their lengths here. */
+      post_header_len[START_EVENT_V3-1]= START_V3_HEADER_LEN;
+      post_header_len[QUERY_EVENT-1]= QUERY_HEADER_LEN;
+      post_header_len[STOP_EVENT-1]= STOP_HEADER_LEN;
+      post_header_len[ROTATE_EVENT-1]= ROTATE_HEADER_LEN;
+      post_header_len[INTVAR_EVENT-1]= INTVAR_HEADER_LEN;
+      post_header_len[LOAD_EVENT-1]= LOAD_HEADER_LEN;
+      post_header_len[SLAVE_EVENT-1]= SLAVE_HEADER_LEN;
+      post_header_len[CREATE_FILE_EVENT-1]= CREATE_FILE_HEADER_LEN;
+      post_header_len[APPEND_BLOCK_EVENT-1]= APPEND_BLOCK_HEADER_LEN;
+      post_header_len[EXEC_LOAD_EVENT-1]= EXEC_LOAD_HEADER_LEN;
+      post_header_len[DELETE_FILE_EVENT-1]= DELETE_FILE_HEADER_LEN;
+      post_header_len[NEW_LOAD_EVENT-1]= NEW_LOAD_HEADER_LEN;
+      post_header_len[RAND_EVENT-1]= RAND_HEADER_LEN;
+      post_header_len[USER_VAR_EVENT-1]= USER_VAR_HEADER_LEN;
+      post_header_len[FORMAT_DESCRIPTION_EVENT-1]= FORMAT_DESCRIPTION_HEADER_LEN;
+      post_header_len[XID_EVENT-1]= XID_HEADER_LEN;
+      post_header_len[BEGIN_LOAD_QUERY_EVENT-1]= BEGIN_LOAD_QUERY_HEADER_LEN;
+      post_header_len[EXECUTE_LOAD_QUERY_EVENT-1]= EXECUTE_LOAD_QUERY_HEADER_LEN;
+      /*
+        The PRE_GA events are never be written to any binlog, but
+        their lengths are included in Format_description_log_event.
+        Hence, we need to be assign some value here, to avoid reading
+        uninitialized memory when the array is written to disk.
+      */
+      post_header_len[PRE_GA_WRITE_ROWS_EVENT-1] = 0;
+      post_header_len[PRE_GA_UPDATE_ROWS_EVENT-1] = 0;
+      post_header_len[PRE_GA_DELETE_ROWS_EVENT-1] = 0;
+
+      post_header_len[TABLE_MAP_EVENT-1]=    TABLE_MAP_HEADER_LEN;
+      post_header_len[WRITE_ROWS_EVENT-1]=   ROWS_HEADER_LEN;
+      post_header_len[UPDATE_ROWS_EVENT-1]=  ROWS_HEADER_LEN;
+      post_header_len[DELETE_ROWS_EVENT-1]=  ROWS_HEADER_LEN;
+      /*
+        We here have the possibility to simulate a master of before we changed
+        the table map id to be stored in 6 bytes: when it was stored in 4
+        bytes (=> post_header_len was 6). This is used to test backward
+        compatibility.
+        This code can be removed after a few months (today is Dec 21st 2005),
+        when we know that the 4-byte masters are not deployed anymore (check
+        with Tomas Ulin first!), and the accompanying test (rpl_row_4_bytes)
+        too.
+      */
+      DBUG_EXECUTE_IF("old_row_based_repl_4_byte_map_id_master",
+                      post_header_len[TABLE_MAP_EVENT-1]=
+                      post_header_len[WRITE_ROWS_EVENT-1]=
+                      post_header_len[UPDATE_ROWS_EVENT-1]=
+                      post_header_len[DELETE_ROWS_EVENT-1]= 6;);
+      post_header_len[INCIDENT_EVENT-1]= INCIDENT_HEADER_LEN;
+      post_header_len[HEARTBEAT_LOG_EVENT-1]= 0;
+
+      // Sanity-check that all post header lengths are initialized.
+      int i;
+      for (i=0; i<number_of_event_types; i++)
+        DBUG_ASSERT(post_header_len[i] != 255);
+    }
+    break;
+
+  case 1: /* 3.23 */
+  case 3: /* 4.0.x x>=2 */
+    /*
+      We build an artificial (i.e. not sent by the master) event, which
+      describes what those old master versions send.
+    */
+    if (binlog_ver==1)
+      strmov(server_version, server_ver ? server_ver : "3.23");
+    else
+      strmov(server_version, server_ver ? server_ver : "4.0");
+    common_header_len= binlog_ver==1 ? OLD_HEADER_LEN :
+      LOG_EVENT_MINIMAL_HEADER_LEN;
+    /*
+      The first new event in binlog version 4 is Format_desc. So any event type
+      after that does not exist in older versions. We use the events known by
+      version 3, even if version 1 had only a subset of them (this is not a
+      problem: it uses a few bytes for nothing but unifies code; it does not
+      make the slave detect less corruptions).
+    */
+    number_of_event_types= FORMAT_DESCRIPTION_EVENT - 1;
+    post_header_len=(uint8*) my_malloc(number_of_event_types*sizeof(uint8),
+                                       MYF(0));
+    if (post_header_len)
+    {
+      post_header_len[START_EVENT_V3-1]= START_V3_HEADER_LEN;
+      post_header_len[QUERY_EVENT-1]= QUERY_HEADER_MINIMAL_LEN;
+      post_header_len[STOP_EVENT-1]= 0;
+      post_header_len[ROTATE_EVENT-1]= (binlog_ver==1) ? 0 : ROTATE_HEADER_LEN;
+      post_header_len[INTVAR_EVENT-1]= 0;
+      post_header_len[LOAD_EVENT-1]= LOAD_HEADER_LEN;
+      post_header_len[SLAVE_EVENT-1]= 0;
+      post_header_len[CREATE_FILE_EVENT-1]= CREATE_FILE_HEADER_LEN;
+      post_header_len[APPEND_BLOCK_EVENT-1]= APPEND_BLOCK_HEADER_LEN;
+      post_header_len[EXEC_LOAD_EVENT-1]= EXEC_LOAD_HEADER_LEN;
+      post_header_len[DELETE_FILE_EVENT-1]= DELETE_FILE_HEADER_LEN;
+      post_header_len[NEW_LOAD_EVENT-1]= post_header_len[LOAD_EVENT-1];
+      post_header_len[RAND_EVENT-1]= 0;
+      post_header_len[USER_VAR_EVENT-1]= 0;
+    }
+    break;
+  default: /* Includes binlog version 2 i.e. 4.0.x x<=1 */
+    post_header_len= 0; /* will make is_valid() fail */
+    break;
+  }
+  calc_server_version_split();
+}
+
+
+/**
+  The problem with this constructor is that the fixed header may have a
+  length different from this version, but we don't know this length as we
+  have not read the Format_description_log_event which says it, yet. This
+  length is in the post-header of the event, but we don't know where the
+  post-header starts.
+
+  So this type of event HAS to:
+  - either have the header's length at the beginning (in the header, at a
+  fixed position which will never be changed), not in the post-header. That
+  would make the header be "shifted" compared to other events.
+  - or have a header of size LOG_EVENT_MINIMAL_HEADER_LEN (19), in all future
+  versions, so that we know for sure.
+
+  I (Guilhem) chose the 2nd solution. Rotate has the same constraint (because
+  it is sent before Format_description_log_event).
+*/
+
+Format_description_log_event::
+Format_description_log_event(const char* buf,
+                             uint event_len,
+                             const
+                             Format_description_log_event*
+                             description_event)
+  :Start_log_event_v3(buf, event_len, description_event),
+   common_header_len(0), post_header_len(NULL), event_type_permutation(0)
+{
+  DBUG_ENTER("Format_description_log_event::Format_description_log_event(char*,...)");
+  if (!Start_log_event_v3::is_valid())
+    DBUG_VOID_RETURN; /* sanity check */
+  buf+= LOG_EVENT_MINIMAL_HEADER_LEN;
+  if ((common_header_len=buf[ST_COMMON_HEADER_LEN_OFFSET]) < OLD_HEADER_LEN)
+    DBUG_VOID_RETURN; /* sanity check */
+  number_of_event_types=
+    event_len-(LOG_EVENT_MINIMAL_HEADER_LEN+ST_COMMON_HEADER_LEN_OFFSET+1);
+  DBUG_PRINT("info", ("common_header_len=%d number_of_event_types=%d",
+                      common_header_len, number_of_event_types));
+  /* If alloc fails, we'll detect it in is_valid() */
+  post_header_len= (uint8*) my_memdup((uchar*)buf+ST_COMMON_HEADER_LEN_OFFSET+1,
+                                      number_of_event_types*
+                                      sizeof(*post_header_len), MYF(0));
+  calc_server_version_split();
+
+  /*
+    In some previous versions, the events were given other event type
+    id numbers than in the present version. When replicating from such
+    a version, we therefore set up an array that maps those id numbers
+    to the id numbers of the present server.
+
+    If post_header_len is null, it means malloc failed, and is_valid
+    will fail, so there is no need to do anything.
+
+    The trees in which events have wrong id's are:
+
+    mysql-5.1-wl1012.old mysql-5.1-wl2325-5.0-drop6p13-alpha
+    mysql-5.1-wl2325-5.0-drop6 mysql-5.1-wl2325-5.0
+    mysql-5.1-wl2325-no-dd
+
+    (this was found by grepping for two lines in sequence where the
+    first matches "FORMAT_DESCRIPTION_EVENT," and the second matches
+    "TABLE_MAP_EVENT," in log_event.h in all trees)
+
+    In these trees, the following server_versions existed since
+    TABLE_MAP_EVENT was introduced:
+
+    5.1.1-a_drop5p3   5.1.1-a_drop5p4        5.1.1-alpha
+    5.1.2-a_drop5p10  5.1.2-a_drop5p11       5.1.2-a_drop5p12
+    5.1.2-a_drop5p13  5.1.2-a_drop5p14       5.1.2-a_drop5p15
+    5.1.2-a_drop5p16  5.1.2-a_drop5p16b      5.1.2-a_drop5p16c
+    5.1.2-a_drop5p17  5.1.2-a_drop5p4        5.1.2-a_drop5p5
+    5.1.2-a_drop5p6   5.1.2-a_drop5p7        5.1.2-a_drop5p8
+    5.1.2-a_drop5p9   5.1.3-a_drop5p17       5.1.3-a_drop5p17b
+    5.1.3-a_drop5p17c 5.1.4-a_drop5p18       5.1.4-a_drop5p19
+    5.1.4-a_drop5p20  5.1.4-a_drop6p0        5.1.4-a_drop6p1
+    5.1.4-a_drop6p2   5.1.5-a_drop5p20       5.2.0-a_drop6p3
+    5.2.0-a_drop6p4   5.2.0-a_drop6p5        5.2.0-a_drop6p6
+    5.2.1-a_drop6p10  5.2.1-a_drop6p11       5.2.1-a_drop6p12
+    5.2.1-a_drop6p6   5.2.1-a_drop6p7        5.2.1-a_drop6p8
+    5.2.2-a_drop6p13  5.2.2-a_drop6p13-alpha 5.2.2-a_drop6p13b
+    5.2.2-a_drop6p13c
+
+    (this was found by grepping for "mysql," in all historical
+    versions of configure.in in the trees listed above).
+
+    There are 5.1.1-alpha versions that use the new event id's, so we
+    do not test that version string.  So replication from 5.1.1-alpha
+    with the other event id's to a new version does not work.
+    Moreover, we can safely ignore the part after drop[56].  This
+    allows us to simplify the big list above to the following regexes:
+
+    5\.1\.[1-5]-a_drop5.*
+    5\.1\.4-a_drop6.*
+    5\.2\.[0-2]-a_drop6.*
+
+    This is what we test for in the 'if' below.
+  */
+  if (post_header_len &&
+      server_version[0] == '5' && server_version[1] == '.' &&
+      server_version[3] == '.' &&
+      strncmp(server_version + 5, "-a_drop", 7) == 0 &&
+      ((server_version[2] == '1' &&
+        server_version[4] >= '1' && server_version[4] <= '5' &&
+        server_version[12] == '5') ||
+       (server_version[2] == '1' &&
+        server_version[4] == '4' &&
+        server_version[12] == '6') ||
+       (server_version[2] == '2' &&
+        server_version[4] >= '0' && server_version[4] <= '2' &&
+        server_version[12] == '6')))
+  {
+    if (number_of_event_types != 22)
+    {
+      DBUG_PRINT("info", (" number_of_event_types=%d",
+                          number_of_event_types));
+      /* this makes is_valid() return false. */
+      my_free(post_header_len);
+      post_header_len= NULL;
+      DBUG_VOID_RETURN;
+    }
+    static const uint8 perm[23]=
+      {
+        UNKNOWN_EVENT, START_EVENT_V3, QUERY_EVENT, STOP_EVENT, ROTATE_EVENT,
+        INTVAR_EVENT, LOAD_EVENT, SLAVE_EVENT, CREATE_FILE_EVENT,
+        APPEND_BLOCK_EVENT, EXEC_LOAD_EVENT, DELETE_FILE_EVENT,
+        NEW_LOAD_EVENT,
+        RAND_EVENT, USER_VAR_EVENT,
+        FORMAT_DESCRIPTION_EVENT,
+        TABLE_MAP_EVENT,
+        PRE_GA_WRITE_ROWS_EVENT,
+        PRE_GA_UPDATE_ROWS_EVENT,
+        PRE_GA_DELETE_ROWS_EVENT,
+        XID_EVENT,
+        BEGIN_LOAD_QUERY_EVENT,
+        EXECUTE_LOAD_QUERY_EVENT,
+      };
+    event_type_permutation= perm;
+    /*
+      Since we use (permuted) event id's to index the post_header_len
+      array, we need to permute the post_header_len array too.
+    */
+    uint8 post_header_len_temp[23];
+    for (int i= 1; i < 23; i++)
+      post_header_len_temp[perm[i] - 1]= post_header_len[i - 1];
+    for (int i= 0; i < 22; i++)
+      post_header_len[i] = post_header_len_temp[i];
+  }
+  DBUG_VOID_RETURN;
+}
+
+#ifndef MYSQL_CLIENT
+bool Format_description_log_event::write(IO_CACHE* file)
+{
+  /*
+    We don't call Start_log_event_v3::write() because this would make 2
+    my_b_safe_write().
+  */
+  uchar buff[FORMAT_DESCRIPTION_HEADER_LEN];
+  int2store(buff + ST_BINLOG_VER_OFFSET,binlog_version);
+  memcpy((char*) buff + ST_SERVER_VER_OFFSET,server_version,ST_SERVER_VER_LEN);
+  if (!dont_set_created)
+    created= when= get_time();
+  int4store(buff + ST_CREATED_OFFSET,created);
+  buff[ST_COMMON_HEADER_LEN_OFFSET]= LOG_EVENT_HEADER_LEN;
+  memcpy((char*) buff+ST_COMMON_HEADER_LEN_OFFSET+1, (uchar*) post_header_len,
+         LOG_EVENT_TYPES);
+  return (write_header(file, sizeof(buff)) ||
+          my_b_safe_write(file, buff, sizeof(buff)));
+}
+#endif
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+int Format_description_log_event::do_apply_event(Relay_log_info const *rli)
+{
+  int ret= 0;
+  DBUG_ENTER("Format_description_log_event::do_apply_event");
+
+  /*
+    As a transaction NEVER spans on 2 or more binlogs:
+    if we have an active transaction at this point, the master died
+    while writing the transaction to the binary log, i.e. while
+    flushing the binlog cache to the binlog. XA guarantees that master has
+    rolled back. So we roll back.
+    Note: this event could be sent by the master to inform us of the
+    format of its binlog; in other words maybe it is not at its
+    original place when it comes to us; we'll know this by checking
+    log_pos ("artificial" events have log_pos == 0).
+  */
+  if (!is_artificial_event() && created && thd->transaction.all.ha_list)
+  {
+    /* This is not an error (XA is safe), just an information */
+    rli->report(INFORMATION_LEVEL, 0,
+                "Rolling back unfinished transaction (no COMMIT "
+                "or ROLLBACK in relay log). A probable cause is that "
+                "the master died while writing the transaction to "
+                "its binary log, thus rolled back too."); 
+    const_cast<Relay_log_info*>(rli)->cleanup_context(thd, 1);
+  }
+
+  /*
+    If this event comes from ourselves, there is no cleaning task to
+    perform, we don't call Start_log_event_v3::do_apply_event()
+    (this was just to update the log's description event).
+  */
+  if (server_id != (uint32) ::server_id)
+  {
+    /*
+      If the event was not requested by the slave i.e. the master sent
+      it while the slave asked for a position >4, the event will make
+      rli->group_master_log_pos advance. Say that the slave asked for
+      position 1000, and the Format_desc event's end is 96. Then in
+      the beginning of replication rli->group_master_log_pos will be
+      0, then 96, then jump to first really asked event (which is
+      >96). So this is ok.
+    */
+    ret= Start_log_event_v3::do_apply_event(rli);
+  }
+
+  if (!ret)
+  {
+    /* Save the information describing this binlog */
+    delete rli->relay_log.description_event_for_exec;
+    const_cast<Relay_log_info *>(rli)->relay_log.description_event_for_exec= this;
+  }
+
+  DBUG_RETURN(ret);
+}
+
+int Format_description_log_event::do_update_pos(Relay_log_info *rli)
+{
+  if (server_id == (uint32) ::server_id)
+  {
+    /*
+      We only increase the relay log position if we are skipping
+      events and do not touch any group_* variables, nor flush the
+      relay log info.  If there is a crash, we will have to re-skip
+      the events again, but that is a minor issue.
+
+      If we do not skip stepping the group log position (and the
+      server id was changed when restarting the server), it might well
+      be that we start executing at a position that is invalid, e.g.,
+      at a Rows_log_event or a Query_log_event preceeded by a
+      Intvar_log_event instead of starting at a Table_map_log_event or
+      the Intvar_log_event respectively.
+     */
+    rli->inc_event_relay_log_pos();
+    return 0;
+  }
+  else
+  {
+    return Log_event::do_update_pos(rli);
+  }
+}
+
+Log_event::enum_skip_reason
+Format_description_log_event::do_shall_skip(Relay_log_info *rli)
+{
+  return Log_event::EVENT_SKIP_NOT;
+}
+
+#endif
+
+
+/**
+   Splits the event's 'server_version' string into three numeric pieces stored
+   into 'server_version_split':
+   X.Y.Zabc (X,Y,Z numbers, a not a digit) -> {X,Y,Z}
+   X.Yabc -> {X,Y,0}
+   'server_version_split' is then used for lookups to find if the server which
+   created this event has some known bug.
+*/
+void Format_description_log_event::calc_server_version_split()
+{
+  char *p= server_version, *r;
+  ulong number;
+  for (uint i= 0; i<=2; i++)
+  {
+    number= strtoul(p, &r, 10);
+    /*
+      It is an invalid version if any version number greater than 255 or
+      first number is not followed by '.'.
+    */
+    if (number < 256 && (*r == '.' || i != 0))
+      server_version_split[i]= (uchar)number;
+    else
+    {
+      server_version_split[0]= 0;
+      server_version_split[1]= 0;
+      server_version_split[2]= 0;
+      break;
+    }
+
+    p= r;
+    if (*r == '.')
+      p++; // skip the dot
+  }
+  DBUG_PRINT("info",("Format_description_log_event::server_version_split:"
+                     " '%s' %d %d %d", server_version,
+                     server_version_split[0],
+                     server_version_split[1], server_version_split[2]));
+}
+
+
+  /**************************************************************************
+        Load_log_event methods
+   General note about Load_log_event: the binlogging of LOAD DATA INFILE is
+   going to be changed in 5.0 (or maybe in 5.1; not decided yet).
+   However, the 5.0 slave could still have to read such events (from a 4.x
+   master), convert them (which just means maybe expand the header, when 5.0
+   servers have a UID in events) (remember that whatever is after the header
+   will be like in 4.x, as this event's format is not modified in 5.0 as we
+   will use new types of events to log the new LOAD DATA INFILE features).
+   To be able to read/convert, we just need to not assume that the common
+   header is of length LOG_EVENT_HEADER_LEN (we must use the description
+   event).
+   Note that I (Guilhem) manually tested replication of a big LOAD DATA INFILE
+   between 3.23 and 5.0, and between 4.0 and 5.0, and it works fine (and the
+   positions displayed in SHOW SLAVE STATUS then are fine too).
+  **************************************************************************/
+
+/*
+  Load_log_event::pack_info()
+*/
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+uint Load_log_event::get_query_buffer_length()
+{
+  return
+    //the DB name may double if we escape the quote character
+    5 + 2*db_len + 3 +
+    18 + fname_len*4 + 2 +                    // "LOAD DATA INFILE 'file''"
+    11 +                                    // "CONCURRENT "
+    7 +					    // LOCAL
+    9 +                                     // " REPLACE or IGNORE "
+    13 + table_name_len*2 +                 // "INTO TABLE `table`"
+    21 + sql_ex.field_term_len*4 + 2 +      // " FIELDS TERMINATED BY 'str'"
+    23 + sql_ex.enclosed_len*4 + 2 +        // " OPTIONALLY ENCLOSED BY 'str'"
+    12 + sql_ex.escaped_len*4 + 2 +         // " ESCAPED BY 'str'"
+    21 + sql_ex.line_term_len*4 + 2 +       // " LINES TERMINATED BY 'str'"
+    19 + sql_ex.line_start_len*4 + 2 +      // " LINES STARTING BY 'str'"
+    15 + 22 +                               // " IGNORE xxx  LINES"
+    3 + (num_fields-1)*2 + field_block_len; // " (field1, field2, ...)"
+}
+
+
+void Load_log_event::print_query(bool need_db, const char *cs, char *buf,
+                                 char **end, char **fn_start, char **fn_end)
+{
+  char quoted_id[1 + NAME_LEN * 2 + 2];//quoted  length
+  int  quoted_id_len= 0;
+  char *pos= buf;
+
+  if (need_db && db && db_len)
+  {
+    pos= strmov(pos, "use ");
+#ifdef MYSQL_SERVER
+    quoted_id_len= my_strmov_quoted_identifier(this->thd, (char *) quoted_id,
+                                               db, 0);
+#else
+    quoted_id_len= my_strmov_quoted_identifier((char *) quoted_id, db);
+#endif
+    quoted_id[quoted_id_len]= '\0';
+    pos= strmov(pos, quoted_id);
+    pos= strmov(pos, "; ");
+  }
+
+  pos= strmov(pos, "LOAD DATA ");
+
+  if (is_concurrent)
+    pos= strmov(pos, "CONCURRENT ");
+
+  if (fn_start)
+    *fn_start= pos;
+
+  if (check_fname_outside_temp_buf())
+    pos= strmov(pos, "LOCAL ");
+  pos= strmov(pos, "INFILE ");
+  pos= pretty_print_str(pos, fname, fname_len);
+  pos= strmov(pos, " ");
+
+  if (sql_ex.opt_flags & REPLACE_FLAG)
+    pos= strmov(pos, "REPLACE ");
+  else if (sql_ex.opt_flags & IGNORE_FLAG)
+    pos= strmov(pos, "IGNORE ");
+
+  pos= strmov(pos ,"INTO");
+
+  if (fn_end)
+    *fn_end= pos;
+
+  pos= strmov(pos ," TABLE ");
+  memcpy(pos, table_name, table_name_len);
+  pos+= table_name_len;
+
+  if (cs != NULL)
+  {
+    pos= strmov(pos ," CHARACTER SET ");
+    pos= strmov(pos ,  cs);
+  }
+
+  /* We have to create all optional fields as the default is not empty */
+  pos= strmov(pos, " FIELDS TERMINATED BY ");
+  pos= pretty_print_str(pos, sql_ex.field_term, sql_ex.field_term_len);
+  if (sql_ex.opt_flags & OPT_ENCLOSED_FLAG)
+    pos= strmov(pos, " OPTIONALLY ");
+  pos= strmov(pos, " ENCLOSED BY ");
+  pos= pretty_print_str(pos, sql_ex.enclosed, sql_ex.enclosed_len);
+
+  pos= strmov(pos, " ESCAPED BY ");
+  pos= pretty_print_str(pos, sql_ex.escaped, sql_ex.escaped_len);
+
+  pos= strmov(pos, " LINES TERMINATED BY ");
+  pos= pretty_print_str(pos, sql_ex.line_term, sql_ex.line_term_len);
+  if (sql_ex.line_start_len)
+  {
+    pos= strmov(pos, " STARTING BY ");
+    pos= pretty_print_str(pos, sql_ex.line_start, sql_ex.line_start_len);
+  }
+
+  if ((long) skip_lines > 0)
+  {
+    pos= strmov(pos, " IGNORE ");
+    pos= longlong10_to_str((longlong) skip_lines, pos, 10);
+    pos= strmov(pos," LINES ");    
+  }
+
+  if (num_fields)
+  {
+    uint i;
+    const char *field= fields;
+    pos= strmov(pos, " (");
+    for (i = 0; i < num_fields; i++)
+    {
+      if (i)
+      {
+        *pos++= ' ';
+        *pos++= ',';
+      }
+      quoted_id_len= my_strmov_quoted_identifier(this->thd, quoted_id, field,
+                                                 0);
+      memcpy(pos, quoted_id, quoted_id_len);
+    }
+    *pos++= ')';
+  }
+
+  *end= pos;
+}
+
+
+void Load_log_event::pack_info(Protocol *protocol)
+{
+  char *buf, *end;
+
+  if (!(buf= (char*) my_malloc(get_query_buffer_length(), MYF(MY_WME))))
+    return;
+  print_query(TRUE, NULL, buf, &end, 0, 0);
+  protocol->store(buf, end-buf, &my_charset_bin);
+  my_free(buf);
+}
+#endif /* defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT) */
+
+
+#ifndef MYSQL_CLIENT
+
+/*
+  Load_log_event::write_data_header()
+*/
+
+bool Load_log_event::write_data_header(IO_CACHE* file)
+{
+  char buf[LOAD_HEADER_LEN];
+  int4store(buf + L_THREAD_ID_OFFSET, slave_proxy_id);
+  int4store(buf + L_EXEC_TIME_OFFSET, exec_time);
+  int4store(buf + L_SKIP_LINES_OFFSET, skip_lines);
+  buf[L_TBL_LEN_OFFSET] = (char)table_name_len;
+  buf[L_DB_LEN_OFFSET] = (char)db_len;
+  int4store(buf + L_NUM_FIELDS_OFFSET, num_fields);
+  return my_b_safe_write(file, (uchar*)buf, LOAD_HEADER_LEN) != 0;
+}
+
+
+/*
+  Load_log_event::write_data_body()
+*/
+
+bool Load_log_event::write_data_body(IO_CACHE* file)
+{
+  if (sql_ex.write_data(file))
+    return 1;
+  if (num_fields && fields && field_lens)
+  {
+    if (my_b_safe_write(file, (uchar*)field_lens, num_fields) ||
+	my_b_safe_write(file, (uchar*)fields, field_block_len))
+      return 1;
+  }
+  return (my_b_safe_write(file, (uchar*)table_name, table_name_len + 1) ||
+	  my_b_safe_write(file, (uchar*)db, db_len + 1) ||
+	  my_b_safe_write(file, (uchar*)fname, fname_len));
+}
+
+
+/*
+  Load_log_event::Load_log_event()
+*/
+
+Load_log_event::Load_log_event(THD *thd_arg, sql_exchange *ex,
+			       const char *db_arg, const char *table_name_arg,
+			       List<Item> &fields_arg,
+                               bool is_concurrent_arg,
+			       enum enum_duplicates handle_dup,
+			       bool ignore, bool using_trans)
+  :Log_event(thd_arg,
+             thd_arg->thread_specific_used ? LOG_EVENT_THREAD_SPECIFIC_F : 0,
+             using_trans),
+   thread_id(thd_arg->thread_id),
+   slave_proxy_id(thd_arg->variables.pseudo_thread_id),
+   num_fields(0),fields(0),
+   field_lens(0),field_block_len(0),
+   table_name(table_name_arg ? table_name_arg : ""),
+   db(db_arg), fname(ex->file_name), local_fname(FALSE),
+   is_concurrent(is_concurrent_arg)
+{
+  time_t end_time;
+  time(&end_time);
+  exec_time = (ulong) (end_time  - thd_arg->start_time);
+  /* db can never be a zero pointer in 4.0 */
+  db_len = (uint32) strlen(db);
+  table_name_len = (uint32) strlen(table_name);
+  fname_len = (fname) ? (uint) strlen(fname) : 0;
+  sql_ex.field_term = (char*) ex->field_term->ptr();
+  sql_ex.field_term_len = (uint8) ex->field_term->length();
+  sql_ex.enclosed = (char*) ex->enclosed->ptr();
+  sql_ex.enclosed_len = (uint8) ex->enclosed->length();
+  sql_ex.line_term = (char*) ex->line_term->ptr();
+  sql_ex.line_term_len = (uint8) ex->line_term->length();
+  sql_ex.line_start = (char*) ex->line_start->ptr();
+  sql_ex.line_start_len = (uint8) ex->line_start->length();
+  sql_ex.escaped = (char*) ex->escaped->ptr();
+  sql_ex.escaped_len = (uint8) ex->escaped->length();
+  sql_ex.opt_flags = 0;
+  sql_ex.cached_new_format = -1;
+    
+  if (ex->dumpfile)
+    sql_ex.opt_flags|= DUMPFILE_FLAG;
+  if (ex->opt_enclosed)
+    sql_ex.opt_flags|= OPT_ENCLOSED_FLAG;
+
+  sql_ex.empty_flags= 0;
+
+  switch (handle_dup) {
+  case DUP_REPLACE:
+    sql_ex.opt_flags|= REPLACE_FLAG;
+    break;
+  case DUP_UPDATE:				// Impossible here
+  case DUP_ERROR:
+    break;	
+  }
+  if (ignore)
+    sql_ex.opt_flags|= IGNORE_FLAG;
+
+  if (!ex->field_term->length())
+    sql_ex.empty_flags |= FIELD_TERM_EMPTY;
+  if (!ex->enclosed->length())
+    sql_ex.empty_flags |= ENCLOSED_EMPTY;
+  if (!ex->line_term->length())
+    sql_ex.empty_flags |= LINE_TERM_EMPTY;
+  if (!ex->line_start->length())
+    sql_ex.empty_flags |= LINE_START_EMPTY;
+  if (!ex->escaped->length())
+    sql_ex.empty_flags |= ESCAPED_EMPTY;
+    
+  skip_lines = ex->skip_lines;
+
+  List_iterator<Item> li(fields_arg);
+  field_lens_buf.length(0);
+  fields_buf.length(0);
+  Item* item;
+  while ((item = li++))
+  {
+    num_fields++;
+    uchar len = (uchar) strlen(item->name);
+    field_block_len += len + 1;
+    fields_buf.append(item->name, len + 1);
+    field_lens_buf.append((char*)&len, 1);
+  }
+
+  field_lens = (const uchar*)field_lens_buf.ptr();
+  fields = fields_buf.ptr();
+}
+#endif /* !MYSQL_CLIENT */
+
+
+/**
+  @note
+    The caller must do buf[event_len] = 0 before he starts using the
+    constructed event.
+*/
+Load_log_event::Load_log_event(const char *buf, uint event_len,
+                               const Format_description_log_event *description_event)
+  :Log_event(buf, description_event), num_fields(0), fields(0),
+   field_lens(0),field_block_len(0),
+   table_name(0), db(0), fname(0), local_fname(FALSE),
+   /*
+     Load_log_event which comes from the binary log does not contain
+     information about the type of insert which was used on the master.
+     Assume that it was an ordinary, non-concurrent LOAD DATA.
+    */
+   is_concurrent(FALSE)
+{
+  DBUG_ENTER("Load_log_event");
+  /*
+    I (Guilhem) manually tested replication of LOAD DATA INFILE for 3.23->5.0,
+    4.0->5.0 and 5.0->5.0 and it works.
+  */
+  if (event_len)
+    copy_log_event(buf, event_len,
+                   ((buf[EVENT_TYPE_OFFSET] == LOAD_EVENT) ?
+                    LOAD_HEADER_LEN + 
+                    description_event->common_header_len :
+                    LOAD_HEADER_LEN + LOG_EVENT_HEADER_LEN),
+                   description_event);
+  /* otherwise it's a derived class, will call copy_log_event() itself */
+  DBUG_VOID_RETURN;
+}
+
+
+/*
+  Load_log_event::copy_log_event()
+*/
+
+int Load_log_event::copy_log_event(const char *buf, ulong event_len,
+                                   int body_offset,
+                                   const Format_description_log_event *description_event)
+{
+  DBUG_ENTER("Load_log_event::copy_log_event");
+  uint data_len;
+  char* buf_end = (char*)buf + event_len;
+  /* this is the beginning of the post-header */
+  const char* data_head = buf + description_event->common_header_len;
+  slave_proxy_id= thread_id= uint4korr(data_head + L_THREAD_ID_OFFSET);
+  exec_time = uint4korr(data_head + L_EXEC_TIME_OFFSET);
+  skip_lines = uint4korr(data_head + L_SKIP_LINES_OFFSET);
+  table_name_len = (uint)data_head[L_TBL_LEN_OFFSET];
+  db_len = (uint)data_head[L_DB_LEN_OFFSET];
+  num_fields = uint4korr(data_head + L_NUM_FIELDS_OFFSET);
+	  
+  if ((int) event_len < body_offset)
+    DBUG_RETURN(1);
+  /*
+    Sql_ex.init() on success returns the pointer to the first byte after
+    the sql_ex structure, which is the start of field lengths array.
+  */
+  if (!(field_lens= (uchar*)sql_ex.init((char*)buf + body_offset,
+                                        buf_end,
+                                        buf[EVENT_TYPE_OFFSET] != LOAD_EVENT)))
+    DBUG_RETURN(1);
+  
+  data_len = event_len - body_offset;
+  if (num_fields > data_len) // simple sanity check against corruption
+    DBUG_RETURN(1);
+  for (uint i = 0; i < num_fields; i++)
+    field_block_len += (uint)field_lens[i] + 1;
+
+  fields = (char*)field_lens + num_fields;
+  table_name  = fields + field_block_len;
+  if (strlen(table_name) > NAME_LEN)
+    goto err;
+
+  db = table_name + table_name_len + 1;
+  DBUG_EXECUTE_IF ("simulate_invalid_address",
+                   db_len = data_len;);
+  fname = db + db_len + 1;
+  if ((db_len > data_len) || (fname > buf_end))
+    goto err;
+  fname_len = (uint) strlen(fname);
+  if ((fname_len > data_len) || (fname + fname_len > buf_end))
+    goto err;
+  // null termination is accomplished by the caller doing buf[event_len]=0
+
+  DBUG_RETURN(0);
+
+err:
+  // Invalid event.
+  table_name = 0;
+  DBUG_RETURN(1);
+}
+
+
+/*
+  Load_log_event::print()
+*/
+
+#ifdef MYSQL_CLIENT
+void Load_log_event::print(FILE* file, PRINT_EVENT_INFO* print_event_info)
+{
+  print(file, print_event_info, 0);
+}
+
+
+void Load_log_event::print(FILE* file_arg, PRINT_EVENT_INFO* print_event_info,
+			   bool commented)
+{
+  size_t id_len= 0;
+  char temp_buf[1 + 2*FN_REFLEN + 2];
+  Write_on_release_cache cache(&print_event_info->head_cache, file_arg);
+
+  DBUG_ENTER("Load_log_event::print");
+  if (!print_event_info->short_form)
+  {
+    print_header(&cache, print_event_info, FALSE);
+    my_b_printf(&cache, "\tQuery\tthread_id=%ld\texec_time=%ld\n",
+                thread_id, exec_time);
+  }
+
+  bool different_db= 1;
+  if (db)
+  {
+    /*
+      If the database is different from the one of the previous statement, we
+      need to print the "use" command, and we update the last_db.
+      But if commented, the "use" is going to be commented so we should not
+      update the last_db.
+    */
+    if ((different_db= memcmp(print_event_info->db, db, db_len + 1)) &&
+        !commented)
+      memcpy(print_event_info->db, db, db_len + 1);
+  }
+  
+  if (db && db[0] && different_db)
+  {
+#ifdef MYSQL_SERVER
+    id_len= my_strmov_quoted_identifier(this->thd, temp_buf, db, 0);
+#else
+    id_len= my_strmov_quoted_identifier(temp_buf, db);
+#endif
+    temp_buf[id_len]= '\0';
+    my_b_printf(&cache, "%suse %s%s\n",
+            commented ? "# " : "", temp_buf, print_event_info->delimiter);
+  }
+  if (flags & LOG_EVENT_THREAD_SPECIFIC_F)
+    my_b_printf(&cache,"%sSET @@session.pseudo_thread_id=%lu%s\n",
+            commented ? "# " : "", (ulong)thread_id,
+            print_event_info->delimiter);
+  my_b_printf(&cache, "%sLOAD DATA ",
+              commented ? "# " : "");
+  if (check_fname_outside_temp_buf())
+    my_b_printf(&cache, "LOCAL ");
+  my_b_printf(&cache, "INFILE '%-*s' ", fname_len, fname);
+
+  if (sql_ex.opt_flags & REPLACE_FLAG)
+    my_b_printf(&cache,"REPLACE ");
+  else if (sql_ex.opt_flags & IGNORE_FLAG)
+    my_b_printf(&cache,"IGNORE ");
+
+#ifdef MYSQL_SERVER
+    id_len= my_strmov_quoted_identifier(this->thd, temp_buf, table_name, 0);
+#else
+    id_len= my_strmov_quoted_identifier(temp_buf, table_name);
+#endif
+  temp_buf[id_len]= '\0';
+  my_b_printf(&cache, "INTO TABLE %s", temp_buf);
+  my_b_printf(&cache, " FIELDS TERMINATED BY ");
+  pretty_print_str(&cache, sql_ex.field_term, sql_ex.field_term_len);
+
+  if (sql_ex.opt_flags & OPT_ENCLOSED_FLAG)
+    my_b_printf(&cache," OPTIONALLY ");
+  my_b_printf(&cache, " ENCLOSED BY ");
+  pretty_print_str(&cache, sql_ex.enclosed, sql_ex.enclosed_len);
+     
+  my_b_printf(&cache, " ESCAPED BY ");
+  pretty_print_str(&cache, sql_ex.escaped, sql_ex.escaped_len);
+     
+  my_b_printf(&cache," LINES TERMINATED BY ");
+  pretty_print_str(&cache, sql_ex.line_term, sql_ex.line_term_len);
+
+
+  if (sql_ex.line_start)
+  {
+    my_b_printf(&cache," STARTING BY ");
+    pretty_print_str(&cache, sql_ex.line_start, sql_ex.line_start_len);
+  }
+  if ((long) skip_lines > 0)
+    my_b_printf(&cache, " IGNORE %ld LINES", (long) skip_lines);
+
+  if (num_fields)
+  {
+    uint i;
+    const char* field = fields;
+    my_b_printf(&cache, " (");
+    for (i = 0; i < num_fields; i++)
+    {
+      if (i)
+        my_b_printf(&cache, ",");
+      id_len= my_strmov_quoted_identifier((char *) temp_buf, field);
+      temp_buf[id_len]= '\0';
+      my_b_printf(&cache, "%s", temp_buf);
+
+      field += field_lens[i]  + 1;
+    }
+    my_b_printf(&cache, ")");
+  }
+
+  my_b_printf(&cache, "%s\n", print_event_info->delimiter);
+  DBUG_VOID_RETURN;
+}
+#endif /* MYSQL_CLIENT */
+
+#ifndef MYSQL_CLIENT
+
+/**
+  Load_log_event::set_fields()
+
+  @note
+    This function can not use the member variable 
+    for the database, since LOAD DATA INFILE on the slave
+    can be for a different database than the current one.
+    This is the reason for the affected_db argument to this method.
+*/
+
+void Load_log_event::set_fields(const char* affected_db, 
+				List<Item> &field_list,
+                                Name_resolution_context *context)
+{
+  uint i;
+  const char* field = fields;
+  for (i= 0; i < num_fields; i++)
+  {
+    field_list.push_back(new Item_field(context,
+                                        affected_db, table_name, field));
+    field+= field_lens[i]  + 1;
+  }
+}
+#endif /* !MYSQL_CLIENT */
+
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+/**
+  Does the data loading job when executing a LOAD DATA on the slave.
+
+  @param net
+  @param rli
+  @param use_rli_only_for_errors     If set to 1, rli is provided to
+                                     Load_log_event::exec_event only for this
+                                     function to have RPL_LOG_NAME and
+                                     rli->last_slave_error, both being used by
+                                     error reports. rli's position advancing
+                                     is skipped (done by the caller which is
+                                     Execute_load_log_event::exec_event).
+                                     If set to 0, rli is provided for full use,
+                                     i.e. for error reports and position
+                                     advancing.
+
+  @todo
+    fix this; this can be done by testing rules in
+    Create_file_log_event::exec_event() and then discarding Append_block and
+    al.
+  @todo
+    this is a bug - this needs to be moved to the I/O thread
+
+  @retval
+    0           Success
+  @retval
+    1           Failure
+*/
+
+int Load_log_event::do_apply_event(NET* net, Relay_log_info const *rli,
+                                   bool use_rli_only_for_errors)
+{
+  LEX_STRING new_db;
+  new_db.length= db_len;
+  new_db.str= (char *) rpl_filter->get_rewrite_db(db, &new_db.length);
+  thd->set_db(new_db.str, new_db.length);
+  DBUG_ASSERT(thd->query() == 0);
+  thd->reset_query_inner();                    // Should not be needed
+  thd->is_slave_error= 0;
+  clear_all_errors(thd, const_cast<Relay_log_info*>(rli));
+
+  /* see Query_log_event::do_apply_event() and BUG#13360 */
+  DBUG_ASSERT(!rli->m_table_map.count());
+  /*
+    Usually lex_start() is called by mysql_parse(), but we need it here
+    as the present method does not call mysql_parse().
+  */
+  lex_start(thd);
+  thd->lex->local_file= local_fname;
+  mysql_reset_thd_for_next_command(thd);
+
+  if (!use_rli_only_for_errors)
+  {
+    /*
+      Saved for InnoDB, see comment in
+      Query_log_event::do_apply_event()
+    */
+    const_cast<Relay_log_info*>(rli)->future_group_master_log_pos= log_pos;
+    DBUG_PRINT("info", ("log_pos: %lu", (ulong) log_pos));
+  }
+ 
+   /*
+    We test replicate_*_db rules. Note that we have already prepared
+    the file to load, even if we are going to ignore and delete it
+    now. So it is possible that we did a lot of disk writes for
+    nothing. In other words, a big LOAD DATA INFILE on the master will
+    still consume a lot of space on the slave (space in the relay log
+    + space of temp files: twice the space of the file to load...)
+    even if it will finally be ignored.  TODO: fix this; this can be
+    done by testing rules in Create_file_log_event::do_apply_event()
+    and then discarding Append_block and al. Another way is do the
+    filtering in the I/O thread (more efficient: no disk writes at
+    all).
+
+
+    Note:   We do not need to execute reset_one_shot_variables() if this
+            db_ok() test fails.
+    Reason: The db stored in binlog events is the same for SET and for
+            its companion query.  If the SET is ignored because of
+            db_ok(), the companion query will also be ignored, and if
+            the companion query is ignored in the db_ok() test of
+            ::do_apply_event(), then the companion SET also have so
+            we don't need to reset_one_shot_variables().
+  */
+  if (rpl_filter->db_ok(thd->db))
+  {
+    thd->set_time((time_t)when);
+    thd->set_query_id(next_query_id());
+    thd->warning_info->opt_clear_warning_info(thd->query_id);
+
+    TABLE_LIST tables;
+    tables.init_one_table(thd->strmake(thd->db, thd->db_length),
+                          thd->db_length,
+                          table_name, strlen(table_name),
+                          table_name, TL_WRITE);
+    tables.updating= 1;
+
+    // the table will be opened in mysql_load    
+    if (rpl_filter->is_on() && !rpl_filter->tables_ok(thd->db, &tables))
+    {
+      // TODO: this is a bug - this needs to be moved to the I/O thread
+      if (net)
+        skip_load_data_infile(net);
+    }
+    else
+    {
+      char llbuff[22];
+      char *end;
+      enum enum_duplicates handle_dup;
+      bool ignore= 0;
+      char *load_data_query;
+
+      /*
+        Forge LOAD DATA INFILE query which will be used in SHOW PROCESS LIST
+        and written to slave's binlog if binlogging is on.
+      */
+      if (!(load_data_query= (char *)thd->alloc(get_query_buffer_length() + 1)))
+      {
+        /*
+          This will set thd->fatal_error in case of OOM. So we surely will notice
+          that something is wrong.
+        */
+        goto error;
+      }
+
+      print_query(FALSE, NULL, load_data_query, &end, NULL, NULL);
+      *end= 0;
+      thd->set_query(load_data_query, (uint) (end - load_data_query));
+
+      if (sql_ex.opt_flags & REPLACE_FLAG)
+        handle_dup= DUP_REPLACE;
+      else if (sql_ex.opt_flags & IGNORE_FLAG)
+      {
+        ignore= 1;
+        handle_dup= DUP_ERROR;
+      }
+      else
+      {
+        /*
+          When replication is running fine, if it was DUP_ERROR on the
+          master then we could choose IGNORE here, because if DUP_ERROR
+          suceeded on master, and data is identical on the master and slave,
+          then there should be no uniqueness errors on slave, so IGNORE is
+          the same as DUP_ERROR. But in the unlikely case of uniqueness errors
+          (because the data on the master and slave happen to be different
+          (user error or bug), we want LOAD DATA to print an error message on
+          the slave to discover the problem.
+
+          If reading from net (a 3.23 master), mysql_load() will change this
+          to IGNORE.
+        */
+        handle_dup= DUP_ERROR;
+      }
+      /*
+        We need to set thd->lex->sql_command and thd->lex->duplicates
+        since InnoDB tests these variables to decide if this is a LOAD
+        DATA ... REPLACE INTO ... statement even though mysql_parse()
+        is not called.  This is not needed in 5.0 since there the LOAD
+        DATA ... statement is replicated using mysql_parse(), which
+        sets the thd->lex fields correctly.
+      */
+      thd->lex->sql_command= SQLCOM_LOAD;
+      thd->lex->duplicates= handle_dup;
+
+      sql_exchange ex((char*)fname, sql_ex.opt_flags & DUMPFILE_FLAG);
+      String field_term(sql_ex.field_term,sql_ex.field_term_len,log_cs);
+      String enclosed(sql_ex.enclosed,sql_ex.enclosed_len,log_cs);
+      String line_term(sql_ex.line_term,sql_ex.line_term_len,log_cs);
+      String line_start(sql_ex.line_start,sql_ex.line_start_len,log_cs);
+      String escaped(sql_ex.escaped,sql_ex.escaped_len, log_cs);
+      ex.field_term= &field_term;
+      ex.enclosed= &enclosed;
+      ex.line_term= &line_term;
+      ex.line_start= &line_start;
+      ex.escaped= &escaped;
+
+      ex.opt_enclosed = (sql_ex.opt_flags & OPT_ENCLOSED_FLAG);
+      if (sql_ex.empty_flags & FIELD_TERM_EMPTY)
+        ex.field_term->length(0);
+
+      ex.skip_lines = skip_lines;
+      List<Item> field_list;
+      thd->lex->select_lex.context.resolve_in_table_list_only(&tables);
+      set_fields(tables.db, field_list, &thd->lex->select_lex.context);
+      thd->variables.pseudo_thread_id= thread_id;
+      if (net)
+      {
+        // mysql_load will use thd->net to read the file
+        thd->net.vio = net->vio;
+        // Make sure the client does not get confused about the packet sequence
+        thd->net.pkt_nr = net->pkt_nr;
+      }
+      /*
+        It is safe to use tmp_list twice because we are not going to
+        update it inside mysql_load().
+      */
+      List<Item> tmp_list;
+      if (mysql_load(thd, &ex, &tables, field_list, tmp_list, tmp_list,
+                     handle_dup, ignore, net != 0))
+        thd->is_slave_error= 1;
+      if (thd->cuted_fields)
+      {
+        /* log_pos is the position of the LOAD event in the master log */
+        sql_print_warning("Slave: load data infile on table '%s' at "
+                          "log position %s in log '%s' produced %ld "
+                          "warning(s). Default database: '%s'",
+                          (char*) table_name,
+                          llstr(log_pos,llbuff), RPL_LOG_NAME, 
+                          (ulong) thd->cuted_fields,
+                          print_slave_db_safe(thd->db));
+      }
+      if (net)
+        net->pkt_nr= thd->net.pkt_nr;
+    }
+  }
+  else
+  {
+    /*
+      We will just ask the master to send us /dev/null if we do not
+      want to load the data.
+      TODO: this a bug - needs to be done in I/O thread
+    */
+    if (net)
+      skip_load_data_infile(net);
+  }
+
+error:
+  thd->net.vio = 0; 
+  const char *remember_db= thd->db;
+  thd->catalog= 0;
+  thd->set_db(NULL, 0);                   /* will free the current database */
+  thd->reset_query();
+  thd->stmt_da->can_overwrite_status= TRUE;
+  thd->is_error() ? trans_rollback_stmt(thd) : trans_commit_stmt(thd);
+  thd->stmt_da->can_overwrite_status= FALSE;
+  close_thread_tables(thd);
+  /*
+    - If transaction rollback was requested due to deadlock
+      perform it and release metadata locks.
+    - If inside a multi-statement transaction,
+    defer the release of metadata locks until the current
+    transaction is either committed or rolled back. This prevents
+    other statements from modifying the table for the entire
+    duration of this transaction.  This provides commit ordering
+    and guarantees serializability across multiple transactions.
+    - If in autocommit mode, or outside a transactional context,
+    automatically release metadata locks of the current statement.
+  */
+  if (thd->transaction_rollback_request)
+  {
+    trans_rollback_implicit(thd);
+    thd->mdl_context.release_transactional_locks();
+  }
+  else if (! thd->in_multi_stmt_transaction_mode())
+    thd->mdl_context.release_transactional_locks();
+  else
+    thd->mdl_context.release_statement_locks();
+
+  DBUG_EXECUTE_IF("LOAD_DATA_INFILE_has_fatal_error",
+                  thd->is_slave_error= 0; thd->is_fatal_error= 1;);
+
+  if (thd->is_slave_error)
+  {
+    /* this err/sql_errno code is copy-paste from net_send_error() */
+    const char *err;
+    int sql_errno;
+    if (thd->is_error())
+    {
+      err= thd->stmt_da->message();
+      sql_errno= thd->stmt_da->sql_errno();
+    }
+    else
+    {
+      sql_errno=ER_UNKNOWN_ERROR;
+      err=ER(sql_errno);       
+    }
+    rli->report(ERROR_LEVEL, sql_errno,"\
+Error '%s' running LOAD DATA INFILE on table '%s'. Default database: '%s'",
+                    err, (char*)table_name, print_slave_db_safe(remember_db));
+    free_root(thd->mem_root,MYF(MY_KEEP_PREALLOC));
+    return 1;
+  }
+  free_root(thd->mem_root,MYF(MY_KEEP_PREALLOC));
+
+  if (thd->is_fatal_error)
+  {
+    char buf[256];
+    my_snprintf(buf, sizeof(buf),
+                "Running LOAD DATA INFILE on table '%-.64s'."
+                " Default database: '%-.64s'",
+                (char*)table_name,
+                print_slave_db_safe(remember_db));
+
+    rli->report(ERROR_LEVEL, ER_SLAVE_FATAL_ERROR,
+                ER(ER_SLAVE_FATAL_ERROR), buf);
+    return 1;
+  }
+
+  return ( use_rli_only_for_errors ? 0 : Log_event::do_apply_event(rli) ); 
+}
+#endif
+
+
+/**************************************************************************
+  Rotate_log_event methods
+**************************************************************************/
+
+/*
+  Rotate_log_event::pack_info()
+*/
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+void Rotate_log_event::pack_info(Protocol *protocol)
+{
+  char buf1[256], buf[22];
+  String tmp(buf1, sizeof(buf1), log_cs);
+  tmp.length(0);
+  tmp.append(new_log_ident, ident_len);
+  tmp.append(STRING_WITH_LEN(";pos="));
+  tmp.append(llstr(pos,buf));
+  protocol->store(tmp.ptr(), tmp.length(), &my_charset_bin);
+}
+#endif
+
+
+/*
+  Rotate_log_event::print()
+*/
+
+#ifdef MYSQL_CLIENT
+void Rotate_log_event::print(FILE* file, PRINT_EVENT_INFO* print_event_info)
+{
+  char buf[22];
+  Write_on_release_cache cache(&print_event_info->head_cache, file,
+                               Write_on_release_cache::FLUSH_F);
+
+  if (print_event_info->short_form)
+    return;
+  print_header(&cache, print_event_info, FALSE);
+  my_b_printf(&cache, "\tRotate to ");
+  if (new_log_ident)
+    my_b_write(&cache, (uchar*) new_log_ident, (uint)ident_len);
+  my_b_printf(&cache, "  pos: %s\n", llstr(pos, buf));
+}
+#endif /* MYSQL_CLIENT */
+
+
+
+/*
+  Rotate_log_event::Rotate_log_event() (2 constructors)
+*/
+
+
+#ifndef MYSQL_CLIENT
+Rotate_log_event::Rotate_log_event(const char* new_log_ident_arg,
+                                   uint ident_len_arg, ulonglong pos_arg,
+                                   uint flags_arg)
+  :Log_event(), new_log_ident(new_log_ident_arg),
+   pos(pos_arg),ident_len(ident_len_arg ? ident_len_arg :
+                          (uint) strlen(new_log_ident_arg)), flags(flags_arg)
+{
+#ifndef DBUG_OFF
+  char buff[22];
+  DBUG_ENTER("Rotate_log_event::Rotate_log_event(...,flags)");
+  DBUG_PRINT("enter",("new_log_ident: %s  pos: %s  flags: %lu", new_log_ident_arg,
+                      llstr(pos_arg, buff), (ulong) flags));
+#endif
+  if (flags & DUP_NAME)
+    new_log_ident= my_strndup(new_log_ident_arg, ident_len, MYF(MY_WME));
+  if (flags & RELAY_LOG)
+    set_relay_log_event();
+  DBUG_VOID_RETURN;
+}
+#endif
+
+
+Rotate_log_event::Rotate_log_event(const char* buf, uint event_len,
+                                   const Format_description_log_event* description_event)
+  :Log_event(buf, description_event) ,new_log_ident(0), flags(DUP_NAME)
+{
+  DBUG_ENTER("Rotate_log_event::Rotate_log_event(char*,...)");
+  // The caller will ensure that event_len is what we have at EVENT_LEN_OFFSET
+  uint8 header_size= description_event->common_header_len;
+  uint8 post_header_len= description_event->post_header_len[ROTATE_EVENT-1];
+  uint ident_offset;
+  if (event_len < header_size)
+    DBUG_VOID_RETURN;
+  buf += header_size;
+  pos = post_header_len ? uint8korr(buf + R_POS_OFFSET) : 4;
+  ident_len = (uint)(event_len -
+                     (header_size+post_header_len)); 
+  ident_offset = post_header_len; 
+  set_if_smaller(ident_len,FN_REFLEN-1);
+  new_log_ident= my_strndup(buf + ident_offset, (uint) ident_len, MYF(MY_WME));
+  DBUG_PRINT("debug", ("new_log_ident: '%s'", new_log_ident));
+  DBUG_VOID_RETURN;
+}
+
+
+/*
+  Rotate_log_event::write()
+*/
+
+#ifndef MYSQL_CLIENT
+bool Rotate_log_event::write(IO_CACHE* file)
+{
+  char buf[ROTATE_HEADER_LEN];
+  int8store(buf + R_POS_OFFSET, pos);
+  return (write_header(file, ROTATE_HEADER_LEN + ident_len) ||
+          my_b_safe_write(file, (uchar*)buf, ROTATE_HEADER_LEN) ||
+          my_b_safe_write(file, (uchar*)new_log_ident, (uint) ident_len));
+}
+#endif
+
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+
+/*
+  Got a rotate log event from the master.
+
+  This is mainly used so that we can later figure out the logname and
+  position for the master.
+
+  We can't rotate the slave's BINlog as this will cause infinitive rotations
+  in a A -> B -> A setup.
+  The NOTES below is a wrong comment which will disappear when 4.1 is merged.
+
+  @retval
+    0	ok
+*/
+int Rotate_log_event::do_update_pos(Relay_log_info *rli)
+{
+  DBUG_ENTER("Rotate_log_event::do_update_pos");
+#ifndef DBUG_OFF
+  char buf[32];
+#endif
+
+  DBUG_PRINT("info", ("server_id=%lu; ::server_id=%lu",
+                      (ulong) this->server_id, (ulong) ::server_id));
+  DBUG_PRINT("info", ("new_log_ident: %s", this->new_log_ident));
+  DBUG_PRINT("info", ("pos: %s", llstr(this->pos, buf)));
+
+  /*
+    If we are in a transaction or in a group: the only normal case is
+    when the I/O thread was copying a big transaction, then it was
+    stopped and restarted: we have this in the relay log:
+
+    BEGIN
+    ...
+    ROTATE (a fake one)
+    ...
+    COMMIT or ROLLBACK
+
+    In that case, we don't want to touch the coordinates which
+    correspond to the beginning of the transaction.  Starting from
+    5.0.0, there also are some rotates from the slave itself, in the
+    relay log, which shall not change the group positions.
+  */
+  if ((server_id != ::server_id || rli->replicate_same_server_id) &&
+      !is_relay_log_event() &&
+      !rli->is_in_group())
+  {
+    mysql_mutex_lock(&rli->data_lock);
+    DBUG_PRINT("info", ("old group_master_log_name: '%s'  "
+                        "old group_master_log_pos: %lu",
+                        rli->group_master_log_name,
+                        (ulong) rli->group_master_log_pos));
+    memcpy(rli->group_master_log_name, new_log_ident, ident_len+1);
+    rli->notify_group_master_log_name_update();
+    rli->inc_group_relay_log_pos(pos, TRUE /* skip_lock */);
+    DBUG_PRINT("info", ("new group_master_log_name: '%s'  "
+                        "new group_master_log_pos: %lu",
+                        rli->group_master_log_name,
+                        (ulong) rli->group_master_log_pos));
+    mysql_mutex_unlock(&rli->data_lock);
+    flush_relay_log_info(rli);
+    
+    /*
+      Reset thd->variables.option_bits and sql_mode etc, because this could be the signal of
+      a master's downgrade from 5.0 to 4.0.
+      However, no need to reset description_event_for_exec: indeed, if the next
+      master is 5.0 (even 5.0.1) we will soon get a Format_desc; if the next
+      master is 4.0 then the events are in the slave's format (conversion).
+    */
+    set_slave_thread_options(thd);
+    set_slave_thread_default_charset(thd, rli);
+    thd->variables.sql_mode= global_system_variables.sql_mode;
+    thd->variables.auto_increment_increment=
+      thd->variables.auto_increment_offset= 1;
+  }
+  else
+    rli->inc_event_relay_log_pos();
+
+
+  DBUG_RETURN(0);
+}
+
+
+Log_event::enum_skip_reason
+Rotate_log_event::do_shall_skip(Relay_log_info *rli)
+{
+  enum_skip_reason reason= Log_event::do_shall_skip(rli);
+
+  switch (reason) {
+  case Log_event::EVENT_SKIP_NOT:
+  case Log_event::EVENT_SKIP_COUNT:
+    return Log_event::EVENT_SKIP_NOT;
+
+  case Log_event::EVENT_SKIP_IGNORE:
+    return Log_event::EVENT_SKIP_IGNORE;
+  }
+  DBUG_ASSERT(0);
+  return Log_event::EVENT_SKIP_NOT;             // To keep compiler happy
+}
+
+#endif
+
+
+/**************************************************************************
+	Intvar_log_event methods
+**************************************************************************/
+
+/*
+  Intvar_log_event::pack_info()
+*/
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+void Intvar_log_event::pack_info(Protocol *protocol)
+{
+  char buf[256], *pos;
+  pos= strmake(buf, get_var_type_name(), sizeof(buf)-23);
+  *pos++= '=';
+  pos= longlong10_to_str(val, pos, -10);
+  protocol->store(buf, (uint) (pos-buf), &my_charset_bin);
+}
+#endif
+
+
+/*
+  Intvar_log_event::Intvar_log_event()
+*/
+
+Intvar_log_event::Intvar_log_event(const char* buf,
+                                   const Format_description_log_event* description_event)
+  :Log_event(buf, description_event)
+{
+  /* The Post-Header is empty. The Varible Data part begins immediately. */
+  buf+= description_event->common_header_len +
+    description_event->post_header_len[INTVAR_EVENT-1];
+  type= buf[I_TYPE_OFFSET];
+  val= uint8korr(buf+I_VAL_OFFSET);
+}
+
+
+/*
+  Intvar_log_event::get_var_type_name()
+*/
+
+const char* Intvar_log_event::get_var_type_name()
+{
+  switch(type) {
+  case LAST_INSERT_ID_EVENT: return "LAST_INSERT_ID";
+  case INSERT_ID_EVENT: return "INSERT_ID";
+  default: /* impossible */ return "UNKNOWN";
+  }
+}
+
+
+/*
+  Intvar_log_event::write()
+*/
+
+#ifndef MYSQL_CLIENT
+bool Intvar_log_event::write(IO_CACHE* file)
+{
+  uchar buf[9];
+  buf[I_TYPE_OFFSET]= (uchar) type;
+  int8store(buf + I_VAL_OFFSET, val);
+  return (write_header(file, sizeof(buf)) ||
+          my_b_safe_write(file, buf, sizeof(buf)));
+}
+#endif
+
+
+/*
+  Intvar_log_event::print()
+*/
+
+#ifdef MYSQL_CLIENT
+void Intvar_log_event::print(FILE* file, PRINT_EVENT_INFO* print_event_info)
+{
+  char llbuff[22];
+  const char *msg;
+  LINT_INIT(msg);
+  Write_on_release_cache cache(&print_event_info->head_cache, file,
+                               Write_on_release_cache::FLUSH_F);
+
+  if (!print_event_info->short_form)
+  {
+    print_header(&cache, print_event_info, FALSE);
+    my_b_printf(&cache, "\tIntvar\n");
+  }
+
+  my_b_printf(&cache, "SET ");
+  switch (type) {
+  case LAST_INSERT_ID_EVENT:
+    msg="LAST_INSERT_ID";
+    break;
+  case INSERT_ID_EVENT:
+    msg="INSERT_ID";
+    break;
+  case INVALID_INT_EVENT:
+  default: // cannot happen
+    msg="INVALID_INT";
+    break;
+  }
+  my_b_printf(&cache, "%s=%s%s\n",
+              msg, llstr(val,llbuff), print_event_info->delimiter);
+}
+#endif
+
+
+#if defined(HAVE_REPLICATION)&& !defined(MYSQL_CLIENT)
+
+/*
+  Intvar_log_event::do_apply_event()
+*/
+
+int Intvar_log_event::do_apply_event(Relay_log_info const *rli)
+{
+  /*
+    We are now in a statement until the associated query log event has
+    been processed.
+   */
+  const_cast<Relay_log_info*>(rli)->set_flag(Relay_log_info::IN_STMT);
+
+  if (rli->deferred_events_collecting)
+    return rli->deferred_events->add(this);
+
+  switch (type) {
+  case LAST_INSERT_ID_EVENT:
+    thd->first_successful_insert_id_in_prev_stmt= val;
+    break;
+  case INSERT_ID_EVENT:
+    thd->force_one_auto_inc_interval(val);
+    break;
+  }
+  return 0;
+}
+
+int Intvar_log_event::do_update_pos(Relay_log_info *rli)
+{
+  rli->inc_event_relay_log_pos();
+  return 0;
+}
+
+
+Log_event::enum_skip_reason
+Intvar_log_event::do_shall_skip(Relay_log_info *rli)
+{
+  /*
+    It is a common error to set the slave skip counter to 1 instead of
+    2 when recovering from an insert which used a auto increment,
+    rand, or user var.  Therefore, if the slave skip counter is 1, we
+    just say that this event should be skipped by ignoring it, meaning
+    that we do not change the value of the slave skip counter since it
+    will be decreased by the following insert event.
+  */
+  return continue_group(rli);
+}
+
+#endif
+
+
+/**************************************************************************
+  Rand_log_event methods
+**************************************************************************/
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+void Rand_log_event::pack_info(Protocol *protocol)
+{
+  char buf1[256], *pos;
+  pos= strmov(buf1,"rand_seed1=");
+  pos= int10_to_str((long) seed1, pos, 10);
+  pos= strmov(pos, ",rand_seed2=");
+  pos= int10_to_str((long) seed2, pos, 10);
+  protocol->store(buf1, (uint) (pos-buf1), &my_charset_bin);
+}
+#endif
+
+
+Rand_log_event::Rand_log_event(const char* buf,
+                               const Format_description_log_event* description_event)
+  :Log_event(buf, description_event)
+{
+  /* The Post-Header is empty. The Variable Data part begins immediately. */
+  buf+= description_event->common_header_len +
+    description_event->post_header_len[RAND_EVENT-1];
+  seed1= uint8korr(buf+RAND_SEED1_OFFSET);
+  seed2= uint8korr(buf+RAND_SEED2_OFFSET);
+}
+
+
+#ifndef MYSQL_CLIENT
+bool Rand_log_event::write(IO_CACHE* file)
+{
+  uchar buf[16];
+  int8store(buf + RAND_SEED1_OFFSET, seed1);
+  int8store(buf + RAND_SEED2_OFFSET, seed2);
+  return (write_header(file, sizeof(buf)) ||
+          my_b_safe_write(file, buf, sizeof(buf)));
+}
+#endif
+
+
+#ifdef MYSQL_CLIENT
+void Rand_log_event::print(FILE* file, PRINT_EVENT_INFO* print_event_info)
+{
+  Write_on_release_cache cache(&print_event_info->head_cache, file,
+                               Write_on_release_cache::FLUSH_F);
+
+  char llbuff[22],llbuff2[22];
+  if (!print_event_info->short_form)
+  {
+    print_header(&cache, print_event_info, FALSE);
+    my_b_printf(&cache, "\tRand\n");
+  }
+  my_b_printf(&cache, "SET @@RAND_SEED1=%s, @@RAND_SEED2=%s%s\n",
+              llstr(seed1, llbuff),llstr(seed2, llbuff2),
+              print_event_info->delimiter);
+}
+#endif /* MYSQL_CLIENT */
+
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+int Rand_log_event::do_apply_event(Relay_log_info const *rli)
+{
+  /*
+    We are now in a statement until the associated query log event has
+    been processed.
+   */
+  const_cast<Relay_log_info*>(rli)->set_flag(Relay_log_info::IN_STMT);
+
+  if (rli->deferred_events_collecting)
+    return rli->deferred_events->add(this);
+
+  thd->rand.seed1= (ulong) seed1;
+  thd->rand.seed2= (ulong) seed2;
+  return 0;
+}
+
+int Rand_log_event::do_update_pos(Relay_log_info *rli)
+{
+  rli->inc_event_relay_log_pos();
+  return 0;
+}
+
+
+Log_event::enum_skip_reason
+Rand_log_event::do_shall_skip(Relay_log_info *rli)
+{
+  /*
+    It is a common error to set the slave skip counter to 1 instead of
+    2 when recovering from an insert which used a auto increment,
+    rand, or user var.  Therefore, if the slave skip counter is 1, we
+    just say that this event should be skipped by ignoring it, meaning
+    that we do not change the value of the slave skip counter since it
+    will be decreased by the following insert event.
+  */
+  return continue_group(rli);
+}
+
+/**
+   Exec deferred Int-, Rand- and User- var events prefixing
+   a Query-log-event event.
+
+   @param thd THD handle
+
+   @return false on success, true if a failure in an event applying occurred.
+*/
+bool slave_execute_deferred_events(THD *thd)
+{
+  bool res= false;
+  Relay_log_info *rli= thd->rli_slave;
+
+  DBUG_ASSERT(rli && (!rli->deferred_events_collecting || rli->deferred_events));
+
+  if (!rli->deferred_events_collecting || rli->deferred_events->is_empty())
+    return res;
+
+  res= rli->deferred_events->execute(rli);
+
+  return res;
+}
+
+#endif /* !MYSQL_CLIENT */
+
+
+/**************************************************************************
+  Xid_log_event methods
+**************************************************************************/
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+void Xid_log_event::pack_info(Protocol *protocol)
+{
+  char buf[128], *pos;
+  pos= strmov(buf, "COMMIT /* xid=");
+  pos= longlong10_to_str(xid, pos, 10);
+  pos= strmov(pos, " */");
+  protocol->store(buf, (uint) (pos-buf), &my_charset_bin);
+}
+#endif
+
+/**
+  @note
+  It's ok not to use int8store here,
+  as long as xid_t::set(ulonglong) and
+  xid_t::get_my_xid doesn't do it either.
+  We don't care about actual values of xids as long as
+  identical numbers compare identically
+*/
+
+Xid_log_event::
+Xid_log_event(const char* buf,
+              const Format_description_log_event *description_event)
+  :Log_event(buf, description_event)
+{
+  /* The Post-Header is empty. The Variable Data part begins immediately. */
+  buf+= description_event->common_header_len +
+    description_event->post_header_len[XID_EVENT-1];
+  memcpy((char*) &xid, buf, sizeof(xid));
+}
+
+
+#ifndef MYSQL_CLIENT
+bool Xid_log_event::write(IO_CACHE* file)
+{
+  DBUG_EXECUTE_IF("do_not_write_xid", return 0;);
+  return write_header(file, sizeof(xid)) ||
+         my_b_safe_write(file, (uchar*) &xid, sizeof(xid));
+}
+#endif
+
+
+#ifdef MYSQL_CLIENT
+void Xid_log_event::print(FILE* file, PRINT_EVENT_INFO* print_event_info)
+{
+  Write_on_release_cache cache(&print_event_info->head_cache, file,
+                               Write_on_release_cache::FLUSH_F);
+
+  if (!print_event_info->short_form)
+  {
+    char buf[64];
+    longlong10_to_str(xid, buf, 10);
+
+    print_header(&cache, print_event_info, FALSE);
+    my_b_printf(&cache, "\tXid = %s\n", buf);
+  }
+  my_b_printf(&cache, "COMMIT%s\n", print_event_info->delimiter);
+}
+#endif /* MYSQL_CLIENT */
+
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+int Xid_log_event::do_apply_event(Relay_log_info const *rli)
+{
+  bool res;
+  /* For a slave Xid_log_event is COMMIT */
+  general_log_print(thd, COM_QUERY,
+                    "COMMIT /* implicit, from Xid_log_event */");
+  res= trans_commit(thd); /* Automatically rolls back on error. */
+  thd->mdl_context.release_transactional_locks();
+
+  /*
+    Increment the global status commit count variable
+  */
+  status_var_increment(thd->status_var.com_stat[SQLCOM_COMMIT]);
+
+  return res;
+}
+
+Log_event::enum_skip_reason
+Xid_log_event::do_shall_skip(Relay_log_info *rli)
+{
+  DBUG_ENTER("Xid_log_event::do_shall_skip");
+  if (rli->slave_skip_counter > 0) {
+    thd->variables.option_bits&= ~OPTION_BEGIN;
+    DBUG_RETURN(Log_event::EVENT_SKIP_COUNT);
+  }
+  DBUG_RETURN(Log_event::do_shall_skip(rli));
+}
+#endif /* !MYSQL_CLIENT */
+
+
+/**************************************************************************
+  User_var_log_event methods
+**************************************************************************/
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+void User_var_log_event::pack_info(Protocol* protocol)
+{
+  char *buf= 0;
+  char quoted_id[1 + FN_REFLEN * 2 + 2];// quoted identifier
+  int id_len= my_strmov_quoted_identifier(this->thd, quoted_id, name, 0);
+  quoted_id[id_len]= '\0';
+  uint val_offset= 2 + id_len;
+  uint event_len= val_offset;
+
+  if (is_null)
+  {
+    if (!(buf= (char*) my_malloc(val_offset + 5, MYF(MY_WME))))
+      return;
+    strmov(buf + val_offset, "NULL");
+    event_len= val_offset + 4;
+  }
+  else
+  {
+    switch (type) {
+    case REAL_RESULT:
+      double real_val;
+      float8get(real_val, val);
+      if (!(buf= (char*) my_malloc(val_offset + MY_GCVT_MAX_FIELD_WIDTH + 1,
+                                   MYF(MY_WME))))
+        return;
+      event_len+= my_gcvt(real_val, MY_GCVT_ARG_DOUBLE, MY_GCVT_MAX_FIELD_WIDTH,
+                          buf + val_offset, NULL);
+      break;
+    case INT_RESULT:
+      if (!(buf= (char*) my_malloc(val_offset + 22, MYF(MY_WME))))
+        return;
+      event_len= longlong10_to_str(uint8korr(val), buf + val_offset, 
+                                   ((flags & User_var_log_event::UNSIGNED_F) ? 
+                                    10 : -10))-buf;
+      break;
+    case DECIMAL_RESULT:
+    {
+      if (!(buf= (char*) my_malloc(val_offset + DECIMAL_MAX_STR_LENGTH,
+                                   MYF(MY_WME))))
+        return;
+      String str(buf+val_offset, DECIMAL_MAX_STR_LENGTH, &my_charset_bin);
+      my_decimal dec;
+      binary2my_decimal(E_DEC_FATAL_ERROR, (uchar*) (val+2), &dec, val[0],
+                        val[1]);
+      my_decimal2string(E_DEC_FATAL_ERROR, &dec, 0, 0, 0, &str);
+      event_len= str.length() + val_offset;
+      break;
+    } 
+    case STRING_RESULT:
+      /* 15 is for 'COLLATE' and other chars */
+      buf= (char*) my_malloc(event_len+val_len*2+1+2*MY_CS_NAME_SIZE+15,
+                             MYF(MY_WME));
+      CHARSET_INFO *cs;
+      if (!buf)
+        return;
+      if (!(cs= get_charset(charset_number, MYF(0))))
+      {
+        strmov(buf+val_offset, "???");
+        event_len+= 3;
+      }
+      else
+      {
+        char *p= strxmov(buf + val_offset, "_", cs->csname, " ", NullS);
+        p= str_to_hex(p, val, val_len);
+        p= strxmov(p, " COLLATE ", cs->name, NullS);
+        event_len= p-buf;
+      }
+      break;
+    case ROW_RESULT:
+    default:
+      DBUG_ASSERT(1);
+      return;
+    }
+  }
+  buf[0]= '@';
+  memcpy(buf + 1, quoted_id, id_len);
+  buf[1 + id_len]= '=';
+  protocol->store(buf, event_len, &my_charset_bin);
+  my_free(buf);
+}
+#endif /* !MYSQL_CLIENT */
+
+
+User_var_log_event::
+User_var_log_event(const char* buf, uint event_len,
+                   const Format_description_log_event* description_event)
+  :Log_event(buf, description_event)
+#ifndef MYSQL_CLIENT
+  , deferred(false), query_id(0)
+#endif
+{
+  bool error= false;
+  const char* buf_start= buf;
+  /* The Post-Header is empty. The Variable Data part begins immediately. */
+  const char *start= buf;
+  buf+= description_event->common_header_len +
+    description_event->post_header_len[USER_VAR_EVENT-1];
+  name_len= uint4korr(buf);
+  /* Avoid reading out of buffer */
+  if ((buf - buf_start) + UV_NAME_LEN_SIZE + name_len > event_len)
+  {
+    error= true;
+    goto err;
+  }
+
+  name= (char *) buf + UV_NAME_LEN_SIZE;
+
+  /*
+    We don't know yet is_null value, so we must assume that name_len
+    may have the bigger value possible, is_null= True and there is no
+    payload for val, or even that name_len is 0.
+  */
+  if (!valid_buffer_range<uint>(name_len, buf_start, name,
+                                event_len - UV_VAL_IS_NULL))
+  {
+    error= true;
+    goto err;
+  }
+
+  buf+= UV_NAME_LEN_SIZE + name_len;
+  is_null= (bool) *buf;
+  flags= User_var_log_event::UNDEF_F;    // defaults to UNDEF_F
+  if (is_null)
+  {
+    type= STRING_RESULT;
+    charset_number= my_charset_bin.number;
+    val_len= 0;
+    val= 0;  
+  }
+  else
+  {
+    if (!valid_buffer_range<uint>(UV_VAL_IS_NULL + UV_VAL_TYPE_SIZE
+                                  + UV_CHARSET_NUMBER_SIZE + UV_VAL_LEN_SIZE,
+                                  buf_start, buf, event_len))
+    {
+      error= true;
+      goto err;
+    }
+
+    type= (Item_result) buf[UV_VAL_IS_NULL];
+    charset_number= uint4korr(buf + UV_VAL_IS_NULL + UV_VAL_TYPE_SIZE);
+    val_len= uint4korr(buf + UV_VAL_IS_NULL + UV_VAL_TYPE_SIZE +
+                       UV_CHARSET_NUMBER_SIZE);
+    val= (char *) (buf + UV_VAL_IS_NULL + UV_VAL_TYPE_SIZE +
+                   UV_CHARSET_NUMBER_SIZE + UV_VAL_LEN_SIZE);
+
+    if (!valid_buffer_range<uint>(val_len, buf_start, val, event_len))
+    {
+      error= true;
+      goto err;
+    }
+
+    /**
+      We need to check if this is from an old server
+      that did not pack information for flags.
+      We do this by checking if there are extra bytes
+      after the packed value. If there are we take the
+      extra byte and it's value is assumed to contain
+      the flags value.
+
+      Old events will not have this extra byte, thence,
+      we keep the flags set to UNDEF_F.
+    */
+    uint bytes_read= ((val + val_len) - start);
+    if (bytes_read > event_len)
+    {
+      error= true;
+      goto err;
+    }
+    if ((data_written - bytes_read) > 0)
+    {
+      flags= (uint) *(buf + UV_VAL_IS_NULL + UV_VAL_TYPE_SIZE +
+                    UV_CHARSET_NUMBER_SIZE + UV_VAL_LEN_SIZE +
+                    val_len);
+    }
+  }
+
+err:
+  if (error)
+    name= 0;
+}
+
+
+#ifndef MYSQL_CLIENT
+bool User_var_log_event::write(IO_CACHE* file)
+{
+  char buf[UV_NAME_LEN_SIZE];
+  char buf1[UV_VAL_IS_NULL + UV_VAL_TYPE_SIZE + 
+	    UV_CHARSET_NUMBER_SIZE + UV_VAL_LEN_SIZE];
+  uchar buf2[max(8, DECIMAL_MAX_FIELD_SIZE + 2)], *pos= buf2;
+  uint unsigned_len= 0;
+  uint buf1_length;
+  ulong event_length;
+
+  int4store(buf, name_len);
+  
+  if ((buf1[0]= is_null))
+  {
+    buf1_length= 1;
+    val_len= 0;                                 // Length of 'pos'
+  }    
+  else
+  {
+    buf1[1]= type;
+    int4store(buf1 + 2, charset_number);
+
+    switch (type) {
+    case REAL_RESULT:
+      float8store(buf2, *(double*) val);
+      break;
+    case INT_RESULT:
+      int8store(buf2, *(longlong*) val);
+      unsigned_len= 1;
+      break;
+    case DECIMAL_RESULT:
+    {
+      my_decimal *dec= (my_decimal *)val;
+      dec->fix_buffer_pointer();
+      buf2[0]= (char)(dec->intg + dec->frac);
+      buf2[1]= (char)dec->frac;
+      decimal2bin((decimal_t*)val, buf2+2, buf2[0], buf2[1]);
+      val_len= decimal_bin_size(buf2[0], buf2[1]) + 2;
+      break;
+    }
+    case STRING_RESULT:
+      pos= (uchar*) val;
+      break;
+    case ROW_RESULT:
+    default:
+      DBUG_ASSERT(1);
+      return 0;
+    }
+    int4store(buf1 + 2 + UV_CHARSET_NUMBER_SIZE, val_len);
+    buf1_length= 10;
+  }
+
+  /* Length of the whole event */
+  event_length= sizeof(buf)+ name_len + buf1_length + val_len + unsigned_len;
+
+  return (write_header(file, event_length) ||
+          my_b_safe_write(file, (uchar*) buf, sizeof(buf))   ||
+          my_b_safe_write(file, (uchar*) name, name_len)     ||
+          my_b_safe_write(file, (uchar*) buf1, buf1_length) ||
+          my_b_safe_write(file, pos, val_len) ||
+          my_b_safe_write(file, &flags, unsigned_len));
+}
+#endif
+
+
+/*
+  User_var_log_event::print()
+*/
+
+#ifdef MYSQL_CLIENT
+void User_var_log_event::print(FILE* file, PRINT_EVENT_INFO* print_event_info)
+{
+  char quoted_id[1 + NAME_LEN * 2 + 2];// quoted length of the identifier
+  int quoted_len= 0;
+  Write_on_release_cache cache(&print_event_info->head_cache, file,
+                               Write_on_release_cache::FLUSH_F);
+
+  if (!print_event_info->short_form)
+  {
+    print_header(&cache, print_event_info, FALSE);
+    my_b_printf(&cache, "\tUser_var\n");
+  }
+
+  my_b_printf(&cache, "SET @");
+  quoted_len= my_strmov_quoted_identifier((char *) quoted_id,
+                                          (const char *) name);
+  quoted_id[quoted_len]= '\0';
+  my_b_write(&cache, (uchar*) quoted_id, (uint) quoted_len);
+
+  if (is_null)
+  {
+    my_b_printf(&cache, ":=NULL%s\n", print_event_info->delimiter);
+  }
+  else
+  {
+    switch (type) {
+    case REAL_RESULT:
+      double real_val;
+      char real_buf[FMT_G_BUFSIZE(14)];
+      float8get(real_val, val);
+      sprintf(real_buf, "%.14g", real_val);
+      my_b_printf(&cache, ":=%s%s\n", real_buf, print_event_info->delimiter);
+      break;
+    case INT_RESULT:
+      char int_buf[22];
+      longlong10_to_str(uint8korr(val), int_buf, 
+                        ((flags & User_var_log_event::UNSIGNED_F) ? 10 : -10));
+      my_b_printf(&cache, ":=%s%s\n", int_buf, print_event_info->delimiter);
+      break;
+    case DECIMAL_RESULT:
+    {
+      char str_buf[200];
+      int str_len= sizeof(str_buf) - 1;
+      int precision= (int)val[0];
+      int scale= (int)val[1];
+      decimal_digit_t dec_buf[10];
+      decimal_t dec;
+      dec.len= 10;
+      dec.buf= dec_buf;
+
+      bin2decimal((uchar*) val+2, &dec, precision, scale);
+      decimal2string(&dec, str_buf, &str_len, 0, 0, 0);
+      str_buf[str_len]= 0;
+      my_b_printf(&cache, ":=%s%s\n", str_buf, print_event_info->delimiter);
+      break;
+    }
+    case STRING_RESULT:
+    {
+      /*
+        Let's express the string in hex. That's the most robust way. If we
+        print it in character form instead, we need to escape it with
+        character_set_client which we don't know (we will know it in 5.0, but
+        in 4.1 we don't know it easily when we are printing
+        User_var_log_event). Explanation why we would need to bother with
+        character_set_client (quoting Bar):
+        > Note, the parser doesn't switch to another unescaping mode after
+        > it has met a character set introducer.
+        > For example, if an SJIS client says something like:
+        > SET @a= _ucs2 \0a\0b'
+        > the string constant is still unescaped according to SJIS, not
+        > according to UCS2.
+      */
+      char *hex_str;
+      CHARSET_INFO *cs;
+
+      hex_str= (char *)my_malloc(2*val_len+1+2,MYF(MY_WME)); // 2 hex digits / byte
+      if (!hex_str)
+        return;
+      str_to_hex(hex_str, val, val_len);
+      /*
+        For proper behaviour when mysqlbinlog|mysql, we need to explicitely
+        specify the variable's collation. It will however cause problems when
+        people want to mysqlbinlog|mysql into another server not supporting the
+        character set. But there's not much to do about this and it's unlikely.
+      */
+      if (!(cs= get_charset(charset_number, MYF(0))))
+        /*
+          Generate an unusable command (=> syntax error) is probably the best
+          thing we can do here.
+        */
+        my_b_printf(&cache, ":=???%s\n", print_event_info->delimiter);
+      else
+        my_b_printf(&cache, ":=_%s %s COLLATE `%s`%s\n",
+                    cs->csname, hex_str, cs->name,
+                    print_event_info->delimiter);
+      my_free(hex_str);
+    }
+      break;
+    case ROW_RESULT:
+    default:
+      DBUG_ASSERT(1);
+      return;
+    }
+  }
+}
+#endif
+
+
+/*
+  User_var_log_event::do_apply_event()
+*/
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+int User_var_log_event::do_apply_event(Relay_log_info const *rli)
+{
+  Item *it= 0;
+  CHARSET_INFO *charset;
+  query_id_t sav_query_id= 0; /* memorize orig id when deferred applying */
+
+  if (rli->deferred_events_collecting)
+  {
+    set_deferred(current_thd->query_id);
+    return rli->deferred_events->add(this);
+  } else if (is_deferred())
+  {
+    sav_query_id= current_thd->query_id;
+    current_thd->query_id= query_id; /* recreating original time context */
+  }
+
+  if (!(charset= get_charset(charset_number, MYF(MY_WME))))
+  {
+    rli->report(ERROR_LEVEL, ER_SLAVE_FATAL_ERROR,
+                ER_THD(thd, ER_SLAVE_FATAL_ERROR),
+                "Invalid character set for User var event");
+    return 1;
+  }
+  LEX_STRING user_var_name;
+  user_var_name.str= name;
+  user_var_name.length= name_len;
+  double real_val;
+  longlong int_val;
+
+  /*
+    We are now in a statement until the associated query log event has
+    been processed.
+   */
+  const_cast<Relay_log_info*>(rli)->set_flag(Relay_log_info::IN_STMT);
+
+  if (is_null)
+  {
+    it= new Item_null();
+  }
+  else
+  {
+    switch (type) {
+    case REAL_RESULT:
+      if (val_len != 8)
+      {
+        rli->report(ERROR_LEVEL, ER_SLAVE_FATAL_ERROR,
+                    ER_THD(thd, ER_SLAVE_FATAL_ERROR),
+                    "Invalid variable length at User var event");
+        return 1;
+      }
+      float8get(real_val, val);
+      it= new Item_float(real_val, 0);
+      val= (char*) &real_val;		// Pointer to value in native format
+      val_len= 8;
+      break;
+    case INT_RESULT:
+      if (val_len != 8)
+      {
+        rli->report(ERROR_LEVEL, ER_SLAVE_FATAL_ERROR,
+                    ER_THD(thd, ER_SLAVE_FATAL_ERROR),
+                    "Invalid variable length at User var event");
+        return 1;
+      }
+      int_val= (longlong) uint8korr(val);
+      it= new Item_int(int_val);
+      val= (char*) &int_val;		// Pointer to value in native format
+      val_len= 8;
+      break;
+    case DECIMAL_RESULT:
+    {
+      if (val_len < 3)
+      {
+        rli->report(ERROR_LEVEL, ER_SLAVE_FATAL_ERROR,
+                    ER_THD(thd, ER_SLAVE_FATAL_ERROR),
+                    "Invalid variable length at User var event");
+        return 1;
+      }
+      Item_decimal *dec= new Item_decimal((uchar*) val+2, val[0], val[1]);
+      it= dec;
+      val= (char *)dec->val_decimal(NULL);
+      val_len= sizeof(my_decimal);
+      break;
+    }
+    case STRING_RESULT:
+      it= new Item_string(val, val_len, charset);
+      break;
+    case ROW_RESULT:
+    default:
+      DBUG_ASSERT(1);
+      return 0;
+    }
+  }
+
+  Item_func_set_user_var *e= 
+    new Item_func_set_user_var(user_var_name, it, false);
+  /*
+    Item_func_set_user_var can't substitute something else on its place =>
+    0 can be passed as last argument (reference on item)
+
+    Fix_fields() can fail, in which case a call of update_hash() might
+    crash the server, so if fix fields fails, we just return with an
+    error.
+  */
+  if (e->fix_fields(thd, 0))
+    return 1;
+
+  /*
+    A variable can just be considered as a table with
+    a single record and with a single column. Thus, like
+    a column value, it could always have IMPLICIT derivation.
+   */
+  e->update_hash(val, val_len, type, charset, DERIVATION_IMPLICIT,
+                 (flags & User_var_log_event::UNSIGNED_F));
+  if (!is_deferred())
+    free_root(thd->mem_root, 0);
+  else
+    current_thd->query_id= sav_query_id; /* restore current query's context */
+
+  return 0;
+}
+
+int User_var_log_event::do_update_pos(Relay_log_info *rli)
+{
+  rli->inc_event_relay_log_pos();
+  return 0;
+}
+
+Log_event::enum_skip_reason
+User_var_log_event::do_shall_skip(Relay_log_info *rli)
+{
+  /*
+    It is a common error to set the slave skip counter to 1 instead
+    of 2 when recovering from an insert which used a auto increment,
+    rand, or user var.  Therefore, if the slave skip counter is 1, we
+    just say that this event should be skipped by ignoring it, meaning
+    that we do not change the value of the slave skip counter since it
+    will be decreased by the following insert event.
+  */
+  return continue_group(rli);
+}
+#endif /* !MYSQL_CLIENT */
+
+
+/**************************************************************************
+  Slave_log_event methods
+**************************************************************************/
+
+#ifdef HAVE_REPLICATION
+#ifdef MYSQL_CLIENT
+void Unknown_log_event::print(FILE* file_arg, PRINT_EVENT_INFO* print_event_info)
+{
+  Write_on_release_cache cache(&print_event_info->head_cache, file_arg);
+
+  if (print_event_info->short_form)
+    return;
+  print_header(&cache, print_event_info, FALSE);
+  my_b_printf(&cache, "\n# %s", "Unknown event\n");
+}
+#endif  
+
+#ifndef MYSQL_CLIENT
+void Slave_log_event::pack_info(Protocol *protocol)
+{
+  char buf[256+HOSTNAME_LENGTH], *pos;
+  pos= strmov(buf, "host=");
+  pos= strnmov(pos, master_host, HOSTNAME_LENGTH);
+  pos= strmov(pos, ",port=");
+  pos= int10_to_str((long) master_port, pos, 10);
+  pos= strmov(pos, ",log=");
+  pos= strmov(pos, master_log);
+  pos= strmov(pos, ",pos=");
+  pos= longlong10_to_str(master_pos, pos, 10);
+  protocol->store(buf, pos-buf, &my_charset_bin);
+}
+#endif /* !MYSQL_CLIENT */
+
+
+#ifndef MYSQL_CLIENT
+/**
+  @todo
+  re-write this better without holding both locks at the same time
+*/
+Slave_log_event::Slave_log_event(THD* thd_arg,
+				 Relay_log_info* rli)
+  :Log_event(thd_arg, 0, 0) , mem_pool(0), master_host(0)
+{
+  DBUG_ENTER("Slave_log_event");
+  if (!rli->inited)				// QQ When can this happen ?
+    DBUG_VOID_RETURN;
+
+  Master_info* mi = rli->mi;
+  // TODO: re-write this better without holding both locks at the same time
+  mysql_mutex_lock(&mi->data_lock);
+  mysql_mutex_lock(&rli->data_lock);
+  master_host_len = strlen(mi->host);
+  master_log_len = strlen(rli->group_master_log_name);
+  // on OOM, just do not initialize the structure and print the error
+  if ((mem_pool = (char*)my_malloc(get_data_size() + 1,
+                                   MYF(MY_WME))))
+  {
+    master_host = mem_pool + SL_MASTER_HOST_OFFSET ;
+    memcpy(master_host, mi->host, master_host_len + 1);
+    master_log = master_host + master_host_len + 1;
+    memcpy(master_log, rli->group_master_log_name, master_log_len + 1);
+    master_port = mi->port;
+    master_pos = rli->group_master_log_pos;
+    DBUG_PRINT("info", ("master_log: %s  pos: %lu", master_log,
+                        (ulong) master_pos));
+  }
+  else
+    sql_print_error("Out of memory while recording slave event");
+  mysql_mutex_unlock(&rli->data_lock);
+  mysql_mutex_unlock(&mi->data_lock);
+  DBUG_VOID_RETURN;
+}
+#endif /* !MYSQL_CLIENT */
+
+
+Slave_log_event::~Slave_log_event()
+{
+  my_free(mem_pool);
+}
+
+
+#ifdef MYSQL_CLIENT
+void Slave_log_event::print(FILE* file, PRINT_EVENT_INFO* print_event_info)
+{
+  Write_on_release_cache cache(&print_event_info->head_cache, file);
+
+  char llbuff[22];
+  if (print_event_info->short_form)
+    return;
+  print_header(&cache, print_event_info, FALSE);
+  my_b_printf(&cache, "\n\
+Slave: master_host: '%s'  master_port: %d  master_log: '%s'  master_pos: %s\n",
+	  master_host, master_port, master_log, llstr(master_pos, llbuff));
+}
+#endif /* MYSQL_CLIENT */
+
+
+int Slave_log_event::get_data_size()
+{
+  return master_host_len + master_log_len + 1 + SL_MASTER_HOST_OFFSET;
+}
+
+
+#ifndef MYSQL_CLIENT
+bool Slave_log_event::write(IO_CACHE* file)
+{
+  ulong event_length= get_data_size();
+  int8store(mem_pool + SL_MASTER_POS_OFFSET, master_pos);
+  int2store(mem_pool + SL_MASTER_PORT_OFFSET, master_port);
+  // log and host are already there
+
+  return (write_header(file, event_length) ||
+          my_b_safe_write(file, (uchar*) mem_pool, event_length));
+}
+#endif
+
+
+void Slave_log_event::init_from_mem_pool(int data_size)
+{
+  master_pos = uint8korr(mem_pool + SL_MASTER_POS_OFFSET);
+  master_port = uint2korr(mem_pool + SL_MASTER_PORT_OFFSET);
+  master_host = mem_pool + SL_MASTER_HOST_OFFSET;
+  master_host_len = (uint) strlen(master_host);
+  // safety
+  master_log = master_host + master_host_len + 1;
+  if (master_log > mem_pool + data_size)
+  {
+    master_host = 0;
+    return;
+  }
+  master_log_len = (uint) strlen(master_log);
+}
+
+
+/** This code is not used, so has not been updated to be format-tolerant. */
+/* We are using description_event so that slave does not crash on Log_event
+  constructor */
+Slave_log_event::Slave_log_event(const char* buf, 
+                                 uint event_len,
+                                 const Format_description_log_event* description_event)
+  :Log_event(buf,description_event),mem_pool(0),master_host(0)
+{
+  if (event_len < LOG_EVENT_HEADER_LEN)
+    return;
+  event_len -= LOG_EVENT_HEADER_LEN;
+  if (!(mem_pool = (char*) my_malloc(event_len + 1, MYF(MY_WME))))
+    return;
+  memcpy(mem_pool, buf + LOG_EVENT_HEADER_LEN, event_len);
+  mem_pool[event_len] = 0;
+  init_from_mem_pool(event_len);
+}
+
+
+#ifndef MYSQL_CLIENT
+int Slave_log_event::do_apply_event(Relay_log_info const *rli)
+{
+  if (mysql_bin_log.is_open())
+    return mysql_bin_log.write(this);
+  return 0;
+}
+#endif /* !MYSQL_CLIENT */
+
+
+/**************************************************************************
+	Stop_log_event methods
+**************************************************************************/
+
+/*
+  Stop_log_event::print()
+*/
+
+#ifdef MYSQL_CLIENT
+void Stop_log_event::print(FILE* file, PRINT_EVENT_INFO* print_event_info)
+{
+  Write_on_release_cache cache(&print_event_info->head_cache, file,
+                               Write_on_release_cache::FLUSH_F);
+
+  if (print_event_info->short_form)
+    return;
+
+  print_header(&cache, print_event_info, FALSE);
+  my_b_printf(&cache, "\tStop\n");
+}
+#endif /* MYSQL_CLIENT */
+
+
+#ifndef MYSQL_CLIENT
+/*
+  The master stopped.  We used to clean up all temporary tables but
+  this is useless as, as the master has shut down properly, it has
+  written all DROP TEMPORARY TABLE (prepared statements' deletion is
+  TODO only when we binlog prep stmts).  We used to clean up
+  slave_load_tmpdir, but this is useless as it has been cleared at the
+  end of LOAD DATA INFILE.  So we have nothing to do here.  The place
+  were we must do this cleaning is in
+  Start_log_event_v3::do_apply_event(), not here. Because if we come
+  here, the master was sane.
+*/
+int Stop_log_event::do_update_pos(Relay_log_info *rli)
+{
+  /*
+    We do not want to update master_log pos because we get a rotate event
+    before stop, so by now group_master_log_name is set to the next log.
+    If we updated it, we will have incorrect master coordinates and this
+    could give false triggers in MASTER_POS_WAIT() that we have reached
+    the target position when in fact we have not.
+  */
+  if (thd->variables.option_bits & OPTION_BEGIN)
+    rli->inc_event_relay_log_pos();
+  else
+  {
+    rli->inc_group_relay_log_pos(0);
+    flush_relay_log_info(rli);
+  }
+  return 0;
+}
+
+#endif /* !MYSQL_CLIENT */
+#endif /* HAVE_REPLICATION */
+
+
+/**************************************************************************
+	Create_file_log_event methods
+**************************************************************************/
+
+/*
+  Create_file_log_event ctor
+*/
+
+#ifndef MYSQL_CLIENT
+Create_file_log_event::
+Create_file_log_event(THD* thd_arg, sql_exchange* ex,
+		      const char* db_arg, const char* table_name_arg,
+                      List<Item>& fields_arg,
+                      bool is_concurrent_arg,
+                      enum enum_duplicates handle_dup,
+                      bool ignore,
+		      uchar* block_arg, uint block_len_arg, bool using_trans)
+  :Load_log_event(thd_arg, ex, db_arg, table_name_arg, fields_arg,
+                  is_concurrent_arg,
+                  handle_dup, ignore, using_trans),
+   fake_base(0), block(block_arg), event_buf(0), block_len(block_len_arg),
+   file_id(thd_arg->file_id = mysql_bin_log.next_file_id())
+{
+  DBUG_ENTER("Create_file_log_event");
+  sql_ex.force_new_format();
+  DBUG_VOID_RETURN;
+}
+
+
+/*
+  Create_file_log_event::write_data_body()
+*/
+
+bool Create_file_log_event::write_data_body(IO_CACHE* file)
+{
+  bool res;
+  if ((res= Load_log_event::write_data_body(file)) || fake_base)
+    return res;
+  return (my_b_safe_write(file, (uchar*) "", 1) ||
+          my_b_safe_write(file, (uchar*) block, block_len));
+}
+
+
+/*
+  Create_file_log_event::write_data_header()
+*/
+
+bool Create_file_log_event::write_data_header(IO_CACHE* file)
+{
+  bool res;
+  uchar buf[CREATE_FILE_HEADER_LEN];
+  if ((res= Load_log_event::write_data_header(file)) || fake_base)
+    return res;
+  int4store(buf + CF_FILE_ID_OFFSET, file_id);
+  return my_b_safe_write(file, buf, CREATE_FILE_HEADER_LEN) != 0;
+}
+
+
+/*
+  Create_file_log_event::write_base()
+*/
+
+bool Create_file_log_event::write_base(IO_CACHE* file)
+{
+  bool res;
+  fake_base= 1;                                 // pretend we are Load event
+  res= write(file);
+  fake_base= 0;
+  return res;
+}
+
+#endif /* !MYSQL_CLIENT */
+
+/*
+  Create_file_log_event ctor
+*/
+
+Create_file_log_event::Create_file_log_event(const char* buf, uint len,
+                                             const Format_description_log_event* description_event)
+  :Load_log_event(buf,0,description_event),fake_base(0),block(0),inited_from_old(0)
+{
+  DBUG_ENTER("Create_file_log_event::Create_file_log_event(char*,...)");
+  uint block_offset;
+  uint header_len= description_event->common_header_len;
+  uint8 load_header_len= description_event->post_header_len[LOAD_EVENT-1];
+  uint8 create_file_header_len= description_event->post_header_len[CREATE_FILE_EVENT-1];
+  if (!(event_buf= (char*) my_memdup(buf, len, MYF(MY_WME))) ||
+      copy_log_event(event_buf,len,
+                     ((buf[EVENT_TYPE_OFFSET] == LOAD_EVENT) ?
+                      load_header_len + header_len :
+                      (fake_base ? (header_len+load_header_len) :
+                       (header_len+load_header_len) +
+                       create_file_header_len)),
+                     description_event))
+    DBUG_VOID_RETURN;
+  if (description_event->binlog_version!=1)
+  {
+    file_id= uint4korr(buf + 
+                       header_len +
+		       load_header_len + CF_FILE_ID_OFFSET);
+    /*
+      Note that it's ok to use get_data_size() below, because it is computed
+      with values we have already read from this event (because we called
+      copy_log_event()); we are not using slave's format info to decode
+      master's format, we are really using master's format info.
+      Anyway, both formats should be identical (except the common_header_len)
+      as these Load events are not changed between 4.0 and 5.0 (as logging of
+      LOAD DATA INFILE does not use Load_log_event in 5.0).
+
+      The + 1 is for \0 terminating fname  
+    */
+    block_offset= (description_event->common_header_len +
+                   Load_log_event::get_data_size() +
+                   create_file_header_len + 1);
+    if (len < block_offset)
+      DBUG_VOID_RETURN;
+    block = (uchar*)buf + block_offset;
+    block_len = len - block_offset;
+  }
+  else
+  {
+    sql_ex.force_new_format();
+    inited_from_old = 1;
+  }
+  DBUG_VOID_RETURN;
+}
+
+
+/*
+  Create_file_log_event::print()
+*/
+
+#ifdef MYSQL_CLIENT
+void Create_file_log_event::print(FILE* file, PRINT_EVENT_INFO* print_event_info,
+				  bool enable_local)
+{
+  Write_on_release_cache cache(&print_event_info->head_cache, file);
+
+  if (print_event_info->short_form)
+  {
+    if (enable_local && check_fname_outside_temp_buf())
+      Load_log_event::print(file, print_event_info);
+    return;
+  }
+
+  if (enable_local)
+  {
+    Load_log_event::print(file, print_event_info,
+			  !check_fname_outside_temp_buf());
+    /**
+      reduce the size of io cache so that the write function is called
+      for every call to my_b_printf().
+     */
+    DBUG_EXECUTE_IF ("simulate_create_event_write_error",
+                     {(&cache)->write_pos= (&cache)->write_end;
+                     DBUG_SET("+d,simulate_file_write_error");});
+    /*
+      That one is for "file_id: etc" below: in mysqlbinlog we want the #, in
+      SHOW BINLOG EVENTS we don't.
+     */
+    my_b_printf(&cache, "#");
+  }
+
+  my_b_printf(&cache, " file_id: %d  block_len: %d\n", file_id, block_len);
+}
+
+
+void Create_file_log_event::print(FILE* file, PRINT_EVENT_INFO* print_event_info)
+{
+  print(file, print_event_info, 0);
+}
+#endif /* MYSQL_CLIENT */
+
+
+/*
+  Create_file_log_event::pack_info()
+*/
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+void Create_file_log_event::pack_info(Protocol *protocol)
+{
+  char buf[NAME_LEN*2 + 30 + 21*2], *pos;
+  pos= strmov(buf, "db=");
+  memcpy(pos, db, db_len);
+  pos= strmov(pos + db_len, ";table=");
+  memcpy(pos, table_name, table_name_len);
+  pos= strmov(pos + table_name_len, ";file_id=");
+  pos= int10_to_str((long) file_id, pos, 10);
+  pos= strmov(pos, ";block_len=");
+  pos= int10_to_str((long) block_len, pos, 10);
+  protocol->store(buf, (uint) (pos-buf), &my_charset_bin);
+}
+#endif /* defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT) */
+
+
+/**
+  Create_file_log_event::do_apply_event()
+  Constructor for Create_file_log_event to intantiate an event
+  from the relay log on the slave.
+
+  @retval
+    0           Success
+  @retval
+    1           Failure
+*/
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+int Create_file_log_event::do_apply_event(Relay_log_info const *rli)
+{
+  char proc_info[17+FN_REFLEN+10], *fname_buf;
+  char *ext;
+  int fd = -1;
+  IO_CACHE file;
+  int error = 1;
+
+  bzero((char*)&file, sizeof(file));
+  fname_buf= strmov(proc_info, "Making temp file ");
+  ext= slave_load_file_stem(fname_buf, file_id, server_id, ".info");
+  thd_proc_info(thd, proc_info);
+  /* old copy may exist already */
+  mysql_file_delete(key_file_log_event_info, fname_buf, MYF(0));
+  if ((fd= mysql_file_create(key_file_log_event_info,
+                             fname_buf, CREATE_MODE,
+                             O_WRONLY | O_BINARY | O_EXCL | O_NOFOLLOW,
+                             MYF(MY_WME))) < 0 ||
+      init_io_cache(&file, fd, IO_SIZE, WRITE_CACHE, (my_off_t)0, 0,
+		    MYF(MY_WME|MY_NABP)))
+  {
+    rli->report(ERROR_LEVEL, my_errno,
+                "Error in Create_file event: could not open file '%s'",
+                fname_buf);
+    goto err;
+  }
+  
+  // a trick to avoid allocating another buffer
+  fname= fname_buf;
+  fname_len= (uint) (strmov(ext, ".data") - fname);
+  if (write_base(&file))
+  {
+    strmov(ext, ".info"); // to have it right in the error message
+    rli->report(ERROR_LEVEL, my_errno,
+                "Error in Create_file event: could not write to file '%s'",
+                fname_buf);
+    goto err;
+  }
+  end_io_cache(&file);
+  mysql_file_close(fd, MYF(0));
+  
+  // fname_buf now already has .data, not .info, because we did our trick
+  /* old copy may exist already */
+  mysql_file_delete(key_file_log_event_data, fname_buf, MYF(0));
+  if ((fd= mysql_file_create(key_file_log_event_data,
+                             fname_buf, CREATE_MODE,
+                             O_WRONLY | O_BINARY | O_EXCL | O_NOFOLLOW,
+                             MYF(MY_WME))) < 0)
+  {
+    rli->report(ERROR_LEVEL, my_errno,
+                "Error in Create_file event: could not open file '%s'",
+                fname_buf);
+    goto err;
+  }
+  if (mysql_file_write(fd, (uchar*) block, block_len, MYF(MY_WME+MY_NABP)))
+  {
+    rli->report(ERROR_LEVEL, my_errno,
+                "Error in Create_file event: write to '%s' failed",
+                fname_buf);
+    goto err;
+  }
+  error=0;					// Everything is ok
+
+err:
+  if (error)
+    end_io_cache(&file);
+  if (fd >= 0)
+    mysql_file_close(fd, MYF(0));
+  thd_proc_info(thd, 0);
+  return error != 0;
+}
+#endif /* defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT) */
+
+
+/**************************************************************************
+	Append_block_log_event methods
+**************************************************************************/
+
+/*
+  Append_block_log_event ctor
+*/
+
+#ifndef MYSQL_CLIENT  
+Append_block_log_event::Append_block_log_event(THD *thd_arg,
+                                               const char *db_arg,
+					       uchar *block_arg,
+					       uint block_len_arg,
+					       bool using_trans)
+  :Log_event(thd_arg,0, using_trans), block(block_arg),
+   block_len(block_len_arg), file_id(thd_arg->file_id), db(db_arg)
+{
+}
+#endif
+
+
+/*
+  Append_block_log_event ctor
+*/
+
+Append_block_log_event::Append_block_log_event(const char* buf, uint len,
+                                               const Format_description_log_event* description_event)
+  :Log_event(buf, description_event),block(0)
+{
+  DBUG_ENTER("Append_block_log_event::Append_block_log_event(char*,...)");
+  uint8 common_header_len= description_event->common_header_len; 
+  uint8 append_block_header_len=
+    description_event->post_header_len[APPEND_BLOCK_EVENT-1];
+  uint total_header_len= common_header_len+append_block_header_len;
+  if (len < total_header_len)
+    DBUG_VOID_RETURN;
+  file_id= uint4korr(buf + common_header_len + AB_FILE_ID_OFFSET);
+  block= (uchar*)buf + total_header_len;
+  block_len= len - total_header_len;
+  DBUG_VOID_RETURN;
+}
+
+
+/*
+  Append_block_log_event::write()
+*/
+
+#ifndef MYSQL_CLIENT
+bool Append_block_log_event::write(IO_CACHE* file)
+{
+  uchar buf[APPEND_BLOCK_HEADER_LEN];
+  int4store(buf + AB_FILE_ID_OFFSET, file_id);
+  return (write_header(file, APPEND_BLOCK_HEADER_LEN + block_len) ||
+          my_b_safe_write(file, buf, APPEND_BLOCK_HEADER_LEN) ||
+	  my_b_safe_write(file, (uchar*) block, block_len));
+}
+#endif
+
+
+/*
+  Append_block_log_event::print()
+*/
+
+#ifdef MYSQL_CLIENT  
+void Append_block_log_event::print(FILE* file,
+				   PRINT_EVENT_INFO* print_event_info)
+{
+  Write_on_release_cache cache(&print_event_info->head_cache, file);
+
+  if (print_event_info->short_form)
+    return;
+  print_header(&cache, print_event_info, FALSE);
+  my_b_printf(&cache, "\n#%s: file_id: %d  block_len: %d\n",
+              get_type_str(), file_id, block_len);
+}
+#endif /* MYSQL_CLIENT */
+
+
+/*
+  Append_block_log_event::pack_info()
+*/
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+void Append_block_log_event::pack_info(Protocol *protocol)
+{
+  char buf[256];
+  size_t length;
+  length= my_snprintf(buf, sizeof(buf), ";file_id=%u;block_len=%u",
+                      file_id, block_len);
+  protocol->store(buf, length, &my_charset_bin);
+}
+
+
+/*
+  Append_block_log_event::get_create_or_append()
+*/
+
+int Append_block_log_event::get_create_or_append() const
+{
+  return 0; /* append to the file, fail if not exists */
+}
+
+/*
+  Append_block_log_event::do_apply_event()
+*/
+
+int Append_block_log_event::do_apply_event(Relay_log_info const *rli)
+{
+  char proc_info[17+FN_REFLEN+10], *fname= proc_info+17;
+  int fd;
+  int error = 1;
+  DBUG_ENTER("Append_block_log_event::do_apply_event");
+
+  fname= strmov(proc_info, "Making temp file ");
+  slave_load_file_stem(fname, file_id, server_id, ".data");
+  thd_proc_info(thd, proc_info);
+  if (get_create_or_append())
+  {
+    /*
+      Usually lex_start() is called by mysql_parse(), but we need it here
+      as the present method does not call mysql_parse().
+    */
+    lex_start(thd);
+    mysql_reset_thd_for_next_command(thd);
+    /* old copy may exist already */
+    mysql_file_delete(key_file_log_event_data, fname, MYF(0));
+    if ((fd= mysql_file_create(key_file_log_event_data,
+                               fname, CREATE_MODE,
+                               O_WRONLY | O_BINARY | O_EXCL | O_NOFOLLOW,
+                               MYF(MY_WME))) < 0)
+    {
+      rli->report(ERROR_LEVEL, my_errno,
+                  "Error in %s event: could not create file '%s'",
+                  get_type_str(), fname);
+      goto err;
+    }
+  }
+  else if ((fd= mysql_file_open(key_file_log_event_data,
+                                fname,
+                                O_WRONLY | O_APPEND | O_BINARY | O_NOFOLLOW,
+                                MYF(MY_WME))) < 0)
+  {
+    rli->report(ERROR_LEVEL, my_errno,
+                "Error in %s event: could not open file '%s'",
+                get_type_str(), fname);
+    goto err;
+  }
+
+  DBUG_EXECUTE_IF("remove_slave_load_file_before_write",
+                  {
+                    my_delete_allow_opened(fname, MYF(0));
+                  });
+
+  if (mysql_file_write(fd, (uchar*) block, block_len, MYF(MY_WME+MY_NABP)))
+  {
+    rli->report(ERROR_LEVEL, my_errno,
+                "Error in %s event: write to '%s' failed",
+                get_type_str(), fname);
+    goto err;
+  }
+  error=0;
+
+err:
+  if (fd >= 0)
+    mysql_file_close(fd, MYF(0));
+  thd_proc_info(thd, 0);
+  DBUG_RETURN(error);
+}
+#endif
+
+
+/**************************************************************************
+	Delete_file_log_event methods
+**************************************************************************/
+
+/*
+  Delete_file_log_event ctor
+*/
+
+#ifndef MYSQL_CLIENT
+Delete_file_log_event::Delete_file_log_event(THD *thd_arg, const char* db_arg,
+					     bool using_trans)
+  :Log_event(thd_arg, 0, using_trans), file_id(thd_arg->file_id), db(db_arg)
+{
+}
+#endif
+
+/*
+  Delete_file_log_event ctor
+*/
+
+Delete_file_log_event::Delete_file_log_event(const char* buf, uint len,
+                                             const Format_description_log_event* description_event)
+  :Log_event(buf, description_event),file_id(0)
+{
+  uint8 common_header_len= description_event->common_header_len;
+  uint8 delete_file_header_len= description_event->post_header_len[DELETE_FILE_EVENT-1];
+  if (len < (uint)(common_header_len + delete_file_header_len))
+    return;
+  file_id= uint4korr(buf + common_header_len + DF_FILE_ID_OFFSET);
+}
+
+
+/*
+  Delete_file_log_event::write()
+*/
+
+#ifndef MYSQL_CLIENT
+bool Delete_file_log_event::write(IO_CACHE* file)
+{
+ uchar buf[DELETE_FILE_HEADER_LEN];
+ int4store(buf + DF_FILE_ID_OFFSET, file_id);
+ return (write_header(file, sizeof(buf)) ||
+         my_b_safe_write(file, buf, sizeof(buf)));
+}
+#endif
+
+
+/*
+  Delete_file_log_event::print()
+*/
+
+#ifdef MYSQL_CLIENT  
+void Delete_file_log_event::print(FILE* file,
+				  PRINT_EVENT_INFO* print_event_info)
+{
+  Write_on_release_cache cache(&print_event_info->head_cache, file);
+
+  if (print_event_info->short_form)
+    return;
+  print_header(&cache, print_event_info, FALSE);
+  my_b_printf(&cache, "\n#Delete_file: file_id=%u\n", file_id);
+}
+#endif /* MYSQL_CLIENT */
+
+/*
+  Delete_file_log_event::pack_info()
+*/
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+void Delete_file_log_event::pack_info(Protocol *protocol)
+{
+  char buf[64];
+  size_t length;
+  length= my_snprintf(buf, sizeof(buf), ";file_id=%u", (uint) file_id);
+  protocol->store(buf, length, &my_charset_bin);
+}
+#endif
+
+/*
+  Delete_file_log_event::do_apply_event()
+*/
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+int Delete_file_log_event::do_apply_event(Relay_log_info const *rli)
+{
+  char fname[FN_REFLEN+10];
+  char *ext= slave_load_file_stem(fname, file_id, server_id, ".data");
+  mysql_file_delete(key_file_log_event_data, fname, MYF(MY_WME));
+  strmov(ext, ".info");
+  mysql_file_delete(key_file_log_event_info, fname, MYF(MY_WME));
+  return 0;
+}
+#endif /* defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT) */
+
+
+/**************************************************************************
+	Execute_load_log_event methods
+**************************************************************************/
+
+/*
+  Execute_load_log_event ctor
+*/
+
+#ifndef MYSQL_CLIENT  
+Execute_load_log_event::Execute_load_log_event(THD *thd_arg,
+                                               const char* db_arg,
+					       bool using_trans)
+  :Log_event(thd_arg, 0, using_trans), file_id(thd_arg->file_id), db(db_arg)
+{
+}
+#endif
+  
+
+/*
+  Execute_load_log_event ctor
+*/
+
+Execute_load_log_event::Execute_load_log_event(const char* buf, uint len,
+                                               const Format_description_log_event* description_event)
+  :Log_event(buf, description_event), file_id(0)
+{
+  uint8 common_header_len= description_event->common_header_len;
+  uint8 exec_load_header_len= description_event->post_header_len[EXEC_LOAD_EVENT-1];
+  if (len < (uint)(common_header_len+exec_load_header_len))
+    return;
+  file_id= uint4korr(buf + common_header_len + EL_FILE_ID_OFFSET);
+}
+
+
+/*
+  Execute_load_log_event::write()
+*/
+
+#ifndef MYSQL_CLIENT
+bool Execute_load_log_event::write(IO_CACHE* file)
+{
+  uchar buf[EXEC_LOAD_HEADER_LEN];
+  int4store(buf + EL_FILE_ID_OFFSET, file_id);
+  return (write_header(file, sizeof(buf)) || 
+          my_b_safe_write(file, buf, sizeof(buf)));
+}
+#endif
+
+
+/*
+  Execute_load_log_event::print()
+*/
+
+#ifdef MYSQL_CLIENT  
+void Execute_load_log_event::print(FILE* file,
+				   PRINT_EVENT_INFO* print_event_info)
+{
+  Write_on_release_cache cache(&print_event_info->head_cache, file);
+
+  if (print_event_info->short_form)
+    return;
+  print_header(&cache, print_event_info, FALSE);
+  my_b_printf(&cache, "\n#Exec_load: file_id=%d\n",
+              file_id);
+}
+#endif
+
+/*
+  Execute_load_log_event::pack_info()
+*/
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+void Execute_load_log_event::pack_info(Protocol *protocol)
+{
+  char buf[64];
+  size_t length;
+  length= my_snprintf(buf, sizeof(buf), ";file_id=%u", (uint) file_id);
+  protocol->store(buf, length, &my_charset_bin);
+}
+
+
+/*
+  Execute_load_log_event::do_apply_event()
+*/
+
+int Execute_load_log_event::do_apply_event(Relay_log_info const *rli)
+{
+  char fname[FN_REFLEN+10];
+  char *ext;
+  int fd;
+  int error= 1;
+  IO_CACHE file;
+  Load_log_event *lev= 0;
+
+  ext= slave_load_file_stem(fname, file_id, server_id, ".info");
+  if ((fd= mysql_file_open(key_file_log_event_info,
+                           fname, O_RDONLY | O_BINARY | O_NOFOLLOW,
+                           MYF(MY_WME))) < 0 ||
+      init_io_cache(&file, fd, IO_SIZE, READ_CACHE, (my_off_t)0, 0,
+		    MYF(MY_WME|MY_NABP)))
+  {
+    rli->report(ERROR_LEVEL, my_errno,
+                "Error in Exec_load event: could not open file '%s'",
+                fname);
+    goto err;
+  }
+  if (!(lev = (Load_log_event*)Log_event::read_log_event(&file,
+                                                         (mysql_mutex_t*)0,
+                                                         rli->relay_log.description_event_for_exec)) ||
+      lev->get_type_code() != NEW_LOAD_EVENT)
+  {
+    rli->report(ERROR_LEVEL, 0, "Error in Exec_load event: "
+                    "file '%s' appears corrupted", fname);
+    goto err;
+  }
+
+  lev->thd = thd;
+  /*
+    lev->do_apply_event should use rli only for errors i.e. should
+    not advance rli's position.
+
+    lev->do_apply_event is the place where the table is loaded (it
+    calls mysql_load()).
+  */
+
+  const_cast<Relay_log_info*>(rli)->future_group_master_log_pos= log_pos;
+  if (lev->do_apply_event(0,rli,1)) 
+  {
+    /*
+      We want to indicate the name of the file that could not be loaded
+      (SQL_LOADxxx).
+      But as we are here we are sure the error is in rli->last_slave_error and
+      rli->last_slave_errno (example of error: duplicate entry for key), so we
+      don't want to overwrite it with the filename.
+      What we want instead is add the filename to the current error message.
+    */
+    char *tmp= my_strdup(rli->last_error().message, MYF(MY_WME));
+    if (tmp)
+    {
+      rli->report(ERROR_LEVEL, rli->last_error().number,
+                  "%s. Failed executing load from '%s'", tmp, fname);
+      my_free(tmp);
+    }
+    goto err;
+  }
+  /*
+    We have an open file descriptor to the .info file; we need to close it
+    or Windows will refuse to delete the file in mysql_file_delete().
+  */
+  if (fd >= 0)
+  {
+    mysql_file_close(fd, MYF(0));
+    end_io_cache(&file);
+    fd= -1;
+  }
+  mysql_file_delete(key_file_log_event_info, fname, MYF(MY_WME));
+  memcpy(ext, ".data", 6);
+  mysql_file_delete(key_file_log_event_data, fname, MYF(MY_WME));
+  error = 0;
+
+err:
+  delete lev;
+  if (fd >= 0)
+  {
+    mysql_file_close(fd, MYF(0));
+    end_io_cache(&file);
+  }
+  return error;
+}
+
+#endif /* defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT) */
+
+
+/**************************************************************************
+	Begin_load_query_log_event methods
+**************************************************************************/
+
+#ifndef MYSQL_CLIENT
+Begin_load_query_log_event::
+Begin_load_query_log_event(THD* thd_arg, const char* db_arg, uchar* block_arg,
+                           uint block_len_arg, bool using_trans)
+  :Append_block_log_event(thd_arg, db_arg, block_arg, block_len_arg,
+                          using_trans)
+{
+   file_id= thd_arg->file_id= mysql_bin_log.next_file_id();
+}
+#endif
+
+
+Begin_load_query_log_event::
+Begin_load_query_log_event(const char* buf, uint len,
+                           const Format_description_log_event* desc_event)
+  :Append_block_log_event(buf, len, desc_event)
+{
+}
+
+
+#if defined( HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+int Begin_load_query_log_event::get_create_or_append() const
+{
+  return 1; /* create the file */
+}
+#endif /* defined( HAVE_REPLICATION) && !defined(MYSQL_CLIENT) */
+
+
+#if !defined(MYSQL_CLIENT) && defined(HAVE_REPLICATION)
+Log_event::enum_skip_reason
+Begin_load_query_log_event::do_shall_skip(Relay_log_info *rli)
+{
+  /*
+    If the slave skip counter is 1, then we should not start executing
+    on the next event.
+  */
+  return continue_group(rli);
+}
+#endif
+
+
+/**************************************************************************
+	Execute_load_query_log_event methods
+**************************************************************************/
+
+
+#ifndef MYSQL_CLIENT
+Execute_load_query_log_event::
+Execute_load_query_log_event(THD *thd_arg, const char* query_arg,
+                             ulong query_length_arg, uint fn_pos_start_arg,
+                             uint fn_pos_end_arg,
+                             enum_load_dup_handling dup_handling_arg,
+                             bool using_trans, bool direct, bool suppress_use,
+                             int errcode):
+  Query_log_event(thd_arg, query_arg, query_length_arg, using_trans, direct,
+                  suppress_use, errcode),
+  file_id(thd_arg->file_id), fn_pos_start(fn_pos_start_arg),
+  fn_pos_end(fn_pos_end_arg), dup_handling(dup_handling_arg)
+{
+}
+#endif /* !MYSQL_CLIENT */
+
+
+Execute_load_query_log_event::
+Execute_load_query_log_event(const char* buf, uint event_len,
+                             const Format_description_log_event* desc_event):
+  Query_log_event(buf, event_len, desc_event, EXECUTE_LOAD_QUERY_EVENT),
+  file_id(0), fn_pos_start(0), fn_pos_end(0)
+{
+  if (!Query_log_event::is_valid())
+    return;
+
+  buf+= desc_event->common_header_len;
+
+  fn_pos_start= uint4korr(buf + ELQ_FN_POS_START_OFFSET);
+  fn_pos_end= uint4korr(buf + ELQ_FN_POS_END_OFFSET);
+  dup_handling= (enum_load_dup_handling)(*(buf + ELQ_DUP_HANDLING_OFFSET));
+
+  if (fn_pos_start > q_len || fn_pos_end > q_len ||
+      dup_handling > LOAD_DUP_REPLACE)
+    return;
+
+  file_id= uint4korr(buf + ELQ_FILE_ID_OFFSET);
+}
+
+
+ulong Execute_load_query_log_event::get_post_header_size_for_derived()
+{
+  return EXECUTE_LOAD_QUERY_EXTRA_HEADER_LEN;
+}
+
+
+#ifndef MYSQL_CLIENT
+bool
+Execute_load_query_log_event::write_post_header_for_derived(IO_CACHE* file)
+{
+  uchar buf[EXECUTE_LOAD_QUERY_EXTRA_HEADER_LEN];
+  int4store(buf, file_id);
+  int4store(buf + 4, fn_pos_start);
+  int4store(buf + 4 + 4, fn_pos_end);
+  *(buf + 4 + 4 + 4)= (uchar) dup_handling;
+  return my_b_safe_write(file, buf, EXECUTE_LOAD_QUERY_EXTRA_HEADER_LEN);
+}
+#endif
+
+
+#ifdef MYSQL_CLIENT
+void Execute_load_query_log_event::print(FILE* file,
+                                         PRINT_EVENT_INFO* print_event_info)
+{
+  print(file, print_event_info, 0);
+}
+
+/**
+  Prints the query as LOAD DATA LOCAL and with rewritten filename.
+*/
+void Execute_load_query_log_event::print(FILE* file,
+                                         PRINT_EVENT_INFO* print_event_info,
+                                         const char *local_fname)
+{
+  Write_on_release_cache cache(&print_event_info->head_cache, file);
+
+  print_query_header(&cache, print_event_info);
+  /**
+    reduce the size of io cache so that the write function is called
+    for every call to my_b_printf().
+   */
+  DBUG_EXECUTE_IF ("simulate_execute_event_write_error",
+                   {(&cache)->write_pos= (&cache)->write_end;
+                   DBUG_SET("+d,simulate_file_write_error");});
+
+  if (local_fname)
+  {
+    my_b_write(&cache, (uchar*) query, fn_pos_start);
+    my_b_printf(&cache, " LOCAL INFILE ");
+    pretty_print_str(&cache, local_fname, strlen(local_fname));
+
+    if (dup_handling == LOAD_DUP_REPLACE)
+      my_b_printf(&cache, " REPLACE");
+    my_b_printf(&cache, " INTO");
+    my_b_write(&cache, (uchar*) query + fn_pos_end, q_len-fn_pos_end);
+    my_b_printf(&cache, "\n%s\n", print_event_info->delimiter);
+  }
+  else
+  {
+    my_b_write(&cache, (uchar*) query, q_len);
+    my_b_printf(&cache, "\n%s\n", print_event_info->delimiter);
+  }
+
+  if (!print_event_info->short_form)
+    my_b_printf(&cache, "# file_id: %d \n", file_id);
+}
+#endif
+
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+void Execute_load_query_log_event::pack_info(Protocol *protocol)
+{
+  char *buf, *pos;
+  if (!(buf= (char*) my_malloc(9 + (db_len * 2) + 2 + q_len + 10 + 21,
+                               MYF(MY_WME))))
+    return;
+  pos= buf;
+  if (db && db_len)
+  {
+    /*
+      Statically allocates room to store '\0' and an identifier
+      that may have NAME_LEN * 2 due to quoting and there are
+      two quoting characters that wrap them.
+    */
+    char quoted_db[1 + NAME_LEN * 2 + 2];// quoted length of the identifier
+    size_t size= 0;
+    size= my_strmov_quoted_identifier(this->thd, quoted_db, db, 0);
+    pos= strmov(buf, "use ");
+    memcpy(pos, quoted_db, size);
+    pos= strmov(pos + size, "; ");
+  }
+  if (query && q_len)
+  {
+    memcpy(pos, query, q_len);
+    pos+= q_len;
+  }
+  pos= strmov(pos, " ;file_id=");
+  pos= int10_to_str((long) file_id, pos, 10);
+  protocol->store(buf, pos-buf, &my_charset_bin);
+  my_free(buf);
+}
+
+
+int
+Execute_load_query_log_event::do_apply_event(Relay_log_info const *rli)
+{
+  char *p;
+  char *buf;
+  char *fname;
+  char *fname_end;
+  int error;
+
+  buf= (char*) my_malloc(q_len + 1 - (fn_pos_end - fn_pos_start) +
+                         (FN_REFLEN + 10) + 10 + 8 + 5, MYF(MY_WME));
+
+  DBUG_EXECUTE_IF("LOAD_DATA_INFILE_has_fatal_error", my_free(buf); buf= NULL;);
+
+  /* Replace filename and LOCAL keyword in query before executing it */
+  if (buf == NULL)
+  {
+    rli->report(ERROR_LEVEL, ER_SLAVE_FATAL_ERROR,
+                ER(ER_SLAVE_FATAL_ERROR), "Not enough memory");
+    return 1;
+  }
+
+  p= buf;
+  memcpy(p, query, fn_pos_start);
+  p+= fn_pos_start;
+  fname= (p= strmake(p, STRING_WITH_LEN(" INFILE \'")));
+  p= slave_load_file_stem(p, file_id, server_id, ".data");
+  fname_end= p= strend(p);                      // Safer than p=p+5
+  *(p++)='\'';
+  switch (dup_handling) {
+  case LOAD_DUP_IGNORE:
+    p= strmake(p, STRING_WITH_LEN(" IGNORE"));
+    break;
+  case LOAD_DUP_REPLACE:
+    p= strmake(p, STRING_WITH_LEN(" REPLACE"));
+    break;
+  default:
+    /* Ordinary load data */
+    break;
+  }
+  p= strmake(p, STRING_WITH_LEN(" INTO "));
+  p= strmake(p, query+fn_pos_end, q_len-fn_pos_end);
+
+  error= Query_log_event::do_apply_event(rli, buf, p-buf);
+
+  /* Forging file name for deletion in same buffer */
+  *fname_end= 0;
+
+  /*
+    If there was an error the slave is going to stop, leave the
+    file so that we can re-execute this event at START SLAVE.
+  */
+  if (!error)
+    mysql_file_delete(key_file_log_event_data, fname, MYF(MY_WME));
+
+  my_free(buf);
+  return error;
+}
+#endif
+
+
+/**************************************************************************
+	sql_ex_info methods
+**************************************************************************/
+
+/*
+  sql_ex_info::write_data()
+*/
+
+bool sql_ex_info::write_data(IO_CACHE* file)
+{
+  if (new_format())
+  {
+    return (write_str(file, field_term, (uint) field_term_len) ||
+	    write_str(file, enclosed,   (uint) enclosed_len) ||
+	    write_str(file, line_term,  (uint) line_term_len) ||
+	    write_str(file, line_start, (uint) line_start_len) ||
+	    write_str(file, escaped,    (uint) escaped_len) ||
+	    my_b_safe_write(file,(uchar*) &opt_flags,1));
+  }
+  else
+  {
+    /**
+      @todo This is sensitive to field padding. We should write a
+      char[7], not an old_sql_ex. /sven
+    */
+    old_sql_ex old_ex;
+    old_ex.field_term= *field_term;
+    old_ex.enclosed=   *enclosed;
+    old_ex.line_term=  *line_term;
+    old_ex.line_start= *line_start;
+    old_ex.escaped=    *escaped;
+    old_ex.opt_flags=  opt_flags;
+    old_ex.empty_flags=empty_flags;
+    return my_b_safe_write(file, (uchar*) &old_ex, sizeof(old_ex)) != 0;
+  }
+}
+
+
+/*
+  sql_ex_info::init()
+*/
+
+const char *sql_ex_info::init(const char *buf, const char *buf_end,
+                              bool use_new_format)
+{
+  cached_new_format = use_new_format;
+  if (use_new_format)
+  {
+    empty_flags=0;
+    /*
+      The code below assumes that buf will not disappear from
+      under our feet during the lifetime of the event. This assumption
+      holds true in the slave thread if the log is in new format, but is not
+      the case when we have old format because we will be reusing net buffer
+      to read the actual file before we write out the Create_file event.
+    */
+    if (read_str(&buf, buf_end, &field_term, &field_term_len) ||
+        read_str(&buf, buf_end, &enclosed,   &enclosed_len) ||
+        read_str(&buf, buf_end, &line_term,  &line_term_len) ||
+        read_str(&buf, buf_end, &line_start, &line_start_len) ||
+        read_str(&buf, buf_end, &escaped,    &escaped_len))
+      return 0;
+    opt_flags = *buf++;
+  }
+  else
+  {
+    field_term_len= enclosed_len= line_term_len= line_start_len= escaped_len=1;
+    field_term = buf++;			// Use first byte in string
+    enclosed=	 buf++;
+    line_term=   buf++;
+    line_start=  buf++;
+    escaped=     buf++;
+    opt_flags =  *buf++;
+    empty_flags= *buf++;
+    if (empty_flags & FIELD_TERM_EMPTY)
+      field_term_len=0;
+    if (empty_flags & ENCLOSED_EMPTY)
+      enclosed_len=0;
+    if (empty_flags & LINE_TERM_EMPTY)
+      line_term_len=0;
+    if (empty_flags & LINE_START_EMPTY)
+      line_start_len=0;
+    if (empty_flags & ESCAPED_EMPTY)
+      escaped_len=0;
+  }
+  return buf;
+}
+
+
+/**************************************************************************
+	Rows_log_event member functions
+**************************************************************************/
+
+#ifndef MYSQL_CLIENT
+Rows_log_event::Rows_log_event(THD *thd_arg, TABLE *tbl_arg, ulong tid,
+                               MY_BITMAP const *cols, bool is_transactional)
+  : Log_event(thd_arg, 0, is_transactional),
+    m_row_count(0),
+    m_table(tbl_arg),
+    m_table_id(tid),
+    m_width(tbl_arg ? tbl_arg->s->fields : 1),
+    m_rows_buf(0), m_rows_cur(0), m_rows_end(0), m_flags(0) 
+#ifdef HAVE_REPLICATION
+    , m_curr_row(NULL), m_curr_row_end(NULL), m_key(NULL)
+#endif
+{
+  /*
+    We allow a special form of dummy event when the table, and cols
+    are null and the table id is ~0UL.  This is a temporary
+    solution, to be able to terminate a started statement in the
+    binary log: the extraneous events will be removed in the future.
+   */
+  DBUG_ASSERT((tbl_arg && tbl_arg->s && tid != ~0UL) ||
+              (!tbl_arg && !cols && tid == ~0UL));
+
+  if (thd_arg->variables.option_bits & OPTION_NO_FOREIGN_KEY_CHECKS)
+      set_flags(NO_FOREIGN_KEY_CHECKS_F);
+  if (thd_arg->variables.option_bits & OPTION_RELAXED_UNIQUE_CHECKS)
+      set_flags(RELAXED_UNIQUE_CHECKS_F);
+  /* if bitmap_init fails, caught in is_valid() */
+  if (likely(!bitmap_init(&m_cols,
+                          m_width <= sizeof(m_bitbuf)*8 ? m_bitbuf : NULL,
+                          m_width,
+                          false)))
+  {
+    /* Cols can be zero if this is a dummy binrows event */
+    if (likely(cols != NULL))
+    {
+      memcpy(m_cols.bitmap, cols->bitmap, no_bytes_in_map(cols));
+      create_last_word_mask(&m_cols);
+    }
+  }
+  else
+  {
+    // Needed because bitmap_init() does not set it to null on failure
+    m_cols.bitmap= 0;
+  }
+}
+#endif
+
+Rows_log_event::Rows_log_event(const char *buf, uint event_len,
+                               Log_event_type event_type,
+                               const Format_description_log_event
+                               *description_event)
+  : Log_event(buf, description_event),
+    m_row_count(0),
+#ifndef MYSQL_CLIENT
+    m_table(NULL),
+#endif
+    m_table_id(0), m_rows_buf(0), m_rows_cur(0), m_rows_end(0)
+#if !defined(MYSQL_CLIENT) && defined(HAVE_REPLICATION)
+    , m_curr_row(NULL), m_curr_row_end(NULL), m_key(NULL)
+#endif
+{
+  DBUG_ENTER("Rows_log_event::Rows_log_event(const char*,...)");
+  uint8 const common_header_len= description_event->common_header_len;
+  uint8 const post_header_len= description_event->post_header_len[event_type-1];
+
+  DBUG_PRINT("enter",("event_len: %u  common_header_len: %d  "
+		      "post_header_len: %d",
+		      event_len, common_header_len,
+		      post_header_len));
+
+  const char *post_start= buf + common_header_len;
+  post_start+= RW_MAPID_OFFSET;
+  if (post_header_len == 6)
+  {
+    /* Master is of an intermediate source tree before 5.1.4. Id is 4 bytes */
+    m_table_id= uint4korr(post_start);
+    post_start+= 4;
+  }
+  else
+  {
+    m_table_id= (ulong) uint6korr(post_start);
+    post_start+= RW_FLAGS_OFFSET;
+  }
+
+  m_flags= uint2korr(post_start);
+
+  uchar const *const var_start=
+    (const uchar *)buf + common_header_len + post_header_len;
+  uchar const *const ptr_width= var_start;
+  uchar *ptr_after_width= (uchar*) ptr_width;
+  DBUG_PRINT("debug", ("Reading from %p", ptr_after_width));
+  m_width = net_field_length(&ptr_after_width);
+  DBUG_PRINT("debug", ("m_width=%lu", m_width));
+  /* Avoid reading out of buffer */
+  if (static_cast<unsigned int>((ptr_after_width +
+                                 (m_width + 7) / 8) -
+                                 (uchar*)buf) > event_len)
+  {
+    m_cols.bitmap= NULL;
+    DBUG_VOID_RETURN;
+  }
+
+  /* if bitmap_init fails, catched in is_valid() */
+  if (likely(!bitmap_init(&m_cols,
+                          m_width <= sizeof(m_bitbuf)*8 ? m_bitbuf : NULL,
+                          m_width,
+                          false)))
+  {
+    DBUG_PRINT("debug", ("Reading from %p", ptr_after_width));
+    memcpy(m_cols.bitmap, ptr_after_width, (m_width + 7) / 8);
+    create_last_word_mask(&m_cols);
+    ptr_after_width+= (m_width + 7) / 8;
+    DBUG_DUMP("m_cols", (uchar*) m_cols.bitmap, no_bytes_in_map(&m_cols));
+  }
+  else
+  {
+    // Needed because bitmap_init() does not set it to null on failure
+    m_cols.bitmap= NULL;
+    DBUG_VOID_RETURN;
+  }
+
+  m_cols_ai.bitmap= m_cols.bitmap; /* See explanation in is_valid() */
+
+  if (event_type == UPDATE_ROWS_EVENT)
+  {
+    DBUG_PRINT("debug", ("Reading from %p", ptr_after_width));
+
+    /* if bitmap_init fails, caught in is_valid() */
+    if (likely(!bitmap_init(&m_cols_ai,
+                            m_width <= sizeof(m_bitbuf_ai)*8 ? m_bitbuf_ai : NULL,
+                            m_width,
+                            false)))
+    {
+      DBUG_PRINT("debug", ("Reading from %p", ptr_after_width));
+      memcpy(m_cols_ai.bitmap, ptr_after_width, (m_width + 7) / 8);
+      create_last_word_mask(&m_cols_ai);
+      ptr_after_width+= (m_width + 7) / 8;
+      DBUG_DUMP("m_cols_ai", (uchar*) m_cols_ai.bitmap,
+                no_bytes_in_map(&m_cols_ai));
+    }
+    else
+    {
+      // Needed because bitmap_init() does not set it to null on failure
+      m_cols_ai.bitmap= 0;
+      DBUG_VOID_RETURN;
+    }
+  }
+
+  const uchar* const ptr_rows_data= (const uchar*) ptr_after_width;
+
+  size_t const read_size= ptr_rows_data - (const unsigned char *) buf;
+  if (read_size > event_len)
+  {
+    DBUG_VOID_RETURN;
+  }
+  size_t const data_size= event_len - read_size;
+  DBUG_PRINT("info",("m_table_id: %lu  m_flags: %d  m_width: %lu  data_size: %lu",
+                     m_table_id, m_flags, m_width, (ulong) data_size));
+
+  m_rows_buf= (uchar*) my_malloc(data_size, MYF(MY_WME));
+  if (likely((bool)m_rows_buf))
+  {
+#if !defined(MYSQL_CLIENT) && defined(HAVE_REPLICATION)
+    m_curr_row= m_rows_buf;
+#endif
+    m_rows_end= m_rows_buf + data_size;
+    m_rows_cur= m_rows_end;
+    memcpy(m_rows_buf, ptr_rows_data, data_size);
+  }
+  else
+    m_cols.bitmap= 0; // to not free it
+
+  DBUG_VOID_RETURN;
+}
+
+Rows_log_event::~Rows_log_event()
+{
+  if (m_cols.bitmap == m_bitbuf) // no my_malloc happened
+    m_cols.bitmap= 0; // so no my_free in bitmap_free
+  bitmap_free(&m_cols); // To pair with bitmap_init().
+  my_free(m_rows_buf);
+}
+
+int Rows_log_event::get_data_size()
+{
+  int const type_code= get_type_code();
+
+  uchar buf[sizeof(m_width) + 1];
+  uchar *end= net_store_length(buf, m_width);
+
+  DBUG_EXECUTE_IF("old_row_based_repl_4_byte_map_id_master",
+                  return 6 + no_bytes_in_map(&m_cols) + (end - buf) +
+                  (type_code == UPDATE_ROWS_EVENT ? no_bytes_in_map(&m_cols_ai) : 0) +
+                  (m_rows_cur - m_rows_buf););
+  int data_size= ROWS_HEADER_LEN;
+  data_size+= no_bytes_in_map(&m_cols);
+  data_size+= (uint) (end - buf);
+
+  if (type_code == UPDATE_ROWS_EVENT)
+    data_size+= no_bytes_in_map(&m_cols_ai);
+
+  data_size+= (uint) (m_rows_cur - m_rows_buf);
+  return data_size; 
+}
+
+
+#ifndef MYSQL_CLIENT
+int Rows_log_event::do_add_row_data(uchar *row_data, size_t length)
+{
+  /*
+    When the table has a primary key, we would probably want, by default, to
+    log only the primary key value instead of the entire "before image". This
+    would save binlog space. TODO
+  */
+  DBUG_ENTER("Rows_log_event::do_add_row_data");
+  DBUG_PRINT("enter", ("row_data: 0x%lx  length: %lu", (ulong) row_data,
+                       (ulong) length));
+  /*
+    Don't print debug messages when running valgrind since they can
+    trigger false warnings.
+   */
+#ifndef HAVE_purify
+  DBUG_DUMP("row_data", row_data, min(length, 32));
+#endif
+
+  DBUG_ASSERT(m_rows_buf <= m_rows_cur);
+  DBUG_ASSERT(!m_rows_buf || (m_rows_end && m_rows_buf < m_rows_end));
+  DBUG_ASSERT(m_rows_cur <= m_rows_end);
+
+  /* The cast will always work since m_rows_cur <= m_rows_end */
+  if (static_cast<size_t>(m_rows_end - m_rows_cur) <= length)
+  {
+    size_t const block_size= 1024;
+    ulong cur_size= m_rows_cur - m_rows_buf;
+    DBUG_EXECUTE_IF("simulate_too_big_row_case1",
+                     cur_size= UINT_MAX32 - (block_size * 10);
+                     length= UINT_MAX32 - (block_size * 10););
+    DBUG_EXECUTE_IF("simulate_too_big_row_case2",
+                     cur_size= UINT_MAX32 - (block_size * 10);
+                     length= block_size * 10;);
+    DBUG_EXECUTE_IF("simulate_too_big_row_case3",
+                     cur_size= block_size * 10;
+                     length= UINT_MAX32 - (block_size * 10););
+    DBUG_EXECUTE_IF("simulate_too_big_row_case4",
+                     cur_size= UINT_MAX32 - (block_size * 10);
+                     length= (block_size * 10) - block_size + 1;);
+    ulong remaining_space= UINT_MAX32 - cur_size;
+    /* Check that the new data fits within remaining space and we can add
+       block_size without wrapping.
+     */
+    if (length > remaining_space ||
+        ((length + block_size) > remaining_space))
+    {
+      sql_print_error("The row data is greater than 4GB, which is too big to "
+                      "write to the binary log.");
+      DBUG_RETURN(ER_BINLOG_ROW_LOGGING_FAILED);
+    }
+    ulong const new_alloc= 
+        block_size * ((cur_size + length + block_size - 1) / block_size);
+
+    uchar* const new_buf= (uchar*)my_realloc((uchar*)m_rows_buf, (uint) new_alloc,
+                                           MYF(MY_ALLOW_ZERO_PTR|MY_WME));
+    if (unlikely(!new_buf))
+      DBUG_RETURN(HA_ERR_OUT_OF_MEM);
+
+    /* If the memory moved, we need to move the pointers */
+    if (new_buf != m_rows_buf)
+    {
+      m_rows_buf= new_buf;
+      m_rows_cur= m_rows_buf + cur_size;
+    }
+
+    /*
+       The end pointer should always be changed to point to the end of
+       the allocated memory.
+    */
+    m_rows_end= m_rows_buf + new_alloc;
+  }
+
+  DBUG_ASSERT(m_rows_cur + length <= m_rows_end);
+  memcpy(m_rows_cur, row_data, length);
+  m_rows_cur+= length;
+  m_row_count++;
+  DBUG_RETURN(0);
+}
+#endif
+
+#if !defined(MYSQL_CLIENT) && defined(HAVE_REPLICATION)
+int Rows_log_event::do_apply_event(Relay_log_info const *rli)
+{
+  DBUG_ENTER("Rows_log_event::do_apply_event(Relay_log_info*)");
+  int error= 0;
+  /*
+    If m_table_id == ~0UL, then we have a dummy event that does not
+    contain any data.  In that case, we just remove all tables in the
+    tables_to_lock list, close the thread tables, and return with
+    success.
+   */
+  if (m_table_id == ~0UL)
+  {
+    /*
+       This one is supposed to be set: just an extra check so that
+       nothing strange has happened.
+     */
+    DBUG_ASSERT(get_flags(STMT_END_F));
+
+    const_cast<Relay_log_info*>(rli)->slave_close_thread_tables(thd);
+    thd->clear_error();
+    DBUG_RETURN(0);
+  }
+
+  /*
+    'thd' has been set by exec_relay_log_event(), just before calling
+    do_apply_event(). We still check here to prevent future coding
+    errors.
+  */
+  DBUG_ASSERT(rli->sql_thd == thd);
+
+  /*
+    If there is no locks taken, this is the first binrow event seen
+    after the table map events.  We should then lock all the tables
+    used in the transaction and proceed with execution of the actual
+    event.
+  */
+  if (!thd->lock)
+  {
+    /*
+      Lock_tables() reads the contents of thd->lex, so they must be
+      initialized.
+
+      We also call the mysql_reset_thd_for_next_command(), since this
+      is the logical start of the next "statement". Note that this
+      call might reset the value of current_stmt_binlog_format, so
+      we need to do any changes to that value after this function.
+    */
+    lex_start(thd);
+    mysql_reset_thd_for_next_command(thd);
+    /*
+      The current statement is just about to begin and 
+      has not yet modified anything. Note, all.modified is reset
+      by mysql_reset_thd_for_next_command.
+    */
+    thd->transaction.stmt.modified_non_trans_table= FALSE;
+    /*
+      This is a row injection, so we flag the "statement" as
+      such. Note that this code is called both when the slave does row
+      injections and when the BINLOG statement is used to do row
+      injections.
+    */
+    thd->lex->set_stmt_row_injection();
+
+    /*
+      There are a few flags that are replicated with each row event.
+      Make sure to set/clear them before executing the main body of
+      the event.
+    */
+    if (get_flags(NO_FOREIGN_KEY_CHECKS_F))
+        thd->variables.option_bits|= OPTION_NO_FOREIGN_KEY_CHECKS;
+    else
+        thd->variables.option_bits&= ~OPTION_NO_FOREIGN_KEY_CHECKS;
+
+    if (get_flags(RELAXED_UNIQUE_CHECKS_F))
+        thd->variables.option_bits|= OPTION_RELAXED_UNIQUE_CHECKS;
+    else
+        thd->variables.option_bits&= ~OPTION_RELAXED_UNIQUE_CHECKS;
+    /* A small test to verify that objects have consistent types */
+    DBUG_ASSERT(sizeof(thd->variables.option_bits) == sizeof(OPTION_RELAXED_UNIQUE_CHECKS));
+
+    if (open_and_lock_tables(thd, rli->tables_to_lock, FALSE, 0))
+    {
+      uint actual_error= thd->stmt_da->sql_errno();
+      if (thd->is_slave_error || thd->is_fatal_error)
+      {
+        /*
+          Error reporting borrowed from Query_log_event with many excessive
+          simplifications. 
+          We should not honour --slave-skip-errors at this point as we are
+          having severe errors which should not be skiped.
+        */
+        rli->report(ERROR_LEVEL, actual_error,
+                    "Error executing row event: '%s'",
+                    (actual_error ? thd->stmt_da->message() :
+                     "unexpected success or fatal error"));
+        thd->is_slave_error= 1;
+      }
+      const_cast<Relay_log_info*>(rli)->slave_close_thread_tables(thd);
+      DBUG_RETURN(actual_error);
+    }
+
+    /*
+      When the open and locking succeeded, we check all tables to
+      ensure that they still have the correct type.
+    */
+
+    {
+      DBUG_PRINT("debug", ("Checking compability of tables to lock - tables_to_lock: %p",
+                           rli->tables_to_lock));
+
+      /**
+        When using RBR and MyISAM MERGE tables the base tables that make
+        up the MERGE table can be appended to the list of tables to lock.
+  
+        Thus, we just check compatibility for those that tables that have
+        a correspondent table map event (ie, those that are actually going
+        to be accessed while applying the event). That's why the loop stops
+        at rli->tables_to_lock_count .
+
+        NOTE: The base tables are added here are removed when 
+              close_thread_tables is called.
+       */
+      TABLE_LIST *table_list_ptr= rli->tables_to_lock;
+      for (uint i=0 ; table_list_ptr && (i < rli->tables_to_lock_count);
+           table_list_ptr= table_list_ptr->next_global, i++)
+      {
+        /*
+          Below if condition takes care of skipping base tables that
+          make up the MERGE table (which are added by open_tables()
+          call). They are added next to the merge table in the list.
+          For eg: If RPL_TABLE_LIST is t3->t1->t2 (where t1 and t2
+          are base tables for merge table 't3'), open_tables will modify
+          the list by adding t1 and t2 again immediately after t3 in the
+          list (*not at the end of the list*). New table_to_lock list will
+          look like t3->t1'->t2'->t1->t2 (where t1' and t2' are TABLE_LIST
+          objects added by open_tables() call). There is no flag(or logic) in
+          open_tables() that can skip adding these base tables to the list.
+          So the logic here should take care of skipping them.
+
+          tables_to_lock_count logic will take care of skipping base tables
+          that are added at the end of the list.
+          For eg: If RPL_TABLE_LIST is t1->t2->t3, open_tables will modify
+          the list into t1->t2->t3->t1'->t2'. t1' and t2' will be skipped
+          because tables_to_lock_count logic in this for loop.
+        */
+        if (table_list_ptr->parent_l)
+          continue;
+        /*
+          We can use a down cast here since we know that every table added
+          to the tables_to_lock is a RPL_TABLE_LIST (or child table which is
+          skipped above).
+        */
+        RPL_TABLE_LIST *ptr= static_cast<RPL_TABLE_LIST*>(table_list_ptr);
+        DBUG_ASSERT(ptr->m_tabledef_valid);
+        TABLE *conv_table;
+        if (!ptr->m_tabledef.compatible_with(thd, const_cast<Relay_log_info*>(rli),
+                                             ptr->table, &conv_table))
+        {
+          DBUG_PRINT("debug", ("Table: %s.%s is not compatible with master",
+                               ptr->table->s->db.str,
+                               ptr->table->s->table_name.str));
+          /*
+            We should not honour --slave-skip-errors at this point as we are
+            having severe errors which should not be skiped.
+          */
+          thd->is_slave_error= 1;
+          const_cast<Relay_log_info*>(rli)->slave_close_thread_tables(thd);
+          DBUG_RETURN(ERR_BAD_TABLE_DEF);
+        }
+        DBUG_PRINT("debug", ("Table: %s.%s is compatible with master"
+                             " - conv_table: %p",
+                             ptr->table->s->db.str,
+                             ptr->table->s->table_name.str, conv_table));
+        ptr->m_conv_table= conv_table;
+      }
+    }
+
+    /*
+      ... and then we add all the tables to the table map and but keep
+      them in the tables to lock list.
+
+      We also invalidate the query cache for all the tables, since
+      they will now be changed.
+
+      TODO [/Matz]: Maybe the query cache should not be invalidated
+      here? It might be that a table is not changed, even though it
+      was locked for the statement.  We do know that each
+      Rows_log_event contain at least one row, so after processing one
+      Rows_log_event, we can invalidate the query cache for the
+      associated table.
+     */
+    TABLE_LIST *ptr= rli->tables_to_lock;
+    for (uint i=0 ;  ptr && (i < rli->tables_to_lock_count); ptr= ptr->next_global, i++)
+    {
+      /*
+        Please see comment in above 'for' loop to know the reason
+        for this if condition
+      */
+      if (ptr->parent_l)
+        continue;
+      const_cast<Relay_log_info*>(rli)->m_table_map.set_table(ptr->table_id, ptr->table);
+    }
+
+#ifdef HAVE_QUERY_CACHE
+    query_cache.invalidate_locked_for_write(rli->tables_to_lock);
+#endif
+  }
+
+  TABLE* 
+    table= 
+    m_table= const_cast<Relay_log_info*>(rli)->m_table_map.get_table(m_table_id);
+
+  DBUG_PRINT("debug", ("m_table: 0x%lx, m_table_id: %lu", (ulong) m_table, m_table_id));
+
+  /*
+    A row event comprising of a P_S table
+    - should not be replicated (i.e executed) by the slave SQL thread.
+    - should not be executed by the client in the  form BINLOG '...' stmts.
+  */
+  if (table && table->s->table_category == TABLE_CATEGORY_PERFORMANCE)
+    table= NULL;
+
+  if (table)
+  {
+    bool transactional_table= table->file->has_transactions();
+    /*
+      table == NULL means that this table should not be replicated
+      (this was set up by Table_map_log_event::do_apply_event()
+      which tested replicate-* rules).
+    */
+
+    /*
+      It's not needed to set_time() but
+      1) it continues the property that "Time" in SHOW PROCESSLIST shows how
+      much slave is behind
+      2) it will be needed when we allow replication from a table with no
+      TIMESTAMP column to a table with one.
+      So we call set_time(), like in SBR. Presently it changes nothing.
+    */
+    thd->set_time((time_t)when);
+
+    /*
+      Now we are in a statement and will stay in a statement until we
+      see a STMT_END_F.
+
+      We set this flag here, before actually applying any rows, in
+      case the SQL thread is stopped and we need to detect that we're
+      inside a statement and halting abruptly might cause problems
+      when restarting.
+     */
+    const_cast<Relay_log_info*>(rli)->set_flag(Relay_log_info::IN_STMT);
+
+     if ( m_width == table->s->fields && bitmap_is_set_all(&m_cols))
+      set_flags(COMPLETE_ROWS_F);
+
+    /* 
+      Set tables write and read sets.
+      
+      Read_set contains all slave columns (in case we are going to fetch
+      a complete record from slave)
+      
+      Write_set equals the m_cols bitmap sent from master but it can be 
+      longer if slave has extra columns. 
+     */ 
+
+    DBUG_PRINT_BITSET("debug", "Setting table's write_set from: %s", &m_cols);
+    
+    bitmap_set_all(table->read_set);
+    bitmap_set_all(table->write_set);
+    if (!get_flags(COMPLETE_ROWS_F))
+      bitmap_intersect(table->write_set,&m_cols);
+
+    this->slave_exec_mode= slave_exec_mode_options; // fix the mode
+
+    // Do event specific preparations 
+    error= do_before_row_operations(rli);
+
+    /*
+      Bug#56662 Assertion failed: next_insert_id == 0, file handler.cc
+      Don't allow generation of auto_increment value when processing
+      rows event by setting 'MODE_NO_AUTO_VALUE_ON_ZERO'. The exception
+      to this rule happens when the auto_inc column exists on some
+      extra columns on the slave. In that case, do not force
+      MODE_NO_AUTO_VALUE_ON_ZERO.
+    */
+    ulong saved_sql_mode= thd->variables.sql_mode;
+    if (!is_auto_inc_in_extra_columns())
+      thd->variables.sql_mode= MODE_NO_AUTO_VALUE_ON_ZERO;
+
+    // row processing loop
+
+    /* 
+      set the initial time of this ROWS statement if it was not done
+      before in some other ROWS event. 
+     */
+    const_cast<Relay_log_info*>(rli)->set_row_stmt_start_timestamp();
+
+    while (error == 0 && m_curr_row < m_rows_end)
+    {
+      /* in_use can have been set to NULL in close_tables_for_reopen */
+      THD* old_thd= table->in_use;
+      if (!table->in_use)
+        table->in_use= thd;
+
+      error= do_exec_row(rli);
+
+      if (error)
+        DBUG_PRINT("info", ("error: %s", HA_ERR(error)));
+      DBUG_ASSERT(error != HA_ERR_RECORD_DELETED);
+
+      table->in_use = old_thd;
+
+      if (error)
+      {
+        int actual_error= convert_handler_error(error, thd, table);
+        bool idempotent_error= (idempotent_error_code(error) &&
+                               (slave_exec_mode == SLAVE_EXEC_MODE_IDEMPOTENT));
+        bool ignored_error= (idempotent_error == 0 ?
+                             ignored_error_code(actual_error) : 0);
+
+        if (idempotent_error || ignored_error)
+        {
+          if (global_system_variables.log_warnings)
+            slave_rows_error_report(WARNING_LEVEL, error, rli, thd, table,
+                                    get_type_str(),
+                                    RPL_LOG_NAME, (ulong) log_pos);
+          clear_all_errors(thd, const_cast<Relay_log_info*>(rli));
+          error= 0;
+          if (idempotent_error == 0)
+            break;
+        }
+      }
+
+      /*
+       If m_curr_row_end  was not set during event execution (e.g., because
+       of errors) we can't proceed to the next row. If the error is transient
+       (i.e., error==0 at this point) we must call unpack_current_row() to set 
+       m_curr_row_end.
+      */ 
+   
+      DBUG_PRINT("info", ("curr_row: 0x%lu; curr_row_end: 0x%lu; rows_end: 0x%lu",
+                          (ulong) m_curr_row, (ulong) m_curr_row_end, (ulong) m_rows_end));
+
+      if (!m_curr_row_end && !error)
+        error= unpack_current_row(rli);
+  
+      // at this moment m_curr_row_end should be set
+      DBUG_ASSERT(error || m_curr_row_end != NULL); 
+      DBUG_ASSERT(error || m_curr_row < m_curr_row_end);
+      DBUG_ASSERT(error || m_curr_row_end <= m_rows_end);
+  
+      m_curr_row= m_curr_row_end;
+ 
+      if (error == 0 && !transactional_table)
+        thd->transaction.all.modified_non_trans_table=
+          thd->transaction.stmt.modified_non_trans_table= TRUE;
+    } // row processing loop
+
+    /*
+      Restore the sql_mode after the rows event is processed.
+    */
+    thd->variables.sql_mode= saved_sql_mode;
+
+    {/**
+         The following failure injecion works in cooperation with tests 
+         setting @@global.debug= 'd,stop_slave_middle_group'.
+         The sql thread receives the killed status and will proceed 
+         to shutdown trying to finish incomplete events group.
+     */
+      DBUG_EXECUTE_IF("stop_slave_middle_group",
+                      if (thd->transaction.all.modified_non_trans_table)
+                        const_cast<Relay_log_info*>(rli)->abort_slave= 1;);
+    }
+
+    if ((error= do_after_row_operations(rli, error)) &&
+        ignored_error_code(convert_handler_error(error, thd, table)))
+    {
+
+      if (global_system_variables.log_warnings)
+        slave_rows_error_report(WARNING_LEVEL, error, rli, thd, table,
+                                get_type_str(),
+                                RPL_LOG_NAME, (ulong) log_pos);
+      clear_all_errors(thd, const_cast<Relay_log_info*>(rli));
+      error= 0;
+    }
+  } // if (table)
+
+  
+  if (error)
+  {
+    slave_rows_error_report(ERROR_LEVEL, error, rli, thd, table,
+                             get_type_str(),
+                             RPL_LOG_NAME, (ulong) log_pos);
+    /*
+      @todo We should probably not call
+      reset_current_stmt_binlog_format_row() from here.
+
+      Note: this applies to log_event_old.cc too.
+      /Sven
+    */
+    thd->reset_current_stmt_binlog_format_row();
+    thd->is_slave_error= 1;
+    DBUG_RETURN(error);
+  }
+
+  if (get_flags(STMT_END_F) && (error= rows_event_stmt_cleanup(rli, thd)))
+    slave_rows_error_report(ERROR_LEVEL,
+                            thd->is_error() ? 0 : error,
+                            rli, thd, table,
+                            get_type_str(),
+                            RPL_LOG_NAME, (ulong) log_pos);
+  DBUG_RETURN(error);
+}
+
+Log_event::enum_skip_reason
+Rows_log_event::do_shall_skip(Relay_log_info *rli)
+{
+  /*
+    If the slave skip counter is 1 and this event does not end a
+    statement, then we should not start executing on the next event.
+    Otherwise, we defer the decision to the normal skipping logic.
+  */
+  if (rli->slave_skip_counter == 1 && !get_flags(STMT_END_F))
+    return Log_event::EVENT_SKIP_IGNORE;
+  else
+    return Log_event::do_shall_skip(rli);
+}
+
+/**
+   The function is called at Rows_log_event statement commit time,
+   normally from Rows_log_event::do_update_pos() and possibly from
+   Query_log_event::do_apply_event() of the COMMIT.
+   The function commits the last statement for engines, binlog and
+   releases resources have been allocated for the statement.
+  
+   @retval  0         Ok.
+   @retval  non-zero  Error at the commit.
+ */
+
+static int rows_event_stmt_cleanup(Relay_log_info const *rli, THD * thd)
+{
+  int error;
+  {
+    /*
+      This is the end of a statement or transaction, so close (and
+      unlock) the tables we opened when processing the
+      Table_map_log_event starting the statement.
+
+      OBSERVER.  This will clear *all* mappings, not only those that
+      are open for the table. There is not good handle for on-close
+      actions for tables.
+
+      NOTE. Even if we have no table ('table' == 0) we still need to be
+      here, so that we increase the group relay log position. If we didn't, we
+      could have a group relay log position which lags behind "forever"
+      (assume the last master's transaction is ignored by the slave because of
+      replicate-ignore rules).
+    */
+    error= thd->binlog_flush_pending_rows_event(TRUE);
+
+    /*
+      If this event is not in a transaction, the call below will, if some
+      transactional storage engines are involved, commit the statement into
+      them and flush the pending event to binlog.
+      If this event is in a transaction, the call will do nothing, but a
+      Xid_log_event will come next which will, if some transactional engines
+      are involved, commit the transaction and flush the pending event to the
+      binlog.
+      If there was a deadlock the transaction should have been rolled back
+      already. So there should be no need to rollback the transaction.
+    */
+    DBUG_ASSERT(! thd->transaction_rollback_request);
+    error|= (error ? trans_rollback_stmt(thd) : trans_commit_stmt(thd));
+
+    /*
+      Now what if this is not a transactional engine? we still need to
+      flush the pending event to the binlog; we did it with
+      thd->binlog_flush_pending_rows_event(). Note that we imitate
+      what is done for real queries: a call to
+      ha_autocommit_or_rollback() (sometimes only if involves a
+      transactional engine), and a call to be sure to have the pending
+      event flushed.
+    */
+
+    /*
+      @todo We should probably not call
+      reset_current_stmt_binlog_format_row() from here.
+
+      Note: this applies to log_event_old.cc too
+
+      Btw, the previous comment about transactional engines does not
+      seem related to anything that happens here.
+      /Sven
+    */
+    thd->reset_current_stmt_binlog_format_row();
+
+    const_cast<Relay_log_info*>(rli)->cleanup_context(thd, 0);
+  }
+  return error;
+}
+
+/**
+   The method either increments the relay log position or
+   commits the current statement and increments the master group 
+   possition if the event is STMT_END_F flagged and
+   the statement corresponds to the autocommit query (i.e replicated
+   without wrapping in BEGIN/COMMIT)
+
+   @retval 0         Success
+   @retval non-zero  Error in the statement commit
+ */
+int
+Rows_log_event::do_update_pos(Relay_log_info *rli)
+{
+  DBUG_ENTER("Rows_log_event::do_update_pos");
+  int error= 0;
+
+  DBUG_PRINT("info", ("flags: %s",
+                      get_flags(STMT_END_F) ? "STMT_END_F " : ""));
+
+  if (get_flags(STMT_END_F))
+  {
+    /*
+      Indicate that a statement is finished.
+      Step the group log position if we are not in a transaction,
+      otherwise increase the event log position.
+    */
+    rli->stmt_done(log_pos, when);
+    /*
+      Clear any errors in thd->net.last_err*. It is not known if this is
+      needed or not. It is believed that any errors that may exist in
+      thd->net.last_err* are allowed. Examples of errors are "key not
+      found", which is produced in the test case rpl_row_conflicts.test
+    */
+    thd->clear_error();
+  }
+  else
+  {
+    rli->inc_event_relay_log_pos();
+  }
+
+  DBUG_RETURN(error);
+}
+
+#endif /* !defined(MYSQL_CLIENT) && defined(HAVE_REPLICATION) */
+
+#ifndef MYSQL_CLIENT
+bool Rows_log_event::write_data_header(IO_CACHE *file)
+{
+  uchar buf[ROWS_HEADER_LEN];	// No need to init the buffer
+  DBUG_ASSERT(m_table_id != ~0UL);
+  DBUG_EXECUTE_IF("old_row_based_repl_4_byte_map_id_master",
+                  {
+                    int4store(buf + 0, m_table_id);
+                    int2store(buf + 4, m_flags);
+                    return (my_b_safe_write(file, buf, 6));
+                  });
+  int6store(buf + RW_MAPID_OFFSET, (ulonglong)m_table_id);
+  int2store(buf + RW_FLAGS_OFFSET, m_flags);
+  return (my_b_safe_write(file, buf, ROWS_HEADER_LEN));
+}
+
+bool Rows_log_event::write_data_body(IO_CACHE*file)
+{
+  /*
+     Note that this should be the number of *bits*, not the number of
+     bytes.
+  */
+  uchar sbuf[sizeof(m_width) + 1];
+  my_ptrdiff_t const data_size= m_rows_cur - m_rows_buf;
+  bool res= false;
+  uchar *const sbuf_end= net_store_length(sbuf, (size_t) m_width);
+  DBUG_ASSERT(static_cast<size_t>(sbuf_end - sbuf) <= sizeof(sbuf));
+
+  DBUG_DUMP("m_width", sbuf, (size_t) (sbuf_end - sbuf));
+  res= res || my_b_safe_write(file, sbuf, (size_t) (sbuf_end - sbuf));
+
+  DBUG_DUMP("m_cols", (uchar*) m_cols.bitmap, no_bytes_in_map(&m_cols));
+  res= res || my_b_safe_write(file, (uchar*) m_cols.bitmap,
+                              no_bytes_in_map(&m_cols));
+  /*
+    TODO[refactor write]: Remove the "down cast" here (and elsewhere).
+   */
+  if (get_type_code() == UPDATE_ROWS_EVENT)
+  {
+    DBUG_DUMP("m_cols_ai", (uchar*) m_cols_ai.bitmap,
+              no_bytes_in_map(&m_cols_ai));
+    res= res || my_b_safe_write(file, (uchar*) m_cols_ai.bitmap,
+                                no_bytes_in_map(&m_cols_ai));
+  }
+  DBUG_DUMP("rows", m_rows_buf, data_size);
+  res= res || my_b_safe_write(file, m_rows_buf, (size_t) data_size);
+
+  return res;
+
+}
+#endif
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+void Rows_log_event::pack_info(Protocol *protocol)
+{
+  char buf[256];
+  char const *const flagstr=
+    get_flags(STMT_END_F) ? " flags: STMT_END_F" : "";
+  size_t bytes= my_snprintf(buf, sizeof(buf),
+                               "table_id: %lu%s", m_table_id, flagstr);
+  protocol->store(buf, bytes, &my_charset_bin);
+}
+#endif
+
+#ifdef MYSQL_CLIENT
+void Rows_log_event::print_helper(FILE *file,
+                                  PRINT_EVENT_INFO *print_event_info,
+                                  char const *const name)
+{
+  IO_CACHE *const head= &print_event_info->head_cache;
+  IO_CACHE *const body= &print_event_info->body_cache;
+  if (!print_event_info->short_form)
+  {
+    bool const last_stmt_event= get_flags(STMT_END_F);
+    print_header(head, print_event_info, !last_stmt_event);
+    my_b_printf(head, "\t%s: table id %lu%s\n",
+                name, m_table_id,
+                last_stmt_event ? " flags: STMT_END_F" : "");
+    print_base64(body, print_event_info, !last_stmt_event);
+  }
+
+  if (get_flags(STMT_END_F))
+  {
+    copy_event_cache_to_file_and_reinit(head, file);
+    copy_event_cache_to_file_and_reinit(body, file);
+  }
+}
+#endif
+
+/**************************************************************************
+	Table_map_log_event member functions and support functions
+**************************************************************************/
+
+/**
+  @page How replication of field metadata works.
+  
+  When a table map is created, the master first calls 
+  Table_map_log_event::save_field_metadata() which calculates how many 
+  values will be in the field metadata. Only those fields that require the 
+  extra data are added. The method also loops through all of the fields in 
+  the table calling the method Field::save_field_metadata() which returns the
+  values for the field that will be saved in the metadata and replicated to
+  the slave. Once all fields have been processed, the table map is written to
+  the binlog adding the size of the field metadata and the field metadata to
+  the end of the body of the table map.
+
+  When a table map is read on the slave, the field metadata is read from the 
+  table map and passed to the table_def class constructor which saves the 
+  field metadata from the table map into an array based on the type of the 
+  field. Field metadata values not present (those fields that do not use extra 
+  data) in the table map are initialized as zero (0). The array size is the 
+  same as the columns for the table on the slave.
+
+  Additionally, values saved for field metadata on the master are saved as a 
+  string of bytes (uchar) in the binlog. A field may require 1 or more bytes
+  to store the information. In cases where values require multiple bytes 
+  (e.g. values > 255), the endian-safe methods are used to properly encode 
+  the values on the master and decode them on the slave. When the field
+  metadata values are captured on the slave, they are stored in an array of
+  type uint16. This allows the least number of casts to prevent casting bugs
+  when the field metadata is used in comparisons of field attributes. When
+  the field metadata is used for calculating addresses in pointer math, the
+  type used is uint32. 
+*/
+
+#if !defined(MYSQL_CLIENT)
+/**
+  Save the field metadata based on the real_type of the field.
+  The metadata saved depends on the type of the field. Some fields
+  store a single byte for pack_length() while others store two bytes
+  for field_length (max length).
+  
+  @retval  0  Ok.
+
+  @todo
+  We may want to consider changing the encoding of the information.
+  Currently, the code attempts to minimize the number of bytes written to 
+  the tablemap. There are at least two other alternatives; 1) using 
+  net_store_length() to store the data allowing it to choose the number of
+  bytes that are appropriate thereby making the code much easier to 
+  maintain (only 1 place to change the encoding), or 2) use a fixed number
+  of bytes for each field. The problem with option 1 is that net_store_length()
+  will use one byte if the value < 251, but 3 bytes if it is > 250. Thus,
+  for fields like CHAR which can be no larger than 255 characters, the method
+  will use 3 bytes when the value is > 250. Further, every value that is
+  encoded using 2 parts (e.g., pack_length, field_length) will be numerically
+  > 250 therefore will use 3 bytes for eah value. The problem with option 2
+  is less wasteful for space but does waste 1 byte for every field that does
+  not encode 2 parts. 
+*/
+int Table_map_log_event::save_field_metadata()
+{
+  DBUG_ENTER("Table_map_log_event::save_field_metadata");
+  int index= 0;
+  for (unsigned int i= 0 ; i < m_table->s->fields ; i++)
+  {
+    DBUG_PRINT("debug", ("field_type: %d", m_coltype[i]));
+    index+= m_table->s->field[i]->save_field_metadata(&m_field_metadata[index]);
+  }
+  DBUG_RETURN(index);
+}
+#endif /* !defined(MYSQL_CLIENT) */
+
+/*
+  Constructor used to build an event for writing to the binary log.
+  Mats says tbl->s lives longer than this event so it's ok to copy pointers
+  (tbl->s->db etc) and not pointer content.
+ */
+#if !defined(MYSQL_CLIENT)
+Table_map_log_event::Table_map_log_event(THD *thd, TABLE *tbl, ulong tid,
+                                         bool is_transactional)
+  : Log_event(thd, 0, is_transactional),
+    m_table(tbl),
+    m_dbnam(tbl->s->db.str),
+    m_dblen(m_dbnam ? tbl->s->db.length : 0),
+    m_tblnam(tbl->s->table_name.str),
+    m_tbllen(tbl->s->table_name.length),
+    m_colcnt(tbl->s->fields),
+    m_memory(NULL),
+    m_table_id(tid),
+    m_flags(TM_BIT_LEN_EXACT_F),
+    m_data_size(0),
+    m_field_metadata(0),
+    m_field_metadata_size(0),
+    m_null_bits(0),
+    m_meta_memory(NULL)
+{
+  uchar cbuf[sizeof(m_colcnt) + 1];
+  uchar *cbuf_end;
+  DBUG_ASSERT(m_table_id != ~0UL);
+  /*
+    In TABLE_SHARE, "db" and "table_name" are 0-terminated (see this comment in
+    table.cc / alloc_table_share():
+      Use the fact the key is db/0/table_name/0
+    As we rely on this let's assert it.
+  */
+  DBUG_ASSERT((tbl->s->db.str == 0) ||
+              (tbl->s->db.str[tbl->s->db.length] == 0));
+  DBUG_ASSERT(tbl->s->table_name.str[tbl->s->table_name.length] == 0);
+
+
+  m_data_size=  TABLE_MAP_HEADER_LEN;
+  DBUG_EXECUTE_IF("old_row_based_repl_4_byte_map_id_master", m_data_size= 6;);
+  m_data_size+= m_dblen + 2;	// Include length and terminating \0
+  m_data_size+= m_tbllen + 2;	// Include length and terminating \0
+  cbuf_end= net_store_length(cbuf, (size_t) m_colcnt);
+  DBUG_ASSERT(static_cast<size_t>(cbuf_end - cbuf) <= sizeof(cbuf));
+  m_data_size+= (cbuf_end - cbuf) + m_colcnt;	// COLCNT and column types
+
+  /* If malloc fails, caught in is_valid() */
+  if ((m_memory= (uchar*) my_malloc(m_colcnt, MYF(MY_WME))))
+  {
+    m_coltype= reinterpret_cast<uchar*>(m_memory);
+    for (unsigned int i= 0 ; i < m_table->s->fields ; ++i)
+      m_coltype[i]= m_table->field[i]->type();
+  }
+
+  /*
+    Calculate a bitmap for the results of maybe_null() for all columns.
+    The bitmap is used to determine when there is a column from the master
+    that is not on the slave and is null and thus not in the row data during
+    replication.
+  */
+  uint num_null_bytes= (m_table->s->fields + 7) / 8;
+  m_data_size+= num_null_bytes;
+  m_meta_memory= (uchar *)my_multi_malloc(MYF(MY_WME),
+                                 &m_null_bits, num_null_bytes,
+                                 &m_field_metadata, (m_colcnt * 2),
+                                 NULL);
+
+  bzero(m_field_metadata, (m_colcnt * 2));
+
+  /*
+    Create an array for the field metadata and store it.
+  */
+  m_field_metadata_size= save_field_metadata();
+  DBUG_ASSERT(m_field_metadata_size <= (m_colcnt * 2));
+
+  /*
+    Now set the size of the data to the size of the field metadata array
+    plus one or three bytes (see pack.c:net_store_length) for number of 
+    elements in the field metadata array.
+  */
+  if (m_field_metadata_size < 251)
+    m_data_size+= m_field_metadata_size + 1; 
+  else
+    m_data_size+= m_field_metadata_size + 3; 
+
+  bzero(m_null_bits, num_null_bytes);
+  for (unsigned int i= 0 ; i < m_table->s->fields ; ++i)
+    if (m_table->field[i]->maybe_null())
+      m_null_bits[(i / 8)]+= 1 << (i % 8);
+
+}
+#endif /* !defined(MYSQL_CLIENT) */
+
+/*
+  Constructor used by slave to read the event from the binary log.
+ */
+#if defined(HAVE_REPLICATION)
+Table_map_log_event::Table_map_log_event(const char *buf, uint event_len,
+                                         const Format_description_log_event
+                                         *description_event)
+
+  : Log_event(buf, description_event),
+#ifndef MYSQL_CLIENT
+    m_table(NULL),
+#endif
+    m_dbnam(NULL), m_dblen(0), m_tblnam(NULL), m_tbllen(0),
+    m_colcnt(0), m_coltype(0),
+    m_memory(NULL), m_table_id(ULONG_MAX), m_flags(0),
+    m_data_size(0), m_field_metadata(0), m_field_metadata_size(0),
+    m_null_bits(0), m_meta_memory(NULL)
+{
+  unsigned int bytes_read= 0;
+  DBUG_ENTER("Table_map_log_event::Table_map_log_event(const char*,uint,...)");
+
+  uint8 common_header_len= description_event->common_header_len;
+  uint8 post_header_len= description_event->post_header_len[TABLE_MAP_EVENT-1];
+  DBUG_PRINT("info",("event_len: %u  common_header_len: %d  post_header_len: %d",
+                     event_len, common_header_len, post_header_len));
+
+  /*
+    Don't print debug messages when running valgrind since they can
+    trigger false warnings.
+   */
+#ifndef HAVE_purify
+  DBUG_DUMP("event buffer", (uchar*) buf, event_len);
+#endif
+
+  /* Read the post-header */
+  const char *post_start= buf + common_header_len;
+
+  post_start+= TM_MAPID_OFFSET;
+  if (post_header_len == 6)
+  {
+    /* Master is of an intermediate source tree before 5.1.4. Id is 4 bytes */
+    m_table_id= uint4korr(post_start);
+    post_start+= 4;
+  }
+  else
+  {
+    DBUG_ASSERT(post_header_len == TABLE_MAP_HEADER_LEN);
+    m_table_id= (ulong) uint6korr(post_start);
+    post_start+= TM_FLAGS_OFFSET;
+  }
+
+  DBUG_ASSERT(m_table_id != ~0UL);
+
+  m_flags= uint2korr(post_start);
+
+  /* Read the variable part of the event */
+  const char *const vpart= buf + common_header_len + post_header_len;
+
+  /* Extract the length of the various parts from the buffer */
+  uchar const *const ptr_dblen= (uchar const*)vpart + 0;
+  m_dblen= *(uchar*) ptr_dblen;
+
+  /* Length of database name + counter + terminating null */
+  uchar const *const ptr_tbllen= ptr_dblen + m_dblen + 2;
+  m_tbllen= *(uchar*) ptr_tbllen;
+
+  /* Length of table name + counter + terminating null */
+  uchar const *const ptr_colcnt= ptr_tbllen + m_tbllen + 2;
+  uchar *ptr_after_colcnt= (uchar*) ptr_colcnt;
+  m_colcnt= net_field_length(&ptr_after_colcnt);
+
+  DBUG_PRINT("info",("m_dblen: %lu  off: %ld  m_tbllen: %lu  off: %ld  m_colcnt: %lu  off: %ld",
+                     (ulong) m_dblen, (long) (ptr_dblen-(const uchar*)vpart), 
+                     (ulong) m_tbllen, (long) (ptr_tbllen-(const uchar*)vpart),
+                     m_colcnt, (long) (ptr_colcnt-(const uchar*)vpart)));
+
+  /* Allocate mem for all fields in one go. If fails, caught in is_valid() */
+  m_memory= (uchar*) my_multi_malloc(MYF(MY_WME),
+                                     &m_dbnam, (uint) m_dblen + 1,
+                                     &m_tblnam, (uint) m_tbllen + 1,
+                                     &m_coltype, (uint) m_colcnt,
+                                     NullS);
+
+  if (m_memory)
+  {
+    /* Copy the different parts into their memory */
+    strncpy(const_cast<char*>(m_dbnam), (const char*)ptr_dblen  + 1, m_dblen + 1);
+    strncpy(const_cast<char*>(m_tblnam), (const char*)ptr_tbllen + 1, m_tbllen + 1);
+    memcpy(m_coltype, ptr_after_colcnt, m_colcnt);
+
+    ptr_after_colcnt= ptr_after_colcnt + m_colcnt;
+    bytes_read= (uint) (ptr_after_colcnt - (uchar *)buf);
+    DBUG_PRINT("info", ("Bytes read: %d.\n", bytes_read));
+    if (bytes_read < event_len)
+    {
+      m_field_metadata_size= net_field_length(&ptr_after_colcnt);
+      DBUG_ASSERT(m_field_metadata_size <= (m_colcnt * 2));
+      uint num_null_bytes= (m_colcnt + 7) / 8;
+      m_meta_memory= (uchar *)my_multi_malloc(MYF(MY_WME),
+                                     &m_null_bits, num_null_bytes,
+                                     &m_field_metadata, m_field_metadata_size,
+                                     NULL);
+      memcpy(m_field_metadata, ptr_after_colcnt, m_field_metadata_size);
+      ptr_after_colcnt= (uchar*)ptr_after_colcnt + m_field_metadata_size;
+      memcpy(m_null_bits, ptr_after_colcnt, num_null_bytes);
+    }
+  }
+
+  DBUG_VOID_RETURN;
+}
+#endif
+
+Table_map_log_event::~Table_map_log_event()
+{
+  my_free(m_meta_memory);
+  my_free(m_memory);
+}
+
+/*
+  Return value is an error code, one of:
+
+      -1     Failure to open table   [from open_tables()]
+       0     Success
+       1     No room for more tables [from set_table()]
+       2     Out of memory           [from set_table()]
+       3     Wrong table definition
+       4     Daisy-chaining RBR with SBR not possible
+ */
+
+#if !defined(MYSQL_CLIENT) && defined(HAVE_REPLICATION)
+
+enum enum_tbl_map_status
+{
+  /* no duplicate identifier found */
+  OK_TO_PROCESS= 0,
+
+  /* this table map must be filtered out */
+  FILTERED_OUT= 1,
+
+  /* identifier mapping table with different properties */
+  SAME_ID_MAPPING_DIFFERENT_TABLE= 2,
+  
+  /* a duplicate identifier was found mapping the same table */
+  SAME_ID_MAPPING_SAME_TABLE= 3
+};
+
+/*
+  Checks if this table map event should be processed or not. First
+  it checks the filtering rules, and then looks for duplicate identifiers
+  in the existing list of rli->tables_to_lock.
+
+  It checks that there hasn't been any corruption by verifying that there
+  are no duplicate entries with different properties.
+
+  In some cases, some binary logs could get corrupted, showing several
+  tables mapped to the same table_id, 0 (see: BUG#56226). Thus we do this
+  early sanity check for such cases and avoid that the server crashes 
+  later.
+
+  In some corner cases, the master logs duplicate table map events, i.e.,
+  same id, same database name, same table name (see: BUG#37137). This is
+  different from the above as it's the same table that is mapped again 
+  to the same identifier. Thus we cannot just check for same ids and 
+  assume that the event is corrupted we need to check every property. 
+
+  NOTE: in the event that BUG#37137 ever gets fixed, this extra check 
+        will still be valid because we would need to support old binary 
+        logs anyway.
+
+  @param rli The relay log info reference.
+  @param table_list A list element containing the table to check against.
+  @return OK_TO_PROCESS 
+            if there was no identifier already in rli->tables_to_lock 
+            
+          FILTERED_OUT
+            if the event is filtered according to the filtering rules
+
+          SAME_ID_MAPPING_DIFFERENT_TABLE 
+            if the same identifier already maps a different table in 
+            rli->tables_to_lock
+
+          SAME_ID_MAPPING_SAME_TABLE 
+            if the same identifier already maps the same table in 
+            rli->tables_to_lock.
+*/
+static enum_tbl_map_status
+check_table_map(Relay_log_info const *rli, RPL_TABLE_LIST *table_list)
+{
+  DBUG_ENTER("check_table_map");
+  enum_tbl_map_status res= OK_TO_PROCESS;
+
+  if (rli->sql_thd->slave_thread /* filtering is for slave only */ &&
+      (!rpl_filter->db_ok(table_list->db) ||
+       (rpl_filter->is_on() && !rpl_filter->tables_ok("", table_list))))
+    res= FILTERED_OUT;
+  else
+  {
+    RPL_TABLE_LIST *ptr= static_cast<RPL_TABLE_LIST*>(rli->tables_to_lock);
+    for(uint i=0 ; ptr && (i< rli->tables_to_lock_count); 
+        ptr= static_cast<RPL_TABLE_LIST*>(ptr->next_local), i++)
+    {
+      if (ptr->table_id == table_list->table_id)
+      {
+
+        if (strcmp(ptr->db, table_list->db) || 
+            strcmp(ptr->alias, table_list->table_name) || 
+            ptr->lock_type != TL_WRITE) // the ::do_apply_event always sets TL_WRITE
+          res= SAME_ID_MAPPING_DIFFERENT_TABLE;
+        else
+          res= SAME_ID_MAPPING_SAME_TABLE;
+
+        break;
+      }
+    }
+  }
+
+  DBUG_PRINT("debug", ("check of table map ended up with: %u", res));
+
+  DBUG_RETURN(res);
+}
+
+int Table_map_log_event::do_apply_event(Relay_log_info const *rli)
+{
+  RPL_TABLE_LIST *table_list;
+  char *db_mem, *tname_mem;
+  size_t dummy_len;
+  void *memory;
+  DBUG_ENTER("Table_map_log_event::do_apply_event(Relay_log_info*)");
+  DBUG_ASSERT(rli->sql_thd == thd);
+
+  /* Step the query id to mark what columns that are actually used. */
+  thd->set_query_id(next_query_id());
+
+  if (!(memory= my_multi_malloc(MYF(MY_WME),
+                                &table_list, (uint) sizeof(RPL_TABLE_LIST),
+                                &db_mem, (uint) NAME_LEN + 1,
+                                &tname_mem, (uint) NAME_LEN + 1,
+                                NullS)))
+    DBUG_RETURN(HA_ERR_OUT_OF_MEM);
+
+  strmov(db_mem, rpl_filter->get_rewrite_db(m_dbnam, &dummy_len));
+  strmov(tname_mem, m_tblnam);
+
+  table_list->init_one_table(db_mem, strlen(db_mem),
+                             tname_mem, strlen(tname_mem),
+                             tname_mem, TL_WRITE);
+
+  table_list->table_id= DBUG_EVALUATE_IF("inject_tblmap_same_id_maps_diff_table", 0, m_table_id);
+  table_list->updating= 1;
+  table_list->required_type= FRMTYPE_TABLE;
+  DBUG_PRINT("debug", ("table: %s is mapped to %u", table_list->table_name, table_list->table_id));
+  enum_tbl_map_status tblmap_status= check_table_map(rli, table_list);
+  if (tblmap_status == OK_TO_PROCESS)
+  {
+    DBUG_ASSERT(thd->lex->query_tables != table_list);
+
+    /*
+      Use placement new to construct the table_def instance in the
+      memory allocated for it inside table_list.
+
+      The memory allocated by the table_def structure (i.e., not the
+      memory allocated *for* the table_def structure) is released
+      inside Relay_log_info::clear_tables_to_lock() by calling the
+      table_def destructor explicitly.
+    */
+    new (&table_list->m_tabledef)
+      table_def(m_coltype, m_colcnt,
+                m_field_metadata, m_field_metadata_size,
+                m_null_bits, m_flags);
+    table_list->m_tabledef_valid= TRUE;
+    table_list->m_conv_table= NULL;
+    table_list->open_type= OT_BASE_ONLY;
+
+    /*
+      We record in the slave's information that the table should be
+      locked by linking the table into the list of tables to lock.
+    */
+    table_list->next_global= table_list->next_local= rli->tables_to_lock;
+    const_cast<Relay_log_info*>(rli)->tables_to_lock= table_list;
+    const_cast<Relay_log_info*>(rli)->tables_to_lock_count++;
+    /* 'memory' is freed in clear_tables_to_lock */
+  }
+  else  // FILTERED_OUT, SAME_ID_MAPPING_*
+  {
+    /*
+      If mapped already but with different properties, we raise an
+      error.
+      If mapped already but with same properties we skip the event.
+      If filtered out we skip the event.
+
+      In all three cases, we need to free the memory previously 
+      allocated.
+     */
+    if (tblmap_status == SAME_ID_MAPPING_DIFFERENT_TABLE)
+    {
+      /*
+        Something bad has happened. We need to stop the slave as strange things
+        could happen if we proceed: slave crash, wrong table being updated, ...
+        As a consequence we push an error in this case.
+       */
+
+      char buf[256];
+
+      my_snprintf(buf, sizeof(buf), 
+                  "Found table map event mapping table id %u which "
+                  "was already mapped but with different settings.",
+                  table_list->table_id);
+
+      if (thd->slave_thread)
+        rli->report(ERROR_LEVEL, ER_SLAVE_FATAL_ERROR, 
+                    ER(ER_SLAVE_FATAL_ERROR), buf);
+      else
+        /* 
+          For the cases in which a 'BINLOG' statement is set to 
+          execute in a user session 
+         */
+        my_printf_error(ER_SLAVE_FATAL_ERROR, ER(ER_SLAVE_FATAL_ERROR), 
+                        MYF(0), buf);
+    } 
+    
+    my_free(memory);
+  }
+
+  DBUG_RETURN(tblmap_status == SAME_ID_MAPPING_DIFFERENT_TABLE);
+}
+
+Log_event::enum_skip_reason
+Table_map_log_event::do_shall_skip(Relay_log_info *rli)
+{
+  /*
+    If the slave skip counter is 1, then we should not start executing
+    on the next event.
+  */
+  return continue_group(rli);
+}
+
+int Table_map_log_event::do_update_pos(Relay_log_info *rli)
+{
+  rli->inc_event_relay_log_pos();
+  return 0;
+}
+
+#endif /* !defined(MYSQL_CLIENT) && defined(HAVE_REPLICATION) */
+
+#ifndef MYSQL_CLIENT
+bool Table_map_log_event::write_data_header(IO_CACHE *file)
+{
+  DBUG_ASSERT(m_table_id != ~0UL);
+  uchar buf[TABLE_MAP_HEADER_LEN];
+  DBUG_EXECUTE_IF("old_row_based_repl_4_byte_map_id_master",
+                  {
+                    int4store(buf + 0, m_table_id);
+                    int2store(buf + 4, m_flags);
+                    return (my_b_safe_write(file, buf, 6));
+                  });
+  int6store(buf + TM_MAPID_OFFSET, (ulonglong)m_table_id);
+  int2store(buf + TM_FLAGS_OFFSET, m_flags);
+  return (my_b_safe_write(file, buf, TABLE_MAP_HEADER_LEN));
+}
+
+bool Table_map_log_event::write_data_body(IO_CACHE *file)
+{
+  DBUG_ASSERT(m_dbnam != NULL);
+  DBUG_ASSERT(m_tblnam != NULL);
+
+  DBUG_ASSERT(m_dblen <= NAME_LEN);
+  DBUG_ASSERT(m_tbllen <= NAME_LEN);
+
+  uchar const dbuf[]= { (uchar) m_dblen };
+  uchar const tbuf[]= { (uchar) m_tbllen };
+
+  uchar cbuf[sizeof(m_colcnt) + 1];
+  uchar *const cbuf_end= net_store_length(cbuf, (size_t) m_colcnt);
+  DBUG_ASSERT(static_cast<size_t>(cbuf_end - cbuf) <= sizeof(cbuf));
+
+  /*
+    Store the size of the field metadata.
+  */
+  uchar mbuf[sizeof(m_field_metadata_size)];
+  uchar *const mbuf_end= net_store_length(mbuf, m_field_metadata_size);
+
+  return (my_b_safe_write(file, dbuf,      sizeof(dbuf)) ||
+          my_b_safe_write(file, (const uchar*)m_dbnam,   m_dblen+1) ||
+          my_b_safe_write(file, tbuf,      sizeof(tbuf)) ||
+          my_b_safe_write(file, (const uchar*)m_tblnam,  m_tbllen+1) ||
+          my_b_safe_write(file, cbuf, (size_t) (cbuf_end - cbuf)) ||
+          my_b_safe_write(file, m_coltype, m_colcnt) ||
+          my_b_safe_write(file, mbuf, (size_t) (mbuf_end - mbuf)) ||
+          my_b_safe_write(file, m_field_metadata, m_field_metadata_size),
+          my_b_safe_write(file, m_null_bits, (m_colcnt + 7) / 8));
+ }
+#endif
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+
+/*
+  Print some useful information for the SHOW BINARY LOG information
+  field.
+ */
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+void Table_map_log_event::pack_info(Protocol *protocol)
+{
+    char buf[256];
+    size_t bytes= my_snprintf(buf, sizeof(buf),
+                                 "table_id: %lu (%s.%s)",
+                              m_table_id, m_dbnam, m_tblnam);
+    protocol->store(buf, bytes, &my_charset_bin);
+}
+#endif
+
+
+#endif
+
+
+#ifdef MYSQL_CLIENT
+void Table_map_log_event::print(FILE *, PRINT_EVENT_INFO *print_event_info)
+{
+  if (!print_event_info->short_form)
+  {
+    print_header(&print_event_info->head_cache, print_event_info, TRUE);
+    my_b_printf(&print_event_info->head_cache,
+                "\tTable_map: `%s`.`%s` mapped to number %lu\n",
+                m_dbnam, m_tblnam, m_table_id);
+    print_base64(&print_event_info->body_cache, print_event_info, TRUE);
+  }
+}
+#endif
+
+/**************************************************************************
+	Write_rows_log_event member functions
+**************************************************************************/
+
+/*
+  Constructor used to build an event for writing to the binary log.
+ */
+#if !defined(MYSQL_CLIENT)
+Write_rows_log_event::Write_rows_log_event(THD *thd_arg, TABLE *tbl_arg,
+                                           ulong tid_arg,
+                                           MY_BITMAP const *cols,
+                                           bool is_transactional)
+  : Rows_log_event(thd_arg, tbl_arg, tid_arg, cols, is_transactional)
+{
+}
+#endif
+
+/*
+  Constructor used by slave to read the event from the binary log.
+ */
+#ifdef HAVE_REPLICATION
+Write_rows_log_event::Write_rows_log_event(const char *buf, uint event_len,
+                                           const Format_description_log_event
+                                           *description_event)
+: Rows_log_event(buf, event_len, WRITE_ROWS_EVENT, description_event)
+{
+}
+#endif
+
+#if !defined(MYSQL_CLIENT) && defined(HAVE_REPLICATION)
+int 
+Write_rows_log_event::do_before_row_operations(const Slave_reporting_capability *const)
+{
+  int error= 0;
+
+  /*
+    Increment the global status insert count variable
+  */
+  if (get_flags(STMT_END_F))
+    status_var_increment(thd->status_var.com_stat[SQLCOM_INSERT]);
+
+  /**
+     todo: to introduce a property for the event (handler?) which forces
+     applying the event in the replace (idempotent) fashion.
+  */
+  if ((slave_exec_mode == SLAVE_EXEC_MODE_IDEMPOTENT) ||
+      (m_table->s->db_type()->db_type == DB_TYPE_NDBCLUSTER))
+  {
+    /*
+      We are using REPLACE semantics and not INSERT IGNORE semantics
+      when writing rows, that is: new rows replace old rows.  We need to
+      inform the storage engine that it should use this behaviour.
+    */
+    
+    /* Tell the storage engine that we are using REPLACE semantics. */
+    thd->lex->duplicates= DUP_REPLACE;
+    
+    /*
+      Pretend we're executing a REPLACE command: this is needed for
+      InnoDB and NDB Cluster since they are not (properly) checking the
+      lex->duplicates flag.
+    */
+    thd->lex->sql_command= SQLCOM_REPLACE;
+    /* 
+       Do not raise the error flag in case of hitting to an unique attribute
+    */
+    m_table->file->extra(HA_EXTRA_IGNORE_DUP_KEY);
+    /* 
+       NDB specific: update from ndb master wrapped as Write_rows
+       so that the event should be applied to replace slave's row
+    */
+    m_table->file->extra(HA_EXTRA_WRITE_CAN_REPLACE);
+    /* 
+       NDB specific: if update from ndb master wrapped as Write_rows
+       does not find the row it's assumed idempotent binlog applying
+       is taking place; don't raise the error.
+    */
+    m_table->file->extra(HA_EXTRA_IGNORE_NO_KEY);
+    /*
+      TODO: the cluster team (Tomas?) says that it's better if the engine knows
+      how many rows are going to be inserted, then it can allocate needed memory
+      from the start.
+    */
+  }
+
+  /*
+    We need TIMESTAMP_NO_AUTO_SET otherwise ha_write_row() will not use fill
+    any TIMESTAMP column with data from the row but instead will use
+    the event's current time.
+    As we replicate from TIMESTAMP to TIMESTAMP and slave has no extra
+    columns, we know that all TIMESTAMP columns on slave will receive explicit
+    data from the row, so TIMESTAMP_NO_AUTO_SET is ok.
+    When we allow a table without TIMESTAMP to be replicated to a table having
+    more columns including a TIMESTAMP column, or when we allow a TIMESTAMP
+    column to be replicated into a BIGINT column and the slave's table has a
+    TIMESTAMP column, then the slave's TIMESTAMP column will take its value
+    from set_time() which we called earlier (consistent with SBR). And then in
+    some cases we won't want TIMESTAMP_NO_AUTO_SET (will require some code to
+    analyze if explicit data is provided for slave's TIMESTAMP columns).
+  */
+  m_table->timestamp_field_type= TIMESTAMP_NO_AUTO_SET;
+  
+  /* Honor next number column if present */
+  m_table->next_number_field= m_table->found_next_number_field;
+  /*
+   * Fixed Bug#45999, In RBR, Store engine of Slave auto-generates new
+   * sequence numbers for auto_increment fields if the values of them are 0.
+   * If generateing a sequence number is decided by the values of
+   * table->auto_increment_field_not_null and SQL_MODE(if includes
+   * MODE_NO_AUTO_VALUE_ON_ZERO) in update_auto_increment function.
+   * SQL_MODE of slave sql thread is always consistency with master's.
+   * In RBR, auto_increment fields never are NULL, except if the auto_inc
+   * column exists only on the slave side (i.e., in an extra column
+   * on the slave's table).
+   */
+  if (!is_auto_inc_in_extra_columns())
+    m_table->auto_increment_field_not_null= TRUE;
+  else
+  {
+    /*
+      Here we have checked that there is an extra field
+      on this server's table that has an auto_inc column.
+
+      Mark that the auto_increment field is null and mark
+      the read and write set bits.
+
+      (There can only be one AUTO_INC column, it is always
+       indexed and it cannot have a DEFAULT value).
+    */
+    m_table->auto_increment_field_not_null= FALSE;
+    m_table->mark_auto_increment_column();
+  }
+
+  return error;
+}
+
+int 
+Write_rows_log_event::do_after_row_operations(const Slave_reporting_capability *const,
+                                              int error)
+{
+  int local_error= 0;
+
+  /**
+    Clear the write_set bit for auto_inc field that only
+    existed on the destination table as an extra column.
+   */
+  if (is_auto_inc_in_extra_columns())
+  {
+    bitmap_clear_bit(m_table->write_set, m_table->next_number_field->field_index);
+    bitmap_clear_bit( m_table->read_set, m_table->next_number_field->field_index);
+
+    if (get_flags(STMT_END_F))
+      m_table->file->ha_release_auto_increment();
+  }
+  m_table->next_number_field=0;
+  m_table->auto_increment_field_not_null= FALSE;
+  if ((slave_exec_mode == SLAVE_EXEC_MODE_IDEMPOTENT) ||
+      m_table->s->db_type()->db_type == DB_TYPE_NDBCLUSTER)
+  {
+    m_table->file->extra(HA_EXTRA_NO_IGNORE_DUP_KEY);
+    m_table->file->extra(HA_EXTRA_WRITE_CANNOT_REPLACE);
+    /*
+      resetting the extra with 
+      table->file->extra(HA_EXTRA_NO_IGNORE_NO_KEY); 
+      fires bug#27077
+      explanation: file->reset() performs this duty
+      ultimately. Still todo: fix
+    */
+  }
+  if ((local_error= m_table->file->ha_end_bulk_insert()))
+  {
+    m_table->file->print_error(local_error, MYF(0));
+  }
+  return error? error : local_error;
+}
+
+#if !defined(MYSQL_CLIENT) && defined(HAVE_REPLICATION)
+
+/*
+  Check if there are more UNIQUE keys after the given key.
+*/
+static int
+last_uniq_key(TABLE *table, uint keyno)
+{
+  while (++keyno < table->s->keys)
+    if (table->key_info[keyno].flags & HA_NOSAME)
+      return 0;
+  return 1;
+}
+
+/**
+   Check if an error is a duplicate key error.
+
+   This function is used to check if an error code is one of the
+   duplicate key error, i.e., and error code for which it is sensible
+   to do a <code>get_dup_key()</code> to retrieve the duplicate key.
+
+   @param errcode The error code to check.
+
+   @return <code>true</code> if the error code is such that
+   <code>get_dup_key()</code> will return true, <code>false</code>
+   otherwise.
+ */
+bool
+is_duplicate_key_error(int errcode)
+{
+  switch (errcode)
+  {
+  case HA_ERR_FOUND_DUPP_KEY:
+  case HA_ERR_FOUND_DUPP_UNIQUE:
+    return true;
+  }
+  return false;
+}
+
+/**
+  Write the current row into event's table.
+
+  The row is located in the row buffer, pointed by @c m_curr_row member.
+  Number of columns of the row is stored in @c m_width member (it can be 
+  different from the number of columns in the table to which we insert). 
+  Bitmap @c m_cols indicates which columns are present in the row. It is assumed 
+  that event's table is already open and pointed by @c m_table.
+
+  If the same record already exists in the table it can be either overwritten 
+  or an error is reported depending on the value of @c overwrite flag 
+  (error reporting not yet implemented). Note that the matching record can be
+  different from the row we insert if we use primary keys to identify records in
+  the table.
+
+  The row to be inserted can contain values only for selected columns. The 
+  missing columns are filled with default values using @c prepare_record() 
+  function. If a matching record is found in the table and @c overwritte is
+  true, the missing columns are taken from it.
+
+  @param  rli   Relay log info (needed for row unpacking).
+  @param  overwrite  
+                Shall we overwrite if the row already exists or signal 
+                error (currently ignored).
+
+  @returns Error code on failure, 0 on success.
+
+  This method, if successful, sets @c m_curr_row_end pointer to point at the
+  next row in the rows buffer. This is done when unpacking the row to be 
+  inserted.
+
+  @note If a matching record is found, it is either updated using 
+  @c ha_update_row() or first deleted and then new record written.
+*/ 
+
+int
+Rows_log_event::write_row(const Relay_log_info *const rli,
+                          const bool overwrite)
+{
+  DBUG_ENTER("write_row");
+  DBUG_ASSERT(m_table != NULL && thd != NULL);
+
+  TABLE *table= m_table;  // pointer to event's table
+  int error;
+  int UNINIT_VAR(keynum);
+  auto_afree_ptr<char> key(NULL);
+
+  prepare_record(table, m_width,
+                 table->file->ht->db_type != DB_TYPE_NDBCLUSTER);
+
+  /* unpack row into table->record[0] */
+  if ((error= unpack_current_row(rli)))
+    DBUG_RETURN(error);
+
+  if (m_curr_row == m_rows_buf)
+  {
+    /* this is the first row to be inserted, we estimate the rows with
+       the size of the first row and use that value to initialize
+       storage engine for bulk insertion */
+    ulong estimated_rows= (m_rows_end - m_curr_row) / (m_curr_row_end - m_curr_row);
+    m_table->file->ha_start_bulk_insert(estimated_rows);
+  }
+
+  /*
+    Explicitly set the auto_inc to null to make sure that
+    it gets an auto_generated value.
+  */
+  if (is_auto_inc_in_extra_columns())
+    m_table->next_number_field->set_null();
+  
+#ifndef DBUG_OFF
+  DBUG_DUMP("record[0]", table->record[0], table->s->reclength);
+  DBUG_PRINT_BITSET("debug", "write_set = %s", table->write_set);
+  DBUG_PRINT_BITSET("debug", "read_set = %s", table->read_set);
+#endif
+
+  /* 
+    Try to write record. If a corresponding record already exists in the table,
+    we try to change it using ha_update_row() if possible. Otherwise we delete
+    it and repeat the whole process again. 
+
+    TODO: Add safety measures against infinite looping. 
+   */
+
+  while ((error= table->file->ha_write_row(table->record[0])))
+  {
+    if (error == HA_ERR_LOCK_DEADLOCK ||
+        error == HA_ERR_LOCK_WAIT_TIMEOUT ||
+        (keynum= table->file->get_dup_key(error)) < 0 ||
+        !overwrite)
+    {
+      DBUG_PRINT("info",("get_dup_key returns %d)", keynum));
+      /*
+        Deadlock, waiting for lock or just an error from the handler
+        such as HA_ERR_FOUND_DUPP_KEY when overwrite is false.
+        Retrieval of the duplicate key number may fail
+        - either because the error was not "duplicate key" error
+        - or because the information which key is not available
+      */
+      table->file->print_error(error, MYF(0));
+      DBUG_RETURN(error);
+    }
+    /*
+       We need to retrieve the old row into record[1] to be able to
+       either update or delete the offending record.  We either:
+
+       - use rnd_pos() with a row-id (available as dupp_row) to the
+         offending row, if that is possible (MyISAM and Blackhole), or else
+
+       - use index_read_idx() with the key that is duplicated, to
+         retrieve the offending row.
+     */
+    if (table->file->ha_table_flags() & HA_DUPLICATE_POS)
+    {
+      DBUG_PRINT("info",("Locating offending record using rnd_pos()"));
+      error= table->file->rnd_pos(table->record[1], table->file->dup_ref);
+      if (error)
+      {
+        DBUG_PRINT("info",("rnd_pos() returns error %d",error));
+        if (error == HA_ERR_RECORD_DELETED)
+          error= HA_ERR_KEY_NOT_FOUND;
+        table->file->print_error(error, MYF(0));
+        DBUG_RETURN(error);
+      }
+    }
+    else
+    {
+      DBUG_PRINT("info",("Locating offending record using index_read_idx()"));
+
+      if (table->file->extra(HA_EXTRA_FLUSH_CACHE))
+      {
+        DBUG_PRINT("info",("Error when setting HA_EXTRA_FLUSH_CACHE"));
+        DBUG_RETURN(my_errno);
+      }
+
+      if (key.get() == NULL)
+      {
+        key.assign(static_cast<char*>(my_alloca(table->s->max_unique_length)));
+        if (key.get() == NULL)
+        {
+          DBUG_PRINT("info",("Can't allocate key buffer"));
+          DBUG_RETURN(ENOMEM);
+        }
+      }
+
+      key_copy((uchar*)key.get(), table->record[0], table->key_info + keynum,
+               0);
+      error= table->file->index_read_idx_map(table->record[1], keynum,
+                                             (const uchar*)key.get(),
+                                             HA_WHOLE_KEY,
+                                             HA_READ_KEY_EXACT);
+      if (error)
+      {
+        DBUG_PRINT("info",("index_read_idx() returns %s", HA_ERR(error)));
+        if (error == HA_ERR_RECORD_DELETED)
+          error= HA_ERR_KEY_NOT_FOUND;
+        table->file->print_error(error, MYF(0));
+        DBUG_RETURN(error);
+      }
+    }
+
+    /*
+       Now, record[1] should contain the offending row.  That
+       will enable us to update it or, alternatively, delete it (so
+       that we can insert the new row afterwards).
+     */
+
+    /*
+      If row is incomplete we will use the record found to fill 
+      missing columns.  
+    */
+    if (!get_flags(COMPLETE_ROWS_F))
+    {
+      restore_record(table,record[1]);
+      error= unpack_current_row(rli);
+    }
+
+#ifndef DBUG_OFF
+    DBUG_PRINT("debug",("preparing for update: before and after image"));
+    DBUG_DUMP("record[1] (before)", table->record[1], table->s->reclength);
+    DBUG_DUMP("record[0] (after)", table->record[0], table->s->reclength);
+#endif
+
+    /*
+       REPLACE is defined as either INSERT or DELETE + INSERT.  If
+       possible, we can replace it with an UPDATE, but that will not
+       work on InnoDB if FOREIGN KEY checks are necessary.
+
+       I (Matz) am not sure of the reason for the last_uniq_key()
+       check as, but I'm guessing that it's something along the
+       following lines.
+
+       Suppose that we got the duplicate key to be a key that is not
+       the last unique key for the table and we perform an update:
+       then there might be another key for which the unique check will
+       fail, so we're better off just deleting the row and inserting
+       the correct row.
+     */
+    if (last_uniq_key(table, keynum) &&
+        !table->file->referenced_by_foreign_key())
+    {
+      DBUG_PRINT("info",("Updating row using ha_update_row()"));
+      error=table->file->ha_update_row(table->record[1],
+                                       table->record[0]);
+      switch (error) {
+                
+      case HA_ERR_RECORD_IS_THE_SAME:
+        DBUG_PRINT("info",("ignoring HA_ERR_RECORD_IS_THE_SAME error from"
+                           " ha_update_row()"));
+        error= 0;
+      
+      case 0:
+        break;
+        
+      default:    
+        DBUG_PRINT("info",("ha_update_row() returns error %d",error));
+        table->file->print_error(error, MYF(0));
+      }
+      
+      DBUG_RETURN(error);
+    }
+    else
+    {
+      DBUG_PRINT("info",("Deleting offending row and trying to write new one again"));
+      if ((error= table->file->ha_delete_row(table->record[1])))
+      {
+        DBUG_PRINT("info",("ha_delete_row() returns error %d",error));
+        table->file->print_error(error, MYF(0));
+        DBUG_RETURN(error);
+      }
+      /* Will retry ha_write_row() with the offending row removed. */
+    }
+  }
+
+  DBUG_RETURN(error);
+}
+
+#endif
+
+int
+Write_rows_log_event::do_exec_row(const Relay_log_info *const rli)
+{
+  DBUG_ASSERT(m_table != NULL);
+  int error= write_row(rli, slave_exec_mode == SLAVE_EXEC_MODE_IDEMPOTENT);
+
+  if (error && !thd->is_error())
+  {
+    DBUG_ASSERT(0);
+    my_error(ER_UNKNOWN_ERROR, MYF(0));
+  }
+
+  return error;
+}
+
+#endif /* !defined(MYSQL_CLIENT) && defined(HAVE_REPLICATION) */
+
+#ifdef MYSQL_CLIENT
+void Write_rows_log_event::print(FILE *file, PRINT_EVENT_INFO* print_event_info)
+{
+  DBUG_EXECUTE_IF("simulate_cache_read_error",
+                  {DBUG_SET("+d,simulate_my_b_fill_error");});
+  Rows_log_event::print_helper(file, print_event_info, "Write_rows");
+}
+#endif
+
+/**************************************************************************
+	Delete_rows_log_event member functions
+**************************************************************************/
+
+#if !defined(MYSQL_CLIENT) && defined(HAVE_REPLICATION)
+/*
+  Compares table->record[0] and table->record[1]
+
+  Returns TRUE if different.
+*/
+static bool record_compare(TABLE *table)
+{
+  /*
+    Need to set the X bit and the filler bits in both records since
+    there are engines that do not set it correctly.
+
+    In addition, since MyISAM checks that one hasn't tampered with the
+    record, it is necessary to restore the old bytes into the record
+    after doing the comparison.
+
+    TODO[record format ndb]: Remove it once NDB returns correct
+    records. Check that the other engines also return correct records.
+   */
+
+  DBUG_DUMP("record[0]", table->record[0], table->s->reclength);
+  DBUG_DUMP("record[1]", table->record[1], table->s->reclength);
+
+  bool result= FALSE;
+  uchar saved_x[2]= {0, 0}, saved_filler[2]= {0, 0};
+
+  if (table->s->null_bytes > 0)
+  {
+    for (int i = 0 ; i < 2 ; ++i)
+    {
+      /* 
+        If we have an X bit then we need to take care of it.
+      */
+      if (!(table->s->db_options_in_use & HA_OPTION_PACK_RECORD))
+      {
+        saved_x[i]= table->record[i][0];
+        table->record[i][0]|= 1U;
+      }
+
+      /*
+         If (last_null_bit_pos == 0 && null_bytes > 1), then:
+
+         X bit (if any) + N nullable fields + M Field_bit fields = 8 bits 
+
+         Ie, the entire byte is used.
+      */
+      if (table->s->last_null_bit_pos > 0)
+      {
+        saved_filler[i]= table->record[i][table->s->null_bytes - 1];
+        table->record[i][table->s->null_bytes - 1]|=
+          256U - (1U << table->s->last_null_bit_pos);
+      }
+    }
+  }
+
+  /**
+    Compare full record only if:
+    - there are no blob fields (otherwise we would also need 
+      to compare blobs contents as well);
+    - there are no varchar fields (otherwise we would also need
+      to compare varchar contents as well);
+    - there are no null fields, otherwise NULLed fields 
+      contents (i.e., the don't care bytes) may show arbitrary 
+      values, depending on how each engine handles internally.
+    */
+  if ((table->s->blob_fields + 
+       table->s->varchar_fields + 
+       table->s->null_fields) == 0)
+  {
+    result= cmp_record(table,record[1]);
+    goto record_compare_exit;
+  }
+
+  /* Compare null bits */
+  if (memcmp(table->null_flags,
+	     table->null_flags+table->s->rec_buff_length,
+	     table->s->null_bytes))
+  {
+    result= TRUE;				// Diff in NULL value
+    goto record_compare_exit;
+  }
+
+  /* Compare fields */
+  for (Field **ptr=table->field ; *ptr ; ptr++)
+  {
+
+    /**
+      We only compare field contents that are not null.
+      NULL fields (i.e., their null bits) were compared 
+      earlier.
+    */
+    if (!(*(ptr))->is_null())
+    {
+      if ((*ptr)->cmp_binary_offset(table->s->rec_buff_length))
+      {
+        result= TRUE;
+        goto record_compare_exit;
+      }
+    }
+  }
+
+record_compare_exit:
+  /*
+    Restore the saved bytes.
+
+    TODO[record format ndb]: Remove this code once NDB returns the
+    correct record format.
+  */
+  if (table->s->null_bytes > 0)
+  {
+    for (int i = 0 ; i < 2 ; ++i)
+    {
+      if (!(table->s->db_options_in_use & HA_OPTION_PACK_RECORD))
+        table->record[i][0]= saved_x[i];
+
+      if (table->s->last_null_bit_pos)
+        table->record[i][table->s->null_bytes - 1]= saved_filler[i];
+    }
+  }
+
+  return result;
+}
+
+/* 
+  Check if we are already spending too much time on this statement.
+  if we are, warn user that it might be because table does not have
+  a PK, but only if the warning was not printed before for this STMT.
+
+  @param type          The event type code.
+  @param table_name    The name of the table that the slave is 
+                       operating.
+  @param is_index_scan States whether the slave is doing an index scan 
+                       or not.
+  @param rli           The relay metadata info.
+*/
+static inline 
+void issue_long_find_row_warning(Log_event_type type, 
+                                 const char *table_name,
+                                 bool is_index_scan,
+                                 const Relay_log_info *rli)
+{
+  if ((global_system_variables.log_warnings > 1 && 
+      !const_cast<Relay_log_info*>(rli)->is_long_find_row_note_printed()))
+  {
+    time_t now= my_time(0);
+    time_t stmt_ts= const_cast<Relay_log_info*>(rli)->get_row_stmt_start_timestamp();
+    
+    DBUG_EXECUTE_IF("inject_long_find_row_note", 
+                    stmt_ts-=(LONG_FIND_ROW_THRESHOLD*2););
+
+    long delta= (long) (now - stmt_ts);
+
+    if (delta > LONG_FIND_ROW_THRESHOLD)
+    {
+      const_cast<Relay_log_info*>(rli)->set_long_find_row_note_printed();
+      const char* evt_type= type == DELETE_ROWS_EVENT ? " DELETE" : "n UPDATE";
+      const char* scan_type= is_index_scan ? "scanning an index" : "scanning the table";
+
+      sql_print_information("The slave is applying a ROW event on behalf of a%s statement "
+                            "on table %s and is currently taking a considerable amount "
+                            "of time (%ld seconds). This is due to the fact that it is %s "
+                            "while looking up records to be processed. Consider adding a "
+                            "primary key (or unique key) to the table to improve "
+                            "performance.", evt_type, table_name, delta, scan_type);
+    }
+  }
+}
+
+/**
+  Locate the current row in event's table.
+
+  The current row is pointed by @c m_curr_row. Member @c m_width tells how many 
+  columns are there in the row (this can be differnet from the number of columns 
+  in the table). It is assumed that event's table is already open and pointed 
+  by @c m_table.
+
+  If a corresponding record is found in the table it is stored in 
+  @c m_table->record[0]. Note that when record is located based on a primary 
+  key, it is possible that the record found differs from the row being located.
+
+  If no key is specified or table does not have keys, a table scan is used to 
+  find the row. In that case the row should be complete and contain values for
+  all columns. However, it can still be shorter than the table, i.e. the table 
+  can contain extra columns not present in the row. It is also possible that 
+  the table has fewer columns than the row being located. 
+
+  @returns Error code on failure, 0 on success. 
+  
+  @post In case of success @c m_table->record[0] contains the record found. 
+  Also, the internal "cursor" of the table is positioned at the record found.
+
+  @note If the engine allows random access of the records, a combination of
+  @c position() and @c rnd_pos() will be used. 
+ */
+
+int Rows_log_event::find_row(const Relay_log_info *rli)
+{
+  DBUG_ENTER("Rows_log_event::find_row");
+
+  DBUG_ASSERT(m_table && m_table->in_use != NULL);
+
+  TABLE *table= m_table;
+  int error= 0;
+  bool is_table_scan= false, is_index_scan= false;
+
+  /*
+    rpl_row_tabledefs.test specifies that
+    if the extra field on the slave does not have a default value
+    and this is okay with Delete or Update events.
+    Todo: fix wl3228 hld that requires defauls for all types of events
+  */
+  
+  prepare_record(table, m_width, FALSE);
+  error= unpack_current_row(rli);
+
+#ifndef DBUG_OFF
+  DBUG_PRINT("info",("looking for the following record"));
+  DBUG_DUMP("record[0]", table->record[0], table->s->reclength);
+#endif
+
+  if ((table->file->ha_table_flags() & HA_PRIMARY_KEY_REQUIRED_FOR_POSITION) &&
+      table->s->primary_key < MAX_KEY)
+  {
+    /*
+      Use a more efficient method to fetch the record given by
+      table->record[0] if the engine allows it.  We first compute a
+      row reference using the position() member function (it will be
+      stored in table->file->ref) and the use rnd_pos() to position
+      the "cursor" (i.e., record[0] in this case) at the correct row.
+
+      TODO: Add a check that the correct record has been fetched by
+      comparing with the original record. Take into account that the
+      record on the master and slave can be of different
+      length. Something along these lines should work:
+
+      ADD>>>  store_record(table,record[1]);
+              int error= table->file->rnd_pos(table->record[0], table->file->ref);
+      ADD>>>  DBUG_ASSERT(memcmp(table->record[1], table->record[0],
+                                 table->s->reclength) == 0);
+
+    */
+    DBUG_PRINT("info",("locating record using primary key (position)"));
+    int error= table->file->rnd_pos_by_record(table->record[0]);
+    if (error)
+    {
+      DBUG_PRINT("info",("rnd_pos returns error %d",error));
+      if (error == HA_ERR_RECORD_DELETED)
+        error= HA_ERR_KEY_NOT_FOUND;
+      table->file->print_error(error, MYF(0));
+    }
+    DBUG_RETURN(error);
+  }
+
+  // We can't use position() - try other methods.
+  
+  /* 
+    We need to retrieve all fields
+    TODO: Move this out from this function to main loop 
+   */
+  table->use_all_columns();
+
+  /*
+    Save copy of the record in table->record[1]. It might be needed 
+    later if linear search is used to find exact match.
+   */ 
+  store_record(table,record[1]);    
+
+  if (table->s->keys > 0 && table->s->keys_in_use.is_set(0))
+  {
+    DBUG_PRINT("info",("locating record using primary key (index_read)"));
+
+    /* The 0th key is active: search the table using the index */
+    if (!table->file->inited && (error= table->file->ha_index_init(0, FALSE)))
+    {
+      DBUG_PRINT("info",("ha_index_init returns error %d",error));
+      table->file->print_error(error, MYF(0));
+      goto err;
+    }
+
+    /* Fill key data for the row */
+
+    DBUG_ASSERT(m_key);
+    key_copy(m_key, table->record[0], table->key_info, 0);
+
+    /*
+      Don't print debug messages when running valgrind since they can
+      trigger false warnings.
+     */
+#ifndef HAVE_purify
+    DBUG_DUMP("key data", m_key, table->key_info->key_length);
+#endif
+
+    /*
+      We need to set the null bytes to ensure that the filler bit are
+      all set when returning.  There are storage engines that just set
+      the necessary bits on the bytes and don't set the filler bits
+      correctly.
+    */
+    if (table->s->null_bytes > 0)
+      table->record[0][table->s->null_bytes - 1]|=
+        256U - (1U << table->s->last_null_bit_pos);
+
+    if ((error= table->file->index_read_map(table->record[0], m_key, 
+                                            HA_WHOLE_KEY,
+                                            HA_READ_KEY_EXACT)))
+    {
+      DBUG_PRINT("info",("no record matching the key found in the table"));
+      if (error == HA_ERR_RECORD_DELETED)
+        error= HA_ERR_KEY_NOT_FOUND;
+      table->file->print_error(error, MYF(0));
+      table->file->ha_index_end();
+      goto err;
+    }
+
+  /*
+    Don't print debug messages when running valgrind since they can
+    trigger false warnings.
+   */
+#ifndef HAVE_purify
+    DBUG_PRINT("info",("found first matching record")); 
+    DBUG_DUMP("record[0]", table->record[0], table->s->reclength);
+#endif
+    /*
+      Below is a minor "optimization".  If the key (i.e., key number
+      0) has the HA_NOSAME flag set, we know that we have found the
+      correct record (since there can be no duplicates); otherwise, we
+      have to compare the record with the one found to see if it is
+      the correct one.
+
+      CAVEAT! This behaviour is essential for the replication of,
+      e.g., the mysql.proc table since the correct record *shall* be
+      found using the primary key *only*.  There shall be no
+      comparison of non-PK columns to decide if the correct record is
+      found.  I can see no scenario where it would be incorrect to
+      chose the row to change only using a PK or an UNNI.
+    */
+    if (table->key_info->flags & HA_NOSAME)
+    {
+      /* Unique does not have non nullable part */
+      if (!(table->key_info->flags & (HA_NULL_PART_KEY)))
+      {
+        table->file->ha_index_end();
+        goto ok;
+      }
+      else
+      {
+        KEY *keyinfo= table->key_info;
+        /*
+          Unique has nullable part. We need to check if there is any field in the
+          BI image that is null and part of UNNI.
+        */
+        bool null_found= FALSE;
+        for (uint i=0; i < keyinfo->key_parts && !null_found; i++)
+        {
+          uint fieldnr= keyinfo->key_part[i].fieldnr - 1;
+          Field **f= table->field+fieldnr;
+          null_found= (*f)->is_null();
+        }
+
+        if (!null_found)
+        {
+          table->file->ha_index_end();
+          goto ok;
+        }
+
+        /* else fall through to index scan */
+      }
+    }
+
+    is_index_scan=true;
+
+    /*
+      In case key is not unique, we still have to iterate over records found
+      and find the one which is identical to the row given. A copy of the 
+      record we are looking for is stored in record[1].
+     */ 
+    DBUG_PRINT("info",("non-unique index, scanning it to find matching record")); 
+
+    while (record_compare(table))
+    {
+      /*
+        We need to set the null bytes to ensure that the filler bit
+        are all set when returning.  There are storage engines that
+        just set the necessary bits on the bytes and don't set the
+        filler bits correctly.
+
+        TODO[record format ndb]: Remove this code once NDB returns the
+        correct record format.
+      */
+      if (table->s->null_bytes > 0)
+      {
+        table->record[0][table->s->null_bytes - 1]|=
+          256U - (1U << table->s->last_null_bit_pos);
+      }
+
+      while ((error= table->file->index_next(table->record[0])))
+      {
+        /* We just skip records that has already been deleted */
+        if (error == HA_ERR_RECORD_DELETED)
+          continue;
+        DBUG_PRINT("info",("no record matching the given row found"));
+        table->file->print_error(error, MYF(0));
+        table->file->ha_index_end();
+        goto err;
+      }
+    }
+
+    /*
+      Have to restart the scan to be able to fetch the next row.
+    */
+    table->file->ha_index_end();
+  }
+  else
+  {
+    DBUG_PRINT("info",("locating record using table scan (rnd_next)"));
+
+    int restart_count= 0; // Number of times scanning has restarted from top
+
+    /* We don't have a key: search the table using rnd_next() */
+    if ((error= table->file->ha_rnd_init(1)))
+    {
+      DBUG_PRINT("info",("error initializing table scan"
+                         " (ha_rnd_init returns %d)",error));
+      table->file->print_error(error, MYF(0));
+      goto err;
+    }
+
+    is_table_scan= true;
+
+    /* Continue until we find the right record or have made a full loop */
+    do
+    {
+  restart_rnd_next:
+      error= table->file->rnd_next(table->record[0]);
+
+      if (error)
+        DBUG_PRINT("info", ("error: %s", HA_ERR(error)));
+      switch (error) {
+
+      case 0:
+        break;
+
+      /*
+        If the record was deleted, we pick the next one without doing
+        any comparisons.
+      */
+      case HA_ERR_RECORD_DELETED:
+        goto restart_rnd_next;
+
+      case HA_ERR_END_OF_FILE:
+        if (++restart_count < 2)
+        {
+          if ((error= table->file->ha_rnd_init(1)))
+          {
+            table->file->print_error(error, MYF(0));
+            goto err;
+          }
+          goto restart_rnd_next;
+        }
+        break;
+
+      default:
+        DBUG_PRINT("info", ("Failed to get next record"
+                            " (rnd_next returns %d)",error));
+        table->file->print_error(error, MYF(0));
+        (void) table->file->ha_rnd_end();
+        goto err;
+      }
+    }
+    while (restart_count < 2 && record_compare(table));
+
+    /* 
+      Note: above record_compare will take into accout all record fields 
+      which might be incorrect in case a partial row was given in the event
+     */
+
+    /*
+      Have to restart the scan to be able to fetch the next row.
+    */
+    if (restart_count == 2)
+      DBUG_PRINT("info", ("Record not found"));
+    else
+      DBUG_DUMP("record found", table->record[0], table->s->reclength);
+    table->file->ha_rnd_end();
+
+    DBUG_ASSERT(error == HA_ERR_END_OF_FILE || error == 0);
+    goto err;
+  }
+ok:
+  if (is_table_scan || is_index_scan)
+    issue_long_find_row_warning(get_type_code(), m_table->alias, 
+                                is_index_scan, rli);
+
+  table->default_column_bitmaps();
+  DBUG_RETURN(0);
+
+err:
+  if (is_table_scan || is_index_scan)
+    issue_long_find_row_warning(get_type_code(), m_table->alias, 
+                                is_index_scan, rli);
+
+  table->default_column_bitmaps();
+  DBUG_RETURN(error);
+}
+
+#endif
+
+/*
+  Constructor used to build an event for writing to the binary log.
+ */
+
+#ifndef MYSQL_CLIENT
+Delete_rows_log_event::Delete_rows_log_event(THD *thd_arg, TABLE *tbl_arg,
+                                             ulong tid, MY_BITMAP const *cols,
+                                             bool is_transactional)
+  : Rows_log_event(thd_arg, tbl_arg, tid, cols, is_transactional)
+{
+}
+#endif /* #if !defined(MYSQL_CLIENT) */
+
+/*
+  Constructor used by slave to read the event from the binary log.
+ */
+#ifdef HAVE_REPLICATION
+Delete_rows_log_event::Delete_rows_log_event(const char *buf, uint event_len,
+                                             const Format_description_log_event
+                                             *description_event)
+  : Rows_log_event(buf, event_len, DELETE_ROWS_EVENT, description_event)
+{
+}
+#endif
+
+#if !defined(MYSQL_CLIENT) && defined(HAVE_REPLICATION)
+
+int 
+Delete_rows_log_event::do_before_row_operations(const Slave_reporting_capability *const)
+{
+  /*
+    Increment the global status delete count variable
+   */
+  if (get_flags(STMT_END_F))
+    status_var_increment(thd->status_var.com_stat[SQLCOM_DELETE]);
+
+  if ((m_table->file->ha_table_flags() & HA_PRIMARY_KEY_REQUIRED_FOR_POSITION) &&
+      m_table->s->primary_key < MAX_KEY)
+  {
+    /*
+      We don't need to allocate any memory for m_key since it is not used.
+    */
+    return 0;
+  }
+
+  if (m_table->s->keys > 0)
+  {
+    // Allocate buffer for key searches
+    m_key= (uchar*)my_malloc(m_table->key_info->key_length, MYF(MY_WME));
+    if (!m_key)
+      return HA_ERR_OUT_OF_MEM;
+  }
+  return 0;
+}
+
+int 
+Delete_rows_log_event::do_after_row_operations(const Slave_reporting_capability *const, 
+                                               int error)
+{
+  /*error= ToDo:find out what this should really be, this triggers close_scan in nbd, returning error?*/
+  m_table->file->ha_index_or_rnd_end();
+  my_free(m_key);
+  m_key= NULL;
+
+  return error;
+}
+
+int Delete_rows_log_event::do_exec_row(const Relay_log_info *const rli)
+{
+  int error;
+  DBUG_ASSERT(m_table != NULL);
+
+  if (!(error= find_row(rli))) 
+  { 
+    /*
+      Delete the record found, located in record[0]
+    */
+    error= m_table->file->ha_delete_row(m_table->record[0]);
+  }
+  return error;
+}
+
+#endif /* !defined(MYSQL_CLIENT) && defined(HAVE_REPLICATION) */
+
+#ifdef MYSQL_CLIENT
+void Delete_rows_log_event::print(FILE *file,
+                                  PRINT_EVENT_INFO* print_event_info)
+{
+  Rows_log_event::print_helper(file, print_event_info, "Delete_rows");
+}
+#endif
+
+
+/**************************************************************************
+	Update_rows_log_event member functions
+**************************************************************************/
+
+/*
+  Constructor used to build an event for writing to the binary log.
+ */
+#if !defined(MYSQL_CLIENT)
+Update_rows_log_event::Update_rows_log_event(THD *thd_arg, TABLE *tbl_arg,
+                                             ulong tid,
+                                             MY_BITMAP const *cols_bi,
+                                             MY_BITMAP const *cols_ai,
+                                             bool is_transactional)
+: Rows_log_event(thd_arg, tbl_arg, tid, cols_bi, is_transactional)
+{
+  init(cols_ai);
+}
+
+Update_rows_log_event::Update_rows_log_event(THD *thd_arg, TABLE *tbl_arg,
+                                             ulong tid,
+                                             MY_BITMAP const *cols,
+                                             bool is_transactional)
+: Rows_log_event(thd_arg, tbl_arg, tid, cols, is_transactional)
+{
+  init(cols);
+}
+
+void Update_rows_log_event::init(MY_BITMAP const *cols)
+{
+  /* if bitmap_init fails, caught in is_valid() */
+  if (likely(!bitmap_init(&m_cols_ai,
+                          m_width <= sizeof(m_bitbuf_ai)*8 ? m_bitbuf_ai : NULL,
+                          m_width,
+                          false)))
+  {
+    /* Cols can be zero if this is a dummy binrows event */
+    if (likely(cols != NULL))
+    {
+      memcpy(m_cols_ai.bitmap, cols->bitmap, no_bytes_in_map(cols));
+      create_last_word_mask(&m_cols_ai);
+    }
+  }
+}
+#endif /* !defined(MYSQL_CLIENT) */
+
+
+Update_rows_log_event::~Update_rows_log_event()
+{
+  if (m_cols_ai.bitmap == m_bitbuf_ai) // no my_malloc happened
+    m_cols_ai.bitmap= 0; // so no my_free in bitmap_free
+  bitmap_free(&m_cols_ai); // To pair with bitmap_init().
+}
+
+
+/*
+  Constructor used by slave to read the event from the binary log.
+ */
+#ifdef HAVE_REPLICATION
+Update_rows_log_event::Update_rows_log_event(const char *buf, uint event_len,
+                                             const
+                                             Format_description_log_event
+                                             *description_event)
+  : Rows_log_event(buf, event_len, UPDATE_ROWS_EVENT, description_event)
+{
+}
+#endif
+
+#if !defined(MYSQL_CLIENT) && defined(HAVE_REPLICATION)
+
+int 
+Update_rows_log_event::do_before_row_operations(const Slave_reporting_capability *const)
+{
+  /*
+    Increment the global status update count variable
+  */
+  if (get_flags(STMT_END_F))
+    status_var_increment(thd->status_var.com_stat[SQLCOM_UPDATE]);
+
+  if (m_table->s->keys > 0)
+  {
+    // Allocate buffer for key searches
+    m_key= (uchar*)my_malloc(m_table->key_info->key_length, MYF(MY_WME));
+    if (!m_key)
+      return HA_ERR_OUT_OF_MEM;
+  }
+
+  m_table->timestamp_field_type= TIMESTAMP_NO_AUTO_SET;
+
+  return 0;
+}
+
+int 
+Update_rows_log_event::do_after_row_operations(const Slave_reporting_capability *const, 
+                                               int error)
+{
+  /*error= ToDo:find out what this should really be, this triggers close_scan in nbd, returning error?*/
+  m_table->file->ha_index_or_rnd_end();
+  my_free(m_key); // Free for multi_malloc
+  m_key= NULL;
+
+  return error;
+}
+
+int 
+Update_rows_log_event::do_exec_row(const Relay_log_info *const rli)
+{
+  DBUG_ASSERT(m_table != NULL);
+
+  int error= find_row(rli); 
+  if (error)
+  {
+    /*
+      We need to read the second image in the event of error to be
+      able to skip to the next pair of updates
+    */
+    m_curr_row= m_curr_row_end;
+    unpack_current_row(rli);
+    return error;
+  }
+
+  /*
+    This is the situation after locating BI:
+
+    ===|=== before image ====|=== after image ===|===
+       ^                     ^
+       m_curr_row            m_curr_row_end
+
+    BI found in the table is stored in record[0]. We copy it to record[1]
+    and unpack AI to record[0].
+   */
+
+  store_record(m_table,record[1]);
+
+  m_curr_row= m_curr_row_end;
+  /* this also updates m_curr_row_end */
+  if ((error= unpack_current_row(rli)))
+    return error;
+
+  /*
+    Now we have the right row to update.  The old row (the one we're
+    looking for) is in record[1] and the new row is in record[0].
+  */
+#ifndef HAVE_purify
+  /*
+    Don't print debug messages when running valgrind since they can
+    trigger false warnings.
+   */
+  DBUG_PRINT("info",("Updating row in table"));
+  DBUG_DUMP("old record", m_table->record[1], m_table->s->reclength);
+  DBUG_DUMP("new values", m_table->record[0], m_table->s->reclength);
+#endif
+
+  error= m_table->file->ha_update_row(m_table->record[1], m_table->record[0]);
+  if (error == HA_ERR_RECORD_IS_THE_SAME)
+    error= 0;
+
+  return error;
+}
+
+#endif /* !defined(MYSQL_CLIENT) && defined(HAVE_REPLICATION) */
+
+#ifdef MYSQL_CLIENT
+void Update_rows_log_event::print(FILE *file,
+				  PRINT_EVENT_INFO* print_event_info)
+{
+  Rows_log_event::print_helper(file, print_event_info, "Update_rows");
+}
+#endif
+
+
+Incident_log_event::Incident_log_event(const char *buf, uint event_len,
+                                       const Format_description_log_event *descr_event)
+  : Log_event(buf, descr_event)
+{
+  DBUG_ENTER("Incident_log_event::Incident_log_event");
+  uint8 const common_header_len=
+    descr_event->common_header_len;
+  uint8 const post_header_len=
+    descr_event->post_header_len[INCIDENT_EVENT-1];
+
+  DBUG_PRINT("info",("event_len: %u; common_header_len: %d; post_header_len: %d",
+                     event_len, common_header_len, post_header_len));
+
+  int incident_number= uint2korr(buf + common_header_len);
+  if (incident_number >= INCIDENT_COUNT ||
+      incident_number <= INCIDENT_NONE)
+  {
+    // If the incident is not recognized, this binlog event is
+    // invalid.  If we set incident_number to INCIDENT_NONE, the
+    // invalidity will be detected by is_valid().
+    m_incident= INCIDENT_NONE;
+    DBUG_VOID_RETURN;
+  }
+  m_incident= static_cast<Incident>(incident_number);
+  char const *ptr= buf + common_header_len + post_header_len;
+  char const *const str_end= buf + event_len;
+  uint8 len= 0;                   // Assignment to keep compiler happy
+  const char *str= NULL;          // Assignment to keep compiler happy
+  read_str(&ptr, str_end, &str, &len);
+  m_message.str= const_cast<char*>(str);
+  m_message.length= len;
+  DBUG_PRINT("info", ("m_incident: %d", m_incident));
+  DBUG_VOID_RETURN;
+}
+
+
+Incident_log_event::~Incident_log_event()
+{
+}
+
+
+const char *
+Incident_log_event::description() const
+{
+  static const char *const description[]= {
+    "NOTHING",                                  // Not used
+    "LOST_EVENTS"
+  };
+
+  DBUG_PRINT("info", ("m_incident: %d", m_incident));
+
+  return description[m_incident];
+}
+
+
+#ifndef MYSQL_CLIENT
+void Incident_log_event::pack_info(Protocol *protocol)
+{
+  char buf[256];
+  size_t bytes;
+  if (m_message.length > 0)
+    bytes= my_snprintf(buf, sizeof(buf), "#%d (%s)",
+                       m_incident, description());
+  else
+    bytes= my_snprintf(buf, sizeof(buf), "#%d (%s): %s",
+                       m_incident, description(), m_message.str);
+  protocol->store(buf, bytes, &my_charset_bin);
+}
+#endif
+
+
+#ifdef MYSQL_CLIENT
+void
+Incident_log_event::print(FILE *file,
+                          PRINT_EVENT_INFO *print_event_info)
+{
+  if (print_event_info->short_form)
+    return;
+
+  Write_on_release_cache cache(&print_event_info->head_cache, file);
+  print_header(&cache, print_event_info, FALSE);
+  my_b_printf(&cache, "\n# Incident: %s\nRELOAD DATABASE; # Shall generate syntax error\n", description());
+}
+#endif
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+int
+Incident_log_event::do_apply_event(Relay_log_info const *rli)
+{
+  DBUG_ENTER("Incident_log_event::do_apply_event");
+  rli->report(ERROR_LEVEL, ER_SLAVE_INCIDENT,
+              ER(ER_SLAVE_INCIDENT),
+              description(),
+              m_message.length > 0 ? m_message.str : "<none>");
+  DBUG_RETURN(1);
+}
+#endif
+
+bool
+Incident_log_event::write_data_header(IO_CACHE *file)
+{
+  DBUG_ENTER("Incident_log_event::write_data_header");
+  DBUG_PRINT("enter", ("m_incident: %d", m_incident));
+  uchar buf[sizeof(int16)];
+  int2store(buf, (int16) m_incident);
+  DBUG_RETURN(my_b_safe_write(file, buf, sizeof(buf)));
+}
+
+bool
+Incident_log_event::write_data_body(IO_CACHE *file)
+{
+  DBUG_ENTER("Incident_log_event::write_data_body");
+  DBUG_RETURN(write_str(file, m_message.str, (uint) m_message.length));
+}
+
+
+#ifdef MYSQL_CLIENT
+/**
+  The default values for these variables should be values that are
+  *incorrect*, i.e., values that cannot occur in an event.  This way,
+  they will always be printed for the first event.
+*/
+st_print_event_info::st_print_event_info()
+  :flags2_inited(0), sql_mode_inited(0), sql_mode(0),
+   auto_increment_increment(0),auto_increment_offset(0), charset_inited(0),
+   lc_time_names_number(~0),
+   charset_database_number(ILLEGAL_CHARSET_INFO_NUMBER),
+   thread_id(0), thread_id_printed(false),
+   base64_output_mode(BASE64_OUTPUT_UNSPEC), printed_fd_event(FALSE)
+{
+  /*
+    Currently we only use static PRINT_EVENT_INFO objects, so zeroed at
+    program's startup, but these explicit bzero() is for the day someone
+    creates dynamic instances.
+  */
+  bzero(db, sizeof(db));
+  bzero(charset, sizeof(charset));
+  bzero(time_zone_str, sizeof(time_zone_str));
+  delimiter[0]= ';';
+  delimiter[1]= 0;
+  myf const flags = MYF(MY_WME | MY_NABP);
+  open_cached_file(&head_cache, NULL, NULL, 0, flags);
+  open_cached_file(&body_cache, NULL, NULL, 0, flags);
+}
+#endif
+
+
+#if defined(HAVE_REPLICATION) && !defined(MYSQL_CLIENT)
+Heartbeat_log_event::Heartbeat_log_event(const char* buf, uint event_len,
+                    const Format_description_log_event* description_event)
+  :Log_event(buf, description_event)
+{
+  uint8 header_size= description_event->common_header_len;
+  ident_len = event_len - header_size;
+  set_if_smaller(ident_len,FN_REFLEN-1);
+  log_ident= buf + header_size;
+}
+#endif
+
+#ifdef MYSQL_SERVER
+/*
+  This is a utility function that adds a quoted identifier into the a buffer.
+  This also escapes any existance of the quote string inside the identifier.
+
+  SYNOPSIS
+    my_strmov_quoted_identifier
+    thd                   thread handler
+    buffer                target buffer
+    identifier            the identifier to be quoted
+    length                length of the identifier
+*/
+size_t my_strmov_quoted_identifier(THD* thd, char *buffer,
+                                   const char* identifier,
+                                   uint length)
+{
+  int q= thd ? get_quote_char_for_identifier(thd, identifier, length) : '`';
+  return my_strmov_quoted_identifier_helper(q, buffer, identifier, length);
+}
+#else
+size_t my_strmov_quoted_identifier(char *buffer,  const char* identifier)
+{
+  int q= '`';
+  return my_strmov_quoted_identifier_helper(q, buffer, identifier, 0);
+}
+
+#endif
+
+size_t my_strmov_quoted_identifier_helper(int q, char *buffer,
+                                          const char* identifier,
+                                          uint length)
+{
+  size_t written= 0;
+  char quote_char;
+  uint id_length= (length) ? length : strlen(identifier);
+
+  if (q == EOF)
+  {
+    (void *) strncpy(buffer, identifier, id_length);
+    return id_length;
+  }
+  quote_char= (char) q;
+  *buffer++= quote_char;
+  written++;
+  while (id_length--)
+  {
+    if (*identifier == quote_char)
+    {
+      *buffer++= quote_char;
+      written++;
+    }
+    *buffer++= *identifier++;
+    written++;
+  }
+  *buffer++= quote_char;
+  return ++written;
+}
+
diff -uNr mysql-5.5.60.orig/sql-common/client_plugin.c mysql-5.5.60/sql-common/client_plugin.c
--- mysql-5.5.60.orig/sql-common/client_plugin.c	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/sql-common/client_plugin.c	2018-12-02 00:06:23.365891768 +0800
@@ -233,11 +233,13 @@
 {
   MYSQL mysql;
   struct st_mysql_client_plugin **builtin;
+  va_list unused;
 
   if (initialized)
     return 0;
 
   bzero(&mysql, sizeof(mysql)); /* dummy mysql for set_mysql_extended_error */
+  bzero(&unused, sizeof(unused)); /* suppress uninitialized-value warnings */
 
   pthread_mutex_init(&LOCK_load_client_plugin, MY_MUTEX_INIT_SLOW);
   init_alloc_root(&mem_root, 128, 128);
@@ -249,7 +251,7 @@
   pthread_mutex_lock(&LOCK_load_client_plugin);
 
   for (builtin= mysql_client_builtins; *builtin; builtin++)
-    add_plugin(&mysql, *builtin, 0, 0, 0);
+    add_plugin(&mysql, *builtin, 0, 0, unused);
 
   pthread_mutex_unlock(&LOCK_load_client_plugin);
 
@@ -293,9 +295,13 @@
 mysql_client_register_plugin(MYSQL *mysql,
                              struct st_mysql_client_plugin *plugin)
 {
+  va_list unused;
+
   if (is_not_initialized(mysql, plugin->name))
     return NULL;
 
+  bzero(&unused, sizeof(unused)); /* suppress uninitialized-value warnings */
+
   pthread_mutex_lock(&LOCK_load_client_plugin);
 
   /* make sure the plugin wasn't loaded meanwhile */
@@ -307,7 +313,7 @@
     plugin= NULL;
   }
   else
-    plugin= add_plugin(mysql, plugin, 0, 0, 0);
+    plugin= add_plugin(mysql, plugin, 0, 0, unused);
 
   pthread_mutex_unlock(&LOCK_load_client_plugin);
   return plugin;
diff -uNr mysql-5.5.60.orig/storage/myisam/mi_rnext.c mysql-5.5.60/storage/myisam/mi_rnext.c
--- mysql-5.5.60.orig/storage/myisam/mi_rnext.c	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/storage/myisam/mi_rnext.c	2018-12-02 00:06:23.397892097 +0800
@@ -64,7 +64,7 @@
       Normally SQL layer would never request "search next" if
       "search first" failed. But HANDLER may do anything.
 
-      As mi_rnext() without preceeding mi_rkey()/mi_rfirst()
+      As mi_rnext() without preceding mi_rkey()/mi_rfirst()
       equals to mi_rfirst(), we must restore original state
       as if failing mi_rfirst() was not called.
     */
diff -uNr mysql-5.5.60.orig/storage/ndb/test/odbc/client/SQLColAttributeTest.cpp mysql-5.5.60/storage/ndb/test/odbc/client/SQLColAttributeTest.cpp
--- mysql-5.5.60.orig/storage/ndb/test/odbc/client/SQLColAttributeTest.cpp	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/storage/ndb/test/odbc/client/SQLColAttributeTest.cpp	2018-12-02 00:06:23.401892138 +0800
@@ -42,7 +42,7 @@
  * Test returning descriptor information
  *
  * Tests:
- * -# Call SQLColAttribute, without preceeding SQLPrepare
+ * -# Call SQLColAttribute, without preceding SQLPrepare
  * -# ???
  * 
  * @return Zero, if test succeeded
diff -uNr mysql-5.5.60.orig/storage/ndb/test/odbc/client/SQLColAttributeTest.cpp.orig mysql-5.5.60/storage/ndb/test/odbc/client/SQLColAttributeTest.cpp.orig
--- mysql-5.5.60.orig/storage/ndb/test/odbc/client/SQLColAttributeTest.cpp.orig	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/storage/ndb/test/odbc/client/SQLColAttributeTest.cpp.orig	2018-02-26 21:02:31.000000000 +0800
@@ -0,0 +1,328 @@
+/* Copyright (c) 2003, 2005 MySQL AB
+   Use is subject to license terms
+
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; version 2 of the License.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program; if not, write to the Free Software
+   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA */
+
+/**
+ * @file SQLColAttributeTest.cpp
+ */
+
+#include <common.hpp>
+using namespace std;
+
+#define MAXIMUM_MESSAGE_LENGTH_Test 200
+#define BufferLengthTest 156
+
+SQLHSTMT    ColAtt_hstmt;
+SQLHSTMT    ColAtt_hdbc;
+SQLHENV     ColAtt_henv;
+SQLHDESC    ColAtt_hdesc;
+
+SQLCHAR        CharacterAttributePtr;
+SQLINTEGER     NumericAttributePtr;
+SQLSMALLINT    StringLengthPtr;
+
+SQLRETURN ColAtt_ret;
+
+void ColAtt_DisplayError(SQLSMALLINT ColAtt_HandleType, 
+			 SQLHSTMT ColAtt_InputHandle);
+
+/** 
+ * Test returning descriptor information
+ *
+ * Tests:
+ * -# Call SQLColAttribute, without preceeding SQLPrepare
+ * -# ???
+ * 
+ * @return Zero, if test succeeded
+ */
+int SQLColAttributeTest()
+{
+  ndbout << endl << "Start SQLColAttribute Testing" << endl;
+
+  SQLCHAR SQLStmt [120];
+
+  /********************************************************************
+   ** Test 1:                                                        **
+   **                                                                **
+   ** Checks to execute SQLColAttribute, when there is no            **
+   ** prepared or executed statement associated with StatementHandle **
+   **                                                                **
+   ** Intended result:  SQL_ERROR ???                                **
+   ********************************************************************/
+  ColAtt_ret = SQLColAttribute(ColAtt_hstmt, 
+			       1, 
+			       SQL_DESC_AUTO_UNIQUE_VALUE, 
+			       &CharacterAttributePtr, 
+			       BufferLengthTest, 
+			       &StringLengthPtr, 
+			       &NumericAttributePtr);
+
+  if (ColAtt_ret == SQL_ERROR)
+    {
+      ndbout << "ColAtt_ret = " << ColAtt_ret << endl;
+      ndbout << endl << "There is no prepared or executed" << endl 
+	     << " statement associated with StatementHandle" << endl;
+      ColAtt_DisplayError(SQL_HANDLE_STMT, ColAtt_hstmt);
+    }
+  else if (ColAtt_ret == SQL_SUCCESS_WITH_INFO)
+    {
+      ndbout << "ColAtt_ret = " << ColAtt_ret << endl;
+      ndbout << endl << "There is no prepared or executed" << endl 
+	     << " statement associated with StatementHandle" << endl;
+      ColAtt_DisplayError(SQL_HANDLE_STMT, ColAtt_hstmt);
+    }
+  else if (ColAtt_ret == SQL_SUCCESS)
+    {
+      ndbout << "ColAtt_ret = " << ColAtt_ret << endl;
+      ndbout << endl << "There is no prepared or executed" << endl 
+	     << " statement associated with StatementHandle" << endl;
+      ColAtt_DisplayError(SQL_HANDLE_STMT, ColAtt_hstmt);
+    }
+  else if (ColAtt_ret == -2)
+    {
+      ndbout << "ColAtt_ret = " << ColAtt_ret << endl;
+      ndbout << endl << "There is no prepared or executed" << endl 
+	     << " statement associated with StatementHandle" << endl;
+      ColAtt_DisplayError(SQL_HANDLE_STMT, ColAtt_hstmt);
+    }
+  else 
+    {
+      ndbout << "ColAtt_ret = " << ColAtt_ret << endl;
+      ndbout << endl << "There is no prepared or executed" << endl 
+	     << " statement associated with StatementHandle" << endl;
+      ColAtt_DisplayError(SQL_HANDLE_STMT, ColAtt_hstmt);
+    }
+
+  //*******************************************************************
+  //** Test 2:                                                       **
+  //**                                                               **
+  //** hstmt                                                         **
+  //** Execute a statement to retrieve rows from the Customers table **
+  //** We can create the table and insert rows into Mysql            **
+  //**                                                               **
+  //** Intended result: ???                                          **
+  //*******************************************************************
+
+  //************************************
+  //** Allocate An Environment Handle **
+  //************************************
+  ColAtt_ret = SQLAllocHandle(SQL_HANDLE_ENV, 
+			      SQL_NULL_HANDLE, 
+			      &ColAtt_henv);
+  
+  if (ColAtt_ret == SQL_SUCCESS || ColAtt_ret == SQL_SUCCESS_WITH_INFO)
+    ndbout << "Allocated an environment Handle!" << endl;
+
+  //*********************************************
+  //** Set the ODBC application Version to 2.x **
+  //*********************************************
+  ColAtt_ret = SQLSetEnvAttr(ColAtt_henv, 
+			     SQL_ATTR_ODBC_VERSION, 
+			     (SQLPOINTER) SQL_OV_ODBC2, 
+			     SQL_IS_UINTEGER);
+  
+  if (ColAtt_ret == SQL_SUCCESS || ColAtt_ret == SQL_SUCCESS_WITH_INFO)
+    ndbout << "Set the ODBC application Version to 2.x!" << endl;
+
+  //**********************************
+  //** Allocate A Connection Handle **
+  //**********************************
+
+  ColAtt_ret = SQLAllocHandle(SQL_HANDLE_DBC, 
+			      ColAtt_henv, 
+			      &ColAtt_hdbc);
+
+  if (ColAtt_ret == SQL_SUCCESS || ColAtt_ret == SQL_SUCCESS_WITH_INFO)
+    ndbout << "Allocated a connection Handle!" << endl;
+
+  // *******************
+  // ** Connect to DB **
+  // *******************
+  ColAtt_ret = SQLConnect(ColAtt_hdbc, 
+			  (SQLCHAR *) connectString(), 
+			  SQL_NTS, 
+			  (SQLCHAR *) "", 
+			  SQL_NTS, 
+			  (SQLCHAR *) "", 
+			  SQL_NTS);
+  
+  if (ColAtt_ret == SQL_SUCCESS || ColAtt_ret == SQL_SUCCESS_WITH_INFO)
+    ndbout << "Connected to DB : OK!" << endl;
+  else 
+    {  
+      ndbout << "Failure to Connect DB!" << endl;
+      return NDBT_FAILED;
+    }
+  //*******************************
+  //** Allocate statement handle **
+  //*******************************
+  
+  ColAtt_ret = SQLAllocHandle(SQL_HANDLE_STMT, 
+			      ColAtt_hdbc, 
+			      &ColAtt_hstmt); 
+  if(ColAtt_ret == SQL_SUCCESS || ColAtt_ret == SQL_SUCCESS_WITH_INFO) 
+    ndbout << "Allocated a statement handle!" << endl;
+
+  //************************
+  //** Define a statement **
+  //************************
+
+  /*
+  strcpy((char *) SQLStmt, 
+	 "DELETE FROM Customers WHERE CustID = 6");
+   */
+
+    strcpy((char *) SQLStmt, 
+    "INSERT INTO Customers (CustID, Name, Address, Phone) VALUES (6, 'Jan', 'LM vag 8', '969696')");
+
+    /*
+    strcpy((char *) SQLStmt, 
+    "INSERT INTO Customers (CustID, Name, Address, Phone) VALUES (?, ?, ?, ?)");
+    */
+
+  //********************************
+  //** Prepare  SQL statement     **
+  //********************************
+  ColAtt_ret = SQLPrepare(ColAtt_hstmt, 
+			  SQLStmt, 
+			  SQL_NTS);
+  
+  if (ColAtt_ret == SQL_SUCCESS || ColAtt_ret == SQL_SUCCESS_WITH_INFO) 
+    {
+      //**************************************************************
+      //** FieldIdentifer is not one of the code valuess in Table 20, 
+      //** "Codes used for descriptor fields" 
+      //**************************************************************
+      ColAtt_ret = SQLColAttribute(ColAtt_hstmt, 
+				   2, 
+				   9999, 
+				   &CharacterAttributePtr, 
+				   BufferLengthTest, 
+				   &StringLengthPtr, 
+				   &NumericAttributePtr);
+      
+      if (ColAtt_ret == SQL_ERROR || ColAtt_ret == SQL_SUCCESS_WITH_INFO)
+	{
+	  ndbout << endl << "FieldIdentifer is not one of the" << endl;  
+	  ndbout << "code valuess in Table 20, Codes used for" << endl;
+	  ndbout << "descriptor fields" <<endl;
+	  ColAtt_DisplayError(SQL_HANDLE_STMT, ColAtt_hstmt);
+	}
+
+      //****************************************************************
+      //** Let TYPE is 'ITEM' in Table 20, ColumnNumber is less than one
+      //****************************************************************
+      ColAtt_ret = SQLColAttribute(ColAtt_hstmt, 
+				   -1, 
+				   SQL_DESC_BASE_COLUMN_NAME, 
+				   &CharacterAttributePtr, 
+				   BufferLengthTest, 
+				   &StringLengthPtr, 
+				   &NumericAttributePtr);
+
+      if (ColAtt_ret == SQL_ERROR || ColAtt_ret == SQL_SUCCESS_WITH_INFO)
+	{
+	  ndbout << "Let TYPE is 'ITEM' in Table 20,ColumnNumber" 
+		 << "is less than one" << endl;
+	  ColAtt_DisplayError(SQL_HANDLE_STMT, ColAtt_hstmt);
+	}
+      
+      //*********************************************************
+      //** Let TYPE is 'ITEM' in Table 20, FieldIdentifer is zero 
+      //*********************************************************
+      ColAtt_ret = SQLColAttribute(ColAtt_hstmt, 
+				   1018, 
+				   0, 
+				   &CharacterAttributePtr, 
+				   BufferLengthTest,
+				   &StringLengthPtr,
+				   &NumericAttributePtr);
+      
+      if (ColAtt_ret == SQL_ERROR || ColAtt_ret == SQL_SUCCESS_WITH_INFO)
+	{
+	  ndbout << "Let TYPE is 'ITEM' in Table 20, FieldIdentifer" 
+		 << " is zero"  <<endl;
+	  ColAtt_DisplayError(SQL_HANDLE_STMT, ColAtt_hstmt);
+        }
+
+      //**********************************************************
+      //** Let TYPE is 'ITEM' in Table 20, ColumnNumber is greater 
+      //** than TOP_LEVEL_COUNT(1044) 
+      //*********************************************************
+      ColAtt_ret = SQLColAttribute(ColAtt_hstmt, 
+				   1045, 
+				   SQL_DESC_BASE_COLUMN_NAME, 
+				   &CharacterAttributePtr, 
+				   BufferLengthTest, 
+				   &StringLengthPtr, 
+				   &NumericAttributePtr);
+      
+      if (ColAtt_ret == SQL_ERROR || ColAtt_ret == SQL_SUCCESS_WITH_INFO)
+	{
+	  ndbout << "Let TYPE is 'ITEM' in Table 20, ColumnNumber" << endl 
+		 << "is greater than TOP_LEVEL_COUNT(1044)" << endl;
+	  ColAtt_DisplayError(SQL_HANDLE_STMT, ColAtt_hstmt);
+	}
+      
+    }
+
+  // *********************************
+  // ** Disconnect and Free Handles **
+  // *********************************  
+  SQLDisconnect(ColAtt_hdbc);
+  SQLFreeHandle(SQL_HANDLE_STMT, ColAtt_hstmt);
+  SQLFreeHandle(SQL_HANDLE_DBC, ColAtt_hdbc);
+  SQLFreeHandle(SQL_HANDLE_ENV, ColAtt_henv);
+
+  return NDBT_OK;
+}
+
+void ColAtt_DisplayError(SQLSMALLINT ColAtt_HandleType, 
+			 SQLHSTMT ColAtt_InputHandle)
+{
+  SQLSMALLINT ColAtt_i = 1;
+  SQLRETURN ColAtt_SQLSTATEs;
+  SQLCHAR ColAtt_Sqlstate[5];
+  SQLCHAR ColAtt_Msg[MAXIMUM_MESSAGE_LENGTH_Test];
+  SQLSMALLINT ColAtt_MsgLen;
+  SQLINTEGER  ColAtt_NativeError;
+
+  ndbout << "-------------------------------------------------" << endl;
+  ndbout << "Error diagnostics:" << endl;
+  
+  while ((ColAtt_SQLSTATEs = SQLGetDiagRec(ColAtt_HandleType, 
+					   ColAtt_InputHandle, 
+					   ColAtt_i, 
+					   ColAtt_Sqlstate, 
+					   &ColAtt_NativeError, 
+					   ColAtt_Msg, 
+					   sizeof(ColAtt_Msg), 
+					   &ColAtt_MsgLen)) 
+	 != SQL_NO_DATA)                   
+    {
+      
+      ndbout << "the HandleType is:" << ColAtt_HandleType << endl;
+      ndbout << "the InputHandle is :" << (long)ColAtt_InputHandle << endl;
+      ndbout << "the ColAtt_Msg is: " << (char *) ColAtt_Msg << endl;
+      ndbout << "the output state is:" << (char *)ColAtt_Sqlstate << endl; 
+      
+      ColAtt_i ++;
+      break;
+    }
+  ndbout << "-------------------------------------------------" << endl;
+}
+
+
+
diff -uNr mysql-5.5.60.orig/storage/ndb/test/odbc/client/SQLColAttributeTest2.cpp mysql-5.5.60/storage/ndb/test/odbc/client/SQLColAttributeTest2.cpp
--- mysql-5.5.60.orig/storage/ndb/test/odbc/client/SQLColAttributeTest2.cpp	2018-02-26 21:02:31.000000000 +0800
+++ mysql-5.5.60/storage/ndb/test/odbc/client/SQLColAttributeTest2.cpp	2018-12-02 00:06:23.401892138 +0800
@@ -42,7 +42,7 @@
  * Test returning descriptor information
  *
  * Test:
- * -# Call SQLColAttribute without preceeding SQLExecute
+ * -# Call SQLColAttribute without preceding SQLExecute
  * -# Let TYPE is 'ITEM' in Table 20, FieldIdentifer is zero
  * -# Let TYPE is 'ITEM' in Table 20, ColumnNumber is less than one
  * -# FieldIdentifer is not one of the code valuess in Table 20
diff -uNr mysql-5.5.60.orig/storage/ndb/test/odbc/client/SQLColAttributeTest2.cpp.orig mysql-5.5.60/storage/ndb/test/odbc/client/SQLColAttributeTest2.cpp.orig
--- mysql-5.5.60.orig/storage/ndb/test/odbc/client/SQLColAttributeTest2.cpp.orig	1970-01-01 08:00:00.000000000 +0800
+++ mysql-5.5.60/storage/ndb/test/odbc/client/SQLColAttributeTest2.cpp.orig	2018-02-26 21:02:31.000000000 +0800
@@ -0,0 +1,277 @@
+/* Copyright (c) 2003, 2005 MySQL AB
+   Use is subject to license terms
+
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; version 2 of the License.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program; if not, write to the Free Software
+   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA */
+
+ /**
+ * @file SQLColAttributeTest2.cpp
+ */
+
+#include <common.hpp>
+using namespace std;
+
+#define MAXIMUM_MESSAGE_LENGTH_Test2 200
+#define BufferLengthTest2 156
+
+SQLHSTMT    ColAtt_hstmtTest2;
+SQLHSTMT    ColAtt_hdbcTest2;
+SQLHENV     ColAtt_henvTest2;
+SQLHDESC    ColAtt_hdescTest2;
+
+SQLCHAR        CharacterAttributePtrTest2;
+SQLINTEGER     NumericAttributePtrTest2;
+SQLSMALLINT    StringLengthPtrTest2;
+
+SQLRETURN ColAtt_retTest2;
+
+void ColAtt_DisplayErrorTest2(SQLSMALLINT ColAttTest2_HandleType, 
+			      SQLHSTMT ColAttTest2_InputHandle);
+
+/** 
+ * Test returning descriptor information
+ *
+ * Test:
+ * -# Call SQLColAttribute without preceeding SQLExecute
+ * -# Let TYPE is 'ITEM' in Table 20, FieldIdentifer is zero
+ * -# Let TYPE is 'ITEM' in Table 20, ColumnNumber is less than one
+ * -# FieldIdentifer is not one of the code valuess in Table 20
+ * -# Let TYPE is 'ITEM' in Table 20, ColumnNumber is greater than 1044
+ * 
+ * @return Zero, if test succeeded
+ */
+int SQLColAttributeTest2()
+{
+  ndbout << endl << "Start SQLColAttribute Testing2" << endl;
+
+  SQLCHAR SQLStmt [120];
+
+  //*******************************************************************
+  //** Test                                                          **
+  //**                                                               **
+  //** hstmt                                                         **
+  //** Prepare a statement without executing the statement           **
+  //**                                                               **
+  //** Intended result:  table Customer should not have new row      **
+  //*******************************************************************
+
+  //************************************
+  //** Allocate An Environment Handle **
+  //************************************
+  ColAtt_retTest2 = SQLAllocHandle(SQL_HANDLE_ENV, 
+				   SQL_NULL_HANDLE, 
+				   &ColAtt_henvTest2);
+  
+  if (ColAtt_retTest2 == SQL_SUCCESS || ColAtt_retTest2 == SQL_SUCCESS_WITH_INFO)
+    ndbout << "Allocated an environment Handle!" << endl;
+
+  //*********************************************
+  //** Set the ODBC application Version to 3.x **
+  //*********************************************
+  ColAtt_retTest2 = SQLSetEnvAttr(ColAtt_henvTest2, 
+				  SQL_ATTR_ODBC_VERSION, 
+				  (SQLPOINTER) SQL_OV_ODBC3, 
+				  SQL_IS_UINTEGER);
+  
+  if (ColAtt_retTest2 == SQL_SUCCESS || ColAtt_retTest2 == SQL_SUCCESS_WITH_INFO)
+    ndbout << "Set the ODBC application Version to 2.x!" << endl;
+
+  //**********************************
+  //** Allocate A Connection Handle **
+  //**********************************
+
+  ColAtt_retTest2 = SQLAllocHandle(SQL_HANDLE_DBC, 
+				   ColAtt_henvTest2, 
+				   &ColAtt_hdbcTest2);
+
+  if (ColAtt_retTest2 == SQL_SUCCESS || ColAtt_retTest2 == SQL_SUCCESS_WITH_INFO)
+    ndbout << "Allocated a connection Handle!" << endl;
+
+  // *******************
+  // ** Connect to DB **
+  // *******************
+  ColAtt_retTest2 = SQLConnect(ColAtt_hdbcTest2, 
+			       (SQLCHAR *) connectString(), 
+			       SQL_NTS, 
+			       (SQLCHAR *) "", 
+			       SQL_NTS, 
+			       (SQLCHAR *) "", 
+			       SQL_NTS);
+  
+  if (ColAtt_retTest2 == SQL_SUCCESS || ColAtt_retTest2 == SQL_SUCCESS_WITH_INFO)
+    ndbout << "Connected to DB : OK!" << endl;
+  else 
+    {  
+      ndbout << "Failure to Connect DB!" << endl;
+      return NDBT_FAILED;
+    }
+
+  //*******************************
+  //** Allocate statement handle **
+  //*******************************
+  
+  ColAtt_retTest2 = SQLAllocHandle(SQL_HANDLE_STMT, 
+				   ColAtt_hdbcTest2, 
+				   &ColAtt_hstmtTest2); 
+  if(ColAtt_retTest2 == SQL_SUCCESS || ColAtt_retTest2 == SQL_SUCCESS_WITH_INFO) 
+    ndbout << "Allocated a statement handle!" << endl;
+
+  //************************
+  //** Define a statement **
+  //************************
+
+  /*
+  strcpy((char *) SQLStmt, 
+	 "DELETE FROM Customers WHERE CustID = 6");
+   */
+
+    strcpy((char *) SQLStmt, 
+    "INSERT INTO Customers (CustID, Name, Address, Phone) VALUES (6, 'Jan', 'LM vag 8', '969696')");
+
+    /*
+    strcpy((char *) SQLStmt, 
+    "INSERT INTO Customers (CustID, Name, Address, Phone) VALUES (?, ?, ?, ?)");
+    */
+
+  //********************************
+  //** Prepare  SQL statement     **
+  //********************************
+  ColAtt_retTest2 = SQLPrepare(ColAtt_hstmtTest2, 
+			  SQLStmt, 
+			  SQL_NTS);
+  
+  if (ColAtt_retTest2 == SQL_SUCCESS || ColAtt_retTest2 == SQL_SUCCESS_WITH_INFO) 
+    {
+      //**************************************************************
+      //** FieldIdentifer is not one of the code valuess in Table 20, 
+      //** "Codes used for descriptor fields" 
+      //**************************************************************
+      ColAtt_retTest2 = SQLColAttribute(ColAtt_hstmtTest2, 
+					2, 
+					9999, 
+					&CharacterAttributePtrTest2, 
+					BufferLengthTest2, 
+					&StringLengthPtrTest2, 
+					&NumericAttributePtrTest2);
+      
+      if (ColAtt_retTest2 == SQL_ERROR || ColAtt_retTest2 == SQL_SUCCESS_WITH_INFO)
+	{
+	  ndbout << endl << "FieldIdentifer is not one of the" << endl;  
+	  ndbout << "code valuess in Table 20, Codes used for" << endl;
+	  ndbout << "descriptor fields" <<endl;
+	  ColAtt_DisplayErrorTest2(SQL_HANDLE_STMT, ColAtt_hstmtTest2);
+	}
+
+      //****************************************************************
+      //** Let TYPE is 'ITEM' in Table 20, ColumnNumber is less than one
+      //****************************************************************
+      ColAtt_retTest2 = SQLColAttribute(ColAtt_hstmtTest2, 
+					-1, 
+					SQL_DESC_BASE_COLUMN_NAME, 
+					&CharacterAttributePtrTest2, 
+					BufferLengthTest2, 
+					&StringLengthPtrTest2, 
+					&NumericAttributePtrTest2);
+      
+      if (ColAtt_retTest2 == SQL_ERROR || ColAtt_retTest2 == SQL_SUCCESS_WITH_INFO)
+	{
+	  ndbout << "Let TYPE is 'ITEM' in Table 20,ColumnNumber" 
+		 << "is less than one" << endl;
+	  ColAtt_DisplayErrorTest2(SQL_HANDLE_STMT, ColAtt_hstmtTest2);
+	}
+      
+      //*********************************************************
+      //** Let TYPE is 'ITEM' in Table 20, FieldIdentifer is zero 
+      //*********************************************************
+      ColAtt_retTest2 = SQLColAttribute(ColAtt_hstmtTest2, 
+					1018, 
+					0, 
+					&CharacterAttributePtrTest2, 
+					BufferLengthTest2, 
+					&StringLengthPtrTest2, 
+					&NumericAttributePtrTest2);
+      
+      if (ColAtt_retTest2 == SQL_ERROR || ColAtt_retTest2 == SQL_SUCCESS_WITH_INFO)
+	{
+	  ndbout << "Let TYPE is 'ITEM' in Table 20, FieldIdentifer" 
+		 << " is zero"  <<endl;
+	  ColAtt_DisplayErrorTest2(SQL_HANDLE_STMT, ColAtt_hstmtTest2);
+        }
+
+      //**********************************************************
+      //** Let TYPE is 'ITEM' in Table 20, ColumnNumber is greater 
+      //** than TOP_LEVEL_COUNT(1044) 
+      //*********************************************************
+      ColAtt_retTest2 = SQLColAttribute(ColAtt_hstmtTest2, 
+					1045, 
+					SQL_DESC_BASE_COLUMN_NAME, 
+					&CharacterAttributePtrTest2, 
+					BufferLengthTest2, 
+					&StringLengthPtrTest2, 
+					&NumericAttributePtrTest2);
+      
+      if (ColAtt_retTest2 == SQL_ERROR || ColAtt_retTest2 == SQL_SUCCESS_WITH_INFO)
+	{
+	  ndbout << "Let TYPE is 'ITEM' in Table 20, ColumnNumber" << endl 
+		 << "is greater than TOP_LEVEL_COUNT(1044)" << endl;
+	  ColAtt_DisplayErrorTest2(SQL_HANDLE_STMT, ColAtt_hstmtTest2);
+	}
+      
+    }
+
+  // *********************************
+  // ** Disconnect and Free Handles **
+  // *********************************  
+  SQLDisconnect(ColAtt_hdbcTest2);
+  SQLFreeHandle(SQL_HANDLE_STMT, ColAtt_hstmtTest2);
+  SQLFreeHandle(SQL_HANDLE_DBC, ColAtt_hdbcTest2);
+  SQLFreeHandle(SQL_HANDLE_ENV, ColAtt_henvTest2);
+
+  return NDBT_OK;
+}
+
+
+void ColAtt_DisplayErrorTest2(SQLSMALLINT ColAttTest2_HandleType, 
+			      SQLHSTMT ColAttTest2_InputHandle)
+{
+  SQLSMALLINT ColAtt_i = 1;
+  SQLRETURN ColAtt_SQLSTATEs;
+  SQLCHAR ColAtt_Sqlstate[5];
+  SQLCHAR ColAtt_Msg[MAXIMUM_MESSAGE_LENGTH_Test2];
+  SQLSMALLINT ColAtt_MsgLen;
+  SQLINTEGER  ColAtt_NativeError;
+
+  ndbout << "-------------------------------------------------" << endl;
+  ndbout << "Error diagnostics:" << endl;
+  
+  while ((ColAtt_SQLSTATEs = SQLGetDiagRec(ColAttTest2_HandleType, 
+					   ColAttTest2_InputHandle, 
+					   ColAtt_i, 
+					   ColAtt_Sqlstate, 
+					   &ColAtt_NativeError, 
+					   ColAtt_Msg, 
+					   sizeof(ColAtt_Msg), 
+					   &ColAtt_MsgLen)) 
+	 != SQL_NO_DATA)                   
+    {
+      
+      ndbout << "the HandleType is:" << ColAttTest2_HandleType << endl;
+      ndbout << "the InputHandle is :" << (long)ColAttTest2_InputHandle << endl;
+      ndbout << "the ColAtt_Msg is: " << (char *) ColAtt_Msg << endl;
+      ndbout << "the output state is:" << (char *)ColAtt_Sqlstate << endl; 
+      
+      ColAtt_i ++;
+      break;
+    }
+  ndbout << "-------------------------------------------------" << endl;
+}
